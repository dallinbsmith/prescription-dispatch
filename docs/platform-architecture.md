# Compounding Pharmacy Platform Architecture

> Last updated: February 2026
> Status: Planning Phase

---

## Table of Contents

1. [Vision & Overview](#vision--overview)
2. [Key Decisions](#key-decisions)
3. [Market Research Summary](#market-research-summary)
4. [Microservices Architecture](#microservices-architecture)
5. [Data Models](#data-models)
6. [Tech Stack](#tech-stack)
7. [Regulatory Notes](#regulatory-notes)
8. [Admin Portal Architecture](#admin-portal-architecture)
9. [Access Control & Security](#access-control--security)
10. [SMS & Notifications](#sms--notifications)
11. [Marketing Architecture](#marketing-architecture)
12. [Provider Platform](#provider-platform)
13. [Operational Workflows](#operational-workflows)
14. [MVP Roadmap](#mvp-roadmap)
15. [Open Questions](#open-questions)

---

## Vision & Overview

### The Problem

Getting compounded medications to patients involves fragmented systems:
- Finding a doctor (ZocDoc, Teladoc model)
- Getting a prescription
- Finding a compounding pharmacy
- Navigating insurance vs cash pricing
- Waiting for custom manufacturing

### The Solution

A unified platform connecting:
- **Patients** → AI-assisted symptom assessment → Doctor appointments → Prescription → Compounded medication delivery
- **Providers** → Patient data from AI → Telemedicine → Prescribing → Authorization
- **Employers** → Employee enrollment → Network access → Benefits management
- **Compounding Facility** → Order receipt → Manufacturing → Quality control → Fulfillment

### Core Flow

```
Patient logs in
    ↓
Searches for drugs / talks to AI about symptoms
    ↓
AI recommends compounds (with disclaimer: not medical advice)
    ↓
Patient prompted to book appointment
    ↓
Quick auth (Auth0)
    ↓
Choose: Our doctors (cash) OR Search in-network doctors (insurance)
    ↓
Insurance verified (if applicable) OR cash price shown
    ↓
Telemedicine appointment
    ↓
Doctor sees AI-gathered data, patient history
    ↓
Doctor prescribes compound
    ↓
Patient authorizes purchase
    ↓
Order sent to compounding facility
    ↓
Custom compound manufactured
    ↓
Shipped to patient
```

---

## Key Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| **Payment Model** | Cash + Insurance (dual) | Show cash price upfront; option to check insurance pricing |
| **Provider Model** | Marketplace-first, employed-ready | Start with external providers; architect for future employed doctors |
| **Compounding** | Own facility | Have access to facility being built; removes partner dependency |
| **AI Liability** | Disclaimer model | "Not medical advice" but data passed to provider pre-visit |
| **Geographic Scope** | Mountain states first | Utah, Idaho, Arizona, Colorado, Wyoming |

### Why Mountain States?

- **Utah**: Just approved Doctronic AI prescribing pilot; very innovation-friendly
- **Arizona**: Business-friendly, large Phoenix market, permissive regulations
- **Colorado**: Denver market, telehealth parity laws
- **Idaho**: Simple regulatory environment, low barriers
- **Wyoming**: Most permissive, minimal restrictions

---

## Market Research Summary

### Key Players Analyzed

| Company | What They Do | Relevant Learnings |
|---------|--------------|-------------------|
| **Teladoc** | Virtual care provider | 24/7 access model, chronic condition management, device integration |
| **ZocDoc** | Doctor marketplace + booking | Insurance verification, reviews system, Provider Mode |
| **Healthie** | Practice management + EHR | Provider portal patterns, API/white-label infrastructure |
| **Cost Plus Drugs** | Transparent drug pricing | Cost-plus model (cost + 15% + fees), manufacturing facility |
| **GoodRx** | Prescription discounts | Dual pricing (cash + insurance comparison), telehealth integration |
| **Doctronic** | AI doctor | Multi-agent AI, 99.2% clinician alignment, Utah prescribing pilot |
| **Strive Pharmacy** | Compounding pharmacy | 503A/503B operations, LifeFile portal, telehealth partnerships |
| **Rx.com** | Prescription discounts | RxWatch price tracking, simple discount card model |

### Key Insights

1. **Insurance verification is unreliable** - Payer APIs inconsistent; cash-pay option essential
2. **AI can achieve clinical-grade accuracy** - Doctronic's 99.2% alignment with human clinicians
3. **Provider portals need AI integration** - Pre-visit summaries dramatically improve efficiency
4. **Compounding is underserved** - Major pharmacies don't customize; opportunity for differentiation
5. **Telehealth partnerships are valuable** - Strive's model of partnering with telehealth companies
6. **Transparent pricing wins** - Cost Plus Drugs model shows consumer appetite for clarity

---

## Microservices Architecture

### Patient Domain

```
┌─────────────────────────────────────────────────────────────────┐
│                      PATIENT PORTAL (Next.js)                   │
└─────────────────────────────────────────────────────────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        ▼                       ▼                       ▼
┌───────────────┐    ┌───────────────────┐    ┌─────────────────┐
│ Drug Catalog  │    │  AI Consultation  │    │   Appointment   │
│    Service    │    │      Service      │    │     Service     │
└───────────────┘    └───────────────────┘    └─────────────────┘
        │                       │                       │
        │                       ▼                       │
        │            ┌───────────────────┐              │
        │            │  Consultation     │              │
        │            │  Summary Service  │──────────────┤
        │            │ (AI → Provider)   │              │
        │            └───────────────────┘              │
        ▼                                               ▼
┌───────────────┐                            ┌─────────────────┐
│ Pricing       │                            │   Insurance     │
│ Service       │                            │   Verification  │
│ (Cash + Ins)  │                            │   Service       │
└───────────────┘                            └─────────────────┘
```

### Provider Domain

```
┌─────────────────────────────────────────────────────────────────┐
│                     PROVIDER PORTAL (Next.js)                   │
└─────────────────────────────────────────────────────────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        ▼                       ▼                       ▼
┌───────────────┐    ┌───────────────────┐    ┌─────────────────┐
│   Provider    │    │    EHR/Chart      │    │  Prescription   │
│   Registry    │    │     Service       │    │    Service      │
│  Service      │    │                   │    │                 │
└───────────────┘    └───────────────────┘    └─────────────────┘
        │                       │                       │
        │            ┌───────────────────┐              │
        │            │   Telemedicine    │              │
        │            │     Service       │              │
        │            └───────────────────┘              │
        ▼                                               ▼
┌───────────────┐                            ┌─────────────────┐
│ Credentialing │                            │   Compound      │
│ Service       │                            │   Authorization │
│               │                            │   Service       │
└───────────────┘                            └─────────────────┘
```

### Employer Domain

```
┌─────────────────────────────────────────────────────────────────┐
│                     EMPLOYER PORTAL (Next.js)                   │
└─────────────────────────────────────────────────────────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        ▼                       ▼                       ▼
┌───────────────┐    ┌───────────────────┐    ┌─────────────────┐
│   Employer    │    │    Employee       │    │    Benefits     │
│   Account     │    │    Enrollment     │    │  Configuration  │
│   Service     │    │    Service        │    │    Service      │
└───────────────┘    └───────────────────┘    └─────────────────┘
                                │
                                ▼
                     ┌───────────────────┐
                     │   Reporting &     │
                     │   Analytics       │
                     └───────────────────┘
```

### Pharmacy/Manufacturing Domain

```
┌─────────────────────────────────────────────────────────────────┐
│                    PHARMACY OPERATIONS PORTAL                   │
└─────────────────────────────────────────────────────────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        ▼                       ▼                       ▼
┌───────────────┐    ┌───────────────────┐    ┌─────────────────┐
│   Compound    │    │   Manufacturing   │    │   Inventory     │
│   Order       │    │   Queue           │    │   Service       │
│   Service     │    │   Service         │    │                 │
└───────────────┘    └───────────────────┘    └─────────────────┘
        │                       │                       │
        │                       ▼                       │
        │            ┌───────────────────┐              │
        │            │   Quality         │              │
        │            │   Control         │              │
        │            │   Service         │              │
        │            └───────────────────┘              │
        ▼                                               ▼
┌───────────────┐                            ┌─────────────────┐
│ Fulfillment   │                            │   Shipping      │
│ Service       │                            │   Integration   │
└───────────────┘                            └─────────────────┘
```

### Shared Platform Services

```
┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│   Identity  │ │ Notification│ │  Payment/   │ │  Document   │
│   Service   │ │   Service   │ │  Billing    │ │  Service    │
│  (Auth0)    │ │             │ │  Service    │ │  (HIPAA)    │
└─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘

┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│   Audit     │ │   Search    │ │   Event     │ │   Feature   │
│   Logging   │ │   Service   │ │   Bus       │ │   Flags     │
│   Service   │ │ (Elastic)   │ │  (Kafka)    │ │  (LaunchD)  │
└─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘
```

### Service Inventory

| Service | Domain | Responsibility |
|---------|--------|----------------|
| Patient Portal | Patient | UI for patient-facing site |
| Drug Catalog Service | Patient | Searchable drug/compound database |
| AI Consultation Service | Patient | Symptom intake, recommendations, conversation |
| Consultation Summary Service | Shared | Transform AI conversation → provider-ready summary |
| Appointment Service | Patient | Scheduling, availability, calendar |
| Insurance Verification Service | Patient | Real-time eligibility checks |
| Pricing Service | Patient | Cash + insurance price quotes |
| Order Service | Patient | Patient orders, status, fulfillment lifecycle |
| Provider Portal | Provider | UI for doctors |
| Provider Registry Service | Provider | Provider profiles, marketplace vs employed |
| Credentialing Service | Provider | License verification, background checks |
| EHR/Chart Service | Provider | Patient records, notes, history |
| Prescription Service | Provider | E-prescribing, Rx lifecycle |
| Provider Calendar Service | Provider | Availability management |
| Telemedicine Service | Provider | Video visit infrastructure |
| Compound Authorization Service | Provider | Prescription → manufacturing approval |
| Employer Portal | Employer | Admin UI for employers |
| Employer Account Service | Employer | Company management |
| Employee Enrollment Service | Employer | Onboarding, eligibility |
| Benefits Configuration Service | Employer | Plan setup, network rules |
| Reporting Service | Employer | Analytics, usage reports |
| Compound Order Service | Pharmacy | Translate Rx → manufacturing specs |
| Manufacturing Queue Service | Pharmacy | Production scheduling |
| Inventory Service | Pharmacy | Stock management |
| Quality Control Service | Pharmacy | QC workflow, batch tracking |
| Fulfillment Service | Pharmacy | Packaging, shipping prep |
| Shipping Integration Service | Pharmacy | Carrier APIs, tracking |
| Identity Service | Platform | Auth0 integration, RBAC |
| Notification Service | Platform | Email, SMS, push |
| Payment/Billing Service | Platform | Stripe, claims |
| Document Service | Platform | HIPAA-compliant file storage |
| Audit Logging Service | Platform | Compliance, audit trails |
| Search Service | Platform | Elasticsearch integration |
| Event Bus | Platform | Kafka/EventBridge |
| Feature Flags | Platform | LaunchDarkly or similar |

---

## Data Models

### Users & Identity

```typescript
// Base user - all types inherit from this
interface User {
  id: string;
  email: string;
  phone: string;
  authProviderId: string; // Auth0 ID
  createdAt: Date;
  updatedAt: Date;
}

interface Patient extends User {
  firstName: string;
  lastName: string;
  dateOfBirth: Date;
  address: Address;
  insurancePolicies: InsurancePolicy[]; // optional, can be empty for cash-pay
  employerId?: string; // if enrolled through employer
}

interface Provider {
  id: string;
  userId: string;
  type: 'marketplace' | 'employed'; // critical distinction
  npi: string;
  licenses: StateLicense[];
  specialties: string[];
  credentialingStatus: 'pending' | 'approved' | 'suspended';
  availability: AvailabilitySchedule;
  telemedicineEnabled: boolean;

  // marketplace-specific
  practiceName?: string;
  acceptedInsurance?: string[];

  // employed-specific
  employmentStartDate?: Date;
  compensationModel?: 'salary' | 'per_visit' | 'hybrid';
}

interface StateLicense {
  state: 'UT' | 'ID' | 'AZ' | 'CO' | 'WY'; // expand later
  licenseNumber: string;
  expirationDate: Date;
  status: 'active' | 'expired' | 'suspended';
}

interface Employer {
  id: string;
  companyName: string;
  adminUsers: string[]; // user IDs
  benefitsConfig: BenefitsConfiguration;
  enrolledEmployees: string[]; // patient IDs
}

interface Address {
  street1: string;
  street2?: string;
  city: string;
  state: string;
  zipCode: string;
  country: string;
}

interface InsurancePolicy {
  id: string;
  payerId: string;
  payerName: string;
  memberId: string;
  groupNumber?: string;
  planType: 'hmo' | 'ppo' | 'epo' | 'pos' | 'hdhp';
  isPrimary: boolean;
  effectiveDate: Date;
  terminationDate?: Date;
}
```

### AI Consultation & Handoff

```typescript
interface Consultation {
  id: string;
  patientId: string;
  status: 'in_progress' | 'completed' | 'handed_off';
  startedAt: Date;
  completedAt?: Date;

  // Conversation
  messages: ConsultationMessage[];

  // AI-generated summary for provider handoff
  summary?: ConsultationSummary;
}

interface ConsultationMessage {
  id: string;
  role: 'patient' | 'ai';
  content: string;
  timestamp: Date;

  // Structured data extracted by AI
  extractedSymptoms?: string[];
  extractedMedications?: string[];
  extractedConditions?: string[];
}

interface ConsultationSummary {
  // This is what the provider sees before the visit
  chiefComplaint: string;
  symptomsSummary: string;
  relevantHistory: string;
  suggestedCompounds: CompoundSuggestion[];
  riskFlags: string[]; // e.g., "mentions chest pain"

  // Structured for easy provider review
  icd10Suggestions?: string[];
  durationOfSymptoms?: string;
  severityAssessment?: 'mild' | 'moderate' | 'severe';
}

interface CompoundSuggestion {
  compoundId: string;
  compoundName: string;
  reasoning: string;
  confidence: number; // 0-1
  requiresPrescription: boolean;
}
```

### Appointments

```typescript
interface Appointment {
  id: string;
  patientId: string;
  providerId: string;
  consultationId?: string; // link to AI consultation that led here

  scheduledAt: Date;
  duration: number; // minutes
  type: 'telemedicine' | 'in_person';
  status: 'scheduled' | 'confirmed' | 'in_progress' | 'completed' | 'cancelled' | 'no_show';

  // Payment
  paymentMethod: 'cash' | 'insurance';
  cashPrice?: number;
  insuranceClaim?: InsuranceClaim;

  // Telemedicine
  videoRoomId?: string;

  // Post-visit
  visitNotes?: string;
  prescriptions?: Prescription[];
}

interface InsuranceClaim {
  id: string;
  status: 'pending' | 'submitted' | 'accepted' | 'rejected' | 'paid';
  payerId: string;
  claimAmount: number;
  patientResponsibility: number;
  submittedAt?: Date;
  paidAt?: Date;
}
```

### Prescriptions & Orders

```typescript
interface Prescription {
  id: string;
  patientId: string;
  providerId: string;
  appointmentId: string;

  // What's being prescribed
  compoundId: string;
  compoundName: string;
  formulation: CompoundFormulation;

  // Prescription details
  quantity: number;
  refills: number;
  directions: string;

  // Status
  status: 'pending_auth' | 'authorized' | 'sent_to_pharmacy' | 'compounding' | 'shipped' | 'delivered';
  prescribedAt: Date;
  authorizedAt?: Date;

  // E-prescribing (when Surescripts integration added)
  surescriptsMessageId?: string;
}

interface CompoundFormulation {
  ingredients: Ingredient[];
  dosageForm: 'injection' | 'capsule' | 'troche' | 'cream' | 'nasal_spray' | 'sublingual';
  strength: string;
  volume?: string;

  // Patient-specific customizations
  removeAllergens?: string[];
  flavorPreference?: string;
}

interface Ingredient {
  name: string;
  amount: number;
  unit: string;
  ndc?: string; // National Drug Code
}

interface CompoundOrder {
  id: string;
  prescriptionId: string;
  patientId: string;

  // Manufacturing details
  formulation: CompoundFormulation;
  batchId?: string;

  // Status tracking
  status: 'queued' | 'compounding' | 'quality_check' | 'passed_qc' | 'failed_qc' | 'ready_to_ship' | 'shipped' | 'delivered';

  // Timestamps
  receivedAt: Date;
  compoundingStartedAt?: Date;
  qcCompletedAt?: Date;
  shippedAt?: Date;
  deliveredAt?: Date;

  // Shipping
  shippingCarrier?: string;
  trackingNumber?: string;
  shippingAddress: Address;
}
```

### Pricing

```typescript
interface DrugPricing {
  compoundId: string;

  // Cash pricing (always available)
  cashPrice: number;
  cashPriceValidUntil: Date;

  // Insurance pricing (checked per-patient)
  insurancePricingAvailable: boolean;
}

interface PatientPriceQuote {
  patientId: string;
  compoundId: string;

  cashPrice: number;

  // If patient has insurance and we can check
  insurancePrice?: number;
  insuranceCopay?: number;
  insuranceDeductibleRemaining?: number;
  insuranceCoveragePercentage?: number;

  recommendation: 'cash' | 'insurance';
  recommendationReason: string; // "Cash is $45 cheaper than your copay"

  quotedAt: Date;
  validUntil: Date;
}
```

### Drug Catalog

```typescript
interface Compound {
  id: string;
  name: string;
  genericName: string;
  brandNames?: string[];

  // Categorization
  therapeuticCategory: string; // e.g., "Weight Management", "Hormone Therapy"
  subcategory?: string;

  // Formulations available
  availableFormulations: CompoundFormulation[];

  // Regulatory
  requiresPrescription: boolean;
  isControlled: boolean;
  schedule?: 'II' | 'III' | 'IV' | 'V';

  // Clinical
  indications: string[];
  contraindications: string[];
  commonDosages: string[];

  // Pricing
  baseCashPrice: number;

  // Search
  keywords: string[];
  symptoms: string[]; // for AI matching
}
```

---

## Tech Stack

### Frontend

| Layer | Technology | Rationale |
|-------|------------|-----------|
| Framework | **Next.js 14+ (App Router)** | SSR, API routes, good DX |
| Styling | **Tailwind CSS** | Fast iteration, consistent design |
| State | **Zustand** or **Jotai** | Lighter than Redux |
| Forms | **React Hook Form + Zod** | Type-safe validation |
| UI Components | **shadcn/ui** | Accessible, customizable |
| Video | **Twilio Video SDK** | HIPAA-compliant |

### Backend

| Layer | Technology | Rationale |
|-------|------------|-----------|
| API Gateway | **Kong** or **AWS API Gateway** | Rate limiting, auth, routing |
| Services | **Node.js/TypeScript** | Fast iteration; Go for high-throughput later |
| Framework | **NestJS** or **Fastify** | Structure for microservices |
| API Style | **tRPC** (internal) + **REST** (external) | Type safety end-to-end |
| Events | **Kafka** or **AWS EventBridge** | Async workflows |

### Data

| Layer | Technology | Rationale |
|-------|------------|-----------|
| Primary DB | **PostgreSQL** | ACID, mature, JSON support |
| Cache | **Redis** | Sessions, rate limiting |
| Search | **Elasticsearch** or **Typesense** | Drug catalog, symptoms |
| Documents | **S3 + Encryption** | HIPAA-compliant files |

### AI

| Layer | Technology | Rationale |
|-------|------------|-----------|
| LLM | **Claude API** or **GPT-4** | Conversation, summarization |
| Orchestration | **LangChain** or custom | Multi-step reasoning |
| Vector DB | **Pinecone** or **Weaviate** | Symptom/drug matching, RAG |
| Knowledge | **Custom knowledge base** | Compounds, contraindications |

### Infrastructure

| Layer | Technology | Rationale |
|-------|------------|-----------|
| Cloud | **AWS** (HIPAA-eligible) | Mature compliance |
| Containers | **ECS** → **EKS** at scale | Start simple |
| IaC | **Terraform + Terragrunt** | Multi-environment |
| CI/CD | **GitHub Actions** | Integrated |
| Monitoring | **Datadog** | HIPAA-compliant observability |
| Secrets | **AWS Secrets Manager + Vault** | Credentials |

### Auth

| Layer | Technology | Rationale |
|-------|------------|-----------|
| Identity | **Auth0** | HIPAA BAA, MFA, SSO |
| Authorization | **Custom RBAC + Casbin** | Fine-grained permissions |

### Key Integrations

| Function | Technology |
|----------|------------|
| Telehealth Video | Twilio Video (HIPAA), Vonage, or Zoom HIPAA |
| Insurance Eligibility | Availity, Eligible API, Change Healthcare |
| E-Prescribing | Surescripts (Phase 2), DrFirst |
| EHR Standards | HL7 FHIR |
| Payments | Stripe (HIPAA BAA available) |
| Shipping | EasyPost, ShipStation |

---

## Regulatory Notes

### Mountain States Overview

| State | Telehealth | Compounding | Corporate Practice |
|-------|------------|-------------|-------------------|
| **Utah** | Very friendly; AI prescribing pilot approved | Standard 503A/503B | MSO model works |
| **Idaho** | Standard consent requirements | Standard rules | Relatively permissive |
| **Arizona** | Telehealth parity; must offer in-person option | Standard rules | MSO model required |
| **Colorado** | Telehealth parity; some controlled restrictions | Standard rules | MSO model works |
| **Wyoming** | Very permissive; minimal restrictions | Standard rules | Permissive |

### HIPAA Requirements

Every service touching PHI must have:
- Encryption at rest (AES-256)
- Encryption in transit (TLS 1.2+)
- Audit logging for all access
- Access controls (RBAC)
- BAAs with all vendors

### Pharmacy Licensing

- Need pharmacy license in each state you ship to
- 503A: patient-specific, state-regulated
- 503B: bulk compounding, FDA-regulated
- Licensed pharmacist-in-charge required
- Timeline: 2-6 months per state

### Provider Requirements

- Physicians must be licensed in patient's state
- Credentialing: 30-60 days minimum
- DEA registration if any controlled substances
- Malpractice coverage required

### Compounding-Specific

- Semaglutide/tirzepatide only legal to compound when FDA-approved versions in shortage
- Must follow USP 795 (non-sterile) and USP 797 (sterile) guidelines
- Third-party testing for sterility, potency, endotoxins
- Batch records and QC documentation

---

## Admin Portal Architecture

### Overview

Three domain-specific admin portals plus a super admin layer, each with strictly scoped access to their respective domains.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           SUPER ADMIN LAYER                                  │
│                    (Tier 0-1: Break Glass + Compliance)                      │
│      ┌─────────────────────────────────────────────────────────────────┐    │
│      │  Full visibility │ Break glass access │ Audit review │ Override │    │
│      └─────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
        ┌─────────────────────────────┼─────────────────────────────┐
        ▼                             ▼                             ▼
┌───────────────────┐    ┌───────────────────────┐    ┌───────────────────┐
│  STOREFRONT ADMIN │    │    PHARMACY ADMIN     │    │  PROVIDER ADMIN   │
│    (Tier 2-4)     │    │      (Tier 2-4)       │    │    (Tier 2-4)     │
├───────────────────┤    ├───────────────────────┤    ├───────────────────┤
│ • Drug catalog    │    │ • Order queue         │    │ • Provider roster │
│ • Pricing config  │    │ • Manufacturing       │    │ • Credentialing   │
│ • Patient orders  │    │ • Inventory           │    │ • Scheduling      │
│ • Promotions      │    │ • QC workflows        │    │ • Compliance      │
│ • Content mgmt    │    │ • Batch tracking      │    │ • Performance     │
│ • Support tickets │    │ • Shipping            │    │ • Patient assign  │
└───────────────────┘    └───────────────────────┘    └───────────────────┘
        │                             │                             │
        └─────────────────────────────┼─────────────────────────────┘
                                      ▼
                    ┌─────────────────────────────────┐
                    │       SHARED AUDIT LOG          │
                    │  (Immutable, all admin actions) │
                    └─────────────────────────────────┘
```

### Portal Responsibilities

| Portal | Primary Users | Key Functions |
|--------|---------------|---------------|
| **Storefront Admin** | Operations team, customer support | Drug catalog management, pricing, patient order oversight, promotions, CMS |
| **Pharmacy Admin** | Pharmacists, compounding techs, QC | Manufacturing queue, inventory, QC checklists, batch records, shipping |
| **Provider Admin** | Medical director, credentialing staff | Provider onboarding, license tracking, scheduling rules, patient assignment |
| **Super Admin** | Compliance officer, CTO, break glass | Cross-domain visibility, audit review, emergency access, system config |

### Domain Isolation

Each admin portal can ONLY access data within its domain:

```typescript
const domainScopes = {
  storefront: [
    'drugs:*',
    'pricing:*',
    'orders:read',
    'orders:update_status',
    'patients:read_limited',  // No PHI, just order context
    'promotions:*',
    'content:*',
    'support:*'
  ],
  pharmacy: [
    'manufacturing:*',
    'inventory:*',
    'orders:read',
    'orders:update_manufacturing_status',
    'qc:*',
    'batches:*',
    'shipping:*'
  ],
  provider: [
    'providers:*',
    'credentialing:*',
    'scheduling:*',
    'patients:read',  // Limited PHI for assignment
    'appointments:read',
    'performance:read'
  ],
  super: [
    '*:*'  // Break glass only, requires justification
  ]
};
```

---

## Access Control & Security

### Permission Tiers

Five-tier permission system with escalating access and oversight:

| Tier | Name | Access Level | Approval Required | Audit Level |
|------|------|--------------|-------------------|-------------|
| **Tier 0** | System/Break Glass | Full system access | Dual approval + time-limited | Every action logged with justification |
| **Tier 1** | Compliance | Read all + audit tools | Manager approval | All access logged |
| **Tier 2** | Domain Admin | Full domain CRUD | Self-service with review | Writes logged |
| **Tier 3** | Operator | Domain read + limited write | Self-service | Writes logged |
| **Tier 4** | Read-Only | Domain read only | Self-service | Session logged |

### Role Definitions

#### Storefront Roles

| Role | Tier | Permissions |
|------|------|-------------|
| `storefront_viewer` | 4 | View catalog, orders, pricing |
| `storefront_support` | 3 | + Update order status, respond to tickets |
| `storefront_operator` | 3 | + Edit pricing, manage promotions |
| `storefront_admin` | 2 | + Create/archive drugs, configure catalog |
| `storefront_director` | 2 | + User management within storefront |

#### Pharmacy Roles

| Role | Tier | Permissions |
|------|------|-------------|
| `pharmacy_viewer` | 4 | View queue, inventory levels |
| `pharmacy_tech` | 3 | + Update order status, log manufacturing steps |
| `pharmacy_qc` | 3 | + Approve/reject QC, manage batch records |
| `pharmacy_pharmacist` | 2 | + Override QC, adjust formulations, final verify |
| `pharmacy_director` | 2 | + Inventory adjustments, user management |

#### Provider Roles

| Role | Tier | Permissions |
|------|------|-------------|
| `provider_viewer` | 4 | View provider roster, schedules |
| `provider_coordinator` | 3 | + Manage schedules, patient assignment |
| `provider_credentialing` | 3 | + Update credentialing status, upload docs |
| `provider_admin` | 2 | + Onboard/offboard providers, edit profiles |
| `provider_medical_director` | 2 | + Override clinical decisions, full PHI |

#### System Roles

| Role | Tier | Permissions |
|------|------|-------------|
| `compliance_auditor` | 1 | Read all domains, audit logs, no modify |
| `compliance_officer` | 1 | + Generate reports, flag issues |
| `system_admin` | 0 | Full access (break glass required) |
| `super_admin` | 0 | Full access + user role management |

### RBAC Database Schema

```sql
-- Core RBAC tables

CREATE TABLE roles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) UNIQUE NOT NULL,
  domain VARCHAR(50) NOT NULL, -- 'storefront', 'pharmacy', 'provider', 'system'
  tier SMALLINT NOT NULL CHECK (tier >= 0 AND tier <= 4),
  description TEXT,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE permissions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) UNIQUE NOT NULL,
  resource VARCHAR(100) NOT NULL,  -- 'drugs', 'orders', 'patients', etc.
  action VARCHAR(50) NOT NULL,     -- 'create', 'read', 'update', 'delete', 'admin'
  domain VARCHAR(50) NOT NULL,
  description TEXT,
  requires_justification BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE role_permissions (
  role_id UUID REFERENCES roles(id) ON DELETE CASCADE,
  permission_id UUID REFERENCES permissions(id) ON DELETE CASCADE,
  granted_at TIMESTAMPTZ DEFAULT NOW(),
  granted_by UUID,
  PRIMARY KEY (role_id, permission_id)
);

CREATE TABLE admin_users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  email VARCHAR(255) NOT NULL,
  full_name VARCHAR(255) NOT NULL,
  is_active BOOLEAN DEFAULT true,
  mfa_enabled BOOLEAN DEFAULT true,
  last_login TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID,

  CONSTRAINT admin_requires_mfa CHECK (mfa_enabled = true)
);

CREATE TABLE admin_user_roles (
  admin_user_id UUID REFERENCES admin_users(id) ON DELETE CASCADE,
  role_id UUID REFERENCES roles(id) ON DELETE CASCADE,
  assigned_at TIMESTAMPTZ DEFAULT NOW(),
  assigned_by UUID REFERENCES admin_users(id),
  expires_at TIMESTAMPTZ,  -- For temporary elevated access
  justification TEXT,      -- Required for Tier 0-1
  PRIMARY KEY (admin_user_id, role_id)
);

-- Indexes for performance
CREATE INDEX idx_roles_domain ON roles(domain);
CREATE INDEX idx_roles_tier ON roles(tier);
CREATE INDEX idx_permissions_domain ON permissions(domain);
CREATE INDEX idx_permissions_resource ON permissions(resource);
CREATE INDEX idx_admin_user_roles_expires ON admin_user_roles(expires_at) WHERE expires_at IS NOT NULL;
```

### Permission Checking Implementation

```typescript
interface PermissionContext {
  adminUserId: string;
  resource: string;
  action: 'create' | 'read' | 'update' | 'delete' | 'admin';
  resourceId?: string;
  justification?: string;
}

interface PermissionResult {
  allowed: boolean;
  requiresJustification: boolean;
  auditRequired: boolean;
  denialReason?: string;
}

const checkPermission = async (ctx: PermissionContext): Promise<PermissionResult> => {
  const adminUser = await getAdminUser(ctx.adminUserId);

  if (!adminUser.isActive) {
    return { allowed: false, requiresJustification: false, auditRequired: true, denialReason: 'User inactive' };
  }

  const roles = await getActiveRoles(ctx.adminUserId);
  const permissions = await getPermissionsForRoles(roles);

  const matchingPermission = permissions.find(p =>
    p.resource === ctx.resource &&
    (p.action === ctx.action || p.action === 'admin')
  );

  if (!matchingPermission) {
    return { allowed: false, requiresJustification: false, auditRequired: true, denialReason: 'No matching permission' };
  }

  const highestTier = Math.min(...roles.map(r => r.tier));

  if (highestTier <= 1 && !ctx.justification) {
    return { allowed: false, requiresJustification: true, auditRequired: true, denialReason: 'Justification required for Tier 0-1' };
  }

  await logAdminAction({
    adminUserId: ctx.adminUserId,
    resource: ctx.resource,
    action: ctx.action,
    resourceId: ctx.resourceId,
    justification: ctx.justification,
    tier: highestTier
  });

  return { allowed: true, requiresJustification: highestTier <= 1, auditRequired: true };
};
```

### Break Glass Access

Emergency access system for critical situations requiring elevated permissions.

#### Break Glass Schema

```sql
CREATE TABLE break_glass_requests (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  requester_id UUID REFERENCES admin_users(id),
  requested_role_id UUID REFERENCES roles(id),

  reason_category VARCHAR(100) NOT NULL, -- 'patient_safety', 'system_outage', 'compliance_emergency', 'security_incident'
  justification TEXT NOT NULL,

  status VARCHAR(50) DEFAULT 'pending', -- 'pending', 'approved', 'denied', 'expired', 'revoked'

  approved_by UUID REFERENCES admin_users(id),
  secondary_approver_id UUID REFERENCES admin_users(id), -- Required for Tier 0

  requested_at TIMESTAMPTZ DEFAULT NOW(),
  approved_at TIMESTAMPTZ,
  expires_at TIMESTAMPTZ NOT NULL,
  revoked_at TIMESTAMPTZ,
  revoked_by UUID REFERENCES admin_users(id),
  revoke_reason TEXT,

  ip_address INET,
  user_agent TEXT
);

CREATE TABLE break_glass_actions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  break_glass_request_id UUID REFERENCES break_glass_requests(id),

  action_type VARCHAR(100) NOT NULL,
  resource_type VARCHAR(100) NOT NULL,
  resource_id UUID,

  action_details JSONB NOT NULL,
  performed_at TIMESTAMPTZ DEFAULT NOW()
);

-- Auto-expire break glass access
CREATE INDEX idx_break_glass_expires ON break_glass_requests(expires_at)
  WHERE status = 'approved';
```

#### Break Glass Workflow

```
┌──────────────────────────────────────────────────────────────────────┐
│                      BREAK GLASS REQUEST FLOW                         │
└──────────────────────────────────────────────────────────────────────┘

User needs elevated access
         │
         ▼
┌─────────────────────┐
│ Submit Break Glass  │
│ Request:            │
│ • Select reason     │
│ • Write justif.     │
│ • Select duration   │
└─────────────────────┘
         │
         ▼
┌─────────────────────┐     ┌──────────────────────┐
│ Tier 0 Request?     │────▶│ Requires 2 approvers │
│                     │ Yes │ (4-eyes principle)   │
└─────────────────────┘     └──────────────────────┘
         │ No                          │
         ▼                             ▼
┌─────────────────────┐     ┌──────────────────────┐
│ Single approver     │     │ Both must approve    │
│ notified            │     │ within 15 minutes    │
└─────────────────────┘     └──────────────────────┘
         │                             │
         └──────────────┬──────────────┘
                        ▼
              ┌─────────────────────┐
              │ Access granted      │
              │ Timer starts        │
              │ All actions logged  │
              └─────────────────────┘
                        │
                        ▼
              ┌─────────────────────┐
              │ Auto-expire OR      │
              │ Manual revoke       │
              └─────────────────────┘
                        │
                        ▼
              ┌─────────────────────┐
              │ Post-incident       │
              │ review required     │
              └─────────────────────┘
```

#### Break Glass Limits

| Tier | Max Duration | Approvers Required | Review Deadline |
|------|--------------|-------------------|-----------------|
| Tier 0 | 4 hours | 2 (different from requester) | 24 hours |
| Tier 1 | 8 hours | 1 (Tier 0 holder) | 48 hours |

### Admin Audit Logging

All admin actions are logged to an immutable audit store.

```sql
CREATE TABLE admin_audit_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  admin_user_id UUID NOT NULL,
  admin_email VARCHAR(255) NOT NULL,  -- Denormalized for immutability
  admin_roles TEXT[] NOT NULL,        -- Roles at time of action

  action_type VARCHAR(100) NOT NULL,  -- 'create', 'read', 'update', 'delete', 'login', 'export'
  resource_type VARCHAR(100) NOT NULL,
  resource_id UUID,

  domain VARCHAR(50) NOT NULL,        -- Which admin portal

  request_details JSONB,              -- Sanitized request payload
  response_status INTEGER,            -- HTTP status

  justification TEXT,                 -- Required for sensitive actions
  break_glass_request_id UUID,        -- If performed under break glass

  ip_address INET NOT NULL,
  user_agent TEXT,
  session_id VARCHAR(255),

  performed_at TIMESTAMPTZ DEFAULT NOW(),

  phi_accessed BOOLEAN DEFAULT false, -- Flag for HIPAA
  data_exported BOOLEAN DEFAULT false -- Flag for data export
);

-- This table should be append-only with no UPDATE/DELETE permissions
-- Consider using a separate audit database or immutable storage

CREATE INDEX idx_audit_admin_user ON admin_audit_log(admin_user_id);
CREATE INDEX idx_audit_performed_at ON admin_audit_log(performed_at);
CREATE INDEX idx_audit_resource ON admin_audit_log(resource_type, resource_id);
CREATE INDEX idx_audit_phi ON admin_audit_log(phi_accessed) WHERE phi_accessed = true;
CREATE INDEX idx_audit_break_glass ON admin_audit_log(break_glass_request_id) WHERE break_glass_request_id IS NOT NULL;
```

### PHI Access Logging

Separate detailed logging for any access to Protected Health Information:

```sql
CREATE TABLE phi_access_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  accessor_id UUID NOT NULL,          -- admin_user_id or provider_id
  accessor_type VARCHAR(50) NOT NULL, -- 'admin', 'provider', 'system'

  patient_id UUID NOT NULL,

  access_type VARCHAR(100) NOT NULL,  -- 'view_record', 'view_prescription', 'export', etc.
  phi_categories TEXT[] NOT NULL,     -- ['demographics', 'medications', 'diagnoses']

  access_reason VARCHAR(255) NOT NULL, -- 'treatment', 'payment', 'operations', 'break_glass'
  justification TEXT,

  data_fields_accessed TEXT[],        -- Specific fields viewed
  data_exported BOOLEAN DEFAULT false,

  ip_address INET NOT NULL,
  session_id VARCHAR(255),

  accessed_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_phi_patient ON phi_access_log(patient_id);
CREATE INDEX idx_phi_accessor ON phi_access_log(accessor_id, accessor_type);
CREATE INDEX idx_phi_accessed_at ON phi_access_log(accessed_at);
```

### Security Checklist for Admin Access

#### Authentication Requirements

- [ ] MFA mandatory for all admin accounts (enforced at DB level)
- [ ] Session timeout: 15 minutes idle, 8 hours max
- [ ] IP allowlisting for Tier 0-1 access
- [ ] Device fingerprinting for anomaly detection
- [ ] Login notifications to admin email

#### Authorization Requirements

- [ ] Permissions checked on every request (middleware)
- [ ] Domain isolation enforced at API gateway
- [ ] Resource-level access control (not just role-based)
- [ ] Time-based access expiration for elevated roles
- [ ] Justification required for PHI access

#### Audit Requirements

- [ ] All admin actions logged (including reads)
- [ ] PHI access separately logged with patient ID
- [ ] Logs are immutable (append-only store)
- [ ] Log retention: 7 years minimum (HIPAA)
- [ ] Weekly audit review by compliance
- [ ] Anomaly alerting (unusual access patterns)

#### Incident Response

- [ ] Break glass procedures documented and tested
- [ ] Automatic access revocation on termination
- [ ] Post-incident review within 24-48 hours
- [ ] Escalation paths defined for each severity

### Row-Level Security for Service Isolation

PostgreSQL RLS policies ensure services can only access their domain:

```sql
-- Enable RLS on sensitive tables
ALTER TABLE patients ENABLE ROW LEVEL SECURITY;
ALTER TABLE prescriptions ENABLE ROW LEVEL SECURITY;
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;

-- Service role policies
CREATE POLICY patient_service_policy ON patients
  FOR ALL
  TO patient_service_role
  USING (true);  -- Patient service has full access to patients

CREATE POLICY provider_service_patient_policy ON patients
  FOR SELECT
  TO provider_service_role
  USING (
    id IN (
      SELECT patient_id FROM appointments
      WHERE provider_id IN (
        SELECT id FROM providers WHERE user_id = current_setting('app.current_user_id')::uuid
      )
    )
  );

CREATE POLICY pharmacy_service_patient_policy ON patients
  FOR SELECT
  TO pharmacy_service_role
  USING (
    id IN (
      SELECT patient_id FROM orders WHERE status IN ('queued', 'compounding', 'ready_to_ship')
    )
  );

-- Admin policies with domain isolation
CREATE POLICY storefront_admin_orders ON orders
  FOR ALL
  TO storefront_admin_role
  USING (true);

CREATE POLICY pharmacy_admin_orders ON orders
  FOR SELECT
  TO pharmacy_admin_role
  USING (status NOT IN ('pending', 'cancelled'));  -- Only sees manufacturing-relevant orders
```

---

## SMS & Notifications

### Overview

SMS messaging for appointments, prescriptions, and order updates with HIPAA-compliant consent management.

### HIPAA Considerations for SMS

SMS is inherently unencrypted and travels through carrier networks in plaintext. This creates PHI disclosure risks.

| Message Type | PHI Risk | Recommendation |
|--------------|----------|----------------|
| "You have an appointment tomorrow at 2pm" | Low | Safe without explicit consent |
| "Appointment with Dr. Smith tomorrow" | Medium | Reveals healthcare relationship |
| "Your semaglutide prescription is ready" | High | Requires explicit PHI consent |
| "Order #12345 shipped" | Low | Order ID alone is not PHI |

**General Rule**: Default to minimal information. Let patients opt into more detailed messages.

### Consent Tiers

Patients choose their comfort level for SMS communications:

| Tier | Name | What's Included | Consent Required |
|------|------|-----------------|------------------|
| 0 | None | No SMS - email/portal only | N/A |
| 1 | Minimal | Generic reminders only ("You have an appointment") | TCPA consent |
| 2 | Standard | + Provider name, appointment type | TCPA + Basic PHI consent |
| 3 | Full | + Medication names, dosages, order details | TCPA + Explicit PHI consent |

### Message Templates

```typescript
const smsTemplates = {
  appointmentReminder: {
    tier1: 'You have an appointment on {{date}} at {{time}}. Reply C to confirm or R to reschedule.',
    tier2: 'Reminder: {{appointmentType}} with {{providerName}} on {{date}} at {{time}}. Reply C to confirm.',
    tier3: 'Reminder: {{appointmentType}} with {{providerName}} for {{reason}} on {{date}} at {{time}}. Reply C to confirm.'
  },

  appointmentConfirmed: {
    tier1: 'Your appointment is confirmed for {{date}} at {{time}}.',
    tier2: 'Confirmed: {{appointmentType}} with {{providerName}} on {{date}} at {{time}}.'
  },

  prescriptionReady: {
    tier1: 'Your prescription is ready. Log in to view details: {{secureLink}}',
    tier2: 'Your prescription from {{providerName}} is ready for processing.',
    tier3: 'Your {{medicationName}} prescription is ready. Estimated ship date: {{shipDate}}.'
  },

  orderShipped: {
    tier1: 'Your order has shipped. Track at: {{trackingLink}}',
    tier2: 'Your order has shipped via {{carrier}}. Track at: {{trackingLink}}',
    tier3: 'Your {{medicationName}} has shipped via {{carrier}}. Tracking: {{trackingNumber}}'
  },

  orderDelivered: {
    tier1: 'Your order has been delivered.',
    tier2: 'Your order has been delivered to {{city}}, {{state}}.',
    tier3: 'Your {{medicationName}} has been delivered.'
  }
};
```

### Two-Way SMS Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         OUTBOUND SMS FLOW                                │
└─────────────────────────────────────────────────────────────────────────┘

Appointment Created/Updated
         │
         ▼
┌─────────────────────┐
│ Appointment Service │
│ publishes event     │
└─────────────────────┘
         │
         ▼ (Event Bus - Kafka)
┌─────────────────────┐
│ Notification Service│
│ subscribes          │
└─────────────────────┘
         │
         ▼
┌─────────────────────┐     ┌──────────────────────┐
│ Check patient prefs │────▶│ SMS disabled?        │──▶ Skip SMS
│ & consent tier      │     │ Phone unverified?    │
└─────────────────────┘     └──────────────────────┘
         │ SMS enabled
         ▼
┌─────────────────────┐
│ Select template     │
│ based on consent    │
│ tier                │
└─────────────────────┘
         │
         ▼
┌─────────────────────┐
│ Twilio SMS API      │
│ Send message        │
└─────────────────────┘
         │
         ▼
┌─────────────────────┐
│ Log delivery status │
│ Store message ID    │
└─────────────────────┘


┌─────────────────────────────────────────────────────────────────────────┐
│                         INBOUND SMS FLOW                                 │
└─────────────────────────────────────────────────────────────────────────┘

Patient sends SMS reply
         │
         ▼
┌─────────────────────┐
│ Twilio Webhook      │
│ POST /sms/inbound   │
└─────────────────────┘
         │
         ▼
┌─────────────────────┐
│ Notification Service│
│ receives message    │
└─────────────────────┘
         │
         ▼
┌─────────────────────┐
│ Parse intent:       │
│ C/Y = Confirm       │
│ R/N = Reschedule    │
│ STOP = Opt-out      │
│ HELP = Send help    │
└─────────────────────┘
         │
         ├── STOP ──▶ Update preferences, send opt-out confirmation
         │
         ├── HELP ──▶ Send help message with options
         │
         ├── C/Y ───▶ Appointment Service: confirm appointment
         │                    │
         │                    ▼
         │            Send confirmation SMS
         │
         └── R/N ───▶ Send reschedule link (secure portal)
```

### Data Models

```typescript
interface PatientCommunicationPreferences {
  patientId: string;

  smsEnabled: boolean;
  smsPhoneNumber?: string;
  smsPhoneVerified: boolean;
  smsConsentTier: 0 | 1 | 2 | 3;
  smsConsentedAt?: Date;
  smsOptOutAt?: Date;

  emailEnabled: boolean;
  emailAddress: string;
  emailVerified: boolean;

  pushEnabled: boolean;
  pushTokens: string[];

  preferredChannel: 'sms' | 'email' | 'push';

  quietHoursStart?: string;  // "22:00"
  quietHoursEnd?: string;    // "08:00"
  timezone: string;

  updatedAt: Date;
}

interface SmsMessage {
  id: string;
  patientId: string;
  phoneNumber: string;

  direction: 'outbound' | 'inbound';
  messageType: 'appointment_reminder' | 'appointment_confirmed' | 'prescription_ready' | 'order_shipped' | 'order_delivered' | 'verification' | 'reply' | 'opt_out';

  templateId?: string;
  consentTierUsed: 0 | 1 | 2 | 3;

  content: string;
  contentRedacted: string;  // PHI stripped for logs

  twilioMessageSid?: string;
  twilioStatus?: 'queued' | 'sent' | 'delivered' | 'failed' | 'undelivered';
  twilioErrorCode?: string;

  relatedEntityType?: 'appointment' | 'prescription' | 'order';
  relatedEntityId?: string;

  sentAt?: Date;
  deliveredAt?: Date;
  receivedAt?: Date;

  createdAt: Date;
}

interface SmsConsent {
  id: string;
  patientId: string;
  phoneNumber: string;

  consentType: 'tcpa' | 'phi_basic' | 'phi_full';
  consentTier: 1 | 2 | 3;

  consentedAt: Date;
  consentMethod: 'web_form' | 'sms_reply' | 'verbal' | 'paper';
  consentIpAddress?: string;

  revokedAt?: Date;
  revokeMethod?: 'sms_stop' | 'web_form' | 'verbal' | 'paper';

  consentText: string;  // Exact language shown to patient
}
```

### Database Schema

```sql
CREATE TABLE patient_communication_preferences (
  patient_id UUID PRIMARY KEY REFERENCES patients(id),

  sms_enabled BOOLEAN DEFAULT false,
  sms_phone_number VARCHAR(20),
  sms_phone_verified BOOLEAN DEFAULT false,
  sms_consent_tier SMALLINT DEFAULT 0 CHECK (sms_consent_tier >= 0 AND sms_consent_tier <= 3),
  sms_consented_at TIMESTAMPTZ,
  sms_opt_out_at TIMESTAMPTZ,

  email_enabled BOOLEAN DEFAULT true,
  email_address VARCHAR(255) NOT NULL,
  email_verified BOOLEAN DEFAULT false,

  push_enabled BOOLEAN DEFAULT false,
  push_tokens TEXT[],

  preferred_channel VARCHAR(20) DEFAULT 'email',

  quiet_hours_start TIME,
  quiet_hours_end TIME,
  timezone VARCHAR(50) DEFAULT 'America/Denver',

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE sms_messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  patient_id UUID NOT NULL REFERENCES patients(id),
  phone_number VARCHAR(20) NOT NULL,

  direction VARCHAR(10) NOT NULL,
  message_type VARCHAR(50) NOT NULL,

  template_id VARCHAR(100),
  consent_tier_used SMALLINT NOT NULL,

  content_encrypted BYTEA NOT NULL,       -- Encrypted message content
  content_redacted VARCHAR(500) NOT NULL, -- PHI-free version for logs

  twilio_message_sid VARCHAR(50),
  twilio_status VARCHAR(20),
  twilio_error_code VARCHAR(10),

  related_entity_type VARCHAR(50),
  related_entity_id UUID,

  sent_at TIMESTAMPTZ,
  delivered_at TIMESTAMPTZ,
  received_at TIMESTAMPTZ,

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE sms_consent (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  patient_id UUID NOT NULL REFERENCES patients(id),
  phone_number VARCHAR(20) NOT NULL,

  consent_type VARCHAR(20) NOT NULL,
  consent_tier SMALLINT NOT NULL,

  consented_at TIMESTAMPTZ NOT NULL,
  consent_method VARCHAR(20) NOT NULL,
  consent_ip_address INET,

  revoked_at TIMESTAMPTZ,
  revoke_method VARCHAR(20),

  consent_text TEXT NOT NULL,

  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_sms_messages_patient ON sms_messages(patient_id);
CREATE INDEX idx_sms_messages_sent_at ON sms_messages(sent_at);
CREATE INDEX idx_sms_messages_twilio_sid ON sms_messages(twilio_message_sid);
CREATE INDEX idx_sms_consent_patient ON sms_consent(patient_id);
CREATE INDEX idx_sms_consent_active ON sms_consent(patient_id, consent_tier) WHERE revoked_at IS NULL;
```

### Phone Verification Flow

Before sending SMS, phone numbers must be verified:

```
Patient enters phone number
         │
         ▼
┌─────────────────────┐
│ Send 6-digit code   │
│ via SMS             │
└─────────────────────┘
         │
         ▼
┌─────────────────────┐
│ Patient enters code │
│ (3 attempts max)    │
└─────────────────────┘
         │
         ▼
┌─────────────────────┐     ┌──────────────────────┐
│ Code matches?       │─No─▶│ Increment attempts   │
│                     │     │ Lock after 3 fails   │
└─────────────────────┘     └──────────────────────┘
         │ Yes
         ▼
┌─────────────────────┐
│ Mark phone verified │
│ Show consent form   │
└─────────────────────┘
         │
         ▼
┌─────────────────────┐
│ Patient selects     │
│ consent tier (1-3)  │
│ Reviews language    │
│ Accepts consent     │
└─────────────────────┘
         │
         ▼
┌─────────────────────┐
│ Store consent       │
│ Enable SMS          │
└─────────────────────┘
```

### Notification Service Integration

```typescript
interface NotificationEvent {
  type: 'appointment.created' | 'appointment.reminder' | 'appointment.cancelled' |
        'prescription.ready' | 'order.shipped' | 'order.delivered';
  patientId: string;
  data: Record<string, unknown>;
  scheduledFor?: Date;  // For scheduled reminders
}

const handleNotificationEvent = async (event: NotificationEvent) => {
  const prefs = await getPatientPreferences(event.patientId);

  if (isQuietHours(prefs)) {
    await scheduleForLater(event, getQuietHoursEnd(prefs));
    return;
  }

  const channels: Promise<void>[] = [];

  if (prefs.smsEnabled && prefs.smsPhoneVerified) {
    channels.push(sendSms(event, prefs));
  }

  if (prefs.emailEnabled && prefs.emailVerified) {
    channels.push(sendEmail(event, prefs));
  }

  if (prefs.pushEnabled && prefs.pushTokens.length > 0) {
    channels.push(sendPush(event, prefs));
  }

  await Promise.allSettled(channels);
};

const sendSms = async (event: NotificationEvent, prefs: PatientCommunicationPreferences) => {
  const template = getTemplate(event.type, prefs.smsConsentTier);
  const content = renderTemplate(template, event.data);
  const redacted = redactPhi(content);

  const result = await twilio.messages.create({
    to: prefs.smsPhoneNumber,
    from: process.env.TWILIO_PHONE_NUMBER,
    body: content,
    statusCallback: `${process.env.API_URL}/webhooks/twilio/status`
  });

  await saveSmsMessage({
    patientId: event.patientId,
    phoneNumber: prefs.smsPhoneNumber,
    direction: 'outbound',
    messageType: event.type,
    consentTierUsed: prefs.smsConsentTier,
    content,
    contentRedacted: redacted,
    twilioMessageSid: result.sid,
    twilioStatus: result.status,
    relatedEntityType: getEntityType(event.type),
    relatedEntityId: event.data.entityId,
    sentAt: new Date()
  });
};
```

### Twilio Webhook Handlers

```typescript
const handleTwilioStatusCallback = async (req: Request) => {
  const { MessageSid, MessageStatus, ErrorCode } = req.body;

  await updateSmsMessage(MessageSid, {
    twilioStatus: MessageStatus,
    twilioErrorCode: ErrorCode,
    deliveredAt: MessageStatus === 'delivered' ? new Date() : undefined
  });

  if (MessageStatus === 'failed' || MessageStatus === 'undelivered') {
    await logDeliveryFailure(MessageSid, ErrorCode);
  }
};

const handleTwilioInbound = async (req: Request) => {
  const { From, Body, MessageSid } = req.body;

  const patient = await findPatientByPhone(From);
  if (!patient) {
    return twiml.message('Reply HELP for assistance or visit our website.');
  }

  const normalizedBody = Body.trim().toUpperCase();

  await saveSmsMessage({
    patientId: patient.id,
    phoneNumber: From,
    direction: 'inbound',
    messageType: 'reply',
    consentTierUsed: 0,
    content: Body,
    contentRedacted: Body,  // Inbound doesn't contain our PHI
    twilioMessageSid: MessageSid,
    receivedAt: new Date()
  });

  switch (normalizedBody) {
    case 'STOP':
    case 'UNSUBSCRIBE':
    case 'CANCEL':
      await optOutPatient(patient.id, From);
      return twiml.message('You have been unsubscribed. Reply START to resubscribe.');

    case 'START':
      await resubscribePatient(patient.id, From);
      return twiml.message('You have been resubscribed to messages.');

    case 'HELP':
      return twiml.message('Reply C to confirm, R to reschedule. Reply STOP to unsubscribe. Call 1-800-XXX-XXXX for help.');

    case 'C':
    case 'Y':
    case 'YES':
    case 'CONFIRM':
      const pendingAppt = await findPendingAppointment(patient.id);
      if (pendingAppt) {
        await confirmAppointment(pendingAppt.id);
        return twiml.message('Your appointment is confirmed. See you then!');
      }
      return twiml.message('No pending appointment found. Log in to view your appointments.');

    case 'R':
    case 'N':
    case 'NO':
    case 'RESCHEDULE':
      const rescheduleLink = await generateSecureLink(patient.id, 'reschedule');
      return twiml.message(`To reschedule, visit: ${rescheduleLink}`);

    default:
      return twiml.message('Reply C to confirm, R to reschedule, or HELP for options.');
  }
};
```

### Admin Portal: SMS Management

Storefront Admin includes SMS oversight capabilities:

| Function | Permission | Description |
|----------|------------|-------------|
| View SMS history | `sms:read` | See all messages for a patient (redacted by default) |
| View full content | `sms:read_phi` | See unredacted message content (Tier 2+, logged) |
| Resend failed SMS | `sms:resend` | Retry failed deliveries |
| Manage opt-outs | `sms:manage_optout` | View opt-out list, cannot override patient choice |
| View delivery metrics | `sms:analytics` | Delivery rates, failure reasons, response rates |

### Scheduling Reminders

Appointment reminders are scheduled, not sent immediately:

```typescript
interface ScheduledReminder {
  id: string;
  appointmentId: string;
  patientId: string;

  reminderType: '48_hour' | '24_hour' | '2_hour';
  scheduledFor: Date;

  status: 'scheduled' | 'sent' | 'cancelled' | 'skipped';
  sentAt?: Date;
  skipReason?: string;  // 'appointment_cancelled', 'patient_opted_out', 'already_confirmed'
}

const scheduleAppointmentReminders = async (appointment: Appointment) => {
  const reminders = [
    { type: '48_hour', offset: -48 * 60 * 60 * 1000 },
    { type: '24_hour', offset: -24 * 60 * 60 * 1000 },
    { type: '2_hour', offset: -2 * 60 * 60 * 1000 }
  ];

  for (const reminder of reminders) {
    const scheduledFor = new Date(appointment.scheduledAt.getTime() + reminder.offset);

    if (scheduledFor > new Date()) {
      await createScheduledReminder({
        appointmentId: appointment.id,
        patientId: appointment.patientId,
        reminderType: reminder.type,
        scheduledFor,
        status: 'scheduled'
      });
    }
  }
};
```

### Vendor: Twilio Configuration

```typescript
const twilioConfig = {
  accountSid: process.env.TWILIO_ACCOUNT_SID,
  authToken: process.env.TWILIO_AUTH_TOKEN,

  phoneNumbers: {
    transactional: process.env.TWILIO_PHONE_TRANSACTIONAL,  // Appointment reminders
    marketing: process.env.TWILIO_PHONE_MARKETING,          // Promotions (if any)
    shortCode: process.env.TWILIO_SHORT_CODE                // Optional: 5-digit for higher throughput
  },

  statusCallbackUrl: `${process.env.API_URL}/webhooks/twilio/status`,
  inboundWebhookUrl: `${process.env.API_URL}/webhooks/twilio/inbound`,

  rateLimits: {
    perSecond: 10,      // Twilio default
    perDay: 10000       // Self-imposed limit
  }
};
```

---

## Push Notification Infrastructure

Mobile push notifications for iOS (APNs) and Android (FCM) with unified delivery, token management, and engagement tracking.

### Push Notification Architecture

```typescript
interface PushNotificationService {
  tokenManagement: TokenRegistry;
  deliveryEngine: PushDeliveryEngine;
  templateEngine: PushTemplateEngine;
  analytics: PushAnalytics;
}

interface DevicePushToken {
  id: string;
  patientId: string;
  platform: 'ios' | 'android' | 'web';
  token: string;
  deviceId: string;
  deviceInfo: {
    model: string;
    osVersion: string;
    appVersion: string;
    locale: string;
    timezone: string;
  };
  permissions: {
    alertsEnabled: boolean;
    badgesEnabled: boolean;
    soundsEnabled: boolean;
    criticalAlertsEnabled: boolean;
  };
  status: 'active' | 'expired' | 'revoked' | 'failed';
  lastUsedAt: string;
  createdAt: string;
  updatedAt: string;
}

interface PushNotification {
  id: string;
  patientId: string;
  type: PushNotificationType;
  priority: 'normal' | 'high' | 'critical';

  content: {
    title: string;
    body: string;
    subtitle?: string;
    imageUrl?: string;
    sound?: string;
    badge?: number;
  };

  data: {
    deepLink: string;
    entityType?: string;
    entityId?: string;
    actionButtons?: PushAction[];
    [key: string]: unknown;
  };

  targeting: {
    tokenIds: string[];
    platforms: ('ios' | 'android' | 'web')[];
  };

  scheduling: {
    sendAt?: string;
    expiresAt?: string;
    timezone?: string;
  };

  delivery: PushDeliveryStatus[];
  analytics: PushEngagement;

  createdAt: string;
}

type PushNotificationType =
  | 'appointment_reminder'
  | 'appointment_starting'
  | 'prescription_ready'
  | 'order_shipped'
  | 'order_delivered'
  | 'medication_reminder'
  | 'refill_reminder'
  | 'lab_results_ready'
  | 'message_received'
  | 'payment_due'
  | 'payment_failed'
  | 'provider_response'
  | 'health_alert'
  | 'promotional';

interface PushAction {
  id: string;
  title: string;
  action: 'open_app' | 'deep_link' | 'dismiss' | 'snooze' | 'reply';
  deepLink?: string;
  destructive?: boolean;
  authRequired?: boolean;
}

interface PushDeliveryStatus {
  tokenId: string;
  platform: 'ios' | 'android' | 'web';
  status: 'pending' | 'sent' | 'delivered' | 'failed' | 'expired';
  sentAt?: string;
  deliveredAt?: string;
  failureReason?: string;
  providerMessageId?: string;
}

interface PushEngagement {
  sent: number;
  delivered: number;
  opened: number;
  dismissed: number;
  actionTaken?: {
    actionId: string;
    count: number;
  }[];
  firstOpenedAt?: string;
}
```

### Token Registration & Management

```typescript
interface TokenRegistry {
  registerToken: (registration: TokenRegistration) => Promise<DevicePushToken>;
  refreshToken: (oldToken: string, newToken: string) => Promise<void>;
  revokeToken: (tokenId: string, reason: string) => Promise<void>;
  getActiveTokens: (patientId: string) => Promise<DevicePushToken[]>;
  cleanupExpiredTokens: () => Promise<number>;
}

interface TokenRegistration {
  patientId: string;
  platform: 'ios' | 'android' | 'web';
  token: string;
  deviceId: string;
  deviceInfo: DevicePushToken['deviceInfo'];
  permissions: DevicePushToken['permissions'];
}

const registerPushToken = async (registration: TokenRegistration): Promise<DevicePushToken> => {
  const existingToken = await findTokenByDeviceId(registration.patientId, registration.deviceId);

  if (existingToken) {
    if (existingToken.token !== registration.token) {
      await updateToken(existingToken.id, {
        token: registration.token,
        permissions: registration.permissions,
        deviceInfo: registration.deviceInfo,
        status: 'active',
        updatedAt: new Date().toISOString()
      });
    }
    return existingToken;
  }

  return await createToken({
    ...registration,
    id: generateId(),
    status: 'active',
    lastUsedAt: new Date().toISOString(),
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
  });
};

const handleTokenRefresh = async (oldToken: string, newToken: string): Promise<void> => {
  const tokenRecord = await findByToken(oldToken);
  if (tokenRecord) {
    await updateToken(tokenRecord.id, {
      token: newToken,
      status: 'active',
      updatedAt: new Date().toISOString()
    });
  }
};

const handleDeliveryFeedback = async (token: string, status: 'invalid' | 'unregistered'): Promise<void> => {
  const tokenRecord = await findByToken(token);
  if (tokenRecord) {
    await updateToken(tokenRecord.id, {
      status: status === 'invalid' ? 'expired' : 'revoked',
      updatedAt: new Date().toISOString()
    });
  }
};
```

### Platform-Specific Delivery

```typescript
interface PushDeliveryEngine {
  sendToiOS: (notification: PushNotification, tokens: DevicePushToken[]) => Promise<PushDeliveryStatus[]>;
  sendToAndroid: (notification: PushNotification, tokens: DevicePushToken[]) => Promise<PushDeliveryStatus[]>;
  sendToWeb: (notification: PushNotification, tokens: DevicePushToken[]) => Promise<PushDeliveryStatus[]>;
}

const sendToAPNs = async (notification: PushNotification, tokens: DevicePushToken[]): Promise<PushDeliveryStatus[]> => {
  const apnsPayload = {
    aps: {
      alert: {
        title: notification.content.title,
        subtitle: notification.content.subtitle,
        body: notification.content.body
      },
      badge: notification.content.badge,
      sound: notification.content.sound || 'default',
      'mutable-content': 1,
      'content-available': 1,
      'interruption-level': notification.priority === 'critical' ? 'critical' :
                            notification.priority === 'high' ? 'time-sensitive' : 'active'
    },
    ...notification.data
  };

  const results: PushDeliveryStatus[] = [];

  for (const token of tokens) {
    try {
      const response = await apnsClient.send({
        deviceToken: token.token,
        payload: apnsPayload,
        topic: process.env.APNS_BUNDLE_ID,
        expiration: notification.scheduling.expiresAt ?
          Math.floor(new Date(notification.scheduling.expiresAt).getTime() / 1000) : 0,
        priority: notification.priority === 'normal' ? 5 : 10,
        pushType: 'alert'
      });

      results.push({
        tokenId: token.id,
        platform: 'ios',
        status: 'sent',
        sentAt: new Date().toISOString(),
        providerMessageId: response.messageId
      });
    } catch (error) {
      results.push({
        tokenId: token.id,
        platform: 'ios',
        status: 'failed',
        failureReason: error.reason || error.message
      });

      if (error.reason === 'BadDeviceToken' || error.reason === 'Unregistered') {
        await handleDeliveryFeedback(token.token, 'unregistered');
      }
    }
  }

  return results;
};

const sendToFCM = async (notification: PushNotification, tokens: DevicePushToken[]): Promise<PushDeliveryStatus[]> => {
  const fcmPayload = {
    notification: {
      title: notification.content.title,
      body: notification.content.body,
      image: notification.content.imageUrl
    },
    data: {
      ...notification.data,
      click_action: 'FLUTTER_NOTIFICATION_CLICK'
    },
    android: {
      priority: notification.priority === 'normal' ? 'normal' : 'high',
      notification: {
        channel_id: getChannelId(notification.type),
        sound: notification.content.sound || 'default',
        default_sound: true,
        default_vibrate_timings: true
      },
      ttl: notification.scheduling.expiresAt ?
        `${Math.floor((new Date(notification.scheduling.expiresAt).getTime() - Date.now()) / 1000)}s` : undefined
    }
  };

  const results: PushDeliveryStatus[] = [];
  const tokenStrings = tokens.map(t => t.token);

  const response = await firebaseAdmin.messaging().sendEachForMulticast({
    tokens: tokenStrings,
    ...fcmPayload
  });

  response.responses.forEach((res, index) => {
    const token = tokens[index];
    if (res.success) {
      results.push({
        tokenId: token.id,
        platform: 'android',
        status: 'sent',
        sentAt: new Date().toISOString(),
        providerMessageId: res.messageId
      });
    } else {
      results.push({
        tokenId: token.id,
        platform: 'android',
        status: 'failed',
        failureReason: res.error?.message
      });

      if (res.error?.code === 'messaging/registration-token-not-registered') {
        handleDeliveryFeedback(token.token, 'unregistered');
      }
    }
  });

  return results;
};
```

### Push Notification Templates

```typescript
interface PushTemplate {
  type: PushNotificationType;
  title: string;
  bodyTemplate: string;
  defaultSound: string;
  defaultPriority: 'normal' | 'high' | 'critical';
  actions?: PushAction[];
  deepLinkPattern: string;
  ttlMinutes: number;
}

const pushTemplates: Record<PushNotificationType, PushTemplate> = {
  appointment_reminder: {
    type: 'appointment_reminder',
    title: 'Upcoming Appointment',
    bodyTemplate: 'Your appointment with {{providerName}} is in {{timeUntil}}',
    defaultSound: 'default',
    defaultPriority: 'high',
    actions: [
      { id: 'join', title: 'Join Now', action: 'deep_link', deepLink: '/appointments/{{appointmentId}}/join' },
      { id: 'reschedule', title: 'Reschedule', action: 'deep_link', deepLink: '/appointments/{{appointmentId}}/reschedule' }
    ],
    deepLinkPattern: '/appointments/{{appointmentId}}',
    ttlMinutes: 60
  },

  medication_reminder: {
    type: 'medication_reminder',
    title: 'Medication Reminder',
    bodyTemplate: "Time to take your {{medicationName}}",
    defaultSound: 'medication_reminder.wav',
    defaultPriority: 'high',
    actions: [
      { id: 'taken', title: 'Mark as Taken', action: 'dismiss' },
      { id: 'snooze', title: 'Snooze 15 min', action: 'snooze' }
    ],
    deepLinkPattern: '/medications/{{medicationId}}/log',
    ttlMinutes: 30
  },

  order_shipped: {
    type: 'order_shipped',
    title: 'Order Shipped! 📦',
    bodyTemplate: 'Your order is on the way. Expected delivery: {{expectedDate}}',
    defaultSound: 'default',
    defaultPriority: 'normal',
    actions: [
      { id: 'track', title: 'Track Package', action: 'deep_link', deepLink: '/orders/{{orderId}}/tracking' }
    ],
    deepLinkPattern: '/orders/{{orderId}}',
    ttlMinutes: 1440
  },

  health_alert: {
    type: 'health_alert',
    title: 'Health Alert',
    bodyTemplate: '{{alertMessage}}',
    defaultSound: 'critical_alert.wav',
    defaultPriority: 'critical',
    deepLinkPattern: '/health/alerts/{{alertId}}',
    ttlMinutes: 60
  },

  message_received: {
    type: 'message_received',
    title: 'New Message',
    bodyTemplate: '{{senderName}}: {{messagePreview}}',
    defaultSound: 'message.wav',
    defaultPriority: 'high',
    actions: [
      { id: 'reply', title: 'Reply', action: 'reply' },
      { id: 'view', title: 'View', action: 'deep_link', deepLink: '/messages/{{threadId}}' }
    ],
    deepLinkPattern: '/messages/{{threadId}}',
    ttlMinutes: 1440
  }
};
```

### Push Analytics & Engagement Tracking

```typescript
interface PushAnalytics {
  trackDelivery: (notificationId: string, tokenId: string, status: string) => Promise<void>;
  trackOpen: (notificationId: string, tokenId: string) => Promise<void>;
  trackAction: (notificationId: string, tokenId: string, actionId: string) => Promise<void>;
  getMetrics: (timeRange: TimeRange) => Promise<PushMetricsSummary>;
}

interface PushMetricsSummary {
  period: { start: string; end: string };

  volume: {
    sent: number;
    delivered: number;
    failed: number;
    deliveryRate: number;
  };

  engagement: {
    opened: number;
    openRate: number;
    actionsTaken: number;
    actionRate: number;
    averageTimeToOpen: number;
  };

  byType: {
    type: PushNotificationType;
    sent: number;
    deliveryRate: number;
    openRate: number;
    actionRate: number;
  }[];

  byPlatform: {
    platform: 'ios' | 'android' | 'web';
    sent: number;
    deliveryRate: number;
    openRate: number;
  }[];

  failures: {
    reason: string;
    count: number;
    percentage: number;
  }[];

  optOuts: {
    date: string;
    count: number;
    reasons: string[];
  }[];
}

const trackPushOpen = async (notificationId: string, tokenId: string): Promise<void> => {
  const notification = await getNotification(notificationId);
  if (!notification) return;

  await updateNotificationAnalytics(notificationId, {
    $inc: { 'analytics.opened': 1 },
    $set: {
      'analytics.firstOpenedAt': notification.analytics.firstOpenedAt || new Date().toISOString()
    }
  });

  await updateDeliveryStatus(notificationId, tokenId, {
    openedAt: new Date().toISOString()
  });

  await publishEvent('push.opened', {
    notificationId,
    tokenId,
    patientId: notification.patientId,
    type: notification.type,
    openedAt: new Date().toISOString()
  });
};
```

### Push Notification Preferences

```typescript
interface PushPreferences {
  patientId: string;

  globalEnabled: boolean;

  byCategory: {
    appointments: boolean;
    medications: boolean;
    orders: boolean;
    messages: boolean;
    healthAlerts: boolean;
    promotions: boolean;
  };

  quietHours: {
    enabled: boolean;
    start: string;
    end: string;
    timezone: string;
    allowCritical: boolean;
  };

  frequency: {
    maxPerHour: number;
    maxPerDay: number;
    digestMode: boolean;
    digestTime?: string;
  };
}

const shouldSendPush = async (patientId: string, notification: PushNotification): Promise<boolean> => {
  const prefs = await getPushPreferences(patientId);

  if (!prefs.globalEnabled) return false;

  const category = getCategoryForType(notification.type);
  if (!prefs.byCategory[category]) return false;

  if (prefs.quietHours.enabled && isQuietHours(prefs.quietHours)) {
    if (notification.priority !== 'critical' || !prefs.quietHours.allowCritical) {
      await scheduleForAfterQuietHours(notification, prefs.quietHours);
      return false;
    }
  }

  const recentCount = await getRecentPushCount(patientId, 'hour');
  if (recentCount >= prefs.frequency.maxPerHour) {
    if (prefs.frequency.digestMode) {
      await addToDigest(patientId, notification);
      return false;
    }
  }

  return true;
};
```

---

## Marketing Architecture

### Overview

DTC marketing infrastructure for patient acquisition, retention, and referral with healthcare-specific compliance requirements.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           MARKETING STACK                                    │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                         ACQUISITION CHANNELS                                 │
├─────────────────┬─────────────────┬─────────────────┬───────────────────────┤
│   Google Ads    │   Meta Ads      │   Programmatic  │   Content / SEO       │
│   (LegitScript) │   (LegitScript) │   (TTD, etc.)   │   (Organic)           │
└────────┬────────┴────────┬────────┴────────┬────────┴───────────┬───────────┘
         │                 │                 │                     │
         └─────────────────┴─────────────────┴─────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         TRACKING & ATTRIBUTION                               │
├─────────────────────────────────────────────────────────────────────────────┤
│   First-Party Events → Event Bus → Analytics (GA4, Mixpanel, Amplitude)     │
│                                  → Ad Platforms (CAPI)                       │
│                                  → Attribution (Northbeam, Rockerbox)        │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      CUSTOMER DATA PLATFORM (CDP)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│   Segment / RudderStack / Custom                                             │
│   - Identity resolution                                                      │
│   - Audience building                                                        │
│   - Data warehouse sync                                                      │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    ▼                               ▼
┌───────────────────────────────────┐ ┌───────────────────────────────────────┐
│         RETENTION                  │ │           REFERRAL                    │
├───────────────────────────────────┤ ├───────────────────────────────────────┤
│ Klaviyo / Customer.io             │ │ Referral Service                      │
│ - Email campaigns                 │ │ - Referral codes                      │
│ - SMS marketing                   │ │ - Reward tracking                     │
│ - Lifecycle flows                 │ │ - Payout management                   │
└───────────────────────────────────┘ └───────────────────────────────────────┘
```

### Healthcare Advertising Compliance

#### LegitScript Certification

Required for pharmacy advertising on Google and Meta.

| Requirement | Description |
|-------------|-------------|
| Pharmacy License | Valid license in operating states |
| Prescriber Verification | Documented prescriber relationships |
| Prescription Process | Clear Rx verification workflow |
| No Controlled Substances | Or proper DEA documentation |
| Domain Verification | Ads must link to certified domain |

**Timeline**: 2-4 weeks for approval, ~$1,500-2,500 annually

#### Creative Restrictions

```typescript
const adCreativeRules = {
  prohibited: [
    'Before/after images for most conditions',
    'Cure or treatment guarantees',
    'Unsubstantiated health claims',
    'Targeting by health condition (Meta)',
    'Remarketing based on health pages (some platforms)',
    'Showing injection/administration',
    'Celebrity health endorsements without disclosure'
  ],

  required: [
    'Testimonial disclaimers ("Results may vary")',
    'Prescription requirement disclosures',
    'Fair balance (benefits + risks for Rx)',
    'Licensed pharmacy disclosure',
    'State availability limitations'
  ],

  bestPractices: [
    'Lifestyle imagery over clinical',
    'Focus on convenience/access, not drug efficacy',
    'Educational content over promotional',
    'Provider credibility emphasis'
  ]
};
```

### Marketing Consent Management

Separate from transactional consent (appointments, orders). Marketing requires explicit opt-in.

```typescript
interface MarketingConsent {
  patientId: string;

  emailMarketing: boolean;
  emailMarketingConsentedAt?: Date;

  smsMarketing: boolean;
  smsMarketingConsentedAt?: Date;
  smsMarketingPhone?: string;

  pushMarketing: boolean;
  pushMarketingConsentedAt?: Date;

  thirdPartySharing: boolean;  // For lookalike audiences, etc.
  thirdPartySharingConsentedAt?: Date;

  dataForAds: boolean;  // Can use purchase data for ad optimization
  dataForAdsConsentedAt?: Date;

  consentSource: 'checkout' | 'account_settings' | 'popup' | 'sms_keyword';
  consentIpAddress?: string;

  unsubscribedAt?: Date;
  unsubscribeSource?: string;
}
```

#### Consent Collection Points

| Touchpoint | Consent Types | UX Pattern |
|------------|---------------|------------|
| Checkout | Email, SMS marketing | Checkbox (unchecked default) |
| Account Creation | Email marketing | Checkbox with value prop |
| Post-Purchase | SMS marketing, referral | Modal with incentive |
| Footer Popup | Email (new visitors) | Exit intent or timed |
| SMS Keyword | SMS marketing | Text "JOIN" to shortcode |

### Event Tracking Architecture

First-party event collection for analytics and ad platform optimization.

```typescript
interface MarketingEvent {
  eventId: string;
  eventName: string;
  timestamp: Date;

  // Identity
  anonymousId: string;       // Pre-auth visitor ID
  userId?: string;           // Post-auth patient ID
  sessionId: string;

  // Attribution
  utmSource?: string;
  utmMedium?: string;
  utmCampaign?: string;
  utmContent?: string;
  utmTerm?: string;
  referrer?: string;
  landingPage?: string;

  // Event data (varies by event type)
  properties: Record<string, unknown>;

  // Context
  ipAddress: string;         // Hashed for privacy
  userAgent: string;
  deviceType: 'desktop' | 'mobile' | 'tablet';
  browser: string;
  os: string;

  // Consent status at time of event
  hasMarketingConsent: boolean;
  consentCategories: string[];
}

const trackableEvents = {
  // Awareness
  'page_viewed': { properties: ['page_path', 'page_title', 'referrer'] },
  'drug_searched': { properties: ['search_query', 'results_count'] },
  'drug_viewed': { properties: ['drug_id', 'drug_name', 'category'] },

  // Consideration
  'ai_consultation_started': { properties: ['entry_point'] },
  'ai_consultation_completed': { properties: ['duration', 'symptoms_discussed'] },
  'provider_viewed': { properties: ['provider_id', 'specialty'] },
  'pricing_viewed': { properties: ['drug_id', 'cash_price', 'insurance_checked'] },

  // Conversion
  'appointment_booked': { properties: ['provider_id', 'appointment_type', 'value'] },
  'checkout_started': { properties: ['cart_value', 'items'] },
  'checkout_completed': { properties: ['order_id', 'order_value', 'payment_method'] },

  // Retention
  'prescription_refill_started': { properties: ['prescription_id'] },
  'referral_link_generated': { properties: ['referral_code'] },
  'referral_link_shared': { properties: ['share_method'] },

  // Engagement
  'email_opened': { properties: ['campaign_id', 'email_type'] },
  'email_clicked': { properties: ['campaign_id', 'link_url'] },
  'sms_link_clicked': { properties: ['campaign_id'] }
};
```

### Event Distribution

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         EVENT FLOW                                           │
└─────────────────────────────────────────────────────────────────────────────┘

Browser/App Event
       │
       ▼
┌─────────────────────┐
│ First-Party Tracker │  (Custom JS, not GTM for control)
│ - Collect event     │
│ - Add context       │
│ - Check consent     │
└─────────────────────┘
       │
       ▼
┌─────────────────────┐
│ Event API           │  POST /api/events
│ - Validate schema   │
│ - Enrich (geo, etc) │
│ - Publish to bus    │
└─────────────────────┘
       │
       ▼ (Event Bus - Kafka)
       │
       ├──────────────────────────────────────────────────┐
       │                                                   │
       ▼                                                   ▼
┌─────────────────────┐                         ┌─────────────────────┐
│ Analytics Consumer  │                         │ Ad Platform Consumer│
│ - GA4 Measurement   │                         │ - Meta CAPI         │
│   Protocol          │                         │ - Google Ads API    │
│ - Mixpanel/Amplitude│                         │ - TikTok Events API │
│ - Data Warehouse    │                         │                     │
└─────────────────────┘                         └─────────────────────┘
       │                                                   │
       │                                                   │
       ▼                                                   ▼
┌─────────────────────┐                         ┌─────────────────────┐
│ CDP Consumer        │                         │ CRM Consumer        │
│ - Segment/Rudder    │                         │ - Klaviyo           │
│ - Identity stitch   │                         │ - Update profiles   │
│ - Audience sync     │                         │ - Trigger flows     │
└─────────────────────┘                         └─────────────────────┘
```

### Server-Side Tracking (CAPI)

Browser tracking is unreliable (ad blockers, iOS privacy). Server-side is essential.

```typescript
interface ConversionsApiConfig {
  meta: {
    pixelId: string;
    accessToken: string;
    testEventCode?: string;  // For testing
  };

  google: {
    measurementId: string;
    apiSecret: string;
  };

  tiktok: {
    pixelCode: string;
    accessToken: string;
  };
}

const sendMetaConversion = async (event: MarketingEvent) => {
  if (!event.hasMarketingConsent) return;

  const payload = {
    data: [{
      event_name: mapToMetaEvent(event.eventName),
      event_time: Math.floor(event.timestamp.getTime() / 1000),
      event_id: event.eventId,  // For deduplication
      event_source_url: event.properties.page_url,
      action_source: 'website',

      user_data: {
        em: hashSha256(event.properties.email),      // Hashed email
        ph: hashSha256(event.properties.phone),      // Hashed phone
        external_id: hashSha256(event.userId),
        client_ip_address: event.ipAddress,
        client_user_agent: event.userAgent,
        fbc: event.properties.fbc,                   // Click ID cookie
        fbp: event.properties.fbp                    // Browser ID cookie
      },

      custom_data: {
        currency: 'USD',
        value: event.properties.value,
        content_ids: event.properties.productIds,
        content_type: 'product'
      }
    }]
  };

  await fetch(`https://graph.facebook.com/v18.0/${pixelId}/events`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      ...payload,
      access_token: accessToken
    })
  });
};
```

### Referral System

Word-of-mouth is critical in healthcare. Custom referral system for control.

```typescript
interface ReferralProgram {
  id: string;
  name: string;
  isActive: boolean;

  referrerReward: ReferralReward;
  refereeReward: ReferralReward;

  conditions: {
    minOrderValue?: number;
    eligibleProducts?: string[];      // Empty = all
    refereesMustBeNew: boolean;
    maxReferralsPerReferrer?: number;
    expirationDays?: number;
  };

  createdAt: Date;
  updatedAt: Date;
}

interface ReferralReward {
  type: 'fixed_amount' | 'percentage' | 'free_product' | 'account_credit';
  value: number;
  maxValue?: number;  // Cap for percentage
  productId?: string; // For free product
}

interface ReferralCode {
  id: string;
  code: string;                // e.g., "JOHN50"
  referrerId: string;          // Patient who owns this code
  programId: string;

  timesUsed: number;
  totalRewardsEarned: number;

  isActive: boolean;
  expiresAt?: Date;

  createdAt: Date;
}

interface Referral {
  id: string;
  referralCodeId: string;
  referrerId: string;
  refereeId: string;

  status: 'pending' | 'qualified' | 'rewarded' | 'expired' | 'fraudulent';

  qualifyingOrderId?: string;
  qualifyingOrderValue?: number;

  referrerRewardAmount?: number;
  referrerRewardStatus: 'pending' | 'issued' | 'redeemed';
  referrerRewardIssuedAt?: Date;

  refereeRewardAmount?: number;
  refereeRewardApplied: boolean;

  attributedAt: Date;          // When referee used code
  qualifiedAt?: Date;          // When qualifying purchase made
  rewardedAt?: Date;

  fraudFlags: string[];
}
```

### Referral Database Schema

```sql
CREATE TABLE referral_programs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,
  is_active BOOLEAN DEFAULT true,

  referrer_reward_type VARCHAR(50) NOT NULL,
  referrer_reward_value DECIMAL(10,2) NOT NULL,
  referrer_reward_max DECIMAL(10,2),
  referrer_reward_product_id UUID,

  referee_reward_type VARCHAR(50) NOT NULL,
  referee_reward_value DECIMAL(10,2) NOT NULL,
  referee_reward_max DECIMAL(10,2),
  referee_reward_product_id UUID,

  min_order_value DECIMAL(10,2),
  eligible_product_ids UUID[],
  referees_must_be_new BOOLEAN DEFAULT true,
  max_referrals_per_referrer INTEGER,
  expiration_days INTEGER,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE referral_codes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code VARCHAR(50) UNIQUE NOT NULL,
  referrer_id UUID NOT NULL REFERENCES patients(id),
  program_id UUID NOT NULL REFERENCES referral_programs(id),

  times_used INTEGER DEFAULT 0,
  total_rewards_earned DECIMAL(10,2) DEFAULT 0,

  is_active BOOLEAN DEFAULT true,
  expires_at TIMESTAMPTZ,

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE referrals (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  referral_code_id UUID NOT NULL REFERENCES referral_codes(id),
  referrer_id UUID NOT NULL REFERENCES patients(id),
  referee_id UUID NOT NULL REFERENCES patients(id),

  status VARCHAR(50) DEFAULT 'pending',

  qualifying_order_id UUID,
  qualifying_order_value DECIMAL(10,2),

  referrer_reward_amount DECIMAL(10,2),
  referrer_reward_status VARCHAR(50) DEFAULT 'pending',
  referrer_reward_issued_at TIMESTAMPTZ,

  referee_reward_amount DECIMAL(10,2),
  referee_reward_applied BOOLEAN DEFAULT false,

  attributed_at TIMESTAMPTZ DEFAULT NOW(),
  qualified_at TIMESTAMPTZ,
  rewarded_at TIMESTAMPTZ,

  fraud_flags TEXT[],

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_referral_codes_referrer ON referral_codes(referrer_id);
CREATE INDEX idx_referral_codes_code ON referral_codes(code);
CREATE INDEX idx_referrals_referrer ON referrals(referrer_id);
CREATE INDEX idx_referrals_referee ON referrals(referee_id);
CREATE INDEX idx_referrals_status ON referrals(status);
```

### Referral Fraud Prevention

```typescript
const fraudChecks = {
  sameHousehold: async (referrerId: string, refereeId: string) => {
    const referrer = await getPatient(referrerId);
    const referee = await getPatient(refereeId);

    if (referrer.address.street1 === referee.address.street1 &&
        referrer.address.zipCode === referee.address.zipCode) {
      return { flagged: true, reason: 'same_address' };
    }
    return { flagged: false };
  },

  samePaymentMethod: async (referrerId: string, refereeId: string) => {
    const referrerCards = await getPaymentMethods(referrerId);
    const refereeCards = await getPaymentMethods(refereeId);

    const referrerFingerprints = referrerCards.map(c => c.fingerprint);
    const overlap = refereeCards.some(c => referrerFingerprints.includes(c.fingerprint));

    if (overlap) {
      return { flagged: true, reason: 'same_payment_method' };
    }
    return { flagged: false };
  },

  velocityCheck: async (referrerId: string) => {
    const recentReferrals = await getReferralsInPeriod(referrerId, '24_hours');

    if (recentReferrals.length > 5) {
      return { flagged: true, reason: 'high_velocity' };
    }
    return { flagged: false };
  },

  ipOverlap: async (referrerId: string, refereeId: string) => {
    const referrerIps = await getRecentIps(referrerId);
    const refereeIps = await getRecentIps(refereeId);

    const overlap = referrerIps.some(ip => refereeIps.includes(ip));
    if (overlap) {
      return { flagged: true, reason: 'ip_overlap' };
    }
    return { flagged: false };
  }
};

const processReferral = async (referral: Referral) => {
  const flags: string[] = [];

  for (const [checkName, checkFn] of Object.entries(fraudChecks)) {
    const result = await checkFn(referral.referrerId, referral.refereeId);
    if (result.flagged) {
      flags.push(result.reason);
    }
  }

  if (flags.length > 0) {
    await updateReferral(referral.id, {
      fraudFlags: flags,
      status: flags.length >= 2 ? 'fraudulent' : 'pending'  // Auto-reject if 2+ flags
    });
  }

  return flags;
};
```

### Email/CRM Integration

Klaviyo recommended for e-commerce + healthcare lifecycle.

```typescript
interface KlaviyoIntegration {
  apiKey: string;
  publicApiKey: string;

  lists: {
    newsletter: string;
    customers: string;
    activePatients: string;
    churned: string;
  };

  flows: {
    welcome: string;
    abandonedCart: string;
    postPurchase: string;
    refillReminder: string;
    winback: string;
    referralNudge: string;
  };
}

const syncPatientToKlaviyo = async (patient: Patient, consent: MarketingConsent) => {
  if (!consent.emailMarketing) return;

  await klaviyo.profiles.createOrUpdate({
    data: {
      type: 'profile',
      attributes: {
        email: patient.email,
        phone_number: consent.smsMarketing ? patient.phone : undefined,
        external_id: patient.id,

        first_name: patient.firstName,
        last_name: patient.lastName,

        properties: {
          // Non-PHI properties only
          state: patient.address.state,
          has_insurance: patient.insurancePolicies.length > 0,
          account_created_at: patient.createdAt,
          total_orders: await getOrderCount(patient.id),
          total_spent: await getTotalSpent(patient.id),
          last_order_date: await getLastOrderDate(patient.id),
          referral_code: await getReferralCode(patient.id)
        }
      }
    }
  });
};

const triggerKlaviyoEvent = async (patientId: string, eventName: string, properties: Record<string, unknown>) => {
  const consent = await getMarketingConsent(patientId);
  if (!consent.emailMarketing) return;

  const patient = await getPatient(patientId);

  await klaviyo.events.createEvent({
    data: {
      type: 'event',
      attributes: {
        profile: { email: patient.email },
        metric: { name: eventName },
        properties,
        time: new Date().toISOString()
      }
    }
  });
};
```

### Lifecycle Email Flows

| Flow | Trigger | Timing | Goal |
|------|---------|--------|------|
| Welcome | Account created | Immediate, +1d, +3d | Educate, first purchase |
| Abandoned Cart | Checkout started, no completion | +1h, +24h, +72h | Recover conversion |
| Post-Purchase | Order completed | +1d, +7d, +14d | Review, referral, education |
| Refill Reminder | Prescription eligible for refill | -14d, -7d, -3d | Retention |
| Win-back | No order in 90d | +90d, +120d, +150d | Re-engage |
| Referral Nudge | 2nd order completed | +3d | Generate referrals |

### Attribution Tracking

Healthcare has long consideration cycles. Multi-touch attribution matters.

```typescript
interface AttributionTouchpoint {
  id: string visitorId: string;
  patientId?: string;

  timestamp: Date;
  channel: 'organic_search' | 'paid_search' | 'paid_social' | 'organic_social' | 'email' | 'sms' | 'referral' | 'direct' | 'affiliate';
  source: string;           // google, meta, klaviyo, etc.
  medium: string;           // cpc, email, organic, etc.
  campaign?: string;
  content?: string;
  term?: string;

  landingPage: string;
  referrer?: string;

  clickIds: {
    gclid?: string;         // Google
    fbclid?: string;        // Meta
    ttclid?: string;        // TikTok
    msclkid?: string;       // Microsoft
  };
}

interface AttributionModel {
  type: 'first_touch' | 'last_touch' | 'linear' | 'time_decay' | 'position_based';

  // For position-based
  firstTouchWeight?: number;   // e.g., 0.4
  lastTouchWeight?: number;    // e.g., 0.4
  middleTouchWeight?: number;  // e.g., 0.2 split among middle touches
}

const calculateAttribution = (
  touchpoints: AttributionTouchpoint[],
  conversionValue: number,
  model: AttributionModel
): Map<string, number> => {
  const attribution = new Map<string, number>();

  if (touchpoints.length === 0) return attribution;

  switch (model.type) {
    case 'first_touch':
      attribution.set(touchpoints[0].id, conversionValue);
      break;

    case 'last_touch':
      attribution.set(touchpoints[touchpoints.length - 1].id, conversionValue);
      break;

    case 'linear':
      const equalShare = conversionValue / touchpoints.length;
      touchpoints.forEach(tp => attribution.set(tp.id, equalShare));
      break;

    case 'position_based':
      if (touchpoints.length === 1) {
        attribution.set(touchpoints[0].id, conversionValue);
      } else if (touchpoints.length === 2) {
        attribution.set(touchpoints[0].id, conversionValue * 0.5);
        attribution.set(touchpoints[1].id, conversionValue * 0.5);
      } else {
        const firstValue = conversionValue * (model.firstTouchWeight || 0.4);
        const lastValue = conversionValue * (model.lastTouchWeight || 0.4);
        const middleTotal = conversionValue * (model.middleTouchWeight || 0.2);
        const middleCount = touchpoints.length - 2;

        attribution.set(touchpoints[0].id, firstValue);
        attribution.set(touchpoints[touchpoints.length - 1].id, lastValue);

        for (let i = 1; i < touchpoints.length - 1; i++) {
          attribution.set(touchpoints[i].id, middleTotal / middleCount);
        }
      }
      break;
  }

  return attribution;
};
```

### Marketing Admin Portal

Storefront Admin includes marketing oversight:

| Function | Permission | Description |
|----------|------------|-------------|
| View campaigns | `marketing:read` | See active campaigns, performance |
| Create campaigns | `marketing:write` | Launch email/SMS campaigns |
| Manage referrals | `referrals:admin` | View referrals, handle fraud flags |
| Export audiences | `marketing:export` | Export segments for ad platforms |
| View attribution | `attribution:read` | See channel performance |

### Marketing Tech Stack Summary

| Layer | Tool | Purpose |
|-------|------|---------|
| **Analytics** | GA4 + Mixpanel | Web + product analytics |
| **CDP** | Segment or RudderStack | Identity, audience sync |
| **Email/SMS** | Klaviyo | Lifecycle marketing |
| **Attribution** | Northbeam or Rockerbox | Multi-touch attribution |
| **Ads** | Google, Meta, TikTok | Paid acquisition |
| **Referral** | Custom | Control + fraud prevention |
| **SEO** | Ahrefs + Clearscope | Organic strategy |

### Privacy & Compliance Checklist

- [ ] Marketing consent separate from transactional
- [ ] Consent collected before any marketing tracking
- [ ] No PHI sent to ad platforms (ever)
- [ ] Hashed identifiers only for matching
- [ ] Easy unsubscribe in every email
- [ ] SMS STOP handling (already in notifications)
- [ ] Cookie consent banner (CCPA, future state laws)
- [ ] Data retention limits on marketing data
- [ ] Regular consent audit
- [ ] LegitScript certification maintained

---

## Provider Platform

### Overview

Comprehensive provider-facing platform for clinical documentation, practice management, revenue cycle, and patient engagement.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         PROVIDER PLATFORM                                    │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                         CLINICAL LAYER                                       │
├───────────────────┬───────────────────┬───────────────────┬─────────────────┤
│     Charting      │    Care Plans     │  Clinical Tools   │    AI Scribe    │
│  • SOAP notes     │  • Treatment goals│  • Drug checks    │  • Transcription│
│  • Templates      │  • Interventions  │  • Lab results    │  • Auto-notes   │
│  • Problem list   │  • Progress track │  • Allergies      │  • Summaries    │
└───────────────────┴───────────────────┴───────────────────┴─────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                         OPERATIONS LAYER                                     │
├───────────────────┬───────────────────┬───────────────────┬─────────────────┤
│  Intake/Onboard   │  Multi-Provider   │  Practice Mgmt    │   Scheduling    │
│  • Digital forms  │  • Practice hier. │  • Settings       │  • Calendar     │
│  • Consent collect│  • Role-based     │  • Fee schedules  │  • Availability │
│  • Insurance cards│  • Patient assign │  • Branding       │  • Waitlists    │
└───────────────────┴───────────────────┴───────────────────┴─────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                         REVENUE CYCLE LAYER                                  │
├───────────────────┬───────────────────┬───────────────────┬─────────────────┤
│     Billing       │    Insurance      │   Claims Mgmt     │   Payments      │
│  • Superbills     │  • Eligibility    │  • 837P submit    │  • Card on file │
│  • Invoices       │  • Prior auth     │  • 835 remittance │  • Payment plans│
│  • Statements     │  • Benefits       │  • Denials        │  • Refunds      │
└───────────────────┴───────────────────┴───────────────────┴─────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                         PATIENT ENGAGEMENT LAYER                             │
├───────────────────┬───────────────────┬───────────────────┬─────────────────┤
│   Telehealth      │    Messaging      │    Programs       │   Journaling    │
│  • Video visits   │  • Secure async   │  • Group sessions │  • Symptom logs │
│  • Webinars       │  • Threads        │  • Curriculum     │  • Food tracking│
│  • Screen share   │  • Attachments    │  • Cohorts        │  • Mood logs    │
└───────────────────┴───────────────────┴───────────────────┴─────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                         ANALYTICS LAYER                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│  • Provider performance  • Financial reports  • Clinical outcomes           │
│  • Utilization metrics   • AR aging           • Patient satisfaction         │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### Clinical Documentation

#### Charting Service

```typescript
interface Encounter {
  id: string;
  patientId: string;
  providerId: string;
  appointmentId?: string;

  encounterType: 'initial_visit' | 'follow_up' | 'telemedicine' | 'phone' | 'message_only';
  status: 'in_progress' | 'completed' | 'signed' | 'amended';

  chiefComplaint: string;
  soap: SOAPNote;

  diagnoses: Diagnosis[];
  procedures: Procedure[];
  prescriptions: string[];  // Prescription IDs

  aiConsultationId?: string;  // Link to pre-visit AI summary

  startedAt: Date;
  completedAt?: Date;
  signedAt?: Date;
  signedById?: string;

  amendments: Amendment[];

  createdAt: Date;
  updatedAt: Date;
}

interface SOAPNote {
  subjective: {
    chiefComplaint: string;
    historyOfPresentIllness: string;
    reviewOfSystems?: ReviewOfSystems;
    pastMedicalHistory?: string;
    medications?: string;
    allergies?: string;
    socialHistory?: string;
    familyHistory?: string;
  };

  objective: {
    vitals?: Vitals;
    physicalExam?: string;
    labResults?: LabResult[];
    imagingResults?: string;
  };

  assessment: {
    diagnoses: Diagnosis[];
    differentialDiagnoses?: string[];
    clinicalImpression: string;
  };

  plan: {
    medications: MedicationOrder[];
    procedures: string[];
    labOrders: LabOrder[];
    referrals: Referral[];
    patientEducation: string[];
    followUp: string;
  };
}

interface Diagnosis {
  id: string;
  icd10Code: string;
  description: string;
  type: 'primary' | 'secondary';
  status: 'active' | 'resolved' | 'chronic';
  onsetDate?: Date;
  resolvedDate?: Date;
}

interface Vitals {
  bloodPressureSystolic?: number;
  bloodPressureDiastolic?: number;
  heartRate?: number;
  respiratoryRate?: number;
  temperature?: number;
  temperatureUnit?: 'F' | 'C';
  weight?: number;
  weightUnit?: 'lbs' | 'kg';
  height?: number;
  heightUnit?: 'in' | 'cm';
  bmi?: number;
  oxygenSaturation?: number;
  painLevel?: number;  // 0-10
  recordedAt: Date;
}

interface Amendment {
  id: string;
  encounterId: string;
  amendedBy: string;
  amendedAt: Date;
  reason: string;
  originalText: string;
  amendedText: string;
  section: string;  // Which part of SOAP was amended
}
```

#### Chart Templates

```typescript
interface ChartTemplate {
  id: string;
  name: string;
  description: string;
  encounterType: string[];
  specialty?: string[];

  isSystemTemplate: boolean;  // Platform-provided vs custom
  practiceId?: string;        // If practice-specific
  providerId?: string;        // If provider-specific

  sections: TemplateSection[];

  createdAt: Date;
  updatedAt: Date;
}

interface TemplateSection {
  id: string;
  name: string;
  soapSection: 'subjective' | 'objective' | 'assessment' | 'plan';
  content: string;           // Default text with placeholders
  placeholders: Placeholder[];
  isRequired: boolean;
}

interface Placeholder {
  key: string;              // e.g., "{{chief_complaint}}"
  label: string;            // "Chief Complaint"
  type: 'text' | 'textarea' | 'select' | 'multiselect' | 'date' | 'vitals';
  options?: string[];       // For select/multiselect
  defaultValue?: string;
}

const exampleTemplates = {
  weightManagement: {
    name: 'Weight Management Follow-Up',
    sections: [
      {
        soapSection: 'subjective',
        content: `Patient reports current weight of {{current_weight}} lbs ({{weight_change}} from last visit).
Appetite: {{appetite_level}}
Energy level: {{energy_level}}
Side effects: {{side_effects}}
Medication adherence: {{adherence}}`
      },
      {
        soapSection: 'assessment',
        content: `{{weight_change_assessment}}
Current BMI: {{bmi}}
Goal weight: {{goal_weight}}
Progress toward goal: {{progress_percentage}}%`
      }
    ]
  },

  hormoneTherapy: {
    name: 'Hormone Therapy Check-In',
    sections: [
      {
        soapSection: 'subjective',
        content: `Symptoms since last visit: {{symptoms}}
Mood/mental health: {{mood}}
Energy: {{energy}}
Sleep quality: {{sleep}}
Libido: {{libido}}`
      },
      {
        soapSection: 'objective',
        content: `Lab results reviewed: {{lab_date}}
Testosterone: {{testosterone_level}} ng/dL
Estradiol: {{estradiol_level}} pg/mL
PSA (if applicable): {{psa}}`
      }
    ]
  }
};
```

#### Care Plans

```typescript
interface CarePlan {
  id: string;
  patientId: string;
  providerId: string;

  name: string;
  condition: string;  // Primary condition being managed
  diagnoses: string[];  // ICD-10 codes

  status: 'draft' | 'active' | 'completed' | 'discontinued';

  startDate: Date;
  targetEndDate?: Date;
  actualEndDate?: Date;

  goals: CarePlanGoal[];
  interventions: CarePlanIntervention[];

  careTeam: CareTeamMember[];

  reviewSchedule: 'weekly' | 'biweekly' | 'monthly' | 'quarterly';
  nextReviewDate: Date;

  notes: CarePlanNote[];

  createdAt: Date;
  updatedAt: Date;
}

interface CarePlanGoal {
  id: string;
  description: string;
  category: 'clinical' | 'behavioral' | 'functional' | 'quality_of_life';

  targetValue?: string;       // e.g., "BMI < 30"
  currentValue?: string;      // e.g., "BMI = 32"
  baseline?: string;          // e.g., "BMI = 35 at start"

  targetDate: Date;
  status: 'not_started' | 'in_progress' | 'achieved' | 'not_achieved' | 'modified';

  progressNotes: ProgressNote[];
}

interface CarePlanIntervention {
  id: string;
  goalId: string;  // Which goal this supports

  type: 'medication' | 'therapy' | 'lifestyle' | 'monitoring' | 'referral' | 'education';
  description: string;

  frequency?: string;  // e.g., "Daily", "Weekly"
  responsibleParty: 'patient' | 'provider' | 'caregiver';

  status: 'planned' | 'active' | 'completed' | 'discontinued';
  startDate: Date;
  endDate?: Date;

  notes: string;
}

interface CareTeamMember {
  userId: string;
  role: 'primary_provider' | 'specialist' | 'care_coordinator' | 'pharmacist' | 'nutritionist';
  name: string;
  addedAt: Date;
}
```

#### AI Scribe

Real-time transcription and automated note generation during visits.

```typescript
interface ScribeSession {
  id: string;
  encounterId: string;
  providerId: string;
  patientId: string;

  status: 'recording' | 'processing' | 'completed' | 'failed';

  startedAt: Date;
  endedAt?: Date;
  duration?: number;  // seconds

  audioFileUrl?: string;  // Encrypted storage
  transcriptRaw: TranscriptSegment[];
  transcriptProcessed?: ProcessedTranscript;

  generatedNote?: GeneratedSOAP;
  providerEdits?: ProviderEdits;
  finalNote?: SOAPNote;

  consentRecorded: boolean;
  consentTimestamp?: Date;
}

interface TranscriptSegment {
  id: string;
  speaker: 'provider' | 'patient' | 'unknown';
  text: string;
  startTime: number;  // seconds from start
  endTime: number;
  confidence: number;
}

interface ProcessedTranscript {
  extractedSymptoms: string[];
  extractedMedications: string[];
  extractedAllergies: string[];
  extractedVitals: Partial<Vitals>;
  extractedHistory: string[];

  keyTopicsDiscussed: string[];
  patientConcerns: string[];
  providerRecommendations: string[];
}

interface GeneratedSOAP {
  subjective: string;
  objective: string;
  assessment: string;
  plan: string;

  suggestedDiagnoses: SuggestedDiagnosis[];
  suggestedCptCodes: string[];

  confidence: number;
  requiresReview: string[];  // Sections that need human review
}

interface SuggestedDiagnosis {
  icd10Code: string;
  description: string;
  confidence: number;
  evidenceFromTranscript: string[];
}
```

#### AI Scribe Integration

```typescript
const scribeConfig = {
  transcription: {
    provider: 'aws_transcribe_medical',  // or 'deepgram', 'nuance'
    language: 'en-US',
    specialty: 'PRIMARYCARE',  // AWS Medical specialty
    enableSpeakerDiarization: true,
    maxSpeakers: 2
  },

  noteGeneration: {
    model: 'claude-sonnet',  // or GPT-4
    promptTemplate: 'medical_soap_generation_v2',
    includeIcd10Suggestions: true,
    includeCptSuggestions: true
  },

  storage: {
    audioRetentionDays: 30,  // Then delete, keep transcript
    transcriptRetentionDays: 2555,  // 7 years for HIPAA
    encryptionKey: 'scribe-audio-key'
  }
};

const startScribeSession = async (encounterId: string) => {
  const encounter = await getEncounter(encounterId);

  const session = await createScribeSession({
    encounterId,
    providerId: encounter.providerId,
    patientId: encounter.patientId,
    status: 'recording',
    startedAt: new Date(),
    consentRecorded: false
  });

  const streamUrl = await transcriptionService.startStream({
    sessionId: session.id,
    config: scribeConfig.transcription,
    onTranscript: (segment) => saveTranscriptSegment(session.id, segment),
    onError: (error) => handleScribeError(session.id, error)
  });

  return { sessionId: session.id, streamUrl };
};

const generateNoteFromTranscript = async (sessionId: string) => {
  const session = await getScribeSession(sessionId);
  const transcript = await getFullTranscript(sessionId);

  const processedTranscript = await processTranscript(transcript);

  const generatedNote = await llm.generate({
    model: scribeConfig.noteGeneration.model,
    messages: [
      { role: 'system', content: SOAP_GENERATION_PROMPT },
      { role: 'user', content: JSON.stringify(processedTranscript) }
    ]
  });

  await updateScribeSession(sessionId, {
    transcriptProcessed: processedTranscript,
    generatedNote: parseGeneratedNote(generatedNote),
    status: 'completed'
  });

  return generatedNote;
};
```

---

### Practice Operations

#### Intake & Onboarding

```typescript
interface IntakeForm {
  id: string;
  practiceId: string;
  name: string;
  description: string;

  formType: 'demographics' | 'medical_history' | 'consent' | 'insurance' | 'custom';
  isRequired: boolean;
  isActive: boolean;

  fields: FormField[];
  conditionalLogic: ConditionalRule[];

  assignToNewPatients: boolean;
  assignToAppointmentTypes?: string[];

  createdAt: Date;
  updatedAt: Date;
}

interface FormField {
  id: string;
  type: 'text' | 'textarea' | 'number' | 'date' | 'select' | 'multiselect' | 'checkbox' | 'signature' | 'file_upload' | 'insurance_card';
  label: string;
  placeholder?: string;
  helpText?: string;
  required: boolean;
  options?: string[];
  validation?: FieldValidation;
  piiType?: 'name' | 'dob' | 'ssn' | 'address' | 'phone' | 'email' | 'insurance';
}

interface IntakeSubmission {
  id: string;
  formId: string;
  patientId: string;
  appointmentId?: string;

  status: 'pending' | 'in_progress' | 'submitted' | 'reviewed' | 'needs_update';

  responses: FormResponse[];
  submittedAt?: Date;
  reviewedAt?: Date;
  reviewedBy?: string;

  signatureData?: string;  // Base64 signature image
  signedAt?: Date;

  insuranceCardFront?: string;  // S3 URL
  insuranceCardBack?: string;

  createdAt: Date;
  updatedAt: Date;
}

interface FormResponse {
  fieldId: string;
  value: unknown;
  isEncrypted: boolean;  // For PII fields
}
```

#### Multi-Provider Support

```typescript
interface Practice {
  id: string;
  name: string;
  npi?: string;  // Group NPI
  taxId?: string;

  type: 'solo' | 'group' | 'employed';  // Solo provider, group practice, or employed by platform

  address: Address;
  phone: string;
  email: string;
  website?: string;

  timezone: string;
  businessHours: BusinessHours;

  branding: PracticeBranding;
  settings: PracticeSettings;

  subscriptionPlan: string;
  subscriptionStatus: 'active' | 'past_due' | 'cancelled';

  createdAt: Date;
  updatedAt: Date;
}

interface PracticeProvider {
  id: string;
  practiceId: string;
  providerId: string;

  role: 'owner' | 'admin' | 'provider' | 'staff';
  permissions: ProviderPermission[];

  isActive: boolean;
  startDate: Date;
  endDate?: Date;

  scheduleAccess: 'own' | 'all';  // See own schedule or all providers
  patientAccess: 'assigned' | 'practice';  // Own patients or all practice patients

  createdAt: Date;
}

interface ProviderPermission {
  resource: 'patients' | 'encounters' | 'billing' | 'settings' | 'reports' | 'users';
  actions: ('create' | 'read' | 'update' | 'delete')[];
}

interface PracticeSettings {
  scheduling: {
    defaultAppointmentDuration: number;
    bufferBetweenAppointments: number;
    allowOnlineBooking: boolean;
    requireIntakeBeforeBooking: boolean;
    cancellationPolicyHours: number;
  };

  billing: {
    defaultPaymentTerms: number;  // days
    acceptedPaymentMethods: string[];
    autoChargeCardOnFile: boolean;
    sendPaymentReminders: boolean;
  };

  clinical: {
    requireSignatureOnNotes: boolean;
    coSignatureRequired: boolean;  // For supervised providers
    defaultChartTemplates: string[];
  };

  notifications: {
    appointmentReminders: boolean;
    reminderTimingHours: number[];
    sendVisitSummary: boolean;
  };
}
```

#### Workflow Automations

```typescript
interface WorkflowAutomation {
  id: string;
  practiceId: string;
  name: string;
  description: string;

  isActive: boolean;

  trigger: WorkflowTrigger;
  conditions: WorkflowCondition[];
  actions: WorkflowAction[];

  lastTriggeredAt?: Date;
  triggerCount: number;

  createdAt: Date;
  updatedAt: Date;
}

interface WorkflowTrigger {
  type: 'appointment_scheduled' | 'appointment_completed' | 'form_submitted' |
        'lab_result_received' | 'invoice_created' | 'payment_received' |
        'prescription_created' | 'time_based' | 'patient_created';

  filters?: Record<string, unknown>;  // e.g., { appointmentType: 'initial_visit' }
}

interface WorkflowCondition {
  field: string;
  operator: 'equals' | 'not_equals' | 'contains' | 'greater_than' | 'less_than' | 'is_empty' | 'is_not_empty';
  value: unknown;
  logicalOperator?: 'and' | 'or';
}

interface WorkflowAction {
  type: 'send_email' | 'send_sms' | 'create_task' | 'assign_form' |
        'update_patient' | 'create_appointment' | 'send_to_webhook' |
        'add_to_program' | 'notify_provider';

  config: Record<string, unknown>;
  delay?: { value: number; unit: 'minutes' | 'hours' | 'days' };
}

const exampleWorkflows = [
  {
    name: 'New Patient Intake',
    trigger: { type: 'appointment_scheduled' },
    conditions: [
      { field: 'patient.isNew', operator: 'equals', value: true }
    ],
    actions: [
      { type: 'assign_form', config: { formId: 'demographics' } },
      { type: 'assign_form', config: { formId: 'medical_history' } },
      { type: 'assign_form', config: { formId: 'consent' } },
      { type: 'send_email', config: { templateId: 'intake_instructions' } }
    ]
  },
  {
    name: 'Post-Visit Follow-Up',
    trigger: { type: 'appointment_completed' },
    conditions: [
      { field: 'encounter.encounterType', operator: 'equals', value: 'initial_visit' }
    ],
    actions: [
      {
        type: 'send_email',
        config: { templateId: 'visit_summary' },
        delay: { value: 1, unit: 'hours' }
      },
      {
        type: 'create_task',
        config: {
          assignTo: 'provider',
          title: 'Follow-up call check-in',
          dueIn: { value: 7, unit: 'days' }
        }
      }
    ]
  },
  {
    name: 'Refill Reminder',
    trigger: { type: 'time_based' },
    conditions: [
      { field: 'prescription.daysUntilRefillEligible', operator: 'less_than', value: 14 }
    ],
    actions: [
      { type: 'send_sms', config: { templateId: 'refill_reminder' } },
      { type: 'send_email', config: { templateId: 'refill_reminder_email' } }
    ]
  }
];
```

---

### Revenue Cycle Management

#### Insurance Eligibility

Real-time insurance verification via clearinghouse.

```typescript
interface EligibilityCheck {
  id: string;
  patientId: string;
  insurancePolicyId: string;

  checkType: 'real_time' | 'batch';
  purpose: 'scheduling' | 'pre_visit' | 'billing';

  request: EligibilityRequest;
  response?: EligibilityResponse;

  status: 'pending' | 'completed' | 'error';
  errorMessage?: string;

  clearinghouse: 'availity' | 'change_healthcare' | 'waystar';
  transactionId?: string;

  requestedAt: Date;
  respondedAt?: Date;
}

interface EligibilityRequest {
  // X12 270 fields
  subscriberId: string;
  subscriberFirstName: string;
  subscriberLastName: string;
  subscriberDob: Date;

  payerId: string;
  payerName: string;

  providerId: string;
  providerNpi: string;

  serviceTypes: string[];  // e.g., ['30'] for health benefit plan coverage
  dateOfService: Date;
}

interface EligibilityResponse {
  // X12 271 fields
  isEligible: boolean;
  coverageStatus: 'active' | 'inactive' | 'unknown';

  planName: string;
  planType: string;
  groupNumber?: string;

  effectiveDate: Date;
  terminationDate?: Date;

  benefits: BenefitInfo[];
  deductible?: DeductibleInfo;
  outOfPocket?: OutOfPocketInfo;

  primaryCareProvider?: string;
  requiresReferral: boolean;
  requiresPriorAuth: boolean;

  rawResponse?: string;  // Store for debugging
}

interface BenefitInfo {
  serviceType: string;
  coverageLevel: 'individual' | 'family';
  inNetwork: boolean;

  copay?: number;
  coinsurance?: number;
  deductible?: number;
  remainingDeductible?: number;

  limitQuantity?: number;
  limitRemaining?: number;
  limitPeriod?: string;

  notes?: string;
}
```

#### Clearinghouse Integration

```typescript
interface ClearinghouseConfig {
  provider: 'availity' | 'change_healthcare' | 'waystar';

  credentials: {
    submitterId: string;
    apiKey: string;
    apiSecret: string;
    environment: 'sandbox' | 'production';
  };

  endpoints: {
    eligibility: string;
    claims: string;
    claimStatus: string;
    remittance: string;
    priorAuth: string;
  };
}

const checkEligibility = async (request: EligibilityRequest): Promise<EligibilityResponse> => {
  const edi270 = generateEdi270(request);

  const response = await clearinghouse.submit({
    transactionType: '270',
    payload: edi270
  });

  const parsed271 = parseEdi271(response.payload);

  return mapToEligibilityResponse(parsed271);
};

const generateEdi270 = (request: EligibilityRequest): string => {
  // X12 270 format
  const segments = [
    `ISA*00*          *00*          *ZZ*${request.providerId}*ZZ*${request.payerId}*${formatDate()}*${formatTime()}*^*00501*${generateControlNumber()}*0*P*:~`,
    `GS*HS*${request.providerId}*${request.payerId}*${formatDate()}*${formatTime()}*${generateGroupControlNumber()}*X*005010X279A1~`,
    `ST*270*0001*005010X279A1~`,
    `BHT*0022*13*${generateTraceNumber()}*${formatDate()}*${formatTime()}~`,
    // ... more segments
    `SE*${segmentCount}*0001~`,
    `GE*1*${groupControlNumber}~`,
    `IEA*1*${controlNumber}~`
  ];

  return segments.join('');
};
```

#### Claims Submission

```typescript
interface Claim {
  id: string;
  patientId: string;
  providerId: string;
  encounterId: string;

  claimType: 'professional' | 'institutional';  // 837P vs 837I

  status: 'draft' | 'ready' | 'submitted' | 'accepted' | 'rejected' |
          'pending' | 'paid' | 'denied' | 'appealed';

  // Claim header
  billingProvider: BillingProvider;
  renderingProvider: RenderingProvider;
  serviceFacility?: ServiceFacility;

  // Patient/subscriber
  subscriber: SubscriberInfo;
  patient: PatientInfo;
  patientRelationship: string;  // 'self', 'spouse', 'child', etc.

  // Claim details
  serviceLines: ClaimServiceLine[];
  diagnoses: ClaimDiagnosis[];

  totalCharges: number;

  // Submission tracking
  originalClaimId?: string;  // For corrected/voided claims
  frequency: '1' | '7' | '8';  // Original, Replace, Void

  submittedAt?: Date;
  clearinghouseClaimId?: string;
  payerClaimId?: string;

  // Response tracking
  acceptedAt?: Date;
  adjudicatedAt?: Date;
  paidAmount?: number;
  patientResponsibility?: number;
  adjustments?: ClaimAdjustment[];

  remittanceAdviceId?: string;

  notes: ClaimNote[];

  createdAt: Date;
  updatedAt: Date;
}

interface ClaimServiceLine {
  lineNumber: number;

  procedureCode: string;  // CPT/HCPCS
  modifiers?: string[];   // Up to 4

  diagnosisPointers: number[];  // Which diagnoses apply

  serviceDate: Date;
  serviceDateEnd?: Date;  // If date range

  placeOfService: string;  // e.g., '02' for telehealth

  units: number;
  unitType: 'UN' | 'MJ' | 'DA';  // Unit, minutes, days

  charges: number;

  // After adjudication
  allowedAmount?: number;
  paidAmount?: number;
  adjustmentReasonCodes?: string[];
  remarkCodes?: string[];
  patientResponsibility?: number;
}

interface ClaimDiagnosis {
  sequence: number;  // 1-12
  code: string;      // ICD-10
  type: 'principal' | 'admitting' | 'other';
}
```

#### Remittance Processing (ERA/835)

```typescript
interface RemittanceAdvice {
  id: string;
  practiceId: string;

  payerId: string;
  payerName: string;

  checkNumber?: string;
  checkDate?: Date;
  checkAmount: number;

  paymentMethod: 'check' | 'eft' | 'virtual_card';
  depositDate?: Date;

  claims: RemittanceClaim[];

  totalBilled: number;
  totalAllowed: number;
  totalPaid: number;
  totalAdjustments: number;
  totalPatientResponsibility: number;

  rawEra?: string;  // Original 835

  processedAt: Date;
  postedAt?: Date;
  reconciledAt?: Date;
}

interface RemittanceClaim {
  claimId: string;
  patientAccountNumber: string;
  payerClaimControlNumber: string;

  status: 'paid' | 'denied' | 'partial';

  totalCharges: number;
  totalAllowed: number;
  totalPaid: number;

  serviceLines: RemittanceServiceLine[];

  patientResponsibility: number;

  adjustments: RemittanceAdjustment[];
  remarkCodes: string[];
}

interface RemittanceAdjustment {
  groupCode: 'CO' | 'PR' | 'OA' | 'PI' | 'CR';  // Contractual, Patient, Other, Payer, Correction
  reasonCode: string;  // CARC code
  amount: number;
  quantity?: number;
}

const processEra835 = async (ediContent: string): Promise<RemittanceAdvice> => {
  const parsed = parseEdi835(ediContent);

  const remittance = await createRemittanceAdvice({
    payerId: parsed.payerId,
    payerName: parsed.payerName,
    checkNumber: parsed.checkNumber,
    checkAmount: parsed.totalPayment,
    claims: parsed.claims.map(mapToRemittanceClaim),
    rawEra: ediContent,
    processedAt: new Date()
  });

  // Auto-match and post payments
  for (const claim of remittance.claims) {
    const matchedClaim = await matchClaimByControlNumber(claim.patientAccountNumber);
    if (matchedClaim) {
      await postPaymentToClaim(matchedClaim.id, claim);
    } else {
      await flagForManualReview(remittance.id, claim);
    }
  }

  return remittance;
};
```

#### Prior Authorization

```typescript
interface PriorAuthorization {
  id: string;
  patientId: string;
  providerId: string;
  insurancePolicyId: string;

  status: 'draft' | 'submitted' | 'pending' | 'approved' | 'denied' | 'expired' | 'cancelled';

  requestType: 'initial' | 'extension' | 'modification';

  // What's being authorized
  serviceType: 'procedure' | 'medication' | 'dme' | 'imaging' | 'referral';
  procedureCodes?: string[];
  medicationName?: string;
  ndc?: string;

  diagnoses: string[];  // ICD-10 codes

  // Clinical justification
  clinicalNotes: string;
  supportingDocuments: string[];  // S3 URLs

  // Request details
  requestedUnits: number;
  requestedStartDate: Date;
  requestedEndDate: Date;

  // Response
  authorizationNumber?: string;
  approvedUnits?: number;
  approvedStartDate?: Date;
  approvedEndDate?: Date;
  denialReason?: string;
  appealDeadline?: Date;

  // Tracking
  submittedAt?: Date;
  decidedAt?: Date;
  submittedVia: 'portal' | 'fax' | 'phone' | 'edi_278';

  // Follow-up
  followUpDates: Date[];
  notes: AuthNote[];

  createdAt: Date;
  updatedAt: Date;
}

interface AuthNote {
  id: string;
  authorId: string;
  content: string;
  type: 'internal' | 'payer_communication';
  createdAt: Date;
}
```

#### Billing Database Schema

```sql
CREATE TABLE claims (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  patient_id UUID NOT NULL REFERENCES patients(id),
  provider_id UUID NOT NULL REFERENCES providers(id),
  encounter_id UUID REFERENCES encounters(id),
  practice_id UUID NOT NULL REFERENCES practices(id),

  claim_type VARCHAR(20) NOT NULL,
  status VARCHAR(50) NOT NULL DEFAULT 'draft',

  billing_provider JSONB NOT NULL,
  rendering_provider JSONB NOT NULL,
  service_facility JSONB,

  subscriber_info JSONB NOT NULL,
  patient_info JSONB NOT NULL,
  patient_relationship VARCHAR(10) NOT NULL,

  diagnoses JSONB NOT NULL,
  service_lines JSONB NOT NULL,

  total_charges DECIMAL(10,2) NOT NULL,

  original_claim_id UUID REFERENCES claims(id),
  frequency CHAR(1) DEFAULT '1',

  submitted_at TIMESTAMPTZ,
  clearinghouse_claim_id VARCHAR(100),
  payer_claim_id VARCHAR(100),

  accepted_at TIMESTAMPTZ,
  adjudicated_at TIMESTAMPTZ,
  paid_amount DECIMAL(10,2),
  patient_responsibility DECIMAL(10,2),
  adjustments JSONB,

  remittance_advice_id UUID REFERENCES remittance_advice(id),

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE remittance_advice (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  practice_id UUID NOT NULL REFERENCES practices(id),

  payer_id VARCHAR(50) NOT NULL,
  payer_name VARCHAR(255) NOT NULL,

  check_number VARCHAR(50),
  check_date DATE,
  check_amount DECIMAL(12,2) NOT NULL,

  payment_method VARCHAR(20) NOT NULL,
  deposit_date DATE,

  claims JSONB NOT NULL,

  total_billed DECIMAL(12,2) NOT NULL,
  total_allowed DECIMAL(12,2) NOT NULL,
  total_paid DECIMAL(12,2) NOT NULL,
  total_adjustments DECIMAL(12,2) NOT NULL,
  total_patient_responsibility DECIMAL(12,2) NOT NULL,

  raw_era TEXT,

  processed_at TIMESTAMPTZ NOT NULL,
  posted_at TIMESTAMPTZ,
  reconciled_at TIMESTAMPTZ,

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE prior_authorizations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  patient_id UUID NOT NULL REFERENCES patients(id),
  provider_id UUID NOT NULL REFERENCES providers(id),
  insurance_policy_id UUID NOT NULL REFERENCES insurance_policies(id),
  practice_id UUID NOT NULL REFERENCES practices(id),

  status VARCHAR(50) NOT NULL DEFAULT 'draft',
  request_type VARCHAR(20) NOT NULL,

  service_type VARCHAR(50) NOT NULL,
  procedure_codes TEXT[],
  medication_name VARCHAR(255),
  ndc VARCHAR(20),

  diagnoses TEXT[] NOT NULL,

  clinical_notes TEXT NOT NULL,
  supporting_documents TEXT[],

  requested_units INTEGER NOT NULL,
  requested_start_date DATE NOT NULL,
  requested_end_date DATE NOT NULL,

  authorization_number VARCHAR(100),
  approved_units INTEGER,
  approved_start_date DATE,
  approved_end_date DATE,
  denial_reason TEXT,
  appeal_deadline DATE,

  submitted_at TIMESTAMPTZ,
  decided_at TIMESTAMPTZ,
  submitted_via VARCHAR(20) NOT NULL,

  follow_up_dates DATE[],
  notes JSONB,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_claims_patient ON claims(patient_id);
CREATE INDEX idx_claims_practice ON claims(practice_id);
CREATE INDEX idx_claims_status ON claims(status);
CREATE INDEX idx_claims_submitted ON claims(submitted_at);
CREATE INDEX idx_remittance_practice ON remittance_advice(practice_id);
CREATE INDEX idx_prior_auth_patient ON prior_authorizations(patient_id);
CREATE INDEX idx_prior_auth_status ON prior_authorizations(status);
```

---

### Patient Engagement

#### Secure Messaging

```typescript
interface MessageThread {
  id: string;
  practiceId: string;
  patientId: string;

  subject: string;
  status: 'open' | 'closed' | 'archived';
  priority: 'normal' | 'urgent';

  assignedTo?: string;  // Provider or staff ID
  category: 'general' | 'prescription' | 'billing' | 'scheduling' | 'clinical' | 'referral';

  participants: ThreadParticipant[];
  messages: Message[];

  lastMessageAt: Date;
  unreadByPatient: number;
  unreadByProvider: number;

  createdAt: Date;
  updatedAt: Date;
}

interface Message {
  id: string;
  threadId: string;

  senderId: string;
  senderType: 'patient' | 'provider' | 'staff' | 'system';
  senderName: string;

  content: string;
  contentType: 'text' | 'html';

  attachments: MessageAttachment[];

  readAt?: Date;
  readBy: string[];

  createdAt: Date;
}

interface MessageAttachment {
  id: string;
  fileName: string;
  fileType: string;
  fileSize: number;
  url: string;  // Pre-signed S3 URL
  uploadedAt: Date;
}
```

#### Programs (Group Sessions)

```typescript
interface Program {
  id: string;
  practiceId: string;
  name: string;
  description: string;

  type: 'group_visit' | 'educational' | 'support_group' | 'challenge';
  deliveryMethod: 'live_video' | 'in_person' | 'self_paced' | 'hybrid';

  status: 'draft' | 'active' | 'completed' | 'archived';

  facilitatorIds: string[];
  maxParticipants?: number;

  schedule: ProgramSchedule;
  modules: ProgramModule[];

  pricing: {
    type: 'free' | 'paid' | 'insurance';
    amount?: number;
    insuranceCoverage?: boolean;
  };

  enrollmentStatus: 'open' | 'closed' | 'waitlist';
  participants: ProgramParticipant[];

  createdAt: Date;
  updatedAt: Date;
}

interface ProgramModule {
  id: string;
  programId: string;
  sequence: number;

  title: string;
  description: string;

  type: 'live_session' | 'video' | 'reading' | 'assignment' | 'quiz';
  content: ModuleContent;

  scheduledDate?: Date;
  duration?: number;  // minutes

  isRequired: boolean;
}

interface ProgramParticipant {
  patientId: string;
  enrolledAt: Date;
  status: 'enrolled' | 'completed' | 'dropped' | 'waitlisted';
  progress: ModuleProgress[];
  completedAt?: Date;
}
```

#### Patient Journaling

```typescript
interface JournalEntry {
  id: string;
  patientId: string;

  entryType: 'symptom_log' | 'food_log' | 'mood_log' | 'medication_log' | 'exercise_log' | 'free_form';

  date: Date;
  time?: string;

  data: JournalData;
  notes?: string;
  photos?: string[];

  sharedWithProvider: boolean;
  providerViewedAt?: Date;

  createdAt: Date;
  updatedAt: Date;
}

type JournalData = SymptomLog | FoodLog | MoodLog | MedicationLog | ExerciseLog | FreeFormLog;

interface SymptomLog {
  type: 'symptom_log';
  symptoms: {
    name: string;
    severity: 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10;
    duration?: string;
    triggers?: string[];
  }[];
}

interface FoodLog {
  type: 'food_log';
  meal: 'breakfast' | 'lunch' | 'dinner' | 'snack';
  foods: {
    name: string;
    quantity?: string;
    calories?: number;
    macros?: { protein: number; carbs: number; fat: number };
  }[];
  hungerBefore?: 1 | 2 | 3 | 4 | 5;
  hungerAfter?: 1 | 2 | 3 | 4 | 5;
}

interface MoodLog {
  type: 'mood_log';
  overallMood: 1 | 2 | 3 | 4 | 5;  // Very bad to very good
  emotions: string[];
  energyLevel: 1 | 2 | 3 | 4 | 5;
  sleepQuality?: 1 | 2 | 3 | 4 | 5;
  sleepHours?: number;
  stressLevel?: 1 | 2 | 3 | 4 | 5;
}

interface MedicationLog {
  type: 'medication_log';
  medications: {
    prescriptionId?: string;
    medicationName: string;
    dose: string;
    taken: boolean;
    takenAt?: string;
    sideEffects?: string[];
  }[];
}
```

---

### Patient Engagement Enhancements

This section defines advanced patient engagement features inspired by leading platforms, designed to drive adherence and improve outcomes.

#### Drip Content Engine for Programs

**Critical** - Automatically delivers program content over time based on enrollment date, eliminating manual content release.

##### Drip Content Flow

```
Patient enrolls in program (e.g., "GLP-1 Onboarding")
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  ENROLLMENT TRIGGERS DRIP SCHEDULE                                           │
│  ├── Day 0: Welcome email + intro video                                      │
│  ├── Day 1: "What to expect" module unlocks                                  │
│  ├── Day 3: Injection technique video                                        │
│  ├── Day 7: First week check-in survey                                       │
│  ├── Day 14: Nutrition guidance module                                       │
│  ├── Day 21: Managing side effects content                                   │
│  └── Day 30: Progress assessment + provider review                           │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  SCHEDULED CONTENT RELEASE                                                   │
│  ├── Check: Is patient still enrolled?                                       │
│  ├── Check: Has patient completed prerequisites?                             │
│  ├── Action: Unlock content in patient portal                                │
│  ├── Action: Send notification (push/email/SMS)                              │
│  └── Track: Module availability timestamp                                    │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
Patient receives notification → Accesses content → Progress tracked
```

##### Drip Content Data Model

```typescript
interface DripSchedule {
  id: string;
  programId: string;

  // Schedule configuration
  contentItems: DripContentItem[];

  // Timing settings
  timezone: string;
  preferredDeliveryTime?: string;  // e.g., "09:00" - morning delivery
  respectQuietHours: boolean;
}

interface DripContentItem {
  id: string;
  moduleId: string;

  // When to release
  releaseType: 'days_after_enrollment' | 'days_after_previous' | 'specific_date' | 'on_completion';
  releaseDays?: number;  // Days after enrollment or previous
  releaseDate?: Date;    // For specific date
  prerequisiteModuleId?: string;  // For on_completion

  // Notification settings
  notificationChannels: ('push' | 'email' | 'sms')[];
  notificationTemplate: string;
  reminderAfterDays?: number;  // Remind if not started

  // Conditions
  conditions?: DripCondition[];
}

interface DripCondition {
  type: 'completed_module' | 'logged_journal' | 'days_active' | 'custom';
  moduleId?: string;
  journalType?: string;
  minimumDays?: number;
  customCheck?: string;
}

interface ParticipantDripState {
  participantId: string;
  programId: string;
  enrolledAt: Date;

  // Content states
  contentStates: {
    contentItemId: string;
    status: 'locked' | 'scheduled' | 'available' | 'started' | 'completed';
    scheduledFor?: Date;
    unlockedAt?: Date;
    startedAt?: Date;
    completedAt?: Date;
    notificationsSent: {
      channel: string;
      sentAt: Date;
    }[];
  }[];

  // Progress
  totalModules: number;
  completedModules: number;
  currentStreak: number;  // Consecutive days engaged
}
```

##### Drip Engine Implementation

```typescript
const dripContentEngine = {
  // Run on enrollment
  onEnrollment: async (participantId: string, programId: string) => {
    const schedule = await getDripSchedule(programId);
    const enrolledAt = new Date();

    const contentStates = schedule.contentItems.map(item => ({
      contentItemId: item.id,
      status: item.releaseDays === 0 ? 'available' : 'scheduled',
      scheduledFor: calculateReleaseDate(enrolledAt, item),
      unlockedAt: item.releaseDays === 0 ? enrolledAt : undefined,
    }));

    await createParticipantDripState({
      participantId,
      programId,
      enrolledAt,
      contentStates,
    });

    // Schedule future releases
    for (const state of contentStates) {
      if (state.scheduledFor && state.scheduledFor > enrolledAt) {
        await scheduleContentRelease(participantId, state.contentItemId, state.scheduledFor);
      }
    }

    // Send Day 0 content notification
    const dayZeroContent = contentStates.filter(s => s.status === 'available');
    if (dayZeroContent.length > 0) {
      await sendContentNotification(participantId, dayZeroContent, 'welcome');
    }
  },

  // Scheduled job - runs every hour
  processScheduledReleases: async () => {
    const now = new Date();
    const dueReleases = await getScheduledReleasesBeforeTime(now);

    for (const release of dueReleases) {
      const participant = await getParticipantDripState(release.participantId);

      // Check prerequisites
      if (release.prerequisiteModuleId) {
        const prereq = participant.contentStates.find(
          s => s.contentItemId === release.prerequisiteModuleId
        );
        if (prereq?.status !== 'completed') {
          // Reschedule for tomorrow
          await rescheduleRelease(release, addDays(now, 1));
          continue;
        }
      }

      // Unlock content
      await updateContentState(release.participantId, release.contentItemId, {
        status: 'available',
        unlockedAt: now,
      });

      // Send notification
      await sendContentNotification(
        release.participantId,
        release.contentItemId,
        'new_content_available'
      );
    }
  },

  // Check for engagement reminders
  processEngagementReminders: async () => {
    const participants = await getParticipantsWithUnstartedContent();

    for (const p of participants) {
      const unstartedItems = p.contentStates.filter(
        s => s.status === 'available' &&
        daysSince(s.unlockedAt) >= s.reminderAfterDays
      );

      for (const item of unstartedItems) {
        await sendContentNotification(p.participantId, item.contentItemId, 'reminder');
      }
    }
  }
};

const calculateReleaseDate = (enrolledAt: Date, item: DripContentItem): Date => {
  if (item.releaseType === 'days_after_enrollment') {
    return addDays(enrolledAt, item.releaseDays || 0);
  }
  if (item.releaseType === 'specific_date') {
    return item.releaseDate!;
  }
  // For 'on_completion' type, no scheduled date - triggered by completion
  return null as unknown as Date;
};
```

##### Pre-Built Program Templates

```typescript
interface ProgramTemplate {
  id: string;
  name: string;
  category: 'weight_loss' | 'hrt' | 'peptides' | 'general_wellness';
  description: string;

  // Template content
  defaultDuration: number;  // days
  modules: ProgramModuleTemplate[];
  dripSchedule: DripContentItem[];

  // Customization
  isCustomizable: boolean;
  customizableFields: string[];

  // Metadata
  createdBy: 'platform' | 'provider';
  usageCount: number;
  avgCompletionRate: number;
}

// Pre-built templates
const platformTemplates: ProgramTemplate[] = [
  {
    id: 'glp1-onboarding',
    name: 'GLP-1 Medication Onboarding',
    category: 'weight_loss',
    description: '30-day program for patients starting semaglutide or tirzepatide',
    defaultDuration: 30,
    modules: [
      { title: 'Welcome & What to Expect', type: 'video', dayRelease: 0 },
      { title: 'Self-Injection Technique', type: 'video', dayRelease: 1 },
      { title: 'Managing Common Side Effects', type: 'reading', dayRelease: 3 },
      { title: 'Nutrition While on GLP-1', type: 'video', dayRelease: 7 },
      { title: 'Week 1 Check-in', type: 'quiz', dayRelease: 7 },
      { title: 'Building Healthy Habits', type: 'reading', dayRelease: 14 },
      { title: 'Exercise Guidelines', type: 'video', dayRelease: 21 },
      { title: '30-Day Progress Assessment', type: 'quiz', dayRelease: 30 },
    ],
    isCustomizable: true,
    customizableFields: ['modules', 'dripSchedule', 'notifications'],
  },
  {
    id: 'trt-onboarding',
    name: 'Testosterone Therapy Onboarding',
    category: 'hrt',
    description: '60-day program for patients starting TRT',
    defaultDuration: 60,
    modules: [
      { title: 'Understanding TRT', type: 'video', dayRelease: 0 },
      { title: 'Injection Technique & Safety', type: 'video', dayRelease: 1 },
      { title: 'What to Expect: Timeline', type: 'reading', dayRelease: 3 },
      { title: 'Lab Monitoring Overview', type: 'reading', dayRelease: 7 },
      { title: 'Week 2 Check-in', type: 'quiz', dayRelease: 14 },
      { title: 'Lifestyle Optimization', type: 'video', dayRelease: 21 },
      { title: 'Managing Estrogen', type: 'reading', dayRelease: 30 },
      { title: '6-Week Progress Assessment', type: 'quiz', dayRelease: 42 },
      { title: '60-Day Comprehensive Review', type: 'quiz', dayRelease: 60 },
    ],
    isCustomizable: true,
    customizableFields: ['modules', 'dripSchedule'],
  },
  {
    id: 'hrt-female-menopause',
    name: 'Menopause HRT Support',
    category: 'hrt',
    description: '90-day program for women starting hormone therapy',
    defaultDuration: 90,
    modules: [
      { title: 'Understanding Menopause & HRT', type: 'video', dayRelease: 0 },
      { title: 'Your HRT Protocol Explained', type: 'reading', dayRelease: 1 },
      { title: 'Symptom Tracking Guide', type: 'reading', dayRelease: 3 },
      { title: 'Week 1 Check-in', type: 'quiz', dayRelease: 7 },
      { title: 'Sleep & Energy Optimization', type: 'video', dayRelease: 14 },
      { title: 'Nutrition for Hormonal Health', type: 'video', dayRelease: 21 },
      { title: 'Month 1 Assessment', type: 'quiz', dayRelease: 30 },
      { title: 'Exercise & Bone Health', type: 'reading', dayRelease: 45 },
      { title: 'Month 2 Assessment', type: 'quiz', dayRelease: 60 },
      { title: '90-Day Comprehensive Review', type: 'quiz', dayRelease: 90 },
    ],
    isCustomizable: true,
    customizableFields: ['modules', 'dripSchedule'],
  }
];
```

---

#### Provider Journal Engagement System

**Critical** - Enables providers to interact with patient journal entries through comments, reactions, and acknowledgments.

##### Provider Engagement Flow

```
Patient submits journal entry (food log, symptom, etc.)
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  PROVIDER NOTIFICATION                                                       │
│  ├── Real-time: Entry appears in provider dashboard                          │
│  ├── Flagged entries: Alert for concerning symptoms/patterns                 │
│  └── Digest: Daily summary of patient activity                               │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  PROVIDER RESPONSE OPTIONS                                                   │
│  ├── Quick Reaction: 👍 ❤️ 🎉 💪 (instant acknowledgment)                    │
│  ├── Comment: Text feedback on entry                                         │
│  ├── Flag for Follow-up: Mark for discussion at next visit                   │
│  └── View Only: Mark as reviewed (patient sees "viewed")                     │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  PATIENT NOTIFICATION                                                        │
│  ├── Push: "Dr. Williams reacted to your food log 👍"                        │
│  ├── In-app: Reaction/comment visible on entry                               │
│  └── Engagement boost: Patient more likely to continue logging               │
└─────────────────────────────────────────────────────────────────────────────┘
```

##### Journal Engagement Data Model

```typescript
interface JournalEngagement {
  id: string;
  journalEntryId: string;
  patientId: string;

  // Provider interaction
  providerId: string;
  providerName: string;

  // Engagement type
  engagementType: 'reaction' | 'comment' | 'flag' | 'viewed';

  // Reaction (if type is reaction)
  reaction?: {
    emoji: '👍' | '❤️' | '🎉' | '💪' | '👏' | '🌟';
    label: 'great' | 'love' | 'celebrate' | 'strong' | 'proud' | 'star';
  };

  // Comment (if type is comment)
  comment?: {
    text: string;
    isPrivate: boolean;  // false = visible to patient, true = internal note
  };

  // Flag (if type is flag)
  flag?: {
    reason: 'discuss_at_visit' | 'concerning' | 'follow_up_needed' | 'positive_progress';
    notes?: string;
    resolvedAt?: Date;
    resolvedBy?: string;
  };

  // Timestamps
  createdAt: Date;
  patientViewedAt?: Date;
  patientAcknowledgedAt?: Date;
}

// Extend existing JournalEntry with engagement
interface JournalEntryWithEngagement extends JournalEntry {
  engagements: JournalEngagement[];

  // Quick stats
  hasProviderResponse: boolean;
  reactionCount: number;
  commentCount: number;
  isFlagged: boolean;
}

// Provider view aggregation
interface PatientJournalSummary {
  patientId: string;
  patientName: string;

  // Recent activity
  entriesLast7Days: number;
  entriesLast30Days: number;

  // Engagement stats
  unviewedEntries: number;
  flaggedEntries: number;

  // Patterns
  loggingStreak: number;
  averageEntriesPerDay: number;
  mostLoggedType: string;

  // Alerts
  alerts: JournalAlert[];
}

interface JournalAlert {
  type: 'symptom_concern' | 'missed_logging' | 'pattern_detected' | 'positive_trend';
  severity: 'info' | 'warning' | 'urgent';
  message: string;
  journalEntryIds?: string[];
  createdAt: Date;
}
```

##### Provider Journal Dashboard UI

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  📓 Patient Journal Activity                                    [Last 7 Days]│
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ⚠️ NEEDS ATTENTION (3)                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Jane Doe • Symptom Log • 2 hours ago                                │   │
│  │ "Severe nausea (8/10) after injection, lasting 6+ hours"           │   │
│  │ [👍] [❤️] [💬 Comment] [🚩 Flag] [✓ Mark Viewed]                   │   │
│  │ ─────────────────────────────────────────────────────────────────── │   │
│  │ Bob Smith • Mood Log • 5 hours ago                                  │   │
│  │ Mood: 2/5, Energy: 1/5, "Feeling exhausted, no motivation"         │   │
│  │ [👍] [❤️] [💬 Comment] [🚩 Flag] [✓ Mark Viewed]                   │   │
│  │ ─────────────────────────────────────────────────────────────────── │   │
│  │ Mary Wilson • Missed 3 days of logging                             │   │
│  │ Last entry: Feb 5 • Was logging daily before                       │   │
│  │ [📧 Send Encouragement] [📞 Schedule Check-in]                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ✅ POSITIVE UPDATES (5)                                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Lisa Chen • Food Log • 3 hours ago                     [You: 👍]   │   │
│  │ 📸 Healthy lunch - grilled chicken salad                           │   │
│  │                                                                     │   │
│  │ Tom Lee • Symptom Log • Yesterday                                   │   │
│  │ "Injection site reaction much better this week! 2/10"             │   │
│  │ [👍] [🎉] [💬 Comment] [✓ Mark Viewed]                             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  📊 PATIENT ENGAGEMENT SUMMARY                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Patient       │ Streak │ Entries │ Unviewed │ Trend   │ Action     │   │
│  │ ──────────────────────────────────────────────────────────────────  │   │
│  │ Jane Doe      │ 14 🔥  │ 42      │ 3        │ ↑ Great │ [View]     │   │
│  │ Bob Smith     │ 0      │ 8       │ 5        │ ↓ Drop  │ [Reach Out]│   │
│  │ Lisa Chen     │ 21 🔥  │ 63      │ 1        │ → Steady│ [View]     │   │
│  │ Mary Wilson   │ 0      │ 12      │ 0        │ ↓ Stopped│ [Check In]│   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

##### Patient View of Provider Engagement

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  📓 My Journal                                                   [+ New Entry]│
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Today, February 9                                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 🍽️ Lunch • 12:30 PM                                                 │   │
│  │ [📸 Photo of grilled chicken salad]                                │   │
│  │ Grilled chicken salad with avocado                                 │   │
│  │ 450 cal • 35g protein • 28g carbs • 22g fat                        │   │
│  │                                                                     │   │
│  │ ──────────────────────────────────────────────────────────────────  │   │
│  │ 👍 Dr. Williams reacted • 2:15 PM                                  │   │
│  │ 💬 "Great protein choice! Keep it up." - Dr. Williams              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  Yesterday, February 8                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 💊 Medication • 8:00 AM                                             │   │
│  │ Semaglutide 0.5mg - Taken ✓                                        │   │
│  │ Side effects: Mild nausea (3/10)                                   │   │
│  │                                                                     │   │
│  │ ──────────────────────────────────────────────────────────────────  │   │
│  │ ✓ Viewed by Dr. Williams                                           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 📊 Symptom Log • 9:00 PM                                           │   │
│  │ Nausea: 6/10 (moderate)                                            │   │
│  │ Duration: 4 hours                                                  │   │
│  │ Notes: "Worse after dinner, helped to lie down"                    │   │
│  │                                                                     │   │
│  │ ──────────────────────────────────────────────────────────────────  │   │
│  │ 💬 "This is common in week 1-2. Try smaller meals and stay        │   │
│  │     hydrated. Let me know if it persists past week 3."            │   │
│  │     - Dr. Williams, Feb 9 at 8:30 AM                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  🔥 14 day logging streak! Keep it going!                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

##### Engagement Automation Rules

```typescript
const journalEngagementAutomation = {
  // Auto-alert for concerning symptoms
  concerningSymptoms: {
    trigger: 'symptom_severity >= 7 OR symptom_name IN ("chest_pain", "difficulty_breathing", "severe_allergic")',
    action: 'alert_provider_urgent',
    notifyPatient: 'Your provider has been notified about your symptom report.',
  },

  // Auto-flag patterns
  negativePattern: {
    trigger: 'mood_score <= 2 for 3 consecutive days',
    action: 'flag_for_provider_review',
    flag: { reason: 'concerning', notes: 'Low mood pattern detected' },
  },

  // Auto-encourage streaks
  streakMilestones: {
    trigger: 'logging_streak IN (7, 14, 30, 60, 90)',
    action: 'send_celebration_notification',
    message: 'Amazing! You\'ve logged for {{streak}} days straight! 🎉',
  },

  // Nudge for missed logging
  missedLogging: {
    trigger: 'days_since_last_entry >= 2 AND previous_streak >= 3',
    action: 'send_gentle_reminder',
    message: 'We noticed you haven\'t logged in a couple days. Everything okay?',
  },

  // Provider digest
  dailyDigest: {
    schedule: '08:00 provider_timezone',
    content: 'summary of patient journal activity from past 24 hours',
    includeAlerts: true,
    includeUnviewedCount: true,
  }
};
```

---

#### Nutrition Database Integration

**Critical** - Integrates with food databases for automatic calorie and macro lookup during food logging.

##### Integration Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       NUTRITION DATABASE INTEGRATION                         │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  USER INPUT                                                                  │
│  ├── Text search: "grilled chicken breast"                                  │
│  ├── Barcode scan: UPC lookup                                               │
│  ├── Recent foods: Quick re-log                                             │
│  └── Favorites: Saved frequent foods                                        │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  NUTRITION API LAYER                                                         │
│  ┌───────────────────────┐  ┌───────────────────────┐                       │
│  │  PRIMARY: Edamam      │  │  BACKUP: Nutritionix  │                       │
│  │  • Food database      │  │  • Restaurant items   │                       │
│  │  • Recipe analysis    │  │  • Branded foods      │                       │
│  │  • Nutrient data      │  │  • Natural language   │                       │
│  └───────────────────────┘  └───────────────────────┘                       │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  RESPONSE NORMALIZATION                                                      │
│  ├── Standard nutrient fields (calories, protein, carbs, fat)               │
│  ├── Extended nutrients (fiber, sodium, sugar, etc.)                        │
│  ├── Serving size normalization                                              │
│  └── Cache frequently searched foods                                        │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
Food entry created with auto-populated nutrition data
```

##### Nutrition Database Data Model

```typescript
interface NutritionSearchResult {
  id: string;
  source: 'edamam' | 'nutritionix' | 'usda' | 'custom';
  sourceId: string;

  // Food identification
  name: string;
  brand?: string;
  category: string;

  // Serving info
  servingSize: number;
  servingUnit: string;
  servingSizeGrams: number;
  alternateServings?: {
    size: number;
    unit: string;
    grams: number;
  }[];

  // Core macros (per serving)
  calories: number;
  protein: number;      // grams
  carbohydrates: number; // grams
  fat: number;          // grams

  // Extended nutrients
  fiber?: number;
  sugar?: number;
  saturatedFat?: number;
  transFat?: number;
  cholesterol?: number;  // mg
  sodium?: number;       // mg
  potassium?: number;    // mg

  // Micronutrients (if available)
  vitamins?: {
    a?: number;  // IU
    c?: number;  // mg
    d?: number;  // IU
    e?: number;  // mg
    k?: number;  // mcg
    b6?: number; // mg
    b12?: number; // mcg
  };

  minerals?: {
    calcium?: number;   // mg
    iron?: number;      // mg
    magnesium?: number; // mg
    zinc?: number;      // mg
  };

  // Metadata
  imageUrl?: string;
  barcode?: string;
}

interface FoodLogWithNutrition extends FoodLog {
  type: 'food_log';
  meal: 'breakfast' | 'lunch' | 'dinner' | 'snack';

  foods: {
    // Search result reference
    nutritionId?: string;
    source?: 'edamam' | 'nutritionix' | 'manual';

    // Food info
    name: string;
    brand?: string;

    // Serving
    servings: number;
    servingSize: number;
    servingUnit: string;

    // Calculated nutrition (servings × per-serving values)
    calories: number;
    protein: number;
    carbohydrates: number;
    fat: number;
    fiber?: number;
    sugar?: number;
    sodium?: number;

    // Photo
    photoUrl?: string;
  }[];

  // Meal totals
  totalCalories: number;
  totalProtein: number;
  totalCarbs: number;
  totalFat: number;

  // Meal context
  hungerBefore?: 1 | 2 | 3 | 4 | 5;
  hungerAfter?: 1 | 2 | 3 | 4 | 5;
  mealNotes?: string;
}

// User's food history for quick access
interface UserFoodHistory {
  patientId: string;

  recentFoods: {
    nutritionId: string;
    name: string;
    lastLoggedAt: Date;
    logCount: number;
  }[];

  favoriteFoods: {
    nutritionId: string;
    name: string;
    defaultServing: number;
    addedAt: Date;
  }[];

  customFoods: {
    id: string;
    name: string;
    nutrition: NutritionSearchResult;
    createdAt: Date;
  }[];
}
```

##### Nutrition API Integration

```typescript
interface NutritionApiConfig {
  edamam: {
    appId: string;
    appKey: string;
    baseUrl: 'https://api.edamam.com/api/food-database/v2';
  };
  nutritionix: {
    appId: string;
    appKey: string;
    baseUrl: 'https://trackapi.nutritionix.com/v2';
  };
}

const nutritionService = {
  // Search for foods
  search: async (query: string, options?: {
    branded?: boolean;
    category?: string;
    limit?: number;
  }): Promise<NutritionSearchResult[]> => {
    // Try primary (Edamam) first
    try {
      const results = await edamamApi.searchFoods(query, options);
      return normalizeEdamamResults(results);
    } catch (error) {
      // Fallback to Nutritionix
      const results = await nutritionixApi.searchFoods(query, options);
      return normalizeNutritionixResults(results);
    }
  },

  // Barcode lookup
  lookupBarcode: async (barcode: string): Promise<NutritionSearchResult | null> => {
    // Try Nutritionix first (better for branded products)
    const result = await nutritionixApi.lookupUpc(barcode);
    if (result) return normalizeNutritionixResults([result])[0];

    // Fallback to Edamam
    const edamamResult = await edamamApi.lookupUpc(barcode);
    if (edamamResult) return normalizeEdamamResults([edamamResult])[0];

    return null;
  },

  // Get detailed nutrition for a food
  getDetails: async (source: string, sourceId: string): Promise<NutritionSearchResult> => {
    if (source === 'edamam') {
      return normalizeEdamamResults([await edamamApi.getFoodDetails(sourceId)])[0];
    }
    return normalizeNutritionixResults([await nutritionixApi.getFoodDetails(sourceId)])[0];
  },

  // Calculate nutrition for a meal
  calculateMealNutrition: (foods: FoodLogWithNutrition['foods']): MealTotals => {
    return foods.reduce((totals, food) => ({
      calories: totals.calories + food.calories,
      protein: totals.protein + food.protein,
      carbohydrates: totals.carbohydrates + food.carbohydrates,
      fat: totals.fat + food.fat,
      fiber: totals.fiber + (food.fiber || 0),
      sugar: totals.sugar + (food.sugar || 0),
      sodium: totals.sodium + (food.sodium || 0),
    }), { calories: 0, protein: 0, carbohydrates: 0, fat: 0, fiber: 0, sugar: 0, sodium: 0 });
  }
};
```

##### Food Logging UI with Nutrition Search

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  🍽️ Log Food - Lunch                                              [Cancel] │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Search for food:                                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 🔍 grilled chicken breast                               [📷] [▦]   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  SEARCH RESULTS                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Grilled Chicken Breast, skinless                                    │   │
│  │ 165 cal • 31g protein • 0g carbs • 3.6g fat                        │   │
│  │ Per 100g                                              [+ Add]      │   │
│  │ ─────────────────────────────────────────────────────────────────── │   │
│  │ Tyson Grilled Chicken Breast Strips                                │   │
│  │ 110 cal • 20g protein • 2g carbs • 2.5g fat                        │   │
│  │ Per 3 oz (85g)                                        [+ Add]      │   │
│  │ ─────────────────────────────────────────────────────────────────── │   │
│  │ Chick-fil-A Grilled Chicken Breast                                 │   │
│  │ 130 cal • 28g protein • 1g carbs • 3g fat                          │   │
│  │ Per filet                                             [+ Add]      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  RECENT FOODS                                                              │
│  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐                    │
│  │ Greek Yogurt  │ │ Avocado       │ │ Scrambled Eggs│                    │
│  │ 100 cal       │ │ 160 cal       │ │ 147 cal       │                    │
│  │ [+ Add]       │ │ [+ Add]       │ │ [+ Add]       │                    │
│  └───────────────┘ └───────────────┘ └───────────────┘                    │
│                                                                             │
│  ★ FAVORITES                                                               │
│  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐                    │
│  │ Protein Shake │ │ Chicken Salad │ │ Oatmeal       │                    │
│  │ [+ Add]       │ │ [+ Add]       │ │ [+ Add]       │                    │
│  └───────────────┘ └───────────────┘ └───────────────┘                    │
│                                                                             │
│  [+ Create Custom Food]                                                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌─────────────────────────────────────────────────────────────────────────────┐
│  🍽️ Log Food - Lunch                                              [Cancel] │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  CURRENT MEAL                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Grilled Chicken Breast, skinless                                    │   │
│  │ Serving: [1.5  ▼] × [100g ▼]                                       │   │
│  │ 248 cal • 47g protein • 0g carbs • 5g fat             [🗑️ Remove] │   │
│  │ ─────────────────────────────────────────────────────────────────── │   │
│  │ Mixed Greens Salad                                                  │   │
│  │ Serving: [2    ▼] × [cup ▼]                                        │   │
│  │ 18 cal • 2g protein • 2g carbs • 0g fat               [🗑️ Remove] │   │
│  │ ─────────────────────────────────────────────────────────────────── │   │
│  │ Olive Oil (dressing)                                                │   │
│  │ Serving: [1    ▼] × [tbsp ▼]                                       │   │
│  │ 119 cal • 0g protein • 0g carbs • 14g fat             [🗑️ Remove] │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        MEAL TOTALS                                  │   │
│  │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │   │
│  │  Calories    Protein     Carbs        Fat                          │   │
│  │  385         49g         2g           19g                          │   │
│  │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │   │
│  │  Daily: 1,245 / 1,800 cal  │  Protein: 98 / 120g target           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  [+ Add More Food]              [📸 Add Photo]                             │
│                                                                             │
│  How hungry before meal? ○ ○ ○ ● ○ (Moderately hungry)                     │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Save Meal Log                               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

#### Photo-Based Meal Logging

**High priority** - Mobile-first photo capture for meal logging with optional AI-assisted food recognition.

##### Photo Meal Flow

```
User taps "Log Meal" → Camera opens
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  PHOTO CAPTURE                                                               │
│  ├── Take photo of meal                                                      │
│  ├── Or select from camera roll                                              │
│  └── Multiple photos supported                                               │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  AI FOOD RECOGNITION (Optional)                                              │
│  ├── Analyze image for food items                                            │
│  ├── Suggest identified foods with nutrition                                 │
│  └── User confirms/edits suggestions                                         │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  USER CONFIRMATION                                                           │
│  ├── Confirm identified foods                                                │
│  ├── Adjust portions                                                         │
│  ├── Add meal context (hunger level, notes)                                  │
│  └── Save log with photo + nutrition                                         │
└─────────────────────────────────────────────────────────────────────────────┘
```

##### Photo Meal Data Model

```typescript
interface PhotoMealLog extends FoodLogWithNutrition {
  // Photo data
  photos: {
    id: string;
    url: string;
    thumbnailUrl: string;
    takenAt: Date;
    uploadedAt: Date;

    // AI analysis results
    aiAnalysis?: {
      analyzedAt: Date;
      confidence: number;
      identifiedFoods: {
        name: string;
        confidence: number;
        boundingBox?: { x: number; y: number; width: number; height: number };
        suggestedNutritionId?: string;
      }[];
      rawResponse?: string;
    };
  }[];

  // Entry method tracking
  entryMethod: 'photo_with_ai' | 'photo_manual' | 'text_search' | 'quick_log';

  // Photo-specific fields
  photoOnly: boolean;  // true if user just uploaded photo without nutrition details
}

// AI Food Recognition Service
interface FoodRecognitionService {
  analyzeImage: (imageUrl: string) => Promise<{
    foods: {
      name: string;
      confidence: number;
      estimatedPortion?: string;
      nutritionMatch?: NutritionSearchResult;
    }[];
  }>;
}

const foodRecognitionService: FoodRecognitionService = {
  analyzeImage: async (imageUrl: string) => {
    // Use Claude Vision or similar for food recognition
    const response = await anthropic.messages.create({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 1024,
      messages: [{
        role: 'user',
        content: [
          {
            type: 'image',
            source: { type: 'url', url: imageUrl }
          },
          {
            type: 'text',
            text: `Analyze this food image. For each distinct food item visible:
1. Identify the food name
2. Estimate the portion size
3. Provide your confidence level (0-1)

Return as JSON: { "foods": [{ "name": string, "portion": string, "confidence": number }] }`
          }
        ]
      }]
    });

    const analysis = JSON.parse(response.content[0].text);

    // Match each food to nutrition database
    for (const food of analysis.foods) {
      const matches = await nutritionService.search(food.name, { limit: 1 });
      food.nutritionMatch = matches[0];
    }

    return analysis;
  }
};
```

---

#### Shareable Provider Booking Links

**High priority** - Unique URLs for patient self-booking, essential for external provider adoption.

##### Booking Link Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      SHAREABLE BOOKING LINKS                                 │
└─────────────────────────────────────────────────────────────────────────────┘

Provider generates booking link
         │
         ├── Generic link: book.platform.com/dr-williams
         │
         ├── Appointment-type specific: book.platform.com/dr-williams/new-patient
         │
         └── Embedded widget: <iframe src="book.platform.com/embed/dr-williams">
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  BOOKING PAGE (Public, no login required to view)                            │
│  ├── Provider profile & photo                                                │
│  ├── Available appointment types                                             │
│  ├── Real-time availability calendar                                         │
│  └── Simple booking flow                                                     │
└─────────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼
Patient selects time → Creates account (or logs in) → Confirms booking
```

##### Booking Link Data Model

```typescript
interface ProviderBookingPage {
  id: string;
  providerId: string;

  // URL configuration
  slug: string;  // "dr-sarah-williams" → book.platform.com/dr-sarah-williams
  customDomain?: string;  // Optional: "book.drwilliams.com"

  // Page settings
  isActive: boolean;
  settings: {
    showProviderPhoto: boolean;
    showProviderBio: boolean;
    showReviews: boolean;
    allowNewPatients: boolean;
    requireAccountBeforeBooking: boolean;
    theme: 'light' | 'dark' | 'custom';
    brandColor?: string;
    logoUrl?: string;
  };

  // Available appointment types
  bookableAppointmentTypes: {
    appointmentTypeId: string;
    name: string;
    duration: number;
    price?: number;
    description: string;
    isNewPatientType: boolean;
    requiresInsurance: boolean;
  }[];

  // Availability display
  availabilitySettings: {
    showDaysAhead: number;  // How far out to show availability
    bufferBetweenAppointments: number;  // minutes
    minimumNotice: number;  // hours before appointment
    blackoutDates: Date[];
  };

  // Analytics
  views: number;
  bookingsFromLink: number;
  conversionRate: number;
}

interface BookingLinkEmbed {
  providerId: string;
  embedType: 'inline' | 'popup' | 'floating_button';

  // Customization
  width?: string;
  height?: string;
  buttonText?: string;
  buttonColor?: string;

  // Generated embed code
  iframeCode: string;
  scriptCode: string;
}

// Generate embed codes
const generateEmbedCodes = (providerId: string, options: BookingLinkEmbed): EmbedCodes => {
  const baseUrl = `https://book.platform.com/embed/${providerId}`;

  return {
    iframe: `<iframe src="${baseUrl}" width="${options.width || '100%'}" height="${options.height || '600px'}" frameborder="0"></iframe>`,

    script: `<script src="https://book.platform.com/embed.js" data-provider="${providerId}" data-type="${options.embedType}"></script>`,

    popup: `<a href="#" onclick="PlatformBooking.open('${providerId}')">Book Appointment</a>
<script src="https://book.platform.com/popup.js"></script>`,
  };
};
```

##### Public Booking Page UI

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  [Platform Logo]                              [Already a patient? Log in]   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  ┌─────────┐                                                        │   │
│  │  │  👩‍⚕️   │  Dr. Sarah Williams, MD                                │   │
│  │  │  Photo  │  Endocrinology & Weight Management                     │   │
│  │  └─────────┘                                                        │   │
│  │                                                                     │   │
│  │  ⭐ 4.9 (142 reviews)  •  Salt Lake City, UT                       │   │
│  │                                                                     │   │
│  │  "Dr. Williams specializes in metabolic health, hormone therapy,   │   │
│  │   and medically-supervised weight loss programs."                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  SELECT APPOINTMENT TYPE                                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ ○ New Patient Consultation                    45 min    $149        │   │
│  │   Comprehensive initial evaluation for new patients                │   │
│  │ ─────────────────────────────────────────────────────────────────── │   │
│  │ ○ Follow-up Visit                             20 min    $79         │   │
│  │   For existing patients - check-in and adjustments                 │   │
│  │ ─────────────────────────────────────────────────────────────────── │   │
│  │ ○ Weight Loss Program Consultation            30 min    $99         │   │
│  │   GLP-1 medication evaluation and program overview                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  SELECT DATE & TIME                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │     ◄  February 2026  ►                                            │   │
│  │  Su   Mo   Tu   We   Th   Fr   Sa                                  │   │
│  │                                1                                    │   │
│  │  2    3    4    5    6    7    8                                   │   │
│  │  9   [10]  11   12   13   14   15                                  │   │
│  │  16   17   18   19   20   21   22                                  │   │
│  │  23   24   25   26   27   28                                       │   │
│  │                                                                     │   │
│  │  Available times for Monday, Feb 10:                               │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐                   │   │
│  │  │ 9:00 AM │ │10:00 AM │ │ 2:00 PM │ │ 3:30 PM │                   │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Continue to Book →                               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

#### Calendar Sync Service

**High priority** - Two-way synchronization with Google Calendar, Outlook, and iCal.

##### Calendar Sync Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         CALENDAR SYNC SERVICE                                │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  EXTERNAL CALENDARS                                                          │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐                    │
│  │ Google Cal    │  │ Outlook/M365  │  │ Apple/iCal    │                    │
│  │ (OAuth 2.0)   │  │ (OAuth 2.0)   │  │ (CalDAV)      │                    │
│  └───────────────┘  └───────────────┘  └───────────────┘                    │
└─────────────────────────────────────────────────────────────────────────────┘
         │                    │                    │
         └────────────────────┼────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  SYNC ENGINE                                                                 │
│  ├── Bidirectional sync every 5 minutes                                      │
│  ├── Webhook listeners for real-time updates (Google, Outlook)              │
│  ├── Conflict resolution (platform = source of truth for appointments)      │
│  └── Busy time detection for availability calculation                       │
└─────────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  PLATFORM CALENDAR                                                           │
│  ├── Appointments from platform                                              │
│  ├── Blocked time from external calendars                                    │
│  └── Combined availability view                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

##### Calendar Sync Data Model

```typescript
interface CalendarConnection {
  id: string;
  providerId: string;

  // Connection info
  provider: 'google' | 'outlook' | 'apple' | 'ical_url';
  status: 'connected' | 'disconnected' | 'error' | 'pending_reauth';

  // OAuth tokens (encrypted)
  accessToken?: string;
  refreshToken?: string;
  tokenExpiresAt?: Date;

  // For iCal URL feeds
  icalUrl?: string;

  // Selected calendars
  calendarsToSync: {
    externalCalendarId: string;
    name: string;
    color: string;
    syncDirection: 'read_only' | 'bidirectional';
    syncAppointments: boolean;  // Push platform appointments to this calendar
    blockAvailability: boolean; // Use events as busy time
  }[];

  // Sync settings
  syncSettings: {
    syncFrequencyMinutes: number;
    includeAppointmentDetails: boolean;  // vs just "Busy"
    reminderMinutes?: number;
    defaultCalendarForNewEvents?: string;
  };

  // Sync state
  lastSyncAt?: Date;
  lastSyncStatus: 'success' | 'partial' | 'failed';
  lastSyncError?: string;
  nextSyncAt?: Date;
}

interface ExternalCalendarEvent {
  id: string;
  connectionId: string;
  externalEventId: string;

  // Event details
  title: string;
  description?: string;
  startTime: Date;
  endTime: Date;
  isAllDay: boolean;
  location?: string;

  // Status
  status: 'confirmed' | 'tentative' | 'cancelled';
  transparency: 'busy' | 'free';

  // Attendees
  attendees?: {
    email: string;
    name?: string;
    responseStatus: 'accepted' | 'declined' | 'tentative' | 'needsAction';
  }[];

  // Recurrence
  isRecurring: boolean;
  recurrenceRule?: string;

  // Sync tracking
  lastSyncedAt: Date;
  syncedChecksum: string;  // To detect changes
}

// Platform appointment synced to external calendar
interface SyncedAppointment {
  appointmentId: string;
  connectionId: string;
  externalEventId: string;
  externalCalendarId: string;

  // Sync status
  syncStatus: 'pending' | 'synced' | 'failed' | 'deleted';
  lastSyncAttempt?: Date;
  syncError?: string;
}
```

##### Calendar Sync Implementation

```typescript
const calendarSyncService = {
  // Connect Google Calendar
  connectGoogle: async (providerId: string, authCode: string) => {
    const tokens = await googleOAuth.exchangeCode(authCode);
    const calendars = await googleCalendarApi.listCalendars(tokens.accessToken);

    return createCalendarConnection({
      providerId,
      provider: 'google',
      status: 'connected',
      accessToken: encrypt(tokens.accessToken),
      refreshToken: encrypt(tokens.refreshToken),
      tokenExpiresAt: tokens.expiresAt,
      calendarsToSync: calendars.map(cal => ({
        externalCalendarId: cal.id,
        name: cal.summary,
        color: cal.backgroundColor,
        syncDirection: cal.accessRole === 'owner' ? 'bidirectional' : 'read_only',
        syncAppointments: cal.primary,
        blockAvailability: true,
      })),
    });
  },

  // Sync external events to platform
  syncFromExternal: async (connectionId: string) => {
    const connection = await getCalendarConnection(connectionId);
    const api = getCalendarApi(connection.provider);

    for (const calendar of connection.calendarsToSync) {
      if (!calendar.blockAvailability) continue;

      const events = await api.listEvents(
        connection.accessToken,
        calendar.externalCalendarId,
        { timeMin: new Date(), timeMax: addDays(new Date(), 60) }
      );

      for (const event of events) {
        await upsertExternalCalendarEvent({
          connectionId,
          externalEventId: event.id,
          title: connection.syncSettings.includeAppointmentDetails ? event.summary : 'Busy',
          startTime: event.start.dateTime,
          endTime: event.end.dateTime,
          status: event.status,
          transparency: event.transparency || 'busy',
        });
      }
    }

    await updateConnectionSyncStatus(connectionId, 'success');
  },

  // Sync platform appointments to external calendar
  syncToExternal: async (appointmentId: string) => {
    const appointment = await getAppointment(appointmentId);
    const connection = await getProviderCalendarConnection(appointment.providerId);

    if (!connection || connection.status !== 'connected') return;

    const targetCalendar = connection.calendarsToSync.find(c => c.syncAppointments);
    if (!targetCalendar) return;

    const api = getCalendarApi(connection.provider);
    const eventData = {
      summary: `${appointment.patientName} - ${appointment.appointmentTypeName}`,
      description: connection.syncSettings.includeAppointmentDetails
        ? `Patient: ${appointment.patientName}\nType: ${appointment.appointmentTypeName}\nNotes: ${appointment.notes || 'None'}`
        : 'Patient appointment',
      start: { dateTime: appointment.scheduledAt },
      end: { dateTime: addMinutes(appointment.scheduledAt, appointment.duration) },
      reminders: connection.syncSettings.reminderMinutes
        ? { overrides: [{ method: 'popup', minutes: connection.syncSettings.reminderMinutes }] }
        : undefined,
    };

    const existingSync = await getSyncedAppointment(appointmentId);

    if (existingSync) {
      await api.updateEvent(connection.accessToken, targetCalendar.externalCalendarId, existingSync.externalEventId, eventData);
    } else {
      const event = await api.createEvent(connection.accessToken, targetCalendar.externalCalendarId, eventData);
      await createSyncedAppointment({
        appointmentId,
        connectionId: connection.id,
        externalEventId: event.id,
        externalCalendarId: targetCalendar.externalCalendarId,
        syncStatus: 'synced',
      });
    }
  },

  // Calculate availability considering external calendar events
  getAvailability: async (providerId: string, date: Date): Promise<TimeSlot[]> => {
    const baseAvailability = await getProviderBaseAvailability(providerId, date);
    const platformAppointments = await getProviderAppointments(providerId, date);
    const externalEvents = await getExternalCalendarEvents(providerId, date);

    const busyTimes = [
      ...platformAppointments.map(a => ({ start: a.scheduledAt, end: a.endAt })),
      ...externalEvents
        .filter(e => e.transparency === 'busy')
        .map(e => ({ start: e.startTime, end: e.endTime })),
    ];

    return subtractBusyTimesFromAvailability(baseAvailability, busyTimes);
  }
};
```

##### Calendar Settings UI

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  📅 Calendar Sync Settings                                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  CONNECTED CALENDARS                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 🔵 Google Calendar                                    ✅ Connected  │   │
│  │    Last synced: 2 minutes ago                                       │   │
│  │    ┌─────────────────────────────────────────────────────────────┐ │   │
│  │    │ ☑️ Personal Calendar          Block time ✓   Push appts ✓  │ │   │
│  │    │ ☑️ Work Calendar              Block time ✓   Push appts ☐  │ │   │
│  │    │ ☐ Holidays                    Block time ☐   Push appts ☐  │ │   │
│  │    └─────────────────────────────────────────────────────────────┘ │   │
│  │    [Manage] [Disconnect]                                           │   │
│  │ ─────────────────────────────────────────────────────────────────── │   │
│  │ ⚪ Microsoft Outlook                               [+ Connect]      │   │
│  │ ─────────────────────────────────────────────────────────────────── │   │
│  │ ⚪ Apple Calendar (iCal)                           [+ Connect]      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  SYNC SETTINGS                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Sync frequency:        [Every 5 minutes ▼]                          │   │
│  │                                                                     │   │
│  │ When pushing appointments to external calendar:                     │   │
│  │ ○ Show full appointment details (patient name, type)               │   │
│  │ ● Show only "Busy" (more private)                                  │   │
│  │                                                                     │   │
│  │ Add reminder:          [15 minutes before ▼]                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Save Changes                                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

#### Wearable Device Integration

**High priority** - Automatic data sync from fitness trackers and health devices.

##### Wearable Integration Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      WEARABLE DEVICE INTEGRATION                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  SUPPORTED DEVICES                                                           │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐     │
│  │ Apple     │ │ Google    │ │ Fitbit    │ │ Garmin    │ │ Oura      │     │
│  │ HealthKit │ │ Fit       │ │           │ │ Connect   │ │ Ring      │     │
│  └───────────┘ └───────────┘ └───────────┘ └───────────┘ └───────────┘     │
└─────────────────────────────────────────────────────────────────────────────┘
         │              │             │             │             │
         └──────────────┴─────────────┴─────────────┴─────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  WEARABLE DATA SERVICE                                                       │
│  ├── OAuth connections to device APIs                                        │
│  ├── Data normalization across platforms                                     │
│  ├── Background sync (daily batch + on-demand)                              │
│  └── Data quality validation                                                 │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  HEALTH DATA TYPES                                                           │
│  ├── Weight (daily)                                                          │
│  ├── Steps (daily)                                                           │
│  ├── Sleep (duration, quality, stages)                                       │
│  ├── Heart Rate (resting, active, HRV)                                       │
│  ├── Activity (workouts, calories burned)                                    │
│  └── Body Composition (body fat %, if available)                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  INTEGRATION WITH PLATFORM                                                   │
│  ├── Auto-populate journal entries (weight, sleep, activity)                 │
│  ├── Display trends on patient dashboard                                     │
│  ├── Provider visibility into patient health data                            │
│  └── Outcome tracking integration (weight loss programs)                     │
└─────────────────────────────────────────────────────────────────────────────┘
```

##### Wearable Data Model

```typescript
interface WearableConnection {
  id: string;
  patientId: string;

  // Device info
  provider: 'apple_health' | 'google_fit' | 'fitbit' | 'garmin' | 'oura' | 'withings';
  status: 'connected' | 'disconnected' | 'error' | 'pending_reauth';

  // OAuth (for API-based providers)
  accessToken?: string;
  refreshToken?: string;
  tokenExpiresAt?: Date;

  // Data permissions granted
  permissions: {
    weight: boolean;
    steps: boolean;
    sleep: boolean;
    heartRate: boolean;
    workouts: boolean;
    bodyComposition: boolean;
  };

  // Sync settings
  syncSettings: {
    autoSync: boolean;
    syncFrequencyHours: number;
    autoPopulateJournal: boolean;
  };

  // Sync state
  lastSyncAt?: Date;
  lastSyncStatus: 'success' | 'partial' | 'failed';
  dataPointsSynced: number;
}

interface WearableDataPoint {
  id: string;
  connectionId: string;
  patientId: string;

  // Data type
  dataType: 'weight' | 'steps' | 'sleep' | 'heart_rate' | 'workout' | 'body_composition';

  // Timestamp
  recordedAt: Date;
  syncedAt: Date;

  // Source
  source: string;  // e.g., "Apple Watch", "Fitbit Charge 5"
  sourceId?: string;  // External ID to prevent duplicates

  // Data (varies by type)
  data: WeightData | StepsData | SleepData | HeartRateData | WorkoutData | BodyCompositionData;
}

interface WeightData {
  type: 'weight';
  weightKg: number;
  weightLbs: number;
  bmi?: number;
}

interface StepsData {
  type: 'steps';
  steps: number;
  distanceMeters?: number;
  distanceMiles?: number;
  floorsClimbed?: number;
}

interface SleepData {
  type: 'sleep';
  startTime: Date;
  endTime: Date;
  durationMinutes: number;
  sleepScore?: number;  // 0-100
  stages?: {
    awake: number;      // minutes
    light: number;
    deep: number;
    rem: number;
  };
  restingHeartRate?: number;
  hrv?: number;
}

interface HeartRateData {
  type: 'heart_rate';
  restingBpm?: number;
  averageBpm?: number;
  maxBpm?: number;
  minBpm?: number;
  hrv?: number;  // Heart rate variability in ms
}

interface WorkoutData {
  type: 'workout';
  activityType: string;  // "Running", "Cycling", "Strength Training", etc.
  startTime: Date;
  endTime: Date;
  durationMinutes: number;
  caloriesBurned?: number;
  averageHeartRate?: number;
  maxHeartRate?: number;
  distanceMeters?: number;
}

interface BodyCompositionData {
  type: 'body_composition';
  bodyFatPercent?: number;
  muscleMassKg?: number;
  boneMassKg?: number;
  waterPercent?: number;
  visceralFat?: number;
}
```

##### Wearable Sync Service

```typescript
const wearableSyncService = {
  // Connect a wearable device
  connect: async (patientId: string, provider: string, authCode: string) => {
    const api = getWearableApi(provider);
    const tokens = await api.exchangeAuthCode(authCode);

    const connection = await createWearableConnection({
      patientId,
      provider,
      status: 'connected',
      accessToken: encrypt(tokens.accessToken),
      refreshToken: encrypt(tokens.refreshToken),
      tokenExpiresAt: tokens.expiresAt,
      permissions: await api.getGrantedPermissions(tokens.accessToken),
    });

    // Initial sync
    await wearableSyncService.syncData(connection.id);

    return connection;
  },

  // Sync data from wearable
  syncData: async (connectionId: string) => {
    const connection = await getWearableConnection(connectionId);
    const api = getWearableApi(connection.provider);

    // Refresh token if needed
    if (connection.tokenExpiresAt && connection.tokenExpiresAt < new Date()) {
      const newTokens = await api.refreshTokens(connection.refreshToken);
      await updateConnectionTokens(connectionId, newTokens);
    }

    const lastSync = connection.lastSyncAt || subDays(new Date(), 30);
    let dataPointsSynced = 0;

    // Sync each data type the user has granted access to
    if (connection.permissions.weight) {
      const weights = await api.getWeightData(connection.accessToken, lastSync);
      for (const w of weights) {
        await upsertWearableDataPoint({
          connectionId,
          patientId: connection.patientId,
          dataType: 'weight',
          recordedAt: w.date,
          sourceId: w.id,
          data: { type: 'weight', weightKg: w.kg, weightLbs: w.kg * 2.205 },
        });
        dataPointsSynced++;
      }
    }

    if (connection.permissions.sleep) {
      const sleepData = await api.getSleepData(connection.accessToken, lastSync);
      for (const s of sleepData) {
        await upsertWearableDataPoint({
          connectionId,
          patientId: connection.patientId,
          dataType: 'sleep',
          recordedAt: s.date,
          sourceId: s.id,
          data: {
            type: 'sleep',
            startTime: s.startTime,
            endTime: s.endTime,
            durationMinutes: s.durationMinutes,
            sleepScore: s.score,
            stages: s.stages,
          },
        });
        dataPointsSynced++;
      }
    }

    // Similar for steps, heart rate, workouts, body composition...

    await updateConnectionSyncStatus(connectionId, 'success', dataPointsSynced);

    // Auto-populate journal if enabled
    if (connection.syncSettings.autoPopulateJournal) {
      await autoPopulateJournalFromWearables(connection.patientId);
    }
  },

  // Auto-create journal entries from wearable data
  autoPopulateJournalFromWearables: async (patientId: string) => {
    const today = startOfDay(new Date());
    const yesterdayData = await getWearableDataForDate(patientId, subDays(today, 1));

    // Create weight journal entry if weight data exists
    const weightData = yesterdayData.find(d => d.dataType === 'weight');
    if (weightData) {
      await createOrUpdateJournalEntry({
        patientId,
        entryType: 'weight_log',
        date: weightData.recordedAt,
        data: {
          weight: weightData.data.weightLbs,
          source: 'wearable_auto',
          deviceSource: weightData.source,
        },
        sharedWithProvider: true,
      });
    }

    // Create sleep journal entry
    const sleepData = yesterdayData.find(d => d.dataType === 'sleep');
    if (sleepData) {
      await createOrUpdateJournalEntry({
        patientId,
        entryType: 'sleep_log',
        date: sleepData.recordedAt,
        data: {
          hoursSlept: sleepData.data.durationMinutes / 60,
          sleepQuality: Math.round(sleepData.data.sleepScore / 20),  // Convert to 1-5
          source: 'wearable_auto',
        },
        sharedWithProvider: true,
      });
    }
  }
};
```

##### Patient Wearable Dashboard

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  ⌚ Connected Devices                                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 🍎 Apple Health                                      ✅ Connected   │   │
│  │    Syncing: Weight, Sleep, Steps, Workouts                         │   │
│  │    Last sync: 1 hour ago                                           │   │
│  │    [Manage Permissions] [Disconnect]                               │   │
│  │ ─────────────────────────────────────────────────────────────────── │   │
│  │ 💍 Oura Ring                                         ✅ Connected   │   │
│  │    Syncing: Sleep, Heart Rate, HRV                                 │   │
│  │    Last sync: 3 hours ago                                          │   │
│  │    [Manage Permissions] [Disconnect]                               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  [+ Connect Another Device]                                                │
│  Supported: Apple Health, Google Fit, Fitbit, Garmin, Oura, Withings      │
│                                                                             │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│  📊 YOUR DATA (Last 7 Days)                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                           WEIGHT                                    │   │
│  │  198 ──●─────────────────────────────●──────────────●─── 195       │   │
│  │       Mon   Tue   Wed   Thu   Fri   Sat   Sun                      │   │
│  │  Current: 195.2 lbs  │  Start: 210 lbs  │  Lost: 14.8 lbs 🎉      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  😴 SLEEP             │  🚶 STEPS              │  ❤️ RESTING HR    │   │
│  │  Avg: 7.2 hrs         │  Avg: 8,432/day        │  Avg: 62 bpm      │   │
│  │  ████████░░ 72%       │  ████████░░ 84%        │  ↓ from 68 bpm    │   │
│  │  vs 8hr goal          │  vs 10K goal           │  Good trend!      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ☑️ Auto-add wearable data to my journal (providers can see your trends)   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

#### Patient Side Effect Reporting

Self-service interface for patients to report medication side effects directly from the patient portal.

| Decision | Choice |
|----------|--------|
| Report types | Medication-specific + general health changes |
| Severity classification | Patient self-rated + clinical triage |
| Provider notification | Immediate for severe, batched for mild |
| Integration | Links to pharmacovigilance if serious |

##### Side Effect Report Data Model

```typescript
interface PatientSideEffectReport {
  id: string;
  patientId: string;
  prescriptionId: string;
  medicationId: string;
  medicationName: string;

  reportedAt: Date;
  reportMethod: 'patient_portal' | 'mobile_app' | 'dose_log_prompt' | 'provider_assisted';

  sideEffects: ReportedSideEffect[];

  overallImpact: {
    affectingDailyLife: boolean;
    severityRating: 1 | 2 | 3 | 4 | 5;  // 1=minimal, 5=severe
    consideringStoppingMedication: boolean;
    alreadyStoppedMedication: boolean;
    stoppedDate?: Date;
  };

  timeline: {
    medicationStartDate: Date;
    sideEffectOnsetDate: Date;
    daysAfterStarting: number;
    currentDose: string;
    recentDoseChange: boolean;
    doseChangedDate?: Date;
  };

  patientActions: {
    actionsTaken: ('none' | 'reduced_dose' | 'changed_timing' | 'took_otc' | 'contacted_provider' | 'went_to_er' | 'stopped_medication')[];
    actionDetails?: string;
    otcMedicationsUsed?: string[];
  };

  attachments?: {
    photos?: string[];  // Rash, swelling, etc.
    additionalNotes?: string;
  };

  clinicalTriage: {
    triageLevel: 'routine' | 'soon' | 'urgent' | 'emergency';
    autoTriagedAt: Date;
    providerReviewRequired: boolean;
    pharmacistReviewRequired: boolean;
  };

  providerReview?: {
    reviewedBy: string;
    reviewedAt: Date;
    assessment: string;
    action: 'continue_monitoring' | 'adjust_dose' | 'change_medication' | 'schedule_visit' | 'refer_specialist' | 'send_to_er';
    followUpScheduled: boolean;
    followUpDate?: Date;
  };

  pharmacovigilanceLink?: {
    linkedToAEReport: boolean;
    adverseEventId?: string;
    meetsSerious Criteria: boolean;
  };

  status: 'submitted' | 'auto_triaged' | 'provider_reviewing' | 'action_taken' | 'resolved' | 'escalated';

  createdAt: Date;
  updatedAt: Date;
}

interface ReportedSideEffect {
  symptom: string;
  symptomCode?: string;  // MedDRA preferred term
  category: 'gastrointestinal' | 'neurological' | 'cardiovascular' | 'dermatological' |
            'musculoskeletal' | 'respiratory' | 'psychiatric' | 'metabolic' | 'other';

  severity: 'mild' | 'moderate' | 'severe';
  frequency: 'constant' | 'frequent' | 'occasional' | 'rare';
  duration: 'minutes' | 'hours' | 'days' | 'ongoing';

  firstOccurrence: Date;
  stillExperiencing: boolean;

  commonSideEffect: boolean;  // Known side effect for this medication
}
```

##### Medication-Specific Side Effect Templates

```typescript
interface MedicationSideEffectProfile {
  medicationId: string;
  medicationName: string;
  medicationClass: string;

  commonSideEffects: {
    symptom: string;
    frequency: 'very_common' | 'common' | 'uncommon' | 'rare';
    typicalOnset: string;
    typicalDuration: string;
    selfManagement: string[];
    whenToReport: string;
  }[];

  seriousSideEffects: {
    symptom: string;
    warningSignsToWatch: string[];
    action: 'contact_provider' | 'seek_immediate_care' | 'call_911';
  }[];

  drugSpecificQuestions: {
    question: string;
    responseType: 'yes_no' | 'scale' | 'multiple_choice' | 'free_text';
    options?: string[];
    triggersAlert?: boolean;
  }[];
}

const semaglutideSideEffectProfile: MedicationSideEffectProfile = {
  medicationId: 'semaglutide',
  medicationName: 'Semaglutide',
  medicationClass: 'GLP-1 Receptor Agonist',

  commonSideEffects: [
    {
      symptom: 'Nausea',
      frequency: 'very_common',
      typicalOnset: 'First 1-2 weeks, often after dose increases',
      typicalDuration: 'Usually improves within 2-4 weeks',
      selfManagement: [
        'Eat smaller meals',
        'Avoid fatty or spicy foods',
        'Stay hydrated',
        'Take with food if tolerated'
      ],
      whenToReport: 'If persistent vomiting, unable to keep fluids down, or lasting > 2 weeks'
    },
    {
      symptom: 'Decreased appetite',
      frequency: 'very_common',
      typicalOnset: 'Within first week',
      typicalDuration: 'Often persists (this is part of how the medication works)',
      selfManagement: ['Eat regular small meals even if not hungry', 'Focus on protein'],
      whenToReport: 'If you\'re eating very little or losing weight too rapidly (>4 lbs/week)'
    },
    {
      symptom: 'Injection site reactions',
      frequency: 'common',
      typicalOnset: 'At time of injection',
      typicalDuration: '1-3 days',
      selfManagement: ['Rotate injection sites', 'Let medication reach room temperature'],
      whenToReport: 'If spreading redness, warmth, or signs of infection'
    }
  ],

  seriousSideEffects: [
    {
      symptom: 'Signs of pancreatitis',
      warningSignsToWatch: ['Severe abdominal pain radiating to back', 'Persistent nausea/vomiting', 'Fever'],
      action: 'seek_immediate_care'
    },
    {
      symptom: 'Signs of hypoglycemia (if on insulin)',
      warningSignsToWatch: ['Shakiness', 'Sweating', 'Confusion', 'Rapid heartbeat'],
      action: 'contact_provider'
    },
    {
      symptom: 'Allergic reaction',
      warningSignsToWatch: ['Swelling of face/throat', 'Difficulty breathing', 'Severe rash'],
      action: 'call_911'
    }
  ],

  drugSpecificQuestions: [
    {
      question: 'Are you experiencing any abdominal pain?',
      responseType: 'scale',
      options: ['None', 'Mild', 'Moderate', 'Severe'],
      triggersAlert: true  // Severe triggers immediate review
    },
    {
      question: 'How many meals are you eating per day?',
      responseType: 'multiple_choice',
      options: ['3+', '2', '1', 'Less than 1'],
      triggersAlert: true  // Less than 1 triggers review
    }
  ]
};
```

##### Patient Portal - Side Effect Reporting UI

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ REPORT A SIDE EFFECT                                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│ Which medication are you reporting about?                                   │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ ● Semaglutide 0.5mg (weekly injection)                                  │ │
│ │ ○ Vitamin D3 5000IU                                                      │ │
│ │ ○ Magnesium Glycinate 400mg                                             │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ ─────────────────────────────────────────────────────────────────────────── │
│                                                                              │
│ What are you experiencing? (Select all that apply)                          │
│                                                                              │
│ COMMON WITH SEMAGLUTIDE:                                                    │
│ ☑️ Nausea                                                                   │
│ ☑️ Decreased appetite                                                       │
│ ☐ Constipation                                                              │
│ ☐ Diarrhea                                                                  │
│ ☐ Fatigue                                                                   │
│ ☐ Injection site reaction                                                   │
│                                                                              │
│ OTHER:                                                                       │
│ ☐ Headache                                                                  │
│ ☐ Dizziness                                                                 │
│ ☐ Abdominal pain  ⚠️ Tell us more if you select this                       │
│ ☐ Something else: [___________________]                                     │
│                                                                              │
│ ─────────────────────────────────────────────────────────────────────────── │
│                                                                              │
│ How severe is the nausea?                                                   │
│ ○ Mild - noticeable but not affecting my day                               │
│ ● Moderate - affecting what I can eat/do                                   │
│ ○ Severe - significantly impacting my life                                 │
│                                                                              │
│ When did the nausea start?                                                  │
│ [February 5, 2024  ▼]                                                       │
│                                                                              │
│ Are you still experiencing it?                                              │
│ ● Yes  ○ No, it resolved on [____]                                         │
│                                                                              │
│ ─────────────────────────────────────────────────────────────────────────── │
│                                                                              │
│ How is this affecting you overall?                                          │
│                                                                              │
│ Is this affecting your daily activities?                                    │
│ ● Yes  ○ No                                                                 │
│                                                                              │
│ Are you thinking about stopping the medication?                             │
│ ○ No  ● Maybe  ○ Yes, I already stopped                                    │
│                                                                              │
│ ─────────────────────────────────────────────────────────────────────────── │
│                                                                              │
│ Anything else you'd like us to know?                                        │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ The nausea is worst in the morning and after eating. I've been eating  │ │
│ │ smaller meals which helps a little.                                     │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ [Attach a photo (optional)]                                                  │
│                                                                              │
│                                                    [Cancel]  [Submit Report] │
└─────────────────────────────────────────────────────────────────────────────┘
```

##### Auto-Triage Rules

```typescript
const sideEffectTriageRules = [
  {
    name: 'Emergency symptoms',
    conditions: [
      { symptom: 'difficulty_breathing', action: 'emergency' },
      { symptom: 'chest_pain', action: 'emergency' },
      { symptom: 'allergic_reaction_severe', action: 'emergency' },
      { symptom: 'suicidal_thoughts', action: 'emergency' }
    ],
    action: 'Show emergency message + 911 prompt',
    triageLevel: 'emergency'
  },
  {
    name: 'Urgent symptoms',
    conditions: [
      { symptom: 'severe_abdominal_pain', action: 'urgent' },
      { symptom: 'persistent_vomiting', action: 'urgent' },
      { symptom: 'signs_of_dehydration', action: 'urgent' },
      { symptom: 'medication_stopped_without_guidance', medicationClass: 'antidepressant', action: 'urgent' }
    ],
    action: 'Immediate provider notification + patient callback within 4 hours',
    triageLevel: 'urgent'
  },
  {
    name: 'Soon review',
    conditions: [
      { severity: 'severe', anySymptom: true },
      { symptom: 'considering_stopping', value: true },
      { symptom: 'affecting_daily_life', value: true, duration: '>7_days' }
    ],
    action: 'Provider review within 24 hours',
    triageLevel: 'soon'
  },
  {
    name: 'Routine',
    conditions: [
      { severity: 'mild', knownSideEffect: true },
      { severity: 'moderate', knownSideEffect: true, duration: '<7_days' }
    ],
    action: 'Add to provider dashboard, batch notification',
    triageLevel: 'routine'
  }
];
```

##### Provider Notification

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ 🔔 SIDE EFFECT REPORTS                                      3 New Today     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│ ⚠️ SOON (Review within 24 hours)                                            │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ Sarah M. · Semaglutide 0.5mg · Reported 2 hours ago                     │ │
│ │ Symptoms: Nausea (moderate), Decreased appetite                          │ │
│ │ Impact: Affecting daily life · Considering stopping                      │ │
│ │ Duration: 5 days since dose increase                                     │ │
│ │ [View Full Report] [Message Patient] [Adjust Prescription]              │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ 📋 ROUTINE (2)                                                               │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ Michael T. · Testosterone Cypionate · Injection site redness (mild)    │ │
│ │ Jennifer L. · Progesterone · Drowsiness (mild) - taking at bedtime     │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ [View All Side Effect Reports]                                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

##### Integration with Pharmacovigilance

```typescript
const pharmacovigilanceEscalation = {
  triggers: [
    { criteria: 'hospitalization_mentioned', action: 'create_adverse_event' },
    { criteria: 'er_visit_mentioned', action: 'create_adverse_event' },
    { criteria: 'severity_severe_plus_unexpected', action: 'flag_for_review' },
    { criteria: 'same_symptom_3_plus_patients_same_batch', action: 'signal_detection' }
  ],

  linkToAEReport: async (sideEffectReportId: string) => {
    // Creates preliminary adverse event for pharmacist review
    // Pulls data from side effect report
    // Pharmacist determines if MedWatch submission required
  }
};
```

---

#### Patient Journey Dashboard

Unified view of the patient's complete health journey on the platform.

##### Journey Dashboard Data Model

```typescript
interface PatientJourneyDashboard {
  patientId: string;
  generatedAt: Date;

  summary: {
    memberSince: Date;
    daysSinceJoining: number;
    totalConsultations: number;
    totalPrescriptions: number;
    totalOrders: number;
    currentMedications: number;
    overallAdherence: number;
    totalSaved: number;
  };

  healthGoals: PatientGoal[];

  timeline: JourneyEvent[];

  currentMedications: CurrentMedication[];

  upcomingActions: UpcomingAction[];

  labHistory: LabSummary[];

  costHistory: CostSummary;
}

interface PatientGoal {
  id: string;
  goalType: 'weight' | 'blood_pressure' | 'a1c' | 'cholesterol' | 'custom';
  goalName: string;

  startValue: number;
  currentValue: number;
  targetValue: number;
  unit: string;

  progressPercent: number;
  trend: 'improving' | 'stable' | 'declining';

  startDate: Date;
  targetDate?: Date;

  milestones: {
    value: number;
    reachedAt?: Date;
    label: string;
  }[];
}

interface JourneyEvent {
  id: string;
  eventType: 'consultation' | 'prescription' | 'order' | 'delivery' | 'lab_result' |
             'refill' | 'side_effect_report' | 'goal_milestone' | 'program_enrollment' |
             'program_completion' | 'message' | 'follow_up';

  date: Date;
  title: string;
  description: string;

  relatedEntities: {
    consultationId?: string;
    prescriptionId?: string;
    orderId?: string;
    labResultId?: string;
    providerId?: string;
    providerName?: string;
  };

  outcome?: string;
  actionRequired?: boolean;
}

interface CurrentMedication {
  prescriptionId: string;
  medicationName: string;
  dosage: string;
  frequency: string;

  prescribedDate: Date;
  prescribedBy: string;

  status: 'active' | 'paused' | 'discontinued';
  adherencePercent: number;

  lastRefillDate?: Date;
  nextRefillDate?: Date;
  refillsRemaining: number;

  daysSupplyRemaining: number;
  autoRefillEnabled: boolean;
}

interface UpcomingAction {
  actionType: 'refill_due' | 'appointment' | 'lab_due' | 'check_in' | 'program_task' | 'follow_up';
  dueDate: Date;
  daysUntilDue: number;
  priority: 'low' | 'medium' | 'high';

  title: string;
  description: string;

  actionUrl?: string;
  actionLabel?: string;
}

interface LabSummary {
  labType: string;
  testName: string;

  results: {
    date: Date;
    value: number;
    unit: string;
    referenceRange: { low: number; high: number };
    status: 'normal' | 'low' | 'high' | 'critical';
  }[];

  trend: 'improving' | 'stable' | 'worsening';
  nextDueDate?: Date;
}

interface CostSummary {
  totalSpent: number;
  totalSaved: number;           // vs retail pricing
  employerContribution: number;
  insuranceContribution: number;
  outOfPocket: number;

  byMonth: {
    month: string;
    spent: number;
    saved: number;
  }[];

  byCategory: {
    category: string;
    spent: number;
    orderCount: number;
  }[];
}
```

##### Patient Journey Dashboard UI

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ MY HEALTH JOURNEY                                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│ 👋 Welcome back, Sarah!                    Member since January 2024        │
│                                                                              │
│ ═══════════════════════════════════════════════════════════════════════════ │
│                                                                              │
│ 🎯 YOUR GOALS                                                                │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ WEIGHT LOSS GOAL                                    Target: 165 lbs     │ │
│ │                                                                          │ │
│ │ Start: 210 lbs ────────────●─────────────────────○ Goal: 165 lbs       │ │
│ │                         185 lbs                                         │ │
│ │                         (56% there!)                                    │ │
│ │                                                                          │ │
│ │ 🎉 Milestones: ✓ -10 lbs  ✓ -20 lbs  ● -25 lbs  ○ -35 lbs  ○ -45 lbs  │ │
│ │                                                                          │ │
│ │ Trend: ↓ 2.3 lbs this month · On track for goal by August              │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ ═══════════════════════════════════════════════════════════════════════════ │
│                                                                              │
│ 💊 CURRENT MEDICATIONS                                                       │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ Semaglutide 1mg                Weekly · Dr. Martinez                    │ │
│ │ ████████████████████░░░░░░░░░░ 67% adherence · Next refill: Feb 28     │ │
│ │ 14 days supply remaining · Auto-refill: ON              [Manage]       │ │
│ ├─────────────────────────────────────────────────────────────────────────┤ │
│ │ Vitamin D3 5000IU              Daily · Dr. Martinez                     │ │
│ │ ██████████████████████████████ 95% adherence · Next refill: Mar 15     │ │
│ │ 34 days supply remaining · Auto-refill: ON              [Manage]       │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ ═══════════════════════════════════════════════════════════════════════════ │
│                                                                              │
│ 📅 UPCOMING                                                                  │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 🔴 Feb 15  Lab work due (Metabolic Panel)               [Schedule Lab] │ │
│ │ 🟡 Feb 22  Follow-up with Dr. Martinez                  [Reschedule]   │ │
│ │ 🟢 Feb 28  Semaglutide refill ships                     [View Order]   │ │
│ │ 🟢 Mar 5   Weekly check-in survey                       [Set Reminder] │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ ═══════════════════════════════════════════════════════════════════════════ │
│                                                                              │
│ 📜 YOUR JOURNEY TIMELINE                         Filter: All ▼  [Expand]   │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │                                                                          │ │
│ │ Feb 8   💊 Refill shipped · Semaglutide 1mg                            │ │
│ │         Tracking: 1Z999AA10123456784 · Arriving Feb 10                 │ │
│ │                                                                          │ │
│ │ Feb 5   📋 Lab results received · Metabolic Panel                      │ │
│ │         A1C: 5.8% (normal) · TSH: 2.1 (normal)         [View Results]  │ │
│ │                                                                          │ │
│ │ Feb 1   🎉 Milestone reached! Lost 25 lbs                              │ │
│ │         You've lost 25 lbs since starting. Keep it up!                 │ │
│ │                                                                          │ │
│ │ Jan 25  👩‍⚕️ Consultation · Dr. Martinez                               │ │
│ │         Dose increase approved. Discussed side effects.   [View Notes] │ │
│ │                                                                          │ │
│ │ Jan 20  ⚠️ Side effect reported · Mild nausea                         │ │
│ │         Resolved after 5 days. Provider notified.                      │ │
│ │                                                                          │ │
│ │ Jan 15  📦 Order delivered · Semaglutide 0.5mg                         │ │
│ │                                                                          │ │
│ │         ··· [Load more history]                                        │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ ═══════════════════════════════════════════════════════════════════════════ │
│                                                                              │
│ 📊 LAB TRENDS                                                                │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ A1C                                          Reference: 4.0 - 5.6%     │ │
│ │                                                                          │ │
│ │ 7.0% ┤                                                                  │ │
│ │ 6.5% ┤ ●                                                                │ │
│ │ 6.0% ┤    ●                                                             │ │
│ │ 5.5% ┤       ●        ●                                                 │ │
│ │ 5.0% ┤                                                                  │ │
│ │      └────────────────────────────────────────────                      │ │
│ │       Oct    Nov    Dec    Jan    Feb                                   │ │
│ │                                                                          │ │
│ │ Current: 5.8% (↓ from 6.4%)  Status: ✅ Normal                         │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ ═══════════════════════════════════════════════════════════════════════════ │
│                                                                              │
│ 💰 YOUR SAVINGS                                                              │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ Total Saved: $1,247                              Since Jan 2024        │ │
│ │                                                                          │ │
│ │ ┌─────────────┬─────────────┬─────────────┐                             │ │
│ │ │ You Paid    │ Employer    │ vs Retail   │                             │ │
│ │ │   $890      │   $650      │  $2,787     │                             │ │
│ │ │ out of pocket│ contributed │ would cost  │                             │ │
│ │ └─────────────┴─────────────┴─────────────┘                             │ │
│ │                                                                          │ │
│ │ [View Detailed Cost History]                                            │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

##### Journey Event Generation

```typescript
const journeyEventGenerators = {
  consultation: (consult: Consultation) => ({
    eventType: 'consultation',
    date: consult.completedAt,
    title: `Consultation with ${consult.providerName}`,
    description: consult.chiefComplaint || 'Follow-up visit',
    relatedEntities: { consultationId: consult.id, providerId: consult.providerId }
  }),

  prescription: (rx: Prescription) => ({
    eventType: 'prescription',
    date: rx.writtenAt,
    title: `New prescription: ${rx.medicationName}`,
    description: `${rx.dosage} - ${rx.directions}`,
    relatedEntities: { prescriptionId: rx.id, providerId: rx.prescriberId }
  }),

  order: (order: Order) => ({
    eventType: 'order',
    date: order.placedAt,
    title: `Order placed`,
    description: `${order.items.length} item(s) - $${order.total}`,
    relatedEntities: { orderId: order.id }
  }),

  delivery: (shipment: Shipment) => ({
    eventType: 'delivery',
    date: shipment.deliveredAt,
    title: `Order delivered`,
    description: shipment.items.map(i => i.name).join(', '),
    relatedEntities: { orderId: shipment.orderId }
  }),

  labResult: (lab: LabResult) => ({
    eventType: 'lab_result',
    date: lab.resultDate,
    title: `Lab results: ${lab.testName}`,
    description: lab.summary,
    relatedEntities: { labResultId: lab.id },
    actionRequired: lab.abnormalResults > 0
  }),

  goalMilestone: (milestone: GoalMilestone) => ({
    eventType: 'goal_milestone',
    date: milestone.reachedAt,
    title: `🎉 Milestone: ${milestone.label}`,
    description: milestone.celebrationMessage
  }),

  sideEffect: (report: SideEffectReport) => ({
    eventType: 'side_effect_report',
    date: report.reportedAt,
    title: `Side effect reported: ${report.primarySymptom}`,
    description: `Severity: ${report.severity} - ${report.resolution || 'In progress'}`,
    relatedEntities: { prescriptionId: report.prescriptionId }
  })
};
```

---

### Patient Engagement Summary

| Feature | Priority | Status |
|---------|----------|--------|
| **Drip Content Engine** | Critical | ✅ Added |
| **Provider Journal Engagement** | Critical | ✅ Added |
| **Nutrition Database Integration** | Critical | ✅ Added |
| **Photo-Based Meal Logging** | High | ✅ Added |
| **Shareable Booking Links** | High | ✅ Added |
| **Calendar Sync Service** | High | ✅ Added |
| **Wearable Device Integration** | High | ✅ Added |
| Pre-Built Program Templates | High | ✅ Added |
| **Patient Side Effect Reporting** | High | ✅ Added |
| **Patient Journey Dashboard** | High | ✅ Added |

---

### Provider-to-Provider Messaging & Care Coordination

Secure communication between providers for care coordination, referrals, and shared patient management.

| Decision | Choice |
|----------|--------|
| Message security | HIPAA-compliant, encrypted end-to-end |
| Delivery method | In-platform + optional Surescripts Clinical Direct Messaging |
| Patient visibility | Provider controls what patient sees |
| Thread types | Patient-specific, general consultation, referrals |

#### Provider Messaging Data Model

```typescript
interface ProviderMessage {
  id: string;
  threadId: string;

  senderId: string;
  senderName: string;
  senderRole: 'physician' | 'np' | 'pa' | 'pharmacist' | 'care_coordinator';
  senderOrganization?: string;

  recipientIds: string[];
  recipientType: 'specific_providers' | 'care_team' | 'specialty_group';

  content: {
    subject?: string;
    body: string;
    format: 'plain_text' | 'structured';
    urgency: 'routine' | 'soon' | 'urgent' | 'stat';
  };

  attachments?: ProviderAttachment[];

  patientContext?: {
    patientId: string;
    patientName: string;
    relevantPrescriptions?: string[];
    relevantDiagnoses?: string[];
    relevantEncounters?: string[];
  };

  messageType: 'general' | 'referral_request' | 'referral_response' | 'consultation_request' |
               'lab_discussion' | 'medication_question' | 'care_coordination' | 'handoff';

  externalDelivery?: {
    viaDirectMessaging: boolean;
    directAddress?: string;
    deliveryStatus: 'not_sent' | 'sent' | 'delivered' | 'read' | 'failed';
    mdnReceived?: Date;
  };

  readBy: { providerId: string; readAt: Date }[];

  status: 'draft' | 'sent' | 'delivered' | 'read' | 'archived';

  createdAt: Date;
  updatedAt: Date;
}

interface ProviderMessageThread {
  id: string;
  type: 'patient_care' | 'consultation' | 'referral' | 'administrative';

  participants: ThreadParticipant[];

  patientId?: string;
  patientName?: string;

  subject: string;
  lastMessageAt: Date;
  messageCount: number;

  status: 'active' | 'resolved' | 'archived';
  resolvedAt?: Date;
  resolvedBy?: string;
  resolution?: string;

  tags?: string[];
  priority: 'routine' | 'high' | 'urgent';

  createdAt: Date;
  updatedAt: Date;
}

interface ThreadParticipant {
  providerId: string;
  providerName: string;
  role: string;
  specialty?: string;
  organization?: string;

  isExternal: boolean;  // External provider (via Direct Messaging)
  directAddress?: string;

  joinedAt: Date;
  lastReadAt?: Date;
  notificationPreference: 'all' | 'mentions' | 'none';
}

interface ProviderAttachment {
  id: string;
  fileName: string;
  fileType: string;
  fileSize: number;
  url: string;  // S3 presigned URL

  attachmentType: 'lab_result' | 'imaging' | 'clinical_note' | 'prescription' |
                  'referral_letter' | 'patient_document' | 'other';

  sourceRecordId?: string;  // Link to original record if from EHR
}
```

#### Care Team Management

```typescript
interface PatientCareTeam {
  patientId: string;

  primaryProvider: CareTeamMember;
  careTeamMembers: CareTeamMember[];

  externalProviders: ExternalProviderReference[];

  settings: {
    shareAllNotes: boolean;
    shareLabResults: boolean;
    sharePrescriptions: boolean;
    notifyOnChanges: boolean;
  };

  createdAt: Date;
  updatedAt: Date;
}

interface CareTeamMember {
  providerId: string;
  providerName: string;
  role: 'primary_care' | 'specialist' | 'pharmacist' | 'care_coordinator' | 'mental_health' | 'nutritionist';
  specialty?: string;

  responsibilities: string[];
  canPrescribe: boolean;
  canViewAllRecords: boolean;
  canMessagePatient: boolean;

  addedAt: Date;
  addedBy: string;
  isActive: boolean;
}

interface ExternalProviderReference {
  npi: string;
  name: string;
  specialty: string;
  organization?: string;

  contactInfo: {
    phone?: string;
    fax?: string;
    directAddress?: string;
    email?: string;
  };

  role: string;
  notes?: string;

  lastContactedAt?: Date;
  invitedToPlat form: boolean;
}
```

#### Referral Workflow

```typescript
interface ProviderReferral {
  id: string;
  referringProviderId: string;
  referringProviderName: string;

  patientId: string;
  patientName: string;

  referralType: 'internal' | 'external_known' | 'external_search';

  targetProvider?: {
    providerId?: string;
    npi?: string;
    name: string;
    specialty: string;
    organization?: string;
    directAddress?: string;
  };

  targetSpecialty?: string;  // If searching for a provider

  referralDetails: {
    reason: string;
    urgency: 'routine' | 'soon' | 'urgent' | 'stat';
    clinicalQuestion: string;
    relevantHistory: string;

    attachedRecords: {
      type: 'lab' | 'imaging' | 'note' | 'prescription';
      recordId: string;
      description: string;
    }[];
  };

  appointmentPreferences?: {
    preferredDateRange?: { start: Date; end: Date };
    preferredTimeOfDay?: 'morning' | 'afternoon' | 'evening';
    specialNeeds?: string[];
  };

  status: 'draft' | 'pending_acceptance' | 'accepted' | 'scheduled' | 'completed' |
          'declined' | 'cancelled' | 'no_response';

  statusHistory: {
    status: string;
    changedAt: Date;
    changedBy: string;
    notes?: string;
  }[];

  responseFromTarget?: {
    respondedAt: Date;
    accepted: boolean;
    declineReason?: string;
    scheduledDate?: Date;
    notes?: string;
  };

  consultation?: {
    occurredAt: Date;
    consultNote?: string;
    recommendations?: string;
    followUpNeeded: boolean;
    followUpPlan?: string;
  };

  messageThreadId?: string;  // Linked discussion thread

  createdAt: Date;
  updatedAt: Date;
}
```

#### Provider-to-Provider Messaging UI

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ MESSAGES                                    [+ New Message] [+ New Referral]│
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│ 🔍 Search messages...                              Filter: All ▼            │
│                                                                              │
│ ─────────────────────────────────────────────────────────────────────────── │
│                                                                              │
│ UNREAD (3)                                                                   │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 🔴 Dr. Sarah Chen (Endocrinology)                          2 hours ago  │ │
│ │ Re: John Smith - Thyroid Management                                      │ │
│ │ "I've reviewed the labs. TSH is still elevated, recommend..."           │ │
│ │ Patient: John Smith (DOB: 01/15/1975)                                    │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 🔴 RPh Michael Torres (Platform Pharmacy)                  4 hours ago  │ │
│ │ Medication Interaction Question                                          │ │
│ │ "Noticed potential interaction between patient's new Rx..."             │ │
│ │ Patient: Maria Garcia                                                    │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ RECENT                                                                       │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ Dr. James Wilson (Primary Care)                            Yesterday    │ │
│ │ Referral Accepted: Jennifer Liu → Cardiology                            │ │
│ │ "Appointment scheduled for Feb 15. Will send consult note after."      │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ ─────────────────────────────────────────────────────────────────────────── │
│                                                                              │
│ PENDING REFERRALS (2)                                                        │
│ • Sarah M. → Dermatology (sent 3 days ago, no response)                    │
│ • Mike T. → Sleep Medicine (accepted, scheduling)                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### Message Composer

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ NEW MESSAGE                                                          [×]    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│ To:  [Dr. Sarah Chen, Endocrinology                              ▼]        │
│      [+ Add recipient]                                                       │
│                                                                              │
│ Patient: [John Smith (DOB: 01/15/1975)                           ▼]        │
│          [Link to patient record]                                            │
│                                                                              │
│ Subject: [Thyroid Management Follow-up                             ]        │
│                                                                              │
│ Urgency: ○ Routine  ● Soon  ○ Urgent  ○ STAT                               │
│                                                                              │
│ ─────────────────────────────────────────────────────────────────────────── │
│                                                                              │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ Hi Dr. Chen,                                                            │ │
│ │                                                                          │ │
│ │ Following up on our patient John Smith. His latest TSH came back        │ │
│ │ at 8.2 (ref 0.4-4.0). He's been on Levothyroxine 50mcg for 3 months.   │ │
│ │                                                                          │ │
│ │ Would you recommend increasing the dose, or should we investigate      │ │
│ │ further?                                                                 │ │
│ │                                                                          │ │
│ │ Best,                                                                    │ │
│ │ Dr. Martinez                                                             │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ Attach from patient record:                                                  │
│ ☑️ Latest labs (Feb 5, 2024)                                               │
│ ☐ Previous thyroid panel (Nov 2023)                                        │
│ ☐ Clinical notes                                                            │
│                                                                              │
│ ☐ Send via Direct Messaging (if recipient is external)                     │
│                                                                              │
│                                               [Save Draft]  [Send Message]  │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### Surescripts Clinical Direct Messaging Integration

For communication with external providers not on the platform:

```typescript
interface DirectMessagingConfig {
  enabled: boolean;
  directAddress: string;  // e.g., 'provider@direct.platform.com'

  inbound: {
    pollingInterval: 'every_5_minutes';
    autoAcknowledge: true;
    routingRules: DirectRoutingRule[];
  };

  outbound: {
    requireRecipientVerification: true;
    attachmentFormats: ['pdf', 'ccd', 'ccda'];
    maxAttachmentSize: '10MB';
  };
}

interface DirectRoutingRule {
  condition: 'by_patient_npi' | 'by_specialty' | 'by_content_type';
  matchValue: string;
  routeTo: 'care_team_primary' | 'specific_provider' | 'queue';
  notifyVia: ('in_app' | 'email' | 'sms')[];
}

const directMessagingFlow = {
  outbound: {
    steps: [
      'Provider composes message in platform',
      'System looks up recipient Direct address (NPI registry or manual entry)',
      'Message converted to CCDA format with attachments',
      'Sent via HISP (Health Information Service Provider)',
      'Track MDN (Message Disposition Notification) for delivery confirmation',
      'Update message status when MDN received'
    ]
  },
  inbound: {
    steps: [
      'HISP receives message for platform Direct address',
      'System polls HISP mailbox',
      'Parse CCDA, extract patient identifiers',
      'Match to patient record (or create placeholder)',
      'Route to appropriate provider based on rules',
      'Notify provider of new message',
      'Send MDN to confirm receipt'
    ]
  }
};
```

#### Care Coordination Dashboard

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ CARE TEAM: John Smith                                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│ PRIMARY CARE                                                                 │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ Dr. Maria Martinez (You)                               [Primary]        │ │
│ │ Internal Medicine · Platform Provider                                    │ │
│ │ Last visit: Feb 1, 2024                                                  │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ CARE TEAM                                                                    │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ Dr. Sarah Chen · Endocrinology                    [Message] [Referral]  │ │
│ │ Platform Provider · Active referral                                      │ │
│ │ Last note: "Recommend increasing Levo to 75mcg" (Feb 8)                 │ │
│ ├─────────────────────────────────────────────────────────────────────────┤ │
│ │ RPh Michael Torres · Clinical Pharmacist          [Message]             │ │
│ │ Platform Pharmacy                                                        │ │
│ │ Monitoring: Thyroid medications, GLP-1                                  │ │
│ ├─────────────────────────────────────────────────────────────────────────┤ │
│ │ Emma Wilson · Care Coordinator                    [Assign Task]         │ │
│ │ Platform Care Team                                                       │ │
│ │ Tracking: Adherence, appointment follow-up                              │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ EXTERNAL PROVIDERS (Not on platform)                                        │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ Dr. Robert Kim · Cardiology                       [Message via Direct] │ │
│ │ Mountain View Cardiology · NPI: 1234567890                              │ │
│ │ Direct Address: rkim@direct.mvcard.org                                  │ │
│ │ Last contact: Referral sent Jan 15 (no response)  [Resend] [Call]      │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ [+ Add Care Team Member]  [+ Add External Provider]  [Invite to Platform]  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### Shared Care Plan

```typescript
interface SharedCarePlan {
  id: string;
  patientId: string;

  carePlanType: 'chronic_disease' | 'post_acute' | 'behavioral_health' | 'weight_management' | 'custom';

  goals: SharedGoal[];
  tasks: SharedTask[];

  participants: {
    providerId: string;
    role: string;
    responsibilities: string[];
    canEdit: boolean;
  }[];

  visibility: 'care_team_only' | 'patient_visible' | 'patient_editable';

  status: 'active' | 'completed' | 'on_hold';
  reviewSchedule: 'weekly' | 'biweekly' | 'monthly' | 'quarterly';
  nextReviewDate: Date;

  discussionThreadId?: string;  // Linked message thread

  createdAt: Date;
  updatedAt: Date;
}

interface SharedGoal {
  id: string;
  description: string;
  targetDate?: Date;
  ownerId: string;  // Primary responsible provider
  status: 'not_started' | 'in_progress' | 'achieved' | 'not_achieved';
  progressNotes: { date: Date; note: string; authorId: string }[];
}

interface SharedTask {
  id: string;
  description: string;
  assignedTo: string;
  dueDate?: Date;
  status: 'pending' | 'in_progress' | 'completed' | 'cancelled';
  completedAt?: Date;
  completedBy?: string;
  notes?: string;
}
```

---

### Provider Platform Integrations

```typescript
const providerPlatformIntegrations = {
  clearinghouse: {
    primary: 'availity',
    config: {
      submitterId: process.env.AVAILITY_SUBMITTER_ID,
      apiKey: process.env.AVAILITY_API_KEY
    },
    supported: ['eligibility', 'claims', 'remittance', 'priorAuth']
  },

  prescribing: {
    provider: 'surescripts',
    features: ['newRx', 'refillRequest', 'cancelRx', 'rxHistory', 'pdmp']
  },

  labs: {
    integrations: [
      { name: 'quest', type: 'orders_and_results' },
      { name: 'labcorp', type: 'orders_and_results' },
      { name: 'generic_hl7', type: 'results_only' }
    ]
  },

  transcription: {
    provider: 'aws_transcribe_medical',
    backup: 'deepgram',
    features: ['realTime', 'speakerDiarization', 'medicalVocabulary']
  },

  fax: {
    provider: 'phaxio',
    useFor: ['priorAuth', 'referrals', 'medicalRecords']
  },

  videoConference: {
    provider: 'twilio',
    features: ['oneOnOne', 'group', 'screenShare', 'recording', 'waitingRoom']
  }
};
```

### Provider Practice Analytics Dashboard

Comprehensive analytics for providers to track their practice performance, patient outcomes, and prescribing patterns.

#### Practice Analytics Data Model

```typescript
interface ProviderPracticeAnalytics {
  providerId: string;
  generatedAt: Date;
  periodStart: Date;
  periodEnd: Date;

  summary: {
    totalPatients: number;
    activePatients: number;        // Seen in last 90 days
    newPatientsThisPeriod: number;
    totalConsultations: number;
    totalPrescriptions: number;
    averageRating: number;
  };

  consultationMetrics: ConsultationMetrics;
  prescribingMetrics: PrescribingMetrics;
  outcomeMetrics: OutcomeMetrics;
  patientPanelMetrics: PatientPanelMetrics;
  revenueMetrics: RevenueMetrics;
  benchmarkComparison: BenchmarkComparison;
}

interface ConsultationMetrics {
  totalConsultations: number;
  byType: {
    initial: number;
    followUp: number;
    urgent: number;
  };
  byModality: {
    video: number;
    phone: number;
    inPerson: number;
    async: number;
  };

  averageDuration: number;         // Minutes
  durationDistribution: {
    under15min: number;
    min15to30: number;
    min30to45: number;
    over45min: number;
  };

  utilizationRate: number;         // % of available slots filled
  noShowRate: number;
  cancellationRate: number;
  sameDayBookingRate: number;

  peakHours: { hour: number; count: number }[];
  peakDays: { day: string; count: number }[];

  averageWaitTime: number;         // Days from booking to appointment
  timeToFirstAppointment: number;  // For new patients
}

interface PrescribingMetrics {
  totalPrescriptions: number;
  newPrescriptions: number;
  refillsAuthorized: number;
  renewalsProcessed: number;

  byCategory: {
    category: string;
    count: number;
    percentage: number;
  }[];

  topMedications: {
    medicationName: string;
    count: number;
    averageDose: string;
  }[];

  doseDistributions: {
    medication: string;
    doses: { dose: string; count: number; percentage: number }[];
  }[];

  prescribingTrends: {
    month: string;
    totalRx: number;
    byCategory: Record<string, number>;
  }[];

  averagePrescriptionsPerVisit: number;

  controlledSubstanceMetrics?: {
    scheduleII: number;
    scheduleIII: number;
    scheduleIV: number;
    pdmpChecksPerformed: number;
  };

  interactionAlerts: {
    totalTriggered: number;
    overridden: number;
    overrideRate: number;
    bySeверяity: Record<string, number>;
  };
}

interface OutcomeMetrics {
  overallEffectiveness: {
    patientsWithOutcomes: number;
    averageRating: number;        // 1-5 scale
    ratingDistribution: Record<string, number>;
  };

  byTreatmentCategory: {
    category: string;
    patientCount: number;
    averageEffectiveness: number;
    averageTolerability: number;
    discontinuationRate: number;
    averageTreatmentDuration: number;
  }[];

  adherenceMetrics: {
    averageAdherence: number;
    patientsAbove80: number;
    patientsBelow50: number;
    adherenceByMedication: { medication: string; adherence: number }[];
  };

  sideEffectsSummary: {
    totalReports: number;
    bySeverity: Record<string, number>;
    topSymptoms: { symptom: string; count: number }[];
    escalatedToPharmacist: number;
  };

  patientSatisfaction: {
    npsScore: number;
    averageRating: number;
    totalReviews: number;
    recentFeedback: { rating: number; comment: string; date: Date }[];
  };
}

interface PatientPanelMetrics {
  totalActivePatients: number;

  byStatus: {
    active: number;
    needsFollowUp: number;
    overdue: number;
    inactive: number;
  };

  byTreatmentCategory: {
    category: string;
    count: number;
    avgAdherence: number;
  }[];

  atRiskPatients: {
    patientId: string;
    patientName: string;
    riskReason: 'low_adherence' | 'missed_followup' | 'side_effects' | 'no_refill';
    daysSinceLastContact: number;
    priority: 'high' | 'medium' | 'low';
  }[];

  upcomingFollowUps: {
    patientId: string;
    patientName: string;
    dueDate: Date;
    reason: string;
  }[];

  labsOverdue: {
    patientId: string;
    patientName: string;
    labType: string;
    daysPastDue: number;
  }[];

  patientRetention: {
    retainedPatients: number;
    lostPatients: number;
    retentionRate: number;
  };
}

interface RevenueMetrics {
  totalRevenue: number;
  revenueBySource: {
    consultations: number;
    prescriptions: number;  // If provider earns on Rx
    other: number;
  };

  consultationRevenue: {
    total: number;
    byType: Record<string, number>;
    averagePerConsult: number;
  };

  trend: {
    month: string;
    revenue: number;
    consultations: number;
  }[];

  // If commission/bonus structure
  bonusProgress?: {
    target: number;
    current: number;
    progressPercent: number;
    daysRemaining: number;
  };
}

interface BenchmarkComparison {
  comparedTo: 'platform_average' | 'specialty_average' | 'top_performers';

  metrics: {
    metricName: string;
    yourValue: number;
    benchmarkValue: number;
    percentile: number;
    trend: 'above' | 'at' | 'below';
  }[];

  strengths: string[];
  improvementAreas: string[];
}
```

#### Provider Analytics Dashboard UI

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ PRACTICE ANALYTICS                                  Dr. Maria Martinez, MD │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│ Period: [This Month ▼]    Compare to: [Last Month ▼]    [Export Report]    │
│                                                                              │
│ ═══════════════════════════════════════════════════════════════════════════ │
│                                                                              │
│ 📊 PRACTICE OVERVIEW                                                         │
│                                                                              │
│ ┌───────────────┬───────────────┬───────────────┬───────────────┐           │
│ │ CONSULTATIONS │ PRESCRIPTIONS │ ACTIVE PTS    │ SATISFACTION  │           │
│ │     127       │     98        │     342       │    4.8/5      │           │
│ │   ↑ 12%       │   ↑ 8%        │   ↑ 15        │   ↑ 0.2       │           │
│ └───────────────┴───────────────┴───────────────┴───────────────┘           │
│                                                                              │
│ ═══════════════════════════════════════════════════════════════════════════ │
│                                                                              │
│ ⏱️ CONSULTATION METRICS                                                      │
│ ┌─────────────────────────────────┬─────────────────────────────────────────┐
│ │ TYPE BREAKDOWN                  │ TIME METRICS                            │
│ │                                  │                                         │
│ │ Initial       ████░░░░░░ 35%    │ Avg Duration:      24 min              │
│ │ Follow-up     ██████░░░░ 58%    │ Utilization:       78%                 │
│ │ Urgent        █░░░░░░░░░  7%    │ No-show Rate:      4.2%                │
│ │                                  │ Avg Wait (days):   2.3                 │
│ └─────────────────────────────────┴─────────────────────────────────────────┘
│                                                                              │
│ 📈 VOLUME TREND                                                              │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 150 ┤                                            ●                       │ │
│ │ 125 ┤                              ●      ●                              │ │
│ │ 100 ┤        ●      ●      ●                                             │ │
│ │  75 ┤ ●                                                                  │ │
│ │  50 ┤                                                                    │ │
│ │     └──────────────────────────────────────────────────────────          │ │
│ │      Sep   Oct   Nov   Dec   Jan   Feb                                  │ │
│ │                                                                          │ │
│ │      ━━ Consultations  ━━ Prescriptions                                 │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ ═══════════════════════════════════════════════════════════════════════════ │
│                                                                              │
│ 💊 PRESCRIBING PATTERNS                                                      │
│ ┌─────────────────────────────────┬─────────────────────────────────────────┐
│ │ TOP MEDICATIONS                 │ BY CATEGORY                             │
│ │                                  │                                         │
│ │ 1. Semaglutide        34 (35%)  │ Weight Loss    ████████░░░░ 62%        │
│ │ 2. Testosterone Cyp   22 (22%)  │ Male HRT       ████░░░░░░░░ 28%        │
│ │ 3. Tirzepatide        15 (15%)  │ Female HRT     █░░░░░░░░░░░  7%        │
│ │ 4. Progesterone       8  (8%)   │ Other          █░░░░░░░░░░░  3%        │
│ │ 5. Estradiol          6  (6%)   │                                         │
│ └─────────────────────────────────┴─────────────────────────────────────────┘
│                                                                              │
│ DOSE DISTRIBUTION: Semaglutide                                              │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 0.25mg  ████░░░░░░░░ 18%  (Starting dose)                               │ │
│ │ 0.5mg   ██████░░░░░░ 32%                                                │ │
│ │ 1.0mg   ████████░░░░ 38%                                                │ │
│ │ 1.7mg   ██░░░░░░░░░░  9%                                                │ │
│ │ 2.4mg   █░░░░░░░░░░░  3%  (Max dose)                                    │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ ═══════════════════════════════════════════════════════════════════════════ │
│                                                                              │
│ 🎯 PATIENT OUTCOMES                                                          │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ TREATMENT EFFECTIVENESS BY CATEGORY                                      │ │
│ │                                                                          │ │
│ │ Category        Patients  Effectiveness  Tolerability  Adherence        │ │
│ │ ─────────────────────────────────────────────────────────────────────── │ │
│ │ Weight Loss     186       4.3/5 ⭐       3.8/5         78%              │ │
│ │ Male HRT        89        4.6/5 ⭐       4.4/5         85%              │ │
│ │ Female HRT      42        4.4/5 ⭐       4.1/5         82%              │ │
│ │ Thyroid         25        4.5/5 ⭐       4.5/5         91%              │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ SIDE EFFECTS REPORTED (This Period)                                         │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ Total: 23 reports · Mild: 15 · Moderate: 7 · Severe: 1                  │ │
│ │                                                                          │ │
│ │ Top: Nausea (12) · Fatigue (5) · Injection site (4) · Headache (2)     │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ ═══════════════════════════════════════════════════════════════════════════ │
│                                                                              │
│ ⚠️ PATIENT PANEL - ATTENTION NEEDED                                         │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 🔴 HIGH PRIORITY (3)                                                     │ │
│ │    • Sarah M. - Adherence 42% for 14 days         [View] [Message]      │ │
│ │    • John T. - Severe side effect reported        [View] [Call]         │ │
│ │    • Lisa R. - 30 days since last contact         [View] [Schedule]     │ │
│ │                                                                          │ │
│ │ 🟡 NEEDS FOLLOW-UP (8)                                                   │ │
│ │    • 5 patients overdue for check-in                                    │ │
│ │    • 3 patients with labs due                     [View All]            │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ ═══════════════════════════════════════════════════════════════════════════ │
│                                                                              │
│ 📊 BENCHMARK COMPARISON (vs Platform Average)                                │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ Metric               You      Platform   Percentile                     │ │
│ │ ─────────────────────────────────────────────────────────────────────── │ │
│ │ Patient Satisfaction 4.8      4.3        92nd       ████████████████░░ │ │
│ │ Adherence Rate       81%      74%        78th       ███████████████░░░ │ │
│ │ Consultation Volume  127      95         85th       ████████████████░░ │ │
│ │ Outcome Rating       4.4      4.1        75th       ██████████████░░░░ │ │
│ │ No-Show Rate         4.2%     6.1%       82nd       ████████████████░░ │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ 💡 INSIGHTS                                                                  │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ ✅ Strengths: Patient satisfaction, low no-show rate, high volume      │ │
│ │ 📈 Opportunities: Semaglutide adherence (78%) below specialty avg (83%)│ │
│ │ 💡 Suggestion: Consider more frequent check-ins for GLP-1 patients     │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### Provider Performance Alerts

```typescript
interface ProviderPerformanceAlert {
  providerId: string;
  alertType: 'achievement' | 'attention' | 'concern';

  triggers: {
    patientSatisfactionBelow4: boolean;
    noShowRateAbove10: boolean;
    adherenceBelow70: boolean;
    outcomeRatingBelow4: boolean;
    unusualPrescribingPattern: boolean;
    highSideEffectRate: boolean;
  };

  notifications: {
    sendToProvider: boolean;
    sendToMedicalDirector: boolean;
    frequency: 'immediate' | 'daily_digest' | 'weekly_summary';
  };
}

const providerAlertRules = [
  {
    name: 'High performer recognition',
    condition: 'satisfaction >= 4.8 AND adherence >= 85%',
    alertType: 'achievement',
    action: 'Send congratulations, consider for mentorship program'
  },
  {
    name: 'Adherence decline',
    condition: 'adherence dropped 10%+ month-over-month',
    alertType: 'attention',
    action: 'Review patient panel, suggest intervention strategies'
  },
  {
    name: 'Unusual prescribing pattern',
    condition: 'dose distribution significantly differs from peers',
    alertType: 'attention',
    action: 'Peer review, educational opportunity'
  },
  {
    name: 'Side effect spike',
    condition: 'side effect reports 2x above personal average',
    alertType: 'concern',
    action: 'Medical director review, quality investigation'
  }
];
```

---

### Provider Platform Feature Matrix

| Feature | MVP | Phase 2 | Phase 3 |
|---------|-----|---------|---------|
| **Clinical** | | | |
| SOAP charting | ✓ | | |
| Chart templates | ✓ | | |
| Care plans | | ✓ | |
| AI Scribe | | ✓ | |
| Drug interaction checks | | ✓ | |
| Lab result viewing | | ✓ | |
| **Operations** | | | |
| Scheduling | ✓ | | |
| Basic intake forms | ✓ | | |
| Custom forms builder | | ✓ | |
| Multi-provider support | | ✓ | |
| Workflow automations | | | ✓ |
| **Revenue Cycle** | | | |
| Cash billing | ✓ | | |
| Superbills | ✓ | | |
| Insurance eligibility | | ✓ | |
| Claims submission | | ✓ | |
| ERA processing | | ✓ | |
| Prior authorization | | | ✓ |
| Denial management | | | ✓ |
| **Patient Engagement** | | | |
| Video visits | ✓ | | |
| Secure messaging | ✓ | | |
| Patient portal | ✓ | | |
| Programs/group sessions | | | ✓ |
| Patient journaling | | | ✓ |
| **Analytics** | | | |
| Basic reports | ✓ | | |
| Financial dashboard | | ✓ | |
| Clinical outcomes | | | ✓ |

---

### External Provider Outreach & Onboarding

**Strategic Goal:** Allow patients to invite their existing doctors to the platform, making it easy for external providers to participate while eventually driving traffic to our own live doctor feature.

#### Growth Strategy

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    PATIENT ACQUISITION FUNNEL                                │
└─────────────────────────────────────────────────────────────────────────────┘

                         ┌─────────────────────┐
                         │   Patient Arrives   │
                         │   Interested in Rx  │
                         └──────────┬──────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    ▼                               ▼
        ┌───────────────────────┐     ┌───────────────────────┐
        │  "I have a doctor"    │     │  "Find me a doctor"   │
        │                       │     │                       │
        │  Invite My Doctor     │     │  Use Our Doctors      │
        │  (External Provider)  │     │  (Platform Provider)  │
        └───────────┬───────────┘     └───────────┬───────────┘
                    │                             │
                    ▼                             ▼
        ┌───────────────────────┐     ┌───────────────────────┐
        │  Provider Search      │     │  Immediate Booking    │
        │  Provider Invitation  │     │  Telemedicine Visit   │
        │  Provider Onboarding  │     │  Prescription         │
        └───────────┬───────────┘     └───────────┬───────────┘
                    │                             │
                    └───────────┬─────────────────┘
                                ▼
                    ┌───────────────────────┐
                    │  Patient Gets         │
                    │  Compounded Medication│
                    └───────────────────────┘

GOAL: Over time, demonstrate value of platform doctors
      → Faster appointments
      → AI-assisted consultations
      → Integrated experience
      → Convert "invite my doctor" patients to "use our doctors"
```

---

#### Provider Search Architecture

##### Data Sources

| Source | Data Available | Update Frequency | Cost |
|--------|----------------|------------------|------|
| **NPPES (NPI Registry)** | Name, NPI, specialty, practice address, credentials | Weekly | Free |
| **State Medical Boards** | License status, disciplinary actions | Varies | Varies |
| **DEA (NTIS)** | DEA number validation, schedules authorized | Real-time query | Per-query |
| **CMS PECOS** | Medicare enrollment status | Monthly | Free |
| **Specialty Boards** | Board certifications | Quarterly | Partnership |
| **Doximity API** | Enhanced profiles, photos, verified contact | Real-time | Partnership |
| **Healthgrades/Vitals** | Reviews, patient feedback | Daily | Partnership |

##### Provider Search Data Model

```typescript
interface ProviderSearchResult {
  // Core identifiers
  npi: string;
  firstName: string;
  lastName: string;
  middleName?: string;
  credentials: string[];  // MD, DO, NP, PA, etc.

  // Specialties
  primarySpecialty: string;
  secondarySpecialties: string[];
  taxonomyCodes: string[];

  // Practice info
  practices: PracticeLocation[];

  // Contact (if available)
  phone?: string;
  fax?: string;
  email?: string;  // Often not available publicly

  // Verification status
  licenseStatus: 'active' | 'inactive' | 'unknown';
  deaStatus?: 'active' | 'inactive' | 'unknown';
  boardCertified: boolean;

  // Platform status
  platformStatus: 'not_registered' | 'invited' | 'pending' | 'active';
  lastInvitedAt?: Date;
  invitedByPatientCount: number;

  // Enhanced data (if available from partners)
  photoUrl?: string;
  bio?: string;
  acceptingNewPatients?: boolean;
  languages?: string[];
  rating?: number;
  reviewCount?: number;
}

interface PracticeLocation {
  id: string;
  name: string;
  address: {
    street1: string;
    street2?: string;
    city: string;
    state: string;
    zipCode: string;
  };
  phone?: string;
  fax?: string;
  isPrimary: boolean;
}
```

##### NPPES Integration

```typescript
interface NPPESSearchParams {
  // Search by name
  firstName?: string;
  lastName?: string;

  // Search by NPI
  npi?: string;

  // Filters
  state?: string;
  city?: string;
  zipCode?: string;
  taxonomyCode?: string;  // Specialty

  // Pagination
  limit?: number;
  skip?: number;
}

// NPPES API wrapper
const searchNPPES = async (params: NPPESSearchParams): Promise<ProviderSearchResult[]> => {
  // NPPES API endpoint: https://npiregistry.cms.hhs.gov/api/
  const response = await fetch(
    `https://npiregistry.cms.hhs.gov/api/?version=2.1&${buildQueryString(params)}`
  );

  const data = await response.json();
  return data.results.map(mapNPPESToProviderResult);
};

// Common specialty taxonomy codes
const SpecialtyTaxonomyCodes = {
  'Family Medicine': '207Q00000X',
  'Internal Medicine': '207R00000X',
  'Endocrinology': '207RE0101X',
  'Urology': '208800000X',
  'OB/GYN': '207V00000X',
  'Psychiatry': '2084P0800X',
  'Nurse Practitioner': '363L00000X',
  'Physician Assistant': '363A00000X',
};
```

##### Provider Search UI

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  🔍 Find Your Doctor                                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Search by name, specialty, or location                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Dr. Sarah Williams                                          🔍      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐    │
│  │ Specialty ▼     │  │ Location ▼      │  │ Distance ▼              │    │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────┘    │
│                                                                             │
│  RESULTS (23 providers found)                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ ┌─────┐  Dr. Sarah Williams, MD                                     │   │
│  │ │ 👩‍⚕️ │  Endocrinology                              ⭐ 4.8 (142)   │   │
│  │ └─────┘  Intermountain Endocrine Clinic                             │   │
│  │          Salt Lake City, UT 84102                                   │   │
│  │          ✅ Accepting new patients  |  📍 2.3 miles                 │   │
│  │                                                     [Invite Doctor] │   │
│  │ ─────────────────────────────────────────────────────────────────── │   │
│  │ ┌─────┐  Dr. Sarah Williams, DO                                     │   │
│  │ │ 👩‍⚕️ │  Family Medicine                                           │   │
│  │ └─────┘  Mountain View Family Practice                              │   │
│  │          Provo, UT 84601                                            │   │
│  │          📍 45 miles                                                │   │
│  │                                                     [Invite Doctor] │   │
│  │ ─────────────────────────────────────────────────────────────────── │   │
│  │ ┌─────┐  Dr. Michael Chen, MD                    ✨ ON PLATFORM    │   │
│  │ │ 👨‍⚕️ │  Internal Medicine                        ⭐ 4.9 (89)      │   │
│  │ └─────┘  Already registered - Available today!                      │   │
│  │          Salt Lake City, UT 84101                                   │   │
│  │                                         [Book Appointment]          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  💡 Don't see your doctor? Enter their info manually:                      │
│     [+ Add Doctor Manually]                                                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

#### Provider Invitation System

##### Invitation Flow

```
Patient selects provider from search
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  INVITATION CONTEXT COLLECTION                                               │
│  ├── What medication are you interested in?                                  │
│  ├── Any relevant symptoms or conditions?                                    │
│  ├── Do you have an existing relationship with this doctor?                  │
│  └── Permission to share your AI consultation summary?                       │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  INVITATION CREATION                                                         │
│  ├── Generate unique invitation code                                         │
│  ├── Create provider invitation record                                       │
│  ├── Link patient's medication interest                                      │
│  └── Queue notification delivery                                             │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  MULTI-CHANNEL NOTIFICATION                                                  │
│  ├── Priority 1: Email (if available)                                        │
│  ├── Priority 2: Fax to practice (always available via NPPES)               │
│  ├── Priority 3: Physical mail (for high-value invitations)                 │
│  └── Follow-up: Automated reminder sequence                                  │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  PROVIDER ACTION                                                             │
│  ├── Click link → Quick signup (2 min)                                       │
│  ├── QR code → Mobile signup                                                 │
│  └── Call hotline → Assisted signup                                          │
└─────────────────────────────────────────────────────────────────────────────┘
```

##### Provider Invitation Data Model

```typescript
interface ProviderInvitation {
  id: string;

  // Provider being invited
  providerNpi: string;
  providerName: string;
  providerEmail?: string;
  providerFax?: string;
  practiceAddress: Address;

  // Inviting patient
  patientId: string;
  patientName: string;  // For personalization

  // Medication context
  medicationInterest: {
    drugName: string;
    category: 'weight_loss' | 'hormone_therapy' | 'peptides' | 'other';
    aiConsultationId?: string;
    sharedSymptoms?: string;  // Patient-approved summary
  };

  // Relationship
  existingPatient: boolean;
  relationshipDescription?: string;

  // Invitation tracking
  invitationCode: string;  // Unique 8-char code
  status:
    | 'pending'
    | 'sent'
    | 'delivered'
    | 'opened'
    | 'clicked'
    | 'registered'
    | 'declined'
    | 'expired';

  // Delivery tracking
  deliveryAttempts: DeliveryAttempt[];

  // Timestamps
  createdAt: Date;
  expiresAt: Date;  // 30 days default
  respondedAt?: Date;

  // Conversion
  convertedProviderId?: string;  // If they registered
}

interface DeliveryAttempt {
  channel: 'email' | 'fax' | 'mail' | 'sms';
  attemptedAt: Date;
  status: 'sent' | 'delivered' | 'failed' | 'bounced';
  deliveryId?: string;  // Email/fax service tracking ID
  errorMessage?: string;
}

// Track aggregate invitations per provider (for conversion prioritization)
interface ProviderInvitationAggregate {
  providerNpi: string;
  providerName: string;

  totalInvitations: number;
  uniquePatients: number;

  // Interest breakdown
  medicationInterests: {
    category: string;
    count: number;
  }[];

  // Status
  lastInvitedAt: Date;
  currentStatus: 'never_contacted' | 'invited' | 'multiple_invitations' | 'registered' | 'declined';

  // For prioritizing outreach
  conversionProbability: number;  // ML-scored based on specialty, volume, etc.
}
```

##### Invitation Content Templates

```typescript
// Email template for provider invitation
const providerInvitationEmail = {
  subject: 'Your patient {{patientName}} is interested in {{drugCategory}} treatment',

  body: `
Dear Dr. {{providerName}},

Your patient, {{patientName}}, has expressed interest in {{drugName}} through our
compounding pharmacy platform and has requested that you prescribe it.

**About the Request:**
- Medication: {{drugName}}
- Patient: {{patientName}} ({{patientRelationship}})
- Patient-provided context: {{symptomSummary}}

**What We Offer:**
- Free e-prescribing directly to our compounding pharmacy
- No cost to you or your practice
- Patient's medical intake already completed
- Drug interaction checking built-in
- EPCS-certified for controlled substances

**Quick Start (2 minutes):**
1. Click here to create your free account: {{signupLink}}
2. Or enter code: {{invitationCode}} at {{signupUrl}}
3. Or call us: 1-800-XXX-XXXX for assisted setup

**Your Patient is Waiting:**
Once you're set up, you can review {{patientName}}'s intake information and
prescribe directly through our secure platform.

Questions? Reply to this email or call our provider support line.

Best regards,
[Platform Name] Provider Success Team

---
This invitation expires in 30 days.
To opt out of future invitations, click here: {{optOutLink}}
  `,
};

// Fax template (more formal, includes QR code)
const providerInvitationFax = {
  header: '[PLATFORM NAME] - PATIENT MEDICATION REQUEST',

  content: `
ATTENTION: Dr. {{providerName}}
FROM: [Platform Name] Provider Relations
DATE: {{date}}
RE: Patient Medication Interest

Your patient {{patientName}} has expressed interest in {{drugName}} treatment
and has requested your involvement.

PROVIDER QUICK START:
━━━━━━━━━━━━━━━━━━━━
1. Scan QR Code: [QR CODE IMAGE]

   OR

2. Visit: {{signupUrl}}
   Code: {{invitationCode}}

   OR

3. Call: 1-800-XXX-XXXX

WHAT YOU GET (FREE):
• E-prescribing to our compounding pharmacy
• Patient intake completed
• Drug interaction checking
• HIPAA-compliant secure platform

PATIENT INFORMATION:
Name: {{patientName}}
Interest: {{drugName}} ({{drugCategory}})
Relationship: {{patientRelationship}}

━━━━━━━━━━━━━━━━━━━━
Questions? Call Provider Support: 1-800-XXX-XXXX
Email: providers@platform.com
  `,
};
```

##### Invitation Management UI (Patient Side)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  📤 Invite Dr. Sarah Williams                                      [Close] │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────┐  Dr. Sarah Williams, MD                                           │
│  │ 👩‍⚕️ │  Endocrinology                                                    │
│  └─────┘  Intermountain Endocrine Clinic                                   │
│           Salt Lake City, UT                                               │
│                                                                             │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│  What medication are you interested in?                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Semaglutide (GLP-1 for weight management)                       ▼  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  Is Dr. Williams already your doctor?                                      │
│  ○ Yes, I'm an existing patient                                            │
│  ○ No, I'd like to become a patient                                        │
│  ○ I've seen them before but not recently                                  │
│                                                                             │
│  Would you like to share your health summary with Dr. Williams?            │
│  This helps them understand your needs before you connect.                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ ☑️ Share my AI consultation summary                                 │   │
│  │    Includes: symptoms discussed, health goals, relevant history    │   │
│  │                                                                     │   │
│  │ ☑️ Share my current medications                                     │   │
│  │                                                                     │   │
│  │ ☐ Share my lab results                                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  Add a personal note (optional):                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Hi Dr. Williams, I've been trying to lose weight and would like    │   │
│  │ to discuss GLP-1 medications with you.                             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 📧 We'll notify Dr. Williams via email and fax                      │   │
│  │ ⏰ Most providers respond within 3-5 business days                  │   │
│  │ 🔔 We'll notify you when they respond                               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Send Invitation                                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  💡 Want faster access? Our platform doctors have appointments             │
│     available today. [See Available Doctors]                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

#### Frictionless Provider Onboarding

##### Onboarding Tiers

| Tier | Requirements | Time | Capabilities |
|------|--------------|------|--------------|
| **Quick Start** | NPI + Email + Password | 2 min | View patient request, basic prescribing |
| **Verified** | + License upload | 24 hr | Full e-prescribing, all medications |
| **EPCS Enabled** | + Identity proofing + 2FA | 3-5 days | Controlled substances |
| **Full Platform** | + Credentialing complete | 30-60 days | Employed/contracted provider |

##### Quick Start Onboarding Flow

```
Provider clicks invitation link
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 1: VERIFY IDENTITY (30 seconds)                                        │
│  ├── Auto-populated from NPPES: Name, NPI, Specialty                         │
│  ├── Confirm: "Is this you?"                                                 │
│  └── Enter: Email + Create password                                          │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 2: AGREE TO TERMS (30 seconds)                                         │
│  ├── BAA (Business Associate Agreement)                                      │
│  ├── Platform Terms of Service                                               │
│  └── E-Prescribing Agreement                                                 │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 3: SEE PATIENT REQUEST (immediate)                                     │
│  ├── Patient name and request details                                        │
│  ├── AI consultation summary (if shared)                                     │
│  └── Medication of interest                                                  │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 4: PRESCRIBE OR SCHEDULE                                               │
│  ├── Option A: Prescribe now (if enough info)                                │
│  ├── Option B: Schedule telemedicine visit                                   │
│  └── Option C: Request more information                                      │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  BACKGROUND: LICENSE VERIFICATION (parallel)                                 │
│  ├── Auto-verify via state board API (if available)                          │
│  ├── Or: Request license upload                                              │
│  └── Flag for credentialing team review                                      │
└─────────────────────────────────────────────────────────────────────────────┘
```

##### Provider Onboarding Data Model

```typescript
interface ProviderOnboarding {
  id: string;

  // Invitation context
  invitationId?: string;
  invitationCode?: string;

  // Provider basics (from NPPES or manual entry)
  npi: string;
  firstName: string;
  lastName: string;
  credentials: string[];
  primarySpecialty: string;

  // Account
  email: string;
  phone?: string;

  // Onboarding status
  status:
    | 'started'
    | 'email_verified'
    | 'quick_start_complete'
    | 'license_pending'
    | 'license_verified'
    | 'epcs_pending'
    | 'epcs_complete'
    | 'fully_credentialed';

  // Tier
  currentTier: 'quick_start' | 'verified' | 'epcs_enabled' | 'full_platform';

  // Agreements
  agreements: {
    baaSignedAt?: Date;
    tosSignedAt?: Date;
    ePrescribingSignedAt?: Date;
    epcsAgreementSignedAt?: Date;
  };

  // License verification
  licenses: ProviderLicense[];
  licenseVerificationStatus: 'pending' | 'auto_verified' | 'manual_review' | 'verified' | 'rejected';

  // DEA
  deaNumber?: string;
  deaVerificationStatus?: 'pending' | 'verified' | 'rejected';
  deaSchedules?: ('II' | 'III' | 'IV' | 'V')[];

  // EPCS enrollment
  epcsEnrollment?: {
    status: 'not_started' | 'idp_pending' | 'idp_complete' | 'active';
    identityProofingProvider?: 'idme' | 'experian';
    identityProofedAt?: Date;
    twoFactorMethod?: 'totp' | 'hardware_token';
  };

  // Conversion tracking
  convertedFromInvitation: boolean;
  invitingPatientId?: string;
  firstPrescriptionAt?: Date;

  // Timestamps
  startedAt: Date;
  completedAt?: Date;
}

interface ProviderLicense {
  state: string;
  licenseNumber: string;
  licenseType: 'MD' | 'DO' | 'NP' | 'PA' | 'PharmD';
  expirationDate: Date;

  // Verification
  verificationMethod: 'api' | 'manual' | 'document_upload';
  verificationStatus: 'pending' | 'verified' | 'rejected';
  verifiedAt?: Date;
  verifiedBy?: string;

  // Document
  documentUrl?: string;
  uploadedAt?: Date;
}
```

##### Quick Start Signup UI

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  🏥 Join [Platform Name] - Provider Quick Start                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Your patient {{patientName}} is waiting for you.                          │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  📋 PATIENT REQUEST                                                 │   │
│  │  ────────────────────────────────────────────────────────────────── │   │
│  │  Patient: Jane Doe                                                  │   │
│  │  Interested in: Semaglutide (GLP-1)                                │   │
│  │  Relationship: Existing patient                                    │   │
│  │                                                                     │   │
│  │  "I've been struggling with weight and would like to discuss       │   │
│  │   GLP-1 options with you."                                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│  STEP 1 OF 2: Confirm Your Identity                                        │
│                                                                             │
│  We found you in the NPI registry:                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  ✅ Dr. Sarah Williams, MD                                          │   │
│  │  NPI: 1234567890                                                    │   │
│  │  Specialty: Endocrinology                                          │   │
│  │  Intermountain Endocrine Clinic                                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│  ○ Yes, this is me                                                         │
│  ○ No, this isn't me (contact support)                                     │
│                                                                             │
│  Your email:                                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ dr.williams@intermountain.org                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  Create password:                                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ ••••••••••••                                                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│  ✅ 8+ characters  ✅ Number  ✅ Special character                        │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        Continue →                                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  Already have an account? [Log in]                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌─────────────────────────────────────────────────────────────────────────────┐
│  🏥 Join [Platform Name] - Provider Quick Start                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  STEP 2 OF 2: Review & Accept Agreements                                    │
│                                                                             │
│  ☑️ I agree to the Terms of Service                              [View]    │
│                                                                             │
│  ☑️ I agree to the Business Associate Agreement (BAA)            [View]    │
│     Required for HIPAA compliance                                          │
│                                                                             │
│  ☑️ I agree to the E-Prescribing Agreement                       [View]    │
│     I will only prescribe for patients under my care                       │
│                                                                             │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│  ⚡ You'll be able to:                                                      │
│  • View your patient's request immediately                                 │
│  • E-prescribe to our compounding pharmacy                                 │
│  • Access patient intake data they've shared                               │
│                                                                             │
│  📋 We'll verify your license in the background                            │
│  • Most licenses are verified within 24 hours                              │
│  • You can start reviewing patients immediately                            │
│                                                                             │
│  🔒 For controlled substances (EPCS):                                      │
│  • Additional identity verification required                               │
│  • Set up after account creation                                           │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │            Create Account & See Patient Request                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

#### External Provider Integration

##### Integration Levels

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    EXTERNAL PROVIDER INTEGRATION LEVELS                      │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  LEVEL 1: PLATFORM PRESCRIBING                                              │
│  ─────────────────────────────────────────────────────────────────────────  │
│  Provider logs into our platform to prescribe                               │
│  • Simplest integration                                                     │
│  • Provider uses our UI                                                     │
│  • Full access to patient intake data                                       │
│  • Best for providers with few patients on platform                        │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  LEVEL 2: INBOUND E-PRESCRIBING                                             │
│  ─────────────────────────────────────────────────────────────────────────  │
│  Provider prescribes from their own EHR via Surescripts                    │
│  • Provider stays in their workflow                                        │
│  • We receive NewRx via Surescripts                                        │
│  • Patient links Rx to their platform account                              │
│  • Limited access to platform features                                     │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  LEVEL 3: EHR INTEGRATION (Future)                                          │
│  ─────────────────────────────────────────────────────────────────────────  │
│  Deep integration with provider's EHR                                       │
│  • Patient data syncs to their EHR                                         │
│  • Embedded prescribing widget                                             │
│  • FHIR-based data exchange                                                │
│  • Requires EHR vendor partnership                                         │
└─────────────────────────────────────────────────────────────────────────────┘
```

##### Patient-Provider Connection Model

```typescript
interface PatientProviderConnection {
  id: string;

  // Patient
  patientId: string;

  // Provider (external or platform)
  providerId?: string;  // If registered on platform
  providerNpi: string;
  providerName: string;
  providerType: 'platform' | 'external_registered' | 'external_invited' | 'external_uncontacted';

  // Connection status
  status:
    | 'patient_requested'      // Patient invited provider
    | 'invitation_sent'        // Invitation delivered
    | 'provider_registered'    // Provider created account
    | 'provider_accepted'      // Provider accepted connection
    | 'active'                 // Active patient-provider relationship
    | 'inactive'               // No recent activity
    | 'terminated';            // Relationship ended

  // Invitation tracking
  invitationId?: string;
  invitedAt?: Date;

  // Data sharing permissions
  dataSharing: {
    shareIntakeData: boolean;
    shareAiConsultation: boolean;
    shareMedications: boolean;
    shareLabResults: boolean;
    shareOutcomes: boolean;
  };

  // Activity
  lastInteractionAt?: Date;
  prescriptionCount: number;
  appointmentCount: number;

  // Timestamps
  createdAt: Date;
  activatedAt?: Date;
}
```

##### External Provider Dashboard

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  👋 Welcome, Dr. Williams                        [Settings] [Help] [Logout] │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  ACCOUNT STATUS                                                     │   │
│  │  ────────────────────────────────────────────────────────────────── │   │
│  │  ✅ Account Active                                                  │   │
│  │  ✅ License Verified (UT, Exp: 2027-03-15)                          │   │
│  │  ⚠️ EPCS Not Enabled  [Set up now - prescribe controlled substances]│   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  PATIENT REQUESTS (2 pending)                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Patient      │ Medication      │ Status     │ Requested │ Action   │   │
│  │ ──────────────────────────────────────────────────────────────────  │   │
│  │ Jane Doe     │ Semaglutide     │ 🟡 New     │ Today     │ [Review] │   │
│  │ Bob Smith    │ Testosterone    │ 🟡 New     │ Yesterday │ [Review] │   │
│  │ Mary Wilson  │ Tirzepatide     │ ✅ Rx Sent │ Feb 5     │ [View]   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  QUICK ACTIONS                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐    │
│  │ + New Rx        │  │ 📅 Schedule     │  │ 📋 My Patients          │    │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────┘    │
│                                                                             │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│  💡 TIP: Set up EPCS to prescribe controlled substances like              │
│     Testosterone. It takes about 5 minutes.  [Learn More]                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

##### Patient Request Review (External Provider View)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  📋 Patient Request: Jane Doe                                      [Close] │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  PATIENT INFORMATION                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  Jane Doe                              DOB: 1985-03-15 (Age 40)     │   │
│  │  Existing patient                      Phone: (801) 555-0123        │   │
│  │                                                                     │   │
│  │  Interested in: Semaglutide (GLP-1 for weight management)          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  PATIENT'S AI CONSULTATION SUMMARY (shared with permission)                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  Chief Concern: Weight management                                   │   │
│  │                                                                     │   │
│  │  History:                                                           │   │
│  │  • Current weight: 195 lbs, Height: 5'4", BMI: 33.5               │   │
│  │  • Previous attempts: Tried diet/exercise, lost 20 lbs but         │   │
│  │    regained over 2 years                                           │   │
│  │  • No history of eating disorders                                  │   │
│  │  • No history of thyroid issues                                    │   │
│  │  • No family history of medullary thyroid cancer                   │   │
│  │                                                                     │   │
│  │  Current Medications:                                               │   │
│  │  • Metformin 500mg BID (type 2 diabetes)                           │   │
│  │  • Lisinopril 10mg daily (hypertension)                            │   │
│  │                                                                     │   │
│  │  Allergies: None reported                                          │   │
│  │                                                                     │   │
│  │  Goals: Lose 40+ lbs, reduce diabetes medications                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  PATIENT'S NOTE                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  "Hi Dr. Williams, I've been reading about GLP-1 medications and   │   │
│  │   think it could help me. I'd like to discuss this with you."      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  YOUR OPTIONS                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │ ○ Prescribe now                                                       │ │
│  │   Patient has provided enough information for you to prescribe       │ │
│  │                                                                       │ │
│  │ ○ Schedule a visit first                                              │ │
│  │   Conduct a telemedicine visit before prescribing                    │ │
│  │                                                                       │ │
│  │ ○ Request more information                                            │ │
│  │   Send a message or questionnaire to the patient                     │ │
│  │                                                                       │ │
│  │ ○ Decline request                                                     │ │
│  │   This medication is not appropriate for this patient                │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          Continue →                                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

#### Invitation Analytics & Optimization

##### Metrics Dashboard

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  📊 Provider Outreach Analytics                            [Last 30 Days ▼]│
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  FUNNEL METRICS                                                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│  │ Invitations │  │ Delivered   │  │ Registered  │  │ Prescribed  │       │
│  │    482      │→ │    423      │→ │    67       │→ │    41       │       │
│  │   sent      │  │   (88%)     │  │   (16%)     │  │   (61%)     │       │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘       │
│                                                                             │
│  CONVERSION BY CHANNEL                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Channel     │ Sent │ Delivered │ Clicked │ Registered │ Conv Rate  │   │
│  │ ──────────────────────────────────────────────────────────────────  │   │
│  │ Email       │ 312  │ 287       │ 89      │ 45         │ 14.4%      │   │
│  │ Fax         │ 423  │ 398       │ -       │ 22         │ 5.2%       │   │
│  │ Email+Fax   │ 312  │ -         │ -       │ 52         │ 16.7%      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  CONVERSION BY SPECIALTY                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Endocrinology      ████████████████████████  24% conversion         │   │
│  │ Family Medicine    ██████████████████  18% conversion               │   │
│  │ Internal Medicine  ████████████████  16% conversion                 │   │
│  │ OB/GYN             ████████████  12% conversion                     │   │
│  │ Urology            ████████████  12% conversion                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  HIGH-VALUE TARGETS (Multiple patient requests)                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Provider            │ Requests │ Specialty    │ Status     │ Action │   │
│  │ ──────────────────────────────────────────────────────────────────  │   │
│  │ Dr. James Peterson  │ 8        │ Endo         │ Invited x2 │ [Call] │   │
│  │ Dr. Maria Garcia    │ 6        │ Family Med   │ Invited x1 │ [Email]│   │
│  │ Dr. Robert Kim      │ 5        │ Internal Med │ Not yet    │ [Start]│   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

##### Automated Follow-up Sequences

```typescript
const providerFollowUpSequence = {
  // Initial invitation
  day0: {
    channels: ['email', 'fax'],
    template: 'initial_invitation',
  },

  // First follow-up
  day3: {
    condition: 'not_registered',
    channels: ['email'],
    template: 'follow_up_1',
    subject: 'Your patient {{patientName}} is still waiting',
  },

  // Second follow-up
  day7: {
    condition: 'not_registered',
    channels: ['email', 'fax'],
    template: 'follow_up_2',
    subject: 'Quick reminder: {{patientName}} medication request',
  },

  // High-value provider escalation
  day10: {
    condition: 'not_registered AND patient_requests >= 3',
    channels: ['phone_call'],
    action: 'assign_to_provider_success_team',
  },

  // Final attempt
  day21: {
    condition: 'not_registered',
    channels: ['email'],
    template: 'final_attempt',
    subject: 'Last chance: Help {{patientName}} get their medication',
  },

  // Expiration notice
  day28: {
    condition: 'not_registered',
    channels: ['email'],
    template: 'expiration_notice',
    subject: 'Your invitation expires in 2 days',
  },
};
```

---

#### Integration with Platform Doctors (Conversion Path)

##### Nudging Patients to Platform Doctors

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  ⏳ Waiting for Dr. Williams to respond...                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  We sent your invitation to Dr. Williams on February 5th.                  │
│  Most providers respond within 3-5 business days.                          │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  📊 INVITATION STATUS                                               │   │
│  │  ──────────────────────────────────────────────────────────────     │   │
│  │  ✅ Invitation sent (Feb 5)                                         │   │
│  │  ✅ Email delivered (Feb 5)                                         │   │
│  │  ✅ Fax delivered (Feb 5)                                           │   │
│  │  ⏳ Waiting for response...                                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│  💡 DON'T WANT TO WAIT?                                                    │
│                                                                             │
│  Our platform doctors have appointments available TODAY and specialize     │
│  in the medications you're interested in.                                  │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ ┌─────┐  Dr. Emily Chen, MD                    ⭐ 4.9 (234 reviews) │   │
│  │ │ 👩‍⚕️ │  Weight Management Specialist                               │   │
│  │ └─────┘  🟢 Available today at 2:00 PM, 4:30 PM                     │   │
│  │          ✅ GLP-1 certified  ✅ 500+ patients treated               │   │
│  │                                                                     │   │
│  │  "Dr. Chen was amazing. She took the time to explain everything    │   │
│  │   and I started seeing results within weeks." - Sarah M.           │   │
│  │                                                                     │   │
│  │                           [Book with Dr. Chen - $99]                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ ┌─────┐  Dr. Marcus Johnson, DO                ⭐ 4.8 (189 reviews) │   │
│  │ │ 👨‍⚕️ │  Internal Medicine / Metabolic Health                       │   │
│  │ └─────┘  🟢 Available today at 3:15 PM                              │   │
│  │          ✅ GLP-1 certified  ✅ 350+ patients treated               │   │
│  │                                                                     │   │
│  │                           [Book with Dr. Johnson - $99]             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│  [I'll wait for Dr. Williams] or [Cancel invitation]                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

##### Conversion Tracking

```typescript
interface PatientProviderJourney {
  patientId: string;

  // Initial path chosen
  initialPath: 'invite_own_doctor' | 'use_platform_doctor';

  // If invited own doctor
  invitedProviderId?: string;
  invitationSentAt?: Date;
  invitationRespondedAt?: Date;
  invitationOutcome?: 'registered' | 'declined' | 'expired' | 'converted_to_platform';

  // If converted to platform doctor
  convertedAt?: Date;
  conversionTrigger?:
    | 'invitation_expired'
    | 'chose_faster_option'
    | 'saw_platform_doctor_promo'
    | 'provider_declined';

  // Final provider
  finalProviderId: string;
  finalProviderType: 'platform' | 'external';

  // Outcome
  prescriptionReceived: boolean;
  prescriptionReceivedAt?: Date;

  // Time metrics
  timeToFirstPrescription?: number;  // Days from first visit to Rx
}
```

---

#### Summary: External Provider Outreach

| Component | Purpose | Status |
|-----------|---------|--------|
| **Provider Search** | NPI registry + enhanced data sources | ✅ Added |
| **Invitation System** | Multi-channel provider notifications | ✅ Added |
| **Quick Start Onboarding** | 2-minute provider signup | ✅ Added |
| **External Provider Dashboard** | Simplified UI for external providers | ✅ Added |
| **Patient-Provider Connection** | Link patients to their doctors | ✅ Added |
| **Conversion Analytics** | Track invitation → registration | ✅ Added |
| **Platform Doctor Nudging** | Convert waiting patients to platform doctors | ✅ Added |

---

## Operational Workflows

This section captures key operational decisions from gap analysis.

### Prescription Lifecycle

Every prescription (Rx) is a specific order from a doctor - not "permission to buy."

| Decision | Choice |
|----------|--------|
| Dose changes | New Rx each time (not modifications) |
| Refill model | Category-dependent check-in requirements |
| Self-service refills | Allowed if valid Rx with refills remaining |

#### Refill Policy by Drug Category

| Category | Check-in Required? | Max Refills | Notes |
|----------|-------------------|-------------|-------|
| Weight loss (GLP-1s) | Yes, every 90 days | 2 per Rx | Labs q6mo |
| HRT (testosterone) | Yes, every 90 days | 2 per Rx | Labs required |
| HRT (estrogen/prog) | Optional | 5 per Rx | Annual check-in |
| Thyroid | Optional | 5 per Rx | Labs q12mo |
| Sexual health | No | 5 per Rx | PRN use |
| General wellness | No | 11 per Rx | Low risk |

#### Self-Service Refill Flow

```
Patient requests refill
         │
         ▼
System checks:
• Rx still valid?
• Refills remaining?
• Labs current?
• Check-in needed?
         │
         ├── All clear → Self-checkout → Pharmacist review → Fulfill
         ├── Labs overdue → Soft block, prompt for labs
         ├── Check-in needed → Route to check-in flow
         └── No refills/expired → Route to provider visit
```

---

### Pharmacist Portal & Clinical Review

Every prescription requires pharmacist review before dispensing.

| Decision | Choice |
|----------|--------|
| Review authority | Pharmacist has final authority on all interactions |
| DUR (Drug Utilization Review) | Automated checks + pharmacist verification |
| Override capability | Pharmacist can override with documentation |

#### Pharmacist Queue

```
New Rx arrives
       │
       ▼
DUR Auto-Check (drug interactions, allergies, duplicates, dose range)
       │
       ├── All clear → Standard Queue
       └── Flags found → Flagged for Investigation
       │
       ▼
Pharmacist Reviews (patient profile, meds, labs, prescriber notes)
       │
       ├── [Approve] → Route to Fulfillment
       ├── [Clarify] → Hold Rx, Message prescriber
       └── [Reject] → Notify prescriber with reason
```

#### Pharmacist-Patient Communication

Direct communication channel between pharmacist and patient for prescription clarifications, counseling, and follow-up.

| Decision | Choice |
|----------|--------|
| Channels | In-app secure messaging, SMS (with consent), phone callback |
| Initiation | Pharmacist-initiated or patient question via portal |
| Response SLA | 4 hours during business hours |
| Escalation | To pharmacy director if unresolved after 24 hours |

##### Communication Data Model

```typescript
interface PharmacistPatientThread {
  id: string;
  pharmacyId: string;
  patientId: string;

  initiatedBy: 'pharmacist' | 'patient';
  initiatorId: string;

  relatedTo: {
    type: 'prescription' | 'order' | 'general' | 'adverse_event' | 'adherence';
    referenceId?: string;
    prescriptionId?: string;
    orderId?: string;
  };

  priority: 'routine' | 'urgent' | 'critical';
  status: 'open' | 'awaiting_patient' | 'awaiting_pharmacist' | 'resolved' | 'escalated';

  subject: string;
  category: 'clarification' | 'insurance' | 'side_effect' | 'dosing_question' | 'drug_interaction' |
            'substitution' | 'refill_issue' | 'shipping' | 'general_counseling';

  messages: PharmacistPatientMessage[];

  assignedPharmacistId?: string;
  lastMessageAt: Date;
  resolvedAt?: Date;
  resolutionSummary?: string;

  slaDeadline: Date;
  slaBreached: boolean;

  createdAt: Date;
  updatedAt: Date;
}

interface PharmacistPatientMessage {
  id: string;
  threadId: string;

  senderType: 'pharmacist' | 'patient' | 'system';
  senderId: string;
  senderName: string;

  content: string;
  contentType: 'text' | 'image' | 'document';
  attachments?: MessageAttachment[];

  deliveryChannel: 'in_app' | 'sms' | 'email';
  deliveryStatus: 'sent' | 'delivered' | 'read' | 'failed';

  isPhiSafe: boolean;  // Reviewed for PHI before SMS/email
  readAt?: Date;

  createdAt: Date;
}

interface MessageAttachment {
  id: string;
  fileName: string;
  fileType: string;
  fileSize: number;
  url: string;  // S3 presigned URL
  uploadedBy: string;
}
```

##### Pharmacist Outreach Triggers

```typescript
const pharmacistOutreachTriggers = [
  {
    trigger: 'prescription_clarification_needed',
    reason: 'Unclear directions, missing information, or potential error',
    priority: 'urgent',
    slaHours: 4,
    actions: ['in_app_message', 'sms_notification', 'hold_prescription']
  },
  {
    trigger: 'insurance_issue',
    reason: 'Prior auth required, coverage denied, or patient cost higher than expected',
    priority: 'routine',
    slaHours: 24,
    actions: ['in_app_message', 'sms_notification']
  },
  {
    trigger: 'drug_interaction_counseling',
    reason: 'New prescription has interaction with existing medication',
    priority: 'urgent',
    slaHours: 4,
    actions: ['in_app_message', 'request_phone_call']
  },
  {
    trigger: 'first_fill_counseling',
    reason: 'New medication requires patient education',
    priority: 'routine',
    slaHours: 24,
    actions: ['in_app_message', 'attach_education_materials']
  },
  {
    trigger: 'therapeutic_substitution',
    reason: 'Prescribed drug unavailable, equivalent available',
    priority: 'urgent',
    slaHours: 8,
    actions: ['in_app_message', 'sms_notification', 'request_approval']
  },
  {
    trigger: 'adverse_event_followup',
    reason: 'Patient reported side effect, pharmacist follow-up required',
    priority: 'critical',
    slaHours: 2,
    actions: ['in_app_message', 'request_phone_call', 'alert_prescriber']
  },
  {
    trigger: 'adherence_intervention',
    reason: 'Patient adherence dropped below 50% for 7+ days',
    priority: 'routine',
    slaHours: 24,
    actions: ['in_app_message', 'sms_outreach']
  }
];
```

##### Pharmacist Queue Interface

```
┌─────────────────────────────────────────────────────────────────────┐
│ PATIENT COMMUNICATIONS                          Filter: All Open ▼  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 🔴 CRITICAL (1)                                                     │
│ ┌─────────────────────────────────────────────────────────────────┐ │
│ │ Sarah M. · Adverse Event Follow-up · 45 min ago                 │ │
│ │ Reported severe nausea on Semaglutide 0.5mg                     │ │
│ │ [View Thread] [Request Call] [Alert Prescriber]                 │ │
│ └─────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│ ⚠️ URGENT (3)                                                       │
│ ┌─────────────────────────────────────────────────────────────────┐ │
│ │ Michael T. · Rx Clarification · 2 hrs ago · SLA: 2 hrs left     │ │
│ │ Testosterone dosage unclear - "as directed" needs specifics     │ │
│ │ Rx #12345 on hold pending clarification                         │ │
│ │ [View Thread] [Contact Patient] [Contact Prescriber]            │ │
│ └─────────────────────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────────────────────┐ │
│ │ Jennifer L. · Substitution Approval · 3 hrs ago                 │ │
│ │ Progesterone 100mg unavailable, 50mg x2 equivalent available    │ │
│ │ [View Thread] [Send Substitution Request]                       │ │
│ └─────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│ 📋 ROUTINE (12)                                                     │
│ ...                                                                  │
└─────────────────────────────────────────────────────────────────────┘
```

##### Patient Portal - Pharmacist Chat

```
┌─────────────────────────────────────────────────────────────────────┐
│ 💬 Messages                                      Ask a Pharmacist   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ ┌─────────────────────────────────────────────────────────────────┐ │
│ │ Rx #12345 - Semaglutide Question                    Yesterday   │ │
│ │ Pharmacist Sarah: "Your question about..."                      │ │
│ │ Status: ✅ Resolved                                              │ │
│ └─────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│ ┌─────────────────────────────────────────────────────────────────┐ │
│ │ Substitution Approval Needed                           Today    │ │
│ │ Your prescribed medication is temporarily unavailable...        │ │
│ │ Status: ⏳ Awaiting your response                                │ │
│ │ [View & Respond]                                                 │ │
│ └─────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│ ─────────────────────────────────────────────────────────────────── │
│                                                                      │
│ [+ New Question]                                                     │
│                                                                      │
│ Common Topics:                                                       │
│ • How do I take this medication?                                    │
│ • What are the side effects?                                        │
│ • Can I take this with my other medications?                        │
│ • I'm having a problem with my order                                │
└─────────────────────────────────────────────────────────────────────┘
```

##### SMS Communication (HIPAA-Compliant)

```typescript
const pharmacistSmsTemplates = {
  outreach_initial: {
    template: 'Hi {{firstName}}, this is {{pharmacistName}} from {{pharmacyName}}. We have a question about your recent prescription. Please check your secure messages in the app or call us at {{pharmacyPhone}}. Reply STOP to opt out.',
    requiresConsent: 'tier2',
    containsPhi: false
  },
  callback_request: {
    template: 'Hi {{firstName}}, a pharmacist would like to speak with you about your medication. Please call {{pharmacyPhone}} at your earliest convenience or reply with a good time to call.',
    requiresConsent: 'tier2',
    containsPhi: false
  },
  substitution_approval: {
    template: 'Hi {{firstName}}, we need your approval for a medication substitution. Please check your secure messages in the app to review and approve. Questions? Call {{pharmacyPhone}}.',
    requiresConsent: 'tier2',
    containsPhi: false
  }
};
```

##### Phone Callback System

```typescript
interface PhoneCallback {
  id: string;
  threadId: string;
  patientId: string;
  pharmacistId: string;

  requestedBy: 'pharmacist' | 'patient';
  requestedAt: Date;

  patientPhone: string;
  preferredTime?: {
    date: Date;
    timeSlot: 'morning' | 'afternoon' | 'evening';
  };

  status: 'requested' | 'scheduled' | 'attempted' | 'completed' | 'failed' | 'cancelled';

  attempts: CallAttempt[];
  maxAttempts: number;

  completedAt?: Date;
  callDuration?: number;
  callNotes?: string;
  callOutcome?: 'resolved' | 'follow_up_needed' | 'voicemail_left' | 'no_answer' | 'wrong_number';

  createdAt: Date;
}

interface CallAttempt {
  attemptNumber: number;
  attemptedAt: Date;
  pharmacistId: string;
  outcome: 'connected' | 'no_answer' | 'voicemail' | 'busy' | 'wrong_number';
  notes?: string;
}
```

---

### Dual Fulfillment Paths

Platform handles both compounded and boxed (manufactured) products.

```
Pharmacist Approves Rx
         │
         ▼
Fulfillment Router: Compounded or Boxed?
         │
         ├── BOXED PATH                    ├── COMPOUNDED PATH
         │   1. Check inventory            │   1. Generate batch record
         │   2. Pick from stock/BD Rowa    │   2. Queue for compounding
         │   3. Verify (scan)              │   3. Robot/tech compounds
         │   4. Label                      │   4. QC verification
         │   5. Stage for ship             │   5. QC approval
         │                                 │   6. Label
         │                                 │   7. Stage for ship
         │                                 │
         └─────────────┬───────────────────┘
                       ▼
              Shipping Queue
```

### Pharmacy Operations Dashboard

Comprehensive operational analytics for pharmacy managers and pharmacists.

#### Pharmacy Operations Data Model

```typescript
interface PharmacyOperationsDashboard {
  pharmacyId: string;
  generatedAt: Date;
  periodStart: Date;
  periodEnd: Date;

  volumeMetrics: VolumeMetrics;
  efficiencyMetrics: EfficiencyMetrics;
  qualityMetrics: QualityMetrics;
  inventoryMetrics: InventoryMetrics;
  staffMetrics: StaffMetrics;
  complianceMetrics: ComplianceMetrics;
}

interface VolumeMetrics {
  prescriptionsReceived: number;
  prescriptionsDispensed: number;
  prescriptionsPending: number;

  byType: {
    newRx: number;
    refills: number;
    transfers: number;
  };

  byFulfillmentPath: {
    compounded: number;
    boxed: number;
  };

  byCategory: {
    category: string;
    count: number;
    percentage: number;
  }[];

  trend: {
    date: string;
    received: number;
    dispensed: number;
  }[];

  peakHours: { hour: number; volume: number }[];
  peakDays: { day: string; volume: number }[];
}

interface EfficiencyMetrics {
  // Time-based metrics (in minutes unless specified)
  averageTurnaroundTime: {
    overall: number;
    byPath: {
      compounded: number;
      boxed: number;
    };
    byPriority: {
      standard: number;
      expedited: number;
      stat: number;
    };
  };

  stageBreakdown: {
    stageName: string;
    averageTime: number;
    minTime: number;
    maxTime: number;
    slaTarget: number;
    slaMet: number;        // Percentage
  }[];

  // Specific stage timing
  timeFromRxReceived: {
    toPharmacistReview: number;
    toApproval: number;
    toCompoundingStart: number;
    toQcComplete: number;
    toShipped: number;
  };

  queueMetrics: {
    currentQueueDepth: number;
    averageQueueWait: number;
    maxQueueWait: number;
    prescriptionsOverSla: number;
  };

  throughput: {
    rxPerHour: number;
    rxPerPharmacist: number;
    rxPerTech: number;
  };
}

interface QualityMetrics {
  // Pharmacist review metrics
  pharmacistReview: {
    totalReviewed: number;
    approved: number;
    sentForClarification: number;
    rejected: number;
    approvalRate: number;
    clarificationRate: number;
    rejectionRate: number;
    averageReviewTime: number;
  };

  // DUR metrics
  durAlerts: {
    totalTriggered: number;
    byType: {
      drugInteraction: number;
      allergy: number;
      duplicate: number;
      doseRange: number;
      contraindication: number;
    };
    overridden: number;
    overrideRate: number;
    overridesByPharmacist: Record<string, number>;
  };

  // QC metrics
  qualityControl: {
    batchesTested: number;
    passedFirstTime: number;
    failedFirstTime: number;
    firstPassYield: number;

    failureReasons: {
      reason: string;
      count: number;
      percentage: number;
    }[];

    reworked: number;
    destroyed: number;

    testingTime: {
      average: number;
      min: number;
      max: number;
    };
  };

  // Error tracking
  errors: {
    totalErrors: number;
    errorRate: number;         // Per 1000 Rx
    byType: {
      errorType: string;
      count: number;
      severity: 'minor' | 'moderate' | 'major';
    }[];
    nearMisses: number;
    reachedPatient: number;
  };

  // Adverse events
  adverseEvents: {
    reported: number;
    underInvestigation: number;
    linkedToBatch: number;
    medwatchSubmitted: number;
  };
}

interface InventoryMetrics {
  stockLevels: {
    itemId: string;
    itemName: string;
    category: string;
    currentStock: number;
    reorderPoint: number;
    status: 'in_stock' | 'low' | 'critical' | 'out_of_stock';
    daysUntilStockout: number;
    turnoverRate: number;      // Times per month
  }[];

  lowStockAlerts: number;
  outOfStockItems: number;
  overStockItems: number;

  expirations: {
    expiringIn30Days: number;
    expiringIn90Days: number;
    expired: number;
    expirationValue: number;   // Dollar value at risk
  };

  ordersSummary: {
    pendingOrders: number;
    inTransit: number;
    receivedThisPeriod: number;
    backordered: number;
  };

  costMetrics: {
    inventoryValue: number;
    costOfGoodsSold: number;
    shrinkage: number;
    wastePercent: number;
  };
}

interface StaffMetrics {
  staffing: {
    pharmacistsScheduled: number;
    pharmacistsPresent: number;
    techsScheduled: number;
    techsPresent: number;
  };

  productivity: {
    staffMember: string;
    role: 'pharmacist' | 'tech' | 'qc';
    rxProcessed: number;
    averageTimePerRx: number;
    errorCount: number;
    utilizationPercent: number;
  }[];

  workloadDistribution: {
    hour: number;
    pharmacistLoad: number;
    techLoad: number;
    optimal: boolean;
  }[];

  overtime: {
    totalHours: number;
    byStaff: Record<string, number>;
  };
}

interface ComplianceMetrics {
  pdmpChecks: {
    required: number;
    completed: number;
    complianceRate: number;
    flaggedPatients: number;
  };

  controlledSubstances: {
    dispensed: number;
    bySchedule: Record<string, number>;
    inventoryReconciled: boolean;
    lastReconciliationDate: Date;
    discrepancies: number;
  };

  temperatureExcursions: {
    total: number;
    byStorage: {
      refrigerator: number;
      freezer: number;
      ambient: number;
    };
    productAffected: number;
    productDestroyed: number;
  };

  auditReadiness: {
    missingDocumentation: number;
    expiredLicenses: number;
    overdueCalibrationsЖ number;
    openCAPAs: number;
  };
}
```

#### Pharmacy Operations Dashboard UI

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ PHARMACY OPERATIONS                                    Mountain View Rx     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│ 📅 Today: Feb 9, 2024                  Shift: Day (7am-3pm)     [Refresh]  │
│                                                                              │
│ ═══════════════════════════════════════════════════════════════════════════ │
│                                                                              │
│ 📊 REAL-TIME STATUS                                                          │
│                                                                              │
│ ┌───────────────┬───────────────┬───────────────┬───────────────┐           │
│ │ IN QUEUE      │ IN PROGRESS   │ READY TO SHIP │ SHIPPED TODAY │           │
│ │     47        │     12        │     23        │     89        │           │
│ │   ↑ 8         │  ⚠️ 3 overdue │               │   vs 95 avg   │           │
│ └───────────────┴───────────────┴───────────────┴───────────────┘           │
│                                                                              │
│ ⏱️ CURRENT WAIT TIMES                                                        │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ Pharmacist Review    ████████░░░░░░ 18 min (SLA: 30 min) ✅              │ │
│ │ Compounding Queue    ██████████████ 45 min (SLA: 60 min) ✅              │ │
│ │ QC Testing           ██████░░░░░░░░ 22 min (SLA: 45 min) ✅              │ │
│ │ Shipping Prep        ████░░░░░░░░░░ 12 min (SLA: 30 min) ✅              │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ ═══════════════════════════════════════════════════════════════════════════ │
│                                                                              │
│ 📈 TODAY'S PERFORMANCE                                                       │
│ ┌─────────────────────────────────┬─────────────────────────────────────────┐
│ │ VOLUME                          │ EFFICIENCY                              │
│ │                                  │                                         │
│ │ Received:     112               │ Avg Turnaround:   2.4 hrs              │
│ │ Dispensed:    89                │ First-Pass QC:    94%                  │
│ │ Pending:      47                │ Throughput:       11.2 Rx/hr           │
│ │ Rejected:     3                 │ SLA Compliance:   97%                  │
│ │                                  │                                         │
│ │ Compounded:   34 (38%)          │ ⚠️ 3 orders over SLA                   │
│ │ Boxed:        55 (62%)          │                                         │
│ └─────────────────────────────────┴─────────────────────────────────────────┘
│                                                                              │
│ ═══════════════════════════════════════════════════════════════════════════ │
│                                                                              │
│ 🔬 QUALITY METRICS                                                           │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ PHARMACIST REVIEW                    │ QC RESULTS                        │ │
│ │                                       │                                   │ │
│ │ Total Reviewed:     92               │ Batches Tested:    34            │ │
│ │ Approved:           87 (95%)         │ Passed 1st Time:   32 (94%)      │ │
│ │ Clarification:      4 (4%)           │ Rework Required:   2             │ │
│ │ Rejected:           1 (1%)           │ Destroyed:         0             │ │
│ │                                       │                                   │ │
│ │ Avg Review Time:    4.2 min          │ Avg QC Time:       18 min        │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ DUR ALERTS TODAY                                                             │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ Total: 23 alerts · Overridden: 8 (35%)                                  │ │
│ │                                                                          │ │
│ │ Drug Interaction: 12  │  Dose Range: 6  │  Allergy: 3  │  Duplicate: 2 │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ ═══════════════════════════════════════════════════════════════════════════ │
│                                                                              │
│ 👥 STAFF PRODUCTIVITY                                                        │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ Staff Member        Role          Rx Today    Avg Time    Utilization  │ │
│ │ ─────────────────────────────────────────────────────────────────────── │ │
│ │ Dr. Sarah Chen      Pharmacist    34          3.8 min     87%          │ │
│ │ Mike Torres         Pharmacist    28          4.5 min     76%          │ │
│ │ Emily Wang          Tech          42          N/A         92%          │ │
│ │ Jason Kim           Tech          38          N/A         84%          │ │
│ │ Lisa Park           QC Tech       34          18 min      89%          │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ ═══════════════════════════════════════════════════════════════════════════ │
│                                                                              │
│ ⚠️ ALERTS & ATTENTION                                                        │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 🔴 CRITICAL                                                              │ │
│ │    • Semaglutide 2mg stock: 3 units (reorder point: 10)    [Order Now] │ │
│ │                                                                          │ │
│ │ 🟡 WARNING                                                               │ │
│ │    • 3 orders over SLA (oldest: 4.5 hrs)                   [View Queue] │ │
│ │    • Refrigerator #2 temp: 9°C (range: 2-8°C)              [Check Now]  │ │
│ │    • 5 items expiring within 30 days ($1,240 value)        [Review]     │ │
│ │                                                                          │ │
│ │ 📋 COMPLIANCE                                                            │ │
│ │    • PDMP checks: 100% compliant today                                  │ │
│ │    • Controlled substance reconciliation due in 2 days      [Schedule]  │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ ═══════════════════════════════════════════════════════════════════════════ │
│                                                                              │
│ 📦 INVENTORY STATUS                                                          │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ Status          Items    Action                                         │ │
│ │ ─────────────────────────────────────────────────────────────────────── │ │
│ │ 🔴 Critical     3        Immediate reorder required                     │ │
│ │ 🟡 Low          12       Reorder within 48 hrs                          │ │
│ │ 🟢 Adequate     145      No action needed                               │ │
│ │ 🔵 Overstocked  8        Consider promotion/transfer                    │ │
│ │                                                                          │ │
│ │ [View Full Inventory] [Generate PO] [Expiration Report]                 │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### Pharmacy SLA Configuration

```typescript
interface PharmacySLAConfig {
  stages: {
    pharmacistReview: {
      targetMinutes: 30;
      warningMinutes: 20;
      escalationMinutes: 45;
    };
    compoundingQueue: {
      targetMinutes: 60;
      warningMinutes: 45;
      escalationMinutes: 90;
    };
    compoundingProcess: {
      targetMinutes: 120;
      warningMinutes: 90;
      escalationMinutes: 180;
    };
    qcTesting: {
      targetMinutes: 45;
      warningMinutes: 30;
      escalationMinutes: 60;
    };
    shippingPrep: {
      targetMinutes: 30;
      warningMinutes: 20;
      escalationMinutes: 45;
    };
  };

  overall: {
    standardTurnaround: {
      targetHours: 4;
      maxHours: 8;
    };
    expeditedTurnaround: {
      targetHours: 2;
      maxHours: 4;
    };
    statTurnaround: {
      targetMinutes: 60;
      maxMinutes: 120;
    };
  };

  escalations: {
    level1: { afterMinutes: 'warning'; notifyRole: 'shift_lead' };
    level2: { afterMinutes: 'escalation'; notifyRole: 'pharmacy_manager' };
    level3: { afterMinutes: 'escalation + 30'; notifyRole: 'pharmacy_director' };
  };
}
```

#### Quality Trend Analysis

```typescript
interface PharmacyQualityTrend {
  period: 'daily' | 'weekly' | 'monthly';

  trends: {
    date: string;
    firstPassYield: number;
    errorRate: number;
    slaCompliance: number;
    clarificationRate: number;
    durOverrideRate: number;
  }[];

  alerts: {
    metric: string;
    trend: 'improving' | 'stable' | 'declining';
    currentValue: number;
    previousValue: number;
    changePercent: number;
    actionRequired: boolean;
  }[];

  rootCauseAnalysis?: {
    topErrorCauses: { cause: string; count: number; trend: string }[];
    topQCFailures: { reason: string; count: number; trend: string }[];
    topClarificationReasons: { reason: string; count: number }[];
  };
}
```

---

### Lab Monitoring & Follow-Up

| Decision | Choice |
|----------|--------|
| Lab ordering | Both ORDER (Quest/LabCorp) and ACCEPT (patient upload) |
| At-home kits | Partner with existing (Everlywell) + white-label later |
| Blocking behavior | Soft block (warning, provider/pharmacist can override) |
| Review responsibility | Drug-dependent (provider or pharmacist) |
| Critical values | Pharmacist approval required |

#### Lab Review Matrix

| Drug Category | Normal Labs | Abnormal Labs | Critical Values |
|---------------|-------------|---------------|-----------------|
| GLP-1 (weight loss) | Auto-approve | Provider review | Pharmacist required |
| Testosterone | Provider review | Provider review | Pharmacist required |
| Estrogen/Prog | Auto-approve | Provider review | Pharmacist required |
| Thyroid | Auto-approve | Provider review | Pharmacist required |
| General wellness | Auto-approve | Auto-approve | Pharmacist required |

---

### Real-Time Provider Queue

| Decision | Choice |
|----------|--------|
| Assignment model | Auto-assign default + patient can choose specific provider |
| Priority | Tiered priority, providers can see and override |
| Load balancing | Continuity-first (same provider), then provider preference |
| Queue hours | Dynamic (based on provider availability) |
| Abandonment | Lose spot, 1 min cooldown, fair re-queue position |

#### Priority Tiers

| Tier | Name | Criteria |
|------|------|----------|
| 1 | Urgent Clinical | Adverse reaction, provider-flagged urgent |
| 2 | Employer Premium | Premium employer tier |
| 3 | Follow-up | Returning patient, has previous provider |
| 4 | Standard | Default |

---

### Emergency Escalation

| Decision | Choice |
|----------|--------|
| Critical emergencies | Show severity, encourage emergency path, allow dismiss |
| On-call alerts | Immediate alert for critical emergencies |
| Mandatory follow-up | Yes - provider must address if patient continues after crisis mention |
| Abuse detection | Track urgent pathway usage, flag after 5 occurrences |

#### Emergency Detection Flow

```
Patient input to AI
         │
         ▼
Emergency keyword detection (every message)
         │
         ▼
Match found → Show interstitial:
┌─────────────────────────────────────────┐
│  ⚠️  This sounds serious.              │
│                                         │
│  [🚨 CALL 911]           ← Prominent    │
│  [📞 Talk to Doctor Now] ← Urgent queue │
│                                         │
│  [Continue anyway]       ← De-emphasized│
└─────────────────────────────────────────┘
         │
         ▼
All choices logged, provider sees flag if patient continues
```

---

### Drug Interactions & Allergies

| Decision | Choice |
|----------|--------|
| Medication history | Both Surescripts + patient-reported, flag unverified |
| Interaction database | License own (FDB or DrugBank) |
| Override authority | Pharmacist final authority |
| Compound interactions | Build custom rules per compound (check ingredients + compound-level) |

#### Interaction Severity Response

| Severity | AI Response | Provider Response | Pharmacist Response |
|----------|-------------|-------------------|---------------------|
| Contraindicated | "Dangerous - talk to doctor" | Hard block, no override | Hard block, escalate |
| Severe | Warning, suggest alternative | Requires override + justification | Requires override + docs |
| Moderate | Informational | Warning, can proceed | Warning, verify with prescriber |
| Minor | No mention | No alert | Log only |

---

### Dose Range Checking

Clinical decision support for validating prescribed doses against therapeutic ranges.

| Decision | Choice |
|----------|--------|
| Data source | FDB (First Databank) or Lexicomp |
| Check timing | At prescribing + pharmacist review |
| Override authority | Provider can override with justification, pharmacist final approval |
| Scope | All medications including compounds |

#### Dose Range Data Model

```typescript
interface DrugDoseRange {
  id: string;
  drugId: string;                    // NDC or compound ID
  genericName: string;
  brandNames: string[];

  indications: IndicationDoseRange[];

  routeOfAdministration: 'oral' | 'injection' | 'topical' | 'sublingual' | 'transdermal' | 'inhaled' | 'rectal' | 'ophthalmic';

  specialPopulations: SpecialPopulationDose[];

  maxDailyDose: {
    amount: number;
    unit: string;
    source: string;
    lastUpdated: Date;
  };

  lethalDoseWarning?: {
    amount: number;
    unit: string;
    warningText: string;
  };

  dataSource: 'fdb' | 'lexicomp' | 'micromedex' | 'custom';
  lastVerified: Date;
  verifiedBy: string;
}

interface IndicationDoseRange {
  indicationCode: string;            // ICD-10
  indicationName: string;

  ageRanges: AgeBasedDose[];

  renalAdjustment?: RenalDoseAdjustment;
  hepaticAdjustment?: HepaticDoseAdjustment;

  titrationSchedule?: TitrationStep[];
}

interface AgeBasedDose {
  ageMin: number;                    // Years
  ageMax: number;
  weightBased: boolean;

  initialDose: {
    min: number;
    max: number;
    typical: number;
    unit: string;
    frequency: string;               // "once daily", "twice daily", "weekly"
  };

  maintenanceDose: {
    min: number;
    max: number;
    typical: number;
    unit: string;
    frequency: string;
  };

  maxSingleDose: {
    amount: number;
    unit: string;
  };

  maxDailyDose: {
    amount: number;
    unit: string;
  };

  weightBasedDosing?: {
    minMgPerKg: number;
    maxMgPerKg: number;
    typicalMgPerKg: number;
    maxTotalDose: number;
    unit: string;
  };
}

interface SpecialPopulationDose {
  population: 'pediatric' | 'geriatric' | 'pregnancy' | 'lactation' | 'renal_impairment' | 'hepatic_impairment';
  adjustmentType: 'reduce' | 'avoid' | 'contraindicated' | 'use_caution' | 'no_adjustment';
  adjustmentPercent?: number;        // e.g., -50 for 50% dose reduction
  maxDose?: { amount: number; unit: string };
  notes: string;
  source: string;
}

interface RenalDoseAdjustment {
  creatinineClearanceRanges: {
    gfrMin: number;
    gfrMax: number;
    adjustmentPercent: number;       // -25 = reduce by 25%
    intervalChange?: string;         // "extend to q12h"
    contraindicated: boolean;
  }[];
  dialysisGuidance?: string;
}

interface TitrationStep {
  stepNumber: number;
  dayStart: number;
  dose: { amount: number; unit: string; frequency: string };
  duration: string;
  notes?: string;
}
```

#### Dose Check Service

```typescript
interface DoseCheckService {
  validatePrescription: (params: {
    drugId: string;
    prescribedDose: { amount: number; unit: string; frequency: string };
    indication?: string;             // ICD-10
    patientAge: number;
    patientWeight?: number;          // kg
    patientSex: 'M' | 'F';
    renalFunction?: { creatinineClearance: number };
    hepaticFunction?: { childPughClass: 'A' | 'B' | 'C' };
    isPregnant?: boolean;
    isLactating?: boolean;
  }) => Promise<DoseCheckResult>;
}

interface DoseCheckResult {
  status: 'within_range' | 'below_range' | 'above_range' | 'critical_high' | 'unknown_drug';

  prescribedDose: { amount: number; unit: string; frequency: string };
  dailyDose: { amount: number; unit: string };

  recommendedRange: {
    min: { amount: number; unit: string; frequency: string };
    max: { amount: number; unit: string; frequency: string };
    typical: { amount: number; unit: string; frequency: string };
  };

  percentOfMaxDailyDose: number;     // e.g., 150 means 150% of max

  alerts: DoseAlert[];

  adjustmentRecommendations: {
    reason: string;
    suggestedDose: { amount: number; unit: string; frequency: string };
    source: string;
  }[];

  requiresOverride: boolean;
  overrideLevel: 'provider' | 'pharmacist' | 'blocked';
}

interface DoseAlert {
  alertId: string;
  severity: 'info' | 'warning' | 'critical' | 'blocked';
  alertType: 'above_max' | 'below_therapeutic' | 'titration_skip' | 'renal_adjustment_needed' |
             'hepatic_adjustment_needed' | 'age_adjustment_needed' | 'weight_based_exceeded' |
             'pregnancy_caution' | 'lethal_dose_proximity';
  message: string;
  clinicalDetails: string;
  source: string;
  recommendedAction: string;
}
```

#### Dose Check Integration Flow

```
Provider writes prescription
              │
              ▼
┌─────────────────────────────────────────────────────────────┐
│ DOSE CHECK ENGINE                                            │
│                                                              │
│ Drug: Semaglutide 2.4mg weekly                              │
│ Patient: 45yo F, 85kg, CrCl 62                              │
│ Indication: Obesity (E66.01)                                │
│                                                              │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ⚠️ WARNING: Dose exceeds titration schedule             │ │
│ │                                                          │ │
│ │ Prescribed: 2.4mg weekly (max dose)                     │ │
│ │ Expected:   0.25mg weekly (starting dose)               │ │
│ │                                                          │ │
│ │ Standard titration: 0.25mg → 0.5mg → 1.0mg → 1.7mg →   │ │
│ │                     2.4mg over 16-20 weeks              │ │
│ │                                                          │ │
│ │ [Override with Reason] [Adjust Dose] [View Protocol]    │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
              │
              ├── Override → Document reason, proceed
              ├── Adjust → Modify prescription
              └── Block (critical) → Cannot proceed
              │
              ▼
       Pharmacist Review
              │
              ▼
See override justification + independent dose check
```

#### Severity Levels & Actions

| Check Result | Severity | Provider Action | Pharmacist Action |
|--------------|----------|-----------------|-------------------|
| Within range | None | Proceed | Approve |
| 101-125% of max | Warning | Acknowledge | Verify indication |
| 126-150% of max | High warning | Override + justification | Call provider if no justification |
| 151-200% of max | Critical | Override + clinical rationale | Independent verification required |
| >200% of max | Blocked | Cannot proceed | Cannot approve, escalate |
| Below therapeutic | Info | Consider increase | Note in review |
| Titration violation | Warning | Override + reason | Verify patient history |
| Renal adjustment needed | High | Apply adjustment or override | Verify renal function |

#### Override Documentation

```typescript
interface DoseOverride {
  id: string;
  prescriptionId: string;
  alertId: string;

  overrideType: 'provider_initial' | 'pharmacist_confirmation';
  overriddenBy: string;
  role: 'provider' | 'pharmacist';

  prescribedDose: { amount: number; unit: string };
  recommendedMax: { amount: number; unit: string };
  percentAboveMax: number;

  clinicalJustification: string;
  justificationCategory: 'prior_tolerance' | 'specialist_recommendation' | 'patient_specific' |
                         'titration_in_progress' | 'therapeutic_failure_at_lower_dose' | 'other';

  supportingEvidence?: {
    priorPrescriptions?: string[];
    labResults?: string[];
    specialistNotes?: string;
  };

  pharmacistVerification?: {
    verifiedBy: string;
    verifiedAt: Date;
    agreed: boolean;
    notes?: string;
  };

  createdAt: Date;
}
```

#### Compound-Specific Dose Checking

For compounded medications without standard dosing data:

```typescript
interface CompoundDoseRule {
  compoundId: string;
  compoundName: string;

  activeIngredients: {
    ingredientId: string;
    ingredientName: string;
    concentrationRange: { min: number; max: number; unit: string };
    maxDailyExposure: { amount: number; unit: string };
    referenceSource: string;
  }[];

  indicationRules: {
    indication: string;
    typicalDose: string;
    maxDose: string;
    frequency: string;
    notes: string;
  }[];

  pharmacistReviewRequired: boolean;
  customRulesApplied: boolean;

  lastReviewedBy: string;
  lastReviewedAt: Date;
}
```

---

### State Licensing

| Decision | Choice |
|----------|--------|
| License verification | Manual by credentialing staff |
| Provider licensing | Multi-state expected |
| Expansion roadmap | Mountain → Coastal (CA, OR, WA) → East Coast |
| Traveling patients | Allow, ship to alternate addresses |

#### Expansion Phases

- **Phase 1 (Launch):** Utah, Arizona, Colorado, Idaho, Wyoming
- **Phase 2:** California, Oregon, Washington, Nevada
- **Phase 3:** Florida, Texas, New York, Pennsylvania, Georgia, North Carolina

---

### Employer Benefits

| Decision | Choice |
|----------|--------|
| Revenue model | Per-transaction subsidy + optional platform fee |
| Employee awareness | Transparent ("Your employer saves you $X") |
| Employer tiers | Yes - Basic, Plus, Premium with different coverage |
| Eligibility verification | All methods: email domain, eligibility file, SSO, API |
| Reporting | Aggregate utilization only (de-identified by default) |
| Billing cycle | Monthly in arrears |
| Contract terms | Annual commitment with monthly billing |

#### Employer Tier Structure

| Tier | Drug Categories | Consults | Labs | Subsidy | Annual Cap | Platform Fee |
|------|-----------------|----------|------|---------|------------|--------------|
| Basic | Weight loss only | 4/year | No | 25% | $500/employee | $0 |
| Plus | Weight loss + HRT | Unlimited | Yes | 50% | $2,000/employee | $2/employee/month |
| Premium | All categories | Unlimited | Yes | 75% | $5,000/employee | $5/employee/month |
| Enterprise | Custom | Custom | Custom | Custom | Custom | Custom |

#### Employer Data Model

```typescript
interface Employer {
  id: string;

  companyInfo: {
    legalName: string;
    dbaName?: string;
    taxId: string;               // EIN
    industry: string;
    employeeCount: number;
    employeeCountBand: '1-50' | '51-200' | '201-500' | '501-1000' | '1001-5000' | '5000+';
    headquarters: Address;
    statesOfOperation: string[];
  };

  contractDetails: {
    contractId: string;
    signedDate: Date;
    effectiveDate: Date;
    renewalDate: Date;
    termLengthMonths: number;
    autoRenew: boolean;

    tier: 'basic' | 'plus' | 'premium' | 'enterprise';

    customTerms?: {
      subsidyPercent: number;
      annualCapPerEmployee: number;
      platformFeePerEmployee: number;
      coveredCategories: string[];
      consultsPerYear: number | 'unlimited';
      labsIncluded: boolean;
    };

    minimumCommitment?: {
      type: 'employees' | 'spend';
      amount: number;
    };
  };

  eligibilityConfig: {
    verificationMethod: 'email_domain' | 'eligibility_file' | 'sso' | 'api' | 'manual';
    emailDomains?: string[];
    ssoConfig?: SSOConfiguration;
    apiConfig?: EligibilityAPIConfig;
    fileConfig?: EligibilityFileConfig;

    dependentCoverage: boolean;
    dependentTypes?: ('spouse' | 'domestic_partner' | 'child')[];
    childMaxAge?: number;            // Default 26

    waitingPeriodDays: number;       // Days from hire to eligibility
    cobraOffered: boolean;
    cobraDurationMonths?: number;
  };

  billing: {
    billingContactEmail: string;
    billingAddress: Address;
    paymentMethod: 'invoice' | 'ach' | 'credit_card';
    paymentTermsDays: number;        // Net 30, Net 45, etc.
    purchaseOrderRequired: boolean;
    taxExempt: boolean;
    taxExemptCertificate?: string;   // S3 URL
  };

  adminUsers: EmployerAdmin[];

  branding?: {
    logoUrl?: string;
    primaryColor?: string;
    welcomeMessage?: string;
  };

  status: 'prospect' | 'contracting' | 'implementing' | 'active' | 'suspended' | 'churned';

  implementationStatus?: {
    phase: 'kickoff' | 'configuration' | 'testing' | 'employee_comms' | 'go_live' | 'complete';
    kickoffDate?: Date;
    targetGoLiveDate?: Date;
    actualGoLiveDate?: Date;
    implementationManagerId?: string;
  };

  metrics: {
    totalEligibleEmployees: number;
    enrolledEmployees: number;
    activeUsersLast30Days: number;
    totalSpendToDate: number;
    totalSubsidyPaidToDate: number;
  };

  createdAt: Date;
  updatedAt: Date;
}

interface EmployerAdmin {
  userId: string;
  email: string;
  firstName: string;
  lastName: string;
  role: 'super_admin' | 'benefits_admin' | 'finance_admin' | 'readonly';
  permissions: EmployerAdminPermission[];
  invitedAt: Date;
  acceptedAt?: Date;
  lastLoginAt?: Date;
  mfaEnabled: boolean;
}

type EmployerAdminPermission =
  | 'manage_admins'
  | 'manage_eligibility'
  | 'view_employees'
  | 'manage_benefits_config'
  | 'view_reports'
  | 'export_reports'
  | 'view_invoices'
  | 'pay_invoices'
  | 'manage_api_keys'
  | 'send_employee_comms';
```

#### Employer Eligibility Management

Comprehensive system for managing employee eligibility across multiple verification methods.

##### Eligibility Data Model

```typescript
interface EmployeeEligibility {
  id: string;
  employerId: string;

  employeeIdentifier: {
    employeeId: string;          // Employer's internal ID
    email: string;
    ssn?: string;                // Last 4 only, encrypted
  };

  personalInfo: {
    firstName: string;
    lastName: string;
    dateOfBirth: Date;
    gender?: 'M' | 'F' | 'X';
  };

  employmentInfo: {
    hireDate: Date;
    terminationDate?: Date;
    employmentStatus: 'active' | 'leave' | 'terminated' | 'retired';
    employmentType: 'full_time' | 'part_time' | 'contractor';
    department?: string;
    location?: string;
    jobTitle?: string;
  };

  eligibilityStatus: 'pending_waiting_period' | 'eligible' | 'enrolled' | 'suspended' | 'terminated' | 'cobra';
  eligibilityEffectiveDate: Date;
  eligibilityEndDate?: Date;

  tier: 'basic' | 'plus' | 'premium' | 'enterprise';

  dependents?: EmployeeDependent[];

  linkedPatientId?: string;      // Link to patient record once enrolled
  enrolledAt?: Date;
  enrollmentMethod?: 'self_service' | 'sso_auto' | 'admin_manual';

  annualUsage: {
    year: number;
    subsidyUsed: number;
    capRemaining: number;
    consultsUsed: number;
  };

  source: 'file_upload' | 'api_sync' | 'sso' | 'manual' | 'self_enrollment';
  sourceRecordId?: string;
  lastSyncedAt?: Date;

  createdAt: Date;
  updatedAt: Date;
}

interface EmployeeDependent {
  id: string;
  relationship: 'spouse' | 'domestic_partner' | 'child';

  firstName: string;
  lastName: string;
  dateOfBirth: Date;
  gender?: 'M' | 'F' | 'X';

  eligibilityStatus: 'eligible' | 'enrolled' | 'aged_out' | 'terminated';
  eligibilityEffectiveDate: Date;
  eligibilityEndDate?: Date;

  linkedPatientId?: string;
  enrolledAt?: Date;

  createdAt: Date;
  updatedAt: Date;
}
```

##### Eligibility File Processing

```typescript
interface EligibilityFileConfig {
  fileFormat: 'csv' | 'xlsx' | 'fixed_width' | 'edi_834';
  deliveryMethod: 'sftp' | 'manual_upload' | 'api_push';

  sftp?: {
    host: string;
    port: number;
    username: string;
    directory: string;
    pgpEncrypted: boolean;
    pgpPublicKey?: string;
  };

  schedule: {
    frequency: 'daily' | 'weekly' | 'biweekly' | 'monthly' | 'on_demand';
    dayOfWeek?: number;          // 0-6 for weekly
    dayOfMonth?: number;         // 1-31 for monthly
    timeOfDay?: string;          // "02:00" UTC
  };

  fileSpec: {
    hasHeaderRow: boolean;
    delimiter?: string;          // For CSV
    encoding: 'utf8' | 'latin1';
    dateFormat: string;          // e.g., "MM/DD/YYYY"

    columnMappings: {
      employeeId: number | string;
      firstName: number | string;
      lastName: number | string;
      email: number | string;
      dateOfBirth: number | string;
      hireDate: number | string;
      terminationDate?: number | string;
      status: number | string;
      department?: number | string;
      location?: number | string;
      tier?: number | string;
      // Dependent columns if in same file
      dependentFirstName?: number | string;
      dependentLastName?: number | string;
      dependentDOB?: number | string;
      dependentRelationship?: number | string;
    };

    statusMappings: {
      active: string[];          // e.g., ["A", "Active", "1"]
      terminated: string[];
      leave: string[];
    };
  };

  processingRules: {
    addNewEmployees: boolean;
    terminateMissing: boolean;   // If not in file, terminate?
    updateExisting: boolean;
    terminationGraceDays: number; // Days after term before cutting access
  };
}

interface EligibilityFileUpload {
  id: string;
  employerId: string;

  fileName: string;
  fileSize: number;
  fileUrl: string;               // S3 URL

  uploadedBy: string;
  uploadedAt: Date;
  uploadMethod: 'sftp' | 'manual' | 'api';

  processingStatus: 'pending' | 'validating' | 'processing' | 'completed' | 'failed' | 'completed_with_errors';
  processingStartedAt?: Date;
  processingCompletedAt?: Date;

  summary: {
    totalRows: number;
    validRows: number;
    errorRows: number;

    employeesAdded: number;
    employeesUpdated: number;
    employeesTerminated: number;
    employeesUnchanged: number;

    dependentsAdded: number;
    dependentsUpdated: number;
    dependentsRemoved: number;
  };

  errors: EligibilityFileError[];

  createdAt: Date;
}

interface EligibilityFileError {
  rowNumber: number;
  employeeId?: string;
  errorType: 'missing_required' | 'invalid_format' | 'duplicate' | 'invalid_date' | 'unknown_status' | 'validation_failed';
  field: string;
  value?: string;
  message: string;
}
```

##### Eligibility File Processing Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ ELIGIBILITY FILE PROCESSING                                                  │
└─────────────────────────────────────────────────────────────────────────────┘

File Received (SFTP/Upload/API)
              │
              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ VALIDATION PHASE                                                             │
│                                                                              │
│ ✓ File format matches configuration                                         │
│ ✓ Required columns present                                                  │
│ ✓ Date formats valid                                                        │
│ ✓ No duplicate employee IDs                                                 │
│ ✓ Email format validation                                                   │
│ ✓ Status values recognized                                                  │
└─────────────────────────────────────────────────────────────────────────────┘
              │
              ├── Validation Errors → Generate error report, notify admin
              │
              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ PROCESSING PHASE                                                             │
│                                                                              │
│ For each row:                                                               │
│ ├── Employee exists?                                                        │
│ │   ├── Yes → Update if changed                                            │
│ │   └── No → Create new eligibility record                                 │
│ │                                                                           │
│ ├── Status = Terminated?                                                    │
│ │   └── Yes → Set termination date, start grace period                     │
│ │                                                                           │
│ └── Process dependents (if included)                                       │
│                                                                              │
│ If terminateMissing = true:                                                 │
│ └── Any existing employees NOT in file → Mark for termination              │
└─────────────────────────────────────────────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ POST-PROCESSING                                                              │
│                                                                              │
│ • Generate processing summary                                               │
│ • Send notification to employer admin                                       │
│ • Update employer metrics                                                   │
│ • Trigger welcome emails for new eligibles (if configured)                 │
│ • Log audit trail                                                           │
└─────────────────────────────────────────────────────────────────────────────┘
```

##### HRIS Integration (API-Based)

```typescript
interface HRISIntegration {
  employerId: string;

  provider: 'adp' | 'workday' | 'bamboohr' | 'gusto' | 'namely' | 'paylocity' | 'ultipro' | 'custom';

  connectionStatus: 'pending' | 'connected' | 'error' | 'disconnected';
  lastSyncAt?: Date;
  lastSyncStatus?: 'success' | 'partial' | 'failed';

  credentials: {
    apiKey?: string;             // Encrypted
    clientId?: string;
    clientSecret?: string;       // Encrypted
    accessToken?: string;        // Encrypted
    refreshToken?: string;       // Encrypted
    tokenExpiresAt?: Date;
  };

  syncConfig: {
    syncFrequency: 'realtime' | 'hourly' | 'daily';
    syncDirection: 'hris_to_platform' | 'bidirectional';

    fieldsToSync: {
      employeeId: boolean;
      email: boolean;
      name: boolean;
      dateOfBirth: boolean;
      hireDate: boolean;
      terminationDate: boolean;
      employmentStatus: boolean;
      department: boolean;
      location: boolean;
      dependents: boolean;
    };

    filterRules?: {
      employmentTypes: ('full_time' | 'part_time' | 'contractor')[];
      departments?: string[];
      locations?: string[];
      customFilter?: string;     // HRIS-specific filter expression
    };
  };

  webhookConfig?: {
    webhookUrl: string;
    webhookSecret: string;
    events: ('employee.created' | 'employee.updated' | 'employee.terminated')[];
  };
}

interface HRISSyncLog {
  id: string;
  employerId: string;
  integrationId: string;

  syncType: 'scheduled' | 'manual' | 'webhook';
  syncStartedAt: Date;
  syncCompletedAt?: Date;

  status: 'in_progress' | 'success' | 'partial' | 'failed';

  summary: {
    recordsProcessed: number;
    employeesAdded: number;
    employeesUpdated: number;
    employeesTerminated: number;
    errors: number;
  };

  errors?: {
    employeeId: string;
    error: string;
  }[];

  createdAt: Date;
}
```

##### SSO Integration

```typescript
interface SSOConfiguration {
  provider: 'okta' | 'azure_ad' | 'google_workspace' | 'onelogin' | 'ping' | 'saml_generic';

  samlConfig?: {
    entityId: string;
    ssoUrl: string;
    certificate: string;
    signatureAlgorithm: 'sha256' | 'sha512';
    nameIdFormat: 'email' | 'persistent' | 'unspecified';
  };

  oidcConfig?: {
    clientId: string;
    clientSecret: string;        // Encrypted
    issuerUrl: string;
    scopes: string[];
  };

  attributeMappings: {
    email: string;               // e.g., "email" or "http://schemas.xmlsoap.org/..."
    firstName: string;
    lastName: string;
    employeeId?: string;
    department?: string;
    groups?: string;
  };

  autoProvision: boolean;        // Create eligibility on first SSO login?
  autoDeprovision: boolean;      // Terminate on SSO deactivation?

  groupMappings?: {
    groupName: string;
    tier: 'basic' | 'plus' | 'premium';
  }[];
}

interface SSOLoginEvent {
  id: string;
  employerId: string;

  email: string;
  employeeId?: string;

  loginAt: Date;
  ipAddress: string;
  userAgent: string;

  outcome: 'success' | 'failed_no_eligibility' | 'failed_terminated' | 'failed_sso_error';

  autoProvisioned: boolean;
  eligibilityId?: string;
  patientId?: string;

  ssoProvider: string;
  ssoSessionId?: string;
}
```

##### Real-Time Eligibility Verification

```typescript
interface EligibilityVerificationService {
  verifyEligibility: (params: {
    employerId: string;
    email?: string;
    employeeId?: string;
    ssn4?: string;
    dateOfBirth?: Date;
  }) => Promise<EligibilityVerificationResult>;

  checkDependentEligibility: (params: {
    employeeEligibilityId: string;
    dependentInfo: {
      firstName: string;
      lastName: string;
      dateOfBirth: Date;
      relationship: 'spouse' | 'domestic_partner' | 'child';
    };
  }) => Promise<DependentEligibilityResult>;
}

interface EligibilityVerificationResult {
  verified: boolean;

  eligibility?: {
    employeeEligibilityId: string;
    employerId: string;
    employerName: string;
    tier: string;
    effectiveDate: Date;
    annualCapRemaining: number;
    consultsRemaining: number | 'unlimited';
    coveredCategories: string[];
    dependentCoverage: boolean;
  };

  denialReason?:
    | 'not_found'
    | 'terminated'
    | 'waiting_period'
    | 'suspended'
    | 'employer_inactive'
    | 'info_mismatch';

  nextSteps?: string;
}
```

#### Employer Billing & Invoicing

Comprehensive billing system for employer accounts.

##### Billing Data Model

```typescript
interface EmployerInvoice {
  id: string;
  invoiceNumber: string;         // e.g., "INV-2024-00123"
  employerId: string;

  billingPeriod: {
    startDate: Date;
    endDate: Date;
    description: string;         // e.g., "January 2024"
  };

  lineItems: InvoiceLineItem[];

  summary: {
    totalSubsidies: number;
    totalPlatformFees: number;
    totalAdjustments: number;
    subtotal: number;
    taxes: number;
    total: number;
  };

  employeeSummary: {
    eligibleCount: number;
    enrolledCount: number;
    activeUsersCount: number;
    usersWithClaimsCount: number;
  };

  status: 'draft' | 'pending' | 'sent' | 'viewed' | 'paid' | 'partial' | 'overdue' | 'disputed' | 'void';

  dueDate: Date;
  sentAt?: Date;
  viewedAt?: Date;

  payments: InvoicePayment[];
  amountPaid: number;
  amountDue: number;

  purchaseOrder?: string;
  notes?: string;

  pdfUrl?: string;               // Generated invoice PDF

  createdAt: Date;
  updatedAt: Date;
}

interface InvoiceLineItem {
  id: string;
  lineNumber: number;

  category: 'subsidy' | 'platform_fee' | 'adjustment' | 'credit' | 'other';
  description: string;

  quantity: number;
  unitPrice: number;
  amount: number;

  details?: {
    // For subsidy line items
    orderCount?: number;
    medicationCategory?: string;

    // For platform fee
    eligibleEmployeeCount?: number;

    // For adjustments
    adjustmentReason?: string;
    relatedInvoiceId?: string;
  };

  // For detailed drill-down (de-identified)
  transactions?: SubsidyTransaction[];
}

interface SubsidyTransaction {
  transactionId: string;
  date: Date;

  // De-identified
  employeeIdentifier: string;    // Hash or partial ID

  orderCategory: string;
  orderSubtotal: number;
  subsidyPercent: number;
  subsidyAmount: number;
  employeePaid: number;

  status: 'completed' | 'refunded' | 'adjusted';
}

interface InvoicePayment {
  id: string;
  invoiceId: string;

  paymentDate: Date;
  amount: number;

  paymentMethod: 'ach' | 'wire' | 'check' | 'credit_card';
  reference: string;             // Check number, transaction ID, etc.

  status: 'pending' | 'completed' | 'failed' | 'reversed';

  processedBy?: string;
  notes?: string;

  createdAt: Date;
}
```

##### Invoice Generation Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ MONTHLY INVOICE GENERATION (Runs 1st of each month)                          │
└─────────────────────────────────────────────────────────────────────────────┘

For each active employer:
              │
              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ AGGREGATE TRANSACTIONS                                                       │
│                                                                              │
│ • Query all completed orders for employer's employees                       │
│ • Calculate subsidy amounts applied                                         │
│ • Group by category (weight loss, HRT, other)                              │
│ • Calculate platform fees (PEPM × eligible employees)                       │
│ • Apply any pending credits or adjustments                                  │
└─────────────────────────────────────────────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ GENERATE INVOICE                                                             │
│                                                                              │
│ Line Items:                                                                  │
│ ├── Medication Subsidies - Weight Loss     $12,450.00                       │
│ │   (124 orders × avg $100.40 subsidy)                                      │
│ ├── Medication Subsidies - HRT              $3,200.00                       │
│ │   (32 orders × avg $100.00 subsidy)                                       │
│ ├── Platform Fee (Plus Tier)                $1,240.00                       │
│ │   (620 eligible employees × $2.00)                                        │
│ ├── Credit: Billing Error Correction         -$200.00                       │
│ │                                                                           │
│ Subtotal:                                  $16,690.00                       │
│ Tax:                                            $0.00                       │
│ Total Due:                                 $16,690.00                       │
└─────────────────────────────────────────────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ DELIVERY                                                                     │
│                                                                              │
│ • Generate PDF invoice                                                      │
│ • Email to billing contact                                                  │
│ • Post to employer portal                                                   │
│ • Set payment due date (Net 30)                                            │
│ • Schedule payment reminders                                                │
└─────────────────────────────────────────────────────────────────────────────┘
```

##### Billing Configuration Options

```typescript
interface EmployerBillingConfig {
  employerId: string;

  invoiceSettings: {
    billingCycle: 'monthly' | 'quarterly';
    invoiceDay: number;          // Day of month to generate
    paymentTermsDays: number;    // Net 30, 45, 60

    invoiceDelivery: ('email' | 'portal' | 'api_webhook')[];
    billingEmails: string[];

    currency: 'USD';

    includeTransactionDetail: boolean;
    detailLevel: 'summary' | 'category' | 'transaction';

    purchaseOrderRequired: boolean;
    defaultPurchaseOrder?: string;
  };

  paymentSettings: {
    acceptedMethods: ('ach' | 'wire' | 'check' | 'credit_card')[];

    achDetails?: {
      bankName: string;
      routingNumber: string;
      accountNumber: string;     // Encrypted
      accountType: 'checking' | 'savings';
    };

    autopayEnabled: boolean;
    autopayMethod?: 'ach' | 'credit_card';
    autopayDaysBefore?: number;  // Days before due date
  };

  taxSettings: {
    taxExempt: boolean;
    taxExemptCertificateUrl?: string;
    taxExemptExpiration?: Date;
    defaultTaxRate: number;
  };

  creditSettings: {
    creditLimit?: number;
    currentBalance: number;
    availableCredit: number;
  };
}
```

#### Employer Admin Portal

Comprehensive self-service portal for employer administrators.

##### Portal Dashboard

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ 🏢 ACME CORPORATION                                    Sarah Johnson (Admin)│
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│ [Dashboard] [Employees] [Eligibility] [Reports] [Billing] [Settings]       │
│                                                                              │
│ ═══════════════════════════════════════════════════════════════════════════ │
│                                                                              │
│ 📊 PROGRAM OVERVIEW                                     This Month | YTD ▼  │
│                                                                              │
│ ┌─────────────┬─────────────┬─────────────┬─────────────┐                   │
│ │ ELIGIBLE    │ ENROLLED    │ ACTIVE      │ UTILIZATION │                   │
│ │    620      │    412      │    187      │    30%      │                   │
│ │ employees   │ (66%)       │ (45% of     │ of enrolled │                   │
│ │             │             │ enrolled)   │             │                   │
│ └─────────────┴─────────────┴─────────────┴─────────────┘                   │
│                                                                              │
│ ┌─────────────────────────────────┬─────────────────────────────────────────┐
│ │ 💰 SPEND THIS MONTH             │ 📈 ENROLLMENT TREND                     │
│ │                                  │                                         │
│ │ Subsidies Paid:    $15,690      │   ▄▄▄                                  │
│ │ Platform Fees:      $1,240      │  ▄███▄                                 │
│ │ ──────────────────────────      │ ▄█████▄▄▄▄                             │
│ │ Total:             $16,930      │ █████████▄                             │
│ │                                  │ Jan Feb Mar Apr May                    │
│ │ vs Last Month:     +12% ↑       │                                         │
│ │ vs Budget:         -8% ✓        │ +15% enrollment growth                  │
│ └─────────────────────────────────┴─────────────────────────────────────────┘
│                                                                              │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 🔔 ACTION ITEMS                                                          │ │
│ │                                                                          │ │
│ │ ⚠️ Invoice #INV-2024-00089 due in 5 days ($16,690)          [Pay Now]   │ │
│ │ 📋 12 new employees added via SFTP sync today               [Review]    │ │
│ │ 📊 Monthly utilization report ready                         [Download]  │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ ┌───────────────────────────────────┬───────────────────────────────────────┐
│ │ TOP CATEGORIES                    │ QUICK ACTIONS                         │
│ │                                    │                                       │
│ │ Weight Loss     ████████░░ 68%    │ [+ Add Employee]                      │
│ │ HRT             ███░░░░░░░ 22%    │ [↑ Upload Eligibility File]           │
│ │ Other           █░░░░░░░░░ 10%    │ [📧 Send Enrollment Reminder]         │
│ │                                    │ [📄 Download Reports]                 │
│ └───────────────────────────────────┴───────────────────────────────────────┘
└─────────────────────────────────────────────────────────────────────────────┘
```

##### Employee Management Interface

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ EMPLOYEES                                                [+ Add] [↑ Upload] │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│ 🔍 Search employees...          Status: All ▼    Department: All ▼         │
│                                                                              │
│ ═══════════════════════════════════════════════════════════════════════════ │
│                                                                              │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ □  NAME              EMAIL                 STATUS      USAGE    ACTIONS │ │
│ ├─────────────────────────────────────────────────────────────────────────┤ │
│ │ □  John Smith        jsmith@acme.com       ✅ Enrolled  $450    [•••]   │ │
│ │    Emp ID: 10045 · Engineering · Hired: Jan 2022 · Tier: Plus           │ │
│ ├─────────────────────────────────────────────────────────────────────────┤ │
│ │ □  Maria Garcia      mgarcia@acme.com      ✅ Enrolled  $1,200  [•••]   │ │
│ │    Emp ID: 10089 · Sales · Hired: Mar 2021 · Tier: Plus                 │ │
│ │    + 2 dependents enrolled                                               │ │
│ ├─────────────────────────────────────────────────────────────────────────┤ │
│ │ □  Robert Chen       rchen@acme.com        ⏳ Eligible  --      [•••]   │ │
│ │    Emp ID: 10234 · Product · Hired: Feb 2024 · Tier: Plus               │ │
│ │    (Not yet enrolled - eligible since Mar 1)                            │ │
│ ├─────────────────────────────────────────────────────────────────────────┤ │
│ │ □  Lisa Thompson     lthompson@acme.com    🚫 Termed    $890    [•••]   │ │
│ │    Emp ID: 10012 · HR · Termed: Jan 15, 2024 · COBRA eligible           │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ Showing 1-20 of 620 employees                          [< Previous] [Next >]│
│                                                                              │
│ ─────────────────────────────────────────────────────────────────────────── │
│ Selected: 0  │  [Send Enrollment Email]  [Export Selected]  [Bulk Update]   │
└─────────────────────────────────────────────────────────────────────────────┘
```

##### Eligibility File Upload

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ UPLOAD ELIGIBILITY FILE                                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │                                                                          │ │
│ │                    📁 Drag and drop your file here                      │ │
│ │                                                                          │ │
│ │                         or [Browse Files]                               │ │
│ │                                                                          │ │
│ │              Accepted formats: CSV, XLSX (Max 10MB)                     │ │
│ │                                                                          │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ [Download Template]  [View Column Mapping]  [View Processing Rules]         │
│                                                                              │
│ ─────────────────────────────────────────────────────────────────────────── │
│                                                                              │
│ RECENT UPLOADS                                                               │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 📄 eligibility_feb_2024.csv                             Feb 1, 2024     │ │
│ │    ✅ Completed · 623 processed · 12 added · 3 terminated · 0 errors    │ │
│ │    [View Details] [Download Report]                                      │ │
│ ├─────────────────────────────────────────────────────────────────────────┤ │
│ │ 📄 eligibility_jan_2024.csv                             Jan 2, 2024     │ │
│ │    ⚠️ Completed with errors · 615 processed · 8 added · 2 errors        │ │
│ │    [View Details] [Download Error Report]                               │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ ─────────────────────────────────────────────────────────────────────────── │
│                                                                              │
│ AUTOMATED SYNC STATUS                                                        │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 🔄 SFTP Sync: Active                                                     │ │
│ │    Last sync: Today at 2:00 AM · Next sync: Tomorrow at 2:00 AM         │ │
│ │    [View Sync History] [Configure]                                       │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### Employee Benefit Experience

The employee-facing experience for discovering, enrolling in, and using employer benefits.

##### Benefit Discovery & Enrollment Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ EMPLOYEE ENROLLMENT FLOW                                                     │
└─────────────────────────────────────────────────────────────────────────────┘

Employee learns about benefit
(Email from HR / Benefits portal / Colleague)
              │
              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ LANDING PAGE                                                                 │
│                                                                              │
│ 🏥 Your Employer Health Benefit                                             │
│                                                                              │
│ ACME Corporation has partnered with us to provide you with                  │
│ affordable access to prescription medications and consultations.            │
│                                                                              │
│ ✓ Save up to 50% on weight loss medications                                │
│ ✓ Unlimited provider consultations included                                │
│ ✓ Lab work covered                                                          │
│                                                                              │
│ [Verify Your Eligibility]                                                    │
│                                                                              │
│ Already have an account? [Sign In]                                          │
└─────────────────────────────────────────────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ ELIGIBILITY VERIFICATION                                                     │
│                                                                              │
│ Verify your employment:                                                     │
│                                                                              │
│ Option A: [Sign in with Okta (ACME SSO)]                                   │
│                                                                              │
│ ─── OR ───                                                                  │
│                                                                              │
│ Option B: Enter your work email                                             │
│           [_________________________@acme.com]                              │
│                                                                              │
│           We'll send a verification link to confirm.                       │
│                                                                              │
│ [Continue]                                                                   │
└─────────────────────────────────────────────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ VERIFICATION SUCCESS                                                         │
│                                                                              │
│ ✅ Verified! Welcome, John.                                                 │
│                                                                              │
│ Your ACME Corporation benefits:                                             │
│                                                                              │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 💊 PLUS TIER                                                             │ │
│ │                                                                          │ │
│ │ • 50% off weight loss & HRT medications                                 │ │
│ │ • Unlimited provider consultations                                      │ │
│ │ • Lab work included                                                      │ │
│ │ • Up to $2,000/year in savings                                          │ │
│ │                                                                          │ │
│ │ Your employer pays: 50% of medication costs                             │ │
│ │ You pay: Remaining 50%                                                  │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ Would you like to add eligible dependents?                                  │
│ ○ Yes, I have a spouse/children to add                                     │
│ ● No, just me for now                                                       │
│                                                                              │
│ [Complete Enrollment]                                                        │
└─────────────────────────────────────────────────────────────────────────────┘
              │
              ▼
Employee completes standard patient registration
(with employer benefit automatically linked)
```

##### Subsidy Visibility in Patient Portal

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ ORDER SUMMARY                                                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│ Semaglutide 0.5mg/0.5mL (4-week supply)                                     │
│                                                                              │
│ Medication Cost                                         $425.00             │
│ Auto-Refill Discount (5%)                               -$21.25             │
│                                                        ─────────            │
│ Subtotal                                                $403.75             │
│                                                                              │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 🏢 EMPLOYER BENEFIT (ACME Corporation)                                   │ │
│ │                                                                          │ │
│ │ Your employer contributes 50%                        -$201.88            │ │
│ │                                                                          │ │
│ │ Annual benefit remaining: $1,798.12 of $2,000                           │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ Shipping                                                  FREE              │
│                                                        ─────────            │
│ YOUR TOTAL                                              $201.87             │
│                                                                              │
│ 💡 You're saving $223.13 on this order!                                    │
│                                                                              │
│ [Proceed to Payment]                                                         │
└─────────────────────────────────────────────────────────────────────────────┘
```

##### Employee Benefits Dashboard

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ MY EMPLOYER BENEFIT                                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│ 🏢 ACME Corporation · Plus Tier                                             │
│                                                                              │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ ANNUAL BENEFIT USAGE                                                     │ │
│ │                                                                          │ │
│ │ ████████████████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░ 45%               │ │
│ │                                                                          │ │
│ │ Used: $890.00          Remaining: $1,110.00          Cap: $2,000        │ │
│ │                                                                          │ │
│ │ Resets: January 1, 2025                                                 │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ WHAT'S COVERED                                                               │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ ✅ Weight Loss Medications                    50% off (employer pays)   │ │
│ │ ✅ Hormone Replacement Therapy                50% off (employer pays)   │ │
│ │ ✅ Provider Consultations                     Unlimited, no copay       │ │
│ │ ✅ Lab Work                                   Included                   │ │
│ │ ❌ Other Medications                          Not covered under plan    │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ MY DEPENDENTS                                                                │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ Lisa Smith (Spouse)                           ✅ Enrolled               │ │
│ │ Jake Smith (Child, age 16)                    ✅ Enrolled               │ │
│ │                                                                          │ │
│ │ [+ Add Dependent]                                                        │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ SAVINGS HISTORY                                                              │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ Feb 5    Semaglutide 0.5mg        Employer paid: $201.88   You: $201.87 │ │
│ │ Jan 8    Semaglutide 0.25mg       Employer paid: $188.12   You: $188.13 │ │
│ │ Jan 3    Provider Consultation    Employer paid: $75.00    You: $0.00   │ │
│ │ Dec 15   Lab Panel (Metabolic)    Employer paid: $125.00   You: $0.00   │ │
│ │                                                                          │ │
│ │ Total saved this year: $590.00                                          │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### Employer Reporting & Analytics

Comprehensive reporting suite for employer administrators.

##### Available Reports

```typescript
interface EmployerReportCatalog {
  enrollment: {
    enrollmentSummary: {
      description: 'Eligible vs enrolled employees over time';
      frequency: 'monthly';
      metrics: ['eligible_count', 'enrolled_count', 'enrollment_rate', 'new_enrollments', 'disenrollments'];
    };
    enrollmentByDepartment: {
      description: 'Enrollment breakdown by department/location';
      frequency: 'monthly';
      groupBy: ['department', 'location'];
    };
    enrollmentFunnel: {
      description: 'Conversion from eligible to active user';
      frequency: 'monthly';
      stages: ['eligible', 'enrolled', 'first_consultation', 'first_order', 'active_user'];
    };
  };

  utilization: {
    utilizationSummary: {
      description: 'Overall program usage metrics';
      frequency: 'monthly';
      metrics: ['active_users', 'orders_placed', 'consultations_completed', 'total_spend'];
    };
    utilizationByCategory: {
      description: 'Usage breakdown by medication category';
      frequency: 'monthly';
      categories: ['weight_loss', 'hrt', 'sexual_health', 'other'];
    };
    topMedications: {
      description: 'Most commonly ordered medications';
      frequency: 'monthly';
      deIdentified: true;
    };
  };

  financial: {
    spendSummary: {
      description: 'Total employer spend and employee savings';
      frequency: 'monthly';
      metrics: ['total_subsidies', 'platform_fees', 'employee_copays', 'total_savings'];
    };
    spendByCategory: {
      description: 'Spend breakdown by medication category';
      frequency: 'monthly';
    };
    budgetVsActual: {
      description: 'Projected vs actual spend';
      frequency: 'monthly';
    };
    roiAnalysis: {
      description: 'Return on investment calculation';
      frequency: 'quarterly';
      methodology: 'Compare to retail pharmacy costs';
    };
  };

  engagement: {
    engagementMetrics: {
      description: 'Patient engagement and adherence';
      frequency: 'monthly';
      metrics: ['active_rate', 'refill_rate', 'adherence_score', 'nps_score'];
    };
    programCompletion: {
      description: 'Completion rates for health programs';
      frequency: 'monthly';
    };
  };

  compliance: {
    hipaaAccess: {
      description: 'Audit log of data access';
      frequency: 'on_demand';
      forAuditPurposes: true;
    };
    eligibilityAudit: {
      description: 'Eligibility file processing audit trail';
      frequency: 'on_demand';
    };
  };
}
```

##### Reporting Dashboard

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ REPORTS & ANALYTICS                                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│ Date Range: [Last 12 Months ▼]   Compare to: [Previous Period ▼]           │
│                                                                              │
│ ═══════════════════════════════════════════════════════════════════════════ │
│                                                                              │
│ 📈 KEY METRICS                                                               │
│                                                                              │
│ ┌───────────────┬───────────────┬───────────────┬───────────────┐           │
│ │ ENROLLMENT    │ UTILIZATION   │ TOTAL SPEND   │ AVG SAVINGS   │           │
│ │    66%        │    45%        │   $142,500    │    $312       │           │
│ │  ↑ 8% vs LY   │  ↑ 12% vs LY  │  ↑ 22% vs LY  │  per employee │           │
│ └───────────────┴───────────────┴───────────────┴───────────────┘           │
│                                                                              │
│ ─────────────────────────────────────────────────────────────────────────── │
│                                                                              │
│ 📊 ENROLLMENT TREND                                                          │
│                                                                              │
│    Eligible ━━━    Enrolled ━━━    Active ━━━                               │
│                                                                              │
│ 700 ┤                                                                        │
│ 600 ┤━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│ 500 ┤                                                                        │
│ 400 ┤━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━                      │
│ 300 ┤                                                                        │
│ 200 ┤━━━━━━━━━━━━━━━━━━━━━━━━━                                               │
│ 100 ┤                                                                        │
│     └──────────────────────────────────────────────────────────────         │
│       Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct  Nov  Dec            │
│                                                                              │
│ ─────────────────────────────────────────────────────────────────────────── │
│                                                                              │
│ 📥 DOWNLOAD REPORTS                                                          │
│                                                                              │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ Report Name                     Last Generated    Format    Actions     │ │
│ ├─────────────────────────────────────────────────────────────────────────┤ │
│ │ Monthly Executive Summary       Feb 1, 2024       PDF       [↓] [📧]   │ │
│ │ Utilization Detail Report       Feb 1, 2024       Excel     [↓] [📧]   │ │
│ │ YTD Financial Summary           Feb 1, 2024       PDF       [↓] [📧]   │ │
│ │ ROI Analysis Q4 2023            Jan 15, 2024      PDF       [↓] [📧]   │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ [Schedule New Report]  [Create Custom Report]                                │
└─────────────────────────────────────────────────────────────────────────────┘
```

##### ROI Calculator

```typescript
interface ROICalculation {
  employerId: string;
  calculationPeriod: { start: Date; end: Date };

  inputs: {
    eligibleEmployees: number;
    enrolledEmployees: number;

    programCosts: {
      totalSubsidiesPaid: number;
      platformFees: number;
      implementationCosts: number;
      totalProgramCost: number;
    };

    comparison: {
      retailPharmacyCost: number;      // Estimated if employees paid retail
      traditionalBenefitCost?: number; // If replacing existing benefit
      productivityLossEstimate?: number;
    };
  };

  calculations: {
    employeeSavings: number;           // What employees saved vs retail
    employerCostPerEmployee: number;
    costPerActiveUser: number;

    vsRetailSavings: number;           // Total savings vs retail pharmacy
    vsRetailSavingsPercent: number;

    vsTraditionalSavings?: number;     // If replacing existing benefit

    impliedProductivityGain?: number;  // Based on health improvement estimates
  };

  roi: {
    totalInvestment: number;
    totalBenefit: number;
    netBenefit: number;
    roiPercent: number;
    paybackMonths: number;
  };

  benchmarks: {
    industryAverageEnrollment: number;
    industryAverageUtilization: number;
    industryAverageSavings: number;
    performanceVsBenchmark: 'above' | 'at' | 'below';
  };
}
```

#### Employer API Specification

RESTful API for programmatic employer integration.

```typescript
// Employer API Endpoints

interface EmployerAPI {
  // ═══════════════════════════════════════════════════════════════════════
  // ELIGIBILITY MANAGEMENT
  // ═══════════════════════════════════════════════════════════════════════

  // List employees
  'GET /api/v1/employers/{employerId}/employees': {
    query: {
      status?: 'eligible' | 'enrolled' | 'terminated';
      department?: string;
      search?: string;
      page?: number;
      limit?: number;
    };
    response: {
      employees: EmployeeEligibility[];
      pagination: { total: number; page: number; pages: number };
    };
  };

  // Get single employee
  'GET /api/v1/employers/{employerId}/employees/{employeeId}': {
    response: EmployeeEligibility;
  };

  // Add employee
  'POST /api/v1/employers/{employerId}/employees': {
    body: {
      employeeId: string;
      email: string;
      firstName: string;
      lastName: string;
      dateOfBirth: string;  // ISO 8601
      hireDate: string;
      department?: string;
      location?: string;
      tier?: 'basic' | 'plus' | 'premium';
      dependents?: {
        firstName: string;
        lastName: string;
        dateOfBirth: string;
        relationship: 'spouse' | 'domestic_partner' | 'child';
      }[];
    };
    response: EmployeeEligibility;
  };

  // Update employee
  'PUT /api/v1/employers/{employerId}/employees/{employeeId}': {
    body: Partial<EmployeeEligibility>;
    response: EmployeeEligibility;
  };

  // Terminate employee
  'DELETE /api/v1/employers/{employerId}/employees/{employeeId}': {
    body: {
      terminationDate: string;
      reason?: string;
      offerCobra?: boolean;
    };
    response: { success: boolean; cobraEligible: boolean };
  };

  // Bulk upload
  'POST /api/v1/employers/{employerId}/eligibility/upload': {
    body: {
      file: File;  // multipart/form-data
      fileFormat: 'csv' | 'xlsx';
      processingMode: 'validate_only' | 'process';
    };
    response: EligibilityFileUpload;
  };

  // Get upload status
  'GET /api/v1/employers/{employerId}/eligibility/uploads/{uploadId}': {
    response: EligibilityFileUpload;
  };

  // ═══════════════════════════════════════════════════════════════════════
  // REAL-TIME ELIGIBILITY VERIFICATION
  // ═══════════════════════════════════════════════════════════════════════

  'POST /api/v1/employers/{employerId}/eligibility/verify': {
    body: {
      email?: string;
      employeeId?: string;
      ssn4?: string;
      dateOfBirth?: string;
    };
    response: EligibilityVerificationResult;
  };

  // ═══════════════════════════════════════════════════════════════════════
  // REPORTING
  // ═══════════════════════════════════════════════════════════════════════

  // Get utilization summary
  'GET /api/v1/employers/{employerId}/reports/utilization': {
    query: {
      startDate: string;
      endDate: string;
      groupBy?: 'month' | 'quarter' | 'category';
    };
    response: UtilizationReport;
  };

  // Get enrollment summary
  'GET /api/v1/employers/{employerId}/reports/enrollment': {
    query: {
      startDate: string;
      endDate: string;
    };
    response: EnrollmentReport;
  };

  // Get spend summary
  'GET /api/v1/employers/{employerId}/reports/spend': {
    query: {
      startDate: string;
      endDate: string;
    };
    response: SpendReport;
  };

  // ═══════════════════════════════════════════════════════════════════════
  // BILLING
  // ═══════════════════════════════════════════════════════════════════════

  // List invoices
  'GET /api/v1/employers/{employerId}/invoices': {
    query: {
      status?: 'pending' | 'paid' | 'overdue';
      startDate?: string;
      endDate?: string;
    };
    response: { invoices: EmployerInvoice[] };
  };

  // Get invoice
  'GET /api/v1/employers/{employerId}/invoices/{invoiceId}': {
    response: EmployerInvoice;
  };

  // Get invoice PDF
  'GET /api/v1/employers/{employerId}/invoices/{invoiceId}/pdf': {
    response: Buffer;  // PDF file
  };

  // ═══════════════════════════════════════════════════════════════════════
  // WEBHOOKS
  // ═══════════════════════════════════════════════════════════════════════

  // Register webhook
  'POST /api/v1/employers/{employerId}/webhooks': {
    body: {
      url: string;
      events: WebhookEventType[];
      secret: string;
    };
    response: { webhookId: string };
  };

  // List webhooks
  'GET /api/v1/employers/{employerId}/webhooks': {
    response: { webhooks: WebhookConfig[] };
  };

  // Delete webhook
  'DELETE /api/v1/employers/{employerId}/webhooks/{webhookId}': {
    response: { success: boolean };
  };
}

type WebhookEventType =
  | 'employee.enrolled'
  | 'employee.terminated'
  | 'order.placed'
  | 'order.completed'
  | 'subsidy.applied'
  | 'invoice.generated'
  | 'invoice.paid'
  | 'cap.warning'        // Employee approaching annual cap
  | 'cap.reached';       // Employee reached annual cap

interface WebhookPayload {
  event: WebhookEventType;
  timestamp: string;
  employerId: string;
  data: unknown;
  signature: string;     // HMAC-SHA256 of payload
}
```

##### API Authentication

```typescript
interface EmployerAPIAuth {
  // API keys for employer
  apiKeys: {
    keyId: string;
    keySecret: string;           // Shown once at creation
    keyPrefix: string;           // First 8 chars for identification
    name: string;
    permissions: EmployerAdminPermission[];
    createdBy: string;
    createdAt: Date;
    lastUsedAt?: Date;
    expiresAt?: Date;
    status: 'active' | 'revoked';
  }[];

  // Rate limits
  rateLimits: {
    requestsPerMinute: 100;
    requestsPerDay: 10000;
    bulkUploadPerDay: 10;
  };
}

// Authentication header
// Authorization: Bearer emp_live_xxxxxxxxxxxx
```

#### Employer Compliance & Legal

##### HIPAA Considerations

```typescript
interface EmployerHIPAACompliance {
  // What employers CAN see (de-identified/aggregate)
  allowedData: {
    enrollmentCounts: true;
    utilizationRates: true;        // % of employees using benefit
    categoryBreakdown: true;       // Weight loss vs HRT usage %
    totalSpend: true;
    averageSavings: true;
    adherenceScores: true;         // Aggregate only
    satisfactionScores: true;
  };

  // What employers CANNOT see (PHI)
  restrictedData: {
    individualMedications: false;
    individualDiagnoses: false;
    individualHealthData: false;
    providerNotes: false;
    labResults: false;
    appointmentDetails: false;
  };

  // Employee-level data employers CAN see
  employeeLevelAllowed: {
    eligibilityStatus: true;
    enrollmentStatus: true;
    subsidyAmountUsed: true;       // Aggregate $ only
    capRemaining: true;
  };

  // Audit requirements
  auditLog: {
    logAllDataAccess: true;
    retentionYears: 6;
    accessibleToEmployee: true;    // Employees can see who accessed their data
  };
}
```

##### Business Associate Agreement

```typescript
interface EmployerBAA {
  templateVersion: string;

  requiredProvisions: {
    permittedUses: string[];
    prohibitedUses: string[];
    safeguards: string[];
    breachNotification: {
      timeframeHours: 72;
      notificationMethod: 'email' | 'certified_mail';
    };
    subcontractorRequirements: string;
    returnOrDestruction: string;
    auditRights: string;
  };

  signatures: {
    platformSignature: {
      name: string;
      title: string;
      date: Date;
    };
    employerSignature: {
      name: string;
      title: string;
      date: Date;
    };
  };

  effectiveDate: Date;
  expirationDate?: Date;

  documentUrl: string;            // Signed PDF in S3
}
```

##### ERISA Considerations (Self-Funded Plans)

```typescript
interface ERISACompliance {
  // If employer is self-funded, additional requirements apply
  planType: 'fully_insured' | 'self_funded' | 'level_funded' | 'not_erisa';

  selfFundedRequirements?: {
    planDocument: {
      required: true;
      templateProvided: true;
      mustInclude: [
        'Eligibility requirements',
        'Covered services',
        'Exclusions',
        'Claims procedures',
        'Appeal rights',
        'COBRA rights',
        'Fiduciary responsibilities'
      ];
    };

    summaryPlanDescription: {
      required: true;
      templateProvided: true;
      distributionMethod: 'email' | 'portal' | 'mail';
    };

    form5500: {
      required: boolean;           // Depends on plan size
      dataProvided: boolean;       // Platform provides utilization data
    };

    fiduciary: {
      employerIsFiduciary: true;
      platformRole: 'service_provider';  // Not a fiduciary
    };
  };
}
```

#### Employer Onboarding & Implementation

##### Implementation Timeline

```typescript
interface EmployerImplementation {
  employerId: string;

  phases: {
    kickoff: {
      targetDays: 1;
      activities: [
        'Contract signed',
        'Implementation manager assigned',
        'Kickoff call scheduled',
        'Access to employer portal granted'
      ];
    };

    configuration: {
      targetDays: 5;
      activities: [
        'Tier and benefits configured',
        'Eligibility verification method chosen',
        'Branding uploaded (logo, colors)',
        'Admin users created',
        'Billing information entered',
        'SSO integration configured (if applicable)'
      ];
    };

    eligibilitySetup: {
      targetDays: 10;
      activities: [
        'File format mapped (if file-based)',
        'SFTP credentials provided (if SFTP)',
        'HRIS connection established (if API)',
        'Test file processed',
        'Eligibility data validated'
      ];
    };

    testing: {
      targetDays: 5;
      activities: [
        'Admin portal walkthrough',
        'Test employee enrollment',
        'Test order with subsidy',
        'Report generation test',
        'SSO testing (if applicable)'
      ];
    };

    employeeCommunications: {
      targetDays: 10;
      activities: [
        'Communication plan created',
        'Email templates customized',
        'Launch date announced',
        'Benefits portal updated',
        'Manager talking points distributed'
      ];
    };

    goLive: {
      targetDays: 1;
      activities: [
        'Eligibility file loaded (full)',
        'Benefit activated',
        'Welcome emails sent',
        'Support team briefed'
      ];
    };
  };

  totalTargetDays: 32;

  milestones: {
    date: Date;
    milestone: string;
    status: 'pending' | 'in_progress' | 'completed' | 'delayed';
    owner: 'employer' | 'platform';
    notes?: string;
  }[];

  risks: {
    risk: string;
    impact: 'low' | 'medium' | 'high';
    mitigation: string;
    status: 'open' | 'mitigated' | 'realized';
  }[];
}
```

##### Employee Communication Templates

```typescript
interface EmployeeCommunicationTemplates {
  // Pre-launch
  announcementEmail: {
    subject: 'New Health Benefit from {{employerName}}';
    sendTiming: '2 weeks before launch';
    content: string;  // Customizable template
  };

  reminderEmail: {
    subject: 'Your new benefit launches in {{daysUntilLaunch}} days';
    sendTiming: '3 days before launch';
  };

  // Launch day
  launchEmail: {
    subject: '🎉 Your {{employerName}} health benefit is now live!';
    sendTiming: 'Launch day';
    includeEnrollmentLink: true;
  };

  // Post-launch
  followUpEmail: {
    subject: 'Haven\'t enrolled yet? Here\'s what you\'re missing';
    sendTiming: '1 week after launch, to non-enrolled';
  };

  // Ongoing
  monthlyNewHireEmail: {
    subject: 'Welcome! You\'re eligible for a new health benefit';
    sendTiming: 'Upon eligibility (after waiting period)';
  };

  // Materials
  printMaterials: {
    benefitsSummaryFlyer: { format: 'PDF'; customizable: true };
    enrollmentInstructions: { format: 'PDF'; customizable: true };
    faqDocument: { format: 'PDF'; customizable: true };
    managerTalkingPoints: { format: 'PDF'; customizable: true };
    breakroomPoster: { format: 'PDF'; customizable: true };
  };
}
```

##### Success Metrics

```typescript
interface EmployerSuccessMetrics {
  // Implementation success
  implementation: {
    daysToGoLive: number;
    vsTargetDays: number;
    milestonesOnTime: number;
    totalMilestones: number;
  };

  // 30-day post-launch
  thirtyDay: {
    enrollmentRate: number;          // % of eligible who enrolled
    activationRate: number;          // % of enrolled who completed first action
    firstOrderRate: number;          // % of enrolled who placed order
  };

  // 90-day health
  ninetyDay: {
    enrollmentRate: number;
    utilizationRate: number;
    averageOrdersPerUser: number;
    refillRate: number;
    npsScore: number;
  };

  // Ongoing
  ongoing: {
    monthlyActiveUsers: number;
    adherenceScore: number;
    employeeSatisfaction: number;
    employerSatisfaction: number;
    churnRisk: 'low' | 'medium' | 'high';
  };

  // Benchmarks
  benchmarks: {
    industryEnrollment: number;
    industryUtilization: number;
    performanceRating: 'exceeding' | 'meeting' | 'below';
  };
}
```

#### Employer Integration Summary

| Component | Status | Priority |
|-----------|--------|----------|
| **Employer Data Model** | ✅ Complete | - |
| **Eligibility Management** | ✅ Complete | Critical |
| **File Upload Processing** | ✅ Complete | Critical |
| **HRIS Integration** | ✅ Complete | High |
| **SSO Integration** | ✅ Complete | High |
| **Billing & Invoicing** | ✅ Complete | Critical |
| **Admin Portal** | ✅ Complete | Critical |
| **Employee Experience** | ✅ Complete | Critical |
| **Reporting & Analytics** | ✅ Complete | High |
| **API Specification** | ✅ Complete | High |
| **Compliance (HIPAA/ERISA)** | ✅ Complete | Critical |
| **Onboarding Process** | ✅ Complete | High |
| **Communication Templates** | ✅ Complete | Medium |

---

### Product Types & Purchase Flows

| Product Type | Rx Required | Flow |
|--------------|-------------|------|
| Prescription compound | Yes | AI → Provider → Rx → Pharmacist → Compound → Ship |
| Prescription boxed | Yes | AI → Provider → Rx → Pharmacist → Dispense → Ship |
| OTC medication | No | Browse → Cart → Pharmacist review → Ship |
| Branded supplement | No | Browse → Cart → Ship |
| Compounded supplement | No | Browse → Customize → Pharmacist review → Compound → Ship |
| Valid refill | No (existing Rx) | Request → System check → Pharmacist → Fulfill → Ship |

---

### Shipping

| Decision | Choice |
|----------|--------|
| Cold chain | In-house (coolers, ice packs, insulated packaging) |
| Signature | Required for controlled substances only |
| Reship costs | Buffered into pricing, company absorbs |
| Analytics | Mandatory - track all delivery events |
| Speed options | Standard, Expedited, Free threshold |

#### Cold Chain Rules

- Max transit: 2 days for temperature-sensitive
- No ship days: Friday, Saturday, Sunday (avoid weekend sits)
- Packaging: Insulated box + gel packs (frozen for <8°C products)

#### Cold Chain IoT Monitoring

Real-time temperature monitoring throughout the shipping process using IoT sensors.

| Decision | Choice |
|----------|--------|
| Sensor type | Single-use temperature loggers (Temptime, Sensitech, Berlinger) |
| Data transmission | NFC read at delivery + cellular for high-value |
| Alert threshold | Product-specific (e.g., 2-8°C for biologics) |
| Excursion handling | Auto-reship if exceeded, patient notification |

##### Temperature Monitoring Data Model

```typescript
interface TemperatureSensor {
  id: string;
  sensorType: 'single_use_nfc' | 'single_use_cellular' | 'reusable_ble';
  serialNumber: string;
  manufacturer: 'temptime' | 'sensitech' | 'berlinger' | 'emerson' | 'controlant';

  assignedToShipmentId?: string;
  assignedAt?: Date;

  configuration: {
    minTemp: number;           // Celsius
    maxTemp: number;
    sampleIntervalMinutes: number;
    alarmThresholdMinutes: number;  // How long outside range before alarm
  };

  status: 'available' | 'assigned' | 'in_transit' | 'delivered' | 'excursion_detected' | 'decommissioned';

  batteryLevel?: number;
  lastReadAt?: Date;
  activatedAt?: Date;
  deactivatedAt?: Date;

  createdAt: Date;
}

interface ShipmentTemperatureLog {
  id: string;
  shipmentId: string;
  sensorId: string;

  readings: TemperatureReading[];

  summary: {
    minRecorded: number;
    maxRecorded: number;
    avgTemperature: number;
    totalReadings: number;
    excursionCount: number;
    totalExcursionMinutes: number;
    longestExcursionMinutes: number;
  };

  excursions: TemperatureExcursion[];

  status: 'monitoring' | 'completed_ok' | 'excursion_detected' | 'data_incomplete';

  productIntegrity: 'verified_ok' | 'compromised' | 'unknown' | 'pending_review';
  pharmacistReviewRequired: boolean;
  pharmacistDecision?: {
    reviewedBy: string;
    reviewedAt: Date;
    decision: 'approve_dispense' | 'reship' | 'destroy';
    rationale: string;
  };

  retrievedAt?: Date;
  retrievalMethod: 'nfc_scan' | 'cellular_upload' | 'manual_entry';

  createdAt: Date;
  updatedAt: Date;
}

interface TemperatureReading {
  timestamp: Date;
  temperature: number;         // Celsius
  withinRange: boolean;
  location?: {
    lat: number;
    lng: number;
    source: 'cellular' | 'carrier_tracking';
  };
}

interface TemperatureExcursion {
  id: string;
  startedAt: Date;
  endedAt?: Date;
  durationMinutes: number;

  excursionType: 'high' | 'low';
  peakTemperature: number;     // Highest (if high) or lowest (if low)
  avgTemperature: number;

  severity: 'minor' | 'moderate' | 'severe' | 'critical';
  productImpact: 'none' | 'reduced_potency' | 'destroyed' | 'unknown';

  alertSent: boolean;
  alertSentAt?: Date;
}
```

##### Product Temperature Requirements

```typescript
interface ProductColdChainRequirements {
  productId: string;
  productName: string;

  storageCondition: 'frozen' | 'refrigerated' | 'controlled_room_temp' | 'ambient';

  temperatureRange: {
    min: number;               // Celsius
    max: number;
    optimal: number;
  };

  excursionTolerance: {
    minorExcursion: {
      tempRange: { min: number; max: number };
      maxDurationMinutes: number;
      action: 'log_only' | 'pharmacist_review' | 'auto_reship';
    };
    moderateExcursion: {
      tempRange: { min: number; max: number };
      maxDurationMinutes: number;
      action: 'pharmacist_review' | 'auto_reship' | 'destroy';
    };
    severeExcursion: {
      tempRange: { min: number; max: number };
      action: 'auto_reship' | 'destroy';
    };
  };

  freezeThaw: {
    tolerateFreeze: boolean;
    maxFreezeThawCycles?: number;
  };

  lightSensitive: boolean;
  shippingRequirements: {
    maxTransitDays: number;
    requiresInsulatedPackaging: boolean;
    requiresGelPacks: boolean;
    gelPackType?: 'refrigerated' | 'frozen';
  };

  regulatoryReference?: string;  // e.g., "USP <659>"
}

const productColdChainExamples: ProductColdChainRequirements[] = [
  {
    productId: 'semaglutide-2mg',
    productName: 'Semaglutide 2mg/0.75mL',
    storageCondition: 'refrigerated',
    temperatureRange: { min: 2, max: 8, optimal: 5 },
    excursionTolerance: {
      minorExcursion: {
        tempRange: { min: 0, max: 25 },
        maxDurationMinutes: 180,
        action: 'log_only'
      },
      moderateExcursion: {
        tempRange: { min: -5, max: 30 },
        maxDurationMinutes: 60,
        action: 'pharmacist_review'
      },
      severeExcursion: {
        tempRange: { min: -20, max: 40 },
        action: 'destroy'
      }
    },
    freezeThaw: { tolerateFreeze: false },
    lightSensitive: true,
    shippingRequirements: {
      maxTransitDays: 2,
      requiresInsulatedPackaging: true,
      requiresGelPacks: true,
      gelPackType: 'refrigerated'
    }
  }
];
```

##### Cold Chain Monitoring Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│ COLD CHAIN MONITORING FLOW                                          │
└─────────────────────────────────────────────────────────────────────┘

Order Ready for Ship
         │
         ▼
Assign Temperature Sensor
         │
         ├── NFC logger (standard)
         └── Cellular logger (high-value >$500)
         │
         ▼
Activate Sensor + Configure Thresholds
         │
         ▼
Package with Gel Packs (refrigerated/frozen)
         │
         ▼
Ship via 2-day carrier (no Friday ship)
         │
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│ IN TRANSIT MONITORING                                                │
│                                                                      │
│ Cellular sensors: Real-time temperature uploads every 15 min        │
│ NFC sensors: Data stored locally, read at delivery                  │
│                                                                      │
│ If cellular excursion detected:                                     │
│   → Alert ops team immediately                                      │
│   → Consider intercepting shipment                                  │
│   → Pre-stage replacement order                                     │
└─────────────────────────────────────────────────────────────────────┘
         │
         ▼
Package Delivered
         │
         ▼
Patient scans NFC sensor (app prompt)
         │
         ├── All readings OK → Proceed normally
         └── Excursion detected → Trigger review
                   │
                   ▼
            ┌─────────────────────────────────────┐
            │ EXCURSION HANDLING                   │
            │                                      │
            │ Minor: Log, patient may use         │
            │ Moderate: Pharmacist review         │
            │ Severe: Auto-reship, do not use     │
            └─────────────────────────────────────┘
```

##### Excursion Alert System

```typescript
interface ColdChainAlert {
  id: string;
  shipmentId: string;
  sensorId: string;
  excursionId: string;

  alertType: 'real_time_excursion' | 'delivery_excursion' | 'sensor_failure' | 'data_gap';
  severity: 'warning' | 'critical';

  triggeredAt: Date;
  temperature: number;
  threshold: { min: number; max: number };
  excursionDuration: number;

  recipientType: 'ops_team' | 'pharmacist' | 'patient';
  recipientId: string;

  notificationChannel: 'email' | 'sms' | 'push' | 'slack';
  notificationSent: boolean;
  notificationSentAt?: Date;

  actionTaken?: 'none' | 'reship_initiated' | 'pharmacist_review' | 'patient_notified' | 'shipment_intercepted';
  actionTakenBy?: string;
  actionTakenAt?: Date;

  resolved: boolean;
  resolvedAt?: Date;
  resolution?: string;

  createdAt: Date;
}

const coldChainAlertRules = [
  {
    condition: 'temperature > max_threshold for 30+ minutes',
    severity: 'warning',
    recipients: ['ops_team'],
    action: 'Monitor closely, prepare replacement'
  },
  {
    condition: 'temperature > max_threshold + 10°C',
    severity: 'critical',
    recipients: ['ops_team', 'pharmacist_on_call'],
    action: 'Intercept if possible, initiate reship'
  },
  {
    condition: 'temperature < 0°C (freeze-sensitive product)',
    severity: 'critical',
    recipients: ['ops_team', 'pharmacist_on_call'],
    action: 'Product compromised, auto-reship'
  },
  {
    condition: 'sensor_data_gap > 2 hours',
    severity: 'warning',
    recipients: ['ops_team'],
    action: 'Investigate, may require pharmacist review at delivery'
  }
];
```

##### Patient NFC Scan Experience

```
┌─────────────────────────────────────────────────────────────────────┐
│ 📦 Your Package Has Arrived!                                        │
│                                                                      │
│ Before opening, please scan the temperature sensor                  │
│ on your package to verify it was stored correctly                   │
│ during shipping.                                                     │
│                                                                      │
│           ┌─────────────────────┐                                   │
│           │   📱 Scan Sensor    │                                   │
│           │                     │                                   │
│           │ Hold phone near the │                                   │
│           │ sensor sticker on   │                                   │
│           │ the package         │                                   │
│           └─────────────────────┘                                   │
│                                                                      │
│ ─────────────────────────────────────────────────────────────────── │
│                                                                      │
│ ✅ SCAN RESULT: Temperature OK                                      │
│                                                                      │
│ Your medication was kept between 2-8°C throughout                   │
│ shipping. It's safe to use.                                         │
│                                                                      │
│ Min: 3.2°C | Max: 6.8°C | Duration: 28 hours                        │
│                                                                      │
│ [View Full Temperature Log] [Continue to Storage Instructions]      │
└─────────────────────────────────────────────────────────────────────┘
```

---

#### Delivery Exception Handling

Comprehensive workflow for handling shipping issues, failed deliveries, and returns.

| Decision | Choice |
|----------|--------|
| Address validation | Pre-ship validation via Smarty/USPS API |
| Failed delivery | 2 carrier attempts, then hold at facility or reship |
| Signature required | Controlled substances + orders >$200 |
| Reship policy | Free reship for carrier issues, patient-caused at cost |

##### Delivery Exception Data Model

```typescript
interface DeliveryException {
  id: string;
  shipmentId: string;
  orderId: string;
  patientId: string;

  exceptionType: 'address_issue' | 'delivery_failed' | 'returned_to_sender' | 'lost_in_transit' |
                 'damaged' | 'temperature_excursion' | 'signature_refused' | 'recipient_unavailable' |
                 'wrong_address' | 'access_issue' | 'weather_delay' | 'carrier_delay';

  detectedAt: Date;
  detectedBy: 'carrier_webhook' | 'patient_report' | 'ops_team' | 'temperature_sensor';

  carrierDetails: {
    carrier: string;
    trackingNumber: string;
    lastKnownStatus: string;
    lastKnownLocation?: string;
    carrierExceptionCode?: string;
    carrierExceptionMessage?: string;
  };

  deliveryAttempts: DeliveryAttempt[];

  status: 'detected' | 'investigating' | 'contacting_patient' | 'awaiting_patient_action' |
          'reship_initiated' | 'held_at_facility' | 'resolved' | 'refunded' | 'escalated';

  resolution?: {
    type: 'delivered_on_retry' | 'reshipped' | 'held_for_pickup' | 'refunded' | 'credited' | 'unresolved';
    resolvedAt: Date;
    resolvedBy: string;
    notes: string;
    reshipmentId?: string;
    refundAmount?: number;
  };

  patientCommunication: ExceptionCommunication[];

  financialImpact: {
    originalShippingCost: number;
    reshipCost?: number;
    productReplacementCost?: number;
    refundIssued?: number;
    responsibility: 'carrier' | 'company' | 'patient';
  };

  slaDeadline: Date;
  slaBreached: boolean;

  createdAt: Date;
  updatedAt: Date;
}

interface DeliveryAttempt {
  attemptNumber: number;
  attemptedAt: Date;
  outcome: 'delivered' | 'no_access' | 'no_recipient' | 'refused' | 'damaged' | 'wrong_address';
  carrierNotes?: string;
  proofOfDelivery?: {
    signatureName?: string;
    signatureImage?: string;
    photoUrl?: string;
    geoLocation?: { lat: number; lng: number };
  };
}

interface ExceptionCommunication {
  id: string;
  channel: 'sms' | 'email' | 'phone' | 'in_app';
  direction: 'outbound' | 'inbound';
  timestamp: Date;
  content: string;
  sentBy?: string;
  outcome?: string;
}
```

##### Exception Handling Workflows

```
┌─────────────────────────────────────────────────────────────────────┐
│ DELIVERY EXCEPTION WORKFLOW                                          │
└─────────────────────────────────────────────────────────────────────┘

Exception Detected (webhook/report)
              │
              ▼
┌─────────────────────────────────────────┐
│ EXCEPTION TYPE ROUTER                    │
└─────────────────────────────────────────┘
              │
    ┌─────────┼─────────┬─────────────────┐
    ▼         ▼         ▼                 ▼
ADDRESS   FAILED      LOST/           DAMAGED/
ISSUE     DELIVERY    DELAYED         EXCURSION

    │         │         │                 │
    ▼         ▼         ▼                 ▼
Contact   Carrier    Investigate      Auto-Reship
Patient   Retry      with Carrier     + Alert Ops

    │         │         │                 │
    ▼         ▼         ▼                 ▼
Correct   Success?   Found?           Notify
Address   ├─Y→ Done  ├─Y→ Resume      Patient
    │     └─N→ ↓     └─N→ ↓              │
    ▼              ▼                      ▼
Reship to      File Claim +              Done
New Address    Reship Free
```

##### Address Issue Handling

```typescript
interface AddressValidationResult {
  inputAddress: Address;
  status: 'valid' | 'correctable' | 'invalid' | 'ambiguous';

  standardizedAddress?: Address;
  corrections?: AddressCorrection[];
  suggestions?: Address[];  // For ambiguous addresses

  deliverability: {
    isDeliverable: boolean;
    deliveryPointType: 'residential' | 'commercial' | 'po_box' | 'military' | 'general_delivery';
    accessNotes?: string;
  };

  riskFactors: {
    isVacant: boolean;
    isHighRiskArea: boolean;
    hasDeliveryIssueHistory: boolean;
    previousExceptionCount: number;
  };
}

interface AddressCorrection {
  field: 'street' | 'unit' | 'city' | 'state' | 'zip';
  original: string;
  corrected: string;
  confidence: number;
}

const addressExceptionFlow = {
  pre_ship: {
    invalid_address: 'Block shipment, contact patient for correction',
    missing_unit: 'Prompt patient to add apartment/unit number',
    po_box_controlled: 'Block - controlled substances cannot ship to PO Box',
    high_risk_history: 'Require signature confirmation before shipping'
  },
  post_ship: {
    wrong_address: 'Contact patient, initiate address change + reship',
    insufficient_address: 'Request carrier hold at facility, contact patient',
    access_issue: 'Contact patient for access instructions or alternate address'
  }
};
```

##### Carrier Integration for Exceptions

```typescript
interface CarrierWebhookEvent {
  carrier: 'ups' | 'fedex' | 'usps' | 'dhl';
  eventType: string;
  trackingNumber: string;
  timestamp: Date;
  status: string;
  exceptionCode?: string;
  location?: string;
  signedBy?: string;
  photoUrl?: string;
}

const carrierExceptionMappings = {
  ups: {
    'X1': { type: 'address_issue', severity: 'high', action: 'contact_patient' },
    'X2': { type: 'recipient_unavailable', severity: 'medium', action: 'retry' },
    'X7': { type: 'access_issue', severity: 'medium', action: 'contact_patient' },
    'X8': { type: 'refused', severity: 'high', action: 'investigate' }
  },
  fedex: {
    '17': { type: 'recipient_unavailable', severity: 'medium', action: 'retry' },
    '84': { type: 'address_issue', severity: 'high', action: 'contact_patient' },
    'DE': { type: 'damaged', severity: 'critical', action: 'reship' }
  },
  usps: {
    '03': { type: 'address_issue', severity: 'high', action: 'contact_patient' },
    '04': { type: 'recipient_unavailable', severity: 'medium', action: 'retry' },
    '06': { type: 'refused', severity: 'high', action: 'return_initiated' }
  }
};
```

##### Patient Communication Templates

```typescript
const deliveryExceptionTemplates = {
  address_issue_sms: {
    template: 'Hi {{firstName}}, we couldn\'t deliver your order to {{street}}. Please update your address in the app or call {{supportPhone}}. Reply HELP for assistance.',
    requiresConsent: 'tier2'
  },
  delivery_failed_sms: {
    template: 'Hi {{firstName}}, delivery of your {{productName}} was attempted but unsuccessful. The carrier will retry tomorrow. Track at: {{trackingUrl}}',
    requiresConsent: 'tier2'
  },
  reship_notification: {
    template: 'Hi {{firstName}}, we\'re reshipping your order at no charge. New tracking: {{trackingNumber}}. Expected delivery: {{estimatedDate}}.',
    requiresConsent: 'tier2'
  },
  held_at_facility: {
    template: 'Hi {{firstName}}, your package is being held at {{facilityAddress}}. Please pick up within 5 days or contact us to reship. ID required.',
    requiresConsent: 'tier2'
  }
};
```

##### Exception Dashboard (Ops Team)

```
┌─────────────────────────────────────────────────────────────────────┐
│ DELIVERY EXCEPTIONS                        Today: 12 | Week: 47     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 🔴 CRITICAL (2)              ⚠️ HIGH (5)              📋 MEDIUM (5) │
│                                                                      │
│ ┌─────────────────────────────────────────────────────────────────┐ │
│ │ 🔴 Temperature Excursion · Order #45678 · Semaglutide           │ │
│ │ Sensor detected 18°C for 45 minutes during transit              │ │
│ │ Status: Auto-reship initiated · Patient notified                │ │
│ │ [View Details] [Contact Patient] [Pharmacist Review]            │ │
│ └─────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│ ┌─────────────────────────────────────────────────────────────────┐ │
│ │ 🔴 Lost in Transit · Order #45123 · Testosterone Cypionate      │ │
│ │ No carrier scan in 72 hours · Last seen: Memphis hub            │ │
│ │ Status: Investigating with FedEx · Claim filed                  │ │
│ │ [View Details] [Initiate Reship] [File Claim]                   │ │
│ └─────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│ ┌─────────────────────────────────────────────────────────────────┐ │
│ │ ⚠️ Address Issue · Order #45890 · Sarah M.                      │ │
│ │ Carrier: "Apartment number missing"                             │ │
│ │ Status: Awaiting patient response · SMS sent 2 hrs ago          │ │
│ │ [View Details] [Call Patient] [Hold at Facility]                │ │
│ └─────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│ ...                                                                  │
└─────────────────────────────────────────────────────────────────────┘
```

##### SLA & Metrics

| Exception Type | Resolution SLA | Escalation Trigger |
|----------------|----------------|-------------------|
| Address Issue | 24 hours | No patient response in 12 hours |
| Failed Delivery | 48 hours | 2nd delivery attempt failed |
| Lost Package | 72 hours | No carrier response in 48 hours |
| Damaged Package | 24 hours | Immediate if medication affected |
| Temperature Excursion | 4 hours | Immediate for critical products |
| Return to Sender | 48 hours | Controlled substance = immediate |

---

### Returns & Adverse Events

| Decision | Choice |
|----------|--------|
| Unopened returns | Accepted (boxed, supplements, OTC) |
| Compounded returns | Not accepted |
| Refund policy | Credit first, refund if opted out |
| Adverse events | Collect → Staff reviews → Submit to MedWatch |
| Quality complaints | QC team → Pharmacist if needed → Batch flag |
| Compensation | Staff discretion |

#### Batch Flag Escalation

- **1 complaint:** Log, monitor
- **2 complaints:** Flag batch, alert QC
- **3+ complaints:** Escalate to pharmacist, potential hold
- **Critical issue:** Immediate hold, notify medical director, potential recall

#### FDA Pharmacovigilance (MedWatch)

Mandatory adverse event reporting to FDA for serious drug reactions.

| Decision | Choice |
|----------|--------|
| Reporting system | FDA MedWatch (Form FDA 3500/3500A) |
| Reporting threshold | Serious adverse events only (hospitalization, disability, death, etc.) |
| Timeline | 15 calendar days for serious events |
| Responsibility | Pharmacist-in-charge with medical director oversight |

##### Adverse Event Data Model

```typescript
interface AdverseEventReport {
  id: string;
  patientId: string;
  reportedBy: 'patient' | 'provider' | 'pharmacist' | 'caregiver';
  reporterId: string;

  reportType: 'initial' | 'followup' | 'correction';
  previousReportId?: string;

  eventDetails: {
    description: string;
    onsetDate: Date;
    resolutionDate?: Date;
    outcome: 'recovered' | 'recovering' | 'not_recovered' | 'fatal' | 'unknown' | 'sequelae';
    isOngoing: boolean;
  };

  severity: {
    isSeriousEvent: boolean;
    seriousnessReason?: ('hospitalization' | 'disability' | 'life_threatening' | 'death' |
                         'congenital_anomaly' | 'intervention_required' | 'other')[];
    hospitalizedDays?: number;
    wasLifeThreatening: boolean;
    causedDeath: boolean;
    deathDate?: Date;
  };

  suspectedProduct: {
    productId: string;
    productName: string;
    ndc?: string;
    batchLotNumber?: string;
    manufacturer?: string;
    expirationDate?: Date;
    doseAdministered: { amount: number; unit: string; frequency: string };
    routeOfAdministration: string;
    therapyDates: { startDate: Date; endDate?: Date };
    indicationForUse: string;
  };

  concomitantMedications: {
    productName: string;
    dose?: string;
    therapyDates?: { startDate: Date; endDate?: Date };
    indicationForUse?: string;
  }[];

  patientDemographics: {
    age: number;
    ageUnit: 'years' | 'months' | 'days';
    sex: 'M' | 'F' | 'U';
    weight?: number;
    weightUnit?: 'kg' | 'lb';
    ethnicity?: string;
  };

  relevantHistory: {
    allergies: string[];
    preExistingConditions: string[];
    relevantLabResults?: string;
    otherRelevantInfo?: string;
  };

  medicalReview: {
    reviewedBy: string;
    reviewedAt: Date;
    causality: 'certain' | 'probable' | 'possible' | 'unlikely' | 'unassessable';
    reviewNotes: string;
    additionalInfoRequested?: string;
  };

  regulatorySubmission: MedWatchSubmission;

  internalActions: {
    batchHold: boolean;
    batchId?: string;
    qualityInvestigation: boolean;
    qualityInvestigationId?: string;
    prescriberNotified: boolean;
    prescriberNotifiedAt?: Date;
    patientFollowUpRequired: boolean;
    patientFollowUpScheduledAt?: Date;
  };

  status: 'draft' | 'pending_review' | 'reviewed' | 'submitted' | 'acknowledged' | 'closed';

  createdAt: Date;
  updatedAt: Date;
}

interface MedWatchSubmission {
  submissionType: 'voluntary' | 'mandatory';
  formType: 'FDA_3500' | 'FDA_3500A';  // 3500A for mandatory reporters

  submissionMethod: 'esub' | 'faers' | 'fax' | 'mail';
  submissionId?: string;  // FDA confirmation number

  submittedAt?: Date;
  submittedBy?: string;

  fdaAcknowledgement?: {
    receivedAt: Date;
    caseNumber: string;
    mfrControlNumber?: string;
  };

  deadline: Date;  // 15 calendar days from awareness
  isOverdue: boolean;

  attachments: {
    fileName: string;
    fileType: string;
    s3Url: string;
    documentType: 'lab_results' | 'medical_records' | 'photos' | 'other';
  }[];
}
```

##### MedWatch Reporting Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│ ADVERSE EVENT REPORTING WORKFLOW                                     │
└─────────────────────────────────────────────────────────────────────┘

Adverse Event Reported
(patient/provider/pharmacist)
              │
              ▼
Initial Triage (Pharmacist)
              │
              ├── Not serious → Log only, monitor
              └── Potentially serious → Continue ↓
              │
              ▼
┌─────────────────────────────────────────────────────────────────────┐
│ SERIOUSNESS CRITERIA (any one = serious)                            │
│                                                                      │
│ □ Resulted in death                                                 │
│ □ Life-threatening                                                  │
│ □ Required hospitalization or prolonged hospitalization            │
│ □ Resulted in persistent or significant disability                 │
│ □ Congenital anomaly/birth defect                                  │
│ □ Required intervention to prevent permanent impairment            │
│ □ Other medically important condition                              │
└─────────────────────────────────────────────────────────────────────┘
              │
              ▼
Medical Director Review (24 hours)
              │
              ├── Causality assessment
              ├── Internal investigation trigger
              └── Batch hold decision
              │
              ▼
Prepare MedWatch Report (FDA Form 3500A)
              │
              ▼
Submit to FDA within 15 calendar days
              │
              ├── FAERS Gateway (electronic preferred)
              ├── FDA Safety Reporting Portal
              └── Fax (1-800-FDA-0178) if electronic unavailable
              │
              ▼
Track FDA Acknowledgement
              │
              ▼
Follow-up Report (if new information)
```

##### Causality Assessment (WHO-UMC Criteria)

```typescript
interface CausalityAssessment {
  eventId: string;
  assessedBy: string;
  assessedAt: Date;

  category: 'certain' | 'probable' | 'possible' | 'unlikely' | 'conditional' | 'unassessable';

  criteria: {
    temporalRelationship: boolean;        // Event occurred after drug exposure
    knownReaction: boolean;               // Event is a known reaction to this drug
    improvedOnWithdrawal: boolean;        // Dechallenge positive
    rechallengePositive?: boolean;        // Event recurred on re-exposure
    alternativeExplanation: boolean;      // Other causes possible
    objectiveEvidence: boolean;           // Lab/test confirmation
  };

  rationale: string;
  confidenceLevel: 'high' | 'medium' | 'low';
}

const causalityCategories = {
  certain: {
    criteria: 'Temporal relationship + known reaction + dechallenge positive + rechallenge positive',
    reportingImplication: 'Mandatory FDA report'
  },
  probable: {
    criteria: 'Temporal relationship + known reaction + dechallenge positive + no rechallenge',
    reportingImplication: 'Mandatory FDA report'
  },
  possible: {
    criteria: 'Temporal relationship + known reaction + alternative explanation possible',
    reportingImplication: 'Mandatory FDA report if serious'
  },
  unlikely: {
    criteria: 'Temporal relationship unlikely + alternative explanation more likely',
    reportingImplication: 'Document only, no FDA report'
  }
};
```

##### Pharmacovigilance Dashboard

```
┌─────────────────────────────────────────────────────────────────────┐
│ PHARMACOVIGILANCE CENTER                                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 📊 SUMMARY                                                           │
│ ┌────────────┬────────────┬────────────┬────────────┐               │
│ │ This Week  │ This Month │ Pending    │ Overdue    │               │
│ │     3      │     12     │     2      │     0      │               │
│ └────────────┴────────────┴────────────┴────────────┘               │
│                                                                      │
│ 🔴 PENDING FDA SUBMISSION (2)                                       │
│ ┌─────────────────────────────────────────────────────────────────┐ │
│ │ AE-2024-0234 · Severe nausea/dehydration · Semaglutide          │ │
│ │ Patient: J.S. · Age: 52F · Hospitalized 2 days                  │ │
│ │ Reported: Feb 5 · Deadline: Feb 20 (11 days)                    │ │
│ │ Status: Medical Director review complete                        │ │
│ │ Causality: Probable                                              │ │
│ │ [View Details] [Prepare 3500A] [Request More Info]              │ │
│ └─────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│ ┌─────────────────────────────────────────────────────────────────┐ │
│ │ AE-2024-0231 · Injection site reaction (severe) · Testosterone  │ │
│ │ Patient: M.T. · Age: 45M · Required medical intervention        │ │
│ │ Reported: Feb 3 · Deadline: Feb 18 (9 days)                     │ │
│ │ Status: Awaiting lab results                                     │ │
│ │ Causality: Possible                                              │ │
│ │ [View Details] [Prepare 3500A] [Add Lab Results]                │ │
│ └─────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│ 📋 RECENTLY SUBMITTED                                                │
│ ┌─────────────────────────────────────────────────────────────────┐ │
│ │ AE-2024-0228 · Submitted Feb 1 · FDA Case #FDA-2024-12345       │ │
│ │ AE-2024-0215 · Submitted Jan 25 · FDA Case #FDA-2024-12289      │ │
│ └─────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│ 📈 SIGNAL DETECTION                                                  │
│ ┌─────────────────────────────────────────────────────────────────┐ │
│ │ ⚠️ Semaglutide: 3 nausea reports this month (vs. 1 avg)         │ │
│ │ ⚠️ Batch #2024-SEM-045: 2 adverse events (investigate?)         │ │
│ └─────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

##### Signal Detection & Trending

```typescript
interface PharmacovigilanceSignal {
  id: string;
  signalType: 'product_cluster' | 'batch_cluster' | 'event_type_increase' | 'geographic_cluster';

  detectedAt: Date;
  detectionMethod: 'automated_threshold' | 'manual_review' | 'external_report';

  details: {
    productId?: string;
    productName?: string;
    batchId?: string;
    eventType?: string;
    timeframe: { start: Date; end: Date };
    eventCount: number;
    expectedCount: number;
    proportionalReportingRatio?: number;
  };

  severity: 'low' | 'medium' | 'high' | 'critical';

  actions: {
    batchHoldInitiated: boolean;
    investigationOpened: boolean;
    investigationId?: string;
    prescriberAlertSent: boolean;
    regulatoryNotification: boolean;
  };

  status: 'detected' | 'investigating' | 'confirmed' | 'dismissed' | 'resolved';
  resolution?: string;

  createdAt: Date;
  updatedAt: Date;
}

const signalDetectionRules = [
  {
    name: 'Product adverse event spike',
    condition: 'AE count for product > 2x monthly average',
    action: 'Alert pharmacovigilance team',
    severity: 'medium'
  },
  {
    name: 'Batch cluster',
    condition: '2+ AEs from same batch within 30 days',
    action: 'Initiate batch investigation, consider hold',
    severity: 'high'
  },
  {
    name: 'Serious event threshold',
    condition: 'Any hospitalization, disability, or death',
    action: 'Immediate medical director review',
    severity: 'critical'
  },
  {
    name: 'New event type',
    condition: 'Event type not previously reported for product',
    action: 'Flag for clinical review',
    severity: 'low'
  }
];
```

##### Integration with Quality System

```typescript
interface AEQualityIntegration {
  adverseEventId: string;

  qualityInvestigation?: {
    investigationId: string;
    status: 'pending' | 'in_progress' | 'completed';
    findings?: string;
    capaRequired: boolean;
    capaId?: string;
  };

  batchActions?: {
    batchId: string;
    actionType: 'hold' | 'quarantine' | 'recall' | 'destruction';
    actionDate: Date;
    authorizedBy: string;
    affectedUnits: number;
  };

  prescriberNotification?: {
    notifiedAt: Date;
    notifiedBy: string;
    response?: string;
    responseAt?: Date;
  };

  patientFollowUp?: {
    scheduledAt: Date;
    completedAt?: Date;
    outcome?: string;
    additionalTreatmentRequired: boolean;
  };
}
```

##### Regulatory Compliance Checklist

| Requirement | Implementation | Status |
|-------------|---------------|--------|
| 15-day serious AE reporting | Automated deadline tracking | ✅ |
| MedWatch Form 3500A | Template generator | ✅ |
| FAERS electronic submission | Gateway integration | ✅ |
| Medical officer review | Workflow + signature | ✅ |
| Causality assessment | WHO-UMC framework | ✅ |
| Signal detection | Automated monitoring | ✅ |
| Batch correlation | Linked to QC system | ✅ |
| Audit trail | 21 CFR Part 11 compliant | ✅ |
| Record retention | 10 years minimum | ✅ |

---

### Identity Verification

| Decision | Choice |
|----------|--------|
| Verification methods | ID scan + video verification during visit |
| When required | Before first prescription |
| Re-verification | Required if address changes |
| Age verification | Required for controlled substances and age-restricted products |
| Address validation | USPS/Smarty integration for standardization |
| Vendor | Persona, Jumio, or Onfido |

#### Verification Flow

```
Patient books first appointment
         │
         ▼
Pre-visit: Upload ID (front + back) + Selfie
         │
         ▼
Automated check (OCR, face match, liveness)
         │
         ├── Pass → Proceed to visit
         ├── Review needed → Staff manual review
         └── Fail → Cannot proceed, escalate
         │
         ▼
During visit: Provider confirms patient matches ID
(attestation logged in encounter)
```

#### Identity Verification Data Model

```typescript
interface IdentityVerification {
  id: string;
  patientId: string;

  verificationType: 'full_kyc' | 'age_only' | 'address_only' | 're_verification';
  triggerEvent: 'registration' | 'first_prescription' | 'controlled_substance' | 'address_change' | 'provider_request' | 'fraud_flag';

  status: 'pending' | 'document_uploaded' | 'processing' | 'manual_review' | 'approved' | 'rejected' | 'expired';

  documentCapture: {
    idFrontUrl: string;         // S3 URL (encrypted at rest)
    idBackUrl: string;
    selfieUrl: string;
    capturedAt: Date;
    captureMethod: 'mobile_camera' | 'file_upload' | 'webcam';
  };

  documentAnalysis: {
    documentType: 'drivers_license' | 'state_id' | 'passport' | 'passport_card' | 'military_id';
    issuingState?: string;
    issuingCountry: string;
    documentNumber: string;       // Encrypted
    expirationDate: Date;
    isExpired: boolean;

    extractedData: {
      firstName: string;
      lastName: string;
      middleName?: string;
      dateOfBirth: Date;
      address: Address;
      sex: 'M' | 'F' | 'X';
    };

    documentAuthenticity: {
      score: number;              // 0-100
      checks: DocumentCheck[];
      isFraudulent: boolean;
      fraudIndicators?: string[];
    };
  };

  biometricAnalysis: {
    faceMatchScore: number;       // 0-100, threshold 80
    faceMatchResult: 'match' | 'no_match' | 'inconclusive';
    livenessScore: number;        // 0-100
    livenessResult: 'live' | 'spoof' | 'inconclusive';
    livenessChecks: ('blink' | 'head_turn' | 'smile' | 'passive')[];
  };

  ageVerification: {
    extractedAge: number;
    meetsMinimumAge: boolean;     // 18+ for most, 21+ for some
    minimumAgeRequired: number;
    verifiedAt: Date;
  };

  addressVerification: {
    inputAddress: Address;
    standardizedAddress: Address;
    matchResult: 'exact' | 'corrected' | 'partial' | 'no_match';
    deliverability: 'deliverable' | 'undeliverable' | 'vacant' | 'po_box';
    isResidential: boolean;
    dpvConfirmed: boolean;        // Delivery Point Validation
    lacsCurrent: boolean;         // Address has been updated (LACS)
  };

  riskAssessment: {
    overallRiskScore: number;     // 0-100, lower is better
    riskLevel: 'low' | 'medium' | 'high' | 'critical';
    riskFactors: RiskFactor[];
    watchlistHit: boolean;
    previousVerifications: number;
    previousRejections: number;
  };

  vendorDetails: {
    vendor: 'persona' | 'jumio' | 'onfido';
    vendorTransactionId: string;
    vendorInquiryId: string;
    rawResponse?: unknown;        // Full vendor response for audit
  };

  manualReview?: {
    reviewerId: string;
    reviewedAt: Date;
    decision: 'approved' | 'rejected';
    rejectionReason?: string;
    notes?: string;
  };

  providerAttestation?: {
    providerId: string;
    attestedAt: Date;
    attestationType: 'video_match' | 'in_person_match';
    notes?: string;
  };

  expiresAt: Date;                // Re-verification required after
  createdAt: Date;
  updatedAt: Date;
}

interface DocumentCheck {
  checkName: 'barcode_match' | 'mrz_valid' | 'hologram_detected' | 'microprint_valid' |
             'uv_features' | 'photo_tampering' | 'document_expired' | 'font_analysis';
  result: 'pass' | 'fail' | 'warning' | 'not_applicable';
  details?: string;
}

interface RiskFactor {
  factor: 'multiple_accounts' | 'velocity_abuse' | 'device_fingerprint' | 'ip_mismatch' |
          'address_mismatch' | 'name_mismatch' | 'dob_mismatch' | 'document_reuse' |
          'known_fraud_pattern' | 'high_risk_geography';
  severity: 'low' | 'medium' | 'high';
  details: string;
}
```

#### Verification Requirements by Context

| Context | ID Required | Age Check | Address Validation | Face Match | Provider Attestation |
|---------|-------------|-----------|-------------------|------------|---------------------|
| Account creation | No | No | No | No | No |
| First consultation | Yes | Yes (18+) | Yes | Yes | Yes (during visit) |
| Controlled substance | Yes | Yes (18+) | Yes | Yes | Yes (each Rx) |
| Schedule II EPCS | Yes | Yes (18+) | Yes | Yes | Yes + PDMP |
| Age-restricted (21+) | Yes | Yes (21+) | Yes | Yes | Optional |
| Address change | No | No | Yes | No | No |
| Annual re-verification | Yes | No | Yes | Yes | No |

#### Address Standardization Flow

```
Patient enters address
         │
         ▼
Smarty/USPS API call
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│ Standardization Result                                       │
│                                                              │
│ Input:  "123 Main St Apt 4B, Salt lake city, UT 84101"      │
│                                                              │
│ Standardized:                                                │
│   Street: "123 MAIN ST APT 4B"                              │
│   City: "SALT LAKE CITY"                                    │
│   State: "UT"                                               │
│   ZIP: "84101-2345"                                         │
│                                                              │
│ Status: ✅ Deliverable                                       │
│ Type: Residential                                            │
│ DPV: Confirmed                                               │
└─────────────────────────────────────────────────────────────┘
         │
         ├── Deliverable → Accept, use standardized
         ├── Correctable → Show correction, ask to confirm
         └── Undeliverable → Reject, ask for new address
```

#### Identity Verification Service

```typescript
interface IdentityVerificationService {
  initiateVerification: (params: {
    patientId: string;
    verificationType: IdentityVerification['verificationType'];
    triggerEvent: IdentityVerification['triggerEvent'];
    requiredChecks: ('document' | 'face_match' | 'liveness' | 'age' | 'address')[];
  }) => Promise<{ verificationId: string; uploadUrl: string }>;

  processDocumentUpload: (params: {
    verificationId: string;
    documentType: 'id_front' | 'id_back' | 'selfie';
    imageData: Buffer;
  }) => Promise<{ status: 'uploaded' | 'error'; error?: string }>;

  getVerificationStatus: (verificationId: string) => Promise<IdentityVerification>;

  submitForManualReview: (params: {
    verificationId: string;
    reason: string;
  }) => Promise<void>;

  recordProviderAttestation: (params: {
    verificationId: string;
    providerId: string;
    attestationType: 'video_match' | 'in_person_match';
    notes?: string;
  }) => Promise<void>;

  checkVerificationRequired: (params: {
    patientId: string;
    context: 'consultation' | 'prescription' | 'controlled_substance' | 'address_change';
  }) => Promise<{ required: boolean; reason?: string; existingVerificationId?: string }>;
}
```

#### Fraud Prevention Rules

```typescript
const fraudPreventionRules = [
  {
    name: 'Multiple accounts same ID',
    check: 'document_number_uniqueness',
    action: 'flag_for_review',
    severity: 'high'
  },
  {
    name: 'Rapid verification attempts',
    check: 'velocity > 3 attempts in 24 hours',
    action: 'temporary_block',
    severity: 'medium'
  },
  {
    name: 'Device fingerprint mismatch',
    check: 'device_id differs from registration',
    action: 'require_additional_verification',
    severity: 'low'
  },
  {
    name: 'High-risk IP geolocation',
    check: 'ip_country != document_country',
    action: 'flag_for_review',
    severity: 'medium'
  },
  {
    name: 'Known fraud pattern',
    check: 'matches_fraud_database',
    action: 'reject_and_alert',
    severity: 'critical'
  },
  {
    name: 'Document previously rejected',
    check: 'document_hash_in_rejection_list',
    action: 'auto_reject',
    severity: 'high'
  }
];
```

#### Compliance & Data Retention

| Data Type | Retention Period | Storage | Deletion Method |
|-----------|-----------------|---------|-----------------|
| ID images | 7 years | S3 (encrypted, versioned) | Secure overwrite |
| Selfie images | 7 years | S3 (encrypted, versioned) | Secure overwrite |
| Verification results | 7 years | PostgreSQL (encrypted) | Soft delete → hard delete |
| Vendor responses | 7 years | PostgreSQL (encrypted) | Soft delete → hard delete |
| Biometric data | 3 years | Vendor-managed or deleted | Vendor API call |
| Risk scores | 7 years | PostgreSQL | Soft delete |

#### Integration Points

- **Registration Flow**: Defer full KYC until first consultation booking
- **Appointment Booking**: Block booking if verification failed/expired
- **Prescription Service**: Verify patient before processing Rx
- **EPCS Flow**: Additional attestation required for Schedule II-V
- **Shipping Service**: Use verified address only
- **Fraud Team**: Alerts on high-risk verifications

---

### Patient Education

| Decision | Choice |
|----------|--------|
| Delivery method | QR code on packaging → YouTube videos / instructions |
| Injection training | Video tutorials (YouTube hosted) |
| Viewing requirement | Optional |

#### Implementation

```
Medication shipped with:
┌─────────────────────────────────────┐
│  📦 Package Insert                  │
│                                     │
│  Scan for instructions:             │
│  ┌─────────┐                        │
│  │ QR CODE │ → youtu.be/xxxxx       │
│  └─────────┘                        │
│                                     │
│  Or visit: platform.com/edu/ABC123  │
└─────────────────────────────────────┘
```

#### Video Content Strategy

| Content Type | Hosted On | Notes |
|--------------|-----------|-------|
| Injection tutorials | YouTube (unlisted) | GLP-1, testosterone, B12 |
| Storage instructions | YouTube (unlisted) | Cold chain, reconstitution |
| General medication info | YouTube (unlisted) | Dosing, timing, side effects |
| Refill instructions | In-app | Platform-specific |

#### QR Code Generation

- Unique QR per medication/SKU
- Tracks scans (analytics)
- Falls back to web URL if YouTube unavailable
- Printed on package insert + outer box

---

### Mobile Experience

| Decision | Choice |
|----------|--------|
| App type | Native (iOS + Android) |
| Feature parity | Full parity with web |

#### Native App Scope

| Feature | iOS | Android | Priority |
|---------|-----|---------|----------|
| AI consultation | ✓ | ✓ | MVP |
| Appointment booking | ✓ | ✓ | MVP |
| Video visits | ✓ | ✓ | MVP |
| Order tracking | ✓ | ✓ | MVP |
| Push notifications | ✓ | ✓ | MVP |
| Medication reminders | ✓ | ✓ | Phase 2 |
| Biometric login | ✓ | ✓ | MVP |
| Offline mode | ✓ | ✓ | Phase 2 |
| Apple Health / Google Fit | ✓ | ✓ | Phase 3 |

#### Tech Stack Options

| Option | Pros | Cons |
|--------|------|------|
| React Native | Shared codebase with web (React), large ecosystem | Bridge overhead, native module complexity |
| Flutter | Fast performance, single codebase | Different language (Dart), separate from web |
| Native (Swift/Kotlin) | Best performance, full platform APIs | Two codebases, higher dev cost |

**Recommended:** React Native - aligns with Next.js web stack, code sharing for business logic, mature HIPAA-compliant video libraries.

#### App Store Considerations

- Apple: Health app review process, HIPAA compliance attestation
- Google: Health app policy compliance, data safety section
- Both: Telemedicine apps require licensed provider verification

---

### PDMP Integration (Prescription Drug Monitoring Program)

**Critical** for controlled substance prescribing. Many states legally require PDMP lookup before prescribing controlled substances.

| Decision | Choice |
|----------|--------|
| PDMP lookup | Required before prescribing controlled substances |
| Integration method | State PDMP APIs via aggregator (Appriss PMP Gateway, Bamboo Health) |
| Display location | In-chart during prescribing workflow |
| Storage | Cache results for session, do not persist (privacy) |

#### State PDMP Requirements

| State | Lookup Required? | When? | Controlled Schedules |
|-------|------------------|-------|----------------------|
| Utah | Yes | Before initial + q12mo | II-V |
| Arizona | Yes | Before initial opioid | II only |
| Colorado | Yes | Before initial + q12mo | II-IV |
| Idaho | Yes | Before initial | II-III |
| Wyoming | No mandate | Best practice | - |

#### PDMP Lookup Flow

```
Provider selects controlled substance to prescribe
         │
         ▼
System checks: Is PDMP lookup required for this state + schedule?
         │
         ├── Not required → Log bypass reason, proceed
         │
         └── Required → Query PDMP aggregator API
                  │
                  ▼
         Display PDMP results in-chart:
         ┌─────────────────────────────────────────┐
         │  PDMP Results for Patient: John Doe     │
         │  State: Utah | Last 12 months           │
         │                                         │
         │  Prescriptions Found: 3                 │
         │  ┌─────────────────────────────────────┐│
         │  │ Hydrocodone 10mg | Dr. Smith | 2/1  ││
         │  │ Alprazolam 1mg | Dr. Jones | 1/15   ││
         │  │ Oxycodone 5mg | Dr. Smith | 12/1    ││
         │  └─────────────────────────────────────┘│
         │                                         │
         │  ⚠️ Flags:                              │
         │  • Multiple prescribers (2)             │
         │  • Early refill pattern detected        │
         │                                         │
         │  [Acknowledge & Continue] [Cancel Rx]   │
         └─────────────────────────────────────────┘
                  │
                  ▼
         Provider acknowledges → Log attestation → Proceed with Rx
```

#### PDMP Data Model

```typescript
interface PDMPLookup {
  id: string;
  patientId: string;
  providerId: string;

  requestedAt: Date;
  state: string;
  lookupType: 'prescribing' | 'dispensing' | 'audit';

  status: 'pending' | 'completed' | 'error' | 'no_data';

  resultsCount: number;
  flagsDetected: PDMPFlag[];

  providerAcknowledgedAt?: Date;
  providerAction: 'proceeded' | 'cancelled' | 'modified';
  providerNotes?: string;

  prescriptionId?: string;
}

interface PDMPFlag {
  type: 'multiple_prescribers' | 'multiple_pharmacies' | 'early_refill' | 'high_mme' | 'overlapping_rx' | 'out_of_state';
  severity: 'info' | 'warning' | 'alert';
  description: string;
}
```

#### PDMP Integration Options

| Aggregator | Coverage | Notes |
|------------|----------|-------|
| Appriss PMP Gateway | 50 states | Most comprehensive, DEA preferred |
| Bamboo Health | 49 states | Good API, real-time |
| LogiCoy | 45 states | Budget option |

**Recommended:** Appriss PMP Gateway - single integration covers all expansion states.

---

### EPCS Identity Proofing & Authentication

**Critical** DEA requirement for Electronic Prescribing of Controlled Substances.

| Decision | Choice |
|----------|--------|
| Identity proofing provider | ID.me or Experian |
| Authentication method | Two-factor (something you have + know/are) |
| Token type | Hardware token, soft token (app), or biometric |
| Staff workflow | Staff can prepare Rx, provider must sign |

#### DEA EPCS Requirements

The DEA requires:
1. **Identity Proofing (IDP)** - One-time verification that provider is who they claim to be
2. **Two-Factor Authentication** - Every controlled substance signature requires 2 of 3:
   - Something you know (password, PIN)
   - Something you have (token, phone)
   - Something you are (biometric)

#### EPCS Enrollment Flow

```
Provider requests EPCS privileges
         │
         ▼
┌─────────────────────────────────────────┐
│  EPCS Enrollment                        │
│                                         │
│  Step 1: Identity Proofing              │
│  • Verify DEA registration number       │
│  • Verify state medical license         │
│  • ID.me identity verification          │
│    (ID scan + selfie + knowledge-based) │
│                                         │
│  Step 2: Choose Authentication Method   │
│  ○ Authenticator app (Google/Microsoft) │
│  ○ Hardware token (YubiKey)             │
│  ○ Biometric (Face ID / fingerprint)    │
│                                         │
│  Step 3: Set Signing PIN                │
│  • 6-digit PIN for controlled Rx        │
│  • Different from login password        │
└─────────────────────────────────────────┘
         │
         ▼
Admin reviews enrollment → Approves → Provider can prescribe controlled
```

#### Controlled Substance Prescribing Flow

```
Provider creates prescription for controlled substance
         │
         ▼
System detects: Schedule II-V drug
         │
         ▼
┌─────────────────────────────────────────┐
│  Sign Controlled Substance Rx           │
│                                         │
│  Patient: John Doe                      │
│  Drug: Testosterone Cypionate 200mg/mL  │
│  Schedule: III                          │
│  Quantity: 10mL                         │
│                                         │
│  Two-Factor Authentication Required:    │
│                                         │
│  1. Enter signing PIN: [______]         │
│                                         │
│  2. Approve on authenticator app        │
│     or tap hardware token               │
│     or verify biometric                 │
│                                         │
│  [Sign Prescription]                    │
└─────────────────────────────────────────┘
         │
         ▼
Both factors verified → Digital signature applied → Rx transmitted
```

#### Staff-to-Provider Handoff

```
Staff member prepares controlled substance Rx
         │
         ▼
Rx saved as "Pending Provider Signature"
         │
         ▼
Provider notified (in-app, push)
         │
         ▼
Provider reviews:
├── Patient info correct?
├── Drug/dose appropriate?
├── PDMP reviewed?
         │
         ▼
Provider completes 2FA signature
         │
         ▼
Rx transmitted to pharmacy
```

#### EPCS Data Model

```typescript
interface ProviderEPCSEnrollment {
  providerId: string;

  status: 'not_enrolled' | 'pending_idp' | 'pending_admin' | 'active' | 'suspended' | 'revoked';

  identityProofingProvider: 'idme' | 'experian';
  identityProofedAt?: Date;
  identityProofingLevel: 'ial2' | 'ial3';

  deaNumber: string;
  deaVerifiedAt?: Date;
  deaExpirationDate: Date;

  authenticationMethods: EPCSAuthMethod[];
  primaryAuthMethod: 'totp' | 'hardware_token' | 'biometric';

  signingPinHash: string;
  signingPinSetAt: Date;

  enrolledAt?: Date;
  enrolledBy?: string;

  lastControlledRxAt?: Date;
  controlledRxCount: number;
}

interface EPCSAuthMethod {
  type: 'totp' | 'hardware_token' | 'biometric';
  deviceId: string;
  deviceName: string;
  enrolledAt: Date;
  lastUsedAt?: Date;
  isActive: boolean;
}

interface ControlledSubstanceSignature {
  id: string;
  prescriptionId: string;
  providerId: string;

  signedAt: Date;

  authFactor1: 'pin' | 'password';
  authFactor2: 'totp' | 'hardware_token' | 'biometric';

  deviceFingerprint: string;
  ipAddress: string;

  deaNumberUsed: string;
  drugSchedule: 'II' | 'III' | 'IV' | 'V';
}
```

---

### Formulary Checking

**High priority** - Helps providers make cost-effective prescribing decisions and reduces prior authorization surprises.

| Decision | Choice |
|----------|--------|
| Formulary source | Surescripts Formulary & Benefit (already using Surescripts) |
| When to check | Real-time during prescribing |
| Display | Coverage tier, estimated copay, PA required flag |
| Alternatives | Suggest covered alternatives when drug not covered |

#### Formulary Check Flow

```
Provider selects drug to prescribe
         │
         ▼
System checks: Does patient have insurance on file?
         │
         ├── No insurance → Show cash price only, skip formulary
         │
         └── Has insurance → Query Surescripts Formulary API
                  │
                  ▼
         ┌─────────────────────────────────────────┐
         │  Formulary Coverage                     │
         │                                         │
         │  Drug: Semaglutide 2mg/0.75mL           │
         │                                         │
         │  Coverage: ✅ Covered                   │
         │  Tier: 3 (Preferred Brand)              │
         │  Estimated Copay: $150                  │
         │  Prior Auth: ⚠️ Required                │
         │  Step Therapy: None                     │
         │  Quantity Limits: 4 pens/30 days        │
         │                                         │
         │  💡 Alternatives:                       │
         │  • Tirzepatide - Tier 2, $75 copay     │
         │  • Liraglutide - Tier 2, $60 copay     │
         │                                         │
         │  Cash Price: $425 (if PA denied)        │
         └─────────────────────────────────────────┘
```

#### Formulary Data Model

```typescript
interface FormularyCheck {
  id: string;
  patientId: string;
  insurancePolicyId: string;
  drugNdc: string;

  checkedAt: Date;

  coverage: 'covered' | 'not_covered' | 'covered_with_restrictions' | 'unknown';

  tier?: number;
  tierName?: string;

  copayEstimate?: number;
  coinsurancePercent?: number;

  priorAuthRequired: boolean;
  stepTherapyRequired: boolean;
  quantityLimits?: {
    quantity: number;
    daysSupply: number;
  };

  alternatives: FormularyAlternative[];

  cacheExpiresAt: Date;
}

interface FormularyAlternative {
  drugName: string;
  drugNdc: string;
  tier: number;
  copayEstimate?: number;
  priorAuthRequired: boolean;
  therapeuticEquivalent: boolean;
}
```

#### Integration with Prescribing Workflow

```typescript
const prescribingWorkflowConfig = {
  formularyCheck: {
    enabled: true,
    showWhenNoInsurance: false,
    cacheResultsMinutes: 60,

    displayOptions: {
      showTier: true,
      showCopayEstimate: true,
      showPriorAuthWarning: true,
      showAlternatives: true,
      maxAlternatives: 3
    },

    alerts: {
      notCovered: 'warning',
      priorAuthRequired: 'info',
      highCopay: 'info',  // Copay > $100
      quantityLimitExceeded: 'warning'
    }
  }
};
```

---

### Claim Scrubbing

**High priority** - Pre-submission validation reduces claim rejections and accelerates payment.

| Decision | Choice |
|----------|--------|
| Scrubbing engine | Build rules engine + use clearinghouse validation |
| When to scrub | Before submission, real-time |
| Error handling | Block submission on hard errors, warn on soft errors |
| Payer rules | Maintain payer-specific rule sets |

#### Claim Validation Categories

| Category | Type | Examples |
|----------|------|----------|
| **Structural** | Hard error | Missing required fields, invalid format |
| **Coding** | Hard error | Invalid ICD-10/CPT, incompatible combinations |
| **Payer-specific** | Hard error | Missing required modifiers, invalid place of service |
| **Timing** | Warning | Approaching timely filing deadline |
| **Duplicate** | Warning | Similar claim already submitted |
| **Clinical** | Warning | Unusual frequency, age/gender mismatch |

#### Scrubbing Flow

```
Claim ready for submission
         │
         ▼
┌─────────────────────────────────────────┐
│  CLAIM SCRUBBER                          │
│                                          │
│  Step 1: Structural Validation           │
│  ├── Required fields present?            │
│  ├── Valid formats (NPI, dates, etc)?    │
│  └── Valid claim type?                   │
│                                          │
│  Step 2: Coding Validation               │
│  ├── Valid ICD-10 codes?                 │
│  ├── Valid CPT/HCPCS codes?              │
│  ├── Diagnosis supports procedure?       │
│  └── Modifier requirements met?          │
│                                          │
│  Step 3: Payer Rules                     │
│  ├── Payer-specific requirements?        │
│  ├── Prior auth on file (if required)?   │
│  └── Member eligibility verified?        │
│                                          │
│  Step 4: Duplicate Detection             │
│  └── Similar claim in last 30 days?      │
└─────────────────────────────────────────┘
         │
         ▼
    ┌────┴────┐
    │ Errors? │
    └────┬────┘
         │
    ┌────┴────┬────────────┐
    ▼         ▼            ▼
 No errors   Warnings    Hard errors
    │         │            │
    ▼         ▼            ▼
 Submit    Review &     Block submission
           decide       Show errors
```

#### Scrubbing Rules Engine

```typescript
interface ClaimScrubRule {
  id: string;
  name: string;
  description: string;

  category: 'structural' | 'coding' | 'payer' | 'timing' | 'duplicate' | 'clinical';
  severity: 'error' | 'warning' | 'info';

  payerIds?: string[];  // null = applies to all

  condition: RuleCondition;
  errorCode: string;
  errorMessage: string;

  isActive: boolean;
  effectiveDate: Date;
  expirationDate?: Date;
}

interface ClaimScrubResult {
  claimId: string;
  scrubbedAt: Date;

  passed: boolean;
  errorCount: number;
  warningCount: number;

  findings: ClaimScrubFinding[];

  canSubmit: boolean;
  requiresReview: boolean;
}

interface ClaimScrubFinding {
  ruleId: string;
  ruleName: string;
  severity: 'error' | 'warning' | 'info';

  field?: string;
  currentValue?: string;
  expectedValue?: string;

  message: string;
  suggestion?: string;
}
```

#### Common Scrubbing Rules

```typescript
const commonScrubRules: ClaimScrubRule[] = [
  {
    id: 'missing_diagnosis',
    name: 'Missing Primary Diagnosis',
    category: 'structural',
    severity: 'error',
    condition: { field: 'diagnosisCodes', operator: 'isEmpty' },
    errorCode: 'ERR001',
    errorMessage: 'Claim must have at least one diagnosis code'
  },
  {
    id: 'invalid_npi',
    name: 'Invalid Rendering Provider NPI',
    category: 'structural',
    severity: 'error',
    condition: { field: 'renderingProviderNpi', operator: 'failsLuhnCheck' },
    errorCode: 'ERR002',
    errorMessage: 'Rendering provider NPI is invalid'
  },
  {
    id: 'telehealth_modifier',
    name: 'Missing Telehealth Modifier',
    category: 'payer',
    severity: 'error',
    condition: {
      and: [
        { field: 'placeOfService', operator: 'equals', value: '02' },
        { field: 'modifiers', operator: 'notContains', value: '95' }
      ]
    },
    errorCode: 'ERR010',
    errorMessage: 'Telehealth claims require modifier 95 or GT'
  },
  {
    id: 'timely_filing_warning',
    name: 'Timely Filing Warning',
    category: 'timing',
    severity: 'warning',
    condition: {
      field: 'dateOfService',
      operator: 'olderThanDays',
      value: 60
    },
    errorCode: 'WARN001',
    errorMessage: 'Service date is over 60 days ago. Check payer timely filing limits.'
  },
  {
    id: 'duplicate_claim',
    name: 'Potential Duplicate Claim',
    category: 'duplicate',
    severity: 'warning',
    condition: {
      customCheck: 'checkDuplicateClaim',
      params: { lookbackDays: 30 }
    },
    errorCode: 'WARN002',
    errorMessage: 'Similar claim submitted within last 30 days'
  }
];
```

---

### Patient Statements & Billing

**High priority** - Patients need clear communication about what they owe after insurance.

| Decision | Choice |
|----------|--------|
| Statement frequency | After each EOB received + monthly summary |
| Delivery method | Email (primary), portal, paper (opt-in) |
| Payment options | Portal, card on file, payment plans |
| Collections threshold | 90 days past due → soft collections |

#### Patient Responsibility Flow

```
Insurance pays claim (or denies)
         │
         ▼
ERA (835) received and posted
         │
         ▼
Calculate patient responsibility:
├── Deductible applied
├── Coinsurance calculated
├── Copay applied
└── Non-covered services
         │
         ▼
Patient balance updated
         │
         ▼
Generate statement
         │
         ├── Email notification with summary
         ├── Full statement in patient portal
         └── Paper statement (if opted in)
         │
         ▼
Patient pays via:
├── Portal (card)
├── Card on file (auto-charge if authorized)
├── Payment plan
└── Manual payment
```

#### Statement Data Model

```typescript
interface PatientStatement {
  id: string;
  patientId: string;

  statementDate: Date;
  statementNumber: string;

  statementType: 'individual_claim' | 'monthly_summary' | 'payment_plan' | 'collections_notice';

  periodStart: Date;
  periodEnd: Date;

  previousBalance: number;
  newCharges: number;
  payments: number;
  adjustments: number;
  currentBalance: number;

  lineItems: StatementLineItem[];

  minimumPaymentDue?: number;
  paymentDueDate: Date;

  deliveryMethod: 'email' | 'portal' | 'paper' | 'all';
  sentAt?: Date;
  viewedAt?: Date;

  createdAt: Date;
}

interface StatementLineItem {
  id: string;
  statementId: string;

  serviceDate: Date;
  description: string;

  providerName?: string;
  claimId?: string;

  chargedAmount: number;
  insurancePaid: number;
  adjustments: number;
  patientResponsibility: number;

  status: 'pending' | 'paid' | 'partial' | 'due';
}

interface PatientBalance {
  patientId: string;

  currentBalance: number;

  aging: {
    current: number;    // 0-30 days
    days30: number;     // 31-60 days
    days60: number;     // 61-90 days
    days90: number;     // 91-120 days
    days120Plus: number; // 121+ days
  };

  lastPaymentDate?: Date;
  lastPaymentAmount?: number;

  paymentPlanId?: string;

  collectionsStatus: 'none' | 'soft' | 'agency' | 'written_off';

  updatedAt: Date;
}
```

#### Payment Plans

```typescript
interface PaymentPlan {
  id: string;
  patientId: string;

  status: 'active' | 'completed' | 'defaulted' | 'cancelled';

  originalBalance: number;
  remainingBalance: number;

  monthlyAmount: number;
  totalPayments: number;
  paymentsCompleted: number;

  startDate: Date;
  nextPaymentDate: Date;

  paymentMethod: 'card_on_file' | 'manual';
  cardOnFileId?: string;
  autoCharge: boolean;

  payments: PaymentPlanPayment[];

  createdAt: Date;
  createdBy: string;
}

interface PaymentPlanPayment {
  id: string;
  paymentPlanId: string;

  scheduledDate: Date;
  amount: number;

  status: 'scheduled' | 'processing' | 'completed' | 'failed' | 'skipped';

  processedAt?: Date;
  transactionId?: string;
  failureReason?: string;
}
```

#### Statement Generation Rules

```typescript
const statementConfig = {
  generation: {
    individualClaim: {
      trigger: 'era_posted',
      delayDays: 3,  // Wait for secondary insurance
      minimumBalance: 5.00  // Don't send for tiny amounts
    },

    monthlySummary: {
      dayOfMonth: 1,
      includeZeroBalance: false,
      includePaymentPlanPatients: true
    }
  },

  delivery: {
    email: {
      enabled: true,
      includeFullStatement: false,  // Link to portal instead
      reminderDays: [7, 14, 30]
    },

    paper: {
      enabled: true,
      optInRequired: true,
      minimumBalance: 25.00
    }
  },

  aging: {
    softCollectionsThreshold: 90,
    agencyReferralThreshold: 180,
    writeOffThreshold: 365
  },

  paymentPlans: {
    minimumBalance: 100,
    minimumMonthlyPayment: 25,
    maxTermMonths: 12,
    autoChargeDefault: true
  }
};
```

#### Collections Workflow

```
Balance reaches 90 days past due
         │
         ▼
Soft Collections:
├── Automated reminder emails (weekly)
├── SMS reminder (if opted in)
├── Flag account in portal
└── Block new appointments (optional)
         │
         ▼
Balance reaches 180 days + no response
         │
         ▼
Review for agency referral:
├── Staff reviews account
├── Final notice sent
├── Patient given payment plan option
         │
         ▼
No resolution after 30 days
         │
         ▼
Agency referral OR write-off decision
```

---

### Auto-Refill Subscriptions

**Critical** for adherence and recurring revenue. Patients who use auto-refill are 70% more likely to refill.

| Decision | Choice |
|----------|--------|
| Subscription model | Opt-in recurring shipments |
| Frequencies | Every 2 weeks, monthly, 6 weeks, 2 months, 3 months |
| Patient control | Skip, pause, cancel anytime |
| Discount | 5% off for auto-refill orders |
| Reminder | 7 days before shipment with option to skip |

#### Auto-Refill Data Model

```typescript
interface SubscriptionOrder {
  id: string;
  patientId: string;
  prescriptionId: string;

  status: 'active' | 'paused' | 'cancelled' | 'expired';

  frequency: 'every_2_weeks' | 'monthly' | 'every_6_weeks' | 'every_2_months' | 'every_3_months';
  nextShipDate: Date;
  lastShipDate?: Date;

  paymentMethodId: string;
  shippingAddressId: string;

  discountPercent: number;  // e.g., 5
  discountReason: 'auto_refill';

  skipNextShipment: boolean;
  skipReason?: string;

  shipmentsCompleted: number;
  totalSaved: number;  // Running total of discount savings

  createdAt: Date;
  pausedAt?: Date;
  pauseReason?: string;
  resumeDate?: Date;  // If paused with scheduled resume
  cancelledAt?: Date;
  cancelReason?: string;

  expiresAt?: Date;  // When Rx runs out of refills
}

interface SubscriptionShipment {
  id: string;
  subscriptionId: string;

  scheduledDate: Date;
  status: 'scheduled' | 'processing' | 'shipped' | 'delivered' | 'skipped' | 'failed';

  orderId?: string;  // Links to actual order when processed
  trackingNumber?: string;

  chargeAmount: number;
  discountApplied: number;

  processedAt?: Date;
  failureReason?: string;
  retryCount: number;
}
```

#### Auto-Refill Enrollment Flow

```
Patient completes first order for refillable Rx
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│  💊 Set Up Auto-Refill                                      │
│                                                             │
│  Never run out of your medication again.                    │
│                                                             │
│  ✓ Save 5% on every order                                  │
│  ✓ Free shipping on all auto-refill orders                 │
│  ✓ Skip, pause, or cancel anytime                          │
│  ✓ Reminder 7 days before each shipment                    │
│                                                             │
│  Ship every: [Monthly ▼]                                    │
│                                                             │
│  First auto-refill: March 15, 2026                         │
│                                                             │
│  [Set Up Auto-Refill]        [No thanks, I'll order myself] │
└─────────────────────────────────────────────────────────────┘
         │
         ▼
Subscription created
         │
         ▼
7 days before ship date:
┌─────────────────────────────────────────────────────────────┐
│  📦 Your auto-refill ships in 7 days                        │
│                                                             │
│  Semaglutide 0.5mg - $XXX (5% off applied)                 │
│  Ships: March 15, 2026                                      │
│                                                             │
│  [Ship as Scheduled]  [Skip This Order]  [Manage Subscription]│
└─────────────────────────────────────────────────────────────┘
         │
         ▼
Ship date arrives
         │
         ├── Card on file charged
         ├── Order created automatically
         ├── Pharmacist review (if required)
         └── Ship to patient
```

#### Subscription Management

```
Patient visits Subscription Management
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│  My Auto-Refills                                            │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ Semaglutide 0.5mg                      [Active]     │    │
│  │ Ships monthly · Next: March 15                      │    │
│  │ $XXX/shipment (saving 5%)                           │    │
│  │ 3 refills remaining on Rx                           │    │
│  │                                                     │    │
│  │ [Skip Next] [Change Frequency] [Pause] [Cancel]     │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ B12 Injection 1000mcg                  [Paused]     │    │
│  │ Paused until April 1                                │    │
│  │                                                     │    │
│  │ [Resume Now] [Cancel]                               │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

#### Auto-Refill Business Rules

```typescript
const autoRefillRules = {
  eligibility: {
    requiresValidRx: true,
    requiresRefillsRemaining: true,
    excludedCategories: ['controlled_schedule_2'],  // No auto-refill for C-II
    requiresLabsCurrent: true  // For categories that need labs
  },

  pricing: {
    discountPercent: 5,
    freeShippingThreshold: 0,  // Always free for auto-refill
    stackWithEmployerDiscount: true
  },

  notifications: {
    preShipmentDays: 7,
    preShipmentReminder: true,
    shipmentConfirmation: true,
    deliveryNotification: true,
    paymentFailedAlert: true
  },

  retry: {
    paymentFailureRetries: 3,
    retryIntervalDays: 2,
    pauseAfterMaxRetries: true
  },

  expiration: {
    warnDaysBeforeRxExpires: 30,
    autoExpireWhenRxExpires: true,
    promptForProviderVisit: true
  }
};
```

---

### Auto-Refill Discounts

**High priority** - 28% higher adherence when discounts incentivize auto-refill.

| Decision | Choice |
|----------|--------|
| Discount amount | 5% off all auto-refill orders |
| Stacking | Stacks with employer subsidies |
| Free shipping | All auto-refill orders ship free |
| Display | Show savings prominently |

#### Pricing Display

```
┌─────────────────────────────────────────────────────────────┐
│  Semaglutide 0.5mg/0.5mL Injection                         │
│                                                             │
│  One-time order:        $425.00                            │
│                         + $9.99 shipping                   │
│                         ─────────                          │
│                         $434.99                            │
│                                                             │
│  ✨ Auto-refill price:  $403.75  ← Save $31.24             │
│                         FREE shipping                       │
│                         ─────────                          │
│                         $403.75                            │
│                                                             │
│  [One-Time Order]  [Set Up Auto-Refill & Save]             │
└─────────────────────────────────────────────────────────────┘
```

#### Discount Stacking

```typescript
interface OrderPricing {
  basePrice: number;

  discounts: Discount[];

  subtotal: number;
  shipping: number;
  tax: number;
  total: number;
}

interface Discount {
  type: 'auto_refill' | 'employer_subsidy' | 'promo_code' | 'loyalty';
  description: string;
  amount: number;
  percentOff?: number;
}

// Example with stacking:
// Base price: $425.00
// Auto-refill (5%): -$21.25
// Employer subsidy (25%): -$100.94  (applied to remaining $403.75)
// Shipping: $0 (free with auto-refill)
// Total: $302.81 (vs $434.99 one-time = $132.18 savings)
```

---

### Adherence Tracking

**High priority** - Visibility into patient adherence enables proactive intervention.

| Decision | Choice |
|----------|--------|
| Tracking method | Patient logs doses in mobile app |
| Reminder integration | Mark as taken from reminder notification |
| Provider visibility | Dashboard showing adherence % by patient |
| Alerts | Flag patients with adherence < 70% |

#### Adherence Data Model

```typescript
interface DoseLog {
  id: string;
  patientId: string;
  prescriptionId: string;
  medicationId: string;

  scheduledDate: Date;
  scheduledTime: 'morning' | 'midday' | 'evening' | 'bedtime';

  status: 'taken' | 'missed' | 'skipped' | 'late' | 'pending';

  loggedAt?: Date;
  logMethod: 'app_manual' | 'reminder_tap' | 'auto_inferred' | 'provider_logged';

  skipReason?: 'forgot' | 'side_effects' | 'ran_out' | 'felt_fine' | 'other';
  notes?: string;

  createdAt: Date;
}

interface PatientAdherenceSummary {
  patientId: string;
  calculatedAt: Date;

  periods: {
    last7Days: AdherencePeriod;
    last30Days: AdherencePeriod;
    last90Days: AdherencePeriod;
    allTime: AdherencePeriod;
  };

  currentStreak: number;  // Consecutive 100% days
  longestStreak: number;

  byMedication: MedicationAdherence[];

  riskLevel: 'on_track' | 'needs_attention' | 'at_risk';
  riskFactors: string[];

  lastDoseLoggedAt?: Date;
}

interface AdherencePeriod {
  adherencePercent: number;
  dosesTaken: number;
  dosesScheduled: number;
  dosesMissed: number;
  dosesSkipped: number;
  trend: 'improving' | 'stable' | 'declining';
}

interface MedicationAdherence {
  prescriptionId: string;
  medicationName: string;
  adherencePercent: number;
  dosesTaken: number;
  dosesScheduled: number;
  lastTakenAt?: Date;
  commonSkipReasons: string[];
}
```

#### Patient Mobile App - Dose Logging

```
┌─────────────────────────────────────────┐
│  Today's Medications          Feb 9     │
│                                         │
│  ☀️ Morning                             │
│  ┌─────────────────────────────────┐    │
│  │ ☑️ Semaglutide 0.5mg           │    │
│  │    Taken at 8:15 AM             │    │
│  └─────────────────────────────────┘    │
│  ┌─────────────────────────────────┐    │
│  │ ☐ Vitamin D 5000IU             │    │
│  │    [Take Now] [Skip] [Remind Later] │
│  └─────────────────────────────────┘    │
│                                         │
│  🌙 Bedtime                             │
│  ┌─────────────────────────────────┐    │
│  │ ○ Magnesium 400mg              │    │
│  │    Scheduled for 9:00 PM        │    │
│  └─────────────────────────────────┘    │
│                                         │
│  ─────────────────────────────────────  │
│  This Week: 85% · 12 day streak 🔥      │
└─────────────────────────────────────────┘
```

#### Provider Dashboard - Adherence View

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  Patient Adherence Dashboard                                                 │
│                                                                              │
│  Filter: [All Patients ▼] [Last 30 Days ▼] [All Medications ▼]              │
│                                                                              │
│  ⚠️ Needs Attention (3 patients)                                            │
│  ┌───────────────────────────────────────────────────────────────────────┐   │
│  │ Patient          │ Adherence │ Trend │ Primary Issue       │ Action  │   │
│  ├───────────────────────────────────────────────────────────────────────┤   │
│  │ Jane Doe         │ 45% 🔴    │ ↓     │ Missed 8 doses (B12)│ [Reach Out]│ │
│  │ John Smith       │ 62% 🟡    │ ↓     │ Skipping evenings   │ [Reach Out]│ │
│  │ Sarah Johnson    │ 68% 🟡    │ →     │ Ran out, no refill  │ [Send Refill]││
│  └───────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ✓ On Track (42 patients)                                                   │
│  ┌───────────────────────────────────────────────────────────────────────┐   │
│  │ Patient          │ Adherence │ Trend │ Streak    │ Last Dose          │   │
│  ├───────────────────────────────────────────────────────────────────────┤   │
│  │ Mike Williams    │ 98% 🟢    │ ↑     │ 45 days   │ Today, 8:00 AM     │   │
│  │ Emily Brown      │ 95% 🟢    │ →     │ 30 days   │ Today, 7:30 AM     │   │
│  │ ...              │           │       │           │                    │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  Aggregate Stats (Last 30 Days)                                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ Avg Adher.  │  │ At Risk     │  │ Auto-Refill │  │ Refill Rate │         │
│  │    87%      │  │    3        │  │    68%      │  │    82%      │         │
│  │   ↑ 4%      │  │   ↓ 2       │  │   ↑ 12%     │  │   ↑ 8%      │         │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### Individual Patient Adherence Detail

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  Adherence Detail: Jane Doe                                                  │
│                                                                              │
│  Overall Adherence (Last 30 Days)                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ ████████████████████░░░░░░░░░░░░░░░░░░░░  45%                       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│  Trend: Declining ↓ (was 72% last month)                                    │
│                                                                              │
│  By Medication:                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ Semaglutide 0.5mg   ████████████████████████████████████  92%      │    │
│  │ B12 Injection       █████████░░░░░░░░░░░░░░░░░░░░░░░░░░░  25%      │    │
│  │ Vitamin D 5000IU    ████████████████░░░░░░░░░░░░░░░░░░░░  40%      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  Recent Dose History:                                                        │
│  Feb 9  ☑️ Semaglutide  ❌ B12 (skipped: "side effects")  ❌ Vitamin D      │
│  Feb 8  ☑️ Semaglutide  ❌ B12 (missed)                   ☑️ Vitamin D      │
│  Feb 7  ☑️ Semaglutide  ❌ B12 (missed)                   ❌ Vitamin D      │
│                                                                              │
│  Common Skip Reasons:                                                        │
│  • Side effects (B12): 4 times                                              │
│  • Forgot (Vitamin D): 6 times                                              │
│                                                                              │
│  Recommendations:                                                            │
│  • Discuss B12 side effects at next visit                                   │
│  • Suggest moving Vitamin D to morning routine                              │
│                                                                              │
│  [Send Adherence Check-in]  [Schedule Follow-up]  [Adjust Treatment Plan]   │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### Adherence Alerts & Automation

```typescript
const adherenceAlertRules = {
  patientAlerts: {
    missedDose: {
      trigger: 'dose_not_logged_within_2_hours',
      action: 'send_reminder_notification',
      message: "Don't forget your {{medication}} today!"
    },
    streakRisk: {
      trigger: 'streak_at_risk_end_of_day',
      action: 'send_encouragement',
      message: "You're on a {{streak}} day streak! Don't break it now."
    }
  },

  providerAlerts: {
    adherenceDropping: {
      trigger: 'adherence_below_70_percent_for_7_days',
      action: 'flag_for_outreach',
      priority: 'high'
    },
    missedMultipleDoses: {
      trigger: 'missed_3_consecutive_doses_same_medication',
      action: 'alert_provider',
      priority: 'medium'
    },
    sideEffectPattern: {
      trigger: 'skipped_for_side_effects_3_times',
      action: 'flag_for_clinical_review',
      priority: 'high'
    }
  },

  automations: {
    lowAdherenceOutreach: {
      trigger: 'adherence_below_60_percent_for_14_days',
      actions: [
        { type: 'send_sms', template: 'adherence_checkin' },
        { type: 'create_task', assignTo: 'care_coordinator' }
      ]
    }
  }
};
```

#### Real-Time Adherence Intervention

Proactive, immediate intervention when patients miss doses rather than waiting for scheduled check-ins.

| Decision | Choice |
|----------|--------|
| Detection method | Missed dose log + reminder no-response |
| Intervention timing | Escalating: 2 hours → 6 hours → 24 hours → care team |
| Channels | Push notification, SMS, phone call |
| Personalization | Based on patient preferences and medication criticality |

##### Real-Time Adherence Data Model

```typescript
interface AdherenceInterventionRule {
  id: string;
  medicationCategory: string;        // e.g., 'glp1', 'insulin', 'antidepressant'
  criticality: 'critical' | 'high' | 'medium' | 'low';

  escalationSteps: EscalationStep[];

  conditions: {
    consecutiveMissedDoses: number;
    timeWindowHours: number;
    patientRiskLevel?: 'high' | 'medium' | 'low';
    excludeIfReasonProvided: boolean;  // Don't escalate if patient logged skip reason
  };

  overridePatientPreferences: boolean; // For critical meds, may override quiet hours
}

interface EscalationStep {
  stepNumber: number;
  triggerAfterHours: number;          // Hours after scheduled dose time
  channels: ('push' | 'sms' | 'email' | 'phone')[];
  message: string;
  requiresAcknowledgement: boolean;
  notifyProvider: boolean;
  notifyPharmacist: boolean;
  createTask: boolean;
}

interface AdherenceIntervention {
  id: string;
  patientId: string;
  prescriptionId: string;
  medicationName: string;

  triggerEvent: {
    scheduledDoseTime: Date;
    doseLogId?: string;
    missedAt: Date;
    consecutiveMissedCount: number;
  };

  currentStep: number;
  status: 'active' | 'acknowledged' | 'dose_logged' | 'escalated' | 'expired' | 'care_team_resolved';

  escalationHistory: {
    stepNumber: number;
    executedAt: Date;
    channel: string;
    messageId?: string;
    deliveryStatus: 'sent' | 'delivered' | 'failed';
    patientResponse?: 'acknowledged' | 'dose_logged' | 'skip_logged' | 'no_response';
    responseAt?: Date;
  }[];

  resolution?: {
    resolvedAt: Date;
    resolvedBy: 'patient' | 'provider' | 'pharmacist' | 'care_coordinator' | 'system';
    resolution: 'dose_taken' | 'skip_documented' | 'prescription_adjusted' | 'no_action_needed' | 'patient_unreachable';
    notes?: string;
  };

  createdAt: Date;
  updatedAt: Date;
}
```

##### Intervention Rules by Medication Type

```typescript
const interventionRulesByCategory: AdherenceInterventionRule[] = [
  {
    id: 'insulin-critical',
    medicationCategory: 'insulin',
    criticality: 'critical',
    escalationSteps: [
      {
        stepNumber: 1,
        triggerAfterHours: 1,
        channels: ['push', 'sms'],
        message: 'Reminder: Your insulin dose was scheduled for {{time}}. Please log when you take it.',
        requiresAcknowledgement: false,
        notifyProvider: false,
        notifyPharmacist: false,
        createTask: false
      },
      {
        stepNumber: 2,
        triggerAfterHours: 3,
        channels: ['push', 'sms', 'phone'],
        message: 'We noticed you haven\'t logged your insulin. Are you okay? Please respond or log your dose.',
        requiresAcknowledgement: true,
        notifyProvider: false,
        notifyPharmacist: true,
        createTask: true
      },
      {
        stepNumber: 3,
        triggerAfterHours: 6,
        channels: ['phone'],
        message: null,  // Phone call from care team
        requiresAcknowledgement: true,
        notifyProvider: true,
        notifyPharmacist: true,
        createTask: true
      }
    ],
    conditions: {
      consecutiveMissedDoses: 1,
      timeWindowHours: 6,
      excludeIfReasonProvided: true
    },
    overridePatientPreferences: true
  },
  {
    id: 'glp1-high',
    medicationCategory: 'glp1',
    criticality: 'high',
    escalationSteps: [
      {
        stepNumber: 1,
        triggerAfterHours: 24,
        channels: ['push'],
        message: 'Reminder: Your weekly Semaglutide dose was scheduled for yesterday. Would you like to take it today?',
        requiresAcknowledgement: false,
        notifyProvider: false,
        notifyPharmacist: false,
        createTask: false
      },
      {
        stepNumber: 2,
        triggerAfterHours: 72,
        channels: ['push', 'sms'],
        message: 'You\'ve missed your Semaglutide dose this week. Missing doses can affect your progress. Need help?',
        requiresAcknowledgement: false,
        notifyProvider: false,
        notifyPharmacist: false,
        createTask: false
      },
      {
        stepNumber: 3,
        triggerAfterHours: 168,  // 1 week
        channels: ['sms', 'email'],
        message: 'We noticed you\'ve missed your GLP-1 dose. Your care team is here to help if you\'re experiencing side effects.',
        requiresAcknowledgement: false,
        notifyProvider: true,
        notifyPharmacist: false,
        createTask: true
      }
    ],
    conditions: {
      consecutiveMissedDoses: 1,
      timeWindowHours: 168,
      excludeIfReasonProvided: true
    },
    overridePatientPreferences: false
  },
  {
    id: 'antidepressant-high',
    medicationCategory: 'antidepressant',
    criticality: 'high',
    escalationSteps: [
      {
        stepNumber: 1,
        triggerAfterHours: 2,
        channels: ['push'],
        message: 'Friendly reminder: Time for your {{medicationName}}. Tap to log.',
        requiresAcknowledgement: false,
        notifyProvider: false,
        notifyPharmacist: false,
        createTask: false
      },
      {
        stepNumber: 2,
        triggerAfterHours: 24,
        channels: ['push', 'sms'],
        message: 'We noticed you missed your {{medicationName}} yesterday. It\'s important to take it consistently.',
        requiresAcknowledgement: false,
        notifyProvider: false,
        notifyPharmacist: false,
        createTask: false
      },
      {
        stepNumber: 3,
        triggerAfterHours: 72,
        channels: ['sms'],
        message: 'You\'ve missed 3 doses of {{medicationName}}. Stopping suddenly can cause withdrawal. Please reach out if you need help.',
        requiresAcknowledgement: false,
        notifyProvider: true,
        notifyPharmacist: true,
        createTask: true
      }
    ],
    conditions: {
      consecutiveMissedDoses: 3,
      timeWindowHours: 72,
      excludeIfReasonProvided: true
    },
    overridePatientPreferences: false
  }
];
```

##### Real-Time Processing Engine

```typescript
interface AdherenceMonitoringService {
  checkForMissedDoses: () => Promise<MissedDoseCheck[]>;
  processIntervention: (interventionId: string) => Promise<void>;
  handlePatientResponse: (interventionId: string, response: PatientResponse) => Promise<void>;
  escalateToNextStep: (interventionId: string) => Promise<void>;
}

interface MissedDoseCheck {
  patientId: string;
  prescriptionId: string;
  scheduledDose: {
    scheduledAt: Date;
    medicationName: string;
    doseAmount: string;
  };
  hoursSinceScheduled: number;
  hasSkipReason: boolean;
  interventionRule: AdherenceInterventionRule;
  shouldIntervene: boolean;
}

const adherenceMonitoringSchedule = {
  checkFrequency: 'every_15_minutes',
  quietHoursRespected: true,  // Except for critical meds
  quietHours: { start: '22:00', end: '07:00' },
  batchSize: 100,  // Process 100 patients per check
  retryOnFailure: true
};
```

##### Intervention Dashboard (Provider View)

```
┌─────────────────────────────────────────────────────────────────────┐
│ ADHERENCE ALERTS                                    Live Monitoring │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 🔴 CRITICAL (2)                                                     │
│ ┌─────────────────────────────────────────────────────────────────┐ │
│ │ Sarah M. · Insulin Lispro · Missed 2 doses                      │ │
│ │ Last dose: Yesterday 6:00 PM · No response to outreach          │ │
│ │ Escalation: Step 3 (Phone call attempted, no answer)            │ │
│ │ [View Patient] [Call Now] [Send Message] [Mark Resolved]        │ │
│ └─────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│ ⚠️ HIGH PRIORITY (5)                                                │
│ ┌─────────────────────────────────────────────────────────────────┐ │
│ │ Michael T. · Semaglutide 1mg · Missed weekly dose               │ │
│ │ Due: Feb 5 · Current step: 2 (SMS sent)                         │ │
│ │ Pattern: This is 3rd missed dose in 2 months                    │ │
│ │ [View Patient] [Schedule Call] [Adjust Treatment]               │ │
│ └─────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│ 📊 TODAY'S ADHERENCE SUMMARY                                        │
│ ┌───────────────────┬─────────────────┬─────────────────┐           │
│ │ Doses Scheduled   │ Doses Logged    │ Interventions   │           │
│ │       234         │     198 (85%)   │      12         │           │
│ └───────────────────┴─────────────────┴─────────────────┘           │
└─────────────────────────────────────────────────────────────────────┘
```

##### Patient Response Handling

```typescript
interface PatientResponse {
  interventionId: string;
  responseType: 'dose_taken' | 'will_take_now' | 'skipping' | 'need_help' | 'stop_reminders';
  responseChannel: 'app_tap' | 'sms_reply' | 'phone_call';
  timestamp: Date;

  doseLogged?: {
    takenAt: Date;
    takenLate: boolean;
    lateByHours: number;
  };

  skipReason?: string;

  helpRequest?: {
    issue: 'side_effects' | 'confusion' | 'cost' | 'forgot' | 'other';
    details?: string;
    callbackRequested: boolean;
  };
}

const responseActions = {
  dose_taken: {
    action: 'Close intervention, log dose',
    followUp: 'none'
  },
  will_take_now: {
    action: 'Pause escalation for 2 hours, await dose log',
    followUp: 'check_in_2_hours'
  },
  skipping: {
    action: 'Log skip with reason, close intervention',
    followUp: 'review_if_pattern'
  },
  need_help: {
    action: 'Create care team task, pause automated escalation',
    followUp: 'care_team_callback'
  },
  stop_reminders: {
    action: 'Respect preference, alert provider, document refusal',
    followUp: 'provider_review_required'
  }
};
```

---

### Treatment Plan Templates

**High priority** - Evidence-based protocols accelerate prescribing and standardize care.

| Decision | Choice |
|----------|--------|
| Template types | Platform-provided + provider-created |
| Sharing | Providers can share templates |
| Categories | Weight loss, HRT, thyroid, sexual health, wellness |
| Components | Medications, supplements, labs, lifestyle |

#### Treatment Plan Template Data Model

```typescript
interface TreatmentPlanTemplate {
  id: string;
  name: string;
  description: string;
  shortDescription: string;  // For list views

  category: 'weight_loss' | 'hrt_male' | 'hrt_female' | 'thyroid' | 'sexual_health' | 'general_wellness' | 'custom';
  subcategory?: string;
  tags: string[];

  source: 'platform' | 'provider_created' | 'community';
  visibility: 'private' | 'organization' | 'public';

  createdBy: string;
  organizationId?: string;

  items: TreatmentPlanItem[];

  // Clinical guidance
  indications: string[];
  contraindications: string[];
  monitoringRequirements: string[];
  patientCriteria: PatientCriteria;

  // Evidence
  supportingEvidence: EvidenceReference[];
  clinicalNotes: string;

  // Usage stats
  usageCount: number;
  rating?: number;
  reviewCount?: number;

  version: number;
  isActive: boolean;

  createdAt: Date;
  updatedAt: Date;
  publishedAt?: Date;
}

interface TreatmentPlanItem {
  id: string;
  sequence: number;
  type: 'medication' | 'supplement' | 'lab' | 'lifestyle' | 'follow_up';

  // For medications/supplements
  productId?: string;
  productName: string;
  productCategory?: string;

  defaultDose?: string;
  defaultFrequency?: string;
  defaultDuration?: string;
  defaultQuantity?: number;
  defaultRefills?: number;
  directions?: string;

  // For labs
  labTestId?: string;
  labTestName?: string;
  labFrequency?: string;  // "baseline", "6 weeks", "12 weeks", "quarterly"
  labRequiredBefore?: string;  // "first_prescription", "each_refill"

  // For lifestyle
  recommendation?: string;
  category?: 'diet' | 'exercise' | 'sleep' | 'stress' | 'other';

  // For follow-up
  followUpType?: 'visit' | 'check_in' | 'lab_review';
  followUpTiming?: string;

  isRequired: boolean;
  isSubstitutable: boolean;
  alternativeProducts?: string[];  // Product IDs

  notes?: string;
  patientInstructions?: string;
}

interface PatientCriteria {
  ageMin?: number;
  ageMax?: number;
  gender?: 'male' | 'female' | 'any';
  bmiMin?: number;
  bmiMax?: number;
  requiredConditions?: string[];
  excludedConditions?: string[];
  requiredLabValues?: LabCriteria[];
}

interface EvidenceReference {
  type: 'study' | 'guideline' | 'review' | 'expert_opinion';
  title: string;
  authors?: string;
  publication?: string;
  year?: number;
  url?: string;
  summary?: string;
}
```

#### Platform-Provided Templates

```typescript
const platformTemplates: Partial<TreatmentPlanTemplate>[] = [
  {
    name: 'GLP-1 Weight Loss Protocol',
    category: 'weight_loss',
    description: 'Standard semaglutide titration protocol for weight management with monitoring.',
    items: [
      {
        type: 'medication',
        productName: 'Semaglutide',
        defaultDose: '0.25mg',
        defaultFrequency: 'Weekly',
        defaultDuration: '4 weeks',
        directions: 'Inject subcutaneously once weekly. Titrate per schedule.',
        notes: 'Start low, titrate every 4 weeks: 0.25mg → 0.5mg → 1mg → 1.7mg → 2.4mg',
        isRequired: true
      },
      {
        type: 'supplement',
        productName: 'Vitamin B12 1000mcg',
        defaultFrequency: 'Daily',
        directions: 'Take daily to prevent B12 deficiency common with GLP-1s.',
        isRequired: false
      },
      {
        type: 'lab',
        labTestName: 'Comprehensive Metabolic Panel',
        labFrequency: 'Baseline, 12 weeks',
        labRequiredBefore: 'first_prescription',
        isRequired: true
      },
      {
        type: 'lab',
        labTestName: 'Lipid Panel',
        labFrequency: 'Baseline, 12 weeks',
        isRequired: true
      },
      {
        type: 'lab',
        labTestName: 'HbA1c',
        labFrequency: 'Baseline, 12 weeks',
        isRequired: true
      },
      {
        type: 'lifestyle',
        recommendation: 'High-protein diet (0.8-1g protein per lb goal body weight)',
        category: 'diet',
        isRequired: false
      },
      {
        type: 'follow_up',
        followUpType: 'check_in',
        followUpTiming: '4 weeks',
        notes: 'Assess tolerance, titrate dose if appropriate',
        isRequired: true
      }
    ],
    patientCriteria: {
      ageMin: 18,
      bmiMin: 27
    },
    contraindications: [
      'Personal or family history of medullary thyroid carcinoma',
      'Multiple Endocrine Neoplasia syndrome type 2',
      'Pregnancy or planning pregnancy'
    ],
    monitoringRequirements: [
      'Weight at each visit',
      'Blood pressure at each visit',
      'Labs at baseline and 12 weeks'
    ]
  },
  {
    name: 'Male HRT - Testosterone Replacement',
    category: 'hrt_male',
    description: 'Standard testosterone cypionate protocol for male hypogonadism.',
    items: [
      {
        type: 'medication',
        productName: 'Testosterone Cypionate 200mg/mL',
        defaultDose: '100mg',
        defaultFrequency: 'Weekly',
        directions: 'Inject intramuscularly or subcutaneously once weekly.',
        isRequired: true
      },
      {
        type: 'medication',
        productName: 'Anastrozole 1mg',
        defaultDose: '0.5mg',
        defaultFrequency: 'Twice weekly',
        directions: 'Take as needed based on estradiol levels.',
        notes: 'Add if E2 > 50 pg/mL on follow-up labs',
        isRequired: false
      },
      {
        type: 'lab',
        labTestName: 'Total Testosterone',
        labFrequency: 'Baseline, 6 weeks, 12 weeks, then quarterly',
        labRequiredBefore: 'first_prescription',
        isRequired: true
      },
      {
        type: 'lab',
        labTestName: 'Free Testosterone',
        labFrequency: 'Baseline, 12 weeks',
        isRequired: true
      },
      {
        type: 'lab',
        labTestName: 'Estradiol',
        labFrequency: 'Baseline, 6 weeks, 12 weeks',
        isRequired: true
      },
      {
        type: 'lab',
        labTestName: 'CBC with Differential',
        labFrequency: 'Baseline, 12 weeks, then biannually',
        notes: 'Monitor hematocrit - hold if > 54%',
        isRequired: true
      },
      {
        type: 'lab',
        labTestName: 'PSA',
        labFrequency: 'Baseline, 12 weeks, then annually',
        notes: 'Required for men over 40',
        isRequired: true
      },
      {
        type: 'follow_up',
        followUpType: 'visit',
        followUpTiming: '6 weeks',
        notes: 'Review initial labs, assess symptoms, adjust dose',
        isRequired: true
      }
    ],
    patientCriteria: {
      gender: 'male',
      ageMin: 18,
      requiredLabValues: [
        { test: 'Total Testosterone', operator: 'less_than', value: 300, unit: 'ng/dL' }
      ]
    },
    contraindications: [
      'Prostate cancer',
      'Breast cancer',
      'Untreated severe sleep apnea',
      'Hematocrit > 54%',
      'Uncontrolled heart failure'
    ]
  },
  {
    name: 'Female HRT - Perimenopause',
    category: 'hrt_female',
    description: 'Bioidentical hormone therapy for perimenopausal symptoms.',
    items: [
      {
        type: 'medication',
        productName: 'Estradiol Cream',
        defaultDose: '0.5mg',
        defaultFrequency: 'Daily',
        directions: 'Apply to inner arm or thigh daily.',
        isRequired: true
      },
      {
        type: 'medication',
        productName: 'Progesterone 100mg',
        defaultDose: '100mg',
        defaultFrequency: 'Nightly',
        directions: 'Take orally at bedtime.',
        notes: 'Required for women with intact uterus',
        isRequired: true
      },
      {
        type: 'lab',
        labTestName: 'Estradiol',
        labFrequency: 'Baseline, 8 weeks',
        isRequired: true
      },
      {
        type: 'lab',
        labTestName: 'FSH',
        labFrequency: 'Baseline',
        isRequired: true
      },
      {
        type: 'lab',
        labTestName: 'Progesterone',
        labFrequency: 'Baseline, 8 weeks',
        isRequired: true
      },
      {
        type: 'follow_up',
        followUpType: 'check_in',
        followUpTiming: '4 weeks',
        notes: 'Symptom assessment',
        isRequired: true
      }
    ],
    patientCriteria: {
      gender: 'female',
      ageMin: 35,
      ageMax: 60
    }
  }
];
```

#### Provider Template Usage Flow

```
Provider starts new prescription
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│  Start from Template (Optional)                             │
│                                                             │
│  [Search templates...]                                      │
│                                                             │
│  Recommended for this patient:                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ 📋 GLP-1 Weight Loss Protocol                       │    │
│  │    Standard semaglutide titration with monitoring   │    │
│  │    ⭐ 4.8 (234 uses)  |  Platform template          │    │
│  │    [Use This Template]                              │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  All Templates:                                             │
│  ├── Weight Loss (3)                                        │
│  ├── Male HRT (2)                                           │
│  ├── Female HRT (4)                                         │
│  ├── Thyroid (2)                                            │
│  └── My Templates (5)                                       │
│                                                             │
│  [Start from Scratch]                                       │
└─────────────────────────────────────────────────────────────┘
         │
         ▼
Provider selects template
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│  Customize Treatment Plan                                    │
│                                                             │
│  Template: GLP-1 Weight Loss Protocol                       │
│                                                             │
│  Medications:                                               │
│  ☑️ Semaglutide 0.25mg weekly         [Edit] [Remove]      │
│     Titrate: 0.25 → 0.5 → 1mg → 1.7 → 2.4mg                │
│  ☑️ Vitamin B12 1000mcg daily         [Edit] [Remove]      │
│  [+ Add Medication]                                         │
│                                                             │
│  Labs (Required before prescribing):                        │
│  ☑️ Comprehensive Metabolic Panel     [Edit] [Remove]      │
│  ☑️ Lipid Panel                       [Edit] [Remove]      │
│  ☑️ HbA1c                             [Edit] [Remove]      │
│  [+ Add Lab]                                                │
│                                                             │
│  Follow-up:                                                 │
│  ☑️ Check-in at 4 weeks               [Edit] [Remove]      │
│  [+ Add Follow-up]                                          │
│                                                             │
│  [Save as My Template]  [Apply to Patient]                  │
└─────────────────────────────────────────────────────────────┘
```

#### Template Management

```
Provider visits Template Library
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│  Treatment Plan Templates                                    │
│                                                             │
│  [Platform Templates] [My Templates] [Organization] [Community]│
│                                                             │
│  My Templates (5)                                           │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ 📋 My GLP-1 Protocol (Modified)           [Private] │    │
│  │    Based on: GLP-1 Weight Loss Protocol             │    │
│  │    Used 23 times  |  Last used: Feb 8              │    │
│  │    [Edit] [Duplicate] [Share] [Delete]              │    │
│  └─────────────────────────────────────────────────────┘    │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ 📋 Low-Dose TRT Protocol                  [Private] │    │
│  │    Custom template                                  │    │
│  │    Used 45 times  |  Last used: Feb 7              │    │
│  │    [Edit] [Duplicate] [Share] [Delete]              │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  [+ Create New Template]                                    │
└─────────────────────────────────────────────────────────────┘
```

---

## Surescripts Integration Architecture

This section defines the comprehensive Surescripts integration for bidirectional prescription data exchange, benefit intelligence, and care coordination.

### Integration Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      SURESCRIPTS INTEGRATION ARCHITECTURE                    │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                           SURESCRIPTS NETWORK                                │
├─────────────────────────────────────────────────────────────────────────────┤
│  External EHRs  │  External Pharmacies  │  PBMs  │  Hospitals  │  Payers   │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    ▼               ▼               ▼
        ┌───────────────┐  ┌───────────────┐  ┌───────────────┐
        │   INBOUND     │  │   OUTBOUND    │  │   QUERIES     │
        │   MESSAGES    │  │   MESSAGES    │  │               │
        ├───────────────┤  ├───────────────┤  ├───────────────┤
        │ • NewRx       │  │ • RxFill      │  │ • RTPB        │
        │ • RxRenewal   │  │ • Dispense    │  │ • Med History │
        │ • RxChange    │  │ • Ship Status │  │ • Eligibility │
        │ • CancelRx    │  │ • Delivery    │  │ • Formulary   │
        │ • RxTransfer  │  │               │  │               │
        └───────────────┘  └───────────────┘  └───────────────┘
                    │               │               │
                    └───────────────┼───────────────┘
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      SURESCRIPTS MESSAGE ROUTER                              │
│  • NCPDP SCRIPT v2017071 parsing                                            │
│  • Message validation & acknowledgment                                       │
│  • Routing to appropriate service                                            │
│  • Audit logging                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
        ┌───────────────────────────┼───────────────────────────┐
        ▼                           ▼                           ▼
┌───────────────┐          ┌───────────────┐          ┌───────────────┐
│  Prescription │          │   Benefits    │          │     Care      │
│    Service    │          │   Service     │          │ Coordination  │
└───────────────┘          └───────────────┘          └───────────────┘
```

### NCPDP SCRIPT Transaction Types Supported

| Transaction | Direction | Purpose | Status |
|-------------|-----------|---------|--------|
| **NewRx** | Inbound | Receive prescriptions from external providers | Critical |
| **RxFill** | Outbound | Send fill/dispense status to prescribers | High |
| **RxRenewal** | Inbound | Receive refill authorization requests | High |
| **RxRenewalResponse** | Outbound | Respond to renewal requests | High |
| **RxChange** | Inbound | Receive therapeutic interchange requests | Medium |
| **RxChangeResponse** | Outbound | Respond to change requests | Medium |
| **CancelRx** | Inbound | Receive cancellation requests | Medium |
| **CancelRxResponse** | Outbound | Acknowledge cancellations | Medium |
| **RxTransfer** | Bidirectional | Pharmacy-to-pharmacy transfers | Medium |
| **Status** | Outbound | Acknowledgment messages | Required |
| **Error** | Outbound | Error responses | Required |

---

### Inbound E-Prescribing (NewRx Receiving)

**Critical** - Enables receiving prescriptions from any Surescripts-connected EHR/provider.

#### Requirements

| Requirement | Implementation |
|-------------|----------------|
| Message format | NCPDP SCRIPT v2017071 |
| Certification | Surescripts pharmacy certification required |
| Response time | Acknowledgment within 24 hours (industry standard) |
| EPCS support | Must support DEA EPCS for Schedule II-V |

#### NewRx Receiving Flow

```
External Provider prescribes in their EHR
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Surescripts Network routes NewRx to our pharmacy                           │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  INBOUND MESSAGE PROCESSOR                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 1. Parse NCPDP SCRIPT XML                                               ││
│  │ 2. Validate message structure                                           ││
│  │ 3. Verify digital signature (EPCS)                                      ││
│  │ 4. Send acknowledgment (Status message)                                 ││
│  └─────────────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  PATIENT MATCHING                                                            │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ Match on: First Name + Last Name + DOB + Address/ZIP                    ││
│  │ ├── Exact match → Link to existing patient                             ││
│  │ ├── Fuzzy match → Flag for manual review                               ││
│  │ └── No match → Create new patient record                               ││
│  └─────────────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  PRESCRIPTION VALIDATION                                                     │
│  ├── Drug interaction check (against known medications)                     │
│  ├── Allergy check (if patient has allergies on file)                       │
│  ├── PDMP lookup (if controlled substance)                                  │
│  ├── DEA validation (prescriber DEA number)                                 │
│  ├── State license validation (prescriber in valid state)                   │
│  └── Quantity/days supply validation                                        │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  PHARMACIST REVIEW QUEUE                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ 📥 New E-Prescriptions                              [Filter] [Sort]     ││
│  │ ─────────────────────────────────────────────────────────────────────── ││
│  │ │ Priority │ Patient      │ Drug           │ Prescriber    │ Status   │││
│  │ │ 🔴 High  │ John Smith   │ Testosterone   │ Dr. Williams  │ PDMP Req │││
│  │ │ 🟡 Med   │ Jane Doe     │ Semaglutide    │ Dr. Chen      │ Pending  │││
│  │ │ 🟢 Low   │ Bob Wilson   │ BPC-157        │ Dr. Patel     │ Pending  │││
│  │ ─────────────────────────────────────────────────────────────────────── ││
│  └─────────────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
Pharmacist reviews and approves → Prescription enters compounding queue
```

#### Inbound Prescription Data Model

```typescript
interface InboundPrescription {
  id: string;

  // Surescripts message tracking
  surescriptsMessageId: string;
  surescriptsTransactionId: string;
  messageVersion: 'SCRIPT_2017071';
  receivedAt: Date;
  acknowledgedAt: Date;

  // Message status
  processingStatus:
    | 'received'
    | 'acknowledged'
    | 'patient_matching'
    | 'validation'
    | 'pending_review'
    | 'approved'
    | 'rejected'
    | 'error';

  // Patient info from message (pre-matching)
  inboundPatient: {
    firstName: string;
    lastName: string;
    middleName?: string;
    dateOfBirth: Date;
    gender: 'M' | 'F' | 'U';
    address: {
      street1: string;
      street2?: string;
      city: string;
      state: string;
      zipCode: string;
    };
    phone?: string;
  };

  // Matched patient (after patient matching)
  matchedPatientId?: string;
  matchConfidence: 'exact' | 'fuzzy' | 'manual' | 'new_patient';

  // Prescriber info
  prescriber: {
    npi: string;
    deaNumber?: string;
    firstName: string;
    lastName: string;
    credentials: string;
    phone: string;
    fax?: string;
    address: {
      practiceName?: string;
      street1: string;
      city: string;
      state: string;
      zipCode: string;
    };
  };

  // Prescription details
  medication: {
    drugName: string;
    ndc?: string;
    rxNormCode?: string;
    strength: string;
    dosageForm: string;
    quantity: number;
    quantityUnitOfMeasure: string;
    daysSupply: number;
    directions: string;  // SIG
    refillsAuthorized: number;
    substitutionAllowed: boolean;
    priorAuthorizationNumber?: string;
  };

  // Controlled substance info
  controlledSubstance?: {
    deaSchedule: 'II' | 'III' | 'IV' | 'V';
    digitalSignature: string;
    signatureTimestamp: Date;
    epcsVerified: boolean;
  };

  // Validation results
  validationResults: {
    drugInteractions: DrugInteraction[];
    allergyAlerts: AllergyAlert[];
    pdmpResults?: PDMPLookup;
    prescriberValid: boolean;
    quantityValid: boolean;
    overallStatus: 'pass' | 'warnings' | 'requires_review' | 'reject';
  };

  // Review tracking
  reviewedBy?: string;
  reviewedAt?: Date;
  reviewNotes?: string;
  rejectionReason?: string;
}

interface DrugInteraction {
  interactingDrug: string;
  severity: 'contraindicated' | 'major' | 'moderate' | 'minor';
  description: string;
  source: string;
}

interface AllergyAlert {
  allergen: string;
  reaction: string;
  severity: 'severe' | 'moderate' | 'mild';
}
```

#### Pharmacist Review Interface

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  📋 E-Prescription Review                                          [Close] │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  PATIENT                           PRESCRIBER                               │
│  ┌───────────────────────────┐     ┌───────────────────────────────────┐   │
│  │ John Smith                │     │ Dr. Sarah Williams, MD            │   │
│  │ DOB: 1985-03-15           │     │ NPI: 1234567890                   │   │
│  │ 123 Main St, Salt Lake    │     │ DEA: AW1234567                    │   │
│  │ City, UT 84101            │     │ Clinic: Wellness Medical Center   │   │
│  │                           │     │ Phone: (801) 555-0123             │   │
│  │ ✅ Matched to existing    │     │ ✅ DEA Valid  ✅ License Valid    │   │
│  │    patient #P-12345       │     │                                   │   │
│  └───────────────────────────┘     └───────────────────────────────────┘   │
│                                                                             │
│  MEDICATION                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Testosterone Cypionate 200mg/mL                                     │   │
│  │ NDC: 0591-3223-01                                                   │   │
│  │                                                                     │   │
│  │ Quantity: 10 mL          Days Supply: 70          Refills: 5       │   │
│  │                                                                     │   │
│  │ Directions: Inject 0.5mL intramuscularly every 7 days              │   │
│  │                                                                     │   │
│  │ 🔒 Schedule III Controlled Substance                                │   │
│  │ ✅ EPCS Signature Verified                                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ⚠️  ALERTS                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 🟡 PDMP Result: 2 controlled substance fills in past 90 days       │   │
│  │    - Testosterone Cypionate (this pharmacy) - 60 days ago          │   │
│  │    - Alprazolam 0.5mg (CVS #4521) - 45 days ago                    │   │
│  │                                                                     │   │
│  │ 🟢 No drug interactions detected                                    │   │
│  │ 🟢 No allergy alerts                                                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  Review Notes:                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Patient is established, continuing TRT therapy per provider.       │   │
│  │ Alprazolam is PRN anxiety from different provider - no concern.    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐    │
│  │ ✅ Approve      │  │ ⏸️ Hold         │  │ ❌ Reject               │    │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### Real-Time Prescription Benefit (RTPB)

**Critical** - Shows patient-specific out-of-pocket costs at point of prescribing.

#### RTPB vs Formulary Checking

| Feature | Formulary Check (Already Have) | RTPB (Adding) |
|---------|--------------------------------|---------------|
| **Data Source** | General formulary tiers | Patient's actual benefit plan |
| **Cost Info** | Tier level only | Exact copay/coinsurance amount |
| **Deductible** | Not included | Shows deductible remaining |
| **Alternatives** | Generic tier info | Priced alternatives specific to patient |
| **PA Required** | Yes/No flag | Yes/No with estimated approval time |
| **Real-time** | Cached formulary | Live query per patient |

#### RTPB Flow

```
Provider selects medication for patient
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  RTPB REQUEST                                                                │
│  ├── Patient ID (linked to insurance)                                       │
│  ├── Medication (NDC or RxNorm)                                             │
│  ├── Quantity                                                                │
│  ├── Days supply                                                             │
│  └── Pharmacy (our NCPDP ID)                                                 │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Surescripts RTPB API → PBM (CVS Caremark, Express Scripts, OptumRx, etc.)  │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  RTPB RESPONSE                                                               │
│  ├── Patient pay amount (copay/coinsurance)                                  │
│  ├── Plan pay amount                                                         │
│  ├── Deductible remaining                                                    │
│  ├── Out-of-pocket max remaining                                             │
│  ├── Prior authorization required? (Y/N)                                     │
│  ├── Step therapy required? (Y/N)                                            │
│  ├── Quantity limits                                                         │
│  └── Up to 5 therapeutic alternatives with pricing                           │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
Display to prescriber with alternatives
```

#### RTPB Data Model

```typescript
interface RTPBRequest {
  id: string;
  requestedAt: Date;

  // Patient
  patientId: string;
  memberId: string;
  payerId: string;
  groupNumber?: string;

  // Medication
  medication: {
    ndc?: string;
    rxNormCode?: string;
    drugName: string;
    quantity: number;
    daysSupply: number;
  };

  // Pharmacy
  pharmacyNcpdpId: string;
}

interface RTPBResponse {
  id: string;
  requestId: string;
  respondedAt: Date;

  // Response status
  status: 'success' | 'patient_not_found' | 'coverage_not_found' | 'error';

  // Primary medication pricing
  primaryMedication: {
    drugName: string;
    ndc: string;

    // Patient costs
    patientPayAmount: number;
    copayAmount?: number;
    coinsuranceAmount?: number;
    coinsurancePercent?: number;

    // Plan costs
    planPayAmount: number;
    ingredientCost: number;
    dispensingFee: number;

    // Benefit status
    deductibleRemaining: number;
    outOfPocketRemaining: number;
    benefitStage: 'deductible' | 'initial_coverage' | 'gap' | 'catastrophic';

    // Coverage details
    formularyStatus: 'on_formulary' | 'non_formulary' | 'not_covered';
    tierLevel?: number;
    tierName?: string;

    // Restrictions
    priorAuthRequired: boolean;
    priorAuthStatus?: 'required' | 'on_file' | 'approved' | 'denied';
    stepTherapyRequired: boolean;
    quantityLimitApplies: boolean;
    quantityLimit?: {
      maxQuantity: number;
      daysSupply: number;
    };
  };

  // Alternative medications (up to 5)
  alternatives: RTPBAlternative[];

  // Messages
  pbmMessages?: string[];
}

interface RTPBAlternative {
  drugName: string;
  ndc: string;
  genericIndicator: 'brand' | 'generic';

  // Cost comparison
  patientPayAmount: number;
  savingsVsPrimary: number;

  // Coverage
  formularyStatus: 'on_formulary' | 'preferred';
  tierLevel?: number;
  priorAuthRequired: boolean;

  // Therapeutic info
  therapeuticEquivalent: boolean;
  strengthComparison: string;
}
```

#### RTPB Display in Prescribing Interface

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  💊 Prescription: Semaglutide 2.4mg                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  PATIENT COST ESTIMATE                    COVERAGE STATUS                   │
│  ┌───────────────────────────────┐        ┌───────────────────────────┐    │
│  │  Patient Pays: $450.00        │        │  ✅ On Formulary (Tier 5)  │    │
│  │  ────────────────────────     │        │  ⚠️ Prior Auth Required    │    │
│  │  Copay:        $0.00          │        │  ✅ No Step Therapy        │    │
│  │  Coinsurance:  $450.00 (25%)  │        │  ✅ No Quantity Limits     │    │
│  │                               │        │                           │    │
│  │  Deductible remaining: $0     │        │  Benefit Stage:           │    │
│  │  OOP Max remaining: $2,150    │        │  Initial Coverage         │    │
│  └───────────────────────────────┘        └───────────────────────────┘    │
│                                                                             │
│  💡 LOWER-COST ALTERNATIVES                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Drug                    │ Patient Pays │ Savings  │ Notes           │   │
│  │ ─────────────────────────────────────────────────────────────────── │   │
│  │ Tirzepatide 2.5mg       │ $350.00      │ $100.00  │ ⚠️ PA Required  │   │
│  │ Liraglutide 1.8mg       │ $125.00      │ $325.00  │ ✅ No PA        │   │
│  │ Semaglutide 1mg (lower) │ $380.00      │ $70.00   │ ⚠️ PA Required  │   │
│  │ ─────────────────────────────────────────────────────────────────── │   │
│  │ [Select Alternative]                                                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  Cash Price Comparison: $425.00 (if patient pays cash through us)          │
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐    │
│  │ Prescribe       │  │ Select Alt      │  │ Prescribe Cash Price    │    │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### Medication History Integration

**High priority** - Pull 12-month prescription history from Surescripts for comprehensive medication reconciliation.

#### Medication History Sources

| Source | Data Included | Latency |
|--------|---------------|---------|
| **PBM Claims** | Insurance-paid fills | ~24 hours |
| **Pharmacy Dispense** | All fills including cash | ~24 hours |
| **Patient Reported** | Manual entry | Real-time |

#### Medication History Flow

```
Patient presents for care (new patient or visit)
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  MEDICATION HISTORY REQUEST                                                  │
│  ├── Patient demographics (name, DOB, gender, address)                       │
│  ├── Request type: 'ambulatory' | 'reconciliation'                           │
│  └── Date range: Last 12 months                                              │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Surescripts Medication History API                                          │
│  Queries: PBMs + Retail Pharmacies + Mail Order                              │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  RESPONSE PROCESSING                                                         │
│  ├── Parse medication list (NDC, drug name, SIG, quantity, dates)            │
│  ├── Normalize SIG (Surescripts Sig IQ)                                      │
│  ├── Deduplicate across sources                                              │
│  ├── Map to our drug database (RxNorm)                                       │
│  └── Flag potential interactions with current medications                    │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  RECONCILIATION WORKFLOW                                                     │
│  ├── Present medication list to provider                                     │
│  ├── Compare with patient-reported medications                               │
│  ├── Identify discrepancies                                                  │
│  └── Confirm/update medication list                                          │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### Medication History Data Model

```typescript
interface MedicationHistoryRequest {
  id: string;
  patientId: string;
  requestType: 'ambulatory' | 'reconciliation';
  requestedBy: string;  // Provider or system
  requestedAt: Date;

  // Patient demographics sent to Surescripts
  patientDemographics: {
    firstName: string;
    lastName: string;
    dateOfBirth: Date;
    gender: 'M' | 'F';
    address: {
      street1: string;
      city: string;
      state: string;
      zipCode: string;
    };
  };

  // Response tracking
  status: 'pending' | 'completed' | 'no_data' | 'error';
  respondedAt?: Date;
  medicationsReturned: number;
}

interface MedicationHistoryRecord {
  id: string;
  requestId: string;
  patientId: string;

  // Source
  source: 'pbm' | 'pharmacy' | 'patient_reported';
  sourceName?: string;  // e.g., "CVS Pharmacy #4521"

  // Medication info
  drugName: string;
  genericName?: string;
  ndc?: string;
  rxNormCode?: string;
  strength: string;
  dosageForm: string;

  // Prescription details
  quantity: number;
  daysSupply: number;
  directions: string;  // Original SIG
  directionsNormalized?: string;  // Sig IQ processed

  // Fill info
  fillDate: Date;
  writtenDate?: Date;
  expirationDate?: Date;
  refillsRemaining?: number;

  // Prescriber
  prescriberName?: string;
  prescriberNpi?: string;

  // Payment
  paymentType: 'insurance' | 'cash' | 'coupon' | 'unknown';

  // Reconciliation
  reconciledStatus: 'pending' | 'confirmed' | 'discontinued' | 'modified';
  reconciledBy?: string;
  reconciledAt?: Date;
  reconciledNotes?: string;

  // Discrepancy tracking
  discrepancyType?: 'not_reported' | 'different_dose' | 'different_frequency' | 'discontinued_by_patient';
}

interface MedicationReconciliationSession {
  id: string;
  patientId: string;
  providerId: string;
  sessionDate: Date;

  // Medications from different sources
  surescriptsMedications: MedicationHistoryRecord[];
  patientReportedMedications: PatientMedication[];

  // Reconciliation results
  reconciledMedications: ReconciledMedication[];
  discrepanciesIdentified: number;
  discrepanciesResolved: number;

  // Audit
  completedAt?: Date;
  completedBy?: string;
}

interface ReconciledMedication {
  medicationId: string;
  drugName: string;

  // Source comparison
  inSurescripts: boolean;
  inPatientReported: boolean;

  // Final status
  status: 'active' | 'discontinued' | 'modified' | 'new';
  finalDose?: string;
  finalFrequency?: string;

  // Resolution
  resolutionNotes?: string;
}
```

#### Medication Reconciliation Interface

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  📋 Medication Reconciliation - John Smith                        [Complete] │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Found 8 medications from Surescripts | 5 patient-reported | 2 discrepancies│
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ SURESCRIPTS HISTORY (Last 12 months)           ☑️ Select All        │   │
│  │ ─────────────────────────────────────────────────────────────────── │   │
│  │ ☑️ Testosterone Cyp 200mg    │ 0.5mL weekly IM │ CVS       │ Active │   │
│  │ ☑️ Metformin 500mg           │ 1 tab BID      │ Walgreens │ Active │   │
│  │ ☑️ Lisinopril 10mg           │ 1 tab daily    │ CVS       │ Active │   │
│  │ ☑️ Atorvastatin 20mg         │ 1 tab daily    │ CVS       │ Active │   │
│  │ ☐ Amoxicillin 500mg          │ Completed      │ Walgreens │ Dec 24 │   │
│  │ ⚠️ Alprazolam 0.5mg          │ 1 tab PRN      │ CVS       │ Active │   │
│  │    └─ Not in patient-reported list                                 │   │
│  │ ☑️ Omeprazole 20mg           │ 1 cap daily    │ Mail Order│ Active │   │
│  │ ⚠️ Sertraline 50mg           │ 1 tab daily    │ CVS       │ Jan 25 │   │
│  │    └─ Patient reports discontinued - side effects                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ PATIENT REPORTED (Not in Surescripts)                               │   │
│  │ ─────────────────────────────────────────────────────────────────── │   │
│  │ ☑️ Vitamin D3 5000 IU        │ 1 daily        │ OTC       │ Active │   │
│  │ ☑️ Fish Oil 1000mg           │ 2 daily        │ OTC       │ Active │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  DISCREPANCY RESOLUTION                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Alprazolam 0.5mg - Patient denies current use                       │   │
│  │ Resolution: [Mark Discontinued ▼] Note: [Patient states stopped 2mo]│   │
│  │                                                                     │   │
│  │ Sertraline 50mg - Patient reports discontinued                      │   │
│  │ Resolution: [Mark Discontinued ▼] Note: [D/C due to side effects  ]│   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────┐                                           │
│  │ ✅ Complete Reconciliation  │                                           │
│  └─────────────────────────────┘                                           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### RxFill Status Notifications

**High priority** - Send fill/dispense/ship status back to prescribing providers.

#### RxFill Message Types

| Status | When Sent | Purpose |
|--------|-----------|---------|
| **Partially Filled** | Partial dispense | Alert prescriber of partial fill |
| **Filled** | Compounding complete | Prescription ready |
| **Not Filled** | Unable to fill | Alert prescriber (out of stock, etc.) |
| **Transferred** | Rx transferred out | Prescription moved to another pharmacy |
| **Dispensed** | Picked up / shipped | Patient received medication |

#### RxFill Flow

```
Prescription status changes in our system
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STATUS CHANGE EVENT                                                         │
│  ├── compounding_complete → Send "Filled" status                             │
│  ├── shipped → Send "Dispensed-Shipped" status                               │
│  ├── delivered → Send "Dispensed-Delivered" status                           │
│  ├── out_of_stock → Send "Not Filled" with reason                            │
│  └── patient_declined → Send "Not Filled" with reason                        │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  RXFILL MESSAGE BUILDER                                                      │
│  ├── Reference original NewRx message ID                                     │
│  ├── Include fill details (quantity, date, NDC)                              │
│  ├── Include status code and description                                     │
│  └── Format as NCPDP SCRIPT RxFill                                           │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Surescripts Network → Route to prescriber's EHR                             │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
Prescriber sees fill status in their EHR
```

#### RxFill Data Model

```typescript
interface RxFillNotification {
  id: string;
  prescriptionId: string;

  // Reference to original prescription
  originalSurescriptsMessageId: string;
  originalTransactionId: string;

  // Status
  fillStatus:
    | 'filled'
    | 'partially_filled'
    | 'not_filled'
    | 'transferred'
    | 'dispensed_picked_up'
    | 'dispensed_shipped'
    | 'dispensed_delivered';

  // Fill details
  fillDetails: {
    quantityFilled: number;
    quantityRemaining?: number;
    daysSupplyFilled: number;
    fillDate: Date;
    ndc: string;
    lotNumber?: string;
    expirationDate?: Date;
  };

  // For partial or not filled
  reason?: {
    code: string;
    description: string;
  };

  // Shipping info (for mail order)
  shippingInfo?: {
    carrier: string;
    trackingNumber: string;
    estimatedDelivery: Date;
    deliveredAt?: Date;
  };

  // Message tracking
  sentAt: Date;
  acknowledgedAt?: Date;
  deliveryStatus: 'pending' | 'sent' | 'acknowledged' | 'error';
  errorDetails?: string;
}

// Status reason codes
const RxFillReasonCodes = {
  NOT_FILLED: {
    'AA': 'Patient Requested Not to Fill',
    'AB': 'Patient Deceased',
    'AC': 'Unable to Contact Patient',
    'AD': 'Insurance Rejected',
    'AE': 'Out of Stock',
    'AF': 'Drug Recall',
    'AG': 'Prescription Expired',
    'AH': 'Prior Authorization Required',
    'AI': 'Therapeutic Duplication',
    'AJ': 'Drug-Drug Interaction',
    'AK': 'Prescriber Requested Cancel',
  },
  PARTIAL_FILL: {
    'BA': 'Insufficient Inventory',
    'BB': 'Patient Request',
    'BC': 'Insurance Quantity Limit',
  }
};
```

#### RxFill Event Triggers

```typescript
const rxFillEventHandlers = {
  // When compounding is complete
  onCompoundingComplete: async (prescription: Prescription) => {
    await sendRxFill({
      prescriptionId: prescription.id,
      fillStatus: 'filled',
      fillDetails: {
        quantityFilled: prescription.quantity,
        fillDate: new Date(),
        ndc: prescription.ndc,
        lotNumber: prescription.batchRecord.lotNumber,
        expirationDate: prescription.batchRecord.expirationDate,
      }
    });
  },

  // When shipped
  onShipped: async (prescription: Prescription, shipment: Shipment) => {
    await sendRxFill({
      prescriptionId: prescription.id,
      fillStatus: 'dispensed_shipped',
      shippingInfo: {
        carrier: shipment.carrier,
        trackingNumber: shipment.trackingNumber,
        estimatedDelivery: shipment.estimatedDelivery,
      }
    });
  },

  // When delivered
  onDelivered: async (prescription: Prescription, delivery: DeliveryConfirmation) => {
    await sendRxFill({
      prescriptionId: prescription.id,
      fillStatus: 'dispensed_delivered',
      shippingInfo: {
        carrier: delivery.carrier,
        trackingNumber: delivery.trackingNumber,
        deliveredAt: delivery.deliveredAt,
      }
    });
  },

  // When unable to fill
  onCannotFill: async (prescription: Prescription, reason: string) => {
    await sendRxFill({
      prescriptionId: prescription.id,
      fillStatus: 'not_filled',
      reason: {
        code: mapReasonToCode(reason),
        description: reason,
      }
    });
  }
};
```

---

### RxRenewal Processing

**High priority** - Receive and process refill authorization requests from pharmacies via Surescripts.

#### RxRenewal Flow

```
Patient requests refill at pharmacy (or our platform for transferred Rx)
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Pharmacy sends RxRenewalRequest via Surescripts                             │
│  (Request for prescriber to authorize refill)                                │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  OUR SYSTEM RECEIVES RENEWAL REQUEST                                         │
│  ├── Parse NCPDP SCRIPT RxRenewalRequest                                     │
│  ├── Match to patient in our system                                          │
│  ├── Match to original prescription (if exists)                              │
│  └── Route to prescriber for review                                          │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  PRESCRIBER REVIEW                                                           │
│  ├── Approve as requested                                                    │
│  ├── Approve with changes (different quantity, strength, etc.)               │
│  ├── Deny with reason                                                        │
│  └── Request patient visit before renewal                                    │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Send RxRenewalResponse via Surescripts                                      │
│  ├── Approved → New prescription sent                                        │
│  ├── ApprovedWithChanges → Modified prescription sent                        │
│  ├── Denied → Denial reason sent                                             │
│  └── DeniedNewRxToFollow → Patient needs visit                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### RxRenewal Data Model

```typescript
interface RxRenewalRequest {
  id: string;

  // Surescripts message info
  surescriptsMessageId: string;
  surescriptsTransactionId: string;
  receivedAt: Date;

  // Requesting pharmacy
  requestingPharmacy: {
    ncpdpId: string;
    name: string;
    address: string;
    phone: string;
    fax?: string;
  };

  // Patient
  patient: {
    firstName: string;
    lastName: string;
    dateOfBirth: Date;
    gender: 'M' | 'F';
    address: string;
  };
  matchedPatientId?: string;

  // Original prescription (what they want renewed)
  originalPrescription: {
    drugName: string;
    strength: string;
    quantity: number;
    directions: string;
    writtenDate?: Date;
    lastFillDate?: Date;
    prescriberId?: string;
    prescriberName?: string;
  };

  // Status
  status:
    | 'pending'
    | 'assigned'
    | 'approved'
    | 'approved_with_changes'
    | 'denied'
    | 'expired';

  // Assignment
  assignedToProviderId?: string;
  assignedAt?: Date;

  // Response
  respondedAt?: Date;
  respondedBy?: string;
  responseType?: 'approved' | 'approved_with_changes' | 'denied' | 'denied_new_rx_to_follow';
  denialReason?: string;

  // New prescription (if approved)
  renewedPrescriptionId?: string;

  // SLA tracking
  dueBy: Date;  // Typically 48-72 hours
  isOverdue: boolean;
}

interface RxRenewalResponse {
  id: string;
  renewalRequestId: string;

  responseCode:
    | 'A'   // Approved
    | 'B'   // Approved with Changes
    | 'C'   // Denied - No More Refills
    | 'D'   // Denied - Patient Unknown
    | 'E'   // Denied - Prescriber Not Associated with Prescription
    | 'F'   // Denied - Request Not Processed
    | 'G'   // Denied - Medication Not Available
    | 'H'   // Denied - New Rx to Follow
    | 'J'   // Denied - Patient Visit Required
    | 'K'   // Denied - High Risk Medication
    | 'L'   // Denied - Contact Prescriber;

  // For approved/approved with changes
  newPrescription?: {
    drugName: string;
    strength: string;
    quantity: number;
    daysSupply: number;
    refills: number;
    directions: string;
  };

  // For denials
  denialReason?: string;

  // Message tracking
  sentAt: Date;
  acknowledgedAt?: Date;
}
```

#### RxRenewal Queue Interface

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  📋 Renewal Requests                                          [Filter ▼]    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ⚠️ 3 requests overdue  |  12 pending  |  45 completed today                │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Priority │ Patient     │ Medication      │ Pharmacy    │ Due     │ ▼│   │
│  │ ──────────────────────────────────────────────────────────────────│   │
│  │ 🔴 LATE  │ Jane Doe    │ Semaglutide 1mg │ CVS #4521   │ 2hr ago │   │
│  │ 🔴 LATE  │ Bob Smith   │ Testosterone C  │ Walgreens   │ 5hr ago │   │
│  │ 🟡 TODAY │ Mary Wilson │ Metformin 500mg │ Our Platform│ 4hr     │   │
│  │ 🟡 TODAY │ John Lee    │ Tirzepatide     │ CVS #2103   │ 6hr     │   │
│  │ 🟢 NORMAL│ Lisa Chen   │ Progesterone    │ Our Platform│ 24hr    │   │
│  │ 🟢 NORMAL│ Mike Brown  │ DHEA 25mg       │ Walmart     │ 36hr    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  📋 Renewal Request Detail                                         [Close] │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  PATIENT: Jane Doe (DOB: 1980-05-15)      REQUESTING: CVS Pharmacy #4521   │
│                                            1234 Main St, Salt Lake City    │
│                                            Phone: (801) 555-0100           │
│                                                                             │
│  MEDICATION REQUESTED                                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Semaglutide 1mg/0.5mL Injection                                     │   │
│  │ Quantity: 4 pens (1 month)                                          │   │
│  │ Directions: Inject 0.5mL subcutaneously once weekly                 │   │
│  │                                                                     │   │
│  │ Original Rx: 2025-08-15  |  Last Fill: 2026-01-10                   │   │
│  │ Refills Remaining: 0                                                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  PATIENT HISTORY                                                            │
│  ├── Last visit: 2025-11-20 - Weight management follow-up                  │
│  ├── Weight trend: 245 lbs → 218 lbs (-27 lbs)                             │
│  ├── Adherence: 94%                                                        │
│  └── Labs (2025-11-15): A1c 6.2%, Lipids WNL                               │
│                                                                             │
│  RESPONSE                                                                   │
│  ┌───────────────┐ ┌─────────────────────┐ ┌────────────────────────────┐  │
│  │ ✅ Approve    │ │ ✏️ Approve w/Changes│ │ ❌ Deny                    │  │
│  └───────────────┘ └─────────────────────┘ └────────────────────────────┘  │
│                                                                             │
│  Changes (if approving with changes):                                       │
│  Quantity: [4 pens    ▼]  Refills: [5 ▼]  Days Supply: [28 ▼]              │
│                                                                             │
│  Denial Reason (if denying):                                                │
│  [Patient needs follow-up visit - schedule appointment           ▼]        │
│                                                                             │
│  ┌──────────────────────┐                                                  │
│  │ Submit Response      │                                                  │
│  └──────────────────────┘                                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### First-Fill Abandonment Tracking

**High priority** - Track when patients don't pick up their first prescription and intervene.

#### First-Fill Abandonment Statistics

| Statistic | Value |
|-----------|-------|
| Industry abandonment rate | 20-30% for first fills |
| Specialty medication abandonment | Up to 40% |
| Cost to re-acquire abandoned patient | 5-10x retention cost |
| Window for intervention | 3-7 days optimal |

#### First-Fill Tracking Flow

```
Prescription dispensed (compounding complete, shipped, or ready for pickup)
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  START FIRST-FILL TRACKING                                                   │
│  ├── Mark prescription as "awaiting_first_fill"                              │
│  ├── Set expected pickup/delivery date                                       │
│  └── Schedule check-in reminders                                             │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ├─── Day 3: If not picked up → Send reminder SMS
         │
         ├─── Day 5: If not picked up → Pharmacist outreach call
         │
         ├─── Day 7: If not picked up → Alert prescriber
         │
         └─── Day 14: If not picked up → Mark abandoned, notify prescriber
                                        via Surescripts First-Fill service
```

#### First-Fill Abandonment Data Model

```typescript
interface FirstFillTracking {
  id: string;
  prescriptionId: string;
  patientId: string;

  // Prescription info
  drugName: string;
  isControlled: boolean;
  isSpecialty: boolean;

  // Timeline
  prescribedAt: Date;
  readyAt: Date;  // Compounding complete or shipped
  expectedPickupBy: Date;

  // Delivery method
  deliveryMethod: 'pickup' | 'mail_order' | 'courier';
  trackingNumber?: string;

  // Status
  status:
    | 'awaiting_pickup'
    | 'in_transit'
    | 'reminder_sent'
    | 'outreach_attempted'
    | 'picked_up'
    | 'delivered'
    | 'abandoned'
    | 'returned_to_stock';

  // Intervention tracking
  interventions: FirstFillIntervention[];

  // Outcome
  outcome?: {
    type: 'completed' | 'abandoned' | 'returned';
    date: Date;
    abandonmentReason?: string;
  };

  // Surescripts notification
  surescriptsNotificationSent: boolean;
  surescriptsNotificationDate?: Date;
}

interface FirstFillIntervention {
  id: string;
  type: 'sms_reminder' | 'email_reminder' | 'phone_call' | 'prescriber_alert';
  attemptedAt: Date;
  successful: boolean;

  // For phone calls
  callOutcome?: 'answered' | 'voicemail' | 'no_answer' | 'wrong_number';

  // Patient response
  patientResponse?: {
    willPickUp: boolean;
    newPickupDate?: Date;
    abandonmentReason?: string;
  };

  notes?: string;
  performedBy?: string;
}

// Abandonment reasons for analytics
const AbandonmentReasons = {
  COST: 'Cost too high',
  INSURANCE: 'Insurance issues',
  SIDE_EFFECTS_CONCERN: 'Concerned about side effects',
  FEELING_BETTER: 'Symptoms resolved',
  CHANGED_MIND: 'Decided not to take medication',
  GOT_ELSEWHERE: 'Filled at different pharmacy',
  FORGOT: 'Forgot to pick up',
  TRAVEL: 'Out of town',
  OTHER: 'Other',
};
```

#### First-Fill Dashboard

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  📊 First-Fill Tracking Dashboard                              [This Week] │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  SUMMARY                                                                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│  │ Awaiting    │  │ At Risk     │  │ Abandoned   │  │ Success     │       │
│  │     23      │  │     8       │  │     3       │  │    89%      │       │
│  │ pickups     │  │ (>3 days)   │  │ this week   │  │ fill rate   │       │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘       │
│                                                                             │
│  AT-RISK PRESCRIPTIONS (Require Intervention)                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Patient      │ Drug           │ Ready   │ Days │ Last Contact      │   │
│  │ ──────────────────────────────────────────────────────────────────  │   │
│  │ Jane Doe     │ Semaglutide    │ Feb 3   │ 6    │ SMS sent Feb 6    │   │
│  │              │ $425.00        │         │      │ [Call] [Alert Rx] │   │
│  │ Bob Smith    │ Testosterone   │ Feb 4   │ 5    │ No answer Feb 7   │   │
│  │              │ $89.00         │         │      │ [Retry] [Alert Rx]│   │
│  │ Mary Wilson  │ Tirzepatide    │ Feb 5   │ 4    │ Voicemail Feb 8   │   │
│  │              │ $550.00        │         │      │ [Retry] [Alert Rx]│   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ABANDONMENT REASONS (Last 30 Days)                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Cost too high          ████████████████████  45%                    │   │
│  │ Insurance issues       ████████████  28%                            │   │
│  │ Side effects concern   ████████  18%                                │   │
│  │ Other                  ████  9%                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### First-Fill Automation Rules

```typescript
const firstFillAutomationRules = {
  // Day 3: SMS reminder
  day3Reminder: {
    trigger: 'prescription_not_picked_up_after_3_days',
    condition: (rx: Prescription) => rx.deliveryMethod === 'pickup',
    actions: [
      { type: 'send_sms', template: 'first_fill_reminder' },
      { type: 'send_email', template: 'first_fill_reminder' },
    ]
  },

  // Day 5: Pharmacist outreach
  day5Outreach: {
    trigger: 'prescription_not_picked_up_after_5_days',
    actions: [
      { type: 'create_task', taskType: 'pharmacist_outreach_call' },
      { type: 'send_sms', template: 'first_fill_urgent' },
    ]
  },

  // Day 7: Alert prescriber
  day7PrescriberAlert: {
    trigger: 'prescription_not_picked_up_after_7_days',
    actions: [
      { type: 'notify_prescriber', method: 'in_app' },
      { type: 'send_clinical_message', template: 'first_fill_abandonment_risk' },
    ]
  },

  // Day 14: Mark abandoned
  day14Abandoned: {
    trigger: 'prescription_not_picked_up_after_14_days',
    actions: [
      { type: 'mark_abandoned' },
      { type: 'send_surescripts_notification' },
      { type: 'return_to_stock', condition: 'if_not_controlled' },
      { type: 'notify_prescriber', method: 'surescripts_first_fill' },
    ]
  },

  // Special handling for expensive medications
  highValueMedication: {
    trigger: 'prescription_value_over_500_not_picked_up_after_2_days',
    actions: [
      { type: 'create_task', taskType: 'pharmacist_outreach_call', priority: 'high' },
      { type: 'send_sms', template: 'first_fill_high_value' },
    ]
  },

  // Specialty medication handling
  specialtyMedication: {
    trigger: 'specialty_prescription_not_picked_up_after_1_day',
    actions: [
      { type: 'create_task', taskType: 'specialty_coordinator_outreach' },
      { type: 'send_sms', template: 'specialty_first_fill' },
    ]
  }
};
```

---

### Care Event Notifications (ADT)

**High priority** - Receive hospital admit/discharge/transfer alerts for care coordination.

#### ADT Event Types

| Event | Code | Use Case |
|-------|------|----------|
| **Admit** | A01 | Patient admitted to hospital |
| **Discharge** | A03 | Patient discharged from hospital |
| **Transfer** | A02 | Patient transferred between units/facilities |
| **ED Visit** | A04 | Emergency department registration |
| **ED Discharge** | A10 | Emergency department discharge |

#### Care Event Flow

```
Patient admitted to hospital (not our facility)
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Hospital sends ADT event via Surescripts Care Event Notifications          │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  OUR SYSTEM RECEIVES ADT                                                     │
│  ├── Parse HL7 ADT message                                                   │
│  ├── Match to patient in our system                                          │
│  └── Determine care coordination actions                                     │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ├─── Admit (A01) → Alert care team, hold auto-refills
         │
         ├─── Discharge (A03) → Schedule medication reconciliation,
         │                       prepare post-discharge medications
         │
         └─── ED Visit (A04) → Alert prescribing provider
```

#### Care Event Data Model

```typescript
interface CareEventNotification {
  id: string;

  // Surescripts message info
  surescriptsMessageId: string;
  receivedAt: Date;

  // Event type
  eventType: 'A01' | 'A02' | 'A03' | 'A04' | 'A10';
  eventTypeName: 'admit' | 'transfer' | 'discharge' | 'ed_registration' | 'ed_discharge';
  eventDateTime: Date;

  // Patient matching
  patient: {
    firstName: string;
    lastName: string;
    dateOfBirth: Date;
    gender: 'M' | 'F';
    mrn?: string;  // Hospital MRN
  };
  matchedPatientId?: string;
  matchConfidence: 'exact' | 'fuzzy' | 'no_match';

  // Facility
  facility: {
    name: string;
    npi?: string;
    address: string;
    phone?: string;
    type: 'hospital' | 'ed' | 'snf' | 'rehab' | 'ltach';
  };

  // Admission details (for admits)
  admissionDetails?: {
    admitType: 'emergency' | 'urgent' | 'elective' | 'newborn';
    admitSource: 'physician_referral' | 'transfer' | 'er' | 'other';
    chiefComplaint?: string;
    admittingDiagnosis?: string;
    attendingPhysician?: {
      name: string;
      npi?: string;
    };
  };

  // Discharge details (for discharges)
  dischargeDetails?: {
    dischargeDisposition:
      | 'home'
      | 'home_health'
      | 'snf'
      | 'rehab'
      | 'ltach'
      | 'hospice'
      | 'ama'
      | 'expired';
    dischargeDateTime: Date;
    dischargeDiagnoses?: string[];
    followUpInstructions?: string;
  };

  // Processing status
  status: 'received' | 'matched' | 'actioned' | 'no_action_needed' | 'error';

  // Actions taken
  actions: CareEventAction[];
}

interface CareEventAction {
  id: string;
  careEventId: string;

  actionType:
    | 'alert_care_team'
    | 'hold_auto_refills'
    | 'resume_auto_refills'
    | 'schedule_med_rec'
    | 'prepare_discharge_meds'
    | 'notify_prescriber'
    | 'create_follow_up';

  triggeredAt: Date;
  completedAt?: Date;

  // Action details
  details?: Record<string, unknown>;

  // Assignment
  assignedTo?: string;
  notes?: string;
}
```

#### Care Event Processing Rules

```typescript
const careEventProcessingRules = {
  // Hospital Admission
  onAdmit: async (event: CareEventNotification) => {
    // 1. Alert care team
    await alertCareTeam({
      patientId: event.matchedPatientId,
      message: `Patient admitted to ${event.facility.name}`,
      urgency: 'high',
    });

    // 2. Hold auto-refill shipments
    await holdAutoRefills({
      patientId: event.matchedPatientId,
      reason: 'patient_hospitalized',
      resumeDate: null,  // Until discharge
    });

    // 3. Flag active prescriptions
    await flagPrescriptions({
      patientId: event.matchedPatientId,
      flag: 'patient_hospitalized',
    });

    // 4. Create care coordination task
    await createTask({
      type: 'hospital_follow_up',
      patientId: event.matchedPatientId,
      dueDate: addDays(new Date(), 2),
      description: 'Check on patient status, prepare for discharge',
    });
  },

  // Hospital Discharge
  onDischarge: async (event: CareEventNotification) => {
    // 1. Alert care team
    await alertCareTeam({
      patientId: event.matchedPatientId,
      message: `Patient discharged from ${event.facility.name}`,
      urgency: 'medium',
    });

    // 2. Resume auto-refills
    await resumeAutoRefills({
      patientId: event.matchedPatientId,
    });

    // 3. Schedule medication reconciliation
    await scheduleAppointment({
      patientId: event.matchedPatientId,
      type: 'medication_reconciliation',
      urgency: 'within_7_days',
      reason: 'Post-hospital medication review',
    });

    // 4. Pull medication history to see hospital meds
    await requestMedicationHistory({
      patientId: event.matchedPatientId,
      requestType: 'reconciliation',
    });

    // 5. Check for new prescriptions from hospital
    await checkForNewPrescriptions({
      patientId: event.matchedPatientId,
      since: event.admissionDetails?.admitDateTime,
    });
  },

  // ED Visit
  onEDVisit: async (event: CareEventNotification) => {
    // 1. Notify prescribing provider
    await notifyProvider({
      patientId: event.matchedPatientId,
      message: `Your patient visited ED at ${event.facility.name}`,
      type: 'informational',
    });

    // 2. Create follow-up task
    await createTask({
      type: 'ed_follow_up',
      patientId: event.matchedPatientId,
      dueDate: addDays(new Date(), 3),
      description: 'Follow up after ED visit',
    });
  },

  // ED Discharge (if no hospital admit)
  onEDDischarge: async (event: CareEventNotification) => {
    // 1. Pull medication history to see any new Rx from ED
    await requestMedicationHistory({
      patientId: event.matchedPatientId,
      requestType: 'ambulatory',
    });

    // 2. Check for drug interactions with new ED medications
    await checkDrugInteractions({
      patientId: event.matchedPatientId,
    });
  }
};
```

#### Care Event Dashboard

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  🏥 Care Event Notifications                                   [Last 7 Days]│
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│  │ Admitted    │  │ Discharged  │  │ ED Visits   │  │ Pending     │       │
│  │     5       │  │     8       │  │     12      │  │  Actions    │       │
│  │ patients    │  │ this week   │  │ this week   │  │     6       │       │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘       │
│                                                                             │
│  CURRENT HOSPITALIZATIONS                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Patient      │ Facility           │ Admitted │ Status        │ ▼   │   │
│  │ ────────────────────────────────────────────────────────────────── │   │
│  │ John Smith   │ U of U Hospital    │ Feb 5    │ Auto-refill   │     │   │
│  │              │ Cardiac Unit       │          │ held          │     │   │
│  │ Mary Wilson  │ Intermountain MC   │ Feb 7    │ Care team     │     │   │
│  │              │ Surgical           │          │ alerted       │     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  RECENT DISCHARGES (Require Follow-up)                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Patient      │ Discharged │ Disposition │ Med Rec      │ Action    │   │
│  │ ────────────────────────────────────────────────────────────────── │   │
│  │ Jane Doe     │ Feb 8      │ Home        │ ⚠️ Pending   │ [Schedule]│   │
│  │ Bob Lee      │ Feb 7      │ Home Health │ ✅ Complete  │ [View]    │   │
│  │ Lisa Chen    │ Feb 6      │ SNF         │ ⚠️ Pending   │ [Contact] │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### Surescripts Integration Summary

| Capability | Priority | Status |
|------------|----------|--------|
| **Inbound E-Prescribing (NewRx)** | Critical | ✅ Added |
| **Real-Time Prescription Benefit (RTPB)** | Critical | ✅ Added |
| **Medication History Integration** | High | ✅ Added |
| **RxFill Status Notifications** | High | ✅ Added |
| **RxRenewal Processing** | High | ✅ Added |
| **First-Fill Abandonment Tracking** | High | ✅ Added |
| **Care Event Notifications (ADT)** | High | ✅ Added |
| PDMP Integration | Critical | ✅ Previously designed |
| EPCS Identity Proofing | Critical | ✅ Previously designed |
| Formulary Checking | High | ✅ Previously designed |

---

## Patient Outcomes & Research Data Architecture

This section defines how we track treatment effectiveness, collect patient-reported outcomes, and structure data for de-identified research while maintaining HIPAA compliance.

### Design Philosophy

**Goal:** Build a learning health system that:
1. Tracks what treatments work for which patients
2. Enables providers to see outcomes across their patient population
3. Generates de-identified datasets for medical research
4. Maintains strict HIPAA compliance throughout

**Key Principle:** Separate identifiable data (PHI) from clinical/research data at the database level.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         DATA ARCHITECTURE OVERVIEW                           │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────┐     ┌─────────────────────┐     ┌─────────────────────┐
│   IDENTITY LAYER    │     │   CLINICAL LAYER    │     │   RESEARCH LAYER    │
│   (PHI - Encrypted) │     │   (Pseudonymized)   │     │   (De-identified)   │
├─────────────────────┤     ├─────────────────────┤     ├─────────────────────┤
│ • Patient names     │     │ • Symptoms          │     │ • Aggregate stats   │
│ • DOB               │     │ • Conditions        │     │ • Cohort analysis   │
│ • SSN               │     │ • Treatments        │     │ • Treatment outcomes│
│ • Address           │     │ • Lab results       │     │ • No individual IDs │
│ • Phone/Email       │     │ • Outcomes          │     │ • k-anonymity       │
│ • Insurance IDs     │     │ • Side effects      │     │ • Differential priv │
└─────────────────────┘     └─────────────────────┘     └─────────────────────┘
         │                           │                           │
         │ patient_id (encrypted)    │ research_id (hash)        │ (no linkage)
         └───────────────────────────┴───────────────────────────┘
```

---

### Patient Outcome Tracking

#### Patient-Reported Outcomes (PROs)

Structured questionnaires patients complete to track treatment effectiveness.

```typescript
interface PatientReportedOutcome {
  id: string;
  clinicalPatientId: string;  // Pseudonymized ID (not real patient_id)

  questionnaireId: string;
  questionnaireVersion: string;

  triggeredBy: 'scheduled' | 'treatment_start' | 'treatment_change' | 'provider_request' | 'patient_initiated';
  relatedTreatmentId?: string;

  responses: PROResponse[];

  scores: {
    totalScore?: number;
    subscaleScores?: Record<string, number>;
    severity?: 'minimal' | 'mild' | 'moderate' | 'severe';
  };

  completedAt: Date;
  timeToComplete: number;  // seconds

  createdAt: Date;
}

interface PROResponse {
  questionId: string;
  questionText: string;  // Stored for research reproducibility
  responseType: 'scale' | 'multiple_choice' | 'free_text' | 'numeric';
  responseValue: string | number;
  responseLabel?: string;
}

interface PROQuestionnaire {
  id: string;
  name: string;
  shortName: string;  // e.g., "PHQ-9", "GAD-7"
  version: string;

  category: 'depression' | 'anxiety' | 'pain' | 'fatigue' | 'sleep' | 'quality_of_life' | 'treatment_satisfaction' | 'side_effects' | 'custom';

  targetConditions: string[];  // ICD-10 codes
  targetTreatments: string[];  // Product IDs

  questions: PROQuestion[];

  scoring: {
    method: 'sum' | 'average' | 'weighted' | 'custom';
    ranges: ScoringRange[];
  };

  validatedInstrument: boolean;
  citation?: string;
  license?: string;

  isActive: boolean;
  createdAt: Date;
}

interface PROQuestion {
  id: string;
  sequence: number;
  text: string;
  helpText?: string;

  responseType: 'likert_5' | 'likert_7' | 'likert_10' | 'vas_100' | 'yes_no' | 'multiple_choice' | 'numeric' | 'free_text';
  responseOptions?: { value: number; label: string }[];

  required: boolean;
  weight?: number;  // For weighted scoring
}
```

#### Standard PRO Instruments

```typescript
const standardQuestionnaires = [
  {
    name: 'Treatment Satisfaction Questionnaire',
    shortName: 'TSQ-9',
    category: 'treatment_satisfaction',
    questions: [
      { text: 'How satisfied are you with the effectiveness of your treatment?', responseType: 'likert_5' },
      { text: 'How satisfied are you with the side effects of your treatment?', responseType: 'likert_5' },
      { text: 'How convenient is your treatment regimen?', responseType: 'likert_5' },
      { text: 'Would you recommend this treatment to others?', responseType: 'likert_5' },
      { text: 'How has your quality of life changed since starting treatment?', responseType: 'likert_5' }
    ]
  },
  {
    name: 'Side Effect Checklist',
    shortName: 'SEC',
    category: 'side_effects',
    questions: [
      { text: 'Nausea', responseType: 'severity_frequency' },
      { text: 'Fatigue', responseType: 'severity_frequency' },
      { text: 'Headache', responseType: 'severity_frequency' },
      { text: 'Injection site reaction', responseType: 'severity_frequency' },
      { text: 'Mood changes', responseType: 'severity_frequency' },
      { text: 'Other (please describe)', responseType: 'free_text' }
    ]
  },
  {
    name: 'Weight Management Outcomes',
    shortName: 'WMO',
    category: 'custom',
    targetTreatments: ['semaglutide', 'tirzepatide'],
    questions: [
      { text: 'Current weight (lbs)', responseType: 'numeric' },
      { text: 'How would you rate your appetite control?', responseType: 'likert_5' },
      { text: 'How often do you experience food cravings?', responseType: 'likert_5' },
      { text: 'How satisfied are you with your weight loss progress?', responseType: 'likert_5' },
      { text: 'Energy level compared to before treatment', responseType: 'likert_5' }
    ]
  }
];
```

#### Symptom Tracking

Ongoing symptom logging separate from formal PROs.

```typescript
interface SymptomLog {
  id: string;
  clinicalPatientId: string;

  logDate: Date;
  logTime?: string;

  symptoms: SymptomEntry[];

  overallWellbeing: 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10;

  relatedTreatmentIds: string[];
  possibleTriggers?: string[];
  notes?: string;

  createdAt: Date;
}

interface SymptomEntry {
  symptomCode: string;  // Standardized code (SNOMED-CT preferred)
  symptomName: string;

  severity: 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10;
  frequency: 'constant' | 'frequent' | 'occasional' | 'rare';
  duration?: string;
  bodyLocation?: string;

  impactOnDaily: 'none' | 'mild' | 'moderate' | 'severe';
  newSinceLastLog: boolean;
  possiblyRelatedToTreatment: boolean;
}
```

#### Treatment Effectiveness Tracking

```typescript
interface TreatmentOutcome {
  id: string;
  clinicalPatientId: string;
  treatmentId: string;

  treatmentType: 'medication' | 'supplement' | 'compound';
  treatmentName: string;
  treatmentCategory: string;

  indication: string;  // Why was this prescribed?
  indicationCode?: string;  // ICD-10

  startDate: Date;
  endDate?: Date;
  durationDays: number;

  // Effectiveness metrics
  effectiveness: {
    patientRating: 1 | 2 | 3 | 4 | 5;  // From PRO
    providerRating?: 1 | 2 | 3 | 4 | 5;
    objectiveMeasures?: ObjectiveMeasure[];
  };

  // Tolerability
  tolerability: {
    overallRating: 1 | 2 | 3 | 4 | 5;
    sideEffects: SideEffectRecord[];
    discontinuedDueToSideEffects: boolean;
  };

  // Outcome
  outcome: 'ongoing' | 'completed' | 'discontinued_effective' | 'discontinued_ineffective' | 'discontinued_side_effects' | 'discontinued_other';
  discontinuationReason?: string;

  // For research: anonymous demographic context
  patientDemographics: {
    ageRange: '18-25' | '26-35' | '36-45' | '46-55' | '56-65' | '65+';
    biologicalSex: 'male' | 'female';
    bmiRange?: 'underweight' | 'normal' | 'overweight' | 'obese_1' | 'obese_2' | 'obese_3';
  };

  createdAt: Date;
  updatedAt: Date;
}

interface ObjectiveMeasure {
  measureType: 'weight' | 'blood_pressure' | 'lab_value' | 'other';
  measureName: string;
  baselineValue: number;
  currentValue: number;
  unit: string;
  percentChange: number;
  measureDate: Date;
}

interface SideEffectRecord {
  sideEffectCode: string;  // MedDRA preferred
  sideEffectName: string;
  severity: 'mild' | 'moderate' | 'severe';
  onsetDays: number;  // Days after treatment start
  resolved: boolean;
  resolvedDays?: number;
  actionTaken: 'none' | 'dose_reduced' | 'treatment_paused' | 'treatment_stopped' | 'other_treatment_added';
}
```

---

### De-identified Research Data Architecture

#### HIPAA De-identification Methods

We support both Safe Harbor and Expert Determination methods.

**Safe Harbor Method (18 Identifiers Removed):**
1. Names
2. Geographic data smaller than state
3. Dates (except year) for dates related to an individual
4. Phone numbers
5. Fax numbers
6. Email addresses
7. Social Security numbers
8. Medical record numbers
9. Health plan beneficiary numbers
10. Account numbers
11. Certificate/license numbers
12. Vehicle identifiers
13. Device identifiers
14. Web URLs
15. IP addresses
16. Biometric identifiers
17. Full-face photographs
18. Any other unique identifying number

**Our Implementation:**

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    THREE-TIER DATA ARCHITECTURE                              │
└─────────────────────────────────────────────────────────────────────────────┘

TIER 1: OPERATIONAL DATABASE (PHI Present)
├── patients (encrypted PHI)
├── appointments
├── prescriptions
├── orders
└── [Full operational data with all identifiers]

         │
         │ ETL with pseudonymization
         ▼

TIER 2: CLINICAL ANALYTICS DATABASE (Pseudonymized)
├── clinical_patients (research_id, no PHI)
├── clinical_treatments
├── clinical_outcomes
├── clinical_symptoms
└── [Linked by research_id, but no direct identifiers]

         │
         │ Aggregation + k-anonymity
         ▼

TIER 3: RESEARCH DATABASE (Fully De-identified)
├── cohort_outcomes
├── treatment_effectiveness_agg
├── symptom_patterns_agg
└── [No individual records, only aggregates meeting k-anonymity threshold]
```

#### Pseudonymization Layer

```typescript
interface ClinicalPatient {
  // NO PHI IN THIS TABLE
  researchId: string;  // One-way hash of patient_id + salt

  // Generalized demographics (Safe Harbor compliant)
  ageRange: '18-25' | '26-35' | '36-45' | '46-55' | '56-65' | '65+';
  biologicalSex: 'male' | 'female';
  stateRegion: 'mountain' | 'pacific' | 'southwest' | 'midwest' | 'northeast' | 'southeast';

  // Clinical characteristics (not identifiers)
  bmiRange?: string;
  smokingStatus?: 'never' | 'former' | 'current';
  alcoholUse?: 'none' | 'light' | 'moderate' | 'heavy';

  enrollmentYear: number;
  enrollmentQuarter: 1 | 2 | 3 | 4;

  isActive: boolean;
  createdAt: Date;
}

// Pseudonymization function
const generateResearchId = (patientId: string): string => {
  const salt = process.env.RESEARCH_ID_SALT;  // Stored securely, never exposed
  return crypto
    .createHash('sha256')
    .update(patientId + salt)
    .digest('hex')
    .substring(0, 32);
};

// The mapping is ONE-WAY - we cannot reverse research_id to patient_id
// If re-identification is ever needed (e.g., safety alert), it requires:
// 1. Break-glass access
// 2. Dual approval
// 3. Justification logged
// 4. Time-limited
```

#### Research-Ready Tables

```sql
-- ============================================
-- TIER 2: CLINICAL ANALYTICS (Pseudonymized)
-- ============================================

CREATE TABLE clinical_patients (
  research_id VARCHAR(32) PRIMARY KEY,  -- SHA-256 hash, not reversible

  -- Generalized demographics
  age_range VARCHAR(10) NOT NULL,
  biological_sex VARCHAR(10) NOT NULL,
  state_region VARCHAR(20) NOT NULL,
  bmi_range VARCHAR(20),

  -- Clinical characteristics
  smoking_status VARCHAR(20),
  alcohol_use VARCHAR(20),

  enrollment_year INTEGER NOT NULL,
  enrollment_quarter INTEGER NOT NULL,

  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE clinical_conditions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  research_id VARCHAR(32) REFERENCES clinical_patients(research_id),

  condition_code VARCHAR(20) NOT NULL,  -- ICD-10
  condition_name VARCHAR(255) NOT NULL,
  condition_category VARCHAR(100),

  onset_year INTEGER,
  onset_quarter INTEGER,
  is_active BOOLEAN,

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE clinical_treatments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  research_id VARCHAR(32) REFERENCES clinical_patients(research_id),

  treatment_type VARCHAR(50) NOT NULL,  -- medication, supplement, compound
  treatment_category VARCHAR(100) NOT NULL,  -- weight_loss, hrt_male, etc.
  treatment_name VARCHAR(255) NOT NULL,
  treatment_code VARCHAR(50),  -- NDC or internal code

  indication_code VARCHAR(20),  -- ICD-10
  indication_name VARCHAR(255),

  start_year INTEGER NOT NULL,
  start_quarter INTEGER NOT NULL,
  start_month INTEGER NOT NULL,  -- Month only, no day

  end_year INTEGER,
  end_quarter INTEGER,
  duration_days INTEGER,

  dosage VARCHAR(100),
  frequency VARCHAR(100),

  is_active BOOLEAN,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE clinical_outcomes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  research_id VARCHAR(32) REFERENCES clinical_patients(research_id),
  treatment_id UUID REFERENCES clinical_treatments(id),

  assessment_year INTEGER NOT NULL,
  assessment_quarter INTEGER NOT NULL,
  assessment_month INTEGER NOT NULL,

  -- Effectiveness
  patient_effectiveness_rating INTEGER CHECK (patient_effectiveness_rating BETWEEN 1 AND 5),
  provider_effectiveness_rating INTEGER CHECK (provider_effectiveness_rating BETWEEN 1 AND 5),

  -- Objective measures (generalized)
  weight_change_category VARCHAR(50),  -- 'lost_10+%', 'lost_5-10%', 'stable', 'gained'
  bp_change_category VARCHAR(50),
  lab_improvement_category VARCHAR(50),

  -- Tolerability
  tolerability_rating INTEGER CHECK (tolerability_rating BETWEEN 1 AND 5),
  had_side_effects BOOLEAN,
  side_effect_severity VARCHAR(20),

  -- Outcome
  outcome VARCHAR(50),  -- ongoing, completed, discontinued_*
  discontinuation_reason VARCHAR(100),

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE clinical_symptoms (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  research_id VARCHAR(32) REFERENCES clinical_patients(research_id),

  symptom_code VARCHAR(50) NOT NULL,  -- SNOMED-CT
  symptom_name VARCHAR(255) NOT NULL,
  symptom_category VARCHAR(100),

  log_year INTEGER NOT NULL,
  log_quarter INTEGER NOT NULL,
  log_month INTEGER NOT NULL,

  severity INTEGER CHECK (severity BETWEEN 1 AND 10),
  frequency VARCHAR(50),
  impact_on_daily VARCHAR(20),

  possibly_treatment_related BOOLEAN,
  related_treatment_id UUID REFERENCES clinical_treatments(id),

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE clinical_labs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  research_id VARCHAR(32) REFERENCES clinical_patients(research_id),

  lab_code VARCHAR(50) NOT NULL,  -- LOINC
  lab_name VARCHAR(255) NOT NULL,
  lab_category VARCHAR(100),

  result_year INTEGER NOT NULL,
  result_quarter INTEGER NOT NULL,
  result_month INTEGER NOT NULL,

  -- Categorized results (not exact values for privacy)
  result_category VARCHAR(50),  -- 'low', 'normal', 'high', 'critical'
  result_range VARCHAR(50),  -- 'below_normal', 'normal', 'above_normal'

  -- For trending, store relative to reference range
  percent_of_upper_limit DECIMAL(5,2),  -- e.g., 85% of upper limit

  related_treatment_id UUID REFERENCES clinical_treatments(id),

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE clinical_pro_responses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  research_id VARCHAR(32) REFERENCES clinical_patients(research_id),
  treatment_id UUID REFERENCES clinical_treatments(id),

  questionnaire_id VARCHAR(50) NOT NULL,
  questionnaire_name VARCHAR(255) NOT NULL,

  response_year INTEGER NOT NULL,
  response_quarter INTEGER NOT NULL,
  response_month INTEGER NOT NULL,

  total_score DECIMAL(5,2),
  severity_category VARCHAR(50),

  -- Individual question responses as JSONB (no free text included)
  structured_responses JSONB,  -- Only numeric/categorical, no free text

  time_since_treatment_start_days INTEGER,

  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ============================================
-- TIER 3: RESEARCH AGGREGATES (Fully De-identified)
-- ============================================

CREATE TABLE research_treatment_effectiveness (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- Grouping dimensions
  treatment_category VARCHAR(100) NOT NULL,
  treatment_name VARCHAR(255) NOT NULL,
  indication_code VARCHAR(20),
  indication_name VARCHAR(255),

  -- Demographics for stratification
  age_range VARCHAR(10),
  biological_sex VARCHAR(10),
  bmi_range VARCHAR(20),

  -- Time period
  analysis_year INTEGER NOT NULL,
  analysis_quarter INTEGER NOT NULL,

  -- Aggregated metrics (k-anonymity enforced: k >= 10)
  patient_count INTEGER NOT NULL CHECK (patient_count >= 10),

  avg_effectiveness_rating DECIMAL(3,2),
  effectiveness_rating_stddev DECIMAL(3,2),

  pct_highly_effective DECIMAL(5,2),  -- % rating 4-5
  pct_moderately_effective DECIMAL(5,2),  -- % rating 3
  pct_ineffective DECIMAL(5,2),  -- % rating 1-2

  avg_tolerability_rating DECIMAL(3,2),
  pct_with_side_effects DECIMAL(5,2),
  pct_discontinued_side_effects DECIMAL(5,2),

  avg_treatment_duration_days DECIMAL(7,1),
  pct_completed_treatment DECIMAL(5,2),
  pct_ongoing DECIMAL(5,2),

  -- Outcome measures
  pct_weight_loss_10plus DECIMAL(5,2),
  pct_weight_loss_5to10 DECIMAL(5,2),
  pct_lab_improvement DECIMAL(5,2),

  created_at TIMESTAMPTZ DEFAULT NOW(),

  -- Ensure k-anonymity
  CONSTRAINT k_anonymity_check CHECK (patient_count >= 10)
);

CREATE TABLE research_symptom_patterns (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  symptom_code VARCHAR(50) NOT NULL,
  symptom_name VARCHAR(255) NOT NULL,
  symptom_category VARCHAR(100),

  treatment_category VARCHAR(100),
  treatment_name VARCHAR(255),

  age_range VARCHAR(10),
  biological_sex VARCHAR(10),

  analysis_year INTEGER NOT NULL,
  analysis_quarter INTEGER NOT NULL,

  patient_count INTEGER NOT NULL CHECK (patient_count >= 10),

  avg_severity DECIMAL(3,1),
  pct_treatment_related DECIMAL(5,2),
  pct_resolved_with_treatment DECIMAL(5,2),
  avg_days_to_resolution DECIMAL(7,1),

  created_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT k_anonymity_check CHECK (patient_count >= 10)
);

CREATE TABLE research_cohort_outcomes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  cohort_definition JSONB NOT NULL,  -- Describes the cohort criteria

  analysis_year INTEGER NOT NULL,
  analysis_quarter INTEGER NOT NULL,

  cohort_size INTEGER NOT NULL CHECK (cohort_size >= 10),

  -- Outcome distributions
  outcome_distribution JSONB,  -- { "completed": 45, "ongoing": 30, ... }

  -- Effectiveness by time
  effectiveness_at_30_days JSONB,
  effectiveness_at_90_days JSONB,
  effectiveness_at_180_days JSONB,

  -- Retention
  retention_30_days DECIMAL(5,2),
  retention_90_days DECIMAL(5,2),
  retention_180_days DECIMAL(5,2),

  created_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT k_anonymity_check CHECK (cohort_size >= 10)
);

-- Indexes for research queries
CREATE INDEX idx_clinical_treatments_category ON clinical_treatments(treatment_category);
CREATE INDEX idx_clinical_outcomes_treatment ON clinical_outcomes(treatment_id);
CREATE INDEX idx_clinical_symptoms_code ON clinical_symptoms(symptom_code);
CREATE INDEX idx_research_effectiveness_treatment ON research_treatment_effectiveness(treatment_name, analysis_year);
```

#### ETL Pipeline for De-identification

```typescript
interface DeidentificationPipeline {
  steps: [
    {
      name: 'extract_from_operational',
      source: 'operational_db',
      target: 'staging',
      description: 'Extract records needing sync'
    },
    {
      name: 'pseudonymize',
      operations: [
        'generate_research_id',
        'remove_phi_fields',
        'generalize_dates',
        'generalize_demographics',
        'generalize_geography'
      ]
    },
    {
      name: 'load_clinical',
      target: 'clinical_analytics_db',
      description: 'Load pseudonymized records'
    },
    {
      name: 'aggregate_research',
      operations: [
        'calculate_cohort_metrics',
        'apply_k_anonymity_filter',
        'generate_aggregate_tables'
      ],
      target: 'research_db'
    }
  ];

  schedule: 'daily_2am';
  retention: {
    operational: 'as_needed',
    clinical: '10_years',
    research: 'indefinite'
  };
}

const generalizationRules = {
  dates: {
    rule: 'reduce_to_month_year',
    example: '2026-02-09' => { year: 2026, quarter: 1, month: 2 }
  },

  age: {
    rule: 'bucket_into_ranges',
    ranges: ['18-25', '26-35', '36-45', '46-55', '56-65', '65+']
  },

  geography: {
    rule: 'reduce_to_region',
    mapping: {
      'UT': 'mountain', 'CO': 'mountain', 'AZ': 'southwest',
      'CA': 'pacific', 'WA': 'pacific', 'OR': 'pacific',
      // etc.
    }
  },

  labValues: {
    rule: 'categorize_relative_to_reference',
    categories: ['critical_low', 'low', 'normal', 'high', 'critical_high']
  },

  weight: {
    rule: 'calculate_percent_change',
    categories: ['lost_10+%', 'lost_5-10%', 'lost_1-5%', 'stable', 'gained_1-5%', 'gained_5+%']
  }
};
```

---

### Security & Compliance Implementation

#### Encryption Standards

```typescript
const encryptionConfig = {
  atRest: {
    algorithm: 'AES-256-GCM',
    keyManagement: 'AWS KMS',
    keyRotation: '90_days',

    encryptedFields: [
      'patients.ssn',
      'patients.date_of_birth',
      'patients.phone',
      'patients.email',
      'patients.address',
      'insurance_policies.member_id',
      'payment_methods.card_token'
    ],

    encryptedTables: [
      'phi_access_log',
      'admin_audit_log'
    ],

    databaseEncryption: {
      type: 'transparent_data_encryption',
      provider: 'AWS RDS',
      keyArn: 'arn:aws:kms:us-west-2:xxx:key/xxx'
    }
  },

  inTransit: {
    protocol: 'TLS 1.3',
    minimumVersion: 'TLS 1.2',
    cipherSuites: [
      'TLS_AES_256_GCM_SHA384',
      'TLS_CHACHA20_POLY1305_SHA256'
    ],

    certificateProvider: 'AWS ACM',
    hsts: {
      enabled: true,
      maxAge: 31536000,
      includeSubdomains: true,
      preload: true
    }
  },

  applicationLevel: {
    fieldLevelEncryption: true,
    searchableEncryption: false,  // Sacrifice for security
    hashingSalt: 'stored_in_secrets_manager'
  }
};
```

#### Field-Level Encryption Implementation

```typescript
import { KMSClient, EncryptCommand, DecryptCommand } from '@aws-sdk/client-kms';
import crypto from 'crypto';

const kmsClient = new KMSClient({ region: 'us-west-2' });
const DATA_KEY_ARN = process.env.KMS_DATA_KEY_ARN;

const encryptPHI = async (plaintext: string): Promise<string> => {
  const iv = crypto.randomBytes(16);

  const encryptCommand = new EncryptCommand({
    KeyId: DATA_KEY_ARN,
    Plaintext: Buffer.from(plaintext)
  });

  const { CiphertextBlob } = await kmsClient.send(encryptCommand);

  const combined = Buffer.concat([
    iv,
    Buffer.from(CiphertextBlob as Uint8Array)
  ]);

  return combined.toString('base64');
};

const decryptPHI = async (ciphertext: string): Promise<string> => {
  const combined = Buffer.from(ciphertext, 'base64');
  const iv = combined.slice(0, 16);
  const encrypted = combined.slice(16);

  const decryptCommand = new DecryptCommand({
    CiphertextBlob: encrypted
  });

  const { Plaintext } = await kmsClient.send(decryptCommand);
  return Buffer.from(Plaintext as Uint8Array).toString('utf8');
};

// Usage in data model
interface PatientRecord {
  id: string;
  first_name_encrypted: string;  // Encrypted
  last_name_encrypted: string;   // Encrypted
  dob_encrypted: string;         // Encrypted
  ssn_encrypted: string;         // Encrypted
  phone_encrypted: string;       // Encrypted
  email_encrypted: string;       // Encrypted

  // Non-PHI fields stored normally
  created_at: Date;
  is_active: boolean;
}
```

#### Role-Based Access Control (RBAC) Matrix

```typescript
const rbacMatrix = {
  roles: {
    // Clinical roles
    provider: {
      patients: ['read_own_patients', 'write_own_patients'],
      prescriptions: ['read_own', 'write_own'],
      clinical_data: ['read_own_patients', 'write_own_patients'],
      research_data: ['none'],
      phi: ['read_own_patients']
    },

    pharmacist: {
      patients: ['read_with_order'],
      prescriptions: ['read_all', 'update_status'],
      clinical_data: ['read_medication_relevant'],
      research_data: ['none'],
      phi: ['read_limited']  // Name, DOB, allergies only
    },

    care_coordinator: {
      patients: ['read_assigned'],
      prescriptions: ['read_assigned'],
      clinical_data: ['read_assigned'],
      research_data: ['none'],
      phi: ['read_assigned_limited']
    },

    // Administrative roles
    billing_staff: {
      patients: ['read_billing_info'],
      prescriptions: ['read_billing_relevant'],
      clinical_data: ['none'],
      research_data: ['none'],
      phi: ['read_billing_only']  // Name, DOB, insurance
    },

    support_staff: {
      patients: ['read_limited'],
      prescriptions: ['read_status_only'],
      clinical_data: ['none'],
      research_data: ['none'],
      phi: ['read_minimal']  // Name only for verification
    },

    // Research roles
    data_analyst: {
      patients: ['none'],
      prescriptions: ['none'],
      clinical_data: ['read_pseudonymized'],
      research_data: ['read_all', 'write_analyses'],
      phi: ['none']
    },

    researcher: {
      patients: ['none'],
      prescriptions: ['none'],
      clinical_data: ['read_aggregated_only'],
      research_data: ['read_deidentified'],
      phi: ['none']
    },

    // System roles
    compliance_officer: {
      patients: ['read_all_with_audit'],
      prescriptions: ['read_all_with_audit'],
      clinical_data: ['read_all_with_audit'],
      research_data: ['read_all'],
      phi: ['read_all_with_audit']
    },

    system_admin: {
      // Break glass only
      all: ['break_glass_only']
    }
  },

  accessRequirements: {
    phi_access: {
      requiresJustification: true,
      logged: true,
      timeLimited: true
    },

    research_data: {
      requiresTraining: true,
      requiresAgreement: true,
      noExport: true
    },

    break_glass: {
      requiresDualApproval: true,
      maxDuration: '4_hours',
      mandatoryReview: true
    }
  }
};
```

#### Comprehensive Audit Logging

```sql
-- Unified audit log for all data access
CREATE TABLE comprehensive_audit_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- Who
  user_id UUID NOT NULL,
  user_email VARCHAR(255) NOT NULL,
  user_role VARCHAR(100) NOT NULL,
  user_department VARCHAR(100),

  -- What
  action VARCHAR(50) NOT NULL,  -- read, create, update, delete, export, query
  resource_type VARCHAR(100) NOT NULL,  -- patients, prescriptions, clinical_data, research_data
  resource_id UUID,
  resource_description VARCHAR(500),

  -- PHI specific
  phi_accessed BOOLEAN DEFAULT false,
  phi_fields_accessed TEXT[],  -- ['ssn', 'dob', 'address']
  patient_ids_accessed UUID[],  -- For batch operations

  -- Context
  justification TEXT,
  access_reason VARCHAR(100),  -- treatment, payment, operations, research, audit
  break_glass_id UUID,

  -- Request details
  request_method VARCHAR(10),
  request_path VARCHAR(500),
  request_query_hash VARCHAR(64),  -- Hash of query for research queries
  response_status INTEGER,
  response_record_count INTEGER,

  -- Session
  session_id VARCHAR(255),
  ip_address INET NOT NULL,
  user_agent TEXT,
  device_fingerprint VARCHAR(255),
  geo_location VARCHAR(100),

  -- Timing
  performed_at TIMESTAMPTZ DEFAULT NOW(),
  duration_ms INTEGER,

  -- Data export tracking
  data_exported BOOLEAN DEFAULT false,
  export_format VARCHAR(50),
  export_record_count INTEGER,
  export_destination VARCHAR(255)
);

-- Immutable - no updates or deletes allowed
REVOKE UPDATE, DELETE ON comprehensive_audit_log FROM PUBLIC;

-- Separate partition for PHI access (for faster compliance queries)
CREATE INDEX idx_audit_phi ON comprehensive_audit_log(phi_accessed, performed_at)
  WHERE phi_accessed = true;
CREATE INDEX idx_audit_user ON comprehensive_audit_log(user_id, performed_at);
CREATE INDEX idx_audit_patient ON comprehensive_audit_log USING GIN(patient_ids_accessed)
  WHERE patient_ids_accessed IS NOT NULL;
CREATE INDEX idx_audit_break_glass ON comprehensive_audit_log(break_glass_id)
  WHERE break_glass_id IS NOT NULL;

-- Retention: 7 years minimum per HIPAA
-- Stored in append-only format, replicated to cold storage
```

#### Data Minimization Implementation

```typescript
const dataMinimizationRules = {
  collection: {
    // Only collect what's needed
    patientRegistration: [
      'name',           // Required: identification
      'dob',            // Required: age verification, clinical
      'email',          // Required: communication
      'phone',          // Required: 2FA, urgent contact
      'address',        // Required: shipping
      // SSN: NOT collected unless insurance billing requires
      // Race/ethnicity: Optional, for research only with consent
    ],

    clinicalEncounter: [
      'symptoms',       // Required: treatment
      'medications',    // Required: safety
      'allergies',      // Required: safety
      'vitals',         // Required: clinical decisions
      // Family history: Only if clinically relevant
      // Social history: Only if clinically relevant
    ]
  },

  display: {
    // Show minimum needed for task
    pharmacistView: ['name', 'dob', 'allergies', 'current_meds', 'new_rx'],
    billingView: ['name', 'dob', 'insurance_info', 'charges'],
    supportView: ['name', 'order_status'],  // No clinical info
    researchView: ['pseudonymized_id', 'clinical_data'],  // No identifiers
  },

  retention: {
    medicalRecords: '10_years_after_last_encounter',
    billingRecords: '7_years',
    auditLogs: '7_years',
    researchData: 'indefinite_deidentified',
    sessionLogs: '90_days',
    supportTickets: '3_years'
  },

  destruction: {
    method: 'cryptographic_erasure',
    verification: 'dual_approval_required',
    documentation: 'destruction_certificate_generated',
    schedule: 'quarterly_review'
  }
};
```

#### Vulnerability Assessment & Monitoring

```typescript
const securityMonitoring = {
  vulnerabilityScanning: {
    frequency: 'weekly',
    tools: ['AWS Inspector', 'Snyk', 'OWASP ZAP'],
    scope: ['infrastructure', 'dependencies', 'application'],
    criticalSLA: '24_hours',
    highSLA: '7_days',
    mediumSLA: '30_days'
  },

  penetrationTesting: {
    frequency: 'annual',
    additionalTriggers: ['major_release', 'infrastructure_change'],
    scope: 'full_application_and_infrastructure',
    provider: 'third_party_certified'
  },

  realTimeMonitoring: {
    anomalyDetection: {
      enabled: true,
      triggers: [
        'unusual_access_patterns',
        'bulk_data_access',
        'after_hours_phi_access',
        'access_from_new_location',
        'multiple_failed_logins'
      ]
    },

    alerts: {
      phiAccessSpike: {
        threshold: '10x_normal_volume',
        action: 'immediate_alert_security_team'
      },
      bulkExport: {
        threshold: '1000_records',
        action: 'require_approval_and_log'
      },
      suspiciousQuery: {
        patterns: ['SELECT * FROM patients', 'bulk_download'],
        action: 'block_and_alert'
      }
    }
  },

  incidentResponse: {
    playbooks: [
      'data_breach',
      'unauthorized_access',
      'ransomware',
      'insider_threat'
    ],
    notificationTimeline: {
      internal: 'immediate',
      hipaaBreachNotification: '60_days',
      stateNotification: 'per_state_law'
    }
  }
};
```

#### Staff Training Requirements

```typescript
const trainingRequirements = {
  allStaff: {
    hipaaPrivacy: {
      frequency: 'annual',
      duration: '2_hours',
      assessment: 'required_passing_score_80'
    },
    hipaaSecurity: {
      frequency: 'annual',
      duration: '2_hours',
      assessment: 'required_passing_score_80'
    },
    phishingAwareness: {
      frequency: 'quarterly',
      type: 'simulated_phishing_test',
      failureAction: 'additional_training_required'
    },
    securityAwareness: {
      frequency: 'annual',
      duration: '1_hour',
      topics: ['password_hygiene', 'social_engineering', 'physical_security']
    }
  },

  roleSpecific: {
    phiAccessRoles: {
      minimumNecessary: {
        frequency: 'annual',
        content: 'Only access PHI needed for job function'
      }
    },
    itStaff: {
      securityOperations: {
        frequency: 'annual',
        duration: '8_hours',
        certifications: ['Security+', 'HCISPP']
      }
    },
    researchers: {
      deidentificationTraining: {
        frequency: 'before_access',
        duration: '4_hours',
        agreement: 'data_use_agreement_required'
      }
    }
  },

  tracking: {
    system: 'LMS',
    compliance: 'block_system_access_if_overdue',
    reporting: 'monthly_compliance_report_to_leadership'
  }
};
```

---

### Provider & Patient Outcome Dashboards

#### Provider Outcomes Dashboard

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  Treatment Outcomes Dashboard                                                │
│  Dr. Smith | Last 12 months                                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Overall Effectiveness                                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ ████████████████████████████████████████████░░░░░░  85%             │    │
│  │ Patients rating treatment 4-5 stars                                  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  By Treatment Category:                                                      │
│  ┌──────────────┬───────────┬────────────┬──────────┬─────────────────┐     │
│  │ Category     │ Patients  │ Effective  │ Tolerab. │ Avg Duration    │     │
│  ├──────────────┼───────────┼────────────┼──────────┼─────────────────┤     │
│  │ Weight Loss  │ 127       │ 89%        │ 4.2/5    │ 6.3 months      │     │
│  │ Male HRT     │ 84        │ 92%        │ 4.5/5    │ 8.1 months      │     │
│  │ Female HRT   │ 56        │ 85%        │ 4.3/5    │ 7.2 months      │     │
│  │ Thyroid      │ 32        │ 78%        │ 4.4/5    │ 9.5 months      │     │
│  └──────────────┴───────────┴────────────┴──────────┴─────────────────┘     │
│                                                                              │
│  Outcome Trends (Last 12 Months):                                           │
│  Effectiveness ──────────────────────────────────────                       │
│  100%│    ╭───╮   ╭───────────────────────────╮                             │
│   80%│────╯   ╰───╯                           │                             │
│   60%│                                        │                             │
│      └────────────────────────────────────────                              │
│       Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct  Nov  Dec            │
│                                                                              │
│  Common Side Effects Reported:                                              │
│  • Nausea (GLP-1): 34% of patients, avg severity 3.2/10, resolves week 4   │
│  • Injection site (HRT): 12% of patients, mild                              │
│  • Fatigue (Thyroid): 8% of patients during titration                       │
│                                                                              │
│  [Export Report]  [Compare to Platform Average]  [Drill Down]               │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### Patient Progress View

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  My Treatment Progress                                                       │
│  Semaglutide for Weight Management                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Started: January 15, 2026 (8 weeks ago)                                    │
│                                                                              │
│  Weight Progress:                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ 220 ●                                                                │    │
│  │ 215   ●                                                              │    │
│  │ 210     ●  ●                                                         │    │
│  │ 205           ●  ●                                                   │    │
│  │ 200                 ●  ●  ●                        Goal: 180         │    │
│  │ 195                                                    ↓             │    │
│  │     ─────────────────────────────────────────────────────────        │    │
│  │     Wk1 Wk2 Wk3 Wk4 Wk5 Wk6 Wk7 Wk8                                 │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  Total Lost: 17 lbs (7.7%)    On Track: ✓                                   │
│                                                                              │
│  Symptom Trends:                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ Nausea    ███████░░░ → ██░░░░░░░ (improving)                        │    │
│  │ Energy    ████░░░░░░ → ████████░ (improving)                        │    │
│  │ Appetite  █████████░ → ███░░░░░░ (desired effect)                   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  This Week's Check-in:                                                       │
│  [Complete Weekly Survey]                                                   │
│                                                                              │
│  Upcoming:                                                                   │
│  • Week 12 labs due: March 12                                               │
│  • Provider check-in: March 15                                              │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### Research Consent Management

Patient consent framework for use of their data in research and quality improvement.

| Decision | Choice |
|----------|--------|
| Default consent | Opt-out for de-identified research, opt-in for everything else |
| Consent granularity | By data type and purpose |
| Withdrawal | Allowed at any time, prospective only |
| Minor consent | Parent/guardian required, re-consent at 18 |

#### Consent Data Model

```typescript
interface ResearchConsent {
  id: string;
  patientId: string;

  consentVersion: string;           // Version of consent form
  consentDocumentUrl: string;       // Signed consent PDF

  capturedAt: Date;
  capturedMethod: 'registration_flow' | 'patient_portal' | 'provider_assisted' | 'paper_upload';

  consentChoices: {
    deidentifiedResearch: ConsentChoice;       // Aggregate stats, no PHI
    pseudonymizedResearch: ConsentChoice;      // Linked but de-identified records
    biomarkerResearch: ConsentChoice;          // Lab/genetic data
    commercialResearch: ConsentChoice;         // Industry-sponsored studies
    qualityImprovement: ConsentChoice;         // Internal QI projects
    marketingAnalytics: ConsentChoice;         // Product development insights
    externalSharing: ConsentChoice;            // Share with research partners
    contactForStudies: ConsentChoice;          // May be contacted for future studies
  };

  restrictions?: {
    excludeConditions?: string[];     // e.g., "mental health", "sexual health"
    excludeTreatments?: string[];     // e.g., "weight loss"
    geographicRestriction?: string;   // e.g., "US only"
    timeRestriction?: {               // e.g., "only after 2025"
      notBefore?: Date;
      notAfter?: Date;
    };
  };

  guardianConsent?: {
    guardianId: string;
    guardianName: string;
    guardianRelationship: 'parent' | 'legal_guardian';
    patientAge: number;
    reConsentRequiredAt: Date;        // Patient's 18th birthday
  };

  attestations: {
    understoodPurpose: boolean;
    understoodVoluntary: boolean;
    understoodWithdrawal: boolean;
    understoodNoImpactOnCare: boolean;
    understoodDataRetention: boolean;
    hadQuestionsAnswered: boolean;
  };

  witnessSignature?: {
    witnessName: string;
    witnessRole: string;
    witnessedAt: Date;
  };

  status: 'active' | 'withdrawn' | 'expired' | 'superseded';

  withdrawalDetails?: {
    withdrawnAt: Date;
    withdrawnBy: 'patient' | 'guardian';
    withdrawalScope: 'all' | 'specific';
    specificWithdrawals?: string[];   // Which consent types withdrawn
    reason?: string;
    effectiveImmediately: boolean;
  };

  auditLog: ConsentAuditEntry[];

  createdAt: Date;
  updatedAt: Date;
}

interface ConsentChoice {
  consented: boolean;
  consentedAt: Date;
  method: 'checkbox' | 'signature' | 'verbal_recorded';
}

interface ConsentAuditEntry {
  timestamp: Date;
  action: 'created' | 'modified' | 'withdrawn' | 'renewed' | 'version_update';
  previousValue?: unknown;
  newValue?: unknown;
  performedBy: string;
  ipAddress?: string;
  userAgent?: string;
}
```

#### Consent Capture Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│ PATIENT REGISTRATION                                                 │
└─────────────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────────┐
│ RESEARCH CONSENT SCREEN                                              │
│                                                                      │
│ "Help improve healthcare for future patients"                       │
│                                                                      │
│ We may use information from your care (with your name and           │
│ identifying details removed) to:                                    │
│                                                                      │
│ ☑️ Improve our treatments and services (required for service)       │
│                                                                      │
│ ☐ Contribute to medical research (de-identified)                   │
│   Your data would be combined with thousands of others              │
│   to help researchers discover better treatments.                   │
│                                                                      │
│ ☐ Allow researchers to contact me about future studies             │
│   You may be invited to participate in clinical studies.            │
│                                                                      │
│ ☐ Share with research partners                                      │
│   Universities and research institutions studying                   │
│   similar health conditions.                                        │
│                                                                      │
│ You can change these choices anytime in your account settings.      │
│                                                                      │
│ [View Full Research Consent Document] [Privacy Policy]              │
│                                                                      │
│                                              [Continue →]            │
└─────────────────────────────────────────────────────────────────────┘
```

#### Patient Portal - Consent Management

```
┌─────────────────────────────────────────────────────────────────────┐
│ PRIVACY & RESEARCH PREFERENCES                                       │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ Your data helps improve healthcare. You control how it's used.      │
│                                                                      │
│ ─────────────────────────────────────────────────────────────────── │
│                                                                      │
│ QUALITY IMPROVEMENT (Required)                     ✅ Enabled        │
│ We use de-identified data to improve our services.                  │
│ This is part of providing your care.                                │
│                                                                      │
│ ─────────────────────────────────────────────────────────────────── │
│                                                                      │
│ DE-IDENTIFIED RESEARCH                             🔘 Enabled        │
│ Your data (without name/identifiers) may be combined                │
│ with others for medical research.                                   │
│ [Change] [Learn More]                                               │
│                                                                      │
│ CONTACT FOR STUDIES                                ⭕ Disabled       │
│ Researchers may contact you about participating                     │
│ in clinical studies you may qualify for.                            │
│ [Change]                                                             │
│                                                                      │
│ RESEARCH PARTNERSHIPS                              ⭕ Disabled       │
│ Share de-identified data with university and                        │
│ industry research partners.                                         │
│ [Change]                                                             │
│                                                                      │
│ ─────────────────────────────────────────────────────────────────── │
│                                                                      │
│ RESTRICTIONS                                                         │
│ Exclude specific conditions from research:                          │
│ ☐ Mental health  ☐ Sexual health  ☐ Substance use                  │
│                                                                      │
│ ─────────────────────────────────────────────────────────────────── │
│                                                                      │
│ [Withdraw All Research Consent]                                      │
│                                                                      │
│ Last updated: January 15, 2024                                      │
│ Consent version: v2.1                                               │
└─────────────────────────────────────────────────────────────────────┘
```

#### Consent Enforcement in Data Pipeline

```typescript
interface ResearchDataFilter {
  filterResearchData: (params: {
    patientIds: string[];
    dataType: 'clinical' | 'labs' | 'outcomes' | 'demographics';
    researchPurpose: 'internal_qi' | 'deidentified_research' | 'commercial' | 'partnership';
    researchProjectId: string;
  }) => Promise<FilteredDataResult>;
}

interface FilteredDataResult {
  includedPatientIds: string[];
  excludedPatientIds: string[];

  exclusionReasons: {
    patientId: string;
    reason: 'no_consent' | 'withdrawn' | 'restricted_condition' | 'minor_no_guardian' | 'expired';
  }[];

  consentCoverage: {
    totalRequested: number;
    consented: number;
    consentRate: number;
  };

  dataProvenance: {
    consentVersionsIncluded: string[];
    dataExtractionDate: Date;
    filteringRulesVersion: string;
  };
}

const consentEnforcementRules = {
  internal_qi: {
    requiredConsent: null,  // No consent needed for QI
    documentation: 'QI project registration',
    deidentification: 'aggregated'
  },
  deidentified_research: {
    requiredConsent: 'deidentifiedResearch',
    documentation: 'IRB approval or exemption',
    deidentification: 'safe_harbor'
  },
  commercial: {
    requiredConsent: ['deidentifiedResearch', 'commercialResearch'],
    documentation: 'IRB + commercial DUA',
    deidentification: 'expert_determination'
  },
  partnership: {
    requiredConsent: ['deidentifiedResearch', 'externalSharing'],
    documentation: 'IRB + partner DUA + institutional agreement',
    deidentification: 'safe_harbor'
  }
};
```

#### Withdrawal Processing

```typescript
interface ConsentWithdrawalService {
  processWithdrawal: (params: {
    patientId: string;
    withdrawalScope: 'all' | 'specific';
    specificConsents?: string[];
    reason?: string;
    effectiveDate?: Date;  // Default: immediate
  }) => Promise<WithdrawalResult>;
}

interface WithdrawalResult {
  withdrawalId: string;
  effectiveAt: Date;

  actionsCompleted: {
    futureDataExcluded: boolean;
    existingResearchUnaffected: boolean;  // Cannot withdraw from completed research
    contactPreferencesUpdated: boolean;
    notificationsSent: boolean;
  };

  notifications: {
    patientConfirmation: boolean;
    researchTeamNotified: boolean;
    dataGovernanceNotified: boolean;
  };

  patientMessage: string;  // Explain what happens next
}

const withdrawalRules = {
  prospectiveOnly: true,  // Cannot withdraw from already-published research
  dataRetention: 'maintain_for_care',  // Clinical data stays for treatment
  researchDataMarking: 'flag_as_withdrawn',  // Mark but don't delete from ongoing studies
  auditTrail: 'permanent',
  notifyActiveStudies: true,
  gracePeriod: null  // Immediate effect
};
```

#### Minor Consent & Re-Consent

```typescript
interface MinorConsentManagement {
  checkMinorStatus: (patientId: string) => Promise<MinorStatus>;
  scheduleReConsent: (patientId: string, eighteenthBirthday: Date) => Promise<void>;
  processAgeOfMajority: (patientId: string) => Promise<ReConsentResult>;
}

interface MinorStatus {
  isMinor: boolean;
  dateOfBirth: Date;
  currentAge: number;
  guardianConsentRequired: boolean;
  guardianId?: string;
  reConsentDate?: Date;
}

interface ReConsentResult {
  patientId: string;
  previousConsentId: string;

  reConsentStatus: 'pending' | 'completed' | 'declined';

  actions: {
    previousConsentSuspended: boolean;
    reConsentEmailSent: boolean;
    reminderScheduled: boolean;
  };

  deadlineForReConsent: Date;  // 30 days to re-consent before data excluded
}

const minorConsentFlow = {
  underEighteen: {
    requirement: 'Parent/guardian consent required',
    patientAssent: 'Required for ages 12-17',
    documentationRequired: ['guardian_signature', 'relationship_verification']
  },
  atEighteen: {
    action: 'Auto-trigger re-consent workflow',
    notification: 'Email + in-app + SMS on 18th birthday',
    gracePeriod: '30 days to complete re-consent',
    ifNotCompleted: 'Exclude from future research, maintain QI only'
  }
};
```

#### Consent Compliance Reporting

```typescript
interface ConsentComplianceReport {
  generatedAt: Date;
  reportPeriod: { start: Date; end: Date };

  overallMetrics: {
    totalActivePatients: number;
    patientsWithConsent: number;
    consentRate: number;

    byConsentType: {
      deidentifiedResearch: { consented: number; declined: number; rate: number };
      commercialResearch: { consented: number; declined: number; rate: number };
      contactForStudies: { consented: number; declined: number; rate: number };
      externalSharing: { consented: number; declined: number; rate: number };
    };
  };

  withdrawals: {
    totalWithdrawals: number;
    withdrawalRate: number;
    topReasons: { reason: string; count: number }[];
  };

  pendingActions: {
    minorReConsentDue: number;
    expiredConsentsNeedingRenewal: number;
    consentVersionUpdatesPending: number;
  };

  complianceIssues: {
    dataUsedWithoutConsent: number;  // Should always be 0
    withdrawalProcessingDelays: number;
    consentDocumentationGaps: number;
  };
}
```

---

### Research Data Access & Governance

```typescript
const researchGovernance = {
  accessTiers: {
    tier1_aggregate: {
      description: 'Pre-computed aggregate statistics',
      data: 'research_treatment_effectiveness, research_cohort_outcomes',
      access: 'self_service_after_training',
      phi: 'none',
      approval: 'automatic'
    },

    tier2_pseudonymized: {
      description: 'Individual-level pseudonymized records',
      data: 'clinical_* tables',
      access: 'research_role_required',
      phi: 'none',
      approval: 'data_governance_committee',
      requirements: ['irb_approval', 'data_use_agreement', 'ethics_training']
    },

    tier3_limited: {
      description: 'Limited dataset with dates/geography',
      data: 'special_extract',
      access: 'formal_request',
      phi: 'limited_per_hipaa',
      approval: 'privacy_officer + legal',
      requirements: ['irb_approval', 'dua', 'institutional_agreement']
    }
  },

  queryRestrictions: {
    minimumCellSize: 10,  // No results with <10 patients
    noPatternQueries: true,  // Block "SELECT * WHERE rare_condition"
    noExactDates: true,  // Only year/quarter/month
    noFreeTextExport: true,  // No unstructured notes

    rateLimit: {
      queriesPerHour: 100,
      recordsPerDay: 100000
    }
  },

  outputReview: {
    automaticReview: {
      smallCellSuppression: true,
      kAnonymityCheck: true,
      differentialPrivacyNoise: 'optional'
    },

    manualReview: {
      triggers: ['export_request', 'unusual_query_pattern', 'large_result_set'],
      reviewer: 'data_governance_analyst'
    }
  }
};
```

---

## GxP Compliance & Pharmaceutical Validation

This section defines the regulatory compliance framework required for pharmaceutical software handling drug data, compounding records, and prescription management.

### Regulatory Framework Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         GxP COMPLIANCE ARCHITECTURE                          │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              FDA REGULATIONS                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│  21 CFR Part 11    │  21 CFR Part 211    │  21 CFR Part 820                │
│  Electronic        │  cGMP for Drugs     │  Quality System                  │
│  Records/Sigs      │  (Compounding)      │  Regulation                      │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           COMPLIANCE CONTROLS                                │
├─────────────────────────────────────────────────────────────────────────────┤
│  ALCOA+           │  Electronic         │  Audit Trails      │  Change     │
│  Data Integrity   │  Signatures         │  (Immutable)       │  Control    │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         SOFTWARE VALIDATION                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  CSV/CSA          │  IQ/OQ/PQ           │  Risk Assessment   │  Traceability│
│  Framework        │  Protocols          │  (GAMP 5)          │  Matrix      │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 21 CFR Part 11 Compliance

21 CFR Part 11 establishes FDA criteria for electronic records and electronic signatures.

#### Requirements Mapping

| Part 11 Requirement | Section | Implementation |
|---------------------|---------|----------------|
| §11.10(a) System validation | Validation Framework | CSV/CSA with IQ/OQ/PQ |
| §11.10(b) Accurate copies | Data Export | Certified PDF/print with hash |
| §11.10(c) Record protection | Data Integrity | Immutable audit trails, no delete |
| §11.10(d) System access | Access Control | RBAC with unique user IDs |
| §11.10(e) Audit trail | Audit System | Computer-generated timestamps |
| §11.10(f) Operational checks | Workflow Controls | Sequence enforcement, step locks |
| §11.10(g) Authority checks | RBAC | Permission validation on every action |
| §11.10(h) Device checks | Input Validation | Source device verification |
| §11.10(i) Training | Training Module | Documented training records |
| §11.10(j) Written policies | SOP Framework | Electronic signature policies |
| §11.10(k) Documentation controls | Change Control | Revision history, approval workflows |
| §11.50 Signature manifestations | E-Signature | Name, date/time, meaning displayed |
| §11.70 Signature linking | E-Signature | Cryptographic binding to record |
| §11.100 General requirements | E-Signature | Unique to individual, not reusable |
| §11.200 Components | E-Signature | Two-factor authentication |
| §11.300 Controls for ID codes | Credentials | Unique IDs, periodic review, revocation |

#### Part 11 Compliant Database Design

```sql
-- ============================================
-- 21 CFR PART 11 COMPLIANT TABLES
-- ============================================

-- Every GxP record must be immutable with full history
CREATE TABLE gxp_record_base (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  record_type VARCHAR(100) NOT NULL,

  -- Version control (no updates, only new versions)
  version INTEGER NOT NULL DEFAULT 1,
  is_current_version BOOLEAN DEFAULT true,
  supersedes_id UUID REFERENCES gxp_record_base(id),

  -- Creation metadata
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by UUID NOT NULL,
  created_by_name VARCHAR(255) NOT NULL,  -- Denormalized for immutability
  created_reason VARCHAR(500) NOT NULL,

  -- Modification tracking
  modified_at TIMESTAMPTZ,
  modified_by UUID,
  modified_by_name VARCHAR(255),
  modification_reason VARCHAR(500),

  -- Electronic signature (if signed)
  signature_id UUID,
  signature_status VARCHAR(50) DEFAULT 'unsigned',

  -- Data integrity
  record_hash VARCHAR(64) NOT NULL,  -- SHA-256 of record content
  previous_hash VARCHAR(64),  -- Hash chain for integrity verification

  -- Archival (never delete)
  is_archived BOOLEAN DEFAULT false,
  archived_at TIMESTAMPTZ,
  archived_by UUID,
  archive_reason VARCHAR(500)
);

-- Ensure records are never updated, only new versions created
-- This is enforced at application layer + DB triggers
CREATE OR REPLACE FUNCTION prevent_gxp_record_update()
RETURNS TRIGGER AS $$
BEGIN
  IF OLD.id = NEW.id AND OLD.version = NEW.version THEN
    RAISE EXCEPTION '21 CFR Part 11 violation: GxP records cannot be modified. Create new version instead.';
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger on all GxP-relevant tables
-- (Applied to: batch_records, prescriptions, qc_results, etc.)

-- Audit trail table (append-only, never modified)
CREATE TABLE gxp_audit_trail (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- What was changed
  record_type VARCHAR(100) NOT NULL,
  record_id UUID NOT NULL,
  record_version INTEGER NOT NULL,

  -- Who changed it
  user_id UUID NOT NULL,
  user_name VARCHAR(255) NOT NULL,  -- Denormalized
  user_role VARCHAR(100) NOT NULL,

  -- When (computer-generated, not user-editable)
  event_timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  system_timestamp TIMESTAMPTZ NOT NULL DEFAULT clock_timestamp(),

  -- What changed
  event_type VARCHAR(50) NOT NULL,  -- created, modified, signed, voided, archived
  field_changes JSONB,  -- { "field": { "old": "x", "new": "y" } }

  -- Why (mandatory for any change)
  reason_for_change VARCHAR(500) NOT NULL,
  reason_code VARCHAR(50),  -- Standardized codes

  -- Integrity
  event_hash VARCHAR(64) NOT NULL,
  previous_event_hash VARCHAR(64),  -- Chain for integrity

  -- Context
  ip_address INET,
  session_id VARCHAR(255),
  workstation_id VARCHAR(100)
);

-- Prevent any modification to audit trail
REVOKE UPDATE, DELETE ON gxp_audit_trail FROM PUBLIC;
CREATE RULE prevent_audit_update AS ON UPDATE TO gxp_audit_trail DO INSTEAD NOTHING;
CREATE RULE prevent_audit_delete AS ON DELETE TO gxp_audit_trail DO INSTEAD NOTHING;
```

---

### Electronic Signatures (21 CFR Part 11 §11.50-11.200)

Electronic signatures must be legally equivalent to handwritten signatures.

#### Signature Types

| Signature Type | Use Cases | Requirements |
|----------------|-----------|--------------|
| **Review** | Document review, data verification | Single factor + reason |
| **Approval** | QC release, batch approval | Two factors + reason |
| **Authorization** | Prescription signing, batch release | Two factors + biometric option |
| **Witness** | Controlled substance witness | Two factors + co-signer required |

#### Electronic Signature Data Model

```typescript
interface ElectronicSignature {
  id: string;

  // Signer identification
  signerId: string;
  signerName: string;  // Full legal name
  signerTitle: string;
  signerCredentials?: string[];  // PharmD, MD, etc.

  // Signature manifestation (§11.50)
  printedName: string;
  signatureDateTime: Date;  // Computer-generated
  signatureMeaning: SignatureMeaning;
  signerStatement?: string;  // Custom statement

  // What is being signed
  signedRecordType: string;
  signedRecordId: string;
  signedRecordVersion: number;
  signedContentHash: string;  // SHA-256 of exact content signed

  // Authentication (§11.200)
  authenticationMethod: 'password_biometric' | 'password_token' | 'password_otp';
  authFactor1Type: 'password' | 'pin';
  authFactor2Type: 'biometric' | 'hardware_token' | 'otp' | 'smart_card';
  authFactor1Timestamp: Date;
  authFactor2Timestamp: Date;

  // Non-repudiation
  signatureToken: string;  // Cryptographic signature
  certificateId?: string;  // If using PKI
  signatureAlgorithm: 'RSA-SHA256' | 'ECDSA-P256';

  // Context
  signingReason: string;
  ipAddress: string;
  deviceFingerprint: string;
  geolocation?: string;

  // Linking (§11.70)
  linkedToRecord: boolean;
  linkingMethod: 'hash_chain' | 'cryptographic_binding';
  verificationStatus: 'valid' | 'invalid' | 'expired' | 'revoked';

  createdAt: Date;
}

type SignatureMeaning =
  | 'authored'      // "I wrote/created this"
  | 'reviewed'      // "I have reviewed this"
  | 'approved'      // "I approve this"
  | 'verified'      // "I verified this is accurate"
  | 'witnessed'     // "I witnessed this action"
  | 'released'      // "I release this for use/distribution"
  | 'rejected'      // "I reject this"
  | 'voided';       // "I void this record"

interface SignatureManifest {
  // What the user sees when signing
  signaturePrompt: string;
  meaningOptions: SignatureMeaning[];
  requiresReason: boolean;
  reasonCodes?: string[];
  customStatementAllowed: boolean;
  witnessRequired: boolean;
}
```

#### Signature Workflow

```
User initiates signature on GxP record
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│  Electronic Signature                                        │
│                                                             │
│  Document: Batch Record #BR-2026-0215                       │
│  Action: Release for Distribution                           │
│                                                             │
│  I, [Sarah Johnson, PharmD], am signing to indicate:        │
│                                                             │
│  ○ I have reviewed this document                           │
│  ○ I approve this document                                 │
│  ● I am releasing this batch for distribution              │
│                                                             │
│  Reason: [Standard release - all QC parameters met     ▼]  │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│                                                             │
│  Step 1: Enter your password                                │
│  [••••••••••••]                                            │
│                                                             │
│  Step 2: Verify with second factor                         │
│  [Approve on authenticator app] or [Enter OTP: ______]     │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│                                                             │
│  By signing, I understand that this electronic signature   │
│  is legally binding and equivalent to a handwritten        │
│  signature under 21 CFR Part 11.                           │
│                                                             │
│  [Cancel]                              [Sign Document]      │
└─────────────────────────────────────────────────────────────┘
         │
         ▼
Both factors verified
         │
         ▼
Generate cryptographic signature of record content
         │
         ▼
Store signature with record + audit trail entry
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│  ✓ Document Signed Successfully                             │
│                                                             │
│  Signed by: Sarah Johnson, PharmD                          │
│  Date/Time: February 9, 2026, 2:45:32 PM EST               │
│  Meaning: Released for distribution                         │
│  Signature ID: SIG-2026-0209-1445-32-SJ                    │
│                                                             │
│  This signature has been cryptographically bound to the    │
│  document and recorded in the audit trail.                 │
└─────────────────────────────────────────────────────────────┘
```

#### Signature Verification

```typescript
const verifyElectronicSignature = async (
  signatureId: string
): Promise<SignatureVerificationResult> => {
  const signature = await getSignature(signatureId);
  const record = await getSignedRecord(signature.signedRecordId, signature.signedRecordVersion);

  // 1. Verify record content hasn't changed
  const currentHash = computeHash(record.content);
  const hashValid = currentHash === signature.signedContentHash;

  // 2. Verify cryptographic signature
  const cryptoValid = verifyCryptoSignature(
    signature.signedContentHash,
    signature.signatureToken,
    signature.signerId
  );

  // 3. Verify signer credentials were valid at signing time
  const signerValid = await verifySignerCredentials(
    signature.signerId,
    signature.signatureDateTime
  );

  // 4. Check certificate status (if PKI)
  const certValid = signature.certificateId
    ? await verifyCertificate(signature.certificateId, signature.signatureDateTime)
    : true;

  return {
    signatureId,
    isValid: hashValid && cryptoValid && signerValid && certValid,
    checks: {
      contentIntegrity: hashValid,
      cryptographicValidity: cryptoValid,
      signerAuthorization: signerValid,
      certificateStatus: certValid
    },
    verifiedAt: new Date()
  };
};
```

---

### ALCOA+ Data Integrity Framework

ALCOA+ principles ensure data integrity throughout the data lifecycle.

#### ALCOA+ Requirements Mapping

| Principle | Requirement | Implementation |
|-----------|-------------|----------------|
| **A**ttributable | Data traceable to who created it | User ID on all records, audit trail |
| **L**egible | Data readable and permanent | No abbreviations without legend, validated displays |
| **C**ontemporaneous | Recorded at time of activity | System timestamps, no backdating |
| **O**riginal | First capture of data | Original record preservation, certified copies |
| **A**ccurate | No errors, editing documented | Validation rules, change tracking |
| **C**omplete | All data present, nothing deleted | Required fields, archive (not delete) |
| **C**onsistent | Data consistent across systems | Cross-system validation, reconciliation |
| **E**nduring | Data preserved for required period | Retention policies, migration validation |
| **A**vailable | Data accessible when needed | Availability SLAs, backup verification |

#### ALCOA+ Implementation

```typescript
interface ALCOAPlusRecord {
  // ATTRIBUTABLE
  attribution: {
    createdBy: string;
    createdByName: string;
    createdByRole: string;
    createdAt: Date;
    createdFromDevice: string;
    createdFromLocation?: string;

    modifiedHistory: AttributionEntry[];
  };

  // LEGIBLE
  legibility: {
    displayFormat: 'standard' | 'scientific' | 'custom';
    abbreviationsUsed: { abbrev: string; meaning: string }[];
    unitsOfMeasure: string;
    decimalPrecision: number;
    renderingValidated: boolean;
  };

  // CONTEMPORANEOUS
  contemporaneity: {
    eventTimestamp: Date;  // When the activity occurred
    recordTimestamp: Date;  // When recorded (should match or be very close)
    timeDeltaSeconds: number;  // Difference (flag if > threshold)
    timestampSource: 'system_clock' | 'synchronized_ntp';
    ntpServerUsed?: string;
  };

  // ORIGINAL
  originality: {
    isOriginal: boolean;
    originalRecordId?: string;  // If this is a copy
    copyType?: 'true_copy' | 'certified_copy' | 'summary';
    copyReason?: string;
    originalPreserved: boolean;
  };

  // ACCURATE
  accuracy: {
    validationRulesApplied: string[];
    validationsPassed: boolean;
    validationErrors: ValidationError[];
    dataSource: 'manual_entry' | 'instrument' | 'calculated' | 'imported';
    calculationFormula?: string;
    instrumentId?: string;
  };

  // COMPLETE
  completeness: {
    requiredFieldsPresent: boolean;
    missingFields: string[];
    intentionallyBlank: { field: string; reason: string }[];
    attachmentsExpected: number;
    attachmentsPresent: number;
  };

  // CONSISTENT
  consistency: {
    crossReferencedRecords: string[];
    consistencyChecks: ConsistencyCheck[];
    discrepanciesFound: Discrepancy[];
    reconciliationStatus: 'consistent' | 'discrepancy_noted' | 'under_review';
  };

  // ENDURING
  endurance: {
    retentionCategory: string;
    retentionPeriodYears: number;
    retentionStartDate: Date;
    scheduledDestructionDate?: Date;
    storageLocation: string;
    backupLocations: string[];
    migrationHistory: MigrationEvent[];
  };

  // AVAILABLE
  availability: {
    accessLevel: 'immediate' | 'archive' | 'deep_archive';
    retrievalTimeSLA: string;  // e.g., "< 1 minute", "< 24 hours"
    lastAccessedAt?: Date;
    accessCount: number;
  };
}

interface ValidationError {
  field: string;
  rule: string;
  value: any;
  expectedValue?: any;
  errorMessage: string;
  severity: 'error' | 'warning';
  overriddenBy?: string;
  overrideReason?: string;
}

interface ConsistencyCheck {
  checkType: string;
  relatedRecordId: string;
  relatedField: string;
  expectedValue: any;
  actualValue: any;
  isConsistent: boolean;
  checkedAt: Date;
}
```

#### Data Entry Controls

```typescript
const dataEntryControls = {
  // Prevent backdating
  timestampControls: {
    systemGeneratedOnly: true,
    userTimestampAllowed: false,
    maxDelayBeforeEntry: '24_hours',  // Flag if > 24 hours between activity and entry
    delayRequiresReason: true
  },

  // Ensure completeness
  completenessControls: {
    requiredFieldsEnforced: true,
    partialSaveAllowed: false,  // Must complete all required fields
    intentionalBlankRequiresReason: true,
    attachmentValidation: true
  },

  // Ensure accuracy
  accuracyControls: {
    rangeChecks: true,
    formatValidation: true,
    crossFieldValidation: true,
    duplicateDetection: true,
    spellCheckOnFreeText: false,  // Free text should be exact

    instrumentDataValidation: {
      checksumValidation: true,
      rawDataPreservation: true,
      manualOverrideRequiresReason: true
    }
  },

  // Change controls
  changeControls: {
    noDeleteAllowed: true,
    noOverwriteAllowed: true,
    versioningRequired: true,
    reasonForChangeRequired: true,
    approvalForCriticalChanges: true,
    originalVisibleAfterChange: true  // Strikethrough, not hidden
  }
};
```

---

### Electronic Batch Records (EBR)

Compounding requires electronic batch records that meet cGMP requirements.

#### Batch Record Structure

```typescript
interface MasterBatchRecord {
  // Template definition (never executed, only copied)
  id: string;
  productId: string;
  productName: string;
  dosageForm: string;
  strength: string;

  version: number;
  status: 'draft' | 'approved' | 'superseded' | 'obsolete';

  // Approval chain
  createdBy: string;
  createdAt: Date;
  reviewedBy?: string;
  reviewedAt?: Date;
  approvedBy?: string;
  approvedAt?: Date;

  // Formulation
  formula: {
    ingredients: MasterIngredient[];
    totalBatchSize: number;
    batchSizeUnit: string;
    yield: { expected: number; tolerance: number };
  };

  // Equipment
  equipment: {
    equipmentType: string;
    specifications: string;
    alternatives?: string[];
  }[];

  // Manufacturing steps
  manufacturingSteps: MasterStep[];

  // Quality checks
  inProcessControls: InProcessControl[];
  finalSpecifications: Specification[];

  // Documentation
  batchRecordForm: BatchRecordField[];
  requiredDocuments: string[];
}

interface MasterStep {
  stepNumber: number;
  instruction: string;
  criticalStep: boolean;
  verificationRequired: boolean;
  witnessRequired: boolean;
  duration?: { min: number; max: number; unit: string };
  temperature?: { min: number; max: number; unit: string };
  parameters: StepParameter[];
}

interface ExecutedBatchRecord {
  // Executed instance
  id: string;
  batchNumber: string;
  masterBatchRecordId: string;
  masterBatchRecordVersion: number;

  // Patient-specific (for 503A compounding)
  patientId?: string;  // Pseudonymized for record
  prescriptionId?: string;

  status: 'in_progress' | 'pending_review' | 'pending_release' | 'released' | 'rejected' | 'quarantined';

  // Execution dates
  startedAt: Date;
  completedAt?: Date;
  releasedAt?: Date;

  // Actual formulation
  actualFormula: {
    ingredients: ExecutedIngredient[];
    actualBatchSize: number;
    actualYield: number;
    yieldVariance: number;
  };

  // Executed steps
  executedSteps: ExecutedStep[];

  // In-process results
  inProcessResults: InProcessResult[];

  // Final testing
  finalTestResults: TestResult[];

  // Deviations
  deviations: Deviation[];

  // Signatures
  preparedBy: ElectronicSignature;
  checkedBy: ElectronicSignature;
  releasedBy?: ElectronicSignature;

  // Lot traceability
  componentLots: ComponentLot[];

  // Documentation
  attachments: BatchAttachment[];
}

interface ExecutedStep {
  stepNumber: number;
  masterStepId: string;
  instruction: string;  // Copied for record

  status: 'pending' | 'in_progress' | 'completed' | 'skipped' | 'failed';

  startedAt?: Date;
  completedAt?: Date;

  performedBy: string;
  performedByName: string;
  performedBySignature?: ElectronicSignature;

  verifiedBy?: string;
  verifiedByName?: string;
  verifiedBySignature?: ElectronicSignature;

  witnessedBy?: string;
  witnessedByName?: string;
  witnessedBySignature?: ElectronicSignature;

  actualParameters: {
    parameterId: string;
    parameterName: string;
    expectedValue: string;
    actualValue: string;
    withinSpec: boolean;
  }[];

  notes?: string;
  deviationId?: string;
}

interface Deviation {
  id: string;
  batchRecordId: string;
  stepNumber?: number;

  type: 'planned' | 'unplanned';
  category: 'process' | 'equipment' | 'material' | 'environment' | 'documentation' | 'other';

  description: string;
  rootCause?: string;
  impact: 'none' | 'minor' | 'major' | 'critical';
  impactAssessment: string;

  correctiveAction: string;
  preventiveAction?: string;

  reportedBy: string;
  reportedAt: Date;
  reviewedBy?: string;
  reviewedAt?: Date;
  approvedBy?: string;
  approvedAt?: Date;

  status: 'open' | 'under_review' | 'closed' | 'capa_required';
}

interface ComponentLot {
  ingredientId: string;
  ingredientName: string;
  lotNumber: string;
  manufacturerLot: string;
  supplierId: string;
  supplierName: string;

  coaOnFile: boolean;
  coaVerifiedBy?: string;
  coaVerifiedAt?: Date;

  expirationDate: Date;
  quantityUsed: number;
  unit: string;

  // Full traceability
  receivedDate: Date;
  receivedBy: string;
  storageLocation: string;
  storageConditions: string;
}
```

#### Batch Record Workflow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         BATCH RECORD WORKFLOW                                │
└─────────────────────────────────────────────────────────────────────────────┘

Order received for compounded product
         │
         ▼
System creates Executed Batch Record from Master
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│  COMPOUNDING PHASE                                          │
│                                                             │
│  For each step:                                             │
│  1. Display instruction                                     │
│  2. Technician performs step                                │
│  3. Record actual values                                    │
│  4. Technician signs step                                   │
│  5. If verification required → Second person verifies       │
│  6. If witness required → Witness signs                     │
│  7. Any deviation → Create deviation record                 │
└─────────────────────────────────────────────────────────────┘
         │
         ▼
All steps completed
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│  IN-PROCESS CONTROL                                         │
│                                                             │
│  • pH check                                                 │
│  • Visual inspection                                        │
│  • Weight/volume verification                               │
│  • Particle check (if injectable)                           │
│                                                             │
│  All results recorded with signatures                       │
└─────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│  FINAL QC                                                   │
│                                                             │
│  • Final specifications check                               │
│  • Sterility (if applicable)                                │
│  • Potency verification                                     │
│  • Label verification                                       │
│                                                             │
│  QC signs off on all tests                                  │
└─────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│  BATCH REVIEW                                               │
│                                                             │
│  Pharmacist reviews:                                        │
│  • All steps completed and signed                           │
│  • All parameters within spec                               │
│  • All deviations addressed                                 │
│  • All QC tests passed                                      │
│  • Documentation complete                                   │
│                                                             │
│  [Reject with Reason]        [Release Batch]                │
└─────────────────────────────────────────────────────────────┘
         │
         ▼
Pharmacist signs electronic release
         │
         ▼
Batch status → Released
         │
         ▼
Available for dispensing/shipping
```

---

### Software Validation Framework (CSV/CSA)

#### GAMP 5 Software Categorization

| Category | Type | Validation Approach |
|----------|------|---------------------|
| 1 | Infrastructure (OS, DB) | Vendor documentation, installation verification |
| 3 | Non-configured products | Vendor audit, black-box testing |
| 4 | Configured products | Configuration documentation, functional testing |
| 5 | Custom applications | Full lifecycle validation (our platform) |

**Our platform is Category 5** - requires full validation.

#### Validation Lifecycle

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    SOFTWARE VALIDATION LIFECYCLE                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│    PLAN      │ ──▶ │    SPECIFY   │ ──▶ │    BUILD     │ ──▶ │   VERIFY     │
│              │     │              │     │              │     │              │
│ • Risk Assess│     │ • URS        │     │ • Development│     │ • IQ         │
│ • Val Plan   │     │ • FRS        │     │ • Config     │     │ • OQ         │
│ • Resource   │     │ • DS         │     │ • Unit Test  │     │ • PQ         │
└──────────────┘     └──────────────┘     └──────────────┘     └──────────────┘
                                                                       │
                                                                       ▼
                                          ┌──────────────┐     ┌──────────────┐
                                          │   RELEASE    │ ◀── │   REPORT     │
                                          │              │     │              │
                                          │ • Go-Live    │     │ • Val Report │
                                          │ • Training   │     │ • Traceability│
                                          └──────────────┘     └──────────────┘
                                                  │
                                                  ▼
                                          ┌──────────────┐
                                          │   MAINTAIN   │
                                          │              │
                                          │ • Change Ctrl│
                                          │ • Periodic   │
                                          │   Review     │
                                          └──────────────┘
```

#### Validation Documentation Structure

```typescript
interface ValidationPackage {
  // Planning
  validationPlan: {
    id: string;
    systemName: string;
    systemVersion: string;
    scope: string;
    approach: 'traditional_csv' | 'csa_risk_based';
    riskAssessment: RiskAssessment;
    resources: Resource[];
    timeline: Milestone[];
    approvals: Approval[];
  };

  // Specifications
  userRequirementsSpec: {
    id: string;
    requirements: UserRequirement[];
    approvals: Approval[];
  };

  functionalRequirementsSpec: {
    id: string;
    requirements: FunctionalRequirement[];
    traceabilityToURS: TraceabilityLink[];
    approvals: Approval[];
  };

  designSpecification: {
    id: string;
    architectureDescription: string;
    dataFlowDiagrams: string[];
    securityDesign: string;
    traceabilityToFRS: TraceabilityLink[];
    approvals: Approval[];
  };

  // Qualification Protocols
  installationQualification: {
    id: string;
    prerequisites: string[];
    testCases: IQTestCase[];
    executedBy?: string;
    executedAt?: Date;
    results?: IQResult[];
    approvals?: Approval[];
  };

  operationalQualification: {
    id: string;
    testCases: OQTestCase[];
    executedBy?: string;
    executedAt?: Date;
    results?: OQResult[];
    deviations?: Deviation[];
    approvals?: Approval[];
  };

  performanceQualification: {
    id: string;
    testCases: PQTestCase[];
    executedBy?: string;
    executedAt?: Date;
    results?: PQResult[];
    deviations?: Deviation[];
    approvals?: Approval[];
  };

  // Traceability
  traceabilityMatrix: TraceabilityMatrix;

  // Final Report
  validationReport: {
    id: string;
    summary: string;
    testsSummary: { passed: number; failed: number; deviations: number };
    deviationsSummary: string;
    conclusion: string;
    limitations?: string;
    approvals: Approval[];
  };
}

interface RiskAssessment {
  methodology: 'FMEA' | 'HACCP' | 'custom';

  systemRisks: {
    function: string;
    hazard: string;
    harm: string;
    severity: 1 | 2 | 3 | 4 | 5;
    likelihood: 1 | 2 | 3 | 4 | 5;
    detectability: 1 | 2 | 3 | 4 | 5;
    riskPriorityNumber: number;  // S x L x D
    riskLevel: 'low' | 'medium' | 'high' | 'critical';
    mitigations: string[];
    residualRisk: 'acceptable' | 'unacceptable';
  }[];

  criticalFunctions: string[];  // Functions requiring enhanced testing
}

interface UserRequirement {
  id: string;  // URS-001, URS-002, etc.
  category: 'functional' | 'data' | 'interface' | 'security' | 'performance' | 'regulatory';
  requirement: string;
  rationale: string;
  priority: 'must' | 'should' | 'could';
  regulatorySource?: string;  // e.g., "21 CFR 11.10(e)"
  verificationMethod: 'test' | 'inspection' | 'analysis' | 'demonstration';
}

interface TraceabilityMatrix {
  // URS → FRS → DS → Test Case → Test Result
  links: {
    ursId: string;
    frsIds: string[];
    dsIds: string[];
    testCaseIds: string[];
    testResultIds: string[];
    status: 'fully_traced' | 'partially_traced' | 'not_traced';
  }[];

  coverage: {
    ursRequirements: number;
    frsRequirements: number;
    testCases: number;
    coveragePercent: number;
  };
}
```

#### IQ/OQ/PQ Test Examples

```typescript
const iqTestCases: IQTestCase[] = [
  {
    id: 'IQ-001',
    objective: 'Verify database server installation',
    procedure: [
      'Connect to database server',
      'Verify PostgreSQL version is 15.x',
      'Verify extensions: pgcrypto, uuid-ossp installed',
      'Verify connection encryption enabled'
    ],
    expectedResult: 'PostgreSQL 15.x running with required extensions and TLS enabled',
    acceptanceCriteria: 'All items verified'
  },
  {
    id: 'IQ-002',
    objective: 'Verify encryption key management',
    procedure: [
      'Verify AWS KMS key exists',
      'Verify key rotation policy (90 days)',
      'Verify key access restricted to application role'
    ],
    expectedResult: 'KMS key configured with rotation and proper access controls',
    acceptanceCriteria: 'All items verified'
  }
];

const oqTestCases: OQTestCase[] = [
  {
    id: 'OQ-001',
    ursTraceability: ['URS-015'],
    objective: 'Verify audit trail captures all record changes',
    preconditions: ['Test user logged in', 'Test batch record exists'],
    procedure: [
      'Modify batch record field',
      'Provide reason for change',
      'Save record',
      'Query audit trail for record'
    ],
    expectedResult: 'Audit trail contains: old value, new value, user, timestamp, reason',
    acceptanceCriteria: 'All five elements present in audit trail',
    regulatoryRequirement: '21 CFR 11.10(e)'
  },
  {
    id: 'OQ-002',
    ursTraceability: ['URS-022'],
    objective: 'Verify electronic signature requires two factors',
    preconditions: ['Test user with signature privilege', 'Document requiring signature'],
    procedure: [
      'Initiate signature',
      'Attempt to sign with password only',
      'Verify signature fails',
      'Sign with password + OTP',
      'Verify signature succeeds'
    ],
    expectedResult: 'Signature requires both password and second factor',
    acceptanceCriteria: 'Single-factor signature rejected, two-factor signature accepted',
    regulatoryRequirement: '21 CFR 11.200'
  }
];

const pqTestCases: PQTestCase[] = [
  {
    id: 'PQ-001',
    objective: 'Verify end-to-end batch record workflow',
    scenario: 'Complete compounding of testosterone cypionate 200mg/mL',
    actors: ['Compounding Tech', 'QC Technician', 'Pharmacist'],
    steps: [
      { actor: 'System', action: 'Receive prescription order' },
      { actor: 'System', action: 'Generate batch record from master' },
      { actor: 'Compounding Tech', action: 'Execute each compounding step' },
      { actor: 'Compounding Tech', action: 'Sign completed steps' },
      { actor: 'QC Technician', action: 'Perform in-process controls' },
      { actor: 'QC Technician', action: 'Record results and sign' },
      { actor: 'Pharmacist', action: 'Review completed batch record' },
      { actor: 'Pharmacist', action: 'Release batch with signature' }
    ],
    expectedResult: 'Batch record complete with all signatures, released for dispensing',
    acceptanceCriteria: [
      'All steps executed and signed',
      'All parameters within specification',
      'No unresolved deviations',
      'Final release signature present'
    ],
    duration: '60 minutes'
  }
];
```

---

### Change Control System

#### Change Control Process

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         CHANGE CONTROL WORKFLOW                              │
└─────────────────────────────────────────────────────────────────────────────┘

Change Request Submitted
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│  CHANGE REQUEST                                             │
│                                                             │
│  Type: [ ] Software  [ ] Infrastructure  [ ] Configuration │
│  Category: [ ] Bug Fix  [ ] Enhancement  [ ] Security Patch│
│                                                             │
│  Description: _________________________________________     │
│  Justification: _______________________________________     │
│  Affected Systems: ____________________________________     │
│  Requested By: ____________  Date: ____________            │
└─────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│  IMPACT ASSESSMENT                                          │
│                                                             │
│  GxP Impact:    [ ] None  [ ] Minor  [ ] Major  [ ] Critical│
│  Validation Impact: [ ] None  [ ] Partial  [ ] Full Reval  │
│  Regulatory Impact: [ ] None  [ ] Notification  [ ] Filing │
│                                                             │
│  Systems Affected:                                          │
│  ☑ Batch Records  ☐ Prescriptions  ☑ Audit Trail          │
│                                                             │
│  Risk Assessment:                                           │
│  [ ] Low - Standard testing                                │
│  [●] Medium - Enhanced testing, QA review                  │
│  [ ] High - Full regression, stakeholder approval          │
│                                                             │
│  Assessed By: ____________  Date: ____________             │
└─────────────────────────────────────────────────────────────┘
         │
         ▼
Impact determines approval level
         │
    ┌────┴────┬────────────┬────────────┐
    ▼         ▼            ▼            ▼
  None      Minor        Major       Critical
    │         │            │            │
    ▼         ▼            ▼            ▼
 Auto      Single       CCB          CCB +
Approve   Approver    Review      Exec Approval
    │         │            │            │
    └─────────┴────────────┴────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  IMPLEMENTATION PLANNING                                    │
│                                                             │
│  Test Plan:                                                 │
│  • Unit tests affected: 12                                  │
│  • Integration tests affected: 5                            │
│  • OQ test cases to re-execute: OQ-001, OQ-015, OQ-023     │
│                                                             │
│  Rollback Plan: ________________________________________   │
│  Implementation Window: _________________________________   │
│  Communication Plan: ____________________________________   │
└─────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│  IMPLEMENTATION & VERIFICATION                              │
│                                                             │
│  ☑ Code changes implemented                                │
│  ☑ Unit tests passed                                       │
│  ☑ Integration tests passed                                │
│  ☑ OQ test cases re-executed                               │
│  ☑ QA review completed                                     │
│  ☑ Documentation updated                                   │
│                                                             │
│  Verified By: ____________  Date: ____________             │
└─────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│  CLOSURE                                                    │
│                                                             │
│  ☑ All test evidence attached                              │
│  ☑ Traceability matrix updated                             │
│  ☑ Training completed (if required)                        │
│  ☑ Production deployment successful                        │
│  ☑ Post-deployment verification complete                   │
│                                                             │
│  Change Effective Date: ____________                        │
│  Closed By: ____________  Date: ____________               │
└─────────────────────────────────────────────────────────────┘
```

#### Change Control Data Model

```typescript
interface ChangeRequest {
  id: string;
  changeNumber: string;  // CR-2026-0001

  // Request details
  title: string;
  description: string;
  justification: string;
  requestedBy: string;
  requestedAt: Date;

  type: 'software' | 'infrastructure' | 'configuration' | 'document' | 'process';
  category: 'bug_fix' | 'enhancement' | 'security_patch' | 'regulatory' | 'corrective_action';
  priority: 'low' | 'medium' | 'high' | 'critical';

  // Impact assessment
  impactAssessment: {
    assessedBy: string;
    assessedAt: Date;

    gxpImpact: 'none' | 'minor' | 'major' | 'critical';
    validationImpact: 'none' | 'partial_revalidation' | 'full_revalidation';
    regulatoryImpact: 'none' | 'notification' | 'filing_required';

    affectedSystems: string[];
    affectedDocuments: string[];
    affectedProcesses: string[];

    riskLevel: 'low' | 'medium' | 'high';
    riskJustification: string;
  };

  // Approval
  approvalLevel: 'auto' | 'single' | 'ccb' | 'executive';
  approvals: ChangeApproval[];
  status: 'draft' | 'pending_assessment' | 'pending_approval' | 'approved' | 'in_progress' | 'verification' | 'closed' | 'rejected';

  // Implementation
  implementation: {
    plannedDate: Date;
    actualDate?: Date;
    implementedBy?: string;

    testPlan: string;
    testCasesToExecute: string[];
    rollbackPlan: string;

    testResults?: {
      testCaseId: string;
      result: 'pass' | 'fail';
      executedBy: string;
      executedAt: Date;
      evidence?: string;
    }[];
  };

  // Closure
  closure?: {
    closedBy: string;
    closedAt: Date;
    effectiveDate: Date;
    closureSummary: string;
    lessonsLearned?: string;
  };

  // Audit
  auditTrail: ChangeAuditEntry[];
}

interface ChangeApproval {
  approverRole: string;
  approverId: string;
  approverName: string;
  decision: 'approved' | 'rejected' | 'pending';
  comments?: string;
  decidedAt?: Date;
  signature?: ElectronicSignature;
}
```

#### Validated State Monitoring

```typescript
const validatedStateMonitoring = {
  continuousMonitoring: {
    // System health checks
    systemChecks: [
      { check: 'database_connectivity', frequency: '1_minute' },
      { check: 'encryption_key_status', frequency: '1_hour' },
      { check: 'audit_trail_integrity', frequency: '1_hour' },
      { check: 'ntp_synchronization', frequency: '5_minutes' },
      { check: 'certificate_expiration', frequency: '1_day' }
    ],

    // Data integrity checks
    integrityChecks: [
      { check: 'audit_trail_hash_chain', frequency: '1_hour' },
      { check: 'batch_record_hash_verification', frequency: '1_day' },
      { check: 'signature_validity', frequency: '1_day' }
    ],

    // Alert thresholds
    alerts: {
      criticalSystemDown: 'immediate_page',
      integrityViolation: 'immediate_page',
      encryptionKeyIssue: 'immediate_email',
      certificateExpiring: '30_day_warning'
    }
  },

  periodicReviews: {
    daily: [
      'Review system alerts',
      'Verify backup completion',
      'Check pending changes'
    ],
    weekly: [
      'Review change requests',
      'Audit trail sampling',
      'Access review'
    ],
    monthly: [
      'Security patch review',
      'Performance trending',
      'Deviation trending'
    ],
    annual: [
      'Full system review',
      'Risk assessment update',
      'Validation status review',
      'Disaster recovery test'
    ]
  }
};
```

---

### Disaster Recovery & Data Integrity

#### Recovery Objectives

| Metric | Target | Rationale |
|--------|--------|-----------|
| **RPO** (Recovery Point Objective) | 1 hour | Maximum data loss acceptable |
| **RTO** (Recovery Time Objective) | 4 hours | Maximum downtime acceptable |
| **Data Integrity Verification** | 100% | No corrupt data after recovery |

#### Disaster Recovery Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      DISASTER RECOVERY ARCHITECTURE                          │
└─────────────────────────────────────────────────────────────────────────────┘

PRIMARY REGION (us-west-2)                 DR REGION (us-east-1)
┌─────────────────────────┐                ┌─────────────────────────┐
│  Application Servers    │                │  Application Servers    │
│  (Active)               │                │  (Standby)              │
└─────────────────────────┘                └─────────────────────────┘
           │                                          │
           ▼                                          ▼
┌─────────────────────────┐    Sync        ┌─────────────────────────┐
│  PostgreSQL Primary     │ ──────────────▶│  PostgreSQL Replica     │
│  (RDS Multi-AZ)         │   < 1 min      │  (Read Replica)         │
└─────────────────────────┘                └─────────────────────────┘
           │                                          │
           ▼                                          ▼
┌─────────────────────────┐    Sync        ┌─────────────────────────┐
│  S3 (Documents, Audit)  │ ──────────────▶│  S3 (Cross-Region Rep)  │
└─────────────────────────┘   < 15 min     └─────────────────────────┘

┌─────────────────────────┐                ┌─────────────────────────┐
│  Backup (Daily)         │                │  Backup Copy            │
│  - Full DB snapshot     │ ──────────────▶│  - 90 day retention     │
│  - Audit log archive    │   Nightly      │  - Encrypted            │
│  - Encryption key backup│                │  - Integrity verified   │
└─────────────────────────┘                └─────────────────────────┘
```

#### Recovery Procedure with Integrity Verification

```typescript
interface DisasterRecoveryProcedure {
  phases: [
    {
      name: 'detection_and_declaration',
      steps: [
        'Detect failure (automated monitoring)',
        'Assess scope of impact',
        'Declare disaster (requires DR Lead approval)',
        'Notify stakeholders',
        'Activate DR team'
      ],
      timeTarget: '30 minutes'
    },
    {
      name: 'failover',
      steps: [
        'Promote DR database replica to primary',
        'Update DNS to point to DR region',
        'Verify application servers in DR region',
        'Enable DR region load balancer',
        'Disable primary region (prevent split-brain)'
      ],
      timeTarget: '1 hour'
    },
    {
      name: 'integrity_verification',
      steps: [
        'Run audit trail hash chain verification',
        'Verify last known good checkpoint',
        'Compare record counts: primary vs DR',
        'Verify signature chain integrity',
        'Run critical data sampling verification',
        'Document any discrepancies'
      ],
      timeTarget: '1 hour',
      critical: true
    },
    {
      name: 'validation',
      steps: [
        'Execute abbreviated OQ test suite',
        'Verify electronic signature functionality',
        'Verify batch record creation',
        'Verify audit trail recording',
        'Document test results'
      ],
      timeTarget: '1 hour'
    },
    {
      name: 'go_live',
      steps: [
        'QA approval of integrity verification',
        'QA approval of validation testing',
        'Enable user access',
        'Notify users of restoration',
        'Monitor for issues'
      ],
      timeTarget: '30 minutes'
    }
  ];

  postRecoveryActions: [
    'Complete incident report',
    'Root cause analysis',
    'Update DR procedures if needed',
    'Plan failback to primary region',
    'Execute failback (with integrity verification)'
  ];
}

const integrityVerification = {
  auditTrailVerification: async () => {
    // Verify hash chain is intact
    const records = await getAuditRecordsInOrder();
    let previousHash = null;

    for (const record of records) {
      if (record.previous_event_hash !== previousHash) {
        throw new IntegrityError(`Hash chain broken at record ${record.id}`);
      }

      const computedHash = computeHash(record);
      if (computedHash !== record.event_hash) {
        throw new IntegrityError(`Hash mismatch at record ${record.id}`);
      }

      previousHash = record.event_hash;
    }

    return { verified: true, recordCount: records.length };
  },

  batchRecordVerification: async () => {
    // Verify all batch records have valid hashes
    const batchRecords = await getBatchRecordsWithSignatures();

    for (const batch of batchRecords) {
      const computedHash = computeHash(batch.content);
      if (computedHash !== batch.record_hash) {
        throw new IntegrityError(`Batch record ${batch.id} hash mismatch`);
      }

      // Verify signatures
      for (const sig of batch.signatures) {
        const sigValid = await verifyElectronicSignature(sig.id);
        if (!sigValid.isValid) {
          throw new IntegrityError(`Batch record ${batch.id} has invalid signature ${sig.id}`);
        }
      }
    }

    return { verified: true, recordCount: batchRecords.length };
  },

  recordCountReconciliation: async (primaryCounts: RecordCounts, drCounts: RecordCounts) => {
    const discrepancies = [];

    for (const table of Object.keys(primaryCounts)) {
      if (primaryCounts[table] !== drCounts[table]) {
        discrepancies.push({
          table,
          primary: primaryCounts[table],
          dr: drCounts[table],
          difference: primaryCounts[table] - drCounts[table]
        });
      }
    }

    if (discrepancies.length > 0) {
      // Within RPO window, some difference is acceptable
      const withinRPO = discrepancies.every(d =>
        d.difference <= getExpectedRecordsInRPO(d.table)
      );

      if (!withinRPO) {
        throw new IntegrityError('Record count discrepancy exceeds RPO tolerance');
      }
    }

    return { verified: true, discrepancies };
  }
};
```

#### Backup Integrity Verification

```typescript
const backupIntegrityProcess = {
  // Every backup includes integrity metadata
  backupMetadata: {
    backupId: string;
    backupTimestamp: Date;
    backupType: 'full' | 'incremental';

    // Checksums for verification
    databaseChecksum: string;
    auditLogChecksum: string;
    documentsChecksum: string;

    // Record counts at backup time
    recordCounts: {
      batchRecords: number;
      prescriptions: number;
      auditEvents: number;
      signatures: number;
    };

    // Last audit event (for continuity verification)
    lastAuditEventId: string;
    lastAuditEventHash: string;
  };

  // Monthly backup restoration test
  monthlyRestoreTest: {
    procedure: [
      'Select random backup from last 30 days',
      'Restore to isolated environment',
      'Run integrity verification suite',
      'Execute sample transactions',
      'Verify audit trail captures new events',
      'Document results',
      'Destroy isolated environment'
    ],
    successCriteria: [
      'All integrity checks pass',
      'Record counts match backup metadata',
      'Audit trail hash chain valid',
      'Sample transactions complete successfully'
    ]
  }
};
```

---

### Compliance Gap Summary

Based on this framework, here are the items **now addressed**:

| Requirement | Status | Section |
|-------------|--------|---------|
| 21 CFR Part 11 Electronic Records | ✅ Addressed | Part 11 Compliance |
| 21 CFR Part 11 Electronic Signatures | ✅ Addressed | Electronic Signatures |
| ALCOA+ Data Integrity | ✅ Addressed | ALCOA+ Framework |
| Audit Trails (immutable) | ✅ Addressed | Part 11 + ALCOA+ |
| Software Validation (CSV/CSA) | ✅ Addressed | Validation Framework |
| Electronic Batch Records | ✅ Addressed | EBR Section |
| Change Control | ✅ Addressed | Change Control System |
| Disaster Recovery | ✅ Addressed | DR Section |
| Data Integrity Verification | ✅ Addressed | DR + ALCOA+ |

---

## Platform Operations Dashboard

Unified operations center providing end-to-end visibility across the entire platform for operations teams, executives, and business analysts.

### Dashboard Architecture

```typescript
interface PlatformOperationsDashboard {
  generatedAt: string;
  timeRange: {
    start: string;
    end: string;
    granularity: 'hourly' | 'daily' | 'weekly' | 'monthly';
    comparisonPeriod?: {
      start: string;
      end: string;
    };
  };

  funnelMetrics: ConversionFunnel;
  slaMetrics: SLADashboard;
  revenueMetrics: RevenueAnalytics;
  satisfactionMetrics: CustomerSatisfaction;
  providerUtilization: ProviderLoadMetrics;
  geographicPerformance: GeographicAnalytics;
  cohortAnalysis: CohortMetrics;
  operationalAlerts: OperationalAlert[];
}

interface ConversionFunnel {
  stages: FunnelStage[];
  overallConversion: {
    visitorToConsult: number;
    consultToRx: number;
    rxToOrder: number;
    orderToDelivery: number;
    endToEndConversion: number;
  };
  dropOffAnalysis: DropOffPoint[];
  trendData: FunnelTrend[];
}

interface FunnelStage {
  stage: 'visitor' | 'registration' | 'consultation_started' | 'consultation_completed' |
         'rx_generated' | 'rx_approved' | 'order_placed' | 'order_fulfilled' | 'shipped' | 'delivered';
  count: number;
  previousPeriodCount: number;
  changePercent: number;
  conversionToNext: number;
  averageTimeToNext: {
    p50: number;
    p90: number;
    p99: number;
  };
}

interface DropOffPoint {
  fromStage: string;
  toStage: string;
  dropOffCount: number;
  dropOffRate: number;
  primaryReasons: {
    reason: string;
    count: number;
    percentage: number;
  }[];
  recoveryAttempts: {
    attempted: number;
    recovered: number;
    recoveryRate: number;
  };
}

interface FunnelTrend {
  date: string;
  stageMetrics: Record<string, number>;
  overallConversion: number;
}
```

### SLA Performance Dashboard

```typescript
interface SLADashboard {
  overall: {
    slasMet: number;
    totalMeasured: number;
    complianceRate: number;
    trend: 'improving' | 'stable' | 'declining';
  };

  byStage: StageSLA[];
  breachAnalysis: SLABreachAnalysis;
  predictiveAlerts: PredictiveSLAAlert[];
}

interface StageSLA {
  stage: string;
  slaDefinition: {
    targetTime: number;
    unit: 'minutes' | 'hours' | 'days';
    businessHoursOnly: boolean;
  };
  performance: {
    metCount: number;
    totalCount: number;
    complianceRate: number;
    averageActual: number;
    p50: number;
    p90: number;
    p99: number;
  };
  breaches: {
    count: number;
    averageOverage: number;
    maxOverage: number;
    impactedPatients: number;
  };
  trend: {
    lastPeriodCompliance: number;
    changePercent: number;
  };
}

interface SLABreachAnalysis {
  totalBreaches: number;
  breachesByRoot: {
    rootCause: 'capacity' | 'system_issue' | 'external_dependency' | 'complex_case' | 'manual_review' | 'inventory' | 'shipping_carrier';
    count: number;
    percentage: number;
    averageResolutionTime: number;
  }[];
  breachesByTimeOfDay: {
    hour: number;
    count: number;
    avgBreachSeverity: number;
  }[];
  breachesByDayOfWeek: {
    day: string;
    count: number;
  }[];
  impactAnalysis: {
    totalPatientsAffected: number;
    refundsIssued: number;
    compensationTotal: number;
    churnFromBreaches: number;
  };
}

interface PredictiveSLAAlert {
  id: string;
  stage: string;
  riskLevel: 'low' | 'medium' | 'high' | 'critical';
  prediction: string;
  estimatedBreachTime: string;
  itemsAtRisk: number;
  recommendedAction: string;
  triggeredAt: string;
}
```

### Revenue Analytics

```typescript
interface RevenueAnalytics {
  summary: {
    period: string;
    totalRevenue: number;
    previousPeriodRevenue: number;
    changePercent: number;
    projectedMonthEnd: number;
  };

  breakdown: {
    byCategory: RevenueCategoryBreakdown[];
    byChannel: RevenueChannelBreakdown[];
    byPayer: RevenuePayerBreakdown[];
    byProductType: RevenueProductBreakdown[];
  };

  unitEconomics: {
    averageOrderValue: number;
    averageRevenuePerUser: number;
    customerAcquisitionCost: number;
    lifetimeValue: number;
    ltvCacRatio: number;
    paybackPeriodMonths: number;
  };

  marginAnalysis: {
    grossMargin: number;
    contributionMargin: number;
    marginByCategory: {
      category: string;
      revenue: number;
      cogs: number;
      grossMargin: number;
      marginPercent: number;
    }[];
  };

  trends: RevenueTrend[];
}

interface RevenueCategoryBreakdown {
  category: 'consultation_fees' | 'prescription_revenue' | 'subscription_fees' | 'employer_contracts' | 'shipping_fees' | 'other';
  amount: number;
  percentage: number;
  previousPeriod: number;
  changePercent: number;
}

interface RevenueChannelBreakdown {
  channel: 'direct_patient' | 'employer_sponsored' | 'provider_referral' | 'partner_integration' | 'insurance_billed';
  amount: number;
  percentage: number;
  orderCount: number;
  averageOrderValue: number;
}

interface RevenuePayerBreakdown {
  payerType: 'self_pay' | 'employer' | 'insurance' | 'hsa_fsa';
  amount: number;
  percentage: number;
  averageReimbursement: number;
  denialRate?: number;
}

interface RevenueProductBreakdown {
  productCategory: string;
  topProducts: {
    productId: string;
    productName: string;
    revenue: number;
    unitsSold: number;
    margin: number;
  }[];
  categoryTotal: number;
  categoryMargin: number;
}

interface RevenueTrend {
  date: string;
  revenue: number;
  orderCount: number;
  averageOrderValue: number;
  newCustomerRevenue: number;
  returningCustomerRevenue: number;
}
```

### Customer Satisfaction Metrics

```typescript
interface CustomerSatisfaction {
  nps: NPSMetrics;
  csat: CSATMetrics;
  supportMetrics: SupportAnalytics;
  reviewsAndRatings: ReviewMetrics;
  churnAnalysis: ChurnMetrics;
}

interface NPSMetrics {
  currentScore: number;
  previousScore: number;
  trend: 'improving' | 'stable' | 'declining';
  breakdown: {
    promoters: { count: number; percentage: number };
    passives: { count: number; percentage: number };
    detractors: { count: number; percentage: number };
  };
  bySegment: {
    segment: string;
    score: number;
    responseCount: number;
  }[];
  trendHistory: {
    date: string;
    score: number;
    responseCount: number;
  }[];
  verbatimThemes: {
    theme: string;
    sentiment: 'positive' | 'negative' | 'neutral';
    frequency: number;
    exampleQuotes: string[];
  }[];
}

interface CSATMetrics {
  overallScore: number;
  byTouchpoint: {
    touchpoint: 'consultation' | 'ordering' | 'delivery' | 'support' | 'pharmacy';
    score: number;
    responseCount: number;
    trend: number;
  }[];
  lowScoreFollowUp: {
    pendingOutreach: number;
    contacted: number;
    resolved: number;
    resolutionRate: number;
  };
}

interface SupportAnalytics {
  ticketVolume: {
    open: number;
    inProgress: number;
    resolved: number;
    escalated: number;
  };
  responseMetrics: {
    averageFirstResponseTime: number;
    averageResolutionTime: number;
    firstContactResolutionRate: number;
  };
  byCategory: {
    category: string;
    ticketCount: number;
    averageResolutionTime: number;
    satisfactionScore: number;
  }[];
  agentPerformance: {
    agentId: string;
    ticketsHandled: number;
    averageResolutionTime: number;
    satisfactionScore: number;
    escalationRate: number;
  }[];
  channelDistribution: {
    channel: 'chat' | 'email' | 'phone' | 'in_app';
    ticketCount: number;
    percentage: number;
    averageHandleTime: number;
  }[];
}

interface ReviewMetrics {
  averageRating: number;
  totalReviews: number;
  ratingDistribution: {
    stars: number;
    count: number;
    percentage: number;
  }[];
  recentReviews: {
    rating: number;
    text: string;
    date: string;
    responded: boolean;
  }[];
  platformBreakdown: {
    platform: 'google' | 'trustpilot' | 'app_store' | 'in_app';
    averageRating: number;
    reviewCount: number;
  }[];
}

interface ChurnMetrics {
  churnRate: {
    monthly: number;
    quarterly: number;
    annual: number;
    trend: 'improving' | 'stable' | 'worsening';
  };
  churnedCustomers: {
    period: string;
    count: number;
    lostRevenue: number;
  };
  churnReasons: {
    reason: string;
    count: number;
    percentage: number;
    preventable: boolean;
  }[];
  atRiskCustomers: {
    customerId: string;
    riskScore: number;
    riskFactors: string[];
    recommendedAction: string;
    lastActivity: string;
  }[];
  retentionEfforts: {
    campaignType: string;
    targeted: number;
    retained: number;
    retentionRate: number;
    revenueRecovered: number;
  }[];
}
```

### Provider Utilization Analytics

```typescript
interface ProviderLoadMetrics {
  overall: {
    totalActiveProviders: number;
    averageUtilization: number;
    optimalUtilizationTarget: number;
    capacityStatus: 'under_capacity' | 'optimal' | 'near_capacity' | 'over_capacity';
  };

  byProvider: ProviderUtilization[];
  loadDistribution: LoadDistributionAnalysis;
  capacityPlanning: CapacityPlanningMetrics;
}

interface ProviderUtilization {
  providerId: string;
  providerName: string;
  specialty: string;
  status: 'available' | 'busy' | 'offline' | 'vacation';
  metrics: {
    scheduledHours: number;
    actualHours: number;
    consultationsCompleted: number;
    utilizationRate: number;
    averageConsultDuration: number;
    patientSatisfaction: number;
  };
  queue: {
    currentQueueDepth: number;
    averageWaitTime: number;
    nextAvailableSlot: string;
  };
  performance: {
    rxApprovalRate: number;
    averageResponseTime: number;
    patientRetention: number;
  };
}

interface LoadDistributionAnalysis {
  byTimeOfDay: {
    hour: number;
    demand: number;
    capacity: number;
    utilizationRate: number;
    averageWaitTime: number;
  }[];
  byDayOfWeek: {
    day: string;
    demand: number;
    capacity: number;
    utilizationRate: number;
  }[];
  bySpecialty: {
    specialty: string;
    demand: number;
    providerCount: number;
    averageUtilization: number;
    bottleneck: boolean;
  }[];
  peakAnalysis: {
    peakHours: string[];
    peakDays: string[];
    peakUtilization: number;
    recommendedAdditionalCapacity: number;
  };
}

interface CapacityPlanningMetrics {
  currentCapacity: {
    totalWeeklyHours: number;
    averageConsultsPerWeek: number;
    maxConsultsPerWeek: number;
  };
  demandForecast: {
    nextWeek: number;
    nextMonth: number;
    nextQuarter: number;
    confidence: number;
  };
  gapAnalysis: {
    forecastedDemand: number;
    currentCapacity: number;
    gap: number;
    recommendedHires: number;
    alternativeOptions: string[];
  };
  seasonalPatterns: {
    month: string;
    historicalDemand: number;
    projectedDemand: number;
    staffingRecommendation: string;
  }[];
}
```

### Geographic Performance Analytics

```typescript
interface GeographicAnalytics {
  byState: StatePerformance[];
  byRegion: RegionPerformance[];
  byMetro: MetroPerformance[];

  shippingAnalysis: {
    averageDeliveryTimeByZone: {
      zone: string;
      averageDays: number;
      onTimeRate: number;
    }[];
    carrierPerformanceByRegion: {
      region: string;
      carrier: string;
      onTimeRate: number;
      damageRate: number;
      costPerPackage: number;
    }[];
  };

  marketPenetration: {
    state: string;
    estimatedMarketSize: number;
    currentCustomers: number;
    penetrationRate: number;
    growthOpportunity: 'high' | 'medium' | 'low';
  }[];

  regulatoryConsiderations: {
    state: string;
    licensingStatus: 'active' | 'pending' | 'restricted' | 'not_licensed';
    restrictions: string[];
    complianceStatus: 'compliant' | 'action_required';
  }[];
}

interface StatePerformance {
  state: string;
  metrics: {
    totalCustomers: number;
    activeCustomers: number;
    revenue: number;
    orderVolume: number;
    averageOrderValue: number;
    customerAcquisitionCost: number;
    nps: number;
  };
  trends: {
    customerGrowth: number;
    revenueGrowth: number;
  };
  topProducts: {
    productId: string;
    productName: string;
    orderCount: number;
  }[];
}

interface RegionPerformance {
  region: 'northeast' | 'southeast' | 'midwest' | 'southwest' | 'west';
  states: string[];
  aggregateMetrics: {
    totalCustomers: number;
    totalRevenue: number;
    averageOrderValue: number;
    deliveryPerformance: number;
  };
  marketShare: number;
  competitivePosition: 'leader' | 'challenger' | 'niche' | 'new_entrant';
}

interface MetroPerformance {
  metroArea: string;
  state: string;
  population: number;
  metrics: {
    customers: number;
    penetrationRate: number;
    revenue: number;
    growthRate: number;
  };
  providerCoverage: {
    inNetworkProviders: number;
    averageResponseTime: number;
    patientToProviderRatio: number;
  };
}
```

### Cohort Analysis

```typescript
interface CohortMetrics {
  acquisitionCohorts: AcquisitionCohort[];
  behaviorCohorts: BehaviorCohort[];
  retentionCurves: RetentionCurve[];
  lifetimeValueByCohort: LTVCohort[];
}

interface AcquisitionCohort {
  cohortId: string;
  acquisitionMonth: string;
  acquisitionChannel: string;
  size: number;
  metrics: {
    month0: CohortMonthMetrics;
    month1: CohortMonthMetrics;
    month3: CohortMonthMetrics;
    month6: CohortMonthMetrics;
    month12: CohortMonthMetrics;
  };
}

interface CohortMonthMetrics {
  retained: number;
  retentionRate: number;
  revenue: number;
  averageOrderValue: number;
  ordersPerCustomer: number;
  nps?: number;
}

interface BehaviorCohort {
  cohortName: string;
  definition: string;
  size: number;
  characteristics: {
    averageOrderFrequency: number;
    averageOrderValue: number;
    preferredCategories: string[];
    engagementScore: number;
  };
  outcomes: {
    retentionRate: number;
    lifetimeValue: number;
    referralRate: number;
  };
}

interface RetentionCurve {
  cohort: string;
  monthsSinceAcquisition: number[];
  retentionRates: number[];
  benchmark: number[];
  analysis: {
    dropOffPoint: number;
    stabilizationPoint: number;
    longTermRetention: number;
  };
}

interface LTVCohort {
  cohort: string;
  size: number;
  averageLTV: number;
  medianLTV: number;
  ltvDistribution: {
    range: string;
    count: number;
    percentage: number;
  }[];
  ltvDrivers: {
    factor: string;
    correlation: number;
    insight: string;
  }[];
}
```

### Operational Alerts & Monitoring

```typescript
interface OperationalAlert {
  id: string;
  severity: 'info' | 'warning' | 'critical' | 'emergency';
  category: 'sla' | 'capacity' | 'quality' | 'financial' | 'compliance' | 'system';
  title: string;
  description: string;
  metric: {
    name: string;
    currentValue: number;
    threshold: number;
    unit: string;
  };
  impactAssessment: {
    affectedCustomers: number;
    potentialRevenueLoss: number;
    reputationRisk: 'low' | 'medium' | 'high';
  };
  recommendedActions: {
    action: string;
    priority: number;
    owner: string;
    estimatedImpact: string;
  }[];
  status: 'active' | 'acknowledged' | 'investigating' | 'mitigating' | 'resolved';
  timeline: {
    triggeredAt: string;
    acknowledgedAt?: string;
    resolvedAt?: string;
  };
}

interface AlertConfiguration {
  alertRules: {
    id: string;
    name: string;
    metric: string;
    condition: 'above' | 'below' | 'change_percent';
    threshold: number;
    evaluationWindow: number;
    severity: string;
    notificationChannels: ('slack' | 'email' | 'pagerduty' | 'sms')[];
    recipients: string[];
    enabled: boolean;
  }[];

  escalationPolicy: {
    level: number;
    delayMinutes: number;
    notifyRoles: string[];
    channels: string[];
  }[];

  maintenanceWindows: {
    name: string;
    schedule: string;
    suppressAlerts: string[];
  }[];
}
```

### Real-Time Operations Dashboard UI

```typescript
interface OperationsDashboardConfig {
  refreshInterval: number;
  defaultTimeRange: '1h' | '24h' | '7d' | '30d';

  panels: DashboardPanel[];

  quickFilters: {
    name: string;
    field: string;
    options: string[];
  }[];

  savedViews: {
    id: string;
    name: string;
    filters: Record<string, any>;
    panelLayout: string;
    isDefault: boolean;
  }[];
}

interface DashboardPanel {
  id: string;
  title: string;
  type: 'metric' | 'chart' | 'table' | 'funnel' | 'map' | 'alert_list';
  dataSource: string;
  position: { x: number; y: number; width: number; height: number };
  config: {
    visualization?: 'line' | 'bar' | 'area' | 'pie' | 'gauge' | 'heatmap';
    aggregation?: 'sum' | 'avg' | 'count' | 'p50' | 'p90' | 'p99';
    groupBy?: string[];
    thresholds?: { value: number; color: string; label: string }[];
  };
  drillDownEnabled: boolean;
  drillDownTarget?: string;
}

const defaultOperationsPanels: DashboardPanel[] = [
  {
    id: 'live-funnel',
    title: 'Live Conversion Funnel',
    type: 'funnel',
    dataSource: 'funnel_metrics',
    position: { x: 0, y: 0, width: 6, height: 4 },
    config: {
      thresholds: [
        { value: 0.8, color: 'green', label: 'Healthy' },
        { value: 0.6, color: 'yellow', label: 'Attention' },
        { value: 0, color: 'red', label: 'Critical' }
      ]
    },
    drillDownEnabled: true,
    drillDownTarget: '/analytics/funnel-detail'
  },
  {
    id: 'sla-gauges',
    title: 'SLA Compliance',
    type: 'metric',
    dataSource: 'sla_metrics',
    position: { x: 6, y: 0, width: 6, height: 2 },
    config: {
      visualization: 'gauge',
      thresholds: [
        { value: 0.95, color: 'green', label: 'On Target' },
        { value: 0.90, color: 'yellow', label: 'At Risk' },
        { value: 0, color: 'red', label: 'Breach' }
      ]
    },
    drillDownEnabled: true,
    drillDownTarget: '/analytics/sla-detail'
  },
  {
    id: 'revenue-trend',
    title: 'Revenue (Today vs Yesterday)',
    type: 'chart',
    dataSource: 'revenue_metrics',
    position: { x: 6, y: 2, width: 6, height: 2 },
    config: {
      visualization: 'area',
      aggregation: 'sum'
    },
    drillDownEnabled: true,
    drillDownTarget: '/analytics/revenue'
  },
  {
    id: 'active-alerts',
    title: 'Active Alerts',
    type: 'alert_list',
    dataSource: 'operational_alerts',
    position: { x: 0, y: 4, width: 12, height: 2 },
    config: {},
    drillDownEnabled: true,
    drillDownTarget: '/alerts'
  }
];
```

### Operations Dashboard API Endpoints

```typescript
// GET /api/v1/operations/dashboard
// Returns full dashboard data for specified time range

interface DashboardRequest {
  timeRange: {
    start: string;
    end: string;
  };
  granularity: 'hourly' | 'daily' | 'weekly';
  includeSections: ('funnel' | 'sla' | 'revenue' | 'satisfaction' | 'provider' | 'geo' | 'cohort' | 'alerts')[];
  filters?: {
    states?: string[];
    channels?: string[];
    productCategories?: string[];
  };
}

// GET /api/v1/operations/alerts
// Returns active and recent alerts

// POST /api/v1/operations/alerts/{alertId}/acknowledge
// Acknowledge an alert

// GET /api/v1/operations/reports/scheduled
// List scheduled reports

// POST /api/v1/operations/reports/generate
// Generate ad-hoc report

interface ScheduledReport {
  id: string;
  name: string;
  reportType: 'executive_summary' | 'operational_detail' | 'financial' | 'compliance';
  schedule: {
    frequency: 'daily' | 'weekly' | 'monthly';
    dayOfWeek?: number;
    dayOfMonth?: number;
    time: string;
    timezone: string;
  };
  recipients: {
    email: string;
    format: 'pdf' | 'excel' | 'dashboard_link';
  }[];
  sections: string[];
  filters: Record<string, any>;
  enabled: boolean;
}
```

---

## Customer Support & Help Desk

Unified customer support platform integrating help desk ticketing, live chat, knowledge base, and escalation workflows for patient and provider support.

### Help Desk Architecture

```typescript
interface HelpDeskSystem {
  ticketing: TicketingService;
  liveChat: LiveChatService;
  knowledgeBase: KnowledgeBaseService;
  escalation: EscalationEngine;
  analytics: SupportAnalytics;
}

interface SupportTicket {
  id: string;
  ticketNumber: string;

  requester: {
    type: 'patient' | 'provider' | 'employer_admin' | 'pharmacy_staff';
    id: string;
    name: string;
    email: string;
    phone?: string;
  };

  category: TicketCategory;
  subcategory: string;
  priority: 'low' | 'normal' | 'high' | 'urgent';

  subject: string;
  description: string;

  relatedEntities: {
    orderId?: string;
    prescriptionId?: string;
    appointmentId?: string;
    claimId?: string;
  };

  channel: 'email' | 'chat' | 'phone' | 'in_app' | 'social';

  status: 'new' | 'open' | 'pending_customer' | 'pending_internal' | 'on_hold' | 'solved' | 'closed';

  assignment: {
    group: string;
    agentId?: string;
    assignedAt?: string;
  };

  sla: {
    firstResponseDue: string;
    resolutionDue: string;
    firstResponseMet?: boolean;
    resolutionMet?: boolean;
    breached: boolean;
  };

  timeline: TicketEvent[];

  satisfaction?: {
    rating: 1 | 2 | 3 | 4 | 5;
    comment?: string;
    submittedAt: string;
  };

  tags: string[];
  customFields: Record<string, unknown>;

  createdAt: string;
  updatedAt: string;
  solvedAt?: string;
  closedAt?: string;
}

type TicketCategory =
  | 'order_issue'
  | 'prescription_question'
  | 'billing_payment'
  | 'shipping_delivery'
  | 'product_quality'
  | 'side_effects'
  | 'account_access'
  | 'insurance_coverage'
  | 'refill_request'
  | 'provider_support'
  | 'technical_issue'
  | 'general_inquiry';

interface TicketEvent {
  id: string;
  type: 'created' | 'replied' | 'note_added' | 'status_changed' | 'assigned' | 'escalated' | 'merged' | 'tagged';
  actorType: 'customer' | 'agent' | 'system' | 'automation';
  actorId?: string;
  content?: string;
  attachments?: Attachment[];
  metadata: Record<string, unknown>;
  isPublic: boolean;
  createdAt: string;
}
```

### Live Chat Integration

```typescript
interface LiveChatService {
  initializeChat: (visitor: ChatVisitor) => Promise<ChatSession>;
  routeChat: (session: ChatSession) => Promise<string>;
  transferChat: (sessionId: string, toAgentId: string) => Promise<void>;
  endChat: (sessionId: string, resolution: string) => Promise<void>;
}

interface ChatSession {
  id: string;
  visitorId: string;
  visitorType: 'anonymous' | 'patient' | 'provider';
  authenticatedUserId?: string;

  channel: 'web_widget' | 'mobile_app' | 'sms';

  status: 'waiting' | 'active' | 'transferred' | 'ended';

  department: string;
  agentId?: string;

  context: {
    currentPage: string;
    previousPages: string[];
    orderId?: string;
    prescriptionId?: string;
  };

  messages: ChatMessage[];

  routing: {
    queuedAt: string;
    assignedAt?: string;
    waitTimeSeconds?: number;
    transferHistory: { fromAgent: string; toAgent: string; reason: string; at: string }[];
  };

  resolution?: {
    type: 'solved' | 'ticket_created' | 'transferred_phone' | 'abandoned';
    ticketId?: string;
    notes?: string;
  };

  satisfaction?: {
    rating: 1 | 2 | 3 | 4 | 5;
    feedback?: string;
  };

  startedAt: string;
  endedAt?: string;
}

interface ChatMessage {
  id: string;
  senderType: 'visitor' | 'agent' | 'bot';
  senderId?: string;
  content: string;
  contentType: 'text' | 'image' | 'file' | 'quick_reply' | 'card';
  attachments?: Attachment[];
  quickReplies?: { label: string; value: string }[];
  sentAt: string;
  deliveredAt?: string;
  readAt?: string;
}

const chatRoutingRules: RoutingRule[] = [
  {
    condition: { visitorType: 'provider' },
    action: { department: 'provider_support', priority: 'high' }
  },
  {
    condition: { context: { page: '/orders/*' } },
    action: { department: 'order_support' }
  },
  {
    condition: { context: { page: '/billing/*' } },
    action: { department: 'billing' }
  },
  {
    condition: { keywords: ['urgent', 'emergency', 'reaction'] },
    action: { department: 'clinical_triage', priority: 'urgent' }
  }
];
```

### Knowledge Base

```typescript
interface KnowledgeBaseService {
  search: (query: string, context?: SearchContext) => Promise<Article[]>;
  getArticle: (articleId: string) => Promise<Article>;
  trackView: (articleId: string, userId?: string) => Promise<void>;
  trackHelpful: (articleId: string, helpful: boolean, userId?: string) => Promise<void>;
  suggestArticles: (ticketContent: string) => Promise<Article[]>;
}

interface Article {
  id: string;
  slug: string;

  title: string;
  summary: string;
  body: string;

  category: string;
  subcategory: string;
  tags: string[];

  visibility: 'public' | 'patients_only' | 'providers_only' | 'internal';

  relatedArticles: string[];

  seo: {
    metaTitle: string;
    metaDescription: string;
    canonicalUrl: string;
  };

  analytics: {
    views: number;
    uniqueViews: number;
    helpfulYes: number;
    helpfulNo: number;
    averageTimeOnPage: number;
    searchAppearances: number;
    searchClicks: number;
  };

  status: 'draft' | 'published' | 'archived';

  authorId: string;
  reviewerId?: string;

  createdAt: string;
  updatedAt: string;
  publishedAt?: string;
  lastReviewedAt?: string;
}

interface ArticleCategory {
  id: string;
  name: string;
  slug: string;
  description: string;
  icon: string;
  parentId?: string;
  order: number;
  articleCount: number;
}

const articleCategories: ArticleCategory[] = [
  { id: 'getting-started', name: 'Getting Started', slug: 'getting-started', description: 'New patient guides', icon: 'rocket', order: 1, articleCount: 0 },
  { id: 'orders-shipping', name: 'Orders & Shipping', slug: 'orders-shipping', description: 'Order tracking and delivery', icon: 'package', order: 2, articleCount: 0 },
  { id: 'prescriptions', name: 'Prescriptions', slug: 'prescriptions', description: 'Prescription questions', icon: 'pill', order: 3, articleCount: 0 },
  { id: 'billing-insurance', name: 'Billing & Insurance', slug: 'billing-insurance', description: 'Payment and coverage', icon: 'credit-card', order: 4, articleCount: 0 },
  { id: 'medications', name: 'Medications', slug: 'medications', description: 'Medication information', icon: 'beaker', order: 5, articleCount: 0 },
  { id: 'account', name: 'Account & Privacy', slug: 'account', description: 'Account management', icon: 'user', order: 6, articleCount: 0 }
];
```

### SLA & Escalation Engine

```typescript
interface EscalationEngine {
  checkSLAs: () => Promise<SLABreachAlert[]>;
  escalateTicket: (ticketId: string, reason: string, toGroup: string) => Promise<void>;
  autoEscalate: (ticket: SupportTicket) => Promise<boolean>;
}

interface SLAPolicy {
  id: string;
  name: string;

  conditions: {
    priority?: ('low' | 'normal' | 'high' | 'urgent')[];
    category?: TicketCategory[];
    requesterType?: ('patient' | 'provider' | 'employer_admin')[];
    tags?: string[];
  };

  targets: {
    firstResponseMinutes: number;
    resolutionMinutes: number;
    businessHoursOnly: boolean;
  };

  escalation: {
    warningThreshold: number;
    breachNotify: string[];
    autoReassign: boolean;
    reassignTo?: string;
  };
}

const slaPolicies: SLAPolicy[] = [
  {
    id: 'urgent',
    name: 'Urgent Priority',
    conditions: { priority: ['urgent'] },
    targets: { firstResponseMinutes: 15, resolutionMinutes: 120, businessHoursOnly: false },
    escalation: { warningThreshold: 0.75, breachNotify: ['support-lead@company.com'], autoReassign: true, reassignTo: 'tier2' }
  },
  {
    id: 'high',
    name: 'High Priority',
    conditions: { priority: ['high'] },
    targets: { firstResponseMinutes: 60, resolutionMinutes: 480, businessHoursOnly: true },
    escalation: { warningThreshold: 0.8, breachNotify: ['support-lead@company.com'], autoReassign: false }
  },
  {
    id: 'provider',
    name: 'Provider Support',
    conditions: { requesterType: ['provider'] },
    targets: { firstResponseMinutes: 30, resolutionMinutes: 240, businessHoursOnly: true },
    escalation: { warningThreshold: 0.8, breachNotify: ['provider-ops@company.com'], autoReassign: true, reassignTo: 'provider-support' }
  },
  {
    id: 'standard',
    name: 'Standard',
    conditions: {},
    targets: { firstResponseMinutes: 240, resolutionMinutes: 1440, businessHoursOnly: true },
    escalation: { warningThreshold: 0.9, breachNotify: [], autoReassign: false }
  }
];

const escalationRules: EscalationRule[] = [
  {
    trigger: { keyword: ['allergic reaction', 'emergency', 'hospitalized'] },
    action: { priority: 'urgent', notify: ['clinical-team@company.com'], tag: 'clinical_urgent' }
  },
  {
    trigger: { sentiment: 'very_negative', consecutiveReplies: 3 },
    action: { escalateTo: 'tier2', notify: ['escalations@company.com'] }
  },
  {
    trigger: { reopenedCount: { gte: 2 } },
    action: { escalateTo: 'tier2', tag: 'chronic_issue' }
  }
];
```

### Vendor Integration (Zendesk/Intercom)

```typescript
interface HelpDeskVendorConfig {
  vendor: 'zendesk' | 'intercom' | 'freshdesk';

  zendesk?: {
    subdomain: string;
    apiToken: string;
    webhookSecret: string;
    widgetKey: string;
  };

  intercom?: {
    appId: string;
    apiKey: string;
    identitySecret: string;
  };

  sync: {
    syncPatientData: boolean;
    patientFields: string[];
    syncOrders: boolean;
    syncPrescriptions: boolean;
  };

  webhooks: {
    ticketCreated: string;
    ticketUpdated: string;
    chatStarted: string;
    satisfactionRated: string;
  };
}

const syncPatientToHelpDesk = async (patientId: string): Promise<void> => {
  const patient = await getPatient(patientId);
  const orders = await getRecentOrders(patientId, 5);
  const prescriptions = await getActivePrescriptions(patientId);

  await helpDeskClient.upsertUser({
    externalId: patientId,
    email: patient.email,
    name: `${patient.firstName} ${patient.lastName}`,
    phone: patient.phone,
    customAttributes: {
      patient_id: patientId,
      member_since: patient.createdAt,
      total_orders: patient.orderCount,
      lifetime_value: patient.lifetimeValue,
      active_prescriptions: prescriptions.length,
      recent_order_ids: orders.map(o => o.id).join(','),
      subscription_status: patient.subscriptionStatus,
      preferred_contact: patient.preferredContactMethod
    }
  });
};
```

---

## Returns, Refunds & Disputes

Comprehensive returns merchandise authorization (RMA), refund processing, and chargeback dispute management.

### Returns & Refunds Architecture

```typescript
interface ReturnsService {
  createRMA: (request: RMARequest) => Promise<ReturnAuthorization>;
  processReturn: (rmaId: string, inspection: ReturnInspection) => Promise<RefundDecision>;
  issueRefund: (refundRequest: RefundRequest) => Promise<Refund>;
  handleChargeback: (chargeback: ChargebackNotification) => Promise<DisputeResponse>;
}

interface ReturnAuthorization {
  id: string;
  rmaNumber: string;

  orderId: string;
  patientId: string;

  type: 'return' | 'exchange' | 'warranty_claim';
  reason: ReturnReason;
  reasonDetails: string;

  items: ReturnItem[];

  status: 'requested' | 'approved' | 'denied' | 'label_sent' | 'in_transit' | 'received' | 'inspecting' | 'completed' | 'cancelled';

  shipping: {
    returnLabelUrl?: string;
    returnTrackingNumber?: string;
    carrier?: string;
    receivedAt?: string;
  };

  inspection?: ReturnInspection;

  refund?: {
    decision: 'full' | 'partial' | 'denied' | 'store_credit';
    amount: number;
    refundId?: string;
    reason?: string;
  };

  timeline: RMAEvent[];

  createdAt: string;
  updatedAt: string;
  completedAt?: string;
  expiresAt: string;
}

type ReturnReason =
  | 'damaged_in_shipping'
  | 'wrong_item_received'
  | 'quality_issue'
  | 'side_effects'
  | 'no_longer_needed'
  | 'duplicate_order'
  | 'price_adjustment'
  | 'never_received'
  | 'other';

interface ReturnItem {
  orderItemId: string;
  productId: string;
  productName: string;
  quantity: number;
  quantityReturned: number;
  unitPrice: number;
  isCompounded: boolean;
  lotNumber?: string;
  returnEligible: boolean;
  ineligibilityReason?: string;
}

interface ReturnInspection {
  inspectedBy: string;
  inspectedAt: string;

  condition: 'unopened' | 'opened_unused' | 'partially_used' | 'damaged' | 'contaminated';

  findings: {
    packagingIntact: boolean;
    productIntact: boolean;
    withinExpiry: boolean;
    matchesRMA: boolean;
    photos: string[];
    notes: string;
  };

  disposition: 'restock' | 'destroy' | 'quarantine_for_review' | 'return_to_patient';

  qualityIssue?: {
    reported: boolean;
    issueType: string;
    batchFlagged: boolean;
  };
}
```

### Return Eligibility Rules

```typescript
interface ReturnEligibilityRules {
  checkEligibility: (order: Order, items: OrderItem[], reason: ReturnReason) => EligibilityResult;
}

interface EligibilityResult {
  eligible: boolean;
  items: {
    itemId: string;
    eligible: boolean;
    reason?: string;
    maxRefund: number;
  }[];
  policy: string;
  expiresAt: string;
}

const returnPolicies: ReturnPolicy[] = [
  {
    id: 'compounded_medications',
    productTypes: ['compounded'],
    eligibility: {
      returnable: false,
      reason: 'Compounded medications are made specifically for you and cannot be returned or resold for safety reasons.'
    },
    exceptions: [
      { condition: 'damaged_in_shipping', action: 'full_refund_no_return' },
      { condition: 'wrong_item_received', action: 'full_refund_with_replacement' },
      { condition: 'quality_issue', action: 'review_required' }
    ]
  },
  {
    id: 'otc_supplements',
    productTypes: ['otc', 'supplement'],
    eligibility: {
      returnable: true,
      windowDays: 30,
      conditions: ['unopened', 'original_packaging']
    },
    restockingFee: 0,
    shippingRefundable: false
  },
  {
    id: 'devices_equipment',
    productTypes: ['device', 'equipment'],
    eligibility: {
      returnable: true,
      windowDays: 30,
      conditions: ['unopened', 'original_packaging', 'all_accessories']
    },
    restockingFee: 0.15,
    shippingRefundable: true
  }
];

const checkReturnEligibility = (order: Order, items: OrderItem[], reason: ReturnReason): EligibilityResult => {
  const daysSinceDelivery = getDaysSince(order.deliveredAt);
  const results: EligibilityResult['items'] = [];

  for (const item of items) {
    const policy = findPolicyForProduct(item.productType);

    if (!policy.eligibility.returnable) {
      const exception = policy.exceptions?.find(e => e.condition === reason);
      if (exception) {
        results.push({
          itemId: item.id,
          eligible: true,
          reason: `Exception: ${exception.action}`,
          maxRefund: item.totalPrice
        });
      } else {
        results.push({
          itemId: item.id,
          eligible: false,
          reason: policy.eligibility.reason,
          maxRefund: 0
        });
      }
      continue;
    }

    if (daysSinceDelivery > policy.eligibility.windowDays) {
      results.push({
        itemId: item.id,
        eligible: false,
        reason: `Return window expired (${policy.eligibility.windowDays} days)`,
        maxRefund: 0
      });
      continue;
    }

    const restockingFee = policy.restockingFee || 0;
    const maxRefund = item.totalPrice * (1 - restockingFee);

    results.push({
      itemId: item.id,
      eligible: true,
      maxRefund
    });
  }

  return {
    eligible: results.some(r => r.eligible),
    items: results,
    policy: 'standard_return_policy',
    expiresAt: addDays(new Date(), 14).toISOString()
  };
};
```

### Refund Processing

```typescript
interface Refund {
  id: string;

  orderId: string;
  rmaId?: string;
  patientId: string;

  type: 'return' | 'cancellation' | 'price_adjustment' | 'service_recovery' | 'chargeback_accepted';

  amount: {
    subtotal: number;
    tax: number;
    shipping: number;
    restockingFee: number;
    total: number;
  };

  method: 'original_payment' | 'store_credit' | 'check' | 'ach';

  paymentDetails: {
    originalPaymentId: string;
    refundTransactionId?: string;
    storeCreditCode?: string;
  };

  status: 'pending' | 'processing' | 'completed' | 'failed';

  approvedBy?: string;
  approvalRequired: boolean;

  reason: string;
  internalNotes?: string;

  createdAt: string;
  processedAt?: string;
}

const processRefund = async (request: RefundRequest): Promise<Refund> => {
  const refund = await createRefund(request);

  if (refund.approvalRequired && refund.amount.total > 100) {
    await notifyForApproval(refund);
    return refund;
  }

  if (request.method === 'original_payment') {
    const payment = await getPayment(request.originalPaymentId);

    const stripeRefund = await stripe.refunds.create({
      payment_intent: payment.stripePaymentIntentId,
      amount: Math.round(refund.amount.total * 100),
      reason: mapToStripeReason(request.type),
      metadata: {
        refund_id: refund.id,
        order_id: request.orderId,
        rma_id: request.rmaId
      }
    });

    await updateRefund(refund.id, {
      status: 'completed',
      paymentDetails: {
        ...refund.paymentDetails,
        refundTransactionId: stripeRefund.id
      },
      processedAt: new Date().toISOString()
    });
  } else if (request.method === 'store_credit') {
    const credit = await issueStoreCredit({
      patientId: request.patientId,
      amount: refund.amount.total,
      reason: `Refund for order ${request.orderId}`,
      expiresAt: addYears(new Date(), 1).toISOString()
    });

    await updateRefund(refund.id, {
      status: 'completed',
      paymentDetails: {
        ...refund.paymentDetails,
        storeCreditCode: credit.code
      },
      processedAt: new Date().toISOString()
    });
  }

  await notifyPatientOfRefund(refund);

  return refund;
};
```

### Chargeback & Dispute Handling

```typescript
interface ChargebackDispute {
  id: string;

  chargebackId: string;
  stripeDisputeId: string;

  orderId: string;
  patientId: string;

  amount: number;
  currency: string;

  reason: ChargebackReason;
  reasonDescription: string;

  status: 'needs_response' | 'under_review' | 'won' | 'lost' | 'accepted';

  evidence: DisputeEvidence;

  deadlines: {
    respondBy: string;
    resolved?: string;
  };

  outcome?: {
    result: 'won' | 'lost';
    networkReasonCode?: string;
    amountRecovered?: number;
  };

  timeline: DisputeEvent[];

  createdAt: string;
  updatedAt: string;
}

type ChargebackReason =
  | 'duplicate'
  | 'fraudulent'
  | 'subscription_canceled'
  | 'product_not_received'
  | 'product_unacceptable'
  | 'unrecognized'
  | 'credit_not_processed'
  | 'general';

interface DisputeEvidence {
  customerName: string;
  customerEmail: string;
  customerSignature?: string;

  billingAddress: string;
  shippingAddress: string;

  productDescription: string;

  shippingDocumentation?: string;
  shippingTrackingNumber?: string;
  shippingCarrier?: string;
  shippingDate?: string;

  receiptUrl?: string;
  invoiceUrl?: string;

  customerCommunication?: string;
  refundPolicy?: string;
  refundPolicyDisclosure?: string;

  serviceDate?: string;
  serviceDocumentation?: string;

  uncategorizedText?: string;
  uncategorizedFile?: string;
}

const handleChargebackWebhook = async (event: Stripe.Event): Promise<void> => {
  const dispute = event.data.object as Stripe.Dispute;

  const order = await findOrderByPaymentIntent(dispute.payment_intent as string);
  if (!order) {
    await logUnmatchedChargeback(dispute);
    return;
  }

  const chargebackRecord = await createChargebackDispute({
    chargebackId: generateId(),
    stripeDisputeId: dispute.id,
    orderId: order.id,
    patientId: order.patientId,
    amount: dispute.amount / 100,
    currency: dispute.currency,
    reason: mapStripeReason(dispute.reason),
    reasonDescription: dispute.reason,
    status: 'needs_response',
    deadlines: {
      respondBy: new Date(dispute.evidence_details.due_by * 1000).toISOString()
    }
  });

  const evidence = await gatherDisputeEvidence(order, chargebackRecord);

  await updateChargebackDispute(chargebackRecord.id, { evidence });

  await notifyDisputeTeam(chargebackRecord);

  if (shouldAutoSubmit(chargebackRecord, evidence)) {
    await submitDisputeEvidence(chargebackRecord.id);
  }
};

const gatherDisputeEvidence = async (order: Order, dispute: ChargebackDispute): Promise<DisputeEvidence> => {
  const patient = await getPatient(order.patientId);
  const shipment = await getShipment(order.id);
  const communications = await getPatientCommunications(order.patientId, order.id);

  return {
    customerName: `${patient.firstName} ${patient.lastName}`,
    customerEmail: patient.email,
    billingAddress: formatAddress(order.billingAddress),
    shippingAddress: formatAddress(order.shippingAddress),
    productDescription: order.items.map(i => `${i.productName} (Qty: ${i.quantity})`).join('; '),
    shippingTrackingNumber: shipment?.trackingNumber,
    shippingCarrier: shipment?.carrier,
    shippingDate: shipment?.shippedAt,
    shippingDocumentation: shipment?.proofOfDeliveryUrl,
    receiptUrl: order.receiptUrl,
    customerCommunication: formatCommunicationsForEvidence(communications),
    refundPolicy: process.env.REFUND_POLICY_URL,
    refundPolicyDisclosure: 'Refund policy was displayed during checkout and linked in order confirmation email.'
  };
};
```

---

## Reviews & Ratings System

Patient reviews for providers, products, and overall experience with moderation and response workflows.

### Reviews Architecture

```typescript
interface ReviewsService {
  submitReview: (review: ReviewSubmission) => Promise<Review>;
  moderateReview: (reviewId: string, decision: ModerationDecision) => Promise<void>;
  respondToReview: (reviewId: string, response: ReviewResponse) => Promise<void>;
  getReviewSummary: (entityType: string, entityId: string) => Promise<ReviewSummary>;
}

interface Review {
  id: string;

  entityType: 'provider' | 'product' | 'order_experience' | 'platform';
  entityId: string;

  reviewerId: string;
  reviewerType: 'patient' | 'caregiver';
  reviewerDisplayName: string;
  verified: boolean;

  rating: 1 | 2 | 3 | 4 | 5;

  title?: string;
  body: string;

  aspects?: {
    aspect: string;
    rating: 1 | 2 | 3 | 4 | 5;
  }[];

  media?: {
    type: 'image' | 'video';
    url: string;
    caption?: string;
  }[];

  orderContext?: {
    orderId: string;
    orderDate: string;
    productsPurchased: string[];
  };

  moderation: {
    status: 'pending' | 'approved' | 'rejected' | 'flagged';
    reviewedBy?: string;
    reviewedAt?: string;
    rejectionReason?: string;
    flags: string[];
  };

  response?: {
    responderId: string;
    responderRole: string;
    body: string;
    respondedAt: string;
  };

  engagement: {
    helpfulCount: number;
    notHelpfulCount: number;
    reportCount: number;
  };

  visibility: 'public' | 'private' | 'hidden';

  createdAt: string;
  updatedAt: string;
  publishedAt?: string;
}

interface ReviewSubmission {
  entityType: Review['entityType'];
  entityId: string;
  reviewerId: string;
  rating: number;
  title?: string;
  body: string;
  aspects?: Review['aspects'];
  orderId?: string;
}

interface ReviewSummary {
  entityType: string;
  entityId: string;

  overallRating: number;
  totalReviews: number;
  verifiedReviews: number;

  ratingDistribution: {
    1: number;
    2: number;
    3: number;
    4: number;
    5: number;
  };

  aspectRatings?: {
    aspect: string;
    averageRating: number;
    reviewCount: number;
  }[];

  recentReviews: Review[];

  responseRate: number;
  averageResponseTime: number;
}
```

### Review Moderation

```typescript
interface ModerationEngine {
  autoModerate: (review: Review) => Promise<AutoModerationResult>;
  manualReview: (reviewId: string, decision: ModerationDecision) => Promise<void>;
  handleReport: (reviewId: string, report: ReviewReport) => Promise<void>;
}

interface AutoModerationResult {
  action: 'approve' | 'reject' | 'flag_for_review';
  confidence: number;
  flags: ModerationFlag[];
  reasons: string[];
}

interface ModerationFlag {
  type: 'profanity' | 'phi_detected' | 'spam' | 'fake' | 'harassment' | 'off_topic' | 'competitor_mention' | 'legal_risk';
  severity: 'low' | 'medium' | 'high';
  details: string;
  location?: { start: number; end: number };
}

const autoModerateReview = async (review: Review): Promise<AutoModerationResult> => {
  const flags: ModerationFlag[] = [];

  const profanityCheck = await checkProfanity(review.body);
  if (profanityCheck.found) {
    flags.push({
      type: 'profanity',
      severity: profanityCheck.severity,
      details: `Found: ${profanityCheck.words.join(', ')}`,
      location: profanityCheck.location
    });
  }

  const phiCheck = await detectPHI(review.body);
  if (phiCheck.detected) {
    flags.push({
      type: 'phi_detected',
      severity: 'high',
      details: `Potential PHI: ${phiCheck.types.join(', ')}`
    });
  }

  const spamScore = await calculateSpamScore(review);
  if (spamScore > 0.7) {
    flags.push({
      type: 'spam',
      severity: spamScore > 0.9 ? 'high' : 'medium',
      details: `Spam score: ${spamScore}`
    });
  }

  const fakeReviewScore = await detectFakeReview(review);
  if (fakeReviewScore > 0.8) {
    flags.push({
      type: 'fake',
      severity: 'high',
      details: 'Potential fake review detected'
    });
  }

  if (flags.some(f => f.severity === 'high')) {
    return { action: 'flag_for_review', confidence: 0.9, flags, reasons: flags.map(f => f.details) };
  }

  if (flags.some(f => f.type === 'profanity' && f.severity === 'medium')) {
    return { action: 'flag_for_review', confidence: 0.7, flags, reasons: ['Contains potentially inappropriate language'] };
  }

  if (flags.length === 0) {
    return { action: 'approve', confidence: 0.95, flags: [], reasons: ['Passed all automated checks'] };
  }

  return { action: 'flag_for_review', confidence: 0.6, flags, reasons: flags.map(f => f.details) };
};
```

### Review Solicitation

```typescript
interface ReviewSolicitation {
  id: string;
  patientId: string;
  orderId: string;

  channel: 'email' | 'sms' | 'in_app';

  status: 'scheduled' | 'sent' | 'opened' | 'completed' | 'expired' | 'opted_out';

  scheduledFor: string;
  sentAt?: string;
  completedAt?: string;

  reviewId?: string;
}

const scheduleReviewSolicitation = async (order: Order): Promise<void> => {
  const daysSinceDelivery = 3;
  const scheduledFor = addDays(new Date(order.deliveredAt), daysSinceDelivery);

  const existingReview = await findReviewByOrderer(order.patientId, order.id);
  if (existingReview) return;

  const recentSolicitations = await getRecentSolicitations(order.patientId, 30);
  if (recentSolicitations.length >= 2) return;

  await createSolicitation({
    patientId: order.patientId,
    orderId: order.id,
    channel: 'email',
    status: 'scheduled',
    scheduledFor: scheduledFor.toISOString()
  });
};
```

---

## Public Status Page

Real-time system status communication for patients, providers, and partners with incident management.

### Status Page Architecture

```typescript
interface StatusPageService {
  getStatus: () => Promise<SystemStatus>;
  createIncident: (incident: IncidentCreate) => Promise<Incident>;
  updateIncident: (incidentId: string, update: IncidentUpdate) => Promise<void>;
  scheduleMainenance: (maintenance: MaintenanceWindow) => Promise<void>;
}

interface SystemStatus {
  overall: 'operational' | 'degraded_performance' | 'partial_outage' | 'major_outage' | 'maintenance';

  components: ComponentStatus[];

  activeIncidents: Incident[];

  scheduledMaintenance: MaintenanceWindow[];

  metrics: {
    uptime30Days: number;
    uptime90Days: number;
    lastIncident?: string;
  };

  updatedAt: string;
}

interface ComponentStatus {
  id: string;
  name: string;
  description: string;
  group: string;

  status: 'operational' | 'degraded_performance' | 'partial_outage' | 'major_outage' | 'maintenance';

  statusMessage?: string;

  metrics?: {
    responseTime: number;
    errorRate: number;
    availability: number;
  };

  updatedAt: string;
}

const statusComponents: ComponentStatus[] = [
  { id: 'patient-portal', name: 'Patient Portal', description: 'Patient-facing web application', group: 'Applications', status: 'operational', updatedAt: '' },
  { id: 'provider-portal', name: 'Provider Portal', description: 'Provider-facing web application', group: 'Applications', status: 'operational', updatedAt: '' },
  { id: 'mobile-apps', name: 'Mobile Apps', description: 'iOS and Android applications', group: 'Applications', status: 'operational', updatedAt: '' },
  { id: 'api', name: 'API', description: 'Core API services', group: 'Infrastructure', status: 'operational', updatedAt: '' },
  { id: 'video-visits', name: 'Video Visits', description: 'Telemedicine video infrastructure', group: 'Services', status: 'operational', updatedAt: '' },
  { id: 'payments', name: 'Payments', description: 'Payment processing', group: 'Services', status: 'operational', updatedAt: '' },
  { id: 'notifications', name: 'Notifications', description: 'Email, SMS, and push notifications', group: 'Services', status: 'operational', updatedAt: '' },
  { id: 'pharmacy-systems', name: 'Pharmacy Systems', description: 'Order fulfillment and shipping', group: 'Operations', status: 'operational', updatedAt: '' }
];

interface Incident {
  id: string;

  title: string;
  status: 'investigating' | 'identified' | 'monitoring' | 'resolved';
  impact: 'none' | 'minor' | 'major' | 'critical';

  affectedComponents: string[];

  updates: IncidentUpdate[];

  startedAt: string;
  resolvedAt?: string;

  postmortem?: {
    summary: string;
    rootCause: string;
    preventionSteps: string[];
    publishedAt: string;
  };
}

interface IncidentUpdate {
  id: string;
  status: Incident['status'];
  message: string;
  createdAt: string;
  createdBy: string;
}

interface MaintenanceWindow {
  id: string;

  title: string;
  description: string;

  affectedComponents: string[];
  expectedImpact: string;

  scheduledStart: string;
  scheduledEnd: string;

  status: 'scheduled' | 'in_progress' | 'completed' | 'cancelled';

  updates: MaintenanceUpdate[];
}
```

### Status Monitoring & Automation

```typescript
interface StatusMonitor {
  checkComponent: (componentId: string) => Promise<HealthCheckResult>;
  runAllChecks: () => Promise<Map<string, HealthCheckResult>>;
  autoUpdateStatus: (results: Map<string, HealthCheckResult>) => Promise<void>;
}

interface HealthCheckResult {
  componentId: string;
  healthy: boolean;
  responseTime: number;
  errorRate: number;
  checks: {
    name: string;
    passed: boolean;
    message?: string;
    duration: number;
  }[];
  checkedAt: string;
}

const healthChecks: Record<string, HealthCheck[]> = {
  'patient-portal': [
    { name: 'homepage_load', endpoint: 'https://app.example.com', expectedStatus: 200, timeout: 5000 },
    { name: 'login_page', endpoint: 'https://app.example.com/login', expectedStatus: 200, timeout: 5000 }
  ],
  'api': [
    { name: 'health_endpoint', endpoint: 'https://api.example.com/health', expectedStatus: 200, timeout: 2000 },
    { name: 'auth_service', endpoint: 'https://api.example.com/auth/health', expectedStatus: 200, timeout: 2000 }
  ],
  'video-visits': [
    { name: 'twilio_status', check: 'external_status', service: 'twilio' },
    { name: 'room_creation', endpoint: 'https://api.example.com/video/health', expectedStatus: 200, timeout: 3000 }
  ],
  'payments': [
    { name: 'stripe_status', check: 'external_status', service: 'stripe' },
    { name: 'payment_service', endpoint: 'https://api.example.com/payments/health', expectedStatus: 200, timeout: 2000 }
  ]
};

const determineComponentStatus = (result: HealthCheckResult): ComponentStatus['status'] => {
  if (!result.healthy) {
    const failedCritical = result.checks.filter(c => !c.passed && isCriticalCheck(c.name));
    if (failedCritical.length > 0) return 'major_outage';
    return 'partial_outage';
  }

  if (result.responseTime > 3000 || result.errorRate > 0.05) {
    return 'degraded_performance';
  }

  return 'operational';
};

const autoCreateIncident = async (componentId: string, result: HealthCheckResult): Promise<void> => {
  const existingIncident = await findActiveIncident(componentId);
  if (existingIncident) {
    await addIncidentUpdate(existingIncident.id, {
      status: existingIncident.status,
      message: `Automated check: ${result.checks.filter(c => !c.passed).map(c => c.message).join('; ')}`
    });
    return;
  }

  await createIncident({
    title: `${getComponentName(componentId)} experiencing issues`,
    status: 'investigating',
    impact: result.errorRate > 0.5 ? 'major' : 'minor',
    affectedComponents: [componentId],
    updates: [{
      status: 'investigating',
      message: 'We are investigating reports of issues. More updates to follow.',
      createdAt: new Date().toISOString(),
      createdBy: 'system'
    }]
  });

  await notifyOnCallTeam(componentId, result);
};
```

### Status Page Subscriptions

```typescript
interface StatusSubscription {
  id: string;

  email?: string;
  phone?: string;
  webhookUrl?: string;

  components: string[];

  notifyOn: {
    incidents: boolean;
    maintenance: boolean;
    degradation: boolean;
  };

  status: 'active' | 'unsubscribed';

  createdAt: string;
}

const notifySubscribers = async (event: StatusEvent): Promise<void> => {
  const subscribers = await getSubscribersForComponents(event.affectedComponents);

  for (const subscriber of subscribers) {
    if (event.type === 'incident' && !subscriber.notifyOn.incidents) continue;
    if (event.type === 'maintenance' && !subscriber.notifyOn.maintenance) continue;
    if (event.type === 'degradation' && !subscriber.notifyOn.degradation) continue;

    if (subscriber.email) {
      await sendStatusEmail(subscriber.email, event);
    }

    if (subscriber.phone) {
      await sendStatusSms(subscriber.phone, event);
    }

    if (subscriber.webhookUrl) {
      await sendStatusWebhook(subscriber.webhookUrl, event);
    }
  }
};
```

---

## CAPA (Corrective and Preventive Action) System

FDA-compliant CAPA management for identifying, investigating, and resolving quality issues with full audit trails.

### CAPA Architecture

```typescript
interface CAPASystem {
  createCAPA: (trigger: CAPATrigger) => Promise<CAPA>;
  investigate: (capaId: string, findings: InvestigationFindings) => Promise<void>;
  implementAction: (capaId: string, actionId: string, evidence: ActionEvidence) => Promise<void>;
  verifyEffectiveness: (capaId: string, verification: EffectivenessVerification) => Promise<void>;
  closeCAPA: (capaId: string, closure: CAPAClosure) => Promise<void>;
}

interface CAPA {
  id: string;
  capaNumber: string;

  type: 'corrective' | 'preventive' | 'both';
  category: CAPACategory;

  source: {
    type: 'complaint' | 'audit' | 'deviation' | 'adverse_event' | 'recall' | 'inspection' | 'trend_analysis' | 'employee_report';
    referenceId?: string;
    description: string;
  };

  severity: 'critical' | 'major' | 'minor';
  priority: 'urgent' | 'high' | 'medium' | 'low';

  status: 'initiated' | 'investigating' | 'action_planning' | 'implementing' | 'verifying' | 'closed' | 'cancelled';

  problemStatement: string;

  affectedAreas: {
    products?: string[];
    processes?: string[];
    batches?: string[];
    departments?: string[];
    locations?: string[];
  };

  riskAssessment: {
    patientImpact: 'none' | 'low' | 'medium' | 'high' | 'critical';
    regulatoryImpact: 'none' | 'low' | 'medium' | 'high';
    businessImpact: 'none' | 'low' | 'medium' | 'high';
    overallRisk: 'low' | 'medium' | 'high' | 'critical';
  };

  investigation: CAPAInvestigation;

  rootCauseAnalysis: RootCauseAnalysis;

  actions: CAPAAction[];

  effectiveness: EffectivenessReview[];

  ownership: {
    initiatedBy: string;
    ownerId: string;
    investigatorIds: string[];
    approverIds: string[];
  };

  timeline: {
    initiatedAt: string;
    investigationDue: string;
    actionsDue: string;
    verificationDue: string;
    closedAt?: string;
  };

  attachments: Attachment[];
  auditTrail: AuditEntry[];

  createdAt: string;
  updatedAt: string;
}

type CAPACategory =
  | 'product_quality'
  | 'manufacturing_process'
  | 'equipment'
  | 'documentation'
  | 'personnel_training'
  | 'supplier_vendor'
  | 'environmental'
  | 'regulatory_compliance'
  | 'patient_safety';

interface CAPAInvestigation {
  status: 'not_started' | 'in_progress' | 'completed';

  scope: string;
  methodology: string[];

  dataCollected: {
    type: string;
    description: string;
    source: string;
    attachmentId?: string;
  }[];

  interviews: {
    personId: string;
    personName: string;
    date: string;
    summary: string;
  }[];

  findings: string;

  completedAt?: string;
  completedBy?: string;
}

interface RootCauseAnalysis {
  method: 'five_whys' | 'fishbone' | 'fault_tree' | 'pareto' | 'failure_mode';

  analysis: {
    step: number;
    question?: string;
    answer: string;
    evidence?: string;
  }[];

  rootCauses: {
    id: string;
    description: string;
    category: string;
    verified: boolean;
    verificationMethod?: string;
  }[];

  contributingFactors: string[];

  diagramUrl?: string;

  completedAt?: string;
  completedBy?: string;
}

interface CAPAAction {
  id: string;

  type: 'immediate_containment' | 'corrective' | 'preventive';

  description: string;

  targetRootCause?: string;

  assignedTo: string;
  dueDate: string;

  status: 'planned' | 'in_progress' | 'completed' | 'verified' | 'cancelled';

  implementation: {
    startedAt?: string;
    completedAt?: string;
    evidence?: string[];
    notes?: string;
  };

  verification: {
    verifiedBy?: string;
    verifiedAt?: string;
    method?: string;
    result?: 'effective' | 'partially_effective' | 'not_effective';
    notes?: string;
  };
}

interface EffectivenessReview {
  id: string;
  reviewDate: string;
  reviewedBy: string;

  criteria: {
    criterion: string;
    target: string;
    actual: string;
    met: boolean;
  }[];

  overallEffective: boolean;

  evidence: string[];
  notes: string;

  recommendation: 'close' | 'continue_monitoring' | 'additional_actions';
}
```

### CAPA Workflow Automation

```typescript
const capaWorkflow = {
  onComplaintThreshold: async (productId: string, complaintCount: number) => {
    if (complaintCount >= 3) {
      await createCAPA({
        type: 'corrective',
        category: 'product_quality',
        source: {
          type: 'trend_analysis',
          description: `Product ${productId} received ${complaintCount} complaints in 30 days`
        },
        severity: complaintCount >= 5 ? 'major' : 'minor',
        priority: 'high'
      });
    }
  },

  onDeviationReported: async (deviation: Deviation) => {
    if (deviation.severity === 'critical') {
      await createCAPA({
        type: 'both',
        category: mapDeviationToCategory(deviation),
        source: {
          type: 'deviation',
          referenceId: deviation.id,
          description: deviation.description
        },
        severity: 'critical',
        priority: 'urgent'
      });
    }
  },

  escalateOverdue: async () => {
    const overdueCAPAs = await findOverdueCAPAs();
    for (const capa of overdueCAPAs) {
      await notifyEscalation(capa);
      await updateCAPAPriority(capa.id, 'urgent');
    }
  }
};
```

---

## Batch Recall Management

Product recall initiation, tracking, patient notification, and regulatory reporting for compromised batches.

### Recall Architecture

```typescript
interface RecallManagement {
  initiateRecall: (recall: RecallInitiation) => Promise<Recall>;
  identifyAffectedPatients: (recallId: string) => Promise<AffectedPatient[]>;
  executeNotifications: (recallId: string) => Promise<NotificationResults>;
  trackResponses: (recallId: string) => Promise<RecallProgress>;
  reportToFDA: (recallId: string) => Promise<FDAReport>;
}

interface Recall {
  id: string;
  recallNumber: string;

  classification: 'class_i' | 'class_ii' | 'class_iii';

  type: 'product' | 'batch' | 'lot';

  status: 'initiated' | 'notifying' | 'in_progress' | 'monitoring' | 'closed';

  product: {
    productId: string;
    productName: string;
    ndc?: string;
  };

  affectedBatches: {
    batchId: string;
    lotNumber: string;
    manufacturingDate: string;
    expirationDate: string;
    quantityProduced: number;
    quantityDistributed: number;
    quantityRemaining: number;
  }[];

  reason: {
    category: 'contamination' | 'potency' | 'sterility' | 'labeling' | 'packaging' | 'adverse_event' | 'regulatory';
    description: string;
    healthHazard: string;
    discoveryDate: string;
    discoveredBy: string;
  };

  scope: {
    geographic: string[];
    distributionChannels: string[];
    estimatedUnitsAffected: number;
  };

  patientImpact: {
    totalPatientsAffected: number;
    patientsNotified: number;
    patientsResponded: number;
    productsReturned: number;
    adverseEventsReported: number;
  };

  instructions: {
    patientInstructions: string;
    disposalInstructions: string;
    alternativeProduct?: string;
    refundPolicy: string;
  };

  regulatory: {
    fdaNotified: boolean;
    fdaNotificationDate?: string;
    fdaRecallNumber?: string;
    stateNotifications: { state: string; notifiedAt: string }[];
    pressReleaseRequired: boolean;
    pressReleaseUrl?: string;
  };

  timeline: RecallEvent[];

  closure?: {
    closedAt: string;
    closedBy: string;
    recoveryRate: number;
    lessonsLearned: string;
    preventiveActions: string[];
  };

  createdAt: string;
  updatedAt: string;
}

interface AffectedPatient {
  patientId: string;
  orderId: string;
  orderDate: string;
  batchId: string;
  lotNumber: string;
  quantity: number;
  shippedTo: Address;
  notificationStatus: 'pending' | 'sent' | 'delivered' | 'opened' | 'responded';
  response?: {
    hasProduct: boolean;
    productDisposed: boolean;
    experiencedIssues: boolean;
    issueDescription?: string;
    refundRequested: boolean;
  };
}

const initiateRecall = async (initiation: RecallInitiation): Promise<Recall> => {
  const recall = await createRecall(initiation);

  await quarantineInventory(recall.affectedBatches.map(b => b.batchId));

  const affectedPatients = await identifyAffectedPatients(recall);
  await updateRecall(recall.id, {
    patientImpact: { totalPatientsAffected: affectedPatients.length }
  });

  if (recall.classification === 'class_i') {
    await notifyFDAImmediately(recall);
    await notifyLeadership(recall);
  }

  await scheduleNotifications(recall.id, affectedPatients);

  await createCAPA({
    type: 'both',
    category: 'product_quality',
    source: { type: 'recall', referenceId: recall.id, description: recall.reason.description },
    severity: recall.classification === 'class_i' ? 'critical' : 'major',
    priority: 'urgent'
  });

  return recall;
};
```

### Patient Notification Workflow

```typescript
const executeRecallNotifications = async (recallId: string): Promise<void> => {
  const recall = await getRecall(recallId);
  const patients = await getAffectedPatients(recallId);

  for (const patient of patients) {
    const channels: NotificationChannel[] = [];

    channels.push({
      type: 'email',
      priority: 'high',
      template: 'recall_notification',
      data: {
        patientName: patient.name,
        productName: recall.product.productName,
        lotNumber: patient.lotNumber,
        reason: recall.reason.description,
        instructions: recall.instructions.patientInstructions,
        refundPolicy: recall.instructions.refundPolicy,
        responseUrl: `${process.env.APP_URL}/recall/${recallId}/respond?patient=${patient.patientId}`
      }
    });

    if (recall.classification === 'class_i') {
      channels.push({
        type: 'sms',
        priority: 'urgent',
        template: 'recall_urgent_sms',
        data: {
          productName: recall.product.productName,
          actionRequired: 'Stop use immediately',
          infoUrl: `${process.env.APP_URL}/recall/${recallId}`
        }
      });

      channels.push({
        type: 'phone',
        priority: 'critical',
        script: 'recall_phone_script',
        maxAttempts: 3
      });
    }

    await sendMultiChannelNotification(patient.patientId, channels);

    await updatePatientNotificationStatus(recallId, patient.patientId, 'sent');
  }
};
```

---

## Environmental Monitoring (Clean Room)

USP 797/800 compliant environmental monitoring for sterile compounding areas with alerting and trending.

### Environmental Monitoring Architecture

```typescript
interface EnvironmentalMonitoring {
  recordReading: (reading: EnvironmentalReading) => Promise<void>;
  checkExcursions: () => Promise<Excursion[]>;
  generateReport: (areaId: string, dateRange: DateRange) => Promise<EnvironmentalReport>;
  calibrateSensor: (sensorId: string, calibration: CalibrationRecord) => Promise<void>;
}

interface CleanRoomArea {
  id: string;
  name: string;
  classification: 'iso_5' | 'iso_7' | 'iso_8' | 'unclassified';
  type: 'primary_engineering_control' | 'buffer_room' | 'ante_room' | 'storage';

  requirements: {
    temperature: { min: number; max: number; unit: 'celsius' | 'fahrenheit' };
    humidity: { min: number; max: number };
    pressure: { differential: number; reference: string };
    particleCount?: { maxPerCubicMeter: number; particleSize: number };
  };

  sensors: Sensor[];

  monitoringSchedule: {
    continuous: string[];
    daily: string[];
    weekly: string[];
    monthly: string[];
  };

  certificationStatus: {
    lastCertified: string;
    nextCertificationDue: string;
    certifiedBy: string;
  };
}

interface Sensor {
  id: string;
  areaId: string;
  type: 'temperature' | 'humidity' | 'pressure' | 'particle_counter';
  location: string;
  model: string;
  serialNumber: string;

  status: 'active' | 'calibration_due' | 'out_of_service' | 'alarming';

  calibration: {
    lastCalibrated: string;
    nextCalibrationDue: string;
    calibratedBy: string;
    certificateUrl?: string;
  };

  alertThresholds: {
    warning: { low?: number; high?: number };
    critical: { low?: number; high?: number };
  };
}

interface EnvironmentalReading {
  id: string;
  sensorId: string;
  areaId: string;

  type: Sensor['type'];
  value: number;
  unit: string;

  status: 'normal' | 'warning' | 'critical' | 'sensor_error';

  recordedAt: string;
  recordedBy?: string;
}

interface Excursion {
  id: string;
  sensorId: string;
  areaId: string;

  type: 'temperature' | 'humidity' | 'pressure' | 'particle';
  severity: 'warning' | 'critical';

  reading: number;
  threshold: number;
  deviation: number;

  startedAt: string;
  endedAt?: string;
  durationMinutes?: number;

  acknowledged: boolean;
  acknowledgedBy?: string;
  acknowledgedAt?: string;

  rootCause?: string;
  correctiveAction?: string;

  impactAssessment?: {
    productsAtRisk: string[];
    batchesAffected: string[];
    actionRequired: 'none' | 'review' | 'quarantine' | 'discard';
  };

  capaId?: string;
}

const monitoringRequirements: Record<string, EnvironmentalRequirements> = {
  iso_5: {
    temperature: { min: 20, max: 24, unit: 'celsius' },
    humidity: { min: 30, max: 60 },
    pressure: { differential: 0.02, positiveToBuffer: true },
    particleCount: { maxPerCubicMeter: 3520, particleSize: 0.5 }
  },
  iso_7: {
    temperature: { min: 20, max: 24, unit: 'celsius' },
    humidity: { min: 30, max: 60 },
    pressure: { differential: 0.01, positiveToAnte: true },
    particleCount: { maxPerCubicMeter: 352000, particleSize: 0.5 }
  }
};

const handleExcursion = async (reading: EnvironmentalReading, threshold: Threshold): Promise<void> => {
  const excursion = await createExcursion({
    sensorId: reading.sensorId,
    areaId: reading.areaId,
    type: reading.type,
    severity: threshold.type,
    reading: reading.value,
    threshold: threshold.value,
    deviation: Math.abs(reading.value - threshold.value),
    startedAt: reading.recordedAt
  });

  await sendAlerts(excursion);

  if (excursion.severity === 'critical') {
    const activeProduction = await getActiveProductionInArea(reading.areaId);
    if (activeProduction.length > 0) {
      await quarantineProduction(activeProduction);
      await notifyPharmacist(excursion, activeProduction);
    }
  }

  if (await shouldCreateCAPA(excursion)) {
    await createCAPA({
      type: 'corrective',
      category: 'environmental',
      source: { type: 'deviation', referenceId: excursion.id },
      severity: excursion.severity === 'critical' ? 'major' : 'minor'
    });
  }
};
```

---

## Equipment Calibration Tracking

Calibration scheduling, tracking, and compliance for pharmacy equipment per USP and FDA requirements.

### Calibration Management Architecture

```typescript
interface CalibrationManagement {
  scheduleCalibration: (equipmentId: string) => Promise<CalibrationSchedule>;
  recordCalibration: (calibration: CalibrationRecord) => Promise<void>;
  getCalibrationStatus: () => Promise<CalibrationStatusReport>;
  generateCertificate: (calibrationId: string) => Promise<CalibrationCertificate>;
}

interface Equipment {
  id: string;

  name: string;
  type: EquipmentType;
  manufacturer: string;
  model: string;
  serialNumber: string;

  location: {
    areaId: string;
    areaName: string;
    position: string;
  };

  status: 'in_service' | 'calibration_due' | 'out_of_tolerance' | 'out_of_service' | 'retired';

  criticality: 'critical' | 'major' | 'minor';

  calibrationRequirements: {
    frequency: number;
    frequencyUnit: 'days' | 'months' | 'years';
    calibrationProcedure: string;
    acceptanceCriteria: AcceptanceCriterion[];
    calibratedBy: 'internal' | 'external' | 'manufacturer';
    vendorId?: string;
  };

  maintenanceRequirements: {
    preventiveMaintenanceFrequency: number;
    lastMaintenance: string;
    nextMaintenanceDue: string;
  };

  documentation: {
    manualUrl?: string;
    sopIds: string[];
    validationDocuments?: string[];
  };

  purchaseInfo: {
    purchaseDate: string;
    warrantyExpiration?: string;
    vendor: string;
    cost: number;
  };

  createdAt: string;
  updatedAt: string;
}

type EquipmentType =
  | 'balance'
  | 'ph_meter'
  | 'thermometer'
  | 'hygrometer'
  | 'pressure_gauge'
  | 'laminar_flow_hood'
  | 'autoclave'
  | 'refrigerator'
  | 'freezer'
  | 'incubator'
  | 'particle_counter'
  | 'pipette'
  | 'volumetric';

interface CalibrationRecord {
  id: string;
  equipmentId: string;

  type: 'routine' | 'post_repair' | 'post_maintenance' | 'verification' | 'initial';

  performedBy: {
    name: string;
    company?: string;
    certificationNumber?: string;
  };

  date: string;

  standardsUsed: {
    standardId: string;
    description: string;
    certificateNumber: string;
    traceableTo: string;
    expirationDate: string;
  }[];

  environmentalConditions: {
    temperature: number;
    humidity: number;
  };

  measurements: CalibrationMeasurement[];

  result: 'pass' | 'fail' | 'pass_with_adjustment';

  adjustmentsMade?: string;

  outOfToleranceActions?: {
    action: string;
    affectedBatches?: string[];
    riskAssessment?: string;
  };

  nextCalibrationDue: string;

  certificateNumber: string;
  certificateUrl?: string;

  approvedBy?: string;
  approvedAt?: string;

  createdAt: string;
}

interface CalibrationMeasurement {
  testPoint: string;
  nominalValue: number;
  unit: string;
  measuredValue: number;
  tolerance: number;
  deviation: number;
  withinTolerance: boolean;
  asFoundValue?: number;
  asLeftValue?: number;
}

interface CalibrationSchedule {
  equipmentId: string;
  equipmentName: string;
  lastCalibration: string;
  nextCalibrationDue: string;
  daysUntilDue: number;
  status: 'current' | 'due_soon' | 'overdue';
  assignedTo?: string;
  vendorScheduled?: boolean;
}

const getCalibrationStatus = async (): Promise<CalibrationStatusReport> => {
  const equipment = await getAllEquipment();

  const report: CalibrationStatusReport = {
    summary: {
      totalEquipment: equipment.length,
      current: 0,
      dueSoon: 0,
      overdue: 0,
      outOfService: 0
    },
    byType: {},
    upcoming: [],
    overdue: [],
    certificates: []
  };

  for (const eq of equipment) {
    const daysUntilDue = getDaysUntil(eq.nextCalibrationDue);

    if (eq.status === 'out_of_service') {
      report.summary.outOfService++;
    } else if (daysUntilDue < 0) {
      report.summary.overdue++;
      report.overdue.push(eq);
    } else if (daysUntilDue <= 30) {
      report.summary.dueSoon++;
      report.upcoming.push(eq);
    } else {
      report.summary.current++;
    }
  }

  return report;
};
```

---

## Staff Training & Competency Tracking

Training management, competency assessments, and certification tracking for pharmacy personnel.

### Training Management Architecture

```typescript
interface TrainingManagement {
  assignTraining: (assignment: TrainingAssignment) => Promise<void>;
  recordCompletion: (completionId: string, result: TrainingResult) => Promise<void>;
  assessCompetency: (staffId: string, competencyId: string) => Promise<CompetencyAssessment>;
  getComplianceStatus: () => Promise<TrainingComplianceReport>;
}

interface TrainingProgram {
  id: string;
  code: string;
  name: string;
  description: string;

  type: 'initial' | 'annual' | 'remedial' | 'new_procedure' | 'regulatory';

  category: 'aseptic_technique' | 'hazardous_drugs' | 'quality_systems' | 'safety' | 'equipment' | 'documentation' | 'regulatory' | 'job_specific';

  content: {
    format: 'online' | 'classroom' | 'hands_on' | 'blended';
    duration: number;
    durationUnit: 'minutes' | 'hours' | 'days';
    modules: TrainingModule[];
    materials: { name: string; url: string; type: string }[];
  };

  assessment: {
    required: boolean;
    type: 'quiz' | 'practical' | 'observation' | 'written';
    passingScore: number;
    maxAttempts: number;
  };

  validity: {
    expiresAfter: number;
    expiresUnit: 'months' | 'years';
    requiresRefresher: boolean;
    refresherProgramId?: string;
  };

  applicability: {
    roles: string[];
    departments: string[];
    mandatory: boolean;
  };

  regulatoryBasis?: string;

  status: 'active' | 'draft' | 'retired';
  version: string;

  createdAt: string;
  updatedAt: string;
}

interface TrainingModule {
  id: string;
  name: string;
  description: string;
  order: number;
  duration: number;
  contentUrl?: string;
  learningObjectives: string[];
}

interface TrainingAssignment {
  id: string;
  staffId: string;
  programId: string;

  assignedBy: string;
  assignedAt: string;
  dueDate: string;

  status: 'assigned' | 'in_progress' | 'completed' | 'expired' | 'exempted';

  progress: {
    modulesCompleted: number;
    totalModules: number;
    percentComplete: number;
    lastAccessedAt?: string;
  };

  completion?: {
    completedAt: string;
    score?: number;
    passed: boolean;
    attempts: number;
    certificateId?: string;
  };

  exemption?: {
    reason: string;
    approvedBy: string;
    approvedAt: string;
    expiresAt?: string;
  };
}

interface StaffCompetency {
  id: string;
  staffId: string;
  competencyId: string;

  competencyName: string;
  category: string;

  status: 'not_assessed' | 'competent' | 'developing' | 'not_competent' | 'expired';

  assessments: CompetencyAssessment[];

  currentAssessment?: {
    assessedAt: string;
    assessedBy: string;
    score: number;
    expiresAt: string;
  };

  requiredForRole: boolean;
  criticalCompetency: boolean;
}

interface CompetencyAssessment {
  id: string;
  staffId: string;
  competencyId: string;

  type: 'initial' | 'annual' | 'remedial' | 'observation';

  assessedBy: string;
  assessedAt: string;

  criteria: {
    criterion: string;
    weight: number;
    score: number;
    maxScore: number;
    comments?: string;
  }[];

  overallScore: number;
  passed: boolean;

  observations: string;
  areasForImprovement?: string[];
  actionPlan?: string;

  signatures: {
    assessor: { name: string; signedAt: string };
    staff: { name: string; signedAt: string };
    manager?: { name: string; signedAt: string };
  };
}

const requiredTrainingByRole: Record<string, string[]> = {
  pharmacist: [
    'aseptic_technique_initial',
    'usp_797_overview',
    'usp_800_hazardous_drugs',
    'quality_management_systems',
    'hipaa_privacy',
    'bloodborne_pathogens'
  ],
  pharmacy_technician: [
    'aseptic_technique_initial',
    'usp_797_overview',
    'usp_800_hazardous_drugs',
    'gowning_procedure',
    'cleaning_disinfection',
    'hipaa_privacy',
    'bloodborne_pathogens'
  ],
  compounding_technician: [
    'aseptic_technique_initial',
    'aseptic_technique_advanced',
    'media_fill_testing',
    'usp_797_compounding',
    'usp_800_hazardous_drugs',
    'balance_operation',
    'equipment_operation'
  ]
};

const getTrainingComplianceStatus = async (): Promise<TrainingComplianceReport> => {
  const staff = await getAllActiveStaff();
  const report: TrainingComplianceReport = {
    overallCompliance: 0,
    byDepartment: {},
    overdue: [],
    expiringSoon: [],
    neverCompleted: []
  };

  let compliantCount = 0;

  for (const person of staff) {
    const required = requiredTrainingByRole[person.role] || [];
    const completed = await getCompletedTraining(person.id);

    const isCompliant = required.every(programId => {
      const completion = completed.find(c => c.programId === programId);
      return completion && !isExpired(completion);
    });

    if (isCompliant) compliantCount++;

    const expiring = completed.filter(c => getDaysUntil(c.expiresAt) <= 30 && getDaysUntil(c.expiresAt) > 0);
    report.expiringSoon.push(...expiring.map(c => ({ staffId: person.id, ...c })));

    const overdue = required.filter(programId => {
      const completion = completed.find(c => c.programId === programId);
      return !completion || isExpired(completion);
    });
    if (overdue.length > 0) {
      report.overdue.push({ staffId: person.id, staffName: person.name, overduePrograms: overdue });
    }
  }

  report.overallCompliance = (compliantCount / staff.length) * 100;

  return report;
};
```

---

## Data Retention & Purging

HIPAA-compliant data retention policies with automated purging and patient data deletion requests (GDPR/CCPA).

### Data Retention Architecture

```typescript
interface DataRetentionService {
  applyRetentionPolicies: () => Promise<RetentionExecutionResult>;
  processDataDeletionRequest: (request: DataDeletionRequest) => Promise<DeletionResult>;
  generateRetentionReport: () => Promise<RetentionReport>;
  archiveData: (dataType: string, olderThan: Date) => Promise<ArchiveResult>;
}

interface RetentionPolicy {
  id: string;
  name: string;
  dataType: DataType;

  retention: {
    minimumPeriod: number;
    minimumUnit: 'days' | 'months' | 'years';
    maximumPeriod?: number;
    maximumUnit?: 'days' | 'months' | 'years';
  };

  legalBasis: string;
  regulatoryReference?: string;

  action: 'archive' | 'anonymize' | 'delete';

  exceptions: {
    condition: string;
    extendedRetention: number;
    extendedUnit: 'days' | 'months' | 'years';
  }[];

  approvalRequired: boolean;
  approvers?: string[];

  status: 'active' | 'draft' | 'retired';
}

type DataType =
  | 'patient_records'
  | 'medical_records'
  | 'prescriptions'
  | 'orders'
  | 'billing_records'
  | 'audit_logs'
  | 'communications'
  | 'consent_records'
  | 'marketing_data'
  | 'analytics_data'
  | 'session_logs'
  | 'support_tickets';

const retentionPolicies: RetentionPolicy[] = [
  {
    id: 'medical_records',
    name: 'Medical Records',
    dataType: 'medical_records',
    retention: { minimumPeriod: 7, minimumUnit: 'years' },
    legalBasis: 'HIPAA requires retention of medical records for 6 years from date of creation or last effective date',
    regulatoryReference: '45 CFR § 164.530(j)',
    action: 'archive',
    exceptions: [
      { condition: 'minor_patient', extendedRetention: 21, extendedUnit: 'years' },
      { condition: 'active_litigation', extendedRetention: 999, extendedUnit: 'years' }
    ],
    approvalRequired: true,
    status: 'active'
  },
  {
    id: 'prescriptions',
    name: 'Prescription Records',
    dataType: 'prescriptions',
    retention: { minimumPeriod: 7, minimumUnit: 'years' },
    legalBasis: 'State pharmacy board requirements (varies by state, using maximum)',
    action: 'archive',
    exceptions: [
      { condition: 'controlled_substance', extendedRetention: 10, extendedUnit: 'years' }
    ],
    approvalRequired: true,
    status: 'active'
  },
  {
    id: 'audit_logs',
    name: 'Audit Logs',
    dataType: 'audit_logs',
    retention: { minimumPeriod: 7, minimumUnit: 'years' },
    legalBasis: 'HIPAA audit trail requirements',
    regulatoryReference: '45 CFR § 164.312(b)',
    action: 'archive',
    exceptions: [],
    approvalRequired: false,
    status: 'active'
  },
  {
    id: 'marketing_data',
    name: 'Marketing Data',
    dataType: 'marketing_data',
    retention: { minimumPeriod: 2, minimumUnit: 'years', maximumPeriod: 3, maximumUnit: 'years' },
    legalBasis: 'Business purpose with consent',
    action: 'anonymize',
    exceptions: [
      { condition: 'active_consent', extendedRetention: 5, extendedUnit: 'years' }
    ],
    approvalRequired: false,
    status: 'active'
  },
  {
    id: 'session_logs',
    name: 'Session Logs',
    dataType: 'session_logs',
    retention: { minimumPeriod: 90, minimumUnit: 'days' },
    legalBasis: 'Security monitoring',
    action: 'delete',
    exceptions: [],
    approvalRequired: false,
    status: 'active'
  }
];

interface DataDeletionRequest {
  id: string;
  requesterId: string;
  requesterType: 'patient' | 'authorized_representative';

  patientId: string;

  requestType: 'full_deletion' | 'partial_deletion' | 'data_export';

  scope: {
    dataTypes: DataType[];
    dateRange?: { start: string; end: string };
    excludeRequired: boolean;
  };

  verification: {
    identityVerified: boolean;
    verificationMethod: string;
    verifiedAt: string;
    verifiedBy: string;
  };

  status: 'pending_verification' | 'verified' | 'in_review' | 'approved' | 'processing' | 'completed' | 'denied';

  review?: {
    reviewedBy: string;
    reviewedAt: string;
    decision: 'approve' | 'deny' | 'partial_approve';
    denialReason?: string;
    retainedData?: { dataType: string; reason: string }[];
  };

  execution?: {
    startedAt: string;
    completedAt: string;
    itemsDeleted: number;
    itemsRetained: number;
    retentionReasons: string[];
  };

  createdAt: string;
  updatedAt: string;
  dueDate: string;
}

const processDataDeletionRequest = async (request: DataDeletionRequest): Promise<DeletionResult> => {
  const result: DeletionResult = {
    requestId: request.id,
    deleted: [],
    retained: [],
    errors: []
  };

  for (const dataType of request.scope.dataTypes) {
    const policy = retentionPolicies.find(p => p.dataType === dataType);
    const data = await getPatientData(request.patientId, dataType);

    for (const item of data) {
      const retentionEnd = calculateRetentionEnd(item, policy);

      if (new Date() < retentionEnd) {
        result.retained.push({
          dataType,
          itemId: item.id,
          reason: `Legal retention required until ${retentionEnd.toISOString()}`,
          policy: policy.legalBasis
        });
        continue;
      }

      if (hasActiveException(item, policy)) {
        result.retained.push({
          dataType,
          itemId: item.id,
          reason: 'Active exception applies',
          policy: policy.legalBasis
        });
        continue;
      }

      try {
        if (policy.action === 'delete') {
          await hardDeleteData(dataType, item.id);
        } else if (policy.action === 'anonymize') {
          await anonymizeData(dataType, item.id);
        }
        result.deleted.push({ dataType, itemId: item.id });
      } catch (error) {
        result.errors.push({ dataType, itemId: item.id, error: error.message });
      }
    }
  }

  await logDeletionExecution(request.id, result);
  await notifyPatientOfCompletion(request.patientId, result);

  return result;
};
```

---

## Patient Data Export (HIPAA Right of Access)

Patient right of access implementation for exporting personal health information per HIPAA requirements.

### Data Export Architecture

```typescript
interface DataExportService {
  requestExport: (request: ExportRequest) => Promise<ExportJob>;
  generateExport: (jobId: string) => Promise<ExportPackage>;
  deliverExport: (jobId: string, method: DeliveryMethod) => Promise<void>;
  getExportStatus: (jobId: string) => Promise<ExportStatus>;
}

interface ExportRequest {
  id: string;
  patientId: string;

  requestedBy: {
    type: 'patient' | 'authorized_representative' | 'provider' | 'legal';
    id: string;
    name: string;
    relationship?: string;
    authorization?: {
      documentUrl: string;
      validUntil: string;
    };
  };

  scope: {
    allData: boolean;
    categories?: ExportCategory[];
    dateRange?: { start: string; end: string };
    providers?: string[];
  };

  format: 'pdf' | 'json' | 'fhir_bundle' | 'ccda';

  delivery: {
    method: 'secure_download' | 'encrypted_email' | 'physical_mail' | 'direct_messaging';
    destination?: string;
  };

  expedited: boolean;

  status: 'pending' | 'processing' | 'ready' | 'delivered' | 'expired' | 'failed';

  timeline: {
    requestedAt: string;
    dueDate: string;
    processedAt?: string;
    deliveredAt?: string;
  };

  fees?: {
    applicable: boolean;
    amount?: number;
    waived: boolean;
    waiverReason?: string;
  };
}

type ExportCategory =
  | 'demographics'
  | 'medical_history'
  | 'medications'
  | 'prescriptions'
  | 'allergies'
  | 'lab_results'
  | 'consultations'
  | 'provider_notes'
  | 'billing'
  | 'insurance'
  | 'communications'
  | 'consent_records';

interface ExportPackage {
  id: string;
  exportRequestId: string;

  format: ExportRequest['format'];

  contents: {
    category: ExportCategory;
    itemCount: number;
    fileUrl: string;
    checksum: string;
  }[];

  manifest: {
    patientName: string;
    dateGenerated: string;
    dateRange: { start: string; end: string };
    totalRecords: number;
    excludedRecords: { category: string; count: number; reason: string }[];
    generatedBy: string;
  };

  encryption: {
    method: 'AES-256';
    passwordProtected: boolean;
  };

  accessUrl: string;
  accessToken: string;
  expiresAt: string;

  createdAt: string;
}

const generateExport = async (request: ExportRequest): Promise<ExportPackage> => {
  const packageContents: ExportPackage['contents'] = [];
  const excludedRecords: { category: string; count: number; reason: string }[] = [];

  const categories = request.scope.allData ? getAllCategories() : request.scope.categories;

  for (const category of categories) {
    const data = await getPatientDataByCategory(request.patientId, category, request.scope.dateRange);

    const filtered = data.filter(item => {
      if (isPsychotherapyNotes(item)) {
        excludedRecords.push({ category, count: 1, reason: 'Psychotherapy notes require separate authorization' });
        return false;
      }
      if (isPendingLitigation(item)) {
        excludedRecords.push({ category, count: 1, reason: 'Subject to legal hold' });
        return false;
      }
      return true;
    });

    if (filtered.length === 0) continue;

    const file = await formatData(filtered, request.format, category);
    const uploaded = await uploadToSecureStorage(file);

    packageContents.push({
      category,
      itemCount: filtered.length,
      fileUrl: uploaded.url,
      checksum: uploaded.checksum
    });
  }

  const exportPackage = await createExportPackage({
    exportRequestId: request.id,
    format: request.format,
    contents: packageContents,
    manifest: {
      patientName: await getPatientName(request.patientId),
      dateGenerated: new Date().toISOString(),
      dateRange: request.scope.dateRange || { start: 'all', end: 'present' },
      totalRecords: packageContents.reduce((sum, c) => sum + c.itemCount, 0),
      excludedRecords,
      generatedBy: 'Automated Export System'
    },
    encryption: {
      method: 'AES-256',
      passwordProtected: true
    },
    expiresAt: addDays(new Date(), 30).toISOString()
  });

  await logExportGeneration(request.id, exportPackage.id, packageContents);

  return exportPackage;
};

const hipaTimelines = {
  standardRequest: 30,
  expeditedRequest: 7,
  extensionAllowed: 30,
  maxTotalDays: 60
};
```

---

## Accessibility (ADA/WCAG Compliance)

Web Content Accessibility Guidelines (WCAG) 2.1 AA compliance for all patient and provider portals.

### Accessibility Architecture

```typescript
interface AccessibilityFramework {
  standards: 'WCAG_2_1_AA' | 'WCAG_2_1_AAA' | 'Section_508';

  components: AccessibleComponent[];

  testing: {
    automated: AutomatedTesting;
    manual: ManualTesting;
    userTesting: UserTesting;
  };

  documentation: {
    vpat: VPATDocument;
    accessibilityStatement: AccessibilityStatement;
  };
}

interface AccessibilityRequirements {
  perceivable: {
    textAlternatives: boolean;
    timeBasedMedia: boolean;
    adaptable: boolean;
    distinguishable: boolean;
  };

  operable: {
    keyboardAccessible: boolean;
    enoughTime: boolean;
    seizuresAndPhysical: boolean;
    navigable: boolean;
    inputModalities: boolean;
  };

  understandable: {
    readable: boolean;
    predictable: boolean;
    inputAssistance: boolean;
  };

  robust: {
    compatible: boolean;
  };
}

const accessibilityChecklist: AccessibilityCheckItem[] = [
  { id: '1.1.1', guideline: 'Non-text Content', level: 'A', description: 'All non-text content has text alternatives', automated: true },
  { id: '1.3.1', guideline: 'Info and Relationships', level: 'A', description: 'Information structure is programmatically determinable', automated: true },
  { id: '1.4.1', guideline: 'Use of Color', level: 'A', description: 'Color is not the only visual means of conveying information', automated: false },
  { id: '1.4.3', guideline: 'Contrast (Minimum)', level: 'AA', description: 'Text has contrast ratio of at least 4.5:1', automated: true },
  { id: '1.4.4', guideline: 'Resize Text', level: 'AA', description: 'Text can be resized up to 200% without loss of functionality', automated: false },
  { id: '2.1.1', guideline: 'Keyboard', level: 'A', description: 'All functionality is operable through keyboard', automated: true },
  { id: '2.1.2', guideline: 'No Keyboard Trap', level: 'A', description: 'Keyboard focus can be moved away from any component', automated: true },
  { id: '2.4.1', guideline: 'Bypass Blocks', level: 'A', description: 'Skip navigation mechanism is available', automated: true },
  { id: '2.4.2', guideline: 'Page Titled', level: 'A', description: 'Pages have descriptive titles', automated: true },
  { id: '2.4.4', guideline: 'Link Purpose', level: 'A', description: 'Link purpose can be determined from link text', automated: false },
  { id: '2.4.6', guideline: 'Headings and Labels', level: 'AA', description: 'Headings and labels describe topic or purpose', automated: false },
  { id: '2.4.7', guideline: 'Focus Visible', level: 'AA', description: 'Keyboard focus indicator is visible', automated: true },
  { id: '3.1.1', guideline: 'Language of Page', level: 'A', description: 'Default language is programmatically determinable', automated: true },
  { id: '3.2.1', guideline: 'On Focus', level: 'A', description: 'Focus does not cause unexpected context change', automated: false },
  { id: '3.2.2', guideline: 'On Input', level: 'A', description: 'Input does not cause unexpected context change', automated: false },
  { id: '3.3.1', guideline: 'Error Identification', level: 'A', description: 'Input errors are identified and described in text', automated: false },
  { id: '3.3.2', guideline: 'Labels or Instructions', level: 'A', description: 'Labels or instructions are provided for user input', automated: true },
  { id: '4.1.1', guideline: 'Parsing', level: 'A', description: 'No major HTML parsing errors', automated: true },
  { id: '4.1.2', guideline: 'Name, Role, Value', level: 'A', description: 'UI components have accessible names and roles', automated: true }
];

interface AccessibilityAudit {
  id: string;
  pageUrl: string;
  auditDate: string;

  automated: {
    tool: 'axe' | 'lighthouse' | 'wave';
    score: number;
    violations: AccessibilityViolation[];
    warnings: AccessibilityViolation[];
    passed: number;
  };

  manual: {
    auditor: string;
    findings: ManualFinding[];
    overallAssessment: 'compliant' | 'mostly_compliant' | 'non_compliant';
  };

  summary: {
    criticalIssues: number;
    seriousIssues: number;
    moderateIssues: number;
    minorIssues: number;
  };
}

interface AccessibilityViolation {
  id: string;
  impact: 'critical' | 'serious' | 'moderate' | 'minor';
  wcagCriteria: string[];
  description: string;
  help: string;
  helpUrl: string;
  nodes: {
    html: string;
    target: string[];
    failureSummary: string;
  }[];
}

const accessibleComponentPatterns = {
  forms: {
    labels: 'All form inputs must have associated labels using <label for=""> or aria-labelledby',
    errors: 'Error messages must be associated with inputs using aria-describedby',
    required: 'Required fields must be indicated both visually and with aria-required',
    groups: 'Related inputs must be grouped with <fieldset> and <legend>'
  },

  modals: {
    focus: 'Focus must be trapped within modal when open',
    escape: 'Modal must close on Escape key press',
    return: 'Focus must return to trigger element on close',
    aria: 'Modal must have role="dialog" and aria-modal="true"'
  },

  navigation: {
    skip: 'Skip to main content link must be first focusable element',
    landmarks: 'Use ARIA landmarks (main, nav, banner, contentinfo)',
    currentPage: 'Current page must be indicated with aria-current="page"'
  },

  tables: {
    headers: 'Data tables must have proper <th> with scope attribute',
    caption: 'Tables should have <caption> or aria-label',
    complex: 'Complex tables must use id/headers for cell associations'
  },

  media: {
    images: 'Images must have alt text (decorative images: alt="")',
    video: 'Videos must have captions and audio descriptions',
    audio: 'Audio content must have transcripts'
  }
};

const integrateAccessibilityTesting = {
  ciPipeline: {
    prCheck: {
      tool: 'axe-core',
      failOn: ['critical', 'serious'],
      pages: ['/', '/login', '/dashboard', '/medications', '/appointments']
    },
    nightly: {
      tool: 'lighthouse-ci',
      threshold: 90,
      fullSiteCrawl: true
    }
  },

  monitoring: {
    realUserMonitoring: {
      trackAssistiveTech: true,
      trackKeyboardUsage: true,
      trackZoomLevel: true
    }
  }
};
```

---

## Provider 1099 & Tax Reporting

Tax compliance for contractor providers including 1099-NEC generation and IRS reporting.

### 1099 Management Architecture

```typescript
interface TaxReportingService {
  calculate1099Eligibility: (providerId: string, taxYear: number) => Promise<Eligibility1099>;
  generate1099: (providerId: string, taxYear: number) => Promise<Form1099NEC>;
  fileWithIRS: (taxYear: number) => Promise<IRSFilingResult>;
  deliverForms: (taxYear: number) => Promise<DeliveryResult>;
}

interface ProviderTaxProfile {
  providerId: string;

  taxClassification: 'individual' | 'sole_proprietor' | 'partnership' | 'corporation' | 's_corporation' | 'llc' | 'other';

  ein?: string;
  ssn?: string;
  tinType: 'ein' | 'ssn';

  legalName: string;
  businessName?: string;

  address: {
    street1: string;
    street2?: string;
    city: string;
    state: string;
    zipCode: string;
    country: string;
  };

  w9: {
    receivedAt: string;
    documentUrl: string;
    certifiedAt: string;
    backupWithholdingRequired: boolean;
  };

  tinVerification: {
    verified: boolean;
    verifiedAt?: string;
    tinMatchResult?: 'match' | 'mismatch' | 'not_issued';
  };
}

interface Form1099NEC {
  id: string;
  taxYear: number;
  providerId: string;

  payer: {
    name: string;
    ein: string;
    address: Address;
    phone: string;
  };

  recipient: {
    name: string;
    tin: string;
    tinType: 'ein' | 'ssn';
    address: Address;
  };

  amounts: {
    box1_nonemployeeCompensation: number;
    box4_federalIncomeTaxWithheld: number;
    box5_stateTaxWithheld?: number;
    box6_statePayerNumber?: string;
    box7_stateIncome?: number;
  };

  status: 'draft' | 'pending_review' | 'approved' | 'filed_irs' | 'delivered' | 'corrected';

  corrections?: {
    originalFormId: string;
    correctionReason: string;
    correctedAt: string;
  };

  delivery: {
    method: 'mail' | 'electronic';
    consentForElectronic: boolean;
    deliveredAt?: string;
    deliveryConfirmation?: string;
  };

  filing: {
    filedAt?: string;
    irsConfirmationNumber?: string;
    stateFilings?: { state: string; filedAt: string; confirmationNumber: string }[];
  };

  createdAt: string;
  updatedAt: string;
}

interface ProviderPaymentSummary {
  providerId: string;
  taxYear: number;

  totalPayments: number;
  totalWithheld: number;
  netPayments: number;

  payments: {
    paymentId: string;
    date: string;
    amount: number;
    withheld: number;
    description: string;
  }[];

  adjustments: {
    type: 'refund' | 'chargeback' | 'bonus' | 'correction';
    amount: number;
    date: string;
    description: string;
  }[];
}

const calculate1099Eligibility = async (providerId: string, taxYear: number): Promise<Eligibility1099> => {
  const profile = await getProviderTaxProfile(providerId);
  const payments = await getProviderPayments(providerId, taxYear);

  const totalCompensation = payments.reduce((sum, p) => sum + p.amount, 0);

  if (profile.taxClassification === 'corporation' || profile.taxClassification === 's_corporation') {
    return {
      eligible: false,
      reason: 'Corporations are generally exempt from 1099-NEC',
      totalPayments: totalCompensation
    };
  }

  if (totalCompensation < 600) {
    return {
      eligible: false,
      reason: 'Total payments below $600 threshold',
      totalPayments: totalCompensation
    };
  }

  if (!profile.w9?.receivedAt) {
    return {
      eligible: true,
      blocked: true,
      reason: 'W-9 not on file',
      totalPayments: totalCompensation,
      action: 'Request W-9 from provider'
    };
  }

  return {
    eligible: true,
    blocked: false,
    totalPayments: totalCompensation,
    form: '1099-NEC'
  };
};

const taxCalendar = {
  w9Collection: { start: 'ongoing', reminder: 'on_first_payment' },
  yearEndClose: { date: '12-31', action: 'freeze_prior_year_payments' },
  form1099Generation: { deadline: '01-15', action: 'generate_all_1099s' },
  recipientDelivery: { deadline: '01-31', method: 'mail_or_electronic' },
  irsEFiling: { deadline: '01-31', action: 'file_via_fire_system' },
  corrections: { window: '03-31', action: 'file_corrected_forms' }
};
```

---

## Patient Financial Assistance

Patient assistance programs, copay assistance, and financial hardship support.

### Financial Assistance Architecture

```typescript
interface FinancialAssistanceService {
  checkEligibility: (patientId: string, programId: string) => Promise<EligibilityResult>;
  submitApplication: (application: AssistanceApplication) => Promise<Application>;
  processApplication: (applicationId: string) => Promise<ApplicationDecision>;
  applyBenefit: (patientId: string, orderId: string) => Promise<BenefitApplication>;
}

interface AssistanceProgram {
  id: string;
  name: string;
  type: 'copay_assistance' | 'patient_assistance' | 'hardship' | 'manufacturer_coupon' | 'foundation_grant';

  eligibility: {
    incomeLimit?: { amount: number; percentage?: number; basis: 'fpl' | 'fixed' };
    insuranceRequired?: boolean;
    insuranceTypes?: ('commercial' | 'medicare' | 'medicaid' | 'uninsured')[];
    diagnosisRequired?: string[];
    medications?: string[];
    geographicRestrictions?: string[];
  };

  benefit: {
    type: 'fixed_amount' | 'percentage' | 'copay_cap' | 'free_medication';
    value: number;
    maxPerFill?: number;
    maxAnnual?: number;
    coversShipping?: boolean;
  };

  application: {
    required: boolean;
    renewalPeriod?: number;
    documentsRequired: string[];
    verificationMethod: 'self_attestation' | 'document_review' | 'third_party';
  };

  funding: {
    source: 'manufacturer' | 'foundation' | 'internal' | 'government';
    fundingLimit?: number;
    currentUtilization?: number;
  };

  status: 'active' | 'paused' | 'closed' | 'waitlist';

  effectiveDates: {
    start: string;
    end?: string;
  };
}

interface AssistanceApplication {
  id: string;
  patientId: string;
  programId: string;

  status: 'draft' | 'submitted' | 'under_review' | 'approved' | 'denied' | 'expired' | 'cancelled';

  applicantInfo: {
    householdSize: number;
    annualIncome: number;
    incomeSource: string[];
    insuranceStatus: string;
    insuranceType?: string;
  };

  documentation: {
    type: string;
    documentUrl: string;
    uploadedAt: string;
    verified: boolean;
  }[];

  medicalInfo?: {
    diagnosis: string[];
    prescribingProvider: string;
    medications: string[];
  };

  review?: {
    reviewedBy: string;
    reviewedAt: string;
    decision: 'approved' | 'denied';
    denialReason?: string;
    notes?: string;
  };

  benefit?: {
    approvedAmount: number;
    benefitType: string;
    validFrom: string;
    validTo: string;
    usageToDate: number;
  };

  createdAt: string;
  updatedAt: string;
}

const federalPovertyLevels2024 = {
  contiguous48: {
    1: 15060,
    2: 20440,
    3: 25820,
    4: 31200,
    5: 36580,
    6: 41960,
    7: 47340,
    8: 52720,
    additionalPerson: 5380
  },
  alaska: {
    1: 18810,
    2: 25540,
    3: 32270,
    4: 39000,
    5: 45730,
    6: 52460,
    7: 59190,
    8: 65920,
    additionalPerson: 6730
  },
  hawaii: {
    1: 17310,
    2: 23500,
    3: 29690,
    4: 35880,
    5: 42070,
    6: 48260,
    7: 54450,
    8: 60640,
    additionalPerson: 6190
  }
};

const checkAssistanceEligibility = async (patientId: string, programId: string): Promise<EligibilityResult> => {
  const program = await getProgram(programId);
  const patient = await getPatient(patientId);
  const application = await getActiveApplication(patientId, programId);

  const checks: EligibilityCheck[] = [];

  if (program.eligibility.incomeLimit) {
    const fplThreshold = calculateFPLThreshold(
      patient.householdSize,
      patient.state,
      program.eligibility.incomeLimit.percentage || 100
    );

    checks.push({
      criterion: 'income',
      passed: patient.annualIncome <= fplThreshold,
      details: `Income ${patient.annualIncome} vs threshold ${fplThreshold}`
    });
  }

  if (program.eligibility.insuranceRequired !== undefined) {
    const hasInsurance = patient.insuranceStatus !== 'uninsured';
    checks.push({
      criterion: 'insurance',
      passed: hasInsurance === program.eligibility.insuranceRequired,
      details: `Insurance required: ${program.eligibility.insuranceRequired}, has: ${hasInsurance}`
    });
  }

  if (program.eligibility.insuranceTypes) {
    checks.push({
      criterion: 'insurance_type',
      passed: program.eligibility.insuranceTypes.includes(patient.insuranceType),
      details: `Accepted types: ${program.eligibility.insuranceTypes.join(', ')}`
    });
  }

  if (program.status !== 'active') {
    checks.push({
      criterion: 'program_status',
      passed: false,
      details: `Program is ${program.status}`
    });
  }

  return {
    eligible: checks.every(c => c.passed),
    checks,
    nextSteps: checks.every(c => c.passed) ? 'Submit application' : 'Does not meet eligibility criteria'
  };
};
```

---

## Promotional & Coupon Engine

Coupon codes, promotional discounts, and marketing offer management.

### Promotions Architecture

```typescript
interface PromotionsService {
  validateCode: (code: string, context: OrderContext) => Promise<ValidationResult>;
  applyPromotion: (orderId: string, promotionId: string) => Promise<AppliedDiscount>;
  createPromotion: (promotion: PromotionCreate) => Promise<Promotion>;
  getPromotionAnalytics: (promotionId: string) => Promise<PromotionAnalytics>;
}

interface Promotion {
  id: string;
  code: string;
  name: string;
  description: string;

  type: 'percentage' | 'fixed_amount' | 'free_shipping' | 'bogo' | 'bundle' | 'tiered';

  discount: {
    value: number;
    maxDiscount?: number;
    minimumOrder?: number;
    minimumQuantity?: number;
  };

  tieredDiscount?: {
    tiers: { threshold: number; discount: number }[];
    thresholdType: 'amount' | 'quantity';
  };

  applicability: {
    products?: string[];
    categories?: string[];
    excludedProducts?: string[];
    excludedCategories?: string[];
    newCustomersOnly?: boolean;
    existingCustomersOnly?: boolean;
  };

  limits: {
    totalUses?: number;
    usesPerCustomer?: number;
    usesRemaining?: number;
  };

  validity: {
    startDate: string;
    endDate: string;
    timezone: string;
  };

  stackable: boolean;
  stackingRules?: {
    canStackWith: string[];
    cannotStackWith: string[];
  };

  attribution: {
    campaign?: string;
    channel?: string;
    source?: string;
  };

  status: 'draft' | 'scheduled' | 'active' | 'paused' | 'expired' | 'depleted';

  analytics: {
    totalUses: number;
    totalDiscount: number;
    averageOrderValue: number;
    conversionRate?: number;
  };

  createdAt: string;
  updatedAt: string;
}

interface AppliedDiscount {
  promotionId: string;
  code: string;
  type: Promotion['type'];

  discount: {
    subtotalDiscount: number;
    shippingDiscount: number;
    totalDiscount: number;
  };

  appliedTo: {
    itemId: string;
    productName: string;
    originalPrice: number;
    discountedPrice: number;
    discountAmount: number;
  }[];
}

const validatePromotionCode = async (code: string, context: OrderContext): Promise<ValidationResult> => {
  const promotion = await findPromotionByCode(code.toUpperCase());

  if (!promotion) {
    return { valid: false, error: 'Invalid promotion code' };
  }

  if (promotion.status !== 'active') {
    return { valid: false, error: 'This promotion is no longer active' };
  }

  const now = new Date();
  if (now < new Date(promotion.validity.startDate)) {
    return { valid: false, error: 'This promotion has not started yet' };
  }
  if (now > new Date(promotion.validity.endDate)) {
    return { valid: false, error: 'This promotion has expired' };
  }

  if (promotion.limits.usesRemaining !== undefined && promotion.limits.usesRemaining <= 0) {
    return { valid: false, error: 'This promotion has reached its usage limit' };
  }

  if (promotion.limits.usesPerCustomer) {
    const customerUses = await getCustomerPromotionUses(context.customerId, promotion.id);
    if (customerUses >= promotion.limits.usesPerCustomer) {
      return { valid: false, error: 'You have already used this promotion the maximum number of times' };
    }
  }

  if (promotion.applicability.newCustomersOnly && context.isExistingCustomer) {
    return { valid: false, error: 'This promotion is for new customers only' };
  }

  if (promotion.discount.minimumOrder && context.subtotal < promotion.discount.minimumOrder) {
    return { valid: false, error: `Minimum order of $${promotion.discount.minimumOrder} required` };
  }

  const applicableItems = filterApplicableItems(context.items, promotion.applicability);
  if (applicableItems.length === 0) {
    return { valid: false, error: 'No items in your cart are eligible for this promotion' };
  }

  const discount = calculateDiscount(promotion, applicableItems, context);

  return {
    valid: true,
    promotion,
    discount,
    message: formatDiscountMessage(promotion, discount)
  };
};

const promotionTypes = {
  welcome: {
    template: { type: 'percentage', value: 15, newCustomersOnly: true },
    defaultDuration: 30
  },
  referral: {
    template: { type: 'fixed_amount', value: 20, usesPerCustomer: 1 },
    defaultDuration: 90
  },
  seasonal: {
    template: { type: 'percentage', value: 10 },
    defaultDuration: 7
  },
  abandoned_cart: {
    template: { type: 'percentage', value: 10, minimumOrder: 50 },
    defaultDuration: 3
  },
  loyalty: {
    template: { type: 'tiered', tiers: [{ threshold: 100, discount: 5 }, { threshold: 200, discount: 10 }, { threshold: 300, discount: 15 }] },
    defaultDuration: 365
  }
};
```

---

## Wearable & Device Integrations

Health device data synchronization from Apple Health, Google Fit, Fitbit, and medical devices.

### Device Integration Architecture

```typescript
interface DeviceIntegrationService {
  connectDevice: (patientId: string, platform: DevicePlatform) => Promise<DeviceConnection>;
  syncData: (connectionId: string) => Promise<SyncResult>;
  getHealthData: (patientId: string, dataType: HealthDataType, dateRange: DateRange) => Promise<HealthDataPoint[]>;
  setAlerts: (patientId: string, alerts: HealthAlert[]) => Promise<void>;
}

type DevicePlatform = 'apple_health' | 'google_fit' | 'fitbit' | 'garmin' | 'oura' | 'withings' | 'dexcom' | 'freestyle_libre' | 'omron';

type HealthDataType =
  | 'weight'
  | 'blood_pressure'
  | 'heart_rate'
  | 'blood_glucose'
  | 'steps'
  | 'sleep'
  | 'activity'
  | 'body_temperature'
  | 'oxygen_saturation'
  | 'respiratory_rate';

interface DeviceConnection {
  id: string;
  patientId: string;
  platform: DevicePlatform;

  status: 'pending' | 'connected' | 'disconnected' | 'error' | 'revoked';

  authentication: {
    accessToken?: string;
    refreshToken?: string;
    expiresAt?: string;
    scope: string[];
  };

  syncSettings: {
    enabled: boolean;
    frequency: 'realtime' | 'hourly' | 'daily';
    dataTypes: HealthDataType[];
    lastSyncAt?: string;
    nextSyncAt?: string;
  };

  deviceInfo?: {
    deviceId: string;
    deviceName: string;
    model: string;
    firmwareVersion: string;
  };

  createdAt: string;
  updatedAt: string;
}

interface HealthDataPoint {
  id: string;
  patientId: string;
  connectionId: string;

  dataType: HealthDataType;
  value: number;
  unit: string;

  metadata?: {
    source: string;
    deviceId?: string;
    accuracy?: number;
    context?: string;
  };

  timestamp: string;
  endTimestamp?: string;

  syncedAt: string;
}

interface SyncResult {
  connectionId: string;
  syncedAt: string;

  dataPoints: {
    dataType: HealthDataType;
    count: number;
    dateRange: { start: string; end: string };
  }[];

  errors: {
    dataType: HealthDataType;
    error: string;
  }[];

  nextSyncAt: string;
}

const platformConfigs: Record<DevicePlatform, PlatformConfig> = {
  apple_health: {
    name: 'Apple Health',
    authType: 'healthkit',
    supportedDataTypes: ['weight', 'blood_pressure', 'heart_rate', 'steps', 'sleep', 'activity', 'blood_glucose'],
    requiresApp: true,
    syncMethod: 'push'
  },
  google_fit: {
    name: 'Google Fit',
    authType: 'oauth2',
    authUrl: 'https://accounts.google.com/o/oauth2/v2/auth',
    tokenUrl: 'https://oauth2.googleapis.com/token',
    scopes: ['https://www.googleapis.com/auth/fitness.activity.read', 'https://www.googleapis.com/auth/fitness.body.read'],
    supportedDataTypes: ['weight', 'heart_rate', 'steps', 'sleep', 'activity'],
    syncMethod: 'pull'
  },
  fitbit: {
    name: 'Fitbit',
    authType: 'oauth2',
    authUrl: 'https://www.fitbit.com/oauth2/authorize',
    tokenUrl: 'https://api.fitbit.com/oauth2/token',
    scopes: ['weight', 'heartrate', 'activity', 'sleep'],
    supportedDataTypes: ['weight', 'heart_rate', 'steps', 'sleep', 'activity', 'oxygen_saturation'],
    webhookSupport: true,
    syncMethod: 'webhook'
  },
  dexcom: {
    name: 'Dexcom CGM',
    authType: 'oauth2',
    authUrl: 'https://api.dexcom.com/v2/oauth2/login',
    tokenUrl: 'https://api.dexcom.com/v2/oauth2/token',
    scopes: ['offline_access'],
    supportedDataTypes: ['blood_glucose'],
    medicalDevice: true,
    syncMethod: 'pull'
  },
  freestyle_libre: {
    name: 'FreeStyle Libre',
    authType: 'oauth2',
    supportedDataTypes: ['blood_glucose'],
    medicalDevice: true,
    syncMethod: 'pull'
  },
  omron: {
    name: 'Omron',
    authType: 'oauth2',
    supportedDataTypes: ['blood_pressure', 'heart_rate'],
    medicalDevice: true,
    syncMethod: 'pull'
  }
};

const syncHealthData = async (connectionId: string): Promise<SyncResult> => {
  const connection = await getConnection(connectionId);
  const config = platformConfigs[connection.platform];

  const results: SyncResult = {
    connectionId,
    syncedAt: new Date().toISOString(),
    dataPoints: [],
    errors: [],
    nextSyncAt: calculateNextSync(connection.syncSettings.frequency)
  };

  for (const dataType of connection.syncSettings.dataTypes) {
    try {
      const lastSync = connection.syncSettings.lastSyncAt || subDays(new Date(), 30).toISOString();

      const rawData = await fetchFromPlatform(connection, dataType, lastSync);

      const normalizedData = normalizeHealthData(rawData, connection.platform, dataType);

      await saveHealthDataPoints(connection.patientId, connectionId, normalizedData);

      results.dataPoints.push({
        dataType,
        count: normalizedData.length,
        dateRange: {
          start: normalizedData[0]?.timestamp,
          end: normalizedData[normalizedData.length - 1]?.timestamp
        }
      });

      await checkHealthAlerts(connection.patientId, dataType, normalizedData);
    } catch (error) {
      results.errors.push({ dataType, error: error.message });
    }
  }

  await updateConnectionSyncStatus(connectionId, results.syncedAt);

  return results;
};
```

---

## Lab Ordering Service

Direct lab test ordering with partner laboratories (Quest, Labcorp) and results integration.

### Lab Ordering Architecture

```typescript
interface LabOrderingService {
  getAvailableTests: (patientState: string) => Promise<LabTest[]>;
  createLabOrder: (order: LabOrderRequest) => Promise<LabOrder>;
  findNearbyLocations: (zipCode: string, testCode: string) => Promise<LabLocation[]>;
  getOrderStatus: (orderId: string) => Promise<LabOrderStatus>;
  processResults: (resultPayload: LabResultPayload) => Promise<void>;
}

interface LabTest {
  id: string;
  code: string;
  name: string;
  description: string;

  category: 'routine' | 'hormone' | 'metabolic' | 'lipid' | 'thyroid' | 'vitamin' | 'std' | 'drug_screen' | 'specialty';

  requirements: {
    fasting: boolean;
    fastingHours?: number;
    specialInstructions?: string;
    ageRestrictions?: { min?: number; max?: number };
    genderRestrictions?: 'male' | 'female';
  };

  components: {
    code: string;
    name: string;
    unit: string;
    referenceRange: { low?: number; high?: number; text?: string };
  }[];

  turnaroundTime: {
    typical: number;
    unit: 'hours' | 'days';
  };

  pricing: {
    patientPrice: number;
    insuranceBillable: boolean;
    cptCode?: string;
  };

  availability: {
    laboratories: ('quest' | 'labcorp' | 'local')[];
    states: string[];
    homeCollection: boolean;
  };
}

interface LabOrder {
  id: string;
  orderNumber: string;

  patientId: string;
  orderingProviderId: string;

  tests: {
    testId: string;
    testCode: string;
    testName: string;
    price: number;
  }[];

  laboratory: 'quest' | 'labcorp' | 'local';
  laboratoryOrderId?: string;

  collectionMethod: 'patient_service_center' | 'home_collection' | 'provider_office';

  location?: {
    locationId: string;
    name: string;
    address: Address;
    phone: string;
    hours: string;
  };

  scheduling?: {
    appointmentRequired: boolean;
    scheduledAt?: string;
    appointmentConfirmation?: string;
  };

  requisition: {
    requisitionUrl: string;
    requisitionCode: string;
    expiresAt: string;
  };

  diagnosis: {
    icd10Codes: string[];
    clinicalIndication: string;
  };

  status: 'created' | 'requisition_sent' | 'specimen_collected' | 'processing' | 'results_ready' | 'results_reviewed' | 'cancelled';

  results?: LabResult[];

  billing: {
    totalPrice: number;
    paymentMethod: 'patient_pay' | 'insurance';
    paymentStatus: 'pending' | 'paid' | 'insurance_submitted';
    insuranceClaim?: string;
  };

  timeline: LabOrderEvent[];

  createdAt: string;
  updatedAt: string;
}

interface LabResult {
  id: string;
  orderId: string;
  testCode: string;
  testName: string;

  collectedAt: string;
  reportedAt: string;

  components: {
    code: string;
    name: string;
    value: string;
    numericValue?: number;
    unit: string;
    referenceRange: string;
    flag: 'normal' | 'low' | 'high' | 'critical_low' | 'critical_high' | 'abnormal';
  }[];

  interpretation?: string;

  status: 'preliminary' | 'final' | 'corrected' | 'cancelled';

  reviewedBy?: string;
  reviewedAt?: string;
  patientNotified?: string;

  attachments?: {
    type: 'pdf_report' | 'image';
    url: string;
  }[];
}

const labPartnerConfigs = {
  quest: {
    name: 'Quest Diagnostics',
    apiBaseUrl: 'https://api.questdiagnostics.com',
    orderEndpoint: '/v1/orders',
    resultsEndpoint: '/v1/results',
    locationsEndpoint: '/v1/locations',
    authType: 'oauth2',
    webhookSupport: true,
    hl7Support: true
  },
  labcorp: {
    name: 'Labcorp',
    apiBaseUrl: 'https://api.labcorp.com',
    orderEndpoint: '/orders',
    resultsEndpoint: '/results',
    locationsEndpoint: '/psc-locations',
    authType: 'api_key',
    webhookSupport: true,
    hl7Support: true
  }
};

const createLabOrder = async (request: LabOrderRequest): Promise<LabOrder> => {
  const tests = await Promise.all(request.testIds.map(id => getLabTest(id)));

  const labConfig = labPartnerConfigs[request.laboratory];

  const labOrderResponse = await submitToLaboratory(labConfig, {
    patientInfo: await getPatientDemographics(request.patientId),
    providerInfo: await getProviderInfo(request.orderingProviderId),
    tests: tests.map(t => ({ code: t.code, name: t.name })),
    diagnosis: request.diagnosis,
    collectionSite: request.locationId
  });

  const order = await createOrder({
    ...request,
    laboratoryOrderId: labOrderResponse.orderId,
    requisition: {
      requisitionUrl: labOrderResponse.requisitionUrl,
      requisitionCode: labOrderResponse.requisitionCode,
      expiresAt: addDays(new Date(), 30).toISOString()
    },
    status: 'requisition_sent'
  });

  await sendRequisitionToPatient(order);

  return order;
};

const handleLabResultWebhook = async (payload: LabResultPayload): Promise<void> => {
  const order = await findOrderByLabId(payload.orderId);
  if (!order) throw new Error('Order not found');

  const results = parseHL7Results(payload.hl7Message);

  await saveLabResults(order.id, results);

  const hasCriticalValues = results.some(r =>
    r.components.some(c => c.flag === 'critical_low' || c.flag === 'critical_high')
  );

  if (hasCriticalValues) {
    await notifyProviderUrgent(order.orderingProviderId, order.id, results);
  }

  await updateOrderStatus(order.id, 'results_ready');

  await notifyPatientResultsReady(order.patientId, order.id);
};
```

---

## Data Warehouse & Business Intelligence

Centralized data warehouse with BI tooling for analytics, reporting, and data science.

### Data Warehouse Architecture

```typescript
interface DataWarehouseService {
  syncTable: (tableName: string) => Promise<SyncResult>;
  runQuery: (query: string, parameters?: Record<string, unknown>) => Promise<QueryResult>;
  scheduleReport: (report: ScheduledReport) => Promise<void>;
  createDashboard: (dashboard: DashboardConfig) => Promise<Dashboard>;
}

interface DataWarehouseConfig {
  platform: 'snowflake' | 'bigquery' | 'redshift' | 'databricks';

  snowflake?: {
    account: string;
    warehouse: string;
    database: string;
    schema: string;
    role: string;
  };

  bigquery?: {
    projectId: string;
    dataset: string;
    location: string;
  };

  replication: {
    method: 'cdc' | 'full_refresh' | 'incremental';
    tool: 'fivetran' | 'airbyte' | 'stitch' | 'custom';
    frequency: 'realtime' | 'hourly' | 'daily';
  };

  transformation: {
    tool: 'dbt' | 'dataform' | 'custom';
    scheduleTime: string;
    timezone: string;
  };

  biTool: {
    platform: 'looker' | 'metabase' | 'tableau' | 'mode';
    connectionName: string;
  };
}

interface DataModel {
  rawTables: RawTable[];
  stagingModels: StagingModel[];
  marts: DataMart[];
  metrics: MetricDefinition[];
}

const dataModelLayers = {
  raw: {
    description: 'Raw data replicated from source systems',
    tables: [
      'raw_patients',
      'raw_providers',
      'raw_orders',
      'raw_prescriptions',
      'raw_consultations',
      'raw_appointments',
      'raw_payments',
      'raw_claims',
      'raw_inventory',
      'raw_shipments'
    ],
    retention: '7 years',
    piiHandling: 'encrypted_columns'
  },

  staging: {
    description: 'Cleaned and standardized data',
    models: [
      'stg_patients',
      'stg_providers',
      'stg_orders',
      'stg_order_items',
      'stg_prescriptions',
      'stg_consultations',
      'stg_payments'
    ],
    transformations: ['deduplication', 'null_handling', 'type_casting', 'standardization']
  },

  intermediate: {
    description: 'Business logic and joins',
    models: [
      'int_patient_orders',
      'int_prescription_fulfillment',
      'int_provider_consultations',
      'int_revenue_by_channel'
    ]
  },

  marts: {
    description: 'Business-ready dimensional models',
    schemas: {
      patients: ['dim_patients', 'fct_patient_orders', 'fct_patient_consultations', 'fct_patient_adherence'],
      providers: ['dim_providers', 'fct_provider_consultations', 'fct_provider_prescriptions'],
      orders: ['dim_products', 'fct_orders', 'fct_order_items', 'fct_refunds'],
      finance: ['fct_revenue', 'fct_payments', 'fct_claims', 'fct_refunds'],
      operations: ['fct_fulfillment', 'fct_shipping', 'fct_inventory'],
      marketing: ['fct_attribution', 'fct_campaigns', 'fct_cohorts']
    }
  }
};

interface MetricDefinition {
  name: string;
  description: string;
  calculation: string;
  dimensions: string[];
  filters?: string[];
  format: 'number' | 'currency' | 'percentage';
  owner: string;
}

const coreMetrics: MetricDefinition[] = [
  {
    name: 'monthly_recurring_revenue',
    description: 'Total revenue from subscription/recurring orders',
    calculation: 'SUM(CASE WHEN is_recurring THEN order_total END)',
    dimensions: ['date_month', 'product_category', 'channel'],
    format: 'currency',
    owner: 'finance'
  },
  {
    name: 'customer_acquisition_cost',
    description: 'Total marketing spend / new customers acquired',
    calculation: 'SUM(marketing_spend) / COUNT(DISTINCT new_customer_id)',
    dimensions: ['date_month', 'channel', 'campaign'],
    format: 'currency',
    owner: 'marketing'
  },
  {
    name: 'patient_lifetime_value',
    description: 'Average total revenue per patient over lifetime',
    calculation: 'AVG(lifetime_revenue)',
    dimensions: ['acquisition_cohort', 'channel'],
    format: 'currency',
    owner: 'finance'
  },
  {
    name: 'order_fulfillment_time',
    description: 'Average time from order placement to shipment',
    calculation: 'AVG(DATEDIFF(hour, order_created_at, shipped_at))',
    dimensions: ['date_day', 'product_category', 'pharmacy'],
    format: 'number',
    owner: 'operations'
  },
  {
    name: 'prescription_conversion_rate',
    description: 'Percentage of prescriptions that convert to orders',
    calculation: 'COUNT(DISTINCT order_id) / COUNT(DISTINCT prescription_id)',
    dimensions: ['date_week', 'medication_category', 'provider'],
    format: 'percentage',
    owner: 'product'
  },
  {
    name: 'patient_nps',
    description: 'Net Promoter Score from patient surveys',
    calculation: '(COUNT(promoters) - COUNT(detractors)) / COUNT(responses) * 100',
    dimensions: ['date_month', 'touchpoint'],
    format: 'number',
    owner: 'cx'
  }
];

const dashboardTemplates = {
  executive: {
    name: 'Executive Dashboard',
    refreshFrequency: 'daily',
    tiles: [
      { metric: 'monthly_recurring_revenue', visualization: 'trend_line' },
      { metric: 'patient_lifetime_value', visualization: 'kpi' },
      { metric: 'customer_acquisition_cost', visualization: 'kpi' },
      { metric: 'patient_nps', visualization: 'gauge' }
    ]
  },
  operations: {
    name: 'Operations Dashboard',
    refreshFrequency: 'hourly',
    tiles: [
      { metric: 'order_fulfillment_time', visualization: 'trend_line' },
      { metric: 'orders_pending', visualization: 'table' },
      { metric: 'inventory_alerts', visualization: 'list' }
    ]
  },
  marketing: {
    name: 'Marketing Dashboard',
    refreshFrequency: 'daily',
    tiles: [
      { metric: 'customer_acquisition_cost', visualization: 'trend_by_channel' },
      { metric: 'conversion_funnel', visualization: 'funnel' },
      { metric: 'campaign_performance', visualization: 'table' }
    ]
  }
};
```

---

## A/B Testing & Experimentation

Feature experimentation platform for data-driven product decisions.

### Experimentation Architecture

```typescript
interface ExperimentationService {
  createExperiment: (experiment: ExperimentCreate) => Promise<Experiment>;
  assignVariant: (experimentId: string, userId: string) => Promise<VariantAssignment>;
  trackEvent: (experimentId: string, userId: string, event: ExperimentEvent) => Promise<void>;
  analyzeResults: (experimentId: string) => Promise<ExperimentResults>;
}

interface Experiment {
  id: string;
  key: string;
  name: string;
  description: string;
  hypothesis: string;

  type: 'ab' | 'multivariate' | 'feature_flag' | 'holdout';

  status: 'draft' | 'running' | 'paused' | 'completed' | 'archived';

  targeting: {
    userPercentage: number;
    segments?: string[];
    excludeSegments?: string[];
    deviceTypes?: ('web' | 'ios' | 'android')[];
    newUsersOnly?: boolean;
  };

  variants: Variant[];

  metrics: {
    primary: MetricConfig;
    secondary: MetricConfig[];
    guardrails: MetricConfig[];
  };

  schedule: {
    startDate: string;
    endDate?: string;
    minimumRuntime: number;
    minimumSampleSize: number;
  };

  analysis: {
    statisticalMethod: 'frequentist' | 'bayesian';
    confidenceLevel: number;
    minimumDetectableEffect: number;
  };

  results?: ExperimentResults;

  owner: string;
  team: string;

  createdAt: string;
  updatedAt: string;
}

interface Variant {
  id: string;
  key: string;
  name: string;
  description: string;
  weight: number;
  isControl: boolean;

  config: Record<string, unknown>;
}

interface MetricConfig {
  metricId: string;
  metricName: string;
  metricType: 'conversion' | 'revenue' | 'engagement' | 'retention';
  expectedDirection: 'increase' | 'decrease';
  minimumImprovement?: number;
}

interface VariantAssignment {
  experimentId: string;
  variantId: string;
  variantKey: string;
  userId: string;
  assignedAt: string;
  context: Record<string, unknown>;
}

interface ExperimentResults {
  experimentId: string;
  analyzedAt: string;

  sampleSize: {
    total: number;
    byVariant: Record<string, number>;
  };

  primaryMetric: MetricResult;
  secondaryMetrics: MetricResult[];
  guardrailMetrics: MetricResult[];

  winner?: {
    variantId: string;
    confidence: number;
    lift: number;
  };

  recommendation: 'ship_winner' | 'continue_running' | 'stop_no_winner' | 'investigate';
  recommendationReason: string;
}

interface MetricResult {
  metricId: string;
  metricName: string;

  byVariant: {
    variantId: string;
    variantKey: string;
    sampleSize: number;
    conversionRate?: number;
    mean?: number;
    standardDeviation?: number;
  }[];

  comparison: {
    controlVariant: string;
    treatmentVariant: string;
    absoluteDifference: number;
    relativeLift: number;
    pValue: number;
    confidenceInterval: { lower: number; upper: number };
    isSignificant: boolean;
    power: number;
  }[];
}

const assignVariant = async (experimentId: string, userId: string, context: Record<string, unknown>): Promise<VariantAssignment> => {
  const existingAssignment = await getExistingAssignment(experimentId, userId);
  if (existingAssignment) {
    return existingAssignment;
  }

  const experiment = await getExperiment(experimentId);

  if (experiment.status !== 'running') {
    return { experimentId, variantId: 'control', variantKey: 'control', userId, assignedAt: new Date().toISOString(), context };
  }

  if (!meetsTargetingCriteria(experiment.targeting, userId, context)) {
    return { experimentId, variantId: 'excluded', variantKey: 'excluded', userId, assignedAt: new Date().toISOString(), context };
  }

  const hash = hashUserExperiment(userId, experimentId);
  const bucket = hash % 100;

  if (bucket >= experiment.targeting.userPercentage) {
    return { experimentId, variantId: 'excluded', variantKey: 'excluded', userId, assignedAt: new Date().toISOString(), context };
  }

  const variant = selectVariantByWeight(experiment.variants, hash);

  const assignment: VariantAssignment = {
    experimentId,
    variantId: variant.id,
    variantKey: variant.key,
    userId,
    assignedAt: new Date().toISOString(),
    context
  };

  await saveAssignment(assignment);
  await trackExposure(assignment);

  return assignment;
};

const experimentIntegrations = {
  frontend: {
    sdk: '@company/experiment-sdk',
    methods: ['getVariant', 'trackConversion', 'trackEvent'],
    caching: 'localStorage with TTL'
  },
  backend: {
    sdk: '@company/experiment-node',
    methods: ['assignVariant', 'trackEvent', 'forceVariant'],
    caching: 'Redis with experiment version key'
  },
  analytics: {
    eventPrefix: 'experiment_',
    properties: ['experiment_id', 'variant_id', 'variant_key'],
    destinations: ['amplitude', 'segment', 'warehouse']
  }
};
```

---

## Caregiver & Family Access

Proxy access for caregivers and family members to manage patient care with appropriate permissions.

### Caregiver Access Architecture

```typescript
interface CaregiverService {
  inviteCaregiver: (patientId: string, invitation: CaregiverInvitation) => Promise<Invitation>;
  acceptInvitation: (invitationCode: string, caregiverId: string) => Promise<CaregiverAccess>;
  updatePermissions: (accessId: string, permissions: CaregiverPermissions) => Promise<void>;
  revokeAccess: (accessId: string, reason: string) => Promise<void>;
  auditAccess: (accessId: string) => Promise<AccessAuditLog[]>;
}

interface CaregiverAccess {
  id: string;

  patientId: string;
  caregiverId: string;

  relationship: 'spouse' | 'parent' | 'child' | 'sibling' | 'guardian' | 'healthcare_proxy' | 'power_of_attorney' | 'other';
  relationshipDetails?: string;

  legalBasis: {
    type: 'patient_consent' | 'legal_guardianship' | 'power_of_attorney' | 'healthcare_proxy' | 'minor_child';
    documentUrl?: string;
    verifiedAt?: string;
    verifiedBy?: string;
    expiresAt?: string;
  };

  permissions: CaregiverPermissions;

  status: 'pending' | 'active' | 'suspended' | 'revoked' | 'expired';

  notifications: {
    receiveAppointmentReminders: boolean;
    receiveOrderUpdates: boolean;
    receiveMedicationReminders: boolean;
    receiveHealthAlerts: boolean;
  };

  createdAt: string;
  updatedAt: string;
  lastAccessedAt?: string;
}

interface CaregiverPermissions {
  viewMedicalRecords: boolean;
  viewMedications: boolean;
  viewAppointments: boolean;
  viewOrders: boolean;
  viewBilling: boolean;

  scheduleAppointments: boolean;
  manageOrders: boolean;
  communicateWithProviders: boolean;
  managePaymentMethods: boolean;

  receiveResultsNotifications: boolean;

  restrictions?: {
    sensitiveRecordsExcluded: boolean;
    mentalHealthExcluded: boolean;
    substanceAbuseExcluded: boolean;
    hivStatusExcluded: boolean;
    reproductiveHealthExcluded: boolean;
  };
}

const permissionPresets: Record<string, CaregiverPermissions> = {
  full_access: {
    viewMedicalRecords: true,
    viewMedications: true,
    viewAppointments: true,
    viewOrders: true,
    viewBilling: true,
    scheduleAppointments: true,
    manageOrders: true,
    communicateWithProviders: true,
    managePaymentMethods: true,
    receiveResultsNotifications: true
  },
  care_coordinator: {
    viewMedicalRecords: true,
    viewMedications: true,
    viewAppointments: true,
    viewOrders: true,
    viewBilling: false,
    scheduleAppointments: true,
    manageOrders: false,
    communicateWithProviders: true,
    managePaymentMethods: false,
    receiveResultsNotifications: true
  },
  financial_only: {
    viewMedicalRecords: false,
    viewMedications: false,
    viewAppointments: false,
    viewOrders: true,
    viewBilling: true,
    scheduleAppointments: false,
    manageOrders: true,
    communicateWithProviders: false,
    managePaymentMethods: true,
    receiveResultsNotifications: false
  },
  view_only: {
    viewMedicalRecords: true,
    viewMedications: true,
    viewAppointments: true,
    viewOrders: true,
    viewBilling: false,
    scheduleAppointments: false,
    manageOrders: false,
    communicateWithProviders: false,
    managePaymentMethods: false,
    receiveResultsNotifications: true
  }
};

const validateCaregiverAction = async (caregiverId: string, patientId: string, action: string): Promise<boolean> => {
  const access = await getCaregiverAccess(caregiverId, patientId);

  if (!access || access.status !== 'active') {
    return false;
  }

  if (access.legalBasis.expiresAt && new Date(access.legalBasis.expiresAt) < new Date()) {
    await suspendAccess(access.id, 'Legal authorization expired');
    return false;
  }

  const actionPermissionMap: Record<string, keyof CaregiverPermissions> = {
    'view_records': 'viewMedicalRecords',
    'view_medications': 'viewMedications',
    'schedule_appointment': 'scheduleAppointments',
    'place_order': 'manageOrders',
    'send_message': 'communicateWithProviders',
    'update_payment': 'managePaymentMethods'
  };

  const requiredPermission = actionPermissionMap[action];
  if (!requiredPermission) {
    return false;
  }

  const hasPermission = access.permissions[requiredPermission];

  await logCaregiverAccess(access.id, action, hasPermission);

  return hasPermission;
};
```

---

## Pediatric Patient Workflows

Specialized workflows for minor patients including guardian consent, age transitions, and privacy controls.

### Pediatric Architecture

```typescript
interface PediatricService {
  registerMinor: (minorData: MinorRegistration, guardianId: string) => Promise<MinorPatient>;
  addGuardian: (patientId: string, guardian: GuardianInfo) => Promise<Guardian>;
  checkConsentRequirements: (patientId: string, action: string) => Promise<ConsentRequirement>;
  handleAgeTransition: (patientId: string) => Promise<AgeTransitionResult>;
}

interface MinorPatient {
  id: string;
  patientId: string;

  dateOfBirth: string;
  currentAge: number;

  guardians: Guardian[];
  primaryGuardianId: string;

  consentStatus: {
    generalMedicalConsent: boolean;
    telehealthConsent: boolean;
    prescriptionConsent: boolean;
    marketingConsent: boolean;
  };

  ageRelatedSettings: {
    adolescentPrivacyEnabled: boolean;
    adolescentPrivacyStartAge: number;
    adultTransitionAge: number;
    upcomingTransitionDate?: string;
  };

  restrictions: {
    certainMedicationsRequireGuardian: boolean;
    financialDecisionsRequireGuardian: boolean;
    sensitiveTopicsPrivate: boolean;
  };

  schoolInfo?: {
    schoolName: string;
    grade: number;
    nurseContact?: string;
  };
}

interface Guardian {
  id: string;
  userId: string;

  relationship: 'mother' | 'father' | 'stepmother' | 'stepfather' | 'grandparent' | 'legal_guardian' | 'foster_parent' | 'other';

  legalStatus: {
    type: 'biological_parent' | 'adoptive_parent' | 'legal_guardian' | 'custodial_parent' | 'temporary_guardian';
    courtOrder?: string;
    expiresAt?: string;
  };

  permissions: {
    canMakeHealthDecisions: boolean;
    canAccessRecords: boolean;
    canScheduleAppointments: boolean;
    canAuthorizePayments: boolean;
    canPickUpPrescriptions: boolean;
    emergencyContact: boolean;
    emergencyPriority: number;
  };

  contactInfo: {
    phone: string;
    email: string;
    preferredContact: 'phone' | 'email' | 'text';
  };

  isPrimary: boolean;
  isActive: boolean;

  createdAt: string;
}

interface ConsentRequirement {
  required: boolean;
  consentType: 'guardian_only' | 'minor_assent' | 'minor_consent' | 'either';
  guardianSignatureRequired: boolean;
  minorSignatureRequired: boolean;
  ageSpecificRules?: string;
  stateSpecificRules?: string;
}

const ageBasedConsentRules = {
  default: {
    guardianConsentRequired: { maxAge: 17 },
    minorAssentRecommended: { minAge: 7 },
    adultConsent: { minAge: 18 }
  },

  stateSpecific: {
    OR: { matureMinorAge: 15, contraceptionNoConsentAge: 15 },
    CA: { matureMinorAge: 12, mentalHealthNoConsentAge: 12 },
    NY: { contraceptionNoConsentAge: 0 }
  },

  treatmentSpecific: {
    contraception: { minorConsentAllowed: true, minAge: 12 },
    std_testing: { minorConsentAllowed: true, minAge: 12 },
    mental_health: { minorConsentAllowed: true, minAge: 12 },
    substance_abuse: { minorConsentAllowed: true, minAge: 12 },
    general_medical: { guardianRequired: true }
  }
};

const handleAgeTransition = async (patientId: string): Promise<AgeTransitionResult> => {
  const patient = await getMinorPatient(patientId);
  const today = new Date();
  const age = calculateAge(patient.dateOfBirth, today);

  const transitions: Transition[] = [];

  if (age >= 13 && !patient.ageRelatedSettings.adolescentPrivacyEnabled) {
    transitions.push({
      type: 'adolescent_privacy',
      description: 'Enable adolescent privacy controls',
      action: 'enable_sensitive_topics_privacy'
    });
  }

  if (age >= 18) {
    transitions.push({
      type: 'adult_transition',
      description: 'Convert to adult patient',
      action: 'full_adult_transition'
    });

    await convertToAdultPatient(patientId);

    await notifyGuardians(patient.guardians, {
      type: 'adult_transition',
      message: `${patient.name} has turned 18 and now has full control of their healthcare account.`,
      patientId
    });

    await requestConsentRenewal(patientId, [
      'hipaa_authorization',
      'telehealth_consent',
      'treatment_consent',
      'communication_preferences'
    ]);
  }

  return { patientId, age, transitions, completedAt: today.toISOString() };
};

const adolescentPrivacyControls = {
  sensitiveCategories: ['reproductive_health', 'mental_health', 'substance_use', 'sexual_health', 'eating_disorders'],

  privacyOptions: {
    hideFromGuardianPortal: true,
    separateProviderNotes: true,
    confidentialAppointments: true,
    privateMessaging: true
  },

  guardianAccessLevels: {
    full: 'All records visible',
    limited: 'General health only, sensitive categories hidden',
    summary: 'Health summaries only, no detailed records',
    none: 'No access to minor records'
  }
};
```

---

## Subscription & Membership Model

Recurring subscription tiers with membership benefits and billing management.

### Subscription Architecture

```typescript
interface SubscriptionService {
  createSubscription: (patientId: string, planId: string) => Promise<Subscription>;
  changePlan: (subscriptionId: string, newPlanId: string) => Promise<Subscription>;
  cancelSubscription: (subscriptionId: string, reason: string) => Promise<void>;
  pauseSubscription: (subscriptionId: string, resumeDate: string) => Promise<void>;
  getBillingHistory: (subscriptionId: string) => Promise<BillingHistory>;
}

interface SubscriptionPlan {
  id: string;
  name: string;
  description: string;

  tier: 'free' | 'basic' | 'plus' | 'premium';

  pricing: {
    monthly: number;
    annual: number;
    annualSavings: number;
  };

  benefits: PlanBenefit[];

  limits: {
    consultationsPerMonth?: number;
    freeShipping: boolean;
    freeShippingMinimum?: number;
    discountPercentage: number;
    prioritySupport: boolean;
    dedicatedPharmacist: boolean;
  };

  eligibility: {
    newMembersOnly?: boolean;
    requiresPrescription?: boolean;
    employerOnly?: boolean;
  };

  status: 'active' | 'grandfathered' | 'discontinued';
}

interface PlanBenefit {
  id: string;
  name: string;
  description: string;
  icon: string;
  highlighted: boolean;
}

interface Subscription {
  id: string;
  patientId: string;

  planId: string;
  planName: string;

  status: 'active' | 'past_due' | 'paused' | 'cancelled' | 'expired';

  billing: {
    interval: 'monthly' | 'annual';
    amount: number;
    currency: string;
    nextBillingDate: string;
    paymentMethodId: string;
  };

  usage: {
    consultationsUsed: number;
    consultationsRemaining: number;
    discountApplied: number;
    savingsToDate: number;
  };

  history: {
    startedAt: string;
    planChanges: PlanChange[];
    pauseHistory: PauseRecord[];
  };

  cancellation?: {
    requestedAt: string;
    effectiveAt: string;
    reason: string;
    feedback?: string;
    winbackOffered?: string;
  };

  stripeSubscriptionId: string;

  createdAt: string;
  updatedAt: string;
}

const subscriptionPlans: SubscriptionPlan[] = [
  {
    id: 'free',
    name: 'Basic Access',
    description: 'Essential features for occasional users',
    tier: 'free',
    pricing: { monthly: 0, annual: 0, annualSavings: 0 },
    benefits: [
      { id: 'access', name: 'Platform Access', description: 'Access to patient portal', icon: 'check', highlighted: false },
      { id: 'catalog', name: 'Drug Catalog', description: 'Browse all medications', icon: 'search', highlighted: false }
    ],
    limits: {
      consultationsPerMonth: 0,
      freeShipping: false,
      freeShippingMinimum: 75,
      discountPercentage: 0,
      prioritySupport: false,
      dedicatedPharmacist: false
    },
    status: 'active'
  },
  {
    id: 'plus',
    name: 'Plus',
    description: 'Enhanced benefits for regular patients',
    tier: 'plus',
    pricing: { monthly: 19.99, annual: 199.99, annualSavings: 40 },
    benefits: [
      { id: 'shipping', name: 'Free Shipping', description: 'Free shipping on all orders', icon: 'truck', highlighted: true },
      { id: 'discount', name: '10% Discount', description: '10% off all medications', icon: 'percent', highlighted: true },
      { id: 'consults', name: '2 Consultations/mo', description: 'Monthly provider consultations', icon: 'video', highlighted: false },
      { id: 'support', name: 'Priority Support', description: 'Skip the queue', icon: 'headset', highlighted: false }
    ],
    limits: {
      consultationsPerMonth: 2,
      freeShipping: true,
      discountPercentage: 10,
      prioritySupport: true,
      dedicatedPharmacist: false
    },
    status: 'active'
  },
  {
    id: 'premium',
    name: 'Premium',
    description: 'Complete care for committed patients',
    tier: 'premium',
    pricing: { monthly: 49.99, annual: 499.99, annualSavings: 100 },
    benefits: [
      { id: 'shipping', name: 'Free Express Shipping', description: '2-day shipping on all orders', icon: 'rocket', highlighted: true },
      { id: 'discount', name: '20% Discount', description: '20% off all medications', icon: 'percent', highlighted: true },
      { id: 'consults', name: 'Unlimited Consultations', description: 'Consult anytime', icon: 'video', highlighted: true },
      { id: 'pharmacist', name: 'Dedicated Pharmacist', description: 'Your personal pharmacist', icon: 'user-md', highlighted: true },
      { id: 'support', name: '24/7 Support', description: 'Round-the-clock assistance', icon: 'clock', highlighted: false }
    ],
    limits: {
      consultationsPerMonth: undefined,
      freeShipping: true,
      discountPercentage: 20,
      prioritySupport: true,
      dedicatedPharmacist: true
    },
    status: 'active'
  }
];

const handleSubscriptionBilling = async (subscriptionId: string): Promise<BillingResult> => {
  const subscription = await getSubscription(subscriptionId);

  try {
    const invoice = await stripe.invoices.create({
      customer: subscription.stripeCustomerId,
      subscription: subscription.stripeSubscriptionId,
      auto_advance: true
    });

    await stripe.invoices.pay(invoice.id);

    await updateSubscription(subscriptionId, {
      status: 'active',
      billing: {
        ...subscription.billing,
        nextBillingDate: addInterval(new Date(), subscription.billing.interval).toISOString()
      }
    });

    return { success: true, invoiceId: invoice.id };
  } catch (error) {
    await updateSubscription(subscriptionId, { status: 'past_due' });

    await scheduleRetry(subscriptionId, [1, 3, 5, 7]);

    await notifyPaymentFailed(subscription.patientId, error.message);

    return { success: false, error: error.message };
  }
};
```

---

## Partner & Affiliate Portal

Partner management for referral partners, affiliates, and integration partners.

### Partner Portal Architecture

```typescript
interface PartnerService {
  registerPartner: (application: PartnerApplication) => Promise<Partner>;
  generateReferralLink: (partnerId: string, campaign?: string) => Promise<ReferralLink>;
  trackConversion: (referralCode: string, orderId: string) => Promise<void>;
  calculateCommission: (partnerId: string, period: DateRange) => Promise<CommissionStatement>;
  processPayouts: (period: DateRange) => Promise<PayoutBatch>;
}

interface Partner {
  id: string;

  type: 'affiliate' | 'referral_partner' | 'integration_partner' | 'healthcare_partner' | 'employer_broker';

  status: 'pending' | 'approved' | 'active' | 'suspended' | 'terminated';

  profile: {
    companyName: string;
    contactName: string;
    email: string;
    phone: string;
    website?: string;
    address: Address;
  };

  agreement: {
    agreementId: string;
    signedAt: string;
    version: string;
    expiresAt?: string;
    terms: PartnerTerms;
  };

  commission: {
    model: 'percentage' | 'fixed' | 'tiered' | 'hybrid';
    rate: number;
    tieredRates?: { threshold: number; rate: number }[];
    minimumPayout: number;
    payoutFrequency: 'monthly' | 'quarterly';
    payoutMethod: 'ach' | 'check' | 'paypal';
  };

  tracking: {
    referralCode: string;
    trackingLinks: ReferralLink[];
    utmParameters: { source: string; medium: string; campaign?: string };
  };

  performance: {
    totalReferrals: number;
    totalConversions: number;
    conversionRate: number;
    totalRevenue: number;
    totalCommission: number;
    lifetimeValue: number;
  };

  paymentInfo: {
    paypalEmail?: string;
    bankAccount?: {
      bankName: string;
      accountType: 'checking' | 'savings';
      routingNumber: string;
      accountNumberLast4: string;
    };
    taxInfo: {
      taxId: string;
      w9Received: boolean;
      w9DocumentUrl?: string;
    };
  };

  createdAt: string;
  updatedAt: string;
}

interface PartnerTerms {
  commissionRate: number;
  cookieDuration: number;
  payoutThreshold: number;
  exclusivity: boolean;
  restrictedCategories?: string[];
  allowedMarketingMethods: string[];
  prohibitedMarketingMethods: string[];
}

interface ReferralLink {
  id: string;
  partnerId: string;

  code: string;
  url: string;

  campaign?: string;
  landingPage: string;

  tracking: {
    clicks: number;
    uniqueVisitors: number;
    conversions: number;
    revenue: number;
  };

  status: 'active' | 'paused' | 'expired';

  createdAt: string;
}

interface CommissionStatement {
  partnerId: string;
  period: { start: string; end: string };

  summary: {
    totalReferrals: number;
    totalConversions: number;
    totalRevenue: number;
    grossCommission: number;
    adjustments: number;
    netCommission: number;
  };

  lineItems: {
    orderId: string;
    orderDate: string;
    customerType: 'new' | 'returning';
    orderValue: number;
    commissionRate: number;
    commission: number;
    status: 'pending' | 'approved' | 'paid' | 'refunded';
  }[];

  adjustments: {
    type: 'refund' | 'chargeback' | 'bonus' | 'correction';
    orderId?: string;
    amount: number;
    reason: string;
  }[];

  payoutStatus: 'pending' | 'processing' | 'paid';
  payoutDate?: string;
  payoutReference?: string;
}

const partnerPortalFeatures = {
  dashboard: {
    realTimeStats: true,
    conversionTracking: true,
    revenueReporting: true,
    linkManagement: true
  },
  marketing: {
    brandAssets: true,
    emailTemplates: true,
    bannerAds: true,
    landingPages: true
  },
  reporting: {
    customDateRanges: true,
    exportFormats: ['csv', 'pdf'],
    scheduledReports: true
  },
  api: {
    trackingApi: true,
    reportingApi: true,
    webhooks: true
  }
};
```

---

## Contract & Legal Document Management

Contract lifecycle management for vendors, partners, providers, and employers.

### Contract Management Architecture

```typescript
interface ContractManagement {
  createContract: (contract: ContractCreate) => Promise<Contract>;
  sendForSignature: (contractId: string, signers: Signer[]) => Promise<SignatureRequest>;
  trackExecution: (contractId: string) => Promise<ExecutionStatus>;
  manageRenewals: () => Promise<RenewalAlert[]>;
  generateAmendment: (contractId: string, changes: Amendment) => Promise<Contract>;
}

interface Contract {
  id: string;
  contractNumber: string;

  type: ContractType;

  parties: {
    role: 'company' | 'counterparty';
    name: string;
    entityType: string;
    contactName: string;
    contactEmail: string;
    address: Address;
  }[];

  terms: {
    effectiveDate: string;
    expirationDate?: string;
    autoRenew: boolean;
    renewalTermMonths?: number;
    noticePeriodDays?: number;
    terminationClauses: string[];
  };

  financialTerms?: {
    totalValue?: number;
    paymentTerms: string;
    paymentSchedule?: PaymentSchedule[];
    currency: string;
  };

  documents: {
    type: 'main_agreement' | 'exhibit' | 'amendment' | 'sow' | 'sla' | 'baa' | 'nda';
    name: string;
    version: string;
    documentUrl: string;
    uploadedAt: string;
  }[];

  signatures: {
    signerId: string;
    signerName: string;
    signerTitle: string;
    signerEmail: string;
    status: 'pending' | 'signed' | 'declined';
    signedAt?: string;
    signatureUrl?: string;
    ipAddress?: string;
  }[];

  status: 'draft' | 'pending_review' | 'pending_signature' | 'executed' | 'active' | 'expired' | 'terminated';

  compliance: {
    baaRequired: boolean;
    baaExecuted: boolean;
    ndaRequired: boolean;
    ndaExecuted: boolean;
    insuranceVerified: boolean;
    backgroundCheckRequired: boolean;
  };

  amendments: {
    amendmentNumber: number;
    description: string;
    effectiveDate: string;
    documentUrl: string;
    executedAt: string;
  }[];

  audit: {
    createdBy: string;
    createdAt: string;
    lastModifiedBy: string;
    lastModifiedAt: string;
    accessLog: { userId: string; action: string; timestamp: string }[];
  };
}

type ContractType =
  | 'provider_agreement'
  | 'vendor_agreement'
  | 'employer_agreement'
  | 'partner_agreement'
  | 'baa'
  | 'nda'
  | 'sla'
  | 'software_license'
  | 'service_agreement';

interface ContractTemplate {
  id: string;
  type: ContractType;
  name: string;
  version: string;

  content: string;
  variables: {
    name: string;
    type: 'text' | 'date' | 'number' | 'selection';
    required: boolean;
    defaultValue?: string;
    options?: string[];
  }[];

  approvalRequired: boolean;
  approvers?: string[];

  status: 'active' | 'draft' | 'deprecated';
}

const contractWorkflows = {
  provider_agreement: {
    steps: [
      { step: 1, name: 'Draft Creation', assignee: 'legal' },
      { step: 2, name: 'Internal Review', assignee: 'operations' },
      { step: 3, name: 'Legal Approval', assignee: 'legal' },
      { step: 4, name: 'Send for Signature', assignee: 'system' },
      { step: 5, name: 'Countersignature', assignee: 'ceo' },
      { step: 6, name: 'Archive', assignee: 'system' }
    ],
    requiredDocuments: ['provider_agreement', 'baa', 'w9'],
    slaSteps: { 'Internal Review': 2, 'Legal Approval': 3 }
  },

  employer_agreement: {
    steps: [
      { step: 1, name: 'Proposal Generation', assignee: 'sales' },
      { step: 2, name: 'Legal Review', assignee: 'legal' },
      { step: 3, name: 'Pricing Approval', assignee: 'finance' },
      { step: 4, name: 'Client Negotiation', assignee: 'sales' },
      { step: 5, name: 'Final Approval', assignee: 'executive' },
      { step: 6, name: 'Execution', assignee: 'system' }
    ],
    requiredDocuments: ['master_agreement', 'baa', 'sla', 'pricing_schedule'],
    slaSteps: { 'Legal Review': 5, 'Pricing Approval': 2 }
  }
};

const contractRenewalManagement = async (): Promise<RenewalAlert[]> => {
  const alerts: RenewalAlert[] = [];

  const expiringContracts = await findContractsExpiringSoon(90);

  for (const contract of expiringContracts) {
    const daysUntilExpiry = getDaysUntil(contract.terms.expirationDate);

    if (daysUntilExpiry <= 30 && !contract.terms.autoRenew) {
      alerts.push({
        contractId: contract.id,
        contractNumber: contract.contractNumber,
        counterparty: contract.parties.find(p => p.role === 'counterparty')?.name,
        expirationDate: contract.terms.expirationDate,
        daysRemaining: daysUntilExpiry,
        alertType: 'expiring_soon',
        action: 'Initiate renewal discussion or termination'
      });
    }

    if (contract.terms.autoRenew && daysUntilExpiry <= contract.terms.noticePeriodDays) {
      alerts.push({
        contractId: contract.id,
        contractNumber: contract.contractNumber,
        counterparty: contract.parties.find(p => p.role === 'counterparty')?.name,
        expirationDate: contract.terms.expirationDate,
        daysRemaining: daysUntilExpiry,
        alertType: 'auto_renewal_pending',
        action: 'Review terms before auto-renewal or provide termination notice'
      });
    }
  }

  return alerts;
};
```

---

## Backup Pharmacy Network

Overflow and disaster recovery pharmacy network for fulfillment continuity.

### Backup Network Architecture

```typescript
interface BackupPharmacyNetwork {
  findBackupPharmacy: (order: Order) => Promise<BackupPharmacy>;
  transferOrder: (orderId: string, backupPharmacyId: string) => Promise<TransferResult>;
  monitorCapacity: () => Promise<CapacityReport>;
  activateBackup: (reason: string) => Promise<ActivationResult>;
}

interface BackupPharmacy {
  id: string;
  name: string;
  type: '503a' | '503b' | 'retail' | 'specialty';

  location: {
    address: Address;
    timezone: string;
    region: string;
  };

  capabilities: {
    compoundingCapable: boolean;
    sterileCompounding: boolean;
    hazardousDrugs: boolean;
    controlledSubstances: boolean;
    coldChainCapable: boolean;
  };

  formulary: {
    supportedCategories: string[];
    excludedCompounds: string[];
    requiresFormularyCheck: boolean;
  };

  licensing: {
    pharmacyLicense: { number: string; state: string; expiresAt: string }[];
    deaLicense?: { number: string; expiresAt: string };
    accreditations: string[];
  };

  integration: {
    method: 'api' | 'sftp' | 'fax' | 'manual';
    apiEndpoint?: string;
    credentials?: string;
    formats: ('ncpdp' | 'hl7' | 'custom')[];
  };

  sla: {
    maxTurnaroundHours: number;
    communicationSla: number;
    qualityStandards: string[];
  };

  capacity: {
    maxDailyOrders: number;
    currentUtilization: number;
    surgeCapacity: number;
  };

  financials: {
    pricingModel: 'cost_plus' | 'fixed' | 'negotiated';
    markupPercentage?: number;
    minimumOrderValue?: number;
  };

  status: 'active' | 'inactive' | 'on_hold' | 'pending_contract';

  performance: {
    ordersProcessed: number;
    onTimeRate: number;
    qualityScore: number;
    issueRate: number;
  };
}

interface BackupActivationEvent {
  id: string;

  reason: 'capacity_overflow' | 'system_outage' | 'quality_hold' | 'disaster' | 'scheduled_maintenance' | 'supply_shortage';

  status: 'active' | 'resolved';

  affectedPrimaryPharmacy: string;
  activatedBackups: string[];

  impact: {
    ordersAffected: number;
    ordersTransferred: number;
    estimatedDuration: string;
  };

  timeline: {
    detectedAt: string;
    activatedAt: string;
    resolvedAt?: string;
  };

  communications: {
    internalNotified: boolean;
    patientsNotified: boolean;
    providersNotified: boolean;
  };
}

const backupPharmacySelection = async (order: Order): Promise<BackupPharmacy> => {
  const eligible = await findEligibleBackups({
    state: order.shippingAddress.state,
    compoundRequired: order.requiresCompounding,
    sterileRequired: order.requiresSterile,
    controlledSubstance: order.hasControlledSubstance,
    coldChain: order.requiresColdChain
  });

  const scored = eligible.map(pharmacy => ({
    pharmacy,
    score: calculateBackupScore(pharmacy, order)
  }));

  scored.sort((a, b) => b.score - a.score);

  const selected = scored[0].pharmacy;

  if (selected.integration.method === 'api') {
    const capacityCheck = await checkPharmacyCapacity(selected.id);
    if (!capacityCheck.available) {
      return backupPharmacySelection({ ...order, excludePharmacies: [selected.id] });
    }
  }

  return selected;
};

const calculateBackupScore = (pharmacy: BackupPharmacy, order: Order): number => {
  let score = 0;

  score += (100 - pharmacy.capacity.currentUtilization);

  score += pharmacy.performance.onTimeRate * 20;
  score += pharmacy.performance.qualityScore * 20;

  if (pharmacy.location.region === order.shippingAddress.region) {
    score += 15;
  }

  if (pharmacy.integration.method === 'api') {
    score += 10;
  }

  if (pharmacy.sla.maxTurnaroundHours <= 24) {
    score += 10;
  }

  return score;
};

const transferOrderToBackup = async (orderId: string, backupPharmacyId: string): Promise<TransferResult> => {
  const order = await getOrder(orderId);
  const backup = await getBackupPharmacy(backupPharmacyId);

  await updateOrderStatus(orderId, 'transferring_to_backup');

  let transferSuccess = false;

  if (backup.integration.method === 'api') {
    const response = await sendOrderToBackupApi(backup, order);
    transferSuccess = response.accepted;
  } else if (backup.integration.method === 'sftp') {
    await generateAndUploadOrderFile(backup, order);
    transferSuccess = true;
  }

  if (transferSuccess) {
    await updateOrder(orderId, {
      status: 'transferred_to_backup',
      fulfillingPharmacy: backupPharmacyId,
      transferredAt: new Date().toISOString()
    });

    await notifyPatientOfTransfer(order.patientId, orderId, backup.name);
  }

  return {
    orderId,
    backupPharmacyId,
    success: transferSuccess,
    transferredAt: new Date().toISOString()
  };
};
```

---

## Incident Response & On-Call System

Centralized incident management with on-call rotation, escalation, runbooks, and post-incident review.

### Incident Response Architecture

```typescript
interface IncidentManagementSystem {
  detectIncident: (signal: IncidentSignal) => Promise<Incident>;
  escalateIncident: (incidentId: string, level: number) => Promise<void>;
  coordinateResponse: (incidentId: string) => Promise<ResponseCoordination>;
  resolveIncident: (incidentId: string, resolution: Resolution) => Promise<void>;
  conductPostmortem: (incidentId: string) => Promise<Postmortem>;
}

interface Incident {
  id: string;
  incidentNumber: string;

  title: string;
  description: string;

  severity: 'sev1' | 'sev2' | 'sev3' | 'sev4';
  priority: 'critical' | 'high' | 'medium' | 'low';

  status: 'detected' | 'acknowledged' | 'investigating' | 'identified' | 'mitigating' | 'monitoring' | 'resolved' | 'closed';

  type: 'outage' | 'degradation' | 'security' | 'data_integrity' | 'compliance' | 'patient_safety';

  affectedSystems: string[];
  affectedCustomers: {
    estimated: number;
    segments: string[];
  };

  detection: {
    source: 'monitoring' | 'customer_report' | 'internal_report' | 'vendor_notification' | 'automated_alert';
    detectedAt: string;
    detectedBy: string;
    alertId?: string;
  };

  response: {
    acknowledgedAt?: string;
    acknowledgedBy?: string;
    incidentCommander?: string;
    responders: Responder[];
    communicationsLead?: string;
  };

  timeline: IncidentEvent[];

  impact: {
    businessImpact: string;
    customerImpact: string;
    financialImpact?: number;
    reputationalImpact: 'low' | 'medium' | 'high';
  };

  rootCause?: {
    summary: string;
    category: 'infrastructure' | 'code_change' | 'configuration' | 'external_dependency' | 'capacity' | 'human_error' | 'security' | 'unknown';
    details: string;
  };

  resolution?: {
    summary: string;
    resolvedAt: string;
    resolvedBy: string;
    timeToDetect: number;
    timeToAcknowledge: number;
    timeToMitigate: number;
    timeToResolve: number;
  };

  followUp: {
    postmortemRequired: boolean;
    postmortemId?: string;
    actionItems: ActionItem[];
  };

  communications: IncidentCommunication[];

  createdAt: string;
  updatedAt: string;
}

interface Responder {
  userId: string;
  name: string;
  role: 'incident_commander' | 'technical_lead' | 'communications' | 'subject_matter_expert' | 'scribe';
  joinedAt: string;
  leftAt?: string;
}

interface IncidentEvent {
  id: string;
  timestamp: string;
  type: 'status_change' | 'responder_joined' | 'action_taken' | 'communication_sent' | 'escalation' | 'note';
  actor: string;
  description: string;
  metadata?: Record<string, unknown>;
}

const severityMatrix: Record<string, SeverityDefinition> = {
  sev1: {
    name: 'Critical',
    description: 'Complete service outage or patient safety issue',
    responseTime: 5,
    escalationTime: 15,
    updateFrequency: 15,
    stakeholderNotification: true,
    executiveNotification: true,
    examples: ['Platform completely down', 'Data breach confirmed', 'Wrong medication dispensed', 'PHI exposure']
  },
  sev2: {
    name: 'High',
    description: 'Major feature unavailable or significant degradation',
    responseTime: 15,
    escalationTime: 30,
    updateFrequency: 30,
    stakeholderNotification: true,
    executiveNotification: false,
    examples: ['Payments failing', 'Video visits down', 'Pharmacy integration broken', '>50% error rate']
  },
  sev3: {
    name: 'Medium',
    description: 'Minor feature unavailable or limited impact',
    responseTime: 60,
    escalationTime: 120,
    updateFrequency: 60,
    stakeholderNotification: false,
    executiveNotification: false,
    examples: ['Single integration down', 'Slow performance', 'Batch job failure', 'Non-critical feature broken']
  },
  sev4: {
    name: 'Low',
    description: 'Cosmetic issue or minimal customer impact',
    responseTime: 240,
    escalationTime: 480,
    updateFrequency: 240,
    stakeholderNotification: false,
    executiveNotification: false,
    examples: ['UI bug', 'Documentation error', 'Minor logging issue']
  }
};
```

### On-Call Rotation Management

```typescript
interface OnCallSystem {
  schedules: OnCallSchedule[];
  escalationPolicies: EscalationPolicy[];
  overrides: OnCallOverride[];
}

interface OnCallSchedule {
  id: string;
  name: string;
  team: string;

  rotation: {
    type: 'weekly' | 'daily' | 'custom';
    handoffTime: string;
    handoffTimezone: string;
    participants: OnCallParticipant[];
  };

  layers: {
    name: string;
    order: number;
    participants: string[];
    rotationType: 'round_robin' | 'random' | 'custom';
  }[];

  restrictions?: {
    timeOfDay?: { start: string; end: string };
    daysOfWeek?: number[];
  };
}

interface OnCallParticipant {
  userId: string;
  name: string;
  email: string;
  phone: string;
  notificationPreferences: {
    channels: ('push' | 'sms' | 'phone' | 'email')[];
    escalationDelay: number;
  };
}

interface EscalationPolicy {
  id: string;
  name: string;
  description: string;

  steps: EscalationStep[];

  repeatPolicy: {
    enabled: boolean;
    maxRepeats: number;
    repeatAfterMinutes: number;
  };
}

interface EscalationStep {
  order: number;
  delayMinutes: number;

  targets: {
    type: 'schedule' | 'user' | 'team';
    id: string;
  }[];

  notificationChannels: ('push' | 'sms' | 'phone' | 'email')[];
}

interface OnCallOverride {
  id: string;
  scheduleId: string;
  originalUserId: string;
  replacementUserId: string;
  startTime: string;
  endTime: string;
  reason: string;
  createdBy: string;
}

const escalationPolicies: EscalationPolicy[] = [
  {
    id: 'platform-critical',
    name: 'Platform Critical',
    description: 'For SEV1 incidents affecting core platform',
    steps: [
      { order: 1, delayMinutes: 0, targets: [{ type: 'schedule', id: 'platform-oncall-primary' }], notificationChannels: ['push', 'sms', 'phone'] },
      { order: 2, delayMinutes: 5, targets: [{ type: 'schedule', id: 'platform-oncall-secondary' }], notificationChannels: ['push', 'sms', 'phone'] },
      { order: 3, delayMinutes: 10, targets: [{ type: 'user', id: 'engineering-manager' }], notificationChannels: ['phone'] },
      { order: 4, delayMinutes: 15, targets: [{ type: 'user', id: 'vp-engineering' }], notificationChannels: ['phone'] }
    ],
    repeatPolicy: { enabled: true, maxRepeats: 3, repeatAfterMinutes: 15 }
  },
  {
    id: 'pharmacy-operations',
    name: 'Pharmacy Operations',
    description: 'For pharmacy system incidents',
    steps: [
      { order: 1, delayMinutes: 0, targets: [{ type: 'schedule', id: 'pharmacy-oncall' }], notificationChannels: ['push', 'sms'] },
      { order: 2, delayMinutes: 10, targets: [{ type: 'user', id: 'pharmacy-director' }], notificationChannels: ['phone'] }
    ],
    repeatPolicy: { enabled: true, maxRepeats: 2, repeatAfterMinutes: 20 }
  }
];
```

### Runbook Management

```typescript
interface Runbook {
  id: string;
  slug: string;
  title: string;

  category: 'incident_response' | 'maintenance' | 'deployment' | 'recovery' | 'security';

  metadata: {
    owner: string;
    lastReviewedAt: string;
    lastUsedAt?: string;
    usageCount: number;
    averageExecutionTime?: number;
  };

  applicability: {
    systems: string[];
    incidentTypes: string[];
    severities: string[];
  };

  steps: RunbookStep[];

  relatedRunbooks: string[];
  relatedDocumentation: string[];

  version: string;
  status: 'draft' | 'published' | 'deprecated';

  createdAt: string;
  updatedAt: string;
}

interface RunbookStep {
  order: number;
  title: string;
  description: string;

  type: 'manual' | 'automated' | 'decision' | 'verification';

  instructions: string;

  automationConfig?: {
    scriptUrl: string;
    parameters: Record<string, string>;
    requiresApproval: boolean;
  };

  decisionTree?: {
    question: string;
    options: { answer: string; nextStep: number }[];
  };

  verification?: {
    criteria: string;
    expectedOutcome: string;
  };

  estimatedDuration: number;
  requiresEscalation: boolean;
  rollbackStep?: number;
}

const criticalRunbooks: Runbook[] = [
  {
    id: 'database-failover',
    slug: 'database-failover',
    title: 'Database Failover Procedure',
    category: 'recovery',
    metadata: { owner: 'platform-team', lastReviewedAt: '2024-01-15', usageCount: 0 },
    applicability: { systems: ['postgresql', 'rds'], incidentTypes: ['outage'], severities: ['sev1', 'sev2'] },
    steps: [
      { order: 1, title: 'Verify primary database status', type: 'verification', description: 'Check if primary is truly unavailable', instructions: 'Run health check against primary endpoint', verification: { criteria: 'Health check fails 3 consecutive times', expectedOutcome: 'Confirmed primary unavailable' }, estimatedDuration: 2, requiresEscalation: false },
      { order: 2, title: 'Notify stakeholders', type: 'manual', description: 'Send initial notification', instructions: 'Post in #incidents channel and update status page', estimatedDuration: 2, requiresEscalation: false },
      { order: 3, title: 'Initiate failover', type: 'automated', description: 'Promote replica to primary', instructions: 'Execute failover script', automationConfig: { scriptUrl: '/scripts/db-failover.sh', parameters: { target: 'replica-1' }, requiresApproval: true }, estimatedDuration: 5, requiresEscalation: true },
      { order: 4, title: 'Verify application connectivity', type: 'verification', description: 'Confirm apps connected to new primary', instructions: 'Check connection pool metrics', verification: { criteria: 'All services reporting healthy DB connections', expectedOutcome: 'Green health checks' }, estimatedDuration: 5, requiresEscalation: false },
      { order: 5, title: 'Update DNS/configuration', type: 'manual', description: 'Point to new primary', instructions: 'Update connection strings if needed', estimatedDuration: 5, requiresEscalation: false }
    ],
    relatedRunbooks: ['database-restore', 'connection-pool-reset'],
    relatedDocumentation: ['/docs/database-architecture', '/docs/rds-configuration'],
    version: '2.1',
    status: 'published',
    createdAt: '2023-06-01',
    updatedAt: '2024-01-15'
  }
];
```

### Post-Incident Review (Postmortem)

```typescript
interface Postmortem {
  id: string;
  incidentId: string;

  title: string;
  status: 'draft' | 'in_review' | 'published';

  summary: {
    incidentSummary: string;
    impact: string;
    duration: string;
    detection: string;
    resolution: string;
  };

  timeline: {
    timestamp: string;
    event: string;
    actor?: string;
  }[];

  rootCauseAnalysis: {
    method: 'five_whys' | 'fishbone' | 'fault_tree';
    analysis: string;
    rootCauses: string[];
    contributingFactors: string[];
  };

  lessonsLearned: {
    whatWentWell: string[];
    whatWentPoorly: string[];
    whereWeGotLucky: string[];
  };

  actionItems: {
    id: string;
    title: string;
    description: string;
    priority: 'p0' | 'p1' | 'p2' | 'p3';
    owner: string;
    dueDate: string;
    status: 'open' | 'in_progress' | 'completed';
    jiraTicket?: string;
  }[];

  metrics: {
    timeToDetect: number;
    timeToAcknowledge: number;
    timeToMitigate: number;
    timeToResolve: number;
    customerTickets: number;
    revenueImpact?: number;
  };

  reviewers: {
    userId: string;
    reviewedAt?: string;
    approved: boolean;
    comments?: string;
  }[];

  publishedAt?: string;
  createdAt: string;
  updatedAt: string;
}

const postmortemTemplate = {
  blameless: true,
  requiredSections: ['summary', 'timeline', 'root_cause', 'lessons_learned', 'action_items'],
  reviewRequired: true,
  minReviewers: 2,
  publishDeadlineDays: 5,
  actionItemTracking: true
};
```

### Incident Communication Templates

```typescript
interface IncidentCommunication {
  id: string;
  incidentId: string;

  type: 'internal_slack' | 'status_page' | 'customer_email' | 'executive_update' | 'support_team';

  audience: string;
  subject?: string;
  content: string;

  sentAt: string;
  sentBy: string;

  template?: string;
}

const communicationTemplates = {
  initial_internal: {
    channel: 'slack',
    template: `🚨 **Incident Declared: {{title}}**
Severity: {{severity}}
Status: Investigating
Affected: {{affected_systems}}
IC: {{incident_commander}}

Join war room: {{war_room_link}}`
  },

  status_page_investigating: {
    channel: 'status_page',
    template: `We are currently investigating reports of {{issue_description}}. We will provide updates as we learn more.`
  },

  status_page_identified: {
    channel: 'status_page',
    template: `We have identified the cause of {{issue_description}}. Our team is working on a fix. We expect to have this resolved within {{eta}}.`
  },

  status_page_resolved: {
    channel: 'status_page',
    template: `The issue affecting {{affected_services}} has been resolved. All services are now operating normally. We apologize for any inconvenience.`
  },

  executive_update: {
    channel: 'email',
    template: `Subject: [{{severity}}] Incident Update: {{title}}

Current Status: {{status}}
Duration: {{duration}}
Customer Impact: {{customer_impact}}
Business Impact: {{business_impact}}

Summary: {{summary}}

Next Update: {{next_update_time}}`
  }
};
```

---

## Unified Audit Logging

Centralized, immutable audit trail for all system actions with compliance-ready querying and retention.

### Audit Logging Architecture

```typescript
interface AuditLoggingSystem {
  logEvent: (event: AuditEvent) => Promise<void>;
  queryLogs: (query: AuditQuery) => Promise<AuditQueryResult>;
  exportLogs: (exportRequest: AuditExportRequest) => Promise<ExportJob>;
  verifyIntegrity: (dateRange: DateRange) => Promise<IntegrityReport>;
}

interface AuditEvent {
  id: string;
  timestamp: string;

  eventType: AuditEventType;
  eventCategory: 'authentication' | 'authorization' | 'data_access' | 'data_modification' | 'admin_action' | 'system_event' | 'compliance';

  actor: {
    type: 'user' | 'service' | 'system' | 'external';
    id: string;
    name?: string;
    email?: string;
    role?: string;
    ipAddress?: string;
    userAgent?: string;
    sessionId?: string;
  };

  target: {
    type: string;
    id: string;
    name?: string;
    attributes?: Record<string, unknown>;
  };

  action: {
    name: string;
    method?: string;
    endpoint?: string;
    parameters?: Record<string, unknown>;
  };

  result: {
    status: 'success' | 'failure' | 'partial';
    errorCode?: string;
    errorMessage?: string;
  };

  context: {
    service: string;
    environment: string;
    version: string;
    traceId?: string;
    spanId?: string;
    correlationId?: string;
  };

  metadata: {
    phiAccessed: boolean;
    piiAccessed: boolean;
    sensitivityLevel: 'public' | 'internal' | 'confidential' | 'restricted';
    justification?: string;
    breakGlass?: boolean;
  };

  changes?: {
    before: Record<string, unknown>;
    after: Record<string, unknown>;
    diff: string[];
  };

  hash: string;
  previousHash: string;
}

type AuditEventType =
  | 'user.login'
  | 'user.logout'
  | 'user.login_failed'
  | 'user.password_changed'
  | 'user.mfa_enabled'
  | 'user.created'
  | 'user.updated'
  | 'user.deleted'
  | 'patient.record_viewed'
  | 'patient.record_updated'
  | 'patient.record_exported'
  | 'patient.consent_updated'
  | 'prescription.created'
  | 'prescription.modified'
  | 'prescription.cancelled'
  | 'order.placed'
  | 'order.modified'
  | 'order.cancelled'
  | 'payment.processed'
  | 'payment.refunded'
  | 'admin.role_assigned'
  | 'admin.permission_changed'
  | 'admin.config_changed'
  | 'admin.user_impersonated'
  | 'system.backup_completed'
  | 'system.restore_initiated'
  | 'compliance.report_generated'
  | 'compliance.audit_accessed';

interface AuditLogStorage {
  primary: {
    type: 'postgresql' | 'elasticsearch';
    retentionDays: number;
    indexing: string[];
  };

  archive: {
    type: 's3' | 'glacier';
    retentionYears: number;
    encryption: 'AES-256';
    immutable: boolean;
  };

  realtime: {
    type: 'kafka' | 'kinesis';
    consumers: string[];
  };
}

const auditStorageConfig: AuditLogStorage = {
  primary: {
    type: 'elasticsearch',
    retentionDays: 90,
    indexing: ['actor.id', 'target.type', 'target.id', 'eventType', 'timestamp', 'metadata.phiAccessed']
  },
  archive: {
    type: 's3',
    retentionYears: 7,
    encryption: 'AES-256',
    immutable: true
  },
  realtime: {
    type: 'kafka',
    consumers: ['siem', 'compliance-monitor', 'alerting']
  }
};
```

### PHI Access Logging (HIPAA)

```typescript
interface PHIAccessLog {
  id: string;
  timestamp: string;

  accessor: {
    userId: string;
    userType: 'patient' | 'provider' | 'admin' | 'support' | 'system';
    role: string;
    department?: string;
  };

  patient: {
    patientId: string;
    mrn?: string;
  };

  access: {
    type: 'view' | 'create' | 'update' | 'delete' | 'export' | 'print';
    recordTypes: string[];
    accessReason: string;
    accessJustification?: string;
  };

  context: {
    appointmentId?: string;
    orderId?: string;
    supportTicketId?: string;
    breakGlassReason?: string;
  };

  dataElements: {
    category: string;
    elements: string[];
    sensitivity: 'standard' | 'sensitive' | 'highly_sensitive';
  }[];

  disclosure?: {
    isDisclosure: boolean;
    recipientType?: string;
    recipientName?: string;
    purpose?: string;
    authorizationId?: string;
  };
}

const phiAccessCategories = {
  standard: ['demographics', 'appointments', 'medications', 'allergies', 'vitals'],
  sensitive: ['diagnoses', 'lab_results', 'provider_notes', 'treatment_plans'],
  highly_sensitive: ['mental_health', 'substance_abuse', 'hiv_status', 'genetic_data', 'reproductive_health']
};

const generateAccountingOfDisclosures = async (patientId: string, dateRange: DateRange): Promise<DisclosureReport> => {
  const disclosures = await queryPHIAccessLogs({
    patientId,
    dateRange,
    filters: { 'disclosure.isDisclosure': true }
  });

  return {
    patientId,
    reportDate: new Date().toISOString(),
    dateRange,
    disclosures: disclosures.map(d => ({
      date: d.timestamp,
      recipientName: d.disclosure.recipientName,
      recipientType: d.disclosure.recipientType,
      purpose: d.disclosure.purpose,
      dataDisclosed: d.dataElements.flatMap(de => de.elements)
    })),
    totalDisclosures: disclosures.length
  };
};
```

### Audit Log Integrity

```typescript
interface AuditIntegrity {
  verifyChain: (startDate: Date, endDate: Date) => Promise<ChainVerificationResult>;
  detectTampering: () => Promise<TamperingReport>;
  generateProof: (eventId: string) => Promise<IntegrityProof>;
}

interface ChainVerificationResult {
  verified: boolean;
  eventsChecked: number;
  brokenLinks: {
    eventId: string;
    expectedHash: string;
    actualHash: string;
    timestamp: string;
  }[];
  verificationTime: number;
}

const createAuditEvent = async (event: Omit<AuditEvent, 'id' | 'hash' | 'previousHash'>): Promise<AuditEvent> => {
  const lastEvent = await getLastAuditEvent();

  const eventWithChain: AuditEvent = {
    ...event,
    id: generateUUID(),
    previousHash: lastEvent?.hash || 'GENESIS',
    hash: ''
  };

  eventWithChain.hash = computeHash(eventWithChain);

  await writeToAuditLog(eventWithChain);
  await publishToStream(eventWithChain);

  return eventWithChain;
};

const computeHash = (event: AuditEvent): string => {
  const hashInput = JSON.stringify({
    id: event.id,
    timestamp: event.timestamp,
    eventType: event.eventType,
    actor: event.actor,
    target: event.target,
    action: event.action,
    result: event.result,
    previousHash: event.previousHash
  });

  return crypto.createHash('sha256').update(hashInput).digest('hex');
};
```

### Audit Query & Reporting

```typescript
interface AuditQuery {
  dateRange: { start: string; end: string };

  filters: {
    eventTypes?: AuditEventType[];
    actorIds?: string[];
    actorTypes?: string[];
    targetTypes?: string[];
    targetIds?: string[];
    resultStatus?: ('success' | 'failure')[];
    phiAccessed?: boolean;
    breakGlass?: boolean;
  };

  search?: {
    query: string;
    fields: string[];
  };

  pagination: {
    page: number;
    pageSize: number;
  };

  sort: {
    field: string;
    order: 'asc' | 'desc';
  };
}

interface ComplianceReport {
  reportType: 'hipaa_access' | 'admin_actions' | 'security_events' | 'data_exports' | 'failed_logins';
  dateRange: DateRange;
  generatedAt: string;
  generatedBy: string;

  summary: {
    totalEvents: number;
    uniqueUsers: number;
    uniquePatients?: number;
    flaggedEvents: number;
  };

  details: AuditEvent[];

  anomalies?: {
    type: string;
    description: string;
    events: string[];
    severity: 'low' | 'medium' | 'high';
  }[];
}

const complianceReportTemplates = {
  hipaa_access: {
    name: 'HIPAA PHI Access Report',
    filters: { phiAccessed: true },
    groupBy: ['accessor.userId', 'patient.patientId'],
    schedule: 'monthly'
  },
  admin_actions: {
    name: 'Administrative Actions Report',
    filters: { eventCategory: 'admin_action' },
    groupBy: ['actor.userId', 'action.name'],
    schedule: 'weekly'
  },
  security_events: {
    name: 'Security Events Report',
    filters: { eventTypes: ['user.login_failed', 'admin.permission_changed', 'admin.user_impersonated'] },
    groupBy: ['eventType', 'result.status'],
    schedule: 'daily'
  },
  failed_logins: {
    name: 'Failed Login Attempts',
    filters: { eventTypes: ['user.login_failed'] },
    groupBy: ['actor.ipAddress', 'actor.email'],
    schedule: 'daily',
    alertThreshold: 5
  }
};
```

---

## Security Monitoring (SIEM)

Security Information and Event Management for threat detection, investigation, and compliance.

### SIEM Architecture

```typescript
interface SIEMSystem {
  ingestEvents: (events: SecurityEvent[]) => Promise<void>;
  correlateEvents: (timeWindow: number) => Promise<Correlation[]>;
  detectThreats: () => Promise<ThreatAlert[]>;
  investigateAlert: (alertId: string) => Promise<Investigation>;
  generateReport: (reportType: string, dateRange: DateRange) => Promise<SecurityReport>;
}

interface SecurityEvent {
  id: string;
  timestamp: string;
  receivedAt: string;

  source: {
    type: 'application' | 'infrastructure' | 'network' | 'endpoint' | 'cloud' | 'identity';
    name: string;
    host: string;
    ip?: string;
  };

  eventType: string;
  severity: 'info' | 'low' | 'medium' | 'high' | 'critical';

  data: {
    action: string;
    outcome: 'success' | 'failure' | 'unknown';
    user?: string;
    sourceIp?: string;
    destinationIp?: string;
    protocol?: string;
    port?: number;
    url?: string;
    method?: string;
    statusCode?: number;
    bytesIn?: number;
    bytesOut?: number;
    process?: string;
    command?: string;
    filePath?: string;
    fileHash?: string;
  };

  normalized: {
    category: SecurityEventCategory;
    subcategory: string;
    outcome: 'success' | 'failure' | 'unknown';
  };

  enrichment?: {
    geoLocation?: { country: string; city: string; lat: number; lon: number };
    threatIntel?: { isMalicious: boolean; threatType: string; confidence: number };
    assetInfo?: { assetType: string; criticality: string; owner: string };
    userInfo?: { department: string; role: string; riskScore: number };
  };

  tags: string[];
}

type SecurityEventCategory =
  | 'authentication'
  | 'authorization'
  | 'network'
  | 'file'
  | 'process'
  | 'registry'
  | 'database'
  | 'web'
  | 'email'
  | 'cloud'
  | 'malware'
  | 'vulnerability';

interface ThreatAlert {
  id: string;
  timestamp: string;

  name: string;
  description: string;

  severity: 'low' | 'medium' | 'high' | 'critical';
  confidence: number;

  category: 'intrusion' | 'malware' | 'data_exfiltration' | 'insider_threat' | 'credential_compromise' | 'policy_violation' | 'anomaly';

  mitreTactics?: string[];
  mitreTechniques?: string[];

  affectedAssets: {
    type: string;
    id: string;
    name: string;
    criticality: string;
  }[];

  indicators: {
    type: 'ip' | 'domain' | 'url' | 'hash' | 'email' | 'user' | 'file';
    value: string;
    context: string;
  }[];

  relatedEvents: string[];
  correlationRule: string;

  status: 'new' | 'investigating' | 'confirmed' | 'false_positive' | 'resolved';

  assignee?: string;
  resolution?: {
    action: string;
    notes: string;
    resolvedAt: string;
    resolvedBy: string;
  };
}
```

### Detection Rules

```typescript
interface DetectionRule {
  id: string;
  name: string;
  description: string;

  enabled: boolean;
  severity: 'low' | 'medium' | 'high' | 'critical';

  type: 'threshold' | 'correlation' | 'anomaly' | 'pattern' | 'threat_intel';

  logic: {
    query: string;
    aggregation?: { field: string; function: 'count' | 'sum' | 'avg' | 'max' | 'min' };
    threshold?: { operator: 'gt' | 'lt' | 'eq' | 'gte' | 'lte'; value: number };
    timeWindow: number;
    groupBy?: string[];
  };

  correlation?: {
    events: { name: string; query: string }[];
    sequence: boolean;
    maxSpan: number;
  };

  mitre?: {
    tactics: string[];
    techniques: string[];
  };

  response: {
    alertSeverity: string;
    notifyChannels: string[];
    autoContainment?: boolean;
    playbookId?: string;
  };

  exceptions: {
    field: string;
    values: string[];
    reason: string;
  }[];

  lastTriggered?: string;
  triggerCount: number;
  falsePositiveRate?: number;
}

const detectionRules: DetectionRule[] = [
  {
    id: 'brute-force-login',
    name: 'Brute Force Login Attempt',
    description: 'Multiple failed login attempts from single IP',
    enabled: true,
    severity: 'high',
    type: 'threshold',
    logic: {
      query: 'eventType:user.login_failed',
      aggregation: { field: 'actor.ipAddress', function: 'count' },
      threshold: { operator: 'gte', value: 10 },
      timeWindow: 300,
      groupBy: ['actor.ipAddress']
    },
    mitre: { tactics: ['TA0006'], techniques: ['T1110'] },
    response: {
      alertSeverity: 'high',
      notifyChannels: ['security-alerts'],
      autoContainment: true,
      playbookId: 'block-ip'
    },
    exceptions: [],
    triggerCount: 0
  },
  {
    id: 'impossible-travel',
    name: 'Impossible Travel Detection',
    description: 'User logged in from geographically distant locations',
    enabled: true,
    severity: 'high',
    type: 'correlation',
    logic: {
      query: 'eventType:user.login AND result.status:success',
      timeWindow: 3600
    },
    correlation: {
      events: [
        { name: 'login1', query: 'eventType:user.login' },
        { name: 'login2', query: 'eventType:user.login' }
      ],
      sequence: true,
      maxSpan: 3600
    },
    mitre: { tactics: ['TA0001'], techniques: ['T1078'] },
    response: {
      alertSeverity: 'high',
      notifyChannels: ['security-alerts'],
      autoContainment: false
    },
    exceptions: [{ field: 'actor.id', values: ['service-accounts'], reason: 'Service accounts use VPN' }],
    triggerCount: 0
  },
  {
    id: 'mass-phi-access',
    name: 'Mass PHI Record Access',
    description: 'User accessing unusually high number of patient records',
    enabled: true,
    severity: 'critical',
    type: 'anomaly',
    logic: {
      query: 'eventType:patient.record_viewed',
      aggregation: { field: 'target.id', function: 'count' },
      threshold: { operator: 'gte', value: 50 },
      timeWindow: 3600,
      groupBy: ['actor.id']
    },
    mitre: { tactics: ['TA0009'], techniques: ['T1530'] },
    response: {
      alertSeverity: 'critical',
      notifyChannels: ['security-alerts', 'compliance-team'],
      autoContainment: true,
      playbookId: 'suspend-user'
    },
    exceptions: [{ field: 'actor.role', values: ['data_analyst', 'compliance_officer'], reason: 'Authorized bulk access roles' }],
    triggerCount: 0
  },
  {
    id: 'after-hours-admin',
    name: 'After Hours Admin Activity',
    description: 'Administrative actions outside business hours',
    enabled: true,
    severity: 'medium',
    type: 'pattern',
    logic: {
      query: 'eventCategory:admin_action AND NOT (hour >= 8 AND hour <= 18)',
      timeWindow: 60
    },
    response: {
      alertSeverity: 'medium',
      notifyChannels: ['security-alerts']
    },
    exceptions: [{ field: 'actor.id', values: ['oncall-admins'], reason: 'On-call authorized' }],
    triggerCount: 0
  }
];
```

### Threat Intelligence Integration

```typescript
interface ThreatIntelligence {
  feeds: ThreatFeed[];
  lookupIndicator: (indicator: Indicator) => Promise<ThreatMatch[]>;
  enrichEvent: (event: SecurityEvent) => Promise<SecurityEvent>;
}

interface ThreatFeed {
  id: string;
  name: string;
  provider: string;
  type: 'ip' | 'domain' | 'url' | 'hash' | 'email';
  updateFrequency: number;
  confidence: number;
  enabled: boolean;
  lastUpdated: string;
  indicatorCount: number;
}

interface ThreatMatch {
  feedId: string;
  feedName: string;
  indicatorType: string;
  indicatorValue: string;
  threatType: string;
  confidence: number;
  firstSeen: string;
  lastSeen: string;
  references: string[];
}

const threatFeeds: ThreatFeed[] = [
  { id: 'abuse-ch', name: 'Abuse.ch', provider: 'abuse.ch', type: 'ip', updateFrequency: 3600, confidence: 0.85, enabled: true, lastUpdated: '', indicatorCount: 0 },
  { id: 'alienvault-otx', name: 'AlienVault OTX', provider: 'alienvault', type: 'ip', updateFrequency: 3600, confidence: 0.8, enabled: true, lastUpdated: '', indicatorCount: 0 },
  { id: 'emerging-threats', name: 'Emerging Threats', provider: 'proofpoint', type: 'ip', updateFrequency: 86400, confidence: 0.9, enabled: true, lastUpdated: '', indicatorCount: 0 }
];
```

### Vulnerability Management

```typescript
interface VulnerabilityManagement {
  scanAssets: (scope: ScanScope) => Promise<ScanJob>;
  getVulnerabilities: (filters: VulnFilters) => Promise<Vulnerability[]>;
  trackRemediation: (vulnId: string) => Promise<RemediationStatus>;
  generateReport: (reportType: string) => Promise<VulnReport>;
}

interface Vulnerability {
  id: string;

  asset: {
    type: 'server' | 'container' | 'application' | 'database' | 'network_device';
    id: string;
    name: string;
    environment: string;
    criticality: 'critical' | 'high' | 'medium' | 'low';
  };

  vulnerability: {
    cveId?: string;
    title: string;
    description: string;
    severity: 'critical' | 'high' | 'medium' | 'low' | 'informational';
    cvssScore?: number;
    cvssVector?: string;
  };

  detection: {
    scannerId: string;
    scanType: 'network' | 'agent' | 'container' | 'sast' | 'dast';
    firstDetected: string;
    lastDetected: string;
    scanCount: number;
  };

  remediation: {
    status: 'new' | 'acknowledged' | 'in_progress' | 'mitigated' | 'remediated' | 'accepted_risk' | 'false_positive';
    owner?: string;
    dueDate?: string;
    solution?: string;
    notes?: string;
  };

  riskScore: number;
  exploitAvailable: boolean;
  patchAvailable: boolean;
}

const vulnerabilitySLAs = {
  critical: { remediationDays: 7, escalationDays: 3 },
  high: { remediationDays: 30, escalationDays: 14 },
  medium: { remediationDays: 90, escalationDays: 45 },
  low: { remediationDays: 180, escalationDays: 90 }
};
```

---

## Vendor Management System

Centralized vendor governance including onboarding, contracts, risk assessment, and performance tracking.

### Vendor Management Architecture

```typescript
interface VendorManagementSystem {
  onboardVendor: (application: VendorApplication) => Promise<Vendor>;
  assessRisk: (vendorId: string) => Promise<RiskAssessment>;
  trackPerformance: (vendorId: string) => Promise<PerformanceMetrics>;
  manageContracts: (vendorId: string) => Promise<ContractPortfolio>;
  conductReview: (vendorId: string, reviewType: string) => Promise<VendorReview>;
}

interface Vendor {
  id: string;
  vendorNumber: string;

  profile: {
    legalName: string;
    dba?: string;
    website: string;
    industry: string;
    companySize: 'startup' | 'small' | 'medium' | 'large' | 'enterprise';
    yearFounded: number;
    headquarters: Address;
  };

  contacts: {
    primary: VendorContact;
    technical?: VendorContact;
    billing?: VendorContact;
    security?: VendorContact;
    escalation?: VendorContact;
  };

  classification: {
    type: 'software' | 'service' | 'infrastructure' | 'professional_services' | 'hardware' | 'data_provider';
    category: string;
    subcategory: string;
    criticality: 'critical' | 'high' | 'medium' | 'low';
    dataAccess: 'none' | 'non_sensitive' | 'pii' | 'phi' | 'financial';
  };

  compliance: {
    baaRequired: boolean;
    baaExecuted: boolean;
    baaExpirationDate?: string;
    ndaRequired: boolean;
    ndaExecuted: boolean;
    certifications: VendorCertification[];
    lastSecurityReview: string;
    nextSecurityReview: string;
  };

  risk: {
    overallScore: number;
    riskLevel: 'low' | 'medium' | 'high' | 'critical';
    lastAssessment: string;
    openFindings: number;
  };

  financial: {
    paymentTerms: string;
    annualSpend: number;
    contractValue: number;
    budgetOwner: string;
  };

  performance: {
    overallScore: number;
    slaCompliance: number;
    incidentCount: number;
    lastReviewDate: string;
  };

  status: 'prospect' | 'onboarding' | 'active' | 'under_review' | 'suspended' | 'terminated';

  contracts: string[];
  relatedAssets: string[];

  createdAt: string;
  updatedAt: string;
}

interface VendorContact {
  name: string;
  title: string;
  email: string;
  phone: string;
  isPrimary: boolean;
}

interface VendorCertification {
  type: 'soc2_type1' | 'soc2_type2' | 'iso27001' | 'hipaa' | 'hitrust' | 'pci_dss' | 'fedramp' | 'gdpr';
  issueDate: string;
  expirationDate: string;
  certificateUrl?: string;
  verified: boolean;
  verifiedBy?: string;
  verifiedAt?: string;
}
```

### Vendor Risk Assessment

```typescript
interface RiskAssessment {
  id: string;
  vendorId: string;

  assessmentType: 'initial' | 'annual' | 'triggered' | 'continuous';
  assessmentDate: string;
  assessor: string;

  categories: {
    security: RiskCategory;
    privacy: RiskCategory;
    operational: RiskCategory;
    financial: RiskCategory;
    compliance: RiskCategory;
    reputational: RiskCategory;
  };

  questionnaire: {
    questionId: string;
    question: string;
    category: string;
    response: string;
    score: number;
    maxScore: number;
    evidence?: string;
    notes?: string;
  }[];

  findings: {
    id: string;
    category: string;
    severity: 'critical' | 'high' | 'medium' | 'low';
    finding: string;
    recommendation: string;
    status: 'open' | 'acknowledged' | 'remediated' | 'accepted';
    dueDate?: string;
    remediationEvidence?: string;
  }[];

  overallScore: number;
  riskLevel: 'low' | 'medium' | 'high' | 'critical';
  recommendation: 'approve' | 'approve_with_conditions' | 'reject' | 'reassess';

  approvals: {
    role: string;
    name: string;
    decision: 'approved' | 'rejected';
    comments?: string;
    decidedAt: string;
  }[];

  nextReviewDate: string;
}

interface RiskCategory {
  score: number;
  maxScore: number;
  riskLevel: 'low' | 'medium' | 'high' | 'critical';
  findings: number;
}

const vendorRiskQuestionnaire = {
  security: [
    { id: 'sec-1', question: 'Do you have a SOC 2 Type II report?', weight: 10, requiredForPHI: true },
    { id: 'sec-2', question: 'Do you perform annual penetration testing?', weight: 8, requiredForPHI: true },
    { id: 'sec-3', question: 'Do you have an incident response plan?', weight: 8, requiredForPHI: true },
    { id: 'sec-4', question: 'Is data encrypted at rest and in transit?', weight: 10, requiredForPHI: true },
    { id: 'sec-5', question: 'Do you have multi-factor authentication?', weight: 7, requiredForPHI: true }
  ],
  privacy: [
    { id: 'priv-1', question: 'Will you sign a Business Associate Agreement (BAA)?', weight: 10, requiredForPHI: true },
    { id: 'priv-2', question: 'Do you have a privacy policy?', weight: 5, requiredForPHI: true },
    { id: 'priv-3', question: 'Do you have data retention and deletion procedures?', weight: 7, requiredForPHI: true },
    { id: 'priv-4', question: 'Can you support data subject access requests?', weight: 6, requiredForPHI: false }
  ],
  operational: [
    { id: 'ops-1', question: 'Do you have a business continuity plan?', weight: 8, requiredForPHI: false },
    { id: 'ops-2', question: 'What is your guaranteed uptime SLA?', weight: 7, requiredForPHI: false },
    { id: 'ops-3', question: 'Do you have 24/7 support available?', weight: 5, requiredForPHI: false }
  ],
  financial: [
    { id: 'fin-1', question: 'Are you financially stable (no recent layoffs, funding issues)?', weight: 6, requiredForPHI: false },
    { id: 'fin-2', question: 'Do you have cyber insurance?', weight: 5, requiredForPHI: true }
  ]
};

const riskTiering = {
  critical: {
    criteria: ['PHI access', 'Critical system dependency', 'No alternative vendor'],
    reviewFrequency: 'quarterly',
    approvalLevel: 'executive',
    requiredCertifications: ['soc2_type2', 'hipaa']
  },
  high: {
    criteria: ['PII access', 'High system dependency'],
    reviewFrequency: 'semi-annual',
    approvalLevel: 'director',
    requiredCertifications: ['soc2_type2']
  },
  medium: {
    criteria: ['Internal data access', 'Moderate dependency'],
    reviewFrequency: 'annual',
    approvalLevel: 'manager',
    requiredCertifications: []
  },
  low: {
    criteria: ['No sensitive data', 'Easily replaceable'],
    reviewFrequency: 'biennial',
    approvalLevel: 'self-service',
    requiredCertifications: []
  }
};
```

### Vendor Performance Tracking

```typescript
interface VendorPerformance {
  vendorId: string;
  period: { start: string; end: string };

  slaMetrics: {
    metric: string;
    target: number;
    actual: number;
    unit: string;
    met: boolean;
  }[];

  incidents: {
    incidentId: string;
    date: string;
    severity: string;
    description: string;
    rootCause: string;
    resolution: string;
    resolutionTime: number;
  }[];

  tickets: {
    opened: number;
    resolved: number;
    averageResolutionTime: number;
    escalations: number;
    satisfaction: number;
  };

  financial: {
    invoicesReceived: number;
    invoicesPaid: number;
    averagePaymentTime: number;
    disputes: number;
    creditNotes: number;
  };

  relationship: {
    meetingsHeld: number;
    issuesRaised: number;
    issuesResolved: number;
    escalationsToManagement: number;
  };

  overallScore: number;
  trend: 'improving' | 'stable' | 'declining';
  recommendation: string;
}

const vendorScorecard = {
  weights: {
    slaCompliance: 0.3,
    incidentManagement: 0.25,
    supportQuality: 0.2,
    relationship: 0.15,
    financial: 0.1
  },
  thresholds: {
    excellent: 90,
    good: 75,
    acceptable: 60,
    poor: 0
  },
  actions: {
    excellent: 'Consider for preferred vendor status',
    good: 'Maintain current engagement',
    acceptable: 'Performance improvement plan recommended',
    poor: 'Escalate to management, consider alternatives'
  }
};
```

---

## Compliance Calendar & Tracking

Unified compliance management across HIPAA, DEA, FDA, State Boards, and other regulatory requirements.

### Compliance Management Architecture

```typescript
interface ComplianceManagementSystem {
  trackRequirements: () => Promise<ComplianceRequirement[]>;
  scheduleActivities: () => Promise<ComplianceActivity[]>;
  conductAudit: (auditType: string) => Promise<AuditResult>;
  generateEvidence: (requirementId: string) => Promise<EvidencePackage>;
  monitorCompliance: () => Promise<ComplianceStatus>;
}

interface ComplianceRequirement {
  id: string;
  code: string;
  name: string;

  regulation: {
    name: string;
    section: string;
    authority: 'federal' | 'state' | 'industry';
    jurisdiction: string[];
  };

  category: 'privacy' | 'security' | 'operational' | 'clinical' | 'financial' | 'environmental' | 'employment';

  description: string;
  fullText: string;
  guidance?: string;

  applicability: {
    entities: string[];
    conditions: string[];
  };

  controls: {
    controlId: string;
    description: string;
    type: 'preventive' | 'detective' | 'corrective';
    frequency: 'continuous' | 'daily' | 'weekly' | 'monthly' | 'quarterly' | 'annual';
    owner: string;
    evidence: string[];
  }[];

  assessment: {
    method: 'self_assessment' | 'internal_audit' | 'external_audit' | 'automated';
    frequency: string;
    lastAssessment?: string;
    nextAssessment: string;
  };

  status: 'compliant' | 'partially_compliant' | 'non_compliant' | 'not_assessed';
  riskLevel: 'low' | 'medium' | 'high' | 'critical';

  relatedRequirements: string[];
  documentationUrl: string;
}

const regulatoryFrameworks = {
  hipaa: {
    name: 'HIPAA',
    authority: 'HHS/OCR',
    categories: ['Privacy Rule', 'Security Rule', 'Breach Notification Rule'],
    auditFrequency: 'annual',
    penaltyRange: '$100 - $1.5M per violation'
  },
  hitech: {
    name: 'HITECH Act',
    authority: 'HHS/OCR',
    categories: ['Breach Notification', 'EHR Incentives', 'Enhanced Penalties'],
    auditFrequency: 'annual'
  },
  dea: {
    name: 'DEA Regulations',
    authority: 'DEA',
    categories: ['Controlled Substances Act', 'EPCS', 'Reporting'],
    auditFrequency: 'biennial'
  },
  fda: {
    name: 'FDA Regulations',
    authority: 'FDA',
    categories: ['503A Compounding', '503B Outsourcing', 'cGMP', 'Drug Quality'],
    auditFrequency: 'varies'
  },
  state_pharmacy: {
    name: 'State Pharmacy Board',
    authority: 'State',
    categories: ['Licensing', 'Compounding', 'Dispensing', 'PDMP'],
    auditFrequency: 'annual'
  },
  usp: {
    name: 'USP Standards',
    authority: 'USP',
    categories: ['USP 795', 'USP 797', 'USP 800', 'USP 825'],
    auditFrequency: 'continuous'
  }
};
```

### Compliance Calendar

```typescript
interface ComplianceCalendar {
  activities: ComplianceActivity[];
  deadlines: ComplianceDeadline[];
  reminders: ComplianceReminder[];
}

interface ComplianceActivity {
  id: string;
  requirementId: string;

  title: string;
  description: string;

  type: 'assessment' | 'training' | 'audit' | 'reporting' | 'renewal' | 'review' | 'certification';

  schedule: {
    frequency: 'one_time' | 'daily' | 'weekly' | 'monthly' | 'quarterly' | 'semi_annual' | 'annual' | 'biennial';
    dueDate: string;
    reminderDays: number[];
    allowableWindow?: number;
  };

  owner: string;
  participants: string[];

  status: 'upcoming' | 'in_progress' | 'completed' | 'overdue' | 'skipped';

  completion?: {
    completedAt: string;
    completedBy: string;
    evidence: string[];
    notes: string;
  };

  dependencies?: string[];
}

interface ComplianceDeadline {
  id: string;
  title: string;
  regulation: string;
  deadline: string;
  type: 'hard' | 'soft';
  consequences: string;
  status: 'upcoming' | 'approaching' | 'imminent' | 'overdue';
  daysRemaining: number;
  owner: string;
  activities: string[];
}

const complianceCalendarTemplate = {
  hipaa: {
    annual: [
      { title: 'HIPAA Risk Assessment', type: 'assessment', month: 1, duration: 30 },
      { title: 'Security Awareness Training', type: 'training', month: 2, duration: 30 },
      { title: 'Policy Review and Update', type: 'review', month: 3, duration: 14 },
      { title: 'Business Associate Agreement Review', type: 'review', month: 4, duration: 14 },
      { title: 'Access Control Review', type: 'audit', month: 6, duration: 7 },
      { title: 'Contingency Plan Testing', type: 'assessment', month: 9, duration: 7 },
      { title: 'PHI Inventory Update', type: 'review', month: 11, duration: 14 }
    ],
    quarterly: [
      { title: 'Security Incident Review', type: 'review' },
      { title: 'Audit Log Review', type: 'audit' }
    ],
    monthly: [
      { title: 'Access Termination Verification', type: 'audit' },
      { title: 'Patch Management Review', type: 'review' }
    ]
  },
  pharmacy: {
    annual: [
      { title: 'Pharmacy License Renewal', type: 'renewal', month: 'varies' },
      { title: 'Pharmacist License Verification', type: 'review', month: 1 },
      { title: 'Controlled Substance Inventory', type: 'audit', month: 6 },
      { title: 'USP 797 Competency Assessment', type: 'assessment', month: 3 },
      { title: 'Clean Room Certification', type: 'certification', month: 'varies' }
    ],
    monthly: [
      { title: 'Temperature Log Review', type: 'review' },
      { title: 'Expired Medication Check', type: 'audit' },
      { title: 'Equipment Calibration Check', type: 'review' }
    ]
  }
};
```

### Audit Management

```typescript
interface AuditManagement {
  planAudit: (auditPlan: AuditPlan) => Promise<Audit>;
  executeAudit: (auditId: string) => Promise<AuditExecution>;
  reportFindings: (auditId: string, findings: AuditFinding[]) => Promise<void>;
  trackRemediation: (findingId: string) => Promise<RemediationStatus>;
}

interface Audit {
  id: string;
  auditNumber: string;

  type: 'internal' | 'external' | 'regulatory' | 'certification';
  scope: string[];

  auditor: {
    type: 'internal' | 'external';
    name: string;
    organization?: string;
    credentials?: string[];
  };

  schedule: {
    plannedStart: string;
    plannedEnd: string;
    actualStart?: string;
    actualEnd?: string;
  };

  status: 'planned' | 'in_progress' | 'fieldwork_complete' | 'draft_report' | 'final_report' | 'closed';

  findings: AuditFinding[];

  report: {
    summary: string;
    overallRating: 'satisfactory' | 'needs_improvement' | 'unsatisfactory';
    reportUrl: string;
    issuedAt: string;
  };

  managementResponse?: {
    response: string;
    respondedBy: string;
    respondedAt: string;
  };
}

interface AuditFinding {
  id: string;
  auditId: string;

  findingNumber: string;
  title: string;
  description: string;

  requirement: string;
  regulation: string;

  severity: 'critical' | 'major' | 'minor' | 'observation';
  riskRating: 'high' | 'medium' | 'low';

  evidence: string[];

  recommendation: string;

  managementResponse: {
    accepted: boolean;
    response: string;
    actionPlan: string;
    owner: string;
    targetDate: string;
  };

  remediation: {
    status: 'open' | 'in_progress' | 'implemented' | 'verified' | 'closed';
    actions: {
      action: string;
      status: string;
      completedAt?: string;
      evidence?: string;
    }[];
    verifiedBy?: string;
    verifiedAt?: string;
    closedAt?: string;
  };

  createdAt: string;
  updatedAt: string;
}

const auditReadinessChecklist = {
  documentation: [
    'Policies and procedures current and approved',
    'Training records complete',
    'Risk assessments documented',
    'Incident logs available',
    'Change management records',
    'Vendor management documentation',
    'Business associate agreements'
  ],
  systems: [
    'Audit logging enabled',
    'Access controls configured',
    'Encryption verified',
    'Backup procedures tested',
    'Disaster recovery plan current'
  ],
  personnel: [
    'Key contacts identified',
    'Subject matter experts available',
    'Management available for interviews',
    'Audit liaison assigned'
  ]
};
```

---

## Disaster Recovery Architecture

Business continuity and disaster recovery planning with RTO/RPO targets and failover procedures.

### DR Architecture

```typescript
interface DisasterRecoverySystem {
  assessImpact: (scenario: DisasterScenario) => Promise<ImpactAssessment>;
  activateDR: (level: DRLevel) => Promise<ActivationResult>;
  failover: (component: string) => Promise<FailoverResult>;
  failback: (component: string) => Promise<FailbackResult>;
  testDR: (testPlan: DRTestPlan) => Promise<DRTestResult>;
}

interface DisasterRecoveryPlan {
  id: string;
  version: string;

  scope: {
    systems: SystemRecoveryProfile[];
    dataStores: DataRecoveryProfile[];
    thirdPartyServices: ThirdPartyRecoveryProfile[];
  };

  tiers: RecoveryTier[];

  scenarios: DisasterScenario[];

  procedures: RecoveryProcedure[];

  contacts: {
    drCoordinator: Contact;
    executiveSponsor: Contact;
    technicalLeads: Contact[];
    vendorContacts: Contact[];
    regulatoryContacts: Contact[];
  };

  communicationPlan: {
    internal: CommunicationPlan;
    external: CommunicationPlan;
    regulatory: CommunicationPlan;
  };

  lastTested: string;
  nextTest: string;
  lastUpdated: string;
  approvedBy: string;
}

interface SystemRecoveryProfile {
  systemId: string;
  systemName: string;
  description: string;

  criticality: 'critical' | 'high' | 'medium' | 'low';
  tier: number;

  dependencies: string[];
  dependents: string[];

  rto: number;
  rpo: number;

  recoveryStrategy: 'active_active' | 'active_passive' | 'pilot_light' | 'warm_standby' | 'backup_restore';

  primaryRegion: string;
  drRegion: string;

  failoverProcedure: string;
  failbackProcedure: string;

  dataReplication: {
    method: 'synchronous' | 'asynchronous' | 'snapshot';
    frequency?: number;
    lagTime?: number;
  };

  lastFailoverTest: string;
  lastSuccessfulRecovery?: string;
}

interface RecoveryTier {
  tier: number;
  name: string;
  description: string;
  rtoTarget: number;
  rpoTarget: number;
  systems: string[];
  priority: number;
  activationCriteria: string[];
}

const recoveryTiers: RecoveryTier[] = [
  {
    tier: 1,
    name: 'Mission Critical',
    description: 'Core systems required for patient safety and regulatory compliance',
    rtoTarget: 60,
    rpoTarget: 0,
    systems: ['prescription_service', 'pharmacy_operations', 'patient_portal', 'provider_portal'],
    priority: 1,
    activationCriteria: ['Any production outage affecting patient care']
  },
  {
    tier: 2,
    name: 'Business Critical',
    description: 'Systems required for core business operations',
    rtoTarget: 240,
    rpoTarget: 60,
    systems: ['order_service', 'payment_service', 'notification_service', 'inventory_service'],
    priority: 2,
    activationCriteria: ['Extended outage (>1 hour) affecting revenue']
  },
  {
    tier: 3,
    name: 'Business Important',
    description: 'Systems supporting business operations',
    rtoTarget: 480,
    rpoTarget: 240,
    systems: ['analytics', 'marketing', 'employer_portal', 'support_desk'],
    priority: 3,
    activationCriteria: ['Outage affecting internal operations']
  },
  {
    tier: 4,
    name: 'Non-Critical',
    description: 'Systems that can be recovered last',
    rtoTarget: 1440,
    rpoTarget: 1440,
    systems: ['development', 'staging', 'internal_tools'],
    priority: 4,
    activationCriteria: ['Full DR activation']
  }
];
```

### Disaster Scenarios

```typescript
interface DisasterScenario {
  id: string;
  name: string;
  description: string;

  type: 'infrastructure' | 'cyber' | 'natural' | 'pandemic' | 'vendor' | 'data_corruption';

  probability: 'low' | 'medium' | 'high';
  impact: 'low' | 'medium' | 'high' | 'catastrophic';

  affectedSystems: string[];
  affectedRegions: string[];

  triggerConditions: string[];

  response: {
    immediateActions: string[];
    recoveryProcedure: string;
    estimatedRecoveryTime: number;
    requiredResources: string[];
  };

  mitigations: {
    preventive: string[];
    detective: string[];
    corrective: string[];
  };
}

const disasterScenarios: DisasterScenario[] = [
  {
    id: 'primary-region-outage',
    name: 'Primary AWS Region Outage',
    description: 'Complete loss of primary AWS region (us-east-1)',
    type: 'infrastructure',
    probability: 'low',
    impact: 'catastrophic',
    affectedSystems: ['all'],
    affectedRegions: ['us-east-1'],
    triggerConditions: ['AWS status page shows region-wide outage', 'Multi-AZ failure detected'],
    response: {
      immediateActions: ['Activate DR command center', 'Notify executive team', 'Begin failover to us-west-2'],
      recoveryProcedure: 'region-failover-runbook',
      estimatedRecoveryTime: 60,
      requiredResources: ['DR coordinator', 'Platform team', 'Database team']
    },
    mitigations: {
      preventive: ['Multi-region architecture', 'Continuous data replication'],
      detective: ['Multi-region health checks', 'AWS Health Dashboard monitoring'],
      corrective: ['Automated failover for critical systems', 'DNS failover']
    }
  },
  {
    id: 'ransomware-attack',
    name: 'Ransomware Attack',
    description: 'Ransomware encryption of production systems',
    type: 'cyber',
    probability: 'medium',
    impact: 'catastrophic',
    affectedSystems: ['potentially_all'],
    affectedRegions: ['all'],
    triggerConditions: ['Ransomware detection alert', 'Mass file encryption detected', 'Ransom note discovered'],
    response: {
      immediateActions: ['Isolate affected systems', 'Activate incident response', 'Preserve evidence', 'Notify legal and compliance'],
      recoveryProcedure: 'ransomware-recovery-runbook',
      estimatedRecoveryTime: 1440,
      requiredResources: ['Security team', 'Legal', 'External forensics', 'FBI/CISA']
    },
    mitigations: {
      preventive: ['Endpoint protection', 'Network segmentation', 'Backup isolation'],
      detective: ['EDR monitoring', 'File integrity monitoring', 'Anomaly detection'],
      corrective: ['Air-gapped backups', 'Immutable storage', 'Rapid restore capability']
    }
  },
  {
    id: 'database-corruption',
    name: 'Database Corruption',
    description: 'Data corruption in primary database',
    type: 'data_corruption',
    probability: 'medium',
    impact: 'high',
    affectedSystems: ['all_data_dependent'],
    affectedRegions: ['primary'],
    triggerConditions: ['Database integrity check failures', 'Application data errors', 'Replication lag with errors'],
    response: {
      immediateActions: ['Stop writes to affected tables', 'Assess corruption scope', 'Identify last good backup'],
      recoveryProcedure: 'database-restore-runbook',
      estimatedRecoveryTime: 240,
      requiredResources: ['Database team', 'Platform team', 'Application owners']
    },
    mitigations: {
      preventive: ['Point-in-time recovery enabled', 'Regular integrity checks', 'Change management'],
      detective: ['Automated integrity monitoring', 'Replication monitoring'],
      corrective: ['15-minute backup intervals', 'Multi-region replicas', 'Tested restore procedures']
    }
  }
];
```

### DR Testing

```typescript
interface DRTestPlan {
  id: string;
  name: string;
  type: 'tabletop' | 'walkthrough' | 'simulation' | 'parallel' | 'full_failover';

  scope: {
    systems: string[];
    scenarios: string[];
    regions: string[];
  };

  schedule: {
    plannedDate: string;
    duration: number;
    maintenanceWindow?: string;
  };

  participants: {
    role: string;
    name: string;
    responsibilities: string[];
  }[];

  objectives: string[];
  successCriteria: string[];

  risks: {
    risk: string;
    mitigation: string;
  }[];

  rollbackPlan: string;
}

interface DRTestResult {
  testPlanId: string;
  executedAt: string;
  completedAt: string;

  overallResult: 'pass' | 'pass_with_issues' | 'fail';

  objectives: {
    objective: string;
    result: 'met' | 'partially_met' | 'not_met';
    notes: string;
  }[];

  metrics: {
    actualRTO: number;
    targetRTO: number;
    rtoMet: boolean;
    actualRPO: number;
    targetRPO: number;
    rpoMet: boolean;
    dataLoss: number;
    systemsRecovered: number;
    systemsFailed: number;
  };

  timeline: {
    timestamp: string;
    event: string;
    duration?: number;
    issues?: string;
  }[];

  issues: {
    severity: 'critical' | 'major' | 'minor';
    description: string;
    impact: string;
    recommendation: string;
    owner: string;
  }[];

  lessonsLearned: string[];
  actionItems: {
    action: string;
    owner: string;
    dueDate: string;
    priority: 'high' | 'medium' | 'low';
  }[];

  nextTestDate: string;
}

const drTestSchedule = {
  tabletop: { frequency: 'quarterly', duration: 2, participants: 'key_stakeholders' },
  walkthrough: { frequency: 'semi_annual', duration: 4, participants: 'technical_teams' },
  simulation: { frequency: 'annual', duration: 8, participants: 'all_teams' },
  full_failover: { frequency: 'annual', duration: 24, participants: 'all_teams', requiresMaintenanceWindow: true }
};
```

---

## API Gateway & Integration Management

Centralized API management, rate limiting, versioning, and third-party integration governance.

### API Gateway Architecture

```typescript
interface APIGatewaySystem {
  registerAPI: (api: APIRegistration) => Promise<API>;
  manageVersions: (apiId: string) => Promise<VersionManagement>;
  configureRateLimiting: (apiId: string, config: RateLimitConfig) => Promise<void>;
  monitorUsage: (apiId: string) => Promise<UsageMetrics>;
  manageIntegrations: () => Promise<IntegrationInventory>;
}

interface API {
  id: string;
  name: string;
  description: string;

  type: 'internal' | 'external' | 'partner' | 'public';
  category: string;

  endpoints: APIEndpoint[];

  versions: {
    current: string;
    supported: string[];
    deprecated: string[];
    sunset: { version: string; date: string }[];
  };

  authentication: {
    methods: ('api_key' | 'oauth2' | 'jwt' | 'mtls')[];
    required: boolean;
    scopes?: string[];
  };

  rateLimiting: {
    enabled: boolean;
    defaultLimit: number;
    windowSeconds: number;
    burstLimit?: number;
  };

  documentation: {
    openApiSpec: string;
    portalUrl: string;
    changelogUrl: string;
  };

  ownership: {
    team: string;
    owner: string;
    oncallGroup: string;
  };

  sla: {
    availability: number;
    latencyP50: number;
    latencyP99: number;
    errorBudget: number;
  };

  status: 'active' | 'deprecated' | 'sunset' | 'development';

  metrics: {
    requestsPerDay: number;
    errorRate: number;
    latencyP50: number;
    latencyP99: number;
  };
}

interface APIEndpoint {
  path: string;
  method: 'GET' | 'POST' | 'PUT' | 'PATCH' | 'DELETE';
  description: string;

  authentication: {
    required: boolean;
    scopes?: string[];
  };

  rateLimit?: {
    limit: number;
    windowSeconds: number;
  };

  caching?: {
    enabled: boolean;
    ttlSeconds: number;
    varyBy: string[];
  };

  validation: {
    requestSchema?: string;
    responseSchema?: string;
  };

  deprecated?: boolean;
  deprecationDate?: string;
  replacementEndpoint?: string;
}

interface RateLimitConfig {
  tiers: {
    name: string;
    requestsPerSecond: number;
    requestsPerDay: number;
    burstSize: number;
    applicableTo: string[];
  }[];

  overrides: {
    clientId: string;
    tier: string;
    customLimit?: number;
    reason: string;
    expiresAt?: string;
  }[];

  throttling: {
    enabled: boolean;
    softLimit: number;
    hardLimit: number;
    penaltyDuration: number;
  };

  quotas: {
    enabled: boolean;
    monthlyLimit: number;
    alertThreshold: number;
  };
}

const rateLimitTiers: RateLimitConfig['tiers'] = [
  { name: 'free', requestsPerSecond: 10, requestsPerDay: 1000, burstSize: 20, applicableTo: ['public_api'] },
  { name: 'basic', requestsPerSecond: 50, requestsPerDay: 10000, burstSize: 100, applicableTo: ['partner_api'] },
  { name: 'premium', requestsPerSecond: 200, requestsPerDay: 100000, burstSize: 500, applicableTo: ['enterprise_api'] },
  { name: 'internal', requestsPerSecond: 1000, requestsPerDay: 10000000, burstSize: 2000, applicableTo: ['internal_api'] }
];
```

### Third-Party Integration Management

```typescript
interface IntegrationInventory {
  integrations: ThirdPartyIntegration[];
  healthStatus: IntegrationHealth[];
  dependencies: DependencyMap;
}

interface ThirdPartyIntegration {
  id: string;
  name: string;
  vendor: string;
  vendorId: string;

  type: 'api' | 'webhook' | 'sftp' | 'database' | 'message_queue' | 'sdk';
  category: 'payment' | 'communication' | 'healthcare' | 'shipping' | 'analytics' | 'identity' | 'infrastructure';

  connection: {
    baseUrl?: string;
    protocol: 'https' | 'sftp' | 'amqp' | 'kafka';
    authentication: {
      type: 'api_key' | 'oauth2' | 'basic' | 'certificate' | 'iam';
      credentialLocation: string;
      rotationSchedule?: string;
    };
  };

  usage: {
    consumingSystems: string[];
    dataFlow: 'inbound' | 'outbound' | 'bidirectional';
    dataTypes: string[];
    piiTransmitted: boolean;
    phiTransmitted: boolean;
  };

  sla: {
    vendorSLA: number;
    expectedLatency: number;
    rateLimit: number;
    quotaLimit?: number;
  };

  monitoring: {
    healthCheckEndpoint?: string;
    healthCheckFrequency: number;
    alertThresholds: {
      errorRate: number;
      latency: number;
    };
  };

  fallback: {
    hasFallback: boolean;
    fallbackType?: 'alternative_vendor' | 'queue_retry' | 'graceful_degradation' | 'manual';
    fallbackIntegrationId?: string;
    maxRetries?: number;
  };

  compliance: {
    baaRequired: boolean;
    baaExecuted: boolean;
    dataProcessingAgreement: boolean;
    securityReview: string;
  };

  status: 'active' | 'degraded' | 'down' | 'deprecated';
  lastHealthCheck: string;
}

interface IntegrationHealth {
  integrationId: string;
  status: 'healthy' | 'degraded' | 'unhealthy' | 'unknown';
  lastCheck: string;

  metrics: {
    successRate: number;
    averageLatency: number;
    p99Latency: number;
    requestCount: number;
    errorCount: number;
  };

  recentErrors: {
    timestamp: string;
    errorType: string;
    message: string;
    count: number;
  }[];

  quotaUsage?: {
    used: number;
    limit: number;
    resetAt: string;
  };
}

const criticalIntegrations: ThirdPartyIntegration[] = [
  {
    id: 'stripe',
    name: 'Stripe Payments',
    vendor: 'Stripe',
    vendorId: 'vendor-stripe',
    type: 'api',
    category: 'payment',
    connection: {
      baseUrl: 'https://api.stripe.com',
      protocol: 'https',
      authentication: { type: 'api_key', credentialLocation: 'secrets_manager:stripe_api_key', rotationSchedule: '90d' }
    },
    usage: {
      consumingSystems: ['order_service', 'subscription_service', 'billing_service'],
      dataFlow: 'bidirectional',
      dataTypes: ['payment_methods', 'transactions', 'customers'],
      piiTransmitted: true,
      phiTransmitted: false
    },
    sla: { vendorSLA: 99.99, expectedLatency: 500, rateLimit: 100 },
    monitoring: { healthCheckEndpoint: 'https://api.stripe.com/v1/health', healthCheckFrequency: 60, alertThresholds: { errorRate: 0.01, latency: 2000 } },
    fallback: { hasFallback: false, fallbackType: 'queue_retry', maxRetries: 3 },
    compliance: { baaRequired: false, baaExecuted: false, dataProcessingAgreement: true, securityReview: '2024-01-15' },
    status: 'active',
    lastHealthCheck: ''
  },
  {
    id: 'twilio',
    name: 'Twilio Communications',
    vendor: 'Twilio',
    vendorId: 'vendor-twilio',
    type: 'api',
    category: 'communication',
    connection: {
      baseUrl: 'https://api.twilio.com',
      protocol: 'https',
      authentication: { type: 'basic', credentialLocation: 'secrets_manager:twilio_credentials', rotationSchedule: '180d' }
    },
    usage: {
      consumingSystems: ['notification_service', 'telemedicine_service'],
      dataFlow: 'bidirectional',
      dataTypes: ['sms', 'voice', 'video'],
      piiTransmitted: true,
      phiTransmitted: true
    },
    sla: { vendorSLA: 99.95, expectedLatency: 1000, rateLimit: 100 },
    monitoring: { healthCheckEndpoint: 'https://status.twilio.com/api/v2/status.json', healthCheckFrequency: 60, alertThresholds: { errorRate: 0.05, latency: 3000 } },
    fallback: { hasFallback: true, fallbackType: 'alternative_vendor', fallbackIntegrationId: 'sendgrid' },
    compliance: { baaRequired: true, baaExecuted: true, dataProcessingAgreement: true, securityReview: '2024-02-01' },
    status: 'active',
    lastHealthCheck: ''
  }
];
```

---

## Change Management System

Controlled change process for infrastructure, application, and configuration changes.

### Change Management Architecture

```typescript
interface ChangeManagementSystem {
  submitChange: (request: ChangeRequest) => Promise<Change>;
  assessRisk: (changeId: string) => Promise<RiskAssessment>;
  approveChange: (changeId: string, approval: Approval) => Promise<void>;
  implementChange: (changeId: string) => Promise<ImplementationResult>;
  reviewChange: (changeId: string) => Promise<PostImplementationReview>;
}

interface Change {
  id: string;
  changeNumber: string;

  title: string;
  description: string;
  justification: string;

  type: 'standard' | 'normal' | 'emergency' | 'expedited';
  category: 'infrastructure' | 'application' | 'database' | 'network' | 'security' | 'configuration';

  requestor: {
    userId: string;
    name: string;
    team: string;
  };

  scope: {
    systems: string[];
    environments: string[];
    regions: string[];
    estimatedImpact: 'none' | 'minimal' | 'moderate' | 'significant' | 'major';
    affectedUsers: number;
  };

  schedule: {
    requestedDate: string;
    requestedWindow: { start: string; end: string };
    approvedWindow?: { start: string; end: string };
    actualStart?: string;
    actualEnd?: string;
  };

  risk: {
    level: 'low' | 'medium' | 'high' | 'critical';
    factors: string[];
    mitigations: string[];
  };

  plan: {
    implementation: string;
    testing: string;
    rollback: string;
    communication: string;
  };

  approvals: ChangeApproval[];

  implementation: {
    status: 'not_started' | 'in_progress' | 'completed' | 'rolled_back' | 'failed';
    implementedBy?: string;
    notes?: string;
    artifacts?: string[];
  };

  review?: {
    successful: boolean;
    issues: string[];
    lessonsLearned: string[];
    reviewedBy: string;
    reviewedAt: string;
  };

  status: 'draft' | 'submitted' | 'assessing' | 'pending_approval' | 'approved' | 'scheduled' | 'implementing' | 'completed' | 'failed' | 'cancelled';

  relatedChanges: string[];
  relatedIncidents: string[];

  createdAt: string;
  updatedAt: string;
}

interface ChangeApproval {
  role: string;
  approver: string;
  status: 'pending' | 'approved' | 'rejected' | 'abstained';
  comments?: string;
  decidedAt?: string;
}

const changeTypes = {
  standard: {
    description: 'Pre-approved, low-risk changes',
    approvalRequired: false,
    leadTime: 0,
    examples: ['Routine patching', 'Config file updates', 'Log rotation changes']
  },
  normal: {
    description: 'Standard changes requiring CAB approval',
    approvalRequired: true,
    leadTime: 5,
    examples: ['New feature deployment', 'Database schema changes', 'Infrastructure scaling']
  },
  expedited: {
    description: 'Urgent changes with shortened approval cycle',
    approvalRequired: true,
    leadTime: 1,
    examples: ['Security patches', 'Critical bug fixes', 'Compliance remediation']
  },
  emergency: {
    description: 'Changes to resolve active incidents',
    approvalRequired: true,
    leadTime: 0,
    examples: ['Incident remediation', 'Security breach response', 'Critical system recovery'],
    postApproval: true
  }
};

const approvalMatrix = {
  low: {
    requiredApprovers: ['team_lead'],
    cabRequired: false
  },
  medium: {
    requiredApprovers: ['team_lead', 'service_owner'],
    cabRequired: false
  },
  high: {
    requiredApprovers: ['team_lead', 'service_owner', 'change_manager'],
    cabRequired: true
  },
  critical: {
    requiredApprovers: ['team_lead', 'service_owner', 'change_manager', 'executive'],
    cabRequired: true,
    cabQuorum: 3
  }
};
```

### Change Calendar & Blackout Windows

```typescript
interface ChangeCalendar {
  scheduledChanges: ScheduledChange[];
  blackoutWindows: BlackoutWindow[];
  maintenanceWindows: MaintenanceWindow[];
  conflicts: ChangeConflict[];
}

interface BlackoutWindow {
  id: string;
  name: string;
  reason: string;

  schedule: {
    start: string;
    end: string;
    recurring?: {
      frequency: 'daily' | 'weekly' | 'monthly' | 'yearly';
      pattern: string;
    };
  };

  scope: {
    systems: string[];
    environments: string[];
    changeTypes: string[];
  };

  exceptions: {
    allowedChangeTypes: string[];
    approvalRequired: boolean;
    approver: string;
  };

  status: 'active' | 'inactive';
}

interface MaintenanceWindow {
  id: string;
  name: string;

  schedule: {
    dayOfWeek: number[];
    startTime: string;
    endTime: string;
    timezone: string;
  };

  scope: {
    systems: string[];
    environments: string[];
  };

  notifications: {
    advanceNotice: number;
    channels: string[];
    template: string;
  };
}

const standardBlackouts: BlackoutWindow[] = [
  {
    id: 'month-end',
    name: 'Month-End Processing',
    reason: 'Financial close processing',
    schedule: { start: '', end: '', recurring: { frequency: 'monthly', pattern: 'last 3 days' } },
    scope: { systems: ['billing', 'payments', 'financial'], environments: ['production'], changeTypes: ['all'] },
    exceptions: { allowedChangeTypes: ['emergency'], approvalRequired: true, approver: 'cfo' },
    status: 'active'
  },
  {
    id: 'holiday-freeze',
    name: 'Holiday Code Freeze',
    reason: 'Reduced staffing during holidays',
    schedule: { start: '2024-12-20', end: '2025-01-02' },
    scope: { systems: ['all'], environments: ['production'], changeTypes: ['normal', 'expedited'] },
    exceptions: { allowedChangeTypes: ['emergency'], approvalRequired: true, approver: 'vp_engineering' },
    status: 'active'
  }
];
```

---

## Data Governance Framework

Data classification, ownership, quality, and lifecycle management across the platform.

### Data Governance Architecture

```typescript
interface DataGovernanceSystem {
  classifyData: (dataAsset: DataAsset) => Promise<Classification>;
  assignOwnership: (dataAssetId: string, ownership: DataOwnership) => Promise<void>;
  measureQuality: (dataAssetId: string) => Promise<QualityMetrics>;
  trackLineage: (dataAssetId: string) => Promise<DataLineage>;
  enforcePolicy: (policyId: string) => Promise<EnforcementResult>;
}

interface DataAsset {
  id: string;
  name: string;
  description: string;

  type: 'table' | 'file' | 'api' | 'stream' | 'document' | 'model';
  location: {
    system: string;
    database?: string;
    schema?: string;
    path?: string;
  };

  classification: DataClassification;

  ownership: DataOwnership;

  schema?: {
    columns: ColumnDefinition[];
    primaryKey?: string[];
    foreignKeys?: ForeignKeyDefinition[];
  };

  quality: {
    score: number;
    dimensions: QualityDimension[];
    lastAssessed: string;
  };

  lineage: {
    sources: string[];
    targets: string[];
    transformations: string[];
  };

  lifecycle: {
    createdAt: string;
    retentionPolicy: string;
    archiveAfter?: number;
    deleteAfter?: number;
  };

  usage: {
    consumers: string[];
    accessFrequency: 'high' | 'medium' | 'low';
    lastAccessed: string;
  };

  compliance: {
    regulations: string[];
    requirements: string[];
    controls: string[];
  };

  metadata: Record<string, unknown>;
}

interface DataClassification {
  level: 'public' | 'internal' | 'confidential' | 'restricted';

  categories: {
    pii: boolean;
    phi: boolean;
    pci: boolean;
    financial: boolean;
    proprietary: boolean;
  };

  sensitivity: 'low' | 'medium' | 'high' | 'critical';

  handling: {
    encryptionRequired: boolean;
    encryptionType?: 'at_rest' | 'in_transit' | 'both';
    maskingRequired: boolean;
    maskingRules?: string[];
    accessRestrictions: string[];
    auditRequired: boolean;
  };

  classifiedBy: string;
  classifiedAt: string;
  reviewDate: string;
}

interface DataOwnership {
  dataOwner: {
    userId: string;
    name: string;
    role: string;
    responsibilities: string[];
  };

  dataSteward: {
    userId: string;
    name: string;
    role: string;
    responsibilities: string[];
  };

  technicalOwner: {
    userId: string;
    name: string;
    team: string;
  };

  businessUnit: string;
  costCenter: string;
}

const classificationLevels = {
  public: {
    description: 'Information that can be freely shared',
    examples: ['Marketing materials', 'Public website content'],
    controls: ['No special controls required']
  },
  internal: {
    description: 'Information for internal use only',
    examples: ['Internal policies', 'Non-sensitive business data'],
    controls: ['Authentication required', 'No external sharing without approval']
  },
  confidential: {
    description: 'Sensitive business or personal information',
    examples: ['Employee records', 'Financial data', 'Customer PII'],
    controls: ['Encryption required', 'Access logging', 'Need-to-know access', 'No external sharing']
  },
  restricted: {
    description: 'Highly sensitive information requiring maximum protection',
    examples: ['PHI', 'Payment card data', 'Security credentials', 'Legal matters'],
    controls: ['Strong encryption', 'MFA required', 'Detailed audit logging', 'DLP monitoring', 'Approval for all access']
  }
};
```

### Data Quality Management

```typescript
interface DataQualityFramework {
  dimensions: QualityDimension[];
  rules: DataQualityRule[];
  metrics: QualityMetrics;
  issues: DataQualityIssue[];
}

interface QualityDimension {
  name: 'completeness' | 'accuracy' | 'consistency' | 'timeliness' | 'validity' | 'uniqueness';
  description: string;
  weight: number;
  score: number;
  threshold: number;
}

interface DataQualityRule {
  id: string;
  name: string;
  description: string;

  dimension: QualityDimension['name'];

  target: {
    dataAssetId: string;
    column?: string;
  };

  rule: {
    type: 'null_check' | 'format_check' | 'range_check' | 'referential' | 'uniqueness' | 'custom';
    expression: string;
    parameters?: Record<string, unknown>;
  };

  severity: 'critical' | 'high' | 'medium' | 'low';

  schedule: {
    frequency: 'realtime' | 'hourly' | 'daily' | 'weekly';
    lastRun?: string;
    nextRun: string;
  };

  alerting: {
    enabled: boolean;
    threshold: number;
    channels: string[];
  };

  enabled: boolean;
}

interface DataQualityIssue {
  id: string;
  ruleId: string;
  dataAssetId: string;

  severity: 'critical' | 'high' | 'medium' | 'low';
  dimension: string;

  description: string;
  affectedRecords: number;
  sampleData?: Record<string, unknown>[];

  status: 'new' | 'acknowledged' | 'investigating' | 'remediated' | 'accepted';

  owner?: string;
  rootCause?: string;
  remediation?: string;

  detectedAt: string;
  resolvedAt?: string;
}

const dataQualityRules: DataQualityRule[] = [
  {
    id: 'patient-email-format',
    name: 'Patient Email Format',
    description: 'Validate patient email addresses',
    dimension: 'validity',
    target: { dataAssetId: 'patients', column: 'email' },
    rule: { type: 'format_check', expression: '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$' },
    severity: 'medium',
    schedule: { frequency: 'daily', nextRun: '' },
    alerting: { enabled: true, threshold: 0.95, channels: ['data-quality-alerts'] },
    enabled: true
  },
  {
    id: 'prescription-provider-ref',
    name: 'Prescription Provider Reference',
    description: 'Ensure prescription references valid provider',
    dimension: 'consistency',
    target: { dataAssetId: 'prescriptions', column: 'provider_id' },
    rule: { type: 'referential', expression: 'EXISTS (SELECT 1 FROM providers WHERE id = prescriptions.provider_id)' },
    severity: 'critical',
    schedule: { frequency: 'hourly', nextRun: '' },
    alerting: { enabled: true, threshold: 1.0, channels: ['data-quality-alerts', 'oncall'] },
    enabled: true
  },
  {
    id: 'order-date-timeliness',
    name: 'Order Date Timeliness',
    description: 'Ensure order dates are not in the future',
    dimension: 'timeliness',
    target: { dataAssetId: 'orders', column: 'created_at' },
    rule: { type: 'range_check', expression: 'created_at <= NOW()', parameters: { tolerance: '1 hour' } },
    severity: 'high',
    schedule: { frequency: 'realtime', nextRun: '' },
    alerting: { enabled: true, threshold: 1.0, channels: ['data-quality-alerts'] },
    enabled: true
  }
];
```

---

## Master Data Management

Centralized management of core business entities with deduplication, matching, and synchronization.

### MDM Architecture

```typescript
interface MasterDataManagement {
  matchRecords: (entityType: string, records: Record<string, unknown>[]) => Promise<MatchResult[]>;
  mergeRecords: (entityType: string, masterId: string, duplicateIds: string[]) => Promise<MergeResult>;
  synchronize: (entityType: string) => Promise<SyncResult>;
  auditChanges: (entityType: string, entityId: string) => Promise<AuditTrail>;
}

interface MasterDataDomain {
  entityType: string;
  description: string;

  sourceSystem: string;
  goldenRecordLocation: string;

  matchingRules: MatchingRule[];
  survivorshipRules: SurvivorshipRule[];
  validationRules: ValidationRule[];

  synchronization: {
    sources: DataSource[];
    targets: DataTarget[];
    frequency: 'realtime' | 'batch';
    conflictResolution: 'source_wins' | 'target_wins' | 'latest_wins' | 'manual';
  };

  governance: {
    dataOwner: string;
    dataSteward: string;
    approvalRequired: boolean;
  };
}

interface MatchingRule {
  id: string;
  name: string;
  weight: number;

  fields: {
    field: string;
    matchType: 'exact' | 'fuzzy' | 'phonetic' | 'normalized';
    threshold?: number;
    weight: number;
  }[];

  minimumScore: number;
  blockingKeys: string[];
}

interface SurvivorshipRule {
  field: string;
  strategy: 'most_recent' | 'most_complete' | 'source_priority' | 'frequency' | 'custom';
  sourcePriority?: string[];
  customLogic?: string;
}

const masterDataDomains: MasterDataDomain[] = [
  {
    entityType: 'patient',
    description: 'Master patient index',
    sourceSystem: 'patient_service',
    goldenRecordLocation: 'mdm.patients',
    matchingRules: [
      {
        id: 'patient-match-1',
        name: 'Exact SSN Match',
        weight: 1.0,
        fields: [{ field: 'ssn', matchType: 'exact', weight: 1.0 }],
        minimumScore: 1.0,
        blockingKeys: ['ssn_last4']
      },
      {
        id: 'patient-match-2',
        name: 'Demographic Match',
        weight: 0.9,
        fields: [
          { field: 'first_name', matchType: 'fuzzy', threshold: 0.85, weight: 0.2 },
          { field: 'last_name', matchType: 'fuzzy', threshold: 0.85, weight: 0.25 },
          { field: 'date_of_birth', matchType: 'exact', weight: 0.3 },
          { field: 'address_zip', matchType: 'exact', weight: 0.15 },
          { field: 'phone', matchType: 'normalized', weight: 0.1 }
        ],
        minimumScore: 0.85,
        blockingKeys: ['last_name_soundex', 'dob_year']
      }
    ],
    survivorshipRules: [
      { field: 'email', strategy: 'most_recent' },
      { field: 'phone', strategy: 'most_recent' },
      { field: 'address', strategy: 'most_complete' },
      { field: 'ssn', strategy: 'source_priority', sourcePriority: ['insurance_verification', 'patient_registration'] },
      { field: 'insurance', strategy: 'most_recent' }
    ],
    validationRules: [],
    synchronization: {
      sources: [{ system: 'patient_portal', table: 'users' }, { system: 'ehr', table: 'patients' }],
      targets: [{ system: 'analytics', table: 'dim_patients' }, { system: 'crm', table: 'contacts' }],
      frequency: 'realtime',
      conflictResolution: 'latest_wins'
    },
    governance: {
      dataOwner: 'chief_medical_officer',
      dataSteward: 'health_informatics_lead',
      approvalRequired: true
    }
  },
  {
    entityType: 'provider',
    description: 'Master provider directory',
    sourceSystem: 'provider_service',
    goldenRecordLocation: 'mdm.providers',
    matchingRules: [
      {
        id: 'provider-match-1',
        name: 'NPI Match',
        weight: 1.0,
        fields: [{ field: 'npi', matchType: 'exact', weight: 1.0 }],
        minimumScore: 1.0,
        blockingKeys: ['npi']
      },
      {
        id: 'provider-match-2',
        name: 'License Match',
        weight: 0.95,
        fields: [
          { field: 'license_number', matchType: 'exact', weight: 0.5 },
          { field: 'license_state', matchType: 'exact', weight: 0.3 },
          { field: 'last_name', matchType: 'exact', weight: 0.2 }
        ],
        minimumScore: 0.95,
        blockingKeys: ['license_state']
      }
    ],
    survivorshipRules: [
      { field: 'credentials', strategy: 'most_complete' },
      { field: 'specialties', strategy: 'frequency' },
      { field: 'contact_info', strategy: 'most_recent' }
    ],
    validationRules: [],
    synchronization: {
      sources: [{ system: 'credentialing', table: 'providers' }, { system: 'nppes', table: 'npi_registry' }],
      targets: [{ system: 'scheduling', table: 'providers' }, { system: 'directory', table: 'provider_profiles' }],
      frequency: 'batch',
      conflictResolution: 'source_wins'
    },
    governance: {
      dataOwner: 'provider_operations_director',
      dataSteward: 'credentialing_manager',
      approvalRequired: true
    }
  },
  {
    entityType: 'product',
    description: 'Master product catalog',
    sourceSystem: 'catalog_service',
    goldenRecordLocation: 'mdm.products',
    matchingRules: [
      {
        id: 'product-match-1',
        name: 'NDC Match',
        weight: 1.0,
        fields: [{ field: 'ndc', matchType: 'exact', weight: 1.0 }],
        minimumScore: 1.0,
        blockingKeys: ['ndc']
      }
    ],
    survivorshipRules: [
      { field: 'description', strategy: 'most_complete' },
      { field: 'pricing', strategy: 'source_priority', sourcePriority: ['pricing_service', 'catalog'] }
    ],
    validationRules: [],
    synchronization: {
      sources: [{ system: 'fdb', table: 'drugs' }, { system: 'inventory', table: 'products' }],
      targets: [{ system: 'ecommerce', table: 'products' }, { system: 'analytics', table: 'dim_products' }],
      frequency: 'batch',
      conflictResolution: 'source_wins'
    },
    governance: {
      dataOwner: 'pharmacy_director',
      dataSteward: 'formulary_manager',
      approvalRequired: false
    }
  }
];
```

### Duplicate Detection & Resolution

```typescript
interface DuplicateManagement {
  detectDuplicates: (entityType: string) => Promise<DuplicateGroup[]>;
  resolveDuplicate: (groupId: string, resolution: DuplicateResolution) => Promise<void>;
  autoMerge: (groupId: string) => Promise<MergeResult>;
  splitRecord: (masterId: string, reason: string) => Promise<SplitResult>;
}

interface DuplicateGroup {
  id: string;
  entityType: string;

  records: {
    recordId: string;
    sourceSystem: string;
    matchScore: number;
    data: Record<string, unknown>;
    lastUpdated: string;
  }[];

  matchDetails: {
    rule: string;
    score: number;
    matchedFields: { field: string; values: string[]; similarity: number }[];
  }[];

  suggestedMaster: string;
  confidence: number;

  status: 'new' | 'reviewing' | 'confirmed' | 'rejected' | 'merged';

  reviewedBy?: string;
  reviewedAt?: string;
  resolution?: DuplicateResolution;

  createdAt: string;
}

interface DuplicateResolution {
  action: 'merge' | 'link' | 'not_duplicate' | 'defer';
  masterId?: string;
  linkedIds?: string[];
  reason?: string;
  survivorshipOverrides?: Record<string, { value: unknown; source: string }>;
}

interface MergeResult {
  success: boolean;
  masterId: string;
  mergedIds: string[];
  goldenRecord: Record<string, unknown>;
  auditId: string;
  warnings?: string[];
}

const duplicateResolutionWorkflow = {
  autoMergeThreshold: 0.98,
  reviewThreshold: 0.85,
  rejectThreshold: 0.70,

  reviewAssignment: {
    patient: 'health_informatics_team',
    provider: 'credentialing_team',
    product: 'formulary_team'
  },

  escalation: {
    daysToReview: 5,
    escalateTo: 'data_steward'
  },

  auditRequirements: {
    logAllMerges: true,
    retainOriginalRecords: true,
    retentionDays: 365
  }
};
```

---

## Shared Platform Architecture

### Philosophy

**One core library. Many independent services. No reinventing the wheel.**

```typescript
const sharedArchitecture = {
  principle: 'Core packages repo + independent service repos',
  goal: 'Shared foundation, independent deployments',

  structure: {
    coreRepo: 'rx-platform-core',      // Shared packages, versioned
    portalRepos: 'Independent repos',   // Each portal is its own repo
    serviceRepos: 'Independent repos'   // Each service is its own repo
  },

  corePackages: {
    '@rx/ui': 'Components used across all portals',
    '@rx/hooks': 'React hooks shared across frontends',
    '@rx/schemas': 'Zod schemas for validation (client + server)',
    '@rx/types': 'TypeScript types for the entire platform',
    '@rx/api-client': 'Frontend API utilities',
    '@rx/api-server': 'Backend API utilities',
    '@rx/auth': 'Authentication/authorization logic',
    '@rx/utils': 'Pure utility functions',
    '@rx/database': 'Prisma client + utilities',
    '@rx/testing': 'Shared test utilities'
  },

  consumers: [
    'patient-portal (separate repo)',
    'provider-portal (separate repo)',
    'admin-portal (separate repo)',
    'prescription-service (separate repo)',
    'order-service (separate repo)'
    // Each deploys independently
  ]
};
```

---

### Repository Structure

```
GitHub Organization: rx-platform/
│
├── rx-platform-core/              # CORE REPO - shared packages
│   ├── packages/
│   │   ├── ui/                    # @rx/ui
│   │   ├── hooks/                 # @rx/hooks
│   │   ├── schemas/               # @rx/schemas
│   │   ├── types/                 # @rx/types
│   │   ├── api-client/            # @rx/api-client
│   │   ├── api-server/            # @rx/api-server
│   │   ├── auth/                  # @rx/auth
│   │   ├── utils/                 # @rx/utils
│   │   ├── database/              # @rx/database
│   │   └── testing/               # @rx/testing
│   ├── tooling/
│   │   ├── eslint-config/         # @rx/eslint-config
│   │   ├── typescript-config/     # @rx/typescript-config
│   │   └── tailwind-config/       # @rx/tailwind-config
│   ├── turbo.json
│   └── package.json
│
├── patient-portal/                # PORTAL REPO - independent
│   ├── src/
│   ├── package.json               # depends on @rx/* packages
│   └── ...
│
├── provider-portal/               # PORTAL REPO - independent
│   └── ...
│
├── admin-portal/                  # PORTAL REPO - independent
│   └── ...
│
├── prescription-service/          # SERVICE REPO - independent
│   ├── src/
│   ├── package.json               # depends on @rx/* packages
│   └── ...
│
├── order-service/                 # SERVICE REPO - independent
│   └── ...
│
└── notification-service/          # SERVICE REPO - independent
    └── ...
```

**Key distinction:**
- `rx-platform-core/` is a small monorepo (just the shared packages)
- Everything else is independent repos that consume published packages

---

### Package Definitions

#### `@rx/ui` - Shared UI Components

```typescript
// packages/ui/package.json
{
  "name": "@rx/ui",
  "exports": {
    ".": "./src/index.ts",
    "./button": "./src/button.tsx",
    "./dialog": "./src/dialog.tsx",
    "./form": "./src/form/index.ts",
    "./data-table": "./src/data-table/index.ts"
  },
  "peerDependencies": {
    "react": "^18.0.0 || ^19.0.0",
    "react-dom": "^18.0.0 || ^19.0.0"
  }
}
```

```typescript
// packages/ui/src/index.ts
// Primitives
export * from './button';
export * from './input';
export * from './select';
export * from './dialog';
export * from './dropdown-menu';
export * from './toast';
export * from './badge';
export * from './card';
export * from './table';
export * from './tabs';

// Composed
export * from './data-table';
export * from './combobox';
export * from './date-picker';
export * from './file-upload';

// Form
export * from './form';

// Healthcare-specific
export * from './patient-status-badge';
export * from './prescription-status-badge';
export * from './order-timeline';
export * from './drug-search';
export * from './allergy-chips';
```

**Usage in any portal:**

```typescript
// apps/patient-portal/src/app/dashboard/page.tsx
import { Button, Card, Badge } from '@rx/ui';
import { PrescriptionStatusBadge } from '@rx/ui/prescription-status-badge';
import { DataTable } from '@rx/ui/data-table';
```

---

#### `@rx/hooks` - Shared React Hooks

```typescript
// packages/hooks/src/index.ts

// UI hooks
export * from './use-debounce';
export * from './use-local-storage';
export * from './use-media-query';
export * from './use-clipboard';
export * from './use-disclosure';

// Data hooks
export * from './use-infinite-scroll';
export * from './use-pagination';

// Form hooks
export * from './use-form-persist';
export * from './use-multi-step-form';

// Platform hooks
export * from './use-current-user';
export * from './use-permissions';
export * from './use-feature-flag';
export * from './use-audit-log';
```

**Usage:**

```typescript
// apps/provider-portal/src/components/PatientSearch.tsx
import { useDebounce, useCurrentUser, usePermissions } from '@rx/hooks';

const PatientSearch = () => {
  const [search, setSearch] = useState('');
  const debouncedSearch = useDebounce(search, 300);
  const user = useCurrentUser();
  const { can } = usePermissions();

  if (!can('patients:read')) return <Unauthorized />;
  // ...
};
```

---

#### `@rx/schemas` - Shared Validation Schemas

```typescript
// packages/schemas/src/index.ts

// Entity schemas (shared between client + server)
export * from './patient';
export * from './provider';
export * from './prescription';
export * from './order';
export * from './drug';
export * from './allergy';
export * from './insurance';

// Form schemas
export * from './forms/patient-registration';
export * from './forms/prescription-create';
export * from './forms/provider-onboarding';

// API schemas
export * from './api/pagination';
export * from './api/filters';
```

```typescript
// packages/schemas/src/patient.ts
import { z } from 'zod';

const patientBaseSchema = z.object({
  firstName: z.string().min(1).max(100),
  lastName: z.string().min(1).max(100),
  dateOfBirth: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  email: z.string().email(),
  phone: z.string().regex(/^\+1\d{10}$/).optional()
});

const patientCreateSchema = patientBaseSchema.extend({
  // Additional fields for creation
});

const patientUpdateSchema = patientBaseSchema.partial();

const patientSchema = patientBaseSchema.extend({
  id: z.string(),
  createdAt: z.string().datetime(),
  updatedAt: z.string().datetime()
});

type Patient = z.infer<typeof patientSchema>;
type PatientCreate = z.infer<typeof patientCreateSchema>;
type PatientUpdate = z.infer<typeof patientUpdateSchema>;

export {
  patientSchema,
  patientCreateSchema,
  patientUpdateSchema,
  type Patient,
  type PatientCreate,
  type PatientUpdate
};
```

**Usage - Same schema on client AND server:**

```typescript
// apps/patient-portal/src/app/register/actions.ts (SERVER)
import { patientCreateSchema } from '@rx/schemas';

const registerPatient = async (formData: FormData) => {
  'use server';
  const parsed = patientCreateSchema.safeParse(Object.fromEntries(formData));
  // ...
};

// apps/patient-portal/src/components/RegistrationForm.tsx (CLIENT)
import { patientCreateSchema } from '@rx/schemas';

const RegistrationForm = () => {
  // Same schema for client-side preview validation
  const validateField = (field: string, value: string) => {
    const result = patientCreateSchema.shape[field].safeParse(value);
    // ...
  };
};
```

---

#### `@rx/types` - Shared TypeScript Types

```typescript
// packages/types/src/index.ts

// Entity types (inferred from schemas or standalone)
export * from './entities/patient';
export * from './entities/provider';
export * from './entities/prescription';
export * from './entities/order';

// API types
export * from './api/responses';
export * from './api/errors';
export * from './api/pagination';

// Event types (for service communication)
export * from './events/prescription-events';
export * from './events/order-events';
export * from './events/notification-events';

// Enum types
export * from './enums';
```

```typescript
// packages/types/src/enums.ts

const PrescriptionStatus = {
  PENDING: 'pending',
  IN_REVIEW: 'in_review',
  APPROVED: 'approved',
  COMPOUNDING: 'compounding',
  QUALITY_CHECK: 'quality_check',
  READY: 'ready',
  SHIPPED: 'shipped',
  DELIVERED: 'delivered',
  CANCELLED: 'cancelled'
} as const;

type PrescriptionStatus = typeof PrescriptionStatus[keyof typeof PrescriptionStatus];

const OrderStatus = {
  CREATED: 'created',
  PAYMENT_PENDING: 'payment_pending',
  PAYMENT_COMPLETE: 'payment_complete',
  PROCESSING: 'processing',
  SHIPPED: 'shipped',
  DELIVERED: 'delivered',
  CANCELLED: 'cancelled',
  REFUNDED: 'refunded'
} as const;

type OrderStatus = typeof OrderStatus[keyof typeof OrderStatus];

export { PrescriptionStatus, OrderStatus };
```

---

#### `@rx/api-client` - Frontend API Utilities

```typescript
// packages/api-client/src/index.ts

export * from './client';
export * from './hooks';
export * from './error-handling';

// Domain-specific API modules
export * from './patients';
export * from './prescriptions';
export * from './orders';
export * from './providers';
```

```typescript
// packages/api-client/src/client.ts
type ApiClientConfig = {
  baseUrl: string;
  getToken: () => Promise<string | null>;
};

const createApiClient = (config: ApiClientConfig) => {
  const request = async <T>(
    path: string,
    options: RequestInit = {}
  ): Promise<T> => {
    const token = await config.getToken();

    const response = await fetch(`${config.baseUrl}${path}`, {
      ...options,
      headers: {
        'Content-Type': 'application/json',
        ...(token && { Authorization: `Bearer ${token}` }),
        ...options.headers
      }
    });

    if (!response.ok) {
      throw await parseApiError(response);
    }

    return response.json();
  };

  return {
    get: <T>(path: string) => request<T>(path, { method: 'GET' }),
    post: <T>(path: string, body: unknown) =>
      request<T>(path, { method: 'POST', body: JSON.stringify(body) }),
    put: <T>(path: string, body: unknown) =>
      request<T>(path, { method: 'PUT', body: JSON.stringify(body) }),
    patch: <T>(path: string, body: unknown) =>
      request<T>(path, { method: 'PATCH', body: JSON.stringify(body) }),
    delete: <T>(path: string) => request<T>(path, { method: 'DELETE' })
  };
};

export { createApiClient };
```

---

#### `@rx/api-server` - Backend API Utilities

```typescript
// packages/api-server/src/index.ts

export * from './middleware/auth';
export * from './middleware/validation';
export * from './middleware/rate-limit';
export * from './middleware/audit-log';

export * from './response';
export * from './errors';
export * from './pagination';
```

```typescript
// packages/api-server/src/response.ts
import type { ApiResponse, ApiErrorResponse } from '@rx/types';

const success = <T>(data: T, meta?: Record<string, unknown>): ApiResponse<T> => ({
  success: true,
  data,
  meta: {
    ...meta,
    timestamp: new Date().toISOString()
  }
});

const error = (
  code: string,
  message: string,
  statusCode: number,
  details?: unknown
): ApiErrorResponse => ({
  success: false,
  error: {
    code,
    message,
    details,
    timestamp: new Date().toISOString()
  }
});

const paginated = <T>(
  data: T[],
  pagination: { page: number; pageSize: number; total: number }
) => success(data, {
  pagination: {
    ...pagination,
    totalPages: Math.ceil(pagination.total / pagination.pageSize)
  }
});

export { success, error, paginated };
```

---

#### `@rx/auth` - Authentication Logic

```typescript
// packages/auth/src/index.ts

// Client-side
export * from './client/provider';
export * from './client/hooks';
export * from './client/guards';

// Server-side
export * from './server/session';
export * from './server/middleware';
export * from './server/permissions';

// Shared
export * from './permissions';
export * from './roles';
```

```typescript
// packages/auth/src/permissions.ts

const Permission = {
  // Patient
  PATIENTS_READ: 'patients:read',
  PATIENTS_WRITE: 'patients:write',
  PATIENTS_DELETE: 'patients:delete',

  // Prescriptions
  PRESCRIPTIONS_READ: 'prescriptions:read',
  PRESCRIPTIONS_WRITE: 'prescriptions:write',
  PRESCRIPTIONS_APPROVE: 'prescriptions:approve',

  // Orders
  ORDERS_READ: 'orders:read',
  ORDERS_WRITE: 'orders:write',
  ORDERS_REFUND: 'orders:refund',

  // Admin
  ADMIN_ACCESS: 'admin:access',
  ADMIN_USERS: 'admin:users',
  ADMIN_SETTINGS: 'admin:settings'
} as const;

type Permission = typeof Permission[keyof typeof Permission];

const RolePermissions: Record<string, Permission[]> = {
  patient: [
    Permission.PATIENTS_READ, // Own record only
    Permission.PRESCRIPTIONS_READ,
    Permission.ORDERS_READ
  ],

  provider: [
    Permission.PATIENTS_READ,
    Permission.PRESCRIPTIONS_READ,
    Permission.PRESCRIPTIONS_WRITE,
    Permission.PRESCRIPTIONS_APPROVE
  ],

  pharmacist: [
    Permission.PATIENTS_READ,
    Permission.PRESCRIPTIONS_READ,
    Permission.PRESCRIPTIONS_WRITE,
    Permission.ORDERS_READ,
    Permission.ORDERS_WRITE
  ],

  admin: Object.values(Permission)
};

export { Permission, RolePermissions };
```

---

#### `@rx/database` - Shared Database Utilities

```typescript
// packages/database/src/index.ts

export * from './client';
export * from './types';
export * from './utils';
export * from './migrations';
```

```typescript
// packages/database/src/client.ts
import { PrismaClient } from '@prisma/client';

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined;
};

const prisma = globalForPrisma.prisma ?? new PrismaClient({
  log: process.env.NODE_ENV === 'development'
    ? ['query', 'error', 'warn']
    : ['error']
});

if (process.env.NODE_ENV !== 'production') {
  globalForPrisma.prisma = prisma;
}

export { prisma };
```

---

#### `@rx/utils` - Pure Utility Functions

```typescript
// packages/utils/src/index.ts

// Formatting
export * from './format/currency';
export * from './format/date';
export * from './format/phone';
export * from './format/address';

// Validation
export * from './validation/npi';
export * from './validation/dea';
export * from './validation/ssn';

// Helpers
export * from './helpers/array';
export * from './helpers/object';
export * from './helpers/string';
export * from './helpers/id';

// Constants
export * from './constants/states';
export * from './constants/drug-schedules';
```

```typescript
// packages/utils/src/format/currency.ts
const formatCurrency = (
  amount: number,
  currency = 'USD',
  locale = 'en-US'
): string => {
  return new Intl.NumberFormat(locale, {
    style: 'currency',
    currency
  }).format(amount);
};

// packages/utils/src/validation/npi.ts
const validateNPI = (npi: string): boolean => {
  if (!/^[12]\d{9}$/.test(npi)) return false;

  // Luhn checksum validation
  const digits = npi.split('').map(Number);
  // ... checksum logic
  return true;
};

export { formatCurrency, validateNPI };
```

---

### Package Dependency Graph

```
                    ┌─────────────┐
                    │   @rx/ui    │
                    └──────┬──────┘
                           │ depends on
              ┌────────────┼────────────┐
              │            │            │
              ▼            ▼            ▼
        ┌──────────┐ ┌──────────┐ ┌──────────┐
        │@rx/hooks │ │@rx/types │ │@rx/utils │
        └────┬─────┘ └────┬─────┘ └──────────┘
             │            │
             │            │
             ▼            ▼
        ┌──────────────────────┐
        │     @rx/schemas      │
        └──────────────────────┘
                    │
        ┌───────────┴───────────┐
        │                       │
        ▼                       ▼
┌───────────────┐      ┌───────────────┐
│ @rx/api-client│      │ @rx/api-server│
└───────────────┘      └───────┬───────┘
                               │
                               ▼
                       ┌───────────────┐
                       │  @rx/database │
                       └───────────────┘

Apps (patient-portal, provider-portal, etc.)
  └── @rx/ui, @rx/hooks, @rx/schemas, @rx/api-client, @rx/auth

Services (prescription-service, order-service, etc.)
  └── @rx/schemas, @rx/types, @rx/api-server, @rx/database, @rx/auth
```

---

### Core Repo Configuration (rx-platform-core)

**Turborepo manages the shared packages within the core repo only.**

```json
// rx-platform-core/turbo.json
{
  "$schema": "https://turbo.build/schema.json",
  "globalDependencies": ["**/.env.*local"],
  "pipeline": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": ["dist/**"]
    },
    "lint": {
      "dependsOn": ["^build"]
    },
    "test": {
      "dependsOn": ["^build"]
    },
    "type-check": {
      "dependsOn": ["^build"]
    },
    "publish": {
      "dependsOn": ["build", "test", "lint"]
    }
  }
}
```

```yaml
# rx-platform-core/pnpm-workspace.yaml
packages:
  - 'packages/*'
  - 'tooling/*'
```

**Note:** Portal and service repos are NOT in this workspace. They are separate repositories that install `@rx/*` packages from the private registry.

---

### Usage Examples

#### Portal Repo Consuming Core Packages

```typescript
// patient-portal/package.json (SEPARATE REPO)
{
  "name": "patient-portal",
  "private": true,
  "dependencies": {
    "@rx/ui": "^2.3.0",
    "@rx/hooks": "^1.5.0",
    "@rx/schemas": "^3.0.0",
    "@rx/types": "^3.0.0",
    "@rx/api-client": "^1.2.0",
    "@rx/auth": "^2.0.0",
    "@rx/utils": "^1.1.0",
    "next": "^14.0.0",
    "react": "^19.0.0"
  }
}
```

```typescript
// patient-portal/src/app/prescriptions/page.tsx
import { DataTable, PrescriptionStatusBadge, Card } from '@rx/ui';
import { useCurrentUser, usePermissions } from '@rx/hooks';
import { prescriptionSchema, type Prescription } from '@rx/schemas';
import { formatCurrency, formatDate } from '@rx/utils';

const PrescriptionsPage = async () => {
  const prescriptions = await getPrescriptions();

  return (
    <Card>
      <DataTable
        data={prescriptions}
        columns={[
          { header: 'Drug', accessorKey: 'drugName' },
          { header: 'Status', cell: (row) => <PrescriptionStatusBadge status={row.status} /> },
          { header: 'Date', cell: (row) => formatDate(row.createdAt) },
          { header: 'Cost', cell: (row) => formatCurrency(row.cost) }
        ]}
      />
    </Card>
  );
};
```

#### Service Repo Consuming Core Packages

```typescript
// prescription-service/package.json (SEPARATE REPO)
{
  "name": "prescription-service",
  "private": true,
  "dependencies": {
    "@rx/schemas": "^3.0.0",
    "@rx/types": "^3.0.0",
    "@rx/api-server": "^1.0.0",
    "@rx/database": "^1.0.0",
    "@rx/auth": "^2.0.0",
    "@rx/utils": "^1.1.0"
  }
```

```typescript
// services/prescription-service/src/routes/prescriptions.ts
import { prescriptionCreateSchema, type PrescriptionCreate } from '@rx/schemas';
import { success, error, paginated } from '@rx/api-server';
import { prisma } from '@rx/database';
import { validateNPI } from '@rx/utils';
import { requirePermission } from '@rx/auth/server';

const createPrescription = async (req: Request) => {
  await requirePermission(req, 'prescriptions:write');

  const body = await req.json();
  const parsed = prescriptionCreateSchema.safeParse(body);

  if (!parsed.success) {
    return error('VALIDATION_ERROR', 'Invalid prescription data', 400, parsed.error);
  }

  const prescription = await prisma.prescription.create({
    data: parsed.data
  });

  return success(prescription);
};
```

---

### What Goes Where

| Package | Contains | Does NOT Contain |
|---------|----------|------------------|
| `@rx/ui` | UI components, styling | Business logic, API calls |
| `@rx/hooks` | Reusable React hooks | Component-specific hooks |
| `@rx/schemas` | Zod schemas, types | Validation logic beyond schema |
| `@rx/types` | TypeScript types, enums | Runtime code |
| `@rx/api-client` | Fetch utilities, error handling | Server-side code |
| `@rx/api-server` | Middleware, response helpers | Route definitions |
| `@rx/auth` | Auth logic, permissions | User management CRUD |
| `@rx/database` | Prisma client, utilities | Business logic |
| `@rx/utils` | Pure functions, formatters | Side effects, API calls |

---

### Adding a New Shared Component

**Checklist:**

1. **Is it reusable across 2+ apps/services?**
   - Yes → Add to appropriate package
   - No → Keep in the app/service

2. **Which package?**
   - UI component → `@rx/ui`
   - React hook → `@rx/hooks`
   - Validation → `@rx/schemas`
   - Type only → `@rx/types`
   - Pure function → `@rx/utils`
   - API helper → `@rx/api-client` or `@rx/api-server`

3. **Export it:**
   ```typescript
   // packages/ui/src/index.ts
   export * from './new-component';
   ```

4. **Use it:**
   ```typescript
   import { NewComponent } from '@rx/ui';
   ```

---

### Versioning & Publishing Strategy

**Core packages are published to private NPM registry. Services consume specific versions.**

```json
// In patient-portal/package.json (separate repo)
{
  "dependencies": {
    "@rx/ui": "^2.3.0",
    "@rx/hooks": "^1.5.0",
    "@rx/schemas": "^3.0.0",
    "@rx/types": "^3.0.0",
    "@rx/api-client": "^1.2.0",
    "@rx/auth": "^2.0.0",
    "@rx/utils": "^1.1.0"
  }
}
```

**Semantic Versioning Rules:**

```typescript
const versioningRules = {
  major: {
    when: 'Breaking changes to public API',
    examples: [
      'Removing a component or function',
      'Changing required props',
      'Changing return types'
    ]
  },

  minor: {
    when: 'New features, backward compatible',
    examples: [
      'Adding new component',
      'Adding optional prop',
      'New utility function'
    ]
  },

  patch: {
    when: 'Bug fixes, no API changes',
    examples: [
      'Fixing styling bug',
      'Performance improvement',
      'Documentation update'
    ]
  }
};
```

**Publishing Workflow:**

```
1. PR merged to rx-platform-core main branch
2. CI runs tests for affected packages
3. Changesets detects version bumps
4. Packages published to private NPM registry
5. Services update dependencies when ready
```

**Private Registry Options:**
- GitHub Packages (free with GitHub)
- npm private packages
- Verdaccio (self-hosted)
- AWS CodeArtifact

---

### Update Strategy for Services

```typescript
const updateStrategy = {
  // Automated dependency updates
  automation: 'Renovate or Dependabot for @rx/* packages',

  // Update frequency by package type
  frequency: {
    '@rx/types': 'Immediate - breaking changes affect contracts',
    '@rx/schemas': 'Immediate - validation changes',
    '@rx/ui': 'Weekly batch - visual changes',
    '@rx/utils': 'Weekly batch - low risk'
  },

  // Testing before update
  testing: {
    requirement: 'All tests must pass after update',
    process: 'Renovate PR → CI runs → Review → Merge'
  }
};
```

**Benefits of this approach:**
- Services update when ready (not forced)
- Clear version history
- Rollback by pinning previous version
- Independent deployment schedules
- Breaking changes are explicit

---

## Implementation Phasing Strategy

This comprehensive phasing plan covers all 114 documented systems across 6 major phases. Each phase builds on the previous, with clear entry/exit criteria and dependency management.

### Phase Overview

| Phase | Name | Duration | Focus | Systems | Team Size |
|-------|------|----------|-------|---------|-----------|
| 0 | Foundation | Weeks 1-6 | Infrastructure & Compliance Baseline | 18 | 3-4 |
| 1 | MVP | Weeks 7-18 | Revenue-Generating Core Loop | 24 | 6-8 |
| 2 | Clinical Maturity | Months 5-9 | Quality, Safety, Compliance Hardening | 22 | 10-12 |
| 3 | Growth | Months 10-15 | Marketing, Mobile, Marketplace | 20 | 15-18 |
| 4 | Enterprise | Months 16-22 | Employers, Insurance, B2B | 18 | 20-25 |
| 5 | Scale | Months 23-30 | Optimization, AI/ML, Multi-Region | 12 | 25-30 |

---

### Phase 0: Foundation (Weeks 1-6)

**Objective:** Establish infrastructure, security baseline, and compliance foundations before building features.

**Entry Criteria:**
- Founding team assembled (CTO, lead engineer, DevOps)
- AWS/GCP HIPAA BAA signed
- Legal entity established
- Healthcare attorney engaged

**Systems to Build:**

```typescript
const phase0Systems = {
  infrastructure: [
    'unified_audit_logging',      // Immutable audit trail from day 1
    'security_monitoring_siem',   // Security baseline before PHI
    'api_gateway',                // Rate limiting, auth, versioning
    'database_schema',            // PostgreSQL with encryption at rest
    'message_queue',              // Redis/SQS for async processing
    'file_storage',               // S3 with encryption, WORM for compliance
    'secrets_management',         // HashiCorp Vault or AWS Secrets Manager
    'ci_cd_pipeline'              // GitHub Actions with security scanning
  ],

  compliance: [
    'hipaa_baseline',             // Policies, procedures, risk assessment
    'baa_management',             // Track vendor BAAs
    'data_classification',        // PHI/PII tagging framework
    'access_control_framework',   // RBAC foundation
    'encryption_standards'        // TLS 1.3, AES-256
  ],

  operations: [
    'incident_response_basic',    // On-call rotation, runbooks
    'monitoring_alerting',        // Datadog/CloudWatch setup
    'backup_strategy',            // Automated backups, tested restores
    'vendor_management_basic',    // Critical vendor inventory
    'change_management_basic'     // PR review process, deploy gates
  ]
};
```

**Key Milestones:**
- [ ] Week 2: HIPAA risk assessment complete
- [ ] Week 3: Infrastructure provisioned, all BAAs signed
- [ ] Week 4: CI/CD pipeline with security scanning operational
- [ ] Week 5: Audit logging capturing all system events
- [ ] Week 6: Penetration test passed, security baseline certified

**Exit Criteria:**
- All infrastructure HIPAA-eligible
- Audit logging operational and tamper-evident
- Security monitoring active
- Backup/restore tested
- Incident response plan documented

**Team:**
| Role | Count | Focus |
|------|-------|-------|
| Tech Lead / CTO | 1 | Architecture, security |
| Senior Backend Engineer | 1 | Infrastructure, APIs |
| DevOps/SRE | 1 | CI/CD, monitoring |
| Compliance Consultant | 0.5 | HIPAA, policies |

---

### Phase 1: MVP (Weeks 7-18)

**Objective:** Launch revenue-generating core loop with cash-pay patients in 5 Mountain states.

**Entry Criteria:**
- Phase 0 complete
- Pharmacy licenses obtained (UT, ID, AZ, CO, WY)
- 5-10 contracted providers with active state licenses
- Compounding facility operational (503A)

**Systems to Build:**

```typescript
const phase1Systems = {
  patientExperience: [
    'patient_portal',             // Next.js, registration, dashboard
    'patient_authentication',     // Auth0 with MFA
    'drug_catalog_search',        // Compound search, pricing display
    'ai_symptom_assessment',      // Claude-powered intake
    'consultation_booking',       // Calendar, availability
    'consent_management',         // State-specific consent flows
    'patient_notifications',      // Email/SMS for appointments, orders
    'payment_processing'          // Stripe with PCI compliance
  ],

  providerExperience: [
    'provider_portal',            // Calendar, patient queue
    'provider_authentication',    // Auth0 with role separation
    'telehealth_video',           // Twilio/Daily.co HIPAA
    'ai_consultation_summary',    // Pre-visit and post-visit AI summaries
    'prescription_creation',      // Basic Rx writing
    'clinical_documentation',     // Visit notes, attestation
    'provider_scheduling'         // Availability management
  ],

  pharmacyOperations: [
    'order_management',           // Rx → Order workflow
    'prescription_processing',    // Validation, DUR basics
    'formulation_management',     // Compound formulas, ingredients
    'label_generation',           // Compliant prescription labels
    'shipping_integration',       // FedEx/UPS with cold chain
    'inventory_basic'             // Ingredient tracking
  ],

  administration: [
    'admin_dashboard',            // User management, basic reports
    'state_licensing_tracker',    // License status, renewals
    'basic_reporting'             // Revenue, orders, utilization
  ]
};
```

**Core User Flow:**
```
Patient Journey:
Search Drug → AI Assessment → Book Appointment → Video Visit →
Rx Written → Payment → Order Fulfilled → Shipped → Delivered

Provider Journey:
View Schedule → Review AI Summary → Conduct Visit →
Write Prescription → Sign-off → Done
```

**Key Milestones:**
- [ ] Week 8: Patient registration and drug search live
- [ ] Week 10: AI assessment flow complete
- [ ] Week 12: Telehealth video operational
- [ ] Week 14: First end-to-end patient journey tested
- [ ] Week 16: Provider portal feature-complete
- [ ] Week 17: Security audit passed
- [ ] Week 18: Soft launch with 50 beta patients

**Scaling Triggers for Phase 2:**
- 500+ monthly active patients
- 50+ prescriptions/week
- Provider utilization > 60%
- Net Promoter Score > 30

**Exit Criteria:**
- Complete patient journey functional
- 5 states operational
- Cash-pay processing working
- No P0/P1 bugs open
- HIPAA compliance verified

**Geographic Scope:**
- Utah (HQ, first)
- Idaho
- Arizona
- Colorado
- Wyoming

**Team:**
| Role | Count | Focus |
|------|-------|-------|
| Tech Lead | 1 | Architecture, code review |
| Senior Full-Stack | 2 | Patient/provider portals |
| Backend Engineer | 2 | APIs, pharmacy ops |
| DevOps/SRE | 1 | Reliability, deploys |
| QA Engineer | 1 | Manual + automated testing |
| Product Manager | 1 | Roadmap, user research |

---

### Phase 2: Clinical Maturity (Months 5-9)

**Objective:** Harden clinical workflows, quality systems, and compliance infrastructure for scale.

**Entry Criteria:**
- Phase 1 stable (< 1 P1 incident/week)
- 500+ patients served
- Pharmacy operations validated
- Initial revenue traction

**Systems to Build:**

```typescript
const phase2Systems = {
  clinicalSafety: [
    'drug_utilization_review',    // Advanced DUR, contraindications
    'allergy_interaction_check',  // Real-time safety checks
    'clinical_decision_support',  // Dosing guidance, protocols
    'adverse_event_reporting',    // FAERS integration
    'prescription_transfer',      // Inbound Rx transfers
    'refill_management',          // Auto-refill, reminders
    'prior_authorization_basic'   // PA workflow foundation
  ],

  qualityCompliance: [
    'capa_system',                // Corrective/preventive actions
    'batch_recall_management',    // Recall workflow, notifications
    'environmental_monitoring',   // Clean room temperature, humidity
    'equipment_calibration',      // Calibration scheduling, records
    'training_tracking',          // Staff competency, expiration
    'document_control',           // SOP versioning, approvals
    'compliance_calendar'         // Regulatory deadlines
  ],

  operationalExcellence: [
    'beyond_use_dating',          // BUD calculations, stability
    'potency_verification',       // QC testing integration
    'master_data_management',     // Patient/provider deduplication
    'data_governance',            // Data quality rules
    'disaster_recovery',          // DR runbooks, testing
    'vendor_risk_management'      // Full vendor assessment
  ],

  patientSafety: [
    'medication_therapy_mgmt',    // MTM consultations
    'patient_education',          // Drug information, counseling
    'adherence_tracking'          // Refill adherence monitoring
  ]
};
```

**Quality Metrics:**
```typescript
const qualityTargets = {
  prescriptionAccuracy: 99.9,     // % correct first time
  dispensingErrors: 0.1,          // per 1000 prescriptions
  patientSafetyIncidents: 0,      // serious events
  capaCycleTime: 30,              // days to close
  trainingCompliance: 100,        // % staff current
  environmentalExcursions: 0,     // out-of-spec events
  recallResponseTime: 24          // hours to patient notification
};
```

**Key Milestones:**
- [ ] Month 5: DUR system live, blocking dangerous interactions
- [ ] Month 6: CAPA system operational
- [ ] Month 7: Environmental monitoring automated
- [ ] Month 8: First DR drill completed successfully
- [ ] Month 9: Quality metrics dashboard live

**Scaling Triggers for Phase 3:**
- 2,000+ monthly patients
- 200+ prescriptions/week
- Zero quality incidents in 60 days
- All quality targets met
- Staff training 100% current

**Exit Criteria:**
- DUR catching all major interactions
- CAPA process mature
- Environmental monitoring 24/7
- DR tested quarterly
- State board inspection ready

**Team Additions:**
| Role | Count | Focus |
|------|-------|-------|
| Clinical Pharmacist | 1 | DUR, clinical protocols |
| Quality Manager | 1 | CAPA, compliance |
| Backend Engineer | 2 | Quality systems |
| Data Engineer | 1 | MDM, data quality |

---

### Phase 3: Growth (Months 10-15)

**Objective:** Expand reach through mobile apps, provider marketplace, and marketing automation.

**Entry Criteria:**
- Phase 2 quality systems stable
- Clinical safety verified
- 2,000+ patient base
- Unit economics positive

**Systems to Build:**

```typescript
const phase3Systems = {
  mobileExperience: [
    'ios_app',                    // Native iOS patient app
    'android_app',                // Native Android patient app
    'push_notification_infra',    // APNs/FCM, preference center
    'biometric_auth',             // Face ID, fingerprint
    'offline_mode',               // Basic offline functionality
    'wearable_sync'               // Apple Health, Google Fit
  ],

  marketplace: [
    'provider_marketplace',       // External provider onboarding
    'provider_credentialing',     // License, DEA, malpractice verification
    'provider_revenue_share',     // Commission calculations
    'provider_analytics',         // Performance dashboards
    'provider_ratings'            // Patient feedback on providers
  ],

  marketing: [
    'referral_program',           // Patient referrals, rewards
    'promotional_engine',         // Discount codes, campaigns
    'email_marketing',            // Drip campaigns, segmentation
    'ab_testing_platform',        // Feature experiments
    'attribution_tracking',       // Marketing channel ROI
    'seo_content_platform'        // Blog, educational content
  ],

  customerSuccess: [
    'help_desk_system',           // Zendesk/Intercom
    'live_chat',                  // Real-time patient support
    'returns_processing',         // Return workflow
    'dispute_resolution',         // Payment disputes
    'patient_reviews',            // Review collection, response
    'status_page'                 // Public system status
  ],

  analytics: [
    'data_warehouse',             // Snowflake/BigQuery
    'bi_dashboards',              // Looker/Metabase
    'cohort_analysis',            // Retention, LTV
    'predictive_churn'            // At-risk patient identification
  ]
};
```

**Growth Metrics:**
```typescript
const growthTargets = {
  monthlyActivePatients: 10000,
  patientAcquisitionCost: 50,     // dollars
  lifetimeValue: 500,             // dollars
  ltvCacRatio: 10,                // minimum
  netPromoterScore: 50,
  appStoreRating: 4.5,
  providerMarketplaceCount: 50,
  monthlyReferrals: 500
};
```

**Key Milestones:**
- [ ] Month 10: iOS app in TestFlight
- [ ] Month 11: Android app in beta
- [ ] Month 12: Provider marketplace MVP
- [ ] Month 13: First 10 marketplace providers onboarded
- [ ] Month 14: Push notifications live
- [ ] Month 15: Data warehouse operational

**Geographic Expansion:**
- Phase 3a: Texas, California, Florida (major markets)
- Phase 3b: All Mountain/Southwest states
- Phase 3c: Midwest expansion

**Scaling Triggers for Phase 4:**
- 10,000+ monthly patients
- 50+ marketplace providers
- Mobile app > 60% of traffic
- LTV:CAC > 8
- NPS > 50

**Exit Criteria:**
- Native apps in app stores
- Provider marketplace scaling
- Marketing automation running
- Customer support < 24hr response
- Data warehouse supporting business decisions

**Team Additions:**
| Role | Count | Focus |
|------|-------|-------|
| iOS Engineer | 2 | Native app |
| Android Engineer | 2 | Native app |
| Growth Engineer | 1 | A/B testing, attribution |
| Data Analyst | 2 | BI, reporting |
| Customer Success | 2 | Support, success |
| Marketing | 2 | Growth, content |

---

### Phase 4: Enterprise (Months 16-22)

**Objective:** Launch employer portal, insurance billing, and B2B sales infrastructure.

**Entry Criteria:**
- Phase 3 growth targets met
- Mobile apps stable
- Marketplace proven
- Series A/B funding secured

**Systems to Build:**

```typescript
const phase4Systems = {
  employerPortal: [
    'employer_portal',            // Company admin dashboard
    'employer_onboarding',        // Self-service setup
    'employee_eligibility',       // Eligibility file processing
    'employer_billing',           // Invoice generation
    'employer_analytics',         // Utilization reporting
    'employer_sso',               // SAML/OIDC integration
    'dependent_management'        // Family member enrollment
  ],

  insuranceBilling: [
    'insurance_verification',     // Real-time eligibility
    'claims_submission',          // 837P/837I EDI
    'claims_adjudication',        // ERA processing (835)
    'prior_authorization_full',   // PA workflow, CoverMyMeds
    'copay_calculation',          // Real-time cost estimation
    'payer_contracts',            // Contract management
    'denial_management'           // Appeal workflows
  ],

  enterpriseSecurity: [
    'sso_integration',            // Enterprise SSO support
    'scim_provisioning',          // Automated user management
    'advanced_rbac',              // Hierarchical permissions
    'audit_export',               // Compliance reporting
    'data_residency',             // Geographic data controls
    'encryption_key_management'   // BYOK support
  ],

  partnerships: [
    'partner_portal',             // Reseller/affiliate dashboard
    'api_partner_program',        // External API access
    'contract_management',        // Partner agreements
    'backup_pharmacy_network',    // Overflow pharmacy routing
    'lab_ordering_integration',   // Quest, Labcorp
    'ehr_integrations'            // Epic, Cerner connectors
  ],

  financialOperations: [
    'revenue_recognition',        // ASC 606 compliance
    'tax_reporting',              // 1099 generation
    'patient_assistance',         // PAP enrollment
    'payment_plans',              // Installment payments
    'bad_debt_management'         // Collections workflow
  ]
};
```

**Enterprise Metrics:**
```typescript
const enterpriseTargets = {
  employerAccounts: 100,
  employerLives: 50000,           // covered employees
  insuranceClaimsSubmitted: 10000,
  claimsAcceptanceRate: 95,       // first-pass acceptance
  averageReimbursementTime: 21,   // days
  enterpriseContractValue: 500000, // average annual
  payerContracts: 10              // in-network agreements
};
```

**Key Milestones:**
- [ ] Month 16: Employer portal MVP
- [ ] Month 17: First employer pilot (100 employees)
- [ ] Month 18: Insurance eligibility verification live
- [ ] Month 19: Claims submission operational
- [ ] Month 20: First payer contract signed
- [ ] Month 21: Partner portal launched
- [ ] Month 22: 10+ employer accounts active

**B2B Sales Motion:**
```
Employer Journey:
Demo Request → Discovery Call → Pilot Proposal →
Pilot (90 days) → ROI Analysis → Full Deployment →
Renewal/Expansion
```

**Scaling Triggers for Phase 5:**
- 100+ employer accounts
- 50,000+ covered lives
- Insurance claims processing at scale
- 10+ payer contracts
- B2B revenue > 30% of total

**Exit Criteria:**
- Employer portal fully functional
- Insurance billing operational
- 10+ active employer accounts
- Claims processing automated
- Partner ecosystem established

**Team Additions:**
| Role | Count | Focus |
|------|-------|-------|
| Enterprise Sales | 3 | Employer acquisition |
| Solutions Engineer | 2 | Implementation |
| Billing Specialist | 2 | Claims, denials |
| Backend Engineer | 2 | Insurance systems |
| Account Manager | 2 | Customer success |
| Finance Analyst | 1 | Revenue, contracts |

---

### Phase 5: Scale & Optimization (Months 23-30)

**Objective:** Platform optimization, advanced AI/ML, and multi-region expansion.

**Entry Criteria:**
- Phase 4 enterprise revenue stable
- 100+ employers
- Insurance billing mature
- Platform handling 10k+ transactions/day

**Systems to Build:**

```typescript
const phase5Systems = {
  advancedAI: [
    'ai_prescribing_assistant',   // Provider decision support
    'personalized_formulations',  // Patient-specific recommendations
    'demand_forecasting',         // Inventory prediction
    'fraud_detection_ml',         // Anomaly detection
    'clinical_nlp',               // Note analysis, coding
    'chatbot_enhancement'         // Advanced patient AI chat
  ],

  platformOptimization: [
    'multi_region_deployment',    // Active-active US regions
    'edge_caching',               // CDN optimization
    'database_sharding',          // Horizontal scaling
    'event_sourcing',             // Full event replay
    'chaos_engineering',          // Resilience testing
    'cost_optimization'           // FinOps practices
  ],

  advancedAnalytics: [
    'real_time_analytics',        // Streaming dashboards
    'clinical_outcomes_research', // Population health
    'predictive_adherence',       // Intervention triggers
    'provider_performance_ml',    // Quality scoring
    'pricing_optimization'        // Dynamic pricing
  ],

  familyHealth: [
    'caregiver_access',           // Delegate access
    'pediatric_workflows',        // Child-specific UX
    'family_dashboard',           // Multi-member view
    'subscription_management'     // Family plans
  ]
};
```

**Scale Metrics:**
```typescript
const scaleTargets = {
  monthlyTransactions: 100000,
  apiLatencyP99: 200,             // milliseconds
  uptime: 99.95,                  // percent
  costPerTransaction: 0.50,       // dollars, down from 2.00
  aiAccuracy: 95,                 // percent
  automationRate: 80,             // percent of workflows
  multiRegionFailover: 60         // seconds RTO
};
```

**Key Milestones:**
- [ ] Month 23: Multi-region active-active deployment
- [ ] Month 24: AI prescribing assistant beta
- [ ] Month 25: Database sharding complete
- [ ] Month 26: Real-time analytics operational
- [ ] Month 27: Chaos engineering program running
- [ ] Month 28: Family health features launched
- [ ] Month 30: Platform handles 100k+ transactions/day

**Geographic Scope:**
- All 50 US states
- Potential Canada expansion (future)

**Exit Criteria:**
- Platform highly available (99.95%+)
- AI/ML features deployed
- Multi-region resilient
- Cost per transaction optimized
- Ready for next growth phase

**Team Additions:**
| Role | Count | Focus |
|------|-------|-------|
| ML Engineer | 3 | AI/ML systems |
| Platform Engineer | 2 | Scaling, optimization |
| Site Reliability | 2 | Reliability, chaos |
| Principal Engineer | 1 | Architecture leadership |
| FinOps Analyst | 1 | Cost optimization |

---

### System Dependency Matrix

```typescript
const systemDependencies = {
  // Phase 0 → Phase 1
  phase1Prerequisites: {
    patient_portal: ['unified_audit_logging', 'api_gateway', 'database_schema'],
    provider_portal: ['unified_audit_logging', 'api_gateway', 'database_schema'],
    telehealth_video: ['hipaa_baseline', 'encryption_standards'],
    payment_processing: ['audit_logging', 'encryption_standards'],
    prescription_processing: ['access_control_framework', 'audit_logging']
  },

  // Phase 1 → Phase 2
  phase2Prerequisites: {
    drug_utilization_review: ['prescription_processing', 'drug_catalog_search'],
    capa_system: ['unified_audit_logging', 'document_control'],
    environmental_monitoring: ['monitoring_alerting', 'incident_response_basic'],
    disaster_recovery: ['backup_strategy', 'database_schema'],
    master_data_management: ['database_schema', 'data_classification']
  },

  // Phase 2 → Phase 3
  phase3Prerequisites: {
    ios_app: ['patient_portal', 'api_gateway', 'push_notification_infra'],
    android_app: ['patient_portal', 'api_gateway', 'push_notification_infra'],
    provider_marketplace: ['provider_portal', 'provider_credentialing'],
    data_warehouse: ['unified_audit_logging', 'basic_reporting'],
    ab_testing_platform: ['patient_portal', 'data_warehouse']
  },

  // Phase 3 → Phase 4
  phase4Prerequisites: {
    employer_portal: ['patient_portal', 'master_data_management'],
    insurance_verification: ['patient_portal', 'api_gateway'],
    claims_submission: ['prescription_processing', 'insurance_verification'],
    partner_portal: ['api_gateway', 'advanced_rbac'],
    ehr_integrations: ['api_gateway', 'master_data_management']
  },

  // Phase 4 → Phase 5
  phase5Prerequisites: {
    ai_prescribing_assistant: ['clinical_decision_support', 'ai_symptom_assessment'],
    multi_region_deployment: ['disaster_recovery', 'database_schema'],
    predictive_adherence: ['data_warehouse', 'adherence_tracking'],
    caregiver_access: ['patient_portal', 'advanced_rbac']
  }
};
```

---

### Risk Mitigation by Phase

```typescript
const phaseRisks = {
  phase0: {
    risks: [
      'HIPAA compliance gaps',
      'Vendor BAA delays',
      'Security vulnerabilities'
    ],
    mitigations: [
      'Engage HIPAA consultant early',
      'Use pre-vetted HIPAA vendors',
      'Third-party pen testing'
    ]
  },

  phase1: {
    risks: [
      'State licensing delays',
      'Provider recruitment challenges',
      'Low patient adoption'
    ],
    mitigations: [
      'Start licensing 6 months ahead',
      'Guaranteed minimums for early providers',
      'Soft launch with targeted marketing'
    ]
  },

  phase2: {
    risks: [
      'Quality system complexity',
      'Regulatory inspection findings',
      'Clinical error events'
    ],
    mitigations: [
      'Hire experienced quality manager',
      'Mock inspections before going live',
      'Robust DUR before volume scaling'
    ]
  },

  phase3: {
    risks: [
      'App store rejection',
      'Marketplace provider quality',
      'CAC exceeds budget'
    ],
    mitigations: [
      'Follow Apple/Google guidelines strictly',
      'Rigorous credentialing before onboarding',
      'Test marketing channels small before scaling'
    ]
  },

  phase4: {
    risks: [
      'Long enterprise sales cycles',
      'Claim denial rates',
      'Payer contract negotiations'
    ],
    mitigations: [
      'Land-and-expand with pilots',
      'Claims scrubbing before submission',
      'Start payer discussions 6 months ahead'
    ]
  },

  phase5: {
    risks: [
      'AI model accuracy',
      'Multi-region complexity',
      'Cost spiral'
    ],
    mitigations: [
      'Human-in-the-loop for clinical AI',
      'Incremental region rollout',
      'FinOps discipline from day 1'
    ]
  }
};
```

---

### Full System Inventory by Phase

| Phase | Count | Systems |
|-------|-------|---------|
| 0 | 18 | Audit logging, SIEM, API gateway, database, message queue, file storage, secrets, CI/CD, HIPAA baseline, BAA management, data classification, access control, encryption, incident response, monitoring, backup, vendor basic, change basic |
| 1 | 24 | Patient portal, patient auth, drug catalog, AI assessment, booking, consent, notifications, payments, provider portal, provider auth, telehealth, AI summary, Rx creation, clinical docs, scheduling, order mgmt, Rx processing, formulation, labels, shipping, inventory, admin dashboard, licensing tracker, basic reporting |
| 2 | 22 | DUR, allergy check, clinical decision support, adverse events, Rx transfer, refills, PA basic, CAPA, recalls, environmental monitoring, calibration, training, document control, compliance calendar, BUD, potency, MDM, data governance, DR, vendor risk, MTM, patient education, adherence |
| 3 | 20 | iOS app, Android app, push notifications, biometric auth, offline mode, wearables, provider marketplace, credentialing, revenue share, provider analytics, ratings, referrals, promos, email marketing, A/B testing, attribution, SEO, help desk, chat, returns, disputes, reviews, status page, warehouse, BI, cohort, churn |
| 4 | 18 | Employer portal, employer onboarding, eligibility, employer billing, employer analytics, SSO, dependents, insurance verification, claims, adjudication, PA full, copay, payer contracts, denials, enterprise SSO, SCIM, advanced RBAC, audit export, data residency, key mgmt, partner portal, API partners, contracts, backup pharmacy, lab ordering, EHR, revenue recognition, tax, PAP, payment plans, collections |
| 5 | 12 | AI Rx assistant, personalized formulations, demand forecasting, fraud ML, clinical NLP, chatbot, multi-region, edge caching, sharding, event sourcing, chaos engineering, cost optimization, real-time analytics, outcomes research, predictive adherence, provider ML, pricing optimization, caregiver, pediatric, family dashboard, subscriptions |

**Total: 114 systems across 6 phases**

---

### Team Growth Trajectory

```
Phase 0 (Weeks 1-6):      ████ 4 people
Phase 1 (Weeks 7-18):     ████████ 8 people
Phase 2 (Months 5-9):     ████████████ 12 people
Phase 3 (Months 10-15):   ██████████████████ 18 people
Phase 4 (Months 16-22):   █████████████████████████ 25 people
Phase 5 (Months 23-30):   ██████████████████████████████ 30 people
```

| Phase | Engineering | Clinical | Operations | Business | Total |
|-------|-------------|----------|------------|----------|-------|
| 0 | 3 | 0 | 0.5 | 0.5 | 4 |
| 1 | 6 | 0 | 1 | 1 | 8 |
| 2 | 8 | 2 | 1 | 1 | 12 |
| 3 | 10 | 2 | 2 | 4 | 18 |
| 4 | 12 | 3 | 4 | 6 | 25 |
| 5 | 15 | 4 | 5 | 6 | 30 |

---

### Budget Estimation by Phase

```typescript
const budgetEstimates = {
  phase0: {
    personnel: 150000,      // 6 weeks, 4 people avg
    infrastructure: 5000,   // AWS/GCP startup
    tools: 10000,           // Monitoring, security
    compliance: 25000,      // HIPAA assessment, legal
    total: 190000
  },

  phase1: {
    personnel: 600000,      // 12 weeks, 8 people
    infrastructure: 15000,  // Growing usage
    tools: 25000,           // Twilio, Auth0, Stripe
    compliance: 50000,      // State licensing, legal
    marketing: 50000,       // Beta launch
    total: 740000
  },

  phase2: {
    personnel: 900000,      // 5 months, 12 people
    infrastructure: 30000,  // Production scale
    tools: 50000,           // Quality systems
    compliance: 75000,      // Audits, certifications
    total: 1055000
  },

  phase3: {
    personnel: 1620000,     // 6 months, 18 people
    infrastructure: 75000,  // Multi-platform
    tools: 100000,          // Marketing stack
    marketing: 300000,      // Growth campaigns
    total: 2095000
  },

  phase4: {
    personnel: 2100000,     // 7 months, 25 people
    infrastructure: 100000, // Enterprise scale
    tools: 150000,          // Enterprise systems
    sales: 500000,          // Sales team, demos
    total: 2850000
  },

  phase5: {
    personnel: 2400000,     // 8 months, 30 people
    infrastructure: 200000, // Multi-region
    tools: 150000,          // ML/AI infrastructure
    total: 2750000
  },

  totalThreeYears: 9680000  // ~$10M all-in
};
```

---

### MVP Scope (Phase 1 Launch)

**In Scope:**
- Patient: search drugs → AI consultation → book → video visit → Rx → order
- Cash-pay only
- Your providers only (5-10 contracted physicians)
- Your compounding facility only (503A)
- 5 Mountain states (UT, ID, AZ, CO, WY)
- Web portal (responsive, mobile-friendly)
- Email/SMS notifications

**Out of Scope (Phase 2+):**
- Insurance verification/billing
- External marketplace providers
- Employer portal
- E-prescribing via Surescripts
- Multiple compounding facilities
- Native mobile apps
- Advanced clinical decision support

---

## Open Questions

### Business

1. **Provider recruitment strategy** - How will you attract marketplace providers pre-launch? Revenue share? Guaranteed minimums?

2. **Compounding facility timeline** - When will your facility be operational? What's the licensing timeline for 5 states?

3. **Initial compound formulary** - Which compounds will you offer at launch? Weight management only? Broader?

4. **Pricing strategy** - What margins on compounds? Platform fee for marketplace providers?

5. **Employer sales strategy** - Who is the target employer? Self-insured mid-market? Large enterprise?

### Technical

1. **AI model selection** - Claude vs GPT-4 vs hybrid? Fine-tuning vs RAG vs both?

2. **Video infrastructure** - Build on Twilio vs Zoom HIPAA API vs other?

3. **EHR integration scope** - Do marketplace providers need to sync their EHRs? Or is your system the source of truth?

4. **Offline/mobile requirements** - Mobile apps in scope? PWA sufficient?

### Regulatory

1. **503A vs 503B decision** - Will your facility be 503A (patient-specific) or 503B (bulk)? Or both?

2. **Controlled substances** - Will you compound any Schedule III-V medications? (Requires DEA)

3. **Corporate structure** - MSO model for provider relationships? How structured?

4. **Legal review** - Healthcare attorney engaged for state-by-state compliance review?

---

## Next Steps

1. **Finalize compound formulary** - What drugs at launch?
2. **Provider recruitment plan** - How many, what states, what terms?
3. **Facility licensing timeline** - Pharmacy licenses for 5 states
4. **Technical deep-dives** - AI service, provider portal, manufacturing integration
5. **Legal/compliance review** - State-by-state requirements

---

## Resources & References

### Market Research

- [Teladoc Health](https://www.teladochealth.com)
- [ZocDoc](https://www.zocdoc.com)
- [Healthie](https://www.gethealthie.com)
- [Cost Plus Drugs](https://www.costplusdrugs.com)
- [GoodRx](https://www.goodrx.com)
- [Doctronic](https://www.doctronic.ai)
- [Strive Pharmacy](https://www.strivepharmacy.com)

### Regulatory

- [FDA 503A vs 503B Guidance](https://www.fda.gov/drugs/human-drug-compounding)
- [Surescripts Certification](https://surescripts.com/enhance-prescribing/e-prescribing)
- [HIPAA Compliance Checklist](https://www.hhs.gov/hipaa)

### Technical

- [Auth0 Healthcare](https://auth0.com/healthcare)
- [Twilio HIPAA](https://www.twilio.com/hipaa)
- [AWS HIPAA Eligible Services](https://aws.amazon.com/compliance/hipaa-eligible-services-reference/)
- [Stripe HIPAA](https://stripe.com/guides/hipaa-compliance)
